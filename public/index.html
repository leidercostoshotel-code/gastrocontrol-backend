<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GASTRO CONTROL PRO | Sistema Profesional de Gesti√≥n Gastron√≥mica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
        <style>
@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

@keyframes float3d {
    0%, 100% {
        transform: translateY(0px) rotateX(0deg) rotateY(0deg);
    }
    25% {
        transform: translateY(-10px) rotateX(5deg) rotateY(5deg);
    }
    50% {
        transform: translateY(0px) rotateX(0deg) rotateY(-5deg);
    }
    75% {
        transform: translateY(-10px) rotateX(-5deg) rotateY(0deg);
    }
}

@keyframes scroll-ticker {
    0% {
        transform: translateX(100%);
    }
    100% {
        transform: translateX(-100%);
    }
}

@keyframes bounce-3d {
    0%, 100% {
        transform: translateY(0) scale(1) rotateY(0deg);
    }
    50% {
        transform: translateY(-8px) scale(1.1) rotateY(180deg);
    }
}

@keyframes rotate-3d {
    0% {
        transform: rotateY(0deg) rotateX(0deg);
    }
    100% {
        transform: rotateY(360deg) rotateX(360deg);
    }
}

@keyframes glow-pulse {
    0%, 100% {
        box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
    }
    50% {
        box-shadow: 0 0 40px rgba(147, 51, 234, 0.8), 0 0 60px rgba(147, 51, 234, 0.6);
    }
}

/* ========== ANIMACIONES DEL DASHBOARD ========== */
@keyframes float-bounce {
    0%, 100% {
        transform: translateY(0px) scale(1);
    }
    50% {
        transform: translateY(-15px) scale(1.1);
    }
}

@keyframes pulse-glow {
    0%, 100% {
        transform: scale(1);
        filter: drop-shadow(0 0 10px currentColor);
    }
    50% {
        transform: scale(1.2);
        filter: drop-shadow(0 0 20px currentColor) brightness(1.3);
    }
}

@keyframes rotate-infinite {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

@keyframes shake-wiggle {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-10deg); }
    75% { transform: rotate(10deg); }
}

@keyframes gradient-shift {
    0% {
        background-position: 0% 50%;
    }
    50% {
        background-position: 100% 50%;
    }
    100% {
        background-position: 0% 50%;
    }
}

@keyframes sparkle {
    0%, 100% {
        opacity: 1;
        transform: scale(1) rotate(0deg);
    }
    50% {
        opacity: 0.6;
        transform: scale(1.3) rotate(180deg);
    }
}

@keyframes bounce-in {
    0% {
        transform: scale(0.3);
        opacity: 0;
    }
    50% {
        transform: scale(1.05);
    }
    70% {
        transform: scale(0.9);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes swing {
    0%, 100% { transform: rotate(0deg); }
    20% { transform: rotate(15deg); }
    40% { transform: rotate(-10deg); }
    60% { transform: rotate(5deg); }
    80% { transform: rotate(-5deg); }
}

.dashboard-icon {
    display: inline-block;
    animation: float-bounce 3s ease-in-out infinite;
}

.dashboard-icon:hover {
    animation: pulse-glow 0.6s ease-in-out;
}

.rotate-icon {
    display: inline-block;
    animation: rotate-infinite 4s linear infinite;
}

.pulse-icon {
    display: inline-block;
    animation: pulse-glow 2s ease-in-out infinite;
}

.shake-icon {
    display: inline-block;
    animation: shake-wiggle 2s ease-in-out infinite;
}

.sparkle-icon {
    display: inline-block;
    animation: sparkle 1.5s ease-in-out infinite;
}

.swing-icon {
    display: inline-block;
    animation: swing 2s ease-in-out infinite;
    transform-origin: top center;
}

.kpi-card {
    background-size: 200% 200%;
    animation: gradient-shift 5s ease infinite;
    transition: all 0.3s ease;
}

.kpi-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
}

.alert-card {
    animation: bounce-in 0.6s ease-out;
}

.alert-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.insight-card {
    transition: all 0.3s ease;
}

.insight-card:hover {
    transform: scale(1.05);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
}

/* ========== TABS DE EVENTOS ========== */
.tab-evento-active {
    color: #7c3aed;
    border-bottom: 3px solid #7c3aed;
    background: linear-gradient(to bottom, rgba(124, 58, 237, 0.1), transparent);
}


.ticker-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: linear-gradient(90deg, rgba(99, 102, 241, 0.95) 0%, rgba(139, 92, 246, 0.95) 100%);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    display: block !important;
    visibility: visible !important;
}

.ticker-container {
    overflow: hidden;
    white-space: nowrap;
    padding: 10px 0;
    position: relative;
}

.ticker-content {
    display: inline-block;
    animation: scroll-ticker 300s linear infinite;
    padding-left: 100%;
    will-change: transform;
}

.ticker-content:hover {
    animation-play-state: paused;
}

.ticker-item {
    display: inline-flex;
    align-items: center;
    margin-right: 60px;
    color: rgba(255, 255, 255, 0.95) !important;
    font-weight: 600;
    font-size: 0.875rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    letter-spacing: 0.3px;
}

.ticker-item span {
    color: rgba(255, 255, 255, 0.95) !important;
}

.ticker-icon {
    display: inline-block;
    margin-right: 8px;
    font-size: 1.2rem;
    opacity: 0.9;
}

@keyframes pulse3d {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

@keyframes pulse3d {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

@keyframes shine {
    0% {
        background-position: -200%;
    }
    100% {
        background-position: 200%;
    }
}

.metric-card {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-5px);
}

.metric-icon {
    animation: float3d 3s ease-in-out infinite;
    font-size: 2.5rem;
    display: inline-block;
}

.metric-card:hover .metric-icon {
    animation: float3d 1.5s ease-in-out infinite;
}

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1e293b;
            padding-top: 45px; /* Espacio para el ticker */
        }
        
        .glass-card { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
        }
        
        .input-corp { 
            border: 2px solid #e2e8f0;
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            width: 100%;
            transition: all 0.2s;
            background: white;
        }
        
        .input-corp:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-action { 
            transition: all 0.3s ease;
            font-weight: 700;
            cursor: pointer;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }
        
        .btn-action:active {
            transform: translateY(0);
        }
        
        .nav-active { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }
        
        .search-box { 
            background: white;
            border: 2px solid #e2e8f0;
            padding: 12px 16px;
            border-radius: 12px;
            width: 100%;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        th { 
            text-align: left;
            padding: 16px;
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* ESTILOS TECLADO NUM√âRICO T√ÅCTIL */
        
        /* ESTILOS PARA TABS DE CATEGOR√çAS */
        .tab-categoria-pos {
            background: #f1f5f9;
            color: #64748b;
            border: 2px solid transparent;
        }
        
        .tab-categoria-pos:hover {
            background: #e2e8f0;
            color: #475569;
        }
        
        .tab-categoria-pos.tab-activa {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        /* OCULTAR SCROLLBAR PERO MANTENER FUNCIONALIDAD */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* ANIMACI√ìN PARA PRODUCTOS */
        @keyframes fadeInProduct {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .producto-card {
            animation: fadeInProduct 0.2s ease-out;
        }
        
        .teclado-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 16px;
            font-size: 24px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .teclado-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .teclado-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        .teclado-btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 16px;
            font-size: 20px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(71, 85, 105, 0.3);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .teclado-btn-secondary:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(71, 85, 105, 0.4);
        }
        
        .teclado-btn-secondary:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            box-shadow: 0 6px 16px rgba(71, 85, 105, 0.4);
        }
        
        #teclado-numerico {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }
        
        .icon-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 3px solid #f1f5f9;
        }
        
        .section-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        /* ========== MINI REPRODUCTOR RADIO (MANAGER) ========== */
        #mini-radio {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 999;
            display: none; /* Oculto por defecto */
        }
        
        #mini-radio.minimizado {
            width: 60px;
            height: 60px;
        }
        
        #mini-radio.expandido {
            width: 320px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(99, 102, 241, 0.3);
        }
        
        .radio-toggle-btn {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            transition: all 0.3s;
            animation: radioGlow 2s ease-in-out infinite;
        }
        
        .radio-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }
        
        .radio-toggle-btn span {
            font-size: 28px;
        }
        
        @keyframes radioGlow {
            0%, 100% { box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(99, 102, 241, 0.8); }
        }
        
        .radio-content {
            display: none;
        }
        
        #mini-radio.expandido .radio-content {
            display: block;
        }
        
        #mini-radio.expandido .radio-toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            z-index: 10;
        }
        
        #mini-radio.expandido .radio-toggle-btn span {
            font-size: 18px;
        }
        
        .radio-header-mini {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .radio-title-mini {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 3px;
        }
        
        .radio-subtitle-mini {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .radio-iframe-container {
            margin: 10px 0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .radio-status-mini {
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 12px;
            color: #94a3b8;
        }
        
        .status-dot-mini {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulseDot 2s ease-in-out infinite;
        }
        
        @keyframes pulseDot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        /* ========== BOT√ìN FLOTANTE PANTALLA COMPLETA ========== */
        #btn-fullscreen-float {
            position: fixed;
            bottom: 80px;
            left: 20px;
            z-index: 999;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            transition: all 0.3s;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        #btn-fullscreen-float:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.6);
        }
        
        #btn-fullscreen-float span {
            font-size: 24px;
        }
    </style>

<style>
@media print {
    /* Ocultar overlay oscuro */
    #modal-ticket-cocina,
    #modal-boleta {
        position: static !important;
        background: white !important;
        width: 100% !important;
        height: auto !important;
    }
    
    /* Centrar el contenido */
    #modal-ticket-cocina > div,
    #modal-boleta > div {
        position: static !important;
        transform: none !important;
        margin: 0 auto !important;
        max-width: 100% !important;
    }
    
    /* Ocultar botones */
    #ticket-buttons,
    #boleta-buttons {
        display: none !important;
    }
    
    /* Asegurar que todo el contenido sea visible */
    body * {
        visibility: visible !important;
    }
    
    /* Ocultar el resto de la p√°gina */
    body > *:not(#modal-ticket-cocina):not(#modal-boleta) {
        display: none !important;
    }
}

@page {
    margin: 1cm;
}
</style>
</head>
<body class="p-4 md:p-8">
<style>
        #licenseModal { z-index: 9999; display: flex; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .blur-content { filter: blur(12px); pointer-events: none; user-select: none; transition: all 0.6s ease; }
    </style>

    <div id="licenseModal">
        <div class="glass-card p-10 w-full max-w-md text-center border-t-8 border-indigo-600 shadow-2xl animate-in">
            <div class="text-6xl mb-4">üîê</div>
            <h2 class="text-2xl font-black text-slate-800 mb-2">SISTEMA PROTEGIDO</h2>
            <p class="text-sm text-slate-500 mb-6">Ingrese su c√≥digo de activaci√≥n manual para el Trimestre 2025-Q4.</p>
            <input type="text" id="licenseInput" placeholder="LTM-2025-XXXX-XXXX" 
                   class="w-full p-4 border-2 rounded-xl mb-4 text-center uppercase font-black text-indigo-600 border-indigo-100 focus:border-indigo-500 outline-none shadow-inner">
            <button onclick="manualActivate()" 
                    class="w-full bg-gradient-to-r from-indigo-600 to-purple-700 text-white py-4 rounded-xl font-black shadow-lg hover:scale-105 transition-all">
                ACTIVAR AHORAz
            </button>
        </div>
    </div>

    <div id="mainContent" class="blur-content">


    <!-- ========== BARRA DE NOTICIAS TICKER ========== -->
    <div class="ticker-wrapper">
        <div class="ticker-container">
            <div class="ticker-content" id="ticker-content">
                <span class="ticker-item">
                    <span class="ticker-icon">üë§</span>
                    <span>Bienvenido a GASTRO CONTROL PRO</span>
                </span>
                <span class="ticker-item" style="opacity: 0.4; margin-right: 40px;">‚Ä¢</span>
                <span class="ticker-item">
                    <span class="ticker-icon">üè®</span>
                    <span>Control Total de tu Cocina</span>
                </span>
                <span class="ticker-item" style="opacity: 0.4; margin-right: 40px;">‚Ä¢</span>
                <span class="ticker-item">
                    <span class="ticker-icon">üìÖ</span>
                    <span>Sistema Profesional de Gesti√≥n Gastron√≥mica</span>
                </span>
                <span class="ticker-item" style="opacity: 0.4; margin-right: 40px;">‚Ä¢</span>
                <span class="ticker-item">
                    <span class="ticker-icon">‚ö°</span>
                    <span>Decisiones Inteligentes para tu Restaurante</span>
                </span>
                <span class="ticker-item" style="opacity: 0.4; margin-right: 40px;">‚Ä¢</span>
                <span class="ticker-item">
                    <span class="ticker-icon">üë§</span>
                    <span>Bienvenido a GASTRO CONTROL PRO</span>
                </span>
                <span class="ticker-item" style="opacity: 0.4; margin-right: 40px;">‚Ä¢</span>
                <span class="ticker-item">
                    <span class="ticker-icon">üè®</span>
                    <span>SWISSOTEL - Excelencia en cada plato</span>
                </span>
                <span class="ticker-item" style="opacity: 0.4; margin-right: 40px;">‚Ä¢</span>
                <span class="ticker-item">
                    <span class="ticker-icon">üìÖ</span>
                    <span>Sistema de Gesti√≥n Gastron√≥mica</span>
                </span>
                <span class="ticker-item" style="opacity: 0.4; margin-right: 40px;">‚Ä¢</span>
                <span class="ticker-item">
                    <span class="ticker-icon">‚ö°</span>
                    <span>Sistema en l√≠nea y funcionando</span>
                </span>
            </div>
        </div>
    </div>

<!-- ==================== PANTALLA DE LOGIN ==================== -->
<div id="pantalla-login" class="fixed inset-0 bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 flex items-center justify-center z-50">
    <div class="bg-white rounded-3xl p-12 shadow-2xl max-w-md w-full animate-in">
        <div class="text-center mb-8">
            <div class="text-6xl mb-4">üìä</div>
            <h1 class="text-3xl font-black bg-gradient-to-r from-blue-700 to-purple-700 bg-clip-text text-transparent mb-2">GASTRO CONTROL PRO</h1>
            <p class="text-slate-600 font-semibold">Sistema Profesional de Gesti√≥n Gastron√≥mica</p>
            <div class="mt-4 p-3 bg-blue-50 border-2 border-blue-200 rounded-xl">
                <p class="text-xs font-bold text-blue-700">üë®‚Äçüç≥ MOZOS: Solo ingresa tu PIN (4 d√≠gitos)</p>
                <p class="text-xs text-blue-600">üë®‚Äçüíº ADMIN/STAFF: Usuario + PIN</p>
            </div>
        </div>
        
        <div class="space-y-4 mb-6">
            <input type="text" id="login-usuario" placeholder="üë§ Usuario (opcional para mozos)" class="w-full p-4 border-2 border-purple-200 rounded-xl font-bold focus:border-purple-500 focus:outline-none" onkeypress="if(event.key==='Enter') document.getElementById('login-password').focus()">
            <input type="password" id="login-password" placeholder="üîí PIN (4 d√≠gitos)" class="w-full p-4 border-2 border-purple-200 rounded-xl font-bold text-center text-2xl tracking-widest focus:border-purple-500 focus:outline-none" maxlength="6" readonly onfocus="mostrarTecladoNumerico()" style="letter-spacing: 1rem;">
        </div>
        
        <!-- MENSAJE DE ERROR -->
        <div id="login-error" class="hidden mb-4 p-3 bg-red-50 border-2 border-red-200 rounded-xl animate-shake">
            <p class="text-sm font-bold text-red-700 text-center" id="login-error-text"></p>
        </div>
        
        <!-- TECLADO NUM√âRICO T√ÅCTIL -->
        <div id="teclado-numerico" class="hidden mb-6">
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 shadow-2xl">
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <button onclick="agregarDigito('1')" class="teclado-btn">1</button>
                    <button onclick="agregarDigito('2')" class="teclado-btn">2</button>
                    <button onclick="agregarDigito('3')" class="teclado-btn">3</button>
                    <button onclick="agregarDigito('4')" class="teclado-btn">4</button>
                    <button onclick="agregarDigito('5')" class="teclado-btn">5</button>
                    <button onclick="agregarDigito('6')" class="teclado-btn">6</button>
                    <button onclick="agregarDigito('7')" class="teclado-btn">7</button>
                    <button onclick="agregarDigito('8')" class="teclado-btn">8</button>
                    <button onclick="agregarDigito('9')" class="teclado-btn">9</button>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="ocultarTecladoNumerico()" class="teclado-btn-secondary">‚úï</button>
                    <button onclick="agregarDigito('0')" class="teclado-btn">0</button>
                    <button onclick="borrarDigito()" class="teclado-btn-secondary">‚å´</button>
                </div>
            </div>
        </div>
        
        <div class="space-y-3">
            <button onclick="iniciarSesionInteligente()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition-all">
                üöÄ INGRESAR
            </button>
        </div>
        
        <p class="text-center text-xs text-slate-500 mt-6">
            Usuarios: <strong>admin</strong>, <strong>chef</strong>, <strong>almacen</strong>
        </p>
        
        <!-- CR√âDITOS DEL DESARROLLADOR -->
        <div class="mt-6 pt-4 border-t border-slate-200">
            <p class="text-center text-[10px] text-slate-400 flex items-center justify-center gap-2">
                <span>üíª Desarrollado por</span>
                <span class="font-bold text-indigo-600">Leider Tisnado Mego</span>
            </p>
        </div>
    </div>
</div>


    <header class="max-w-7xl mx-auto mb-8 glass-card p-6 animate-in">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg icon-pulse">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tight">
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">GASTRO CONTROL PRO</span>
                        <span class="badge bg-gradient-to-r from-blue-600 to-purple-600 text-white ml-2">PRO</span>
                    </h1>
                    <p class="text-xs text-slate-600 font-semibold mt-1">
                        Sistema Profesional de Gesti√≥n Gastron√≥mica
                    </p>
                    <p class="text-xs text-slate-500 font-semibold tracking-wider mt-1">
                        SWISSOTEL ‚Ä¢ Usuario: <span id="nombre-usuario-admin" class="text-purple-600 font-bold">-</span>
                    </p>
                    <p class="text-[10px] text-slate-400 mt-1 flex items-center gap-1">
                        <span>üíª</span>
                        <span>Desarrollado por</span>
                        <span class="font-bold text-indigo-600">Leider Tisnado Mego</span>
                    </p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="solicitarImportarJSON()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 text-xs btn-action font-bold">
                    üì• IMPORTAR
                </button>
                <button onclick="exportData()" class="bg-gradient-to-r from-slate-700 to-slate-900 text-white px-6 py-3 text-xs btn-action font-bold">
                    üíæ EXPORTAR
                </button>
                <input type="file" id="importFile" class="hidden">
                <button onclick="cerrarSesion()" class="bg-gradient-to-r from-red-600 to-red-700 text-white px-5 py-3 text-xs btn-action font-bold">
                    üö™ CERRAR SESI√ìN
                </button>
            </div>
        </div>
    </header>

    <nav class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
    <button onclick="showSection('dashboard')" id="nav-dashboard" class="glass-card p-5 font-bold text-xs btn-action bg-white">
        <div class="text-2xl mb-2">üìä</div>
        DASHBOARD
    </button>
    <button onclick="showSection('bom')" id="nav-bom" class="glass-card p-5 font-bold text-xs btn-action bg-white">
        <div class="text-2xl mb-2">üì¶</div>
        MATERIALES
    </button>
    <button onclick="showSection('bases')" id="nav-bases" class="glass-card p-5 font-bold text-xs btn-action bg-white">
        <div class="text-2xl mb-2">üß™</div>
        RECETAS BASE
    </button>
    <button onclick="showSection('menu')" id="nav-menu" class="glass-card p-5 font-bold text-xs btn-action bg-white">
        <div class="text-2xl mb-2">üçΩÔ∏è</div>
        CARTA & BEBIDAS
    </button>
    <button onclick="showSection('stock')" id="nav-stock" class="glass-card p-5 font-bold text-xs btn-action bg-white">
        <div class="text-2xl mb-2">üì¶</div>
        INVENTARIO
    </button>
    <button onclick="showSection('planning')" id="nav-planning" class="glass-card p-5 font-bold text-xs btn-action bg-white">
        <div class="text-2xl mb-2">üìÖ</div>
        PLANIFICACI√ìN
    </button>
    <button onclick="showSection('mrp')" id="nav-mrp" class="glass-card p-5 font-bold text-xs btn-action bg-white">
        <div class="text-2xl mb-2">‚ö°</div>
        √ìRDENES PLATOS
    </button>
    
    <button onclick="showSection('eventos')" id="nav-eventos" class="glass-card p-5 font-bold text-xs btn-action bg-white">
        <div class="text-2xl mb-2 sparkle-icon">üéâ</div>
        EVENTOS
    </button>
    
    <button onclick="showSection('compras')" id="nav-compras" class="glass-card p-5 font-bold text-xs btn-action bg-white">
        <div class="text-2xl mb-2 pulse-icon">üìÇ</div>
        COMPRAS
    </button>
    
    <!-- ‚úÖ MOVER ESTOS 3 BOTONES DENTRO DEL NAV -->
    <button onclick="showSection('familias')" id="nav-familias" class="glass-card p-5 font-bold text-xs btn-action bg-white">
        <div class="text-2xl mb-2">üè∑Ô∏è</div>
        FAMILIAS
    </button>




<button onclick="showSection('usuarios')" id="nav-usuarios" class="glass-card p-5 font-bold text-xs btn-action bg-white">
    <div class="text-2xl mb-2">üë•</div>
    USUARIOS
</button>




</nav>

    <main class="max-w-7xl mx-auto">
        <!-- ========== DASHBOARD PROFESIONAL ========== -->
        <section id="section-dashboard" class="hidden">
            <div class="glass-card p-8 animate-in">
                <div class="section-header">
                    <div class="section-icon">
                        <span class="dashboard-icon">üìä</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black flex items-center gap-2">
                            DASHBOARD GASTRON√ìMICO
                            <span class="text-xl sparkle-icon">üíé</span>
                            <span class="text-lg pulse-icon">‚ú®</span>
                        </h2>
                        <p class="text-sm text-slate-500 font-medium flex items-center gap-2">
                            <span class="pulse-icon">üìà</span>
                            Panel de control y m√©tricas clave del negocio
                        </p>
                    </div>
                </div>

                <!-- BOT√ìN DE ACTUALIZAR -->
                <div class="flex justify-end mb-6">
                    <button onclick="actualizarDashboard()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-xl font-bold btn-action shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center gap-2">
                        <span class="rotate-icon text-xl">üîÑ</span>
                        ACTUALIZAR DASHBOARD
                        <span class="sparkle-icon text-lg">‚ú®</span>
                    </button>
                </div>

                <!-- ========== SECCI√ìN 1: KPIs PRINCIPALES ========== -->
                <div class="mb-8">
                    <h3 class="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">
                        <span class="text-2xl sparkle-icon">üéØ</span>
                        INDICADORES CLAVE
                        <span class="text-xl pulse-icon">üíé</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Food Cost Promedio -->
                        <div class="kpi-card bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-2xl shadow-lg border-2 border-emerald-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl dashboard-icon">üçΩÔ∏è</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">FOOD</span>
                            </div>
                            <p id="kpi-food-cost" class="text-4xl font-black text-white">0%</p>
                            <p class="text-xs text-emerald-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üìä</span> Food Cost Promedio
                            </p>
                        </div>

                        <!-- Beverage Cost -->
                        <div class="kpi-card bg-gradient-to-br from-blue-500 to-cyan-600 p-6 rounded-2xl shadow-lg border-2 border-blue-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl dashboard-icon">ü•§</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">BEVERAGE</span>
                            </div>
                            <p id="kpi-beverage-cost" class="text-4xl font-black text-white">0%</p>
                            <p class="text-xs text-blue-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üíß</span> Beverage Cost Promedio
                            </p>
                        </div>

                        <!-- Liquor Cost -->
                        <div class="kpi-card bg-gradient-to-br from-purple-500 to-pink-600 p-6 rounded-2xl shadow-lg border-2 border-purple-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl dashboard-icon">üç∑</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">LIQUOR</span>
                            </div>
                            <p id="kpi-liquor-cost" class="text-4xl font-black text-white">0%</p>
                            <p class="text-xs text-purple-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üç∏</span> Liquor Cost Promedio
                            </p>
                        </div>

                        <!-- Total Productos -->
                        <div class="kpi-card bg-gradient-to-br from-orange-500 to-amber-600 p-6 rounded-2xl shadow-lg border-2 border-orange-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl rotate-icon">üìã</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">CARTA</span>
                            </div>
                            <p id="kpi-total-productos" class="text-4xl font-black text-white">0</p>
                            <p class="text-xs text-orange-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="sparkle-icon">‚ú®</span> Productos en Carta
                            </p>
                        </div>

                        <!-- Valor Inventario -->
                        <div class="kpi-card bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-2xl shadow-lg border-2 border-indigo-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl shake-icon">üí∞</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">STOCK</span>
                            </div>
                            <p id="kpi-valor-inventario" class="text-4xl font-black text-white">S/. 0</p>
                            <p class="text-xs text-indigo-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üíé</span> Valor Total Inventario
                            </p>
                        </div>

                        <!-- Margen Promedio -->
                        <div class="kpi-card bg-gradient-to-br from-rose-500 to-red-600 p-6 rounded-2xl shadow-lg border-2 border-rose-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl dashboard-icon">üìà</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">MARGEN</span>
                            </div>
                            <p id="kpi-margen-promedio" class="text-4xl font-black text-white">0%</p>
                            <p class="text-xs text-rose-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="sparkle-icon">üöÄ</span> Margen Promedio General
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ========== SECCI√ìN 2: TOP AN√ÅLISIS ========== -->
                <div class="mb-8">
                    <h3 class="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">
                        <span class="text-2xl dashboard-icon">üèÜ</span>
                        TOP PRODUCTOS
                        <span class="text-xl sparkle-icon">‚≠ê</span>
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Top M√°s Rentables -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-emerald-200 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-emerald-700 mb-4 flex items-center gap-2">
                                <span class="text-xl pulse-icon">‚úÖ</span>
                                TOP 10 M√ÅS RENTABLES
                                <span class="text-sm shake-icon">üéâ</span>
                            </h4>
                            <div id="top-rentables" class="text-sm">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>

                        <!-- Top Menos Rentables -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-red-200 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-red-700 mb-4 flex items-center gap-2">
                                <span class="text-xl shake-icon">‚ö†Ô∏è</span>
                                TOP 10 MENOS RENTABLES
                                <span class="text-sm pulse-icon">üîç</span>
                            </h4>
                            <div id="top-menos-rentables" class="text-sm">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== SECCI√ìN 3: AN√ÅLISIS POR CATEGOR√çA ========== -->
                <div class="mb-8">
                    <h3 class="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">
                        <span class="text-2xl rotate-icon">üìÇ</span>
                        AN√ÅLISIS POR CATEGOR√çA
                        <span class="text-xl pulse-icon">üìä</span>
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Gr√°fico de Barras -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-blue-200 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-blue-700 mb-4 flex items-center gap-2">
                                <span class="dashboard-icon">üìä</span>
                                COSTO % POR CATEGOR√çA
                            </h4>
                            <div class="overflow-auto max-h-96" style="max-height: 400px;">
                                <div style="min-height: 300px;">
                                    <canvas id="chart-categoria-fc"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de categor√≠as -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-purple-200 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-purple-700 mb-4 flex items-center gap-2">
                                <span class="pulse-icon">üìã</span>
                                RESUMEN POR CATEGOR√çA
                            </h4>
                            <div id="tabla-categorias" class="overflow-auto max-h-96">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== SECCI√ìN 4: AN√ÅLISIS POR √ÅREA ========== -->
                <div class="mb-8">
                    <h3 class="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">
                        <span class="text-2xl shake-icon">üè¢</span>
                        AN√ÅLISIS POR √ÅREA
                        <span class="text-xl sparkle-icon">üéØ</span>
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Gr√°fico de Barras -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-green-200 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-green-700 mb-4 flex items-center gap-2">
                                <span class="dashboard-icon">üìä</span>
                                COSTO % POR √ÅREA
                            </h4>
                            <div class="overflow-auto max-h-96" style="max-height: 400px;">
                                <div style="min-height: 300px;">
                                    <canvas id="chart-area-fc"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de √°reas -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-teal-200 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-teal-700 mb-4 flex items-center gap-2">
                                <span class="pulse-icon">üìã</span>
                                RESUMEN POR √ÅREA
                            </h4>
                            <div id="tabla-areas" class="overflow-auto max-h-96">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== SECCI√ìN 5: ALERTAS CR√çTICAS ========== -->
                <div class="mb-8">
                    <h3 class="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">
                        <span class="text-2xl shake-icon">‚ö†Ô∏è</span>
                        ALERTAS Y ATENCI√ìN
                        <span class="text-xl pulse-icon">üö®</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Alertas Rojas -->
                        <div class="alert-card bg-gradient-to-br from-red-50 to-rose-100 rounded-2xl shadow-lg border-2 border-red-300 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-red-700 mb-3 flex items-center gap-2">
                                <span class="shake-icon">üî¥</span>
                                COSTO ALTO (FC% > 35%)
                            </h4>
                            <p id="alerta-fc-alto" class="text-3xl font-black text-red-600 mb-2">0</p>
                            <p class="text-xs text-red-600 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">‚ö°</span> Productos requieren atenci√≥n
                            </p>
                        </div>

                        <!-- Alertas Amarillas -->
                        <div class="alert-card bg-gradient-to-br from-amber-50 to-yellow-100 rounded-2xl shadow-lg border-2 border-amber-300 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-amber-700 mb-3 flex items-center gap-2">
                                <span class="pulse-icon">üü°</span>
                                ATENCI√ìN (FC% 30-35%)
                            </h4>
                            <p id="alerta-fc-medio" class="text-3xl font-black text-amber-600 mb-2">0</p>
                            <p class="text-xs text-amber-600 font-semibold flex items-center gap-1">
                                <span class="sparkle-icon">üëÄ</span> Productos a monitorear
                            </p>
                        </div>

                        <!-- Sin Precio -->
                        <div class="alert-card bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl shadow-lg border-2 border-orange-300 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-orange-700 mb-3 flex items-center gap-2">
                                <span class="shake-icon">üü†</span>
                                SIN PRECIO
                            </h4>
                            <p id="alerta-sin-precio" class="text-3xl font-black text-orange-600 mb-2">0</p>
                            <p class="text-xs text-orange-600 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üí≤</span> Productos sin definir
                            </p>
                        </div>

                        <!-- Stock Cr√≠tico -->
                        <div class="alert-card bg-gradient-to-br from-purple-50 to-fuchsia-100 rounded-2xl shadow-lg border-2 border-purple-300 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-purple-700 mb-3 flex items-center gap-2">
                                <span class="shake-icon">üì¶</span>
                                SIN STOCK
                            </h4>
                            <p id="alerta-sin-stock" class="text-3xl font-black text-purple-600 mb-2">0</p>
                            <p class="text-xs text-purple-600 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üö´</span> Materiales agotados
                            </p>
                        </div>

                        <!-- Stock Bajo -->
                        <div class="alert-card bg-gradient-to-br from-blue-50 to-cyan-100 rounded-2xl shadow-lg border-2 border-blue-300 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-blue-700 mb-3 flex items-center gap-2">
                                <span class="pulse-icon">üìâ</span>
                                STOCK BAJO
                            </h4>
                            <p id="alerta-stock-bajo" class="text-3xl font-black text-blue-600 mb-2">0</p>
                            <p class="text-xs text-blue-600 font-semibold flex items-center gap-1">
                                <span class="sparkle-icon">‚è∞</span> Materiales por agotar
                            </p>
                        </div>

                        <!-- Recetas sin usar -->
                        <div class="alert-card bg-gradient-to-br from-slate-50 to-gray-100 rounded-2xl shadow-lg border-2 border-slate-300 p-6 hover:shadow-2xl transition-all">
                            <h4 class="font-black text-slate-700 mb-3 flex items-center gap-2">
                                <span class="rotate-icon">üß™</span>
                                RB SIN USAR
                            </h4>
                            <p id="alerta-rb-sin-usar" class="text-3xl font-black text-slate-600 mb-2">0</p>
                            <p class="text-xs text-slate-600 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üî¨</span> Recetas base sin aplicar
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ========== SECCI√ìN 6: INSIGHTS ESTRAT√âGICOS ========== -->
                <div class="mb-8">
                    <h3 class="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">
                        <span class="text-2xl sparkle-icon">üíé</span>
                        INSIGHTS ESTRAT√âGICOS
                        <span class="text-xl dashboard-icon">üéØ</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Producto Estrella -->
                        <div class="insight-card bg-gradient-to-br from-yellow-400 to-amber-500 p-6 rounded-2xl shadow-lg border-2 border-yellow-300">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-4xl sparkle-icon">‚≠ê</span>
                                <div>
                                    <p class="text-xs font-bold text-yellow-900 flex items-center gap-1">
                                        <span class="pulse-icon">üèÜ</span> PRODUCTO ESTRELLA
                                    </p>
                                    <p class="text-sm text-yellow-900 font-semibold">(Mejor margen)</p>
                                </div>
                            </div>
                            <p id="insight-estrella" class="text-xl font-black text-yellow-900">-</p>
                        </div>

                        <!-- Producto a Revisar -->
                        <div class="insight-card bg-gradient-to-br from-red-400 to-rose-500 p-6 rounded-2xl shadow-lg border-2 border-red-300">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-4xl shake-icon">üîç</span>
                                <div>
                                    <p class="text-xs font-bold text-red-900 flex items-center gap-1">
                                        <span class="pulse-icon">‚ö†Ô∏è</span> A REVISAR
                                    </p>
                                    <p class="text-sm text-red-900 font-semibold">(Peor margen)</p>
                                </div>
                            </div>
                            <p id="insight-revisar" class="text-xl font-black text-red-900">-</p>
                        </div>

                        <!-- Categor√≠a M√°s Rentable -->
                        <div class="insight-card bg-gradient-to-br from-emerald-400 to-green-500 p-6 rounded-2xl shadow-lg border-2 border-emerald-300">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-4xl dashboard-icon">üèÜ</span>
                                <div>
                                    <p class="text-xs font-bold text-emerald-900 flex items-center gap-1">
                                        <span class="sparkle-icon">‚ú®</span> CATEGOR√çA TOP
                                    </p>
                                    <p class="text-sm text-emerald-900 font-semibold">(M√°s rentable)</p>
                                </div>
                            </div>
                            <p id="insight-categoria-top" class="text-xl font-black text-emerald-900">-</p>
                        </div>

                        <!-- √Årea M√°s Rentable -->
                        <div class="insight-card bg-gradient-to-br from-blue-400 to-cyan-500 p-6 rounded-2xl shadow-lg border-2 border-blue-300">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-4xl pulse-icon">üèÖ</span>
                                <div>
                                    <p class="text-xs font-bold text-blue-900 flex items-center gap-1">
                                        <span class="rotate-icon">üéñÔ∏è</span> √ÅREA TOP
                                    </p>
                                    <p class="text-sm text-blue-900 font-semibold">(M√°s rentable)</p>
                                </div>
                            </div>
                            <p id="insight-area-top" class="text-xl font-black text-blue-900">-</p>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- ========== SECCI√ìN: CALCULADORA DE EVENTOS Y BANQUETES ========== -->
        <section id="section-eventos" class="hidden">
            <div class="glass-card p-8 animate-in">
                <div class="section-header">
                    <div class="section-icon">
                        <span class="sparkle-icon">üéâ</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black flex items-center gap-2">
                            EVENTOS Y BANQUETES
                            <span class="text-xl dashboard-icon">ü•Ç</span>
                            <span class="text-lg pulse-icon">‚ú®</span>
                        </h2>
                        <p class="text-sm text-slate-500 font-medium flex items-center gap-2">
                            <span class="pulse-icon">üí∞</span>
                            Calculadora profesional de cotizaciones para eventos
                        </p>
                    </div>
                </div>

                <!-- TABS: CREAR EVENTO vs EVENTOS GUARDADOS -->
                <div class="flex gap-4 mb-6 border-b-2 border-slate-200">
                    <button onclick="mostrarTabEvento('crear')" id="tab-crear-evento" class="tab-evento-active px-6 py-3 font-bold text-sm transition-all">
                        <span class="sparkle-icon">‚ûï</span> CREAR EVENTO
                    </button>
                    <button onclick="mostrarTabEvento('guardados')" id="tab-guardados-evento" class="px-6 py-3 font-bold text-sm text-slate-500 hover:text-purple-600 transition-all">
                        <span class="pulse-icon">üìã</span> EVENTOS GUARDADOS
                    </button>
                </div>

                <!-- ========== TAB 1: CREAR EVENTO ========== -->
                <div id="contenido-crear-evento">
                    <!-- INFORMACI√ìN B√ÅSICA DEL EVENTO -->
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-2xl mb-6 border-2 border-purple-200">
                        <h3 class="font-black text-purple-700 mb-4 flex items-center gap-2">
                            <span class="text-xl pulse-icon">üìù</span>
                            INFORMACI√ìN DEL EVENTO
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-purple-700 mb-2">
                                    <span class="sparkle-icon">üé™</span> NOMBRE DEL EVENTO:
                                </label>
                                <input type="text" id="evento-nombre" placeholder="Ej: Boda Garc√≠a - L√≥pez" class="w-full p-3 border-2 border-purple-300 rounded-xl font-semibold focus:border-purple-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-purple-700 mb-2">
                                    <span class="pulse-icon">üìÖ</span> FECHA DEL EVENTO:
                                </label>
                                <input type="date" id="evento-fecha" class="w-full p-3 border-2 border-purple-300 rounded-xl font-semibold focus:border-purple-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-purple-700 mb-2">
                                    <span class="shake-icon">üë•</span> TOTAL PAX (PERSONAS):
                                </label>
                                <input type="number" id="evento-pax-total" placeholder="100" class="w-full p-3 border-2 border-purple-300 rounded-xl font-semibold text-center text-xl focus:border-purple-500 focus:outline-none" min="1" onchange="calcularResumenEvento()">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-purple-700 mb-2">
                                    <span class="sparkle-icon">üí∞</span> PROFIT DESEADO (%):
                                </label>
                                <input type="number" id="evento-profit" placeholder="35" class="w-full p-3 border-2 border-purple-300 rounded-xl font-semibold text-center text-xl focus:border-purple-500 focus:outline-none" min="0" max="100" step="0.1" onchange="calcularResumenEvento()">
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-purple-100 border border-purple-300 rounded-lg">
                            <p class="text-xs text-purple-700 font-semibold flex items-center gap-2">
                                <span class="pulse-icon">üí°</span>
                                <strong>TIP:</strong> El profit deseado se suma al costo para calcular el precio final. Ej: Si costo = S/. 1000 y profit = 35%, precio = S/. 1350
                            </p>
                        </div>
                    </div>

                    <!-- SELECTOR DE PLATOS PARA EL EVENTO -->
                    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-6 rounded-2xl mb-6 border-2 border-blue-200">
                        <h3 class="font-black text-blue-700 mb-4 flex items-center gap-2">
                            <span class="text-xl dashboard-icon">üçΩÔ∏è</span>
                            AGREGAR PLATOS AL MEN√ö
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-blue-700 mb-2">
                                    <span class="pulse-icon">üîç</span> BUSCAR PLATO:
                                </label>
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        id="evento-buscar-plato" 
                                        placeholder="Buscar por nombre del plato..." 
                                        class="w-full p-3 border-2 border-blue-300 rounded-xl font-semibold focus:border-blue-500 focus:outline-none"
                                        oninput="buscarPlatoEvento()"
                                        onfocus="buscarPlatoEvento()"
                                        autocomplete="off"
                                    >
                                    <div id="evento-sugerencias-platos" class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-blue-300 rounded-xl shadow-2xl max-h-80 overflow-y-auto"></div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-blue-700 mb-2">
                                    <span class="shake-icon">üë§</span> PAX PARA ESTE PLATO:
                                </label>
                                <input type="number" id="evento-pax-plato" placeholder="100" class="w-full p-3 border-2 border-blue-300 rounded-xl font-semibold text-center text-lg focus:border-blue-500 focus:outline-none" min="1">
                            </div>
                        </div>
                    </div>

                    <!-- TABLA: PLATOS AGREGADOS AL EVENTO -->
                    <div class="bg-white rounded-2xl shadow-lg border-2 border-emerald-200 p-6 mb-6">
                        <h3 class="font-black text-emerald-700 mb-4 flex items-center gap-2">
                            <span class="text-xl pulse-icon">üìã</span>
                            MEN√ö DEL EVENTO
                            <span class="text-sm sparkle-icon">‚ú®</span>
                        </h3>
                        <div class="overflow-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white">
                                    <tr>
                                        <th class="p-3 text-left font-bold">PLATO</th>
                                        <th class="p-3 text-center font-bold">PAX</th>
                                        <th class="p-3 text-right font-bold">COSTO/UNI</th>
                                        <th class="p-3 text-right font-bold">COSTO TOTAL</th>
                                        <th class="p-3 text-right font-bold">FC%</th>
                                        <th class="p-3 text-center font-bold">ACCIONES</th>
                                    </tr>
                                </thead>
                                <tbody id="evento-platos-tabla" class="divide-y divide-emerald-100">
                                    <tr>
                                        <td colspan="6" class="p-8 text-center text-slate-400 italic">
                                            <span class="text-4xl mb-2 block opacity-50">üçΩÔ∏è</span>
                                            No hay platos agregados. Busca y selecciona platos arriba.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- RESUMEN FINANCIERO DEL EVENTO -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <!-- Costo Total -->
                        <div class="kpi-card bg-gradient-to-br from-orange-500 to-amber-600 p-6 rounded-2xl shadow-lg border-2 border-orange-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl shake-icon">üí∞</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">COSTO</span>
                            </div>
                            <p id="evento-costo-total" class="text-3xl font-black text-white">S/. 0</p>
                            <p class="text-xs text-orange-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üìä</span> Costo Total Evento
                            </p>
                        </div>

                        <!-- FC% Promedio -->
                        <div class="kpi-card bg-gradient-to-br from-blue-500 to-cyan-600 p-6 rounded-2xl shadow-lg border-2 border-blue-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl dashboard-icon">üìà</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">FC%</span>
                            </div>
                            <p id="evento-fc-promedio" class="text-3xl font-black text-white">0%</p>
                            <p class="text-xs text-blue-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üéØ</span> FC% Promedio
                            </p>
                        </div>

                        <!-- Precio Sugerido -->
                        <div class="kpi-card bg-gradient-to-br from-emerald-500 to-green-600 p-6 rounded-2xl shadow-lg border-2 border-emerald-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl sparkle-icon">üíµ</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">PRECIO</span>
                            </div>
                            <p id="evento-precio-sugerido" class="text-3xl font-black text-white">S/. 0</p>
                            <p class="text-xs text-emerald-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">‚ú®</span> Precio Sugerido Total
                            </p>
                        </div>

                        <!-- Por Persona -->
                        <div class="kpi-card bg-gradient-to-br from-purple-500 to-pink-600 p-6 rounded-2xl shadow-lg border-2 border-purple-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl pulse-icon">üë§</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">POR PAX</span>
                            </div>
                            <p id="evento-precio-pax" class="text-3xl font-black text-white">S/. 0</p>
                            <p class="text-xs text-purple-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="sparkle-icon">üíé</span> Precio por Persona
                            </p>
                        </div>
                    </div>

                    <!-- BOTONES DE ACCI√ìN -->
                    <div class="flex gap-4 justify-end">
                        <button onclick="limpiarEvento()" class="bg-slate-500 text-white px-6 py-3 rounded-xl font-bold btn-action hover:bg-slate-600 transition-all flex items-center gap-2">
                            <span class="rotate-icon">üîÑ</span>
                            LIMPIAR
                        </button>
                        <button onclick="guardarEvento()" class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-6 py-3 rounded-xl font-bold btn-action shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center gap-2">
                            <span class="pulse-icon">üíæ</span>
                            GUARDAR EVENTO
                        </button>
                        <button onclick="exportarCotizacionPDF()" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-xl font-bold btn-action shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center gap-2">
                            <span class="sparkle-icon">üìÑ</span>
                            GENERAR PDF
                            <span class="dashboard-icon">‚ú®</span>
                        </button>
                    </div>
                </div>

                <!-- ========== TAB 2: EVENTOS GUARDADOS ========== -->
                <div id="contenido-guardados-evento" class="hidden">
                    <div class="bg-white rounded-2xl shadow-lg border-2 border-purple-200 p-6">
                        <h3 class="font-black text-purple-700 mb-4 flex items-center gap-2">
                            <span class="text-xl pulse-icon">üìö</span>
                            HISTORIAL DE EVENTOS
                            <span class="text-sm sparkle-icon">üéâ</span>
                        </h3>
                        <div id="eventos-guardados-lista" class="space-y-4">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- ========== SECCI√ìN: AN√ÅLISIS DE COMPRAS ========== -->
        <section id="section-compras" class="hidden">
            <div class="glass-card p-8 animate-in">
                <div class="section-header">
                    <div class="section-icon">
                        <span class="pulse-icon">üìÇ</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black flex items-center gap-2">
                            AN√ÅLISIS DE COMPRAS
                            <span class="text-xl sparkle-icon">üí∞</span>
                            <span class="text-lg dashboard-icon">üìä</span>
                        </h2>
                        <p class="text-sm text-slate-500 font-medium flex items-center gap-2">
                            <span class="pulse-icon">üìà</span>
                            Importaci√≥n y an√°lisis autom√°tico de compras desde Excel
                        </p>
                    </div>
                </div>

                <!-- ========== IMPORTACI√ìN DE EXCEL ========== -->
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-6 rounded-2xl mb-6 border-2 border-blue-200">
                    <h3 class="font-black text-blue-700 mb-4 flex items-center gap-2">
                        <span class="text-xl rotate-icon">üì§</span>
                        IMPORTAR DATOS DESDE EXCEL
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <input type="file" id="compras-excel-file" accept=".xlsx,.xls" class="hidden" onchange="importarExcelCompras(event)">
                            <button onclick="document.getElementById('compras-excel-file').click()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-6 py-4 rounded-xl font-bold btn-action shadow-lg hover:shadow-xl hover:scale-105 transition-all flex items-center justify-center gap-2">
                                <span class="text-2xl pulse-icon">üìÇ</span>
                                SELECCIONAR ARCHIVO EXCEL
                                <span class="sparkle-icon">‚ú®</span>
                            </button>
                            <p class="text-xs text-blue-600 mt-2 font-semibold">üìã Formato: Fecha (A), Descripci√≥n (F), Proveedor (G), Cantidad (J), Importe (L), Familia (M), Kardex (N)</p>
                            <p class="text-xs text-amber-600 mt-1 font-bold flex items-center gap-1">
                                <span class="pulse-icon">‚ö†Ô∏è</span> Datos temporales: Re-importar al reabrir el sistema
                            </p>
                        </div>
                        <div id="compras-info-importacion" class="bg-white p-4 rounded-xl border-2 border-blue-200">
                            <p class="text-xs font-bold text-blue-700 mb-2 flex items-center gap-1">
                                <span class="pulse-icon">‚ÑπÔ∏è</span> ESTADO DE IMPORTACI√ìN:
                            </p>
                            <div id="compras-estado" class="text-sm text-slate-600">
                                <p class="italic">‚è≥ Esperando archivo Excel...</p>
                                <p class="text-xs text-blue-600 mt-2 font-semibold">üí° Los datos se mantienen solo durante esta sesi√≥n</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BOTONES OPCIONALES: BACKUP JSON -->
                    <div id="compras-backup-section" class="hidden mt-4 pt-4 border-t-2 border-blue-200">
                        <p class="text-xs font-bold text-blue-700 mb-2">üîß OPCIONES AVANZADAS (OPCIONAL):</p>
                        <div class="flex gap-3 flex-wrap">
                            <button onclick="exportarComprasJSON()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-emerald-600 transition-all flex items-center gap-2">
                                <span>üíæ</span> EXPORTAR BACKUP JSON
                            </button>
                            <input type="file" id="compras-json-file" accept=".json" class="hidden" onchange="importarComprasJSON(event)">
                            <button onclick="document.getElementById('compras-json-file').click()" class="bg-purple-500 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-purple-600 transition-all flex items-center gap-2">
                                <span>üì•</span> IMPORTAR BACKUP JSON
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-2 italic">üí° Puedes guardar/cargar tus compras como archivo JSON para no re-importar el Excel cada vez</p>
                    </div>
                </div>

                <!-- ========== SECCI√ìN: KPIs PRINCIPALES ========== -->
                <div id="compras-kpis-section" class="hidden mb-8">
                    <h3 class="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">
                        <span class="text-2xl sparkle-icon">üéØ</span>
                        INDICADORES CLAVE
                        <span class="text-xl pulse-icon">üíé</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Total Comprado -->
                        <div class="kpi-card bg-gradient-to-br from-emerald-500 to-green-600 p-6 rounded-2xl shadow-lg border-2 border-emerald-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl shake-icon">üí∞</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">TOTAL</span>
                            </div>
                            <p id="kpi-compras-total" class="text-4xl font-black text-white">S/. 0</p>
                            <p class="text-xs text-emerald-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üìä</span> Total Comprado
                            </p>
                        </div>

                        <!-- Total Art√≠culos -->
                        <div class="kpi-card bg-gradient-to-br from-blue-500 to-cyan-600 p-6 rounded-2xl shadow-lg border-2 border-blue-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl dashboard-icon">üì¶</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">SKUs</span>
                            </div>
                            <p id="kpi-compras-articulos" class="text-4xl font-black text-white">0</p>
                            <p class="text-xs text-blue-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üéØ</span> Art√≠culos √önicos
                            </p>
                        </div>

                        <!-- Total Proveedores -->
                        <div class="kpi-card bg-gradient-to-br from-purple-500 to-pink-600 p-6 rounded-2xl shadow-lg border-2 border-purple-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl pulse-icon">üè¢</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">SUPPLIERS</span>
                            </div>
                            <p id="kpi-compras-proveedores" class="text-4xl font-black text-white">0</p>
                            <p class="text-xs text-purple-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="sparkle-icon">‚ú®</span> Proveedores Activos
                            </p>
                        </div>

                        <!-- Compra Promedio -->
                        <div class="kpi-card bg-gradient-to-br from-orange-500 to-amber-600 p-6 rounded-2xl shadow-lg border-2 border-orange-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl rotate-icon">üìã</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">PROMEDIO</span>
                            </div>
                            <p id="kpi-compras-promedio" class="text-4xl font-black text-white">S/. 0</p>
                            <p class="text-xs text-orange-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="pulse-icon">üí≥</span> Por Orden
                            </p>
                        </div>

                        <!-- Top Familia -->
                        <div class="kpi-card bg-gradient-to-br from-rose-500 to-red-600 p-6 rounded-2xl shadow-lg border-2 border-rose-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl sparkle-icon">üéØ</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">TOP</span>
                            </div>
                            <p id="kpi-compras-top-familia" class="text-2xl font-black text-white">-</p>
                            <p class="text-xs text-rose-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="dashboard-icon">üèÜ</span> Familia M√°s Comprada
                            </p>
                        </div>

                        <!-- Frecuencia -->
                        <div class="kpi-card bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-2xl shadow-lg border-2 border-indigo-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-3xl pulse-icon">‚ö°</span>
                                <span class="text-xs font-bold text-white bg-white bg-opacity-20 px-3 py-1 rounded-full">FRECUENCIA</span>
                            </div>
                            <p id="kpi-compras-frecuencia" class="text-4xl font-black text-white">0</p>
                            <p class="text-xs text-indigo-100 mt-2 font-semibold flex items-center gap-1">
                                <span class="shake-icon">üìÖ</span> Compras por D√≠a
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Resto del contenido ser√° agregado en la siguiente parte -->
                <div id="compras-analisis-section" class="hidden">
                    <!-- B√öSQUEDA PREDICTIVA -->
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-2xl mb-6 border-2 border-purple-200">
                        <h3 class="font-black text-purple-700 mb-4 flex items-center gap-2">
                            <span class="text-xl pulse-icon">üîç</span>
                            B√öSQUEDA PREDICTIVA DE PRODUCTOS
                        </h3>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="compras-buscar-producto" 
                                placeholder="üîç Buscar producto por descripci√≥n..." 
                                class="w-full p-4 pr-12 border-2 border-purple-300 rounded-xl font-semibold text-lg focus:border-purple-500 focus:outline-none"
                                oninput="buscarProductoCompras()"
                                onfocus="buscarProductoCompras()"
                                autocomplete="off"
                            >
                            <!-- Bot√≥n X para limpiar b√∫squeda -->
                            <button 
                                id="compras-btn-limpiar-busqueda"
                                onclick="limpiarBusquedaCompras()"
                                class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 z-10 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold hover:bg-red-600 transition-all shadow-lg hover:scale-110"
                                title="Limpiar b√∫squeda"
                            >
                                ‚úñ
                            </button>
                            <div id="compras-sugerencias" class="hidden absolute z-50 w-full mt-2 bg-white border-2 border-purple-300 rounded-xl shadow-2xl max-h-96 overflow-y-auto"></div>
                        </div>
                    </div>

                    <!-- DETALLE DEL PRODUCTO SELECCIONADO -->
                    <div id="compras-detalle-producto" class="hidden bg-white rounded-2xl shadow-lg border-2 border-blue-200 p-6 mb-6">
                        <!-- Se llena din√°micamente -->
                    </div>

                    <!-- TOP PROVEEDORES Y TOP PRODUCTOS -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Top Proveedores -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-emerald-200 p-6">
                            <h3 class="font-black text-emerald-700 mb-4 flex items-center gap-2">
                                <span class="text-xl dashboard-icon">üèÜ</span>
                                TOP 10 PROVEEDORES
                                <span class="text-sm sparkle-icon">‚ú®</span>
                            </h3>
                            <div id="compras-top-proveedores" class="space-y-3">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>

                        <!-- Top Productos -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-blue-200 p-6">
                            <h3 class="font-black text-blue-700 mb-4 flex items-center gap-2">
                                <span class="text-xl pulse-icon">üì¶</span>
                                TOP 10 PRODUCTOS M√ÅS COMPRADOS
                                <span class="text-sm shake-icon">üéØ</span>
                            </h3>
                            <div id="compras-top-productos" class="space-y-3">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <!-- AN√ÅLISIS POR FAMILIA -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Gr√°fico de Familia -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-purple-200 p-6">
                            <h3 class="font-black text-purple-700 mb-4 flex items-center gap-2">
                                <span class="dashboard-icon">üìä</span>
                                DISTRIBUCI√ìN POR FAMILIA
                            </h3>
                            <div style="max-height: 400px;">
                                <canvas id="chart-compras-familias"></canvas>
                            </div>
                        </div>

                        <!-- Tabla de Familias -->
                        <div class="bg-white rounded-2xl shadow-lg border-2 border-rose-200 p-6">
                            <h3 class="font-black text-rose-700 mb-4 flex items-center gap-2">
                                <span class="pulse-icon">üìã</span>
                                RESUMEN POR FAMILIA
                            </h3>
                            <div id="compras-tabla-familias" class="overflow-auto max-h-96">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <!-- GR√ÅFICO TEMPORAL -->
                    <div class="bg-white rounded-2xl shadow-lg border-2 border-indigo-200 p-6 mb-8">
                        <h3 class="font-black text-indigo-700 mb-4 flex items-center gap-2">
                            <span class="text-xl rotate-icon">üìà</span>
                            AN√ÅLISIS TEMPORAL DE COMPRAS
                            <span class="text-sm sparkle-icon">‚ö°</span>
                        </h3>
                        <div class="mb-4 flex gap-2 flex-wrap">
                            <button onclick="filtrarComprasPorPeriodo('hoy')" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-bold text-xs hover:bg-indigo-200 transition-all">üìÖ HOY</button>
                            <button onclick="filtrarComprasPorPeriodo('semana')" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-bold text-xs hover:bg-indigo-200 transition-all">üìÖ ESTA SEMANA</button>
                            <button onclick="filtrarComprasPorPeriodo('mes')" class="px-4 py-2 bg-indigo-500 text-white rounded-lg font-bold text-xs hover:bg-indigo-600 transition-all">üìÖ ESTE MES</button>
                            <button onclick="filtrarComprasPorPeriodo('trimestre')" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-bold text-xs hover:bg-indigo-200 transition-all">üìÖ TRIMESTRE</button>
                            <button onclick="filtrarComprasPorPeriodo('a√±o')" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-bold text-xs hover:bg-indigo-200 transition-all">üìÖ A√ëO</button>
                            <button onclick="filtrarComprasPorPeriodo('todo')" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-bold text-xs hover:bg-indigo-200 transition-all">üìÖ TODO</button>
                        </div>
                        <div style="height: 300px;">
                            <canvas id="chart-compras-temporal"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </section>
        
        <section id="section-bom">
            <div class="glass-card p-8 animate-in">
                <div class="section-header">
                    <div class="section-icon">üì¶</div>
                    <div>
                        <h2 class="text-2xl font-black">CAT√ÅLOGO DE MATERIALES</h2>
                        <p class="text-sm text-slate-500 font-medium">Gesti√≥n de insumos y materias primas</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex gap-2 w-full md:w-auto">
                        <div class="relative flex-1 md:w-96">
                            <input 
                                type="text" 
                                id="search-materials" 
                                placeholder="üîç Buscar material..." 
                                class="search-box w-full" 
                                oninput="mostrarSugerenciasMateriales()"
                                autocomplete="off"
                            >
                            <div id="sugerencias-materiales" class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-slate-300 rounded-xl shadow-2xl max-h-60 overflow-y-auto"></div>
                        </div>
                        <select id="filter-alergenos" class="input-corp w-48" onchange="renderMaterials()">
                            <option value="">üîç Filtrar por al√©rgeno</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="limpiarBusquedaMateriales()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-300 btn-action">
                            ‚ùå LIMPIAR
                        </button>
                        <button id="btn-exportar-materiales" onclick="exportarMaterialesExcel()" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-xl text-xs font-bold btn-action hover:shadow-lg">
                            üìä EXPORTAR A EXCEL
                        </button>
                        <button id="btn-pegar-materiales" onclick="openPasteModal()" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-xl text-xs font-bold btn-action">
                            üìã PEGAR DESDE EXCEL
                        </button>
                    </div>
                </div>
                
                <p id="contador-materiales" class="text-xs text-slate-500 mb-4 font-semibold"></p>

                <div id="form-crear-material" class="bg-gradient-to-br from-slate-50 to-blue-50 p-6 rounded-2xl mb-6 border-2 border-slate-200">
                    <input id="m-sku-hidden" type="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-4">
                    <input id="m-nombre" type="text" placeholder="Nombre del material" class="input-corp">
                    <select id="m-familia" class="input-corp">
    <option value="">-- Seleccionar Familia --</option>
</select>                             <input id="m-u-compra" type="text" placeholder="U. Compra" class="input-corp">
                    <input id="m-u-costo" type="text" placeholder="U. Costo" class="input-corp">
                    <input id="m-factor" type="number" placeholder="Factor" class="input-corp" step="0.01">
                    <input id="m-precio" type="number" placeholder="Precio S/." class="input-corp" step="0.01">
                    </div>
                    
                    <!-- CAMPO DE AL√âRGENOS -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-slate-700 mb-2">‚ö†Ô∏è Al√©rgenos (selecciona todos los que apliquen):</label>
                        <div id="m-alergenos-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 p-4 bg-white rounded-xl border-2 border-slate-200">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                    
                    <button onclick="addMaterial()" class="w-full bg-gradient-to-r from-slate-700 to-slate-900 text-white py-4 btn-action font-bold text-sm">
                        ‚úÖ GUARDAR MATERIAL
                    </button>
                </div>

               <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <table class="w-full text-left text-sm bg-white rounded-2xl overflow-hidden">
        <thead style="position: sticky; top: 0; z-index: 10; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <tr>
                <th>C√ìDIGO</th>
                <th>NOMBRE</th>
                <th>FAMILIA</th>
                <th>AL√âRGENOS</th>
                <th>U. COMPRA</th>
                <th>U. COSTO</th>
                <th>FACTOR</th>
                <th>PRECIO</th>
                <th>STOCK</th>
                <th id="th-acciones-materiales" class="text-right">ACCIONES</th>
            </tr>
        </thead>
        <tbody id="table-materials" class="divide-y divide-slate-100"></tbody>
    </table>
</div>
            </div>
        </section>

        <section id="section-bases" class="hidden">
            <div class="glass-card p-8 animate-in">
                <div class="section-header">
                    <div class="section-icon">üß™</div>
                    <div>
                        <h2 class="text-2xl font-black">RECETAS BASE</h2>
                        <p class="text-sm text-slate-500 font-medium">Preparaciones fundamentales, Ojo con los rendiemintos poner siempre en Unidad de Costo, 1 Kg de RB SALSA BLANCA, deberia ir 1000 G</p>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex gap-2 items-center mb-3">
                        <div class="relative flex-1">
                            <input 
                                type="text" 
                                id="search-bases" 
                                placeholder="üîç Buscar receta base..." 
                                class="search-box w-full" 
                                onkeyup="renderBases()"
                                oninput="mostrarSugerenciasRecetasBase()"
                                autocomplete="off"
                            >
                            <div id="sugerencias-recetas-base" class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-emerald-300 rounded-xl shadow-2xl max-h-60 overflow-y-auto"></div>
                        </div>
                        <button onclick="limpiarBusquedaBases()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-300 btn-action">
                            ‚ùå LIMPIAR
                        </button>
                    </div>
                    
                    <!-- Bot√≥n Producci√≥n Masiva -->
                    <div class="flex gap-3">
                        <button onclick="abrirModalProduccionMasiva()" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl font-bold btn-action shadow-lg hover:shadow-xl">
                            üè≠ PRODUCCI√ìN MASIVA DE RECETAS BASE
                        </button>
                    </div>
                    
                    <p id="contador-recetas-base" class="text-xs text-slate-500 mt-2 font-semibold"></p>
                </div>

                <div id="formulario-crear-rb" class="bg-gradient-to-br from-emerald-50 to-teal-50 p-6 rounded-2xl mb-8 border-2 border-emerald-200">
                    <input id="b-sku-hidden" type="hidden">
                    
                    <!-- SELECTOR DE MODO -->
                    <div class="flex gap-3 mb-6">
                        <button id="btn-modo-manual" onclick="cambiarModoRecetaBase('manual')" class="flex-1 bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-3 rounded-xl font-bold btn-action">
                            ‚úçÔ∏è MODO MANUAL
                        </button>
                        <button id="btn-modo-excel" onclick="cambiarModoRecetaBase('excel')" class="flex-1 bg-slate-200 text-slate-600 py-3 rounded-xl font-bold btn-action">
                            üìä PEGAR DESDE EXCEL
                        </button>
                    </div>
                    
                    <!-- DATOS B√ÅSICOS (SIEMPRE VISIBLE) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input id="b-nombre" type="text" placeholder="Nombre de la receta" class="input-corp">
                        <input id="b-rendimiento" type="number" placeholder="Rendimiento" class="input-corp" step="0.01">
                        <input id="b-unidad" type="text" placeholder="Unidad Final" class="input-corp">
                    </div>
                    
                    <!-- MODO MANUAL (DEFAULT) -->
                    <div id="modo-manual-rb" class="modo-rb-activo">
                        <div class="bg-white p-5 rounded-xl border-2 border-dashed border-emerald-300 mb-4">
                            <p class="text-xs font-bold text-slate-600 mb-3">A√ëADIR INGREDIENTES</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        id="b-insumo-buscar" 
                                        class="input-corp" 
                                        placeholder="üîç Buscar material..."
                                        autocomplete="off"
                                        oninput="buscarMaterialRB()"
                                        onfocus="mostrarResultadosRB()"
                                        onkeydown="navegarResultadosRB(event)"
                                    >
                                    <input type="hidden" id="b-insumo">
                                    <div id="rb-resultados-busqueda" class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-emerald-300 rounded-xl shadow-2xl max-h-80 overflow-y-auto"></div>
                                </div>
                                <input id="b-cant" type="number" class="input-corp" placeholder="Cantidad" step="0.01" onkeydown="if(event.key==='Enter')addToBaseTemp()">
                                <button onclick="addToBaseTemp()" class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white btn-action font-bold">
                                    ‚ûï A√ëADIR
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MODO PEGAR EXCEL -->
                    <div id="modo-excel-rb" class="hidden">
                        <div class="bg-white p-5 rounded-xl border-2 border-dashed border-blue-300 mb-4">
                            <p class="text-xs font-bold text-slate-600 mb-2">üìä PEGA TUS DATOS DESDE EXCEL</p>
                            <p class="text-xs text-slate-500 mb-3">
                                Copia y pega desde Excel con columnas: <span class="font-bold">Ingrediente | Cantidad | Unidad</span><br>
                                Ejemplo: <span class="font-mono text-[10px]">Cebolla Roja    200    GR</span>
                            </p>
                            <textarea 
                                id="excel-paste-area" 
                                class="w-full h-48 border-2 border-blue-200 rounded-xl p-3 text-sm font-mono"
                                placeholder="Pega aqu√≠ los datos copiados de Excel...&#10;&#10;Ejemplo:&#10;Cebolla Roja	200	GR&#10;Tomate	150	GR&#10;Aceite	50	ML"></textarea>
                            <div class="flex gap-3 mt-3">
                                <button onclick="procesarExcelPegado()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl font-bold btn-action">
                                    ‚ö° PROCESAR DATOS
                                </button>
                                <button onclick="limpiarExcelPegado()" class="px-6 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold btn-action">
                                    üóëÔ∏è LIMPIAR
                                </button>
                            </div>
                        </div>
                    </div>

                    <table class="w-full text-xs bg-white border rounded-xl mb-4 overflow-hidden">
                        <thead class="bg-emerald-100">
                            <tr>
                                <th class="p-3">INGREDIENTE</th>
                                <th width="140" class="p-3">CANTIDAD</th>
                                <th class="p-3">UNIDAD</th>
                                <th class="p-3">COSTO</th>
                                <th class="p-3">AL√âRGENOS</th>
                                <th class="p-3">ACCI√ìN</th>
                            </tr>
                        </thead>
                        <tbody id="b-edit-table-body" class="divide-y"></tbody>
                    </table>
                     <div class="bg-white p-5 rounded-xl border-2 border-dashed border-emerald-300 mb-4">
    <p class="text-xs font-bold text-slate-600 mb-2">
        üìù INSTRUCCIONES DE PREPARACI√ìN
    </p>
    <textarea
        id="b-instrucciones"
        class="w-full h-40 border-2 border-emerald-200 rounded-xl p-3 text-sm font-medium"
        placeholder="1. Paso uno&#10;2. Paso dos&#10;3. Paso tres"></textarea>
</div>

                    <!-- üì∏ GALER√çA DE FOTOS (NUEVO) -->
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-5 rounded-xl border-2 border-purple-200 mb-4">
                        <p class="text-sm font-bold text-purple-700 mb-2 flex items-center gap-2">
                            <span class="text-xl">üì∏</span>
                            GALER√çA DE FOTOS
                            <span class="sparkle-icon text-sm">‚ú®</span>
                        </p>
                        <p class="text-xs text-slate-600 mb-4">Agrega fotos del proceso de preparaci√≥n y resultado final</p>
                        
                        <!-- Input file oculto -->
                        <input type="file" id="rb-foto-input" accept="image/*" multiple class="hidden" onchange="agregarFotosRB(event)">
                        
                        <!-- Bot√≥n para agregar fotos -->
                        <button onclick="document.getElementById('rb-foto-input').click()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl font-bold btn-action mb-4 flex items-center justify-center gap-2">
                            <span class="text-xl">üì∑</span>
                            AGREGAR FOTOS
                            <span class="text-xs bg-white/20 px-2 py-1 rounded">(M√°x 5)</span>
                        </button>
                        
                        <!-- Galer√≠a de fotos -->
                        <div id="rb-galeria-fotos" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                            <!-- Las fotos se mostrar√°n aqu√≠ -->
                        </div>
                        
                        <div class="mt-3 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                            <p class="text-xs text-purple-800">
                                üí° <strong>Tip:</strong> Fotos claras ayudan al personal a replicar la receta exactamente
                            </p>
                        </div>
                    </div>

                    <!-- INFORMACI√ìN DE CONSERVACI√ìN -->
                    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-5 rounded-xl border-2 border-blue-200 mb-4">
                        <p class="text-sm font-bold text-blue-700 mb-4">‚ùÑÔ∏è INFORMACI√ìN DE CONSERVACI√ìN Y VIDA √öTIL</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- VIDA √öTIL TEMPERATURA AMBIENTE -->
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-2">üå°Ô∏è Temp. Ambiente</label>
                                <input 
                                    id="b-vida-ambiente" 
                                    type="text" 
                                    placeholder="Ej: 2 horas, No recomendado" 
                                    class="input-corp">
                            </div>
                            
                            <!-- VIDA √öTIL REFRIGERADO -->
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-2">üßä Refrigerado (0-4¬∞C)</label>
                                <input 
                                    id="b-vida-refrigerado" 
                                    type="text" 
                                    placeholder="Ej: 3-5 d√≠as, 72 horas" 
                                    class="input-corp">
                            </div>
                            
                            <!-- VIDA √öTIL CONGELADO -->
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-2">‚ùÑÔ∏è Congelado (-18¬∞C)</label>
                                <input 
                                    id="b-vida-congelado" 
                                    type="text" 
                                    placeholder="Ej: 3 meses, 90 d√≠as" 
                                    class="input-corp">
                            </div>
                        </div>
                        
                        <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-xs text-yellow-800">
                                üí° <strong>Tip:</strong> Especifica claramente los tiempos para garantizar la seguridad alimentaria
                            </p>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="saveFinalBase()" class="flex-1 bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-4 btn-action font-bold">
                            üíæ GUARDAR RECETA BASE
                        </button>
                        <button onclick="clearRBForm()" class="px-8 bg-slate-200 text-slate-700 py-4 btn-action font-bold">
                            ‚ùå CANCELAR
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl border-2 border-slate-200 overflow-hidden">
                    <div class="max-h-[600px] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gradient-to-r from-emerald-600 to-teal-600 sticky top-0 z-10">
                                <tr>
                                    <th class="p-4 text-left font-bold text-white">RECETA BASE</th>
                                    <th class="p-4 text-center font-bold text-white">RENDIMIENTO</th>
                                    <th class="p-4 text-center font-bold text-white">INGREDIENTES</th>
                                    <th class="p-4 text-right font-bold text-white">ACCIONES</th>
                                </tr>
                            </thead>
                            <tbody id="list-bases">
                                <!-- Se llena din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="section-menu" class="hidden">
            <div class="glass-card p-8 animate-in">
                <div class="section-header">
                    <div class="section-icon">üçΩÔ∏è</div>
                    <div>
                        <h2 class="text-2xl font-black">CARTA & BEBIDAS</h2>
                        <p class="text-sm text-slate-500 font-medium">Gesti√≥n de platos, bebidas, c√≥cteles y productos</p>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="search-platos" 
                            placeholder="üîç Buscar plato..." 
                            class="search-box w-full" 
                            oninput="mostrarSugerenciasPlatos()"
                            autocomplete="off"
                        >
                        <div id="sugerencias-platos" class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-orange-300 rounded-xl shadow-2xl max-h-60 overflow-y-auto"></div>
                    </div>
                    <p id="contador-platos" class="text-xs text-slate-500 mt-2 font-semibold"></p>
                </div>

                <div class="mb-6">
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-2xl border-2 border-purple-200">
                        <h3 class="text-lg font-black text-purple-700 mb-4">üìÑ EXPORTAR CARTA A PDF</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <select id="filter-cocina-pdf" class="input-corp">
                                <option value="">üè® TODAS LAS √ÅREAS</option>
                                <!-- Se llena din√°micamente desde db.areas -->
                            </select>
                            
                            <button onclick="exportPlatosMenuPDF()" class="bg-gradient-to-r from-red-600 to-pink-600 text-white px-6 py-3 rounded-xl font-bold btn-action">
                                üìÑ DESCARGAR CARTA PDF
                            </button>
                        </div>
                        
                        <p class="text-xs text-purple-600 font-semibold">
                            üí° Selecciona una cocina espec√≠fica o deja "TODAS" para exportar la carta completa agrupada por categor√≠as y cocinas.
                        </p>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-orange-50 to-amber-50 p-6 rounded-2xl mb-8 border-2 border-orange-200">
                    <input id="p-sku-hidden" type="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <input id="p-nombre" type="text" placeholder="Nombre del plato" class="input-corp">
                        
                        <select id="p-categoria" class="input-corp" onchange="calculatePlatoMetrics()">
                            <option value="">-- Selecciona categor√≠a --</option>
                            <!-- Las categor√≠as se cargan din√°micamente desde db.categorias -->
                        </select>
                        
                        <select id="p-cocina" class="input-corp">
                            <option value="">-- Selecciona √°rea --</option>
                            <!-- Se llena din√°micamente desde db.areas -->
                        </select>
                        
                        <select id="p-tipo" class="input-corp" onchange="toggleInventarioSelector()">
                            <option value="PREPARADO">üë®‚Äçüç≥ CON RECETA (Se elabora en cocina)</option>
                            <option value="PRODUCTO_TERMINADO">üì¶ DIRECTO (Sale del inventario)</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <select id="p-tipo-carta" class="input-corp">
                            <option value="CARTA">üìÑ CARTA PRINCIPAL</option>
                            <option value="MENU">üìã MEN√ö DEL D√çA</option>
                        </select>
                        
                        <input id="p-precio-menu" type="number" placeholder="Precio: S/." class="input-corp" step="0.01" onchange="calculatePlatoMetrics()">
                    </div>
                    
                    <!-- TARJETAS DE M√âTRICAS FINANCIERAS -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="metric-card bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-2xl shadow-lg border-2 border-blue-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="metric-icon">üí∞</span>
                                <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                                    <p class="text-xs font-bold text-white">COSTO</p>
                                </div>
                            </div>
                            <p id="p-costo-receta" class="text-2xl font-black text-white">S/. 0.00</p>
                            <p class="text-xs text-blue-100 mt-1 font-semibold">Cost per Recipe</p>
                        </div>
                        
                        <div class="metric-card bg-gradient-to-br from-purple-500 to-purple-600 p-5 rounded-2xl shadow-lg border-2 border-purple-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="metric-icon">üí≥</span>
                                <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                                    <p class="text-xs font-bold text-white">SIN IGV</p>
                                </div>
                            </div>
                            <p id="p-precio-sin-igv" class="text-2xl font-black text-white">S/. 0.00</p>
                            <p class="text-xs text-purple-100 mt-1 font-semibold">Price Excluding VAT</p>
                        </div>
                        
                        <div class="metric-card bg-gradient-to-br from-emerald-500 to-emerald-600 p-5 rounded-2xl shadow-lg border-2 border-emerald-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="metric-icon">üìä</span>
                                <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                                    <p id="p-etiqueta-costo-corta" class="text-xs font-bold text-white">FC%</p>
                                </div>
                            </div>
                            <p id="p-fc-porcentaje" class="text-2xl font-black text-white">0.00%</p>
                            <p id="p-etiqueta-costo-completa" class="text-xs text-emerald-100 mt-1 font-semibold">Food Cost</p>
                        </div>
                        
                        <div class="metric-card bg-gradient-to-br from-orange-500 to-amber-600 p-5 rounded-2xl shadow-lg border-2 border-orange-300">
                            <div class="flex items-center justify-between mb-2">
                                <span class="metric-icon">‚≠ê</span>
                                <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full">
                                    <p class="text-xs font-bold text-white">IDEAL</p>
                                </div>
                            </div>
                            <p id="p-precio-ideal" class="text-2xl font-black text-white">S/. 0.00</p>
                            <p id="p-margen-usado" class="text-xs text-orange-100 mt-1 font-semibold">Margen FC: --</p>
                        </div>
                    </div>
                    
                    <!-- SELECTOR DE MATERIAL PARA PRODUCTOS DIRECTOS -->
                    <div id="contenedor-sku-inventario" class="hidden mb-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
                        <p class="text-xs font-bold text-blue-700 mb-2">üì¶ PRODUCTO DIRECTO - Vincula con material en inventario:</p>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="p-sku-inventario-buscar" 
                                placeholder="üîç Buscar material..." 
                                class="input-corp"
                                autocomplete="off"
                                oninput="buscarMaterialInventarioPlato()"
                                onfocus="buscarMaterialInventarioPlato()"
                            >
                            <input type="hidden" id="p-sku-inventario">
                            <div id="p-sku-inventario-sugerencias" class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-blue-300 rounded-xl shadow-2xl max-h-60 overflow-y-auto"></div>
                        </div>
                        <p class="text-xs text-blue-600 mt-2">‚ÑπÔ∏è El stock se descontar√° autom√°ticamente del inventario al vender</p>
                    </div>

<!-- üì∏ NUEVA SECCI√ìN PARA FOTO -->
<div class="bg-white p-5 rounded-xl border-2 border-dashed border-orange-300 mb-4">
    <p class="text-xs font-bold text-slate-600 mb-3">üì∏ FOTO DEL PLATO (Opcional)</p>
    <div class="flex gap-4 items-center">
        <label class="bg-gradient-to-r from-orange-600 to-amber-600 text-white px-6 py-3 rounded-xl font-bold cursor-pointer btn-action text-sm">
            üñºÔ∏è SELECCIONAR IMAGEN
            <input type="file" id="p-foto" accept="image/*" class="hidden" onchange="previewPlatoImage(this)">
        </label>
        <button onclick="eliminarFotoPlato()" class="bg-red-100 text-red-600 px-4 py-3 rounded-xl font-bold btn-action text-sm">
            üóëÔ∏è ELIMINAR FOTO
        </button>
    </div>
    <div id="p-preview" class="mt-4 hidden">
        <p class="text-xs font-semibold text-slate-600 mb-2">Vista previa:</p>
        <img id="p-preview-img" class="w-full max-w-xs rounded-xl border-2 border-orange-200 shadow-lg">
    </div>
</div>
                    
                    <div class="bg-white p-5 rounded-xl border-2 border-dashed border-orange-300 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-xs font-bold text-slate-600">A√ëADIR COMPONENTES</p>
                            <button onclick="openPasteModalPlato()" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-xl text-xs font-bold btn-action">
                                üìã PEGAR DESDE EXCEL
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="p-item-buscar" 
                                    class="input-corp" 
                                    placeholder="üîç Buscar material o receta base..."
                                    autocomplete="off"
                                    oninput="buscarRecetaPlato()"
                                    onfocus="mostrarResultadosPlato()"
                                    onkeydown="navegarResultadosPlato(event)"
                                >
                                <input type="hidden" id="p-item-selector">
                                <div id="plato-resultados-busqueda" class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-orange-300 rounded-xl shadow-2xl max-h-80 overflow-y-auto"></div>
                            </div>
                            <input id="p-cant" type="number" class="input-corp" placeholder="Cantidad" step="0.01" onkeydown="if(event.key==='Enter')addToPlatoTemp()">
                            <button onclick="addToPlatoTemp()" class="bg-gradient-to-r from-orange-600 to-amber-600 text-white btn-action font-bold">
                                ‚ûï A√ëADIR
                            </button>
                        </div>
                    </div>

                    <table class="w-full text-xs bg-white border rounded-xl mb-4 overflow-hidden">
                        <thead class="bg-orange-100">
                            <tr>
                                <th class="p-3 text-left">COMPONENTE</th>
                                <th width="120" class="p-3 text-right">CANTIDAD</th>
                                <th width="80" class="p-3 text-center">UNIDAD</th>
                                <th width="100" class="p-3 text-right">PRECIO UNIT.</th>
                                <th width="100" class="p-3 text-right">COSTO TOTAL</th>
                                <th width="80" class="p-3 text-center">ACCI√ìN</th>
                            </tr>
                        </thead>
                        <tbody id="p-edit-table-body" class="divide-y"></tbody>
                        <tfoot id="p-edit-table-footer" class="bg-orange-50 border-t-2 border-orange-200"></tfoot>
                    </table>
                    
<!-- üìù DESCRIPCI√ìN PROFESIONAL DEL PLATO -->
<div class="bg-gradient-to-br from-purple-50 to-pink-50 p-5 rounded-xl border-2 border-purple-200 mb-4">
    <div class="flex items-center gap-2 mb-4">
        <span class="text-2xl">üìù</span>
        <h3 class="text-lg font-black text-purple-700">HOJA DE CATA - DESCRIPCI√ìN PROFESIONAL</h3>
    </div>
    
    <!-- Descripci√≥n -->
    <div class="mb-4">
        <label class="text-xs font-bold text-purple-700 block mb-2">‚ú® DESCRIPCI√ìN:</label>
        <textarea 
            id="p-descripcion" 
            rows="3" 
            placeholder="Describe el producto de manera atractiva para el cliente..."
            class="w-full border-2 border-purple-200 rounded-xl p-3 text-sm focus:border-purple-400 focus:outline-none"
        ></textarea>
        <p class="text-xs text-purple-600 mt-1">üí° Para platos, bebidas, c√≥cteles, etc.</p>
    </div>
    
    <!-- Instrucciones de Preparaci√≥n -->
    <div class="mb-4">
        <label class="text-xs font-bold text-purple-700 block mb-2">üë®‚Äçüç≥ INSTRUCCIONES DE PREPARACI√ìN:</label>
        <textarea 
            id="p-instrucciones" 
            rows="4" 
            placeholder="Pasos detallados para la preparaci√≥n..."
            class="w-full border-2 border-purple-200 rounded-xl p-3 text-sm focus:border-purple-400 focus:outline-none font-mono"
        ></textarea>
    </div>
    
    <!-- Venta Sugestiva -->
    <div class="mb-4">
        <label class="text-xs font-bold text-purple-700 block mb-2">üí¨ VENTA SUGESTIVA (Pitch de Venta):</label>
        <textarea 
            id="p-venta-sugestiva" 
            rows="2" 
            placeholder="Frase atractiva para sugerir el producto al cliente..."
            class="w-full border-2 border-purple-200 rounded-xl p-3 text-sm focus:border-purple-400 focus:outline-none italic"
        ></textarea>
    </div>
    
    <!-- Adjetivos Descriptivos -->
    <div class="mb-4">
        <label class="text-xs font-bold text-purple-700 block mb-2">üè∑Ô∏è ADJETIVOS INFORMATIVOS:</label>
        <input 
            id="p-adjetivos" 
            type="text" 
            placeholder="Ej: Delicioso, Crocante, Sabroso, Elegante, Fusi√≥n..."
            class="w-full border-2 border-purple-200 rounded-xl p-3 text-sm focus:border-purple-400 focus:outline-none"
        >
        <p class="text-xs text-purple-600 mt-1">üí° Separa los adjetivos con comas</p>
    </div>
    
    <!-- Maridaje -->
    <div class="mb-4">
        <label class="text-xs font-bold text-purple-700 block mb-2">üç∑ MARIDAJE:</label>
        <input 
            id="p-maridaje" 
            type="text" 
            placeholder="Ej: Vino Blanco Sauvignon, Cerveza Artesanal, Pisco Sour..."
            class="w-full border-2 border-purple-200 rounded-xl p-3 text-sm focus:border-purple-400 focus:outline-none"
        >
        <p class="text-xs text-purple-600 mt-1">üçΩÔ∏è Con qu√© bebida o alimento acompa√±ar</p>
    </div>
</div>

                    <div class="flex gap-3">
                        <button onclick="saveFinalPlato()" id="btn-guardar-plato" class="flex-1 bg-gradient-to-r from-slate-700 to-slate-900 text-white py-4 btn-action font-bold">
                            üíæ GUARDAR PRODUCTO
                        </button>
                        <button onclick="clearPlatoForm()" class="px-8 bg-slate-200 text-slate-700 py-4 btn-action font-bold">
                            ‚ùå CANCELAR
                        </button>
                    </div>
                </div>

                <div id="list-platos" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>
        </section>

        <section id="section-stock" class="hidden">
            <div class="glass-card p-8 animate-in">
                <div class="section-header">
                    <div class="section-icon">üìä</div>
                    <div>
                        <h2 class="text-2xl font-black">INVENTARIO ACTUAL</h2>
                        <p class="text-sm text-slate-500 font-medium">Control de existencias en almac√©n</p>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex gap-2">
                        <input type="text" id="search-stock" placeholder="üîç Buscar en inventario..." class="search-box flex-1" onkeyup="renderStock()">
                        <button onclick="document.getElementById('search-stock').value='';renderStock()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-300 btn-action">
                            ‚ùå LIMPIAR
                        </button>
                        <button id="btn-aperturar-ajuste" onclick="aperturarAjusteInventario()" class="bg-gradient-to-r from-orange-600 to-red-600 text-white px-6 py-2 rounded-xl text-xs font-bold hover:shadow-lg btn-action">
                            üìù APERTURAR AJUSTE
                        </button>
                        <button id="btn-guardar-ajuste" onclick="guardarAjusteInventario()" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-2 rounded-xl text-xs font-bold hover:shadow-lg btn-action hidden">
                            üíæ GUARDAR AJUSTE
                        </button>
                        <button id="btn-cancelar-ajuste" onclick="cancelarAjusteInventario()" class="bg-slate-600 text-white px-6 py-2 rounded-xl text-xs font-bold hover:bg-slate-700 btn-action hidden">
                            ‚ùå CANCELAR
                        </button>
                    </div>
                </div>

                <div id="mensaje-ajuste" class="hidden bg-orange-100 border-2 border-orange-500 text-orange-700 p-4 rounded-xl mb-4">
                    <p class="font-bold">‚ö†Ô∏è MODO AJUSTE DE INVENTARIO ACTIVADO</p>
                    <p class="text-sm">Puedes editar los stocks manualmente. Click en GUARDAR AJUSTE cuando termines.</p>
                </div>

                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-2xl mb-4">
                    <div class="bg-white rounded-xl overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-gradient-to-r from-blue-600 to-indigo-600" style="color: white !important;">
                                <tr>
                                    <th class="p-4 text-left font-bold" style="color: white;">C√ìDIGO</th>
                                    <th class="p-4 text-left font-bold" style="color: white;">MATERIAL</th>
                                    <th class="p-4 text-center font-bold" style="color: white;">UNIDAD</th>
                                    <th class="p-4 text-right font-bold" style="color: white;">PRECIO UNIT.</th>
                                    <th class="p-4 text-right font-bold" style="color: white;">STOCK</th>
                                    <th class="p-4 text-right font-bold" style="color: white;">VALOR TOTAL</th>
                                </tr>
                            </thead>
                            <tbody id="stock-list-container" class="divide-y"></tbody>
                            <tfoot class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white">
                                <tr>
                                    <td colspan="5" class="p-4 text-right font-black text-lg">INVENTARIO VALORIZADO TOTAL:</td>
                                    <td id="total-valorizado" class="p-4 text-right font-black text-xl">S/. 0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="section-planning" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-3 glass-card p-8 animate-in">
                    <div class="section-header">
                        <div class="section-icon">üìÖ</div>
                        <div>
                            <h2 class="text-2xl font-black">PLANIFICACI√ìN SEMANAL</h2>
                            <p class="text-sm text-slate-500 font-medium">Planifica 2 semanas de producci√≥n con anticipaci√≥n</p>
                        </div>
                    </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- SEMANA 1 -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-2xl border-2 border-blue-200">
                        <div class="mb-4">
                            <h3 class="font-black text-lg mb-2 text-blue-700">üìÖ SEMANA 1</h3>
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 border-blue-300">
                                <label class="font-bold text-sm text-blue-700">üìÜ Lunes de inicio:</label>
                                <input type="date" id="fecha-inicio-s1" class="flex-1 p-2 border-2 border-blue-200 rounded-lg font-semibold" onchange="guardarFechasSemanas()">
                            </div>
                            <p id="info-semana1" class="text-xs text-blue-600 mt-2 font-semibold"></p>
                        </div>
                        <div id="semana1-dias" class="space-y-3"></div>
                    </div>

                    <!-- SEMANA 2 -->
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-2xl border-2 border-purple-200">
                        <div class="mb-4">
                            <h3 class="font-black text-lg mb-2 text-purple-700">üìÖ SEMANA 2</h3>
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 border-purple-300">
                                <label class="font-bold text-sm text-purple-700">üìÜ Lunes de inicio:</label>
                                <input type="date" id="fecha-inicio-s2" class="flex-1 p-2 border-2 border-purple-200 rounded-lg font-semibold" onchange="guardarFechasSemanas()">
                            </div>
                            <p id="info-semana2" class="text-xs text-purple-600 mt-2 font-semibold"></p>
                        </div>
                        <div id="semana2-dias" class="space-y-3"></div>
                    </div>
                </div>

                <!-- BOT√ìN IMPRIMIR CALENDARIO -->
                <div class="mb-4">
                    <button onclick="exportarCalendarioSemanalPDF()" class="w-full bg-gradient-to-r from-pink-600 to-rose-600 text-white py-4 btn-action font-black text-sm rounded-xl shadow-xl hover:shadow-2xl transition-all">
                        üìã IMPRIMIR CALENDARIO MEN√ö DEL D√çA
                    </button>
                    <p class="text-xs text-center text-slate-500 mt-2">
                        üí° Genera PDF con los platos de MEN√ö programados para cada d√≠a
                    </p>
                </div>

                <div class="mb-4">
                    <button onclick="calcularExplosionSemanal()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 btn-action font-black text-sm rounded-xl">
                        ‚ö° CALCULAR EXPLOSI√ìN DE 14 D√çAS
                    </button>
                </div>
                
                <div class="flex gap-4 mb-6">
                    <div class="flex-1 bg-white rounded-xl p-3 border-2 border-purple-200">
                        <label class="text-xs font-bold text-purple-700 block mb-2">üë®‚Äçüç≥ PARA EL CHEF</label>
                        <select id="tipo-export-pdf-semanal" class="w-full p-2 border-2 border-slate-300 rounded-lg mb-2 font-semibold text-xs">
                            <option value="preliminar">üìã Vista Preliminar (Con Componentes Directos)</option>
                            <option value="orden">üõí Orden de Compra (Disgregado por Familias)</option>
                        </select>
                        <button id="btn-pdf-chef-semanal" onclick="exportarPDFSemanalSegunTipo()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-xl font-bold btn-action opacity-50 pointer-events-none text-sm shadow-lg">
                            üìÑ EXPORTAR PDF
                        </button>
                        <p class="text-[9px] text-slate-500 mt-2 text-center">
                            üí° <strong>Vista Preliminar:</strong> Componentes directos<br>
                            üí° <strong>Orden de Compra:</strong> Disgregado sin AGUA FILTRADA
                        </p>
                    </div>
                    
                    <div class="flex-1 bg-white rounded-xl p-3 border-2 border-green-200">
                        <label class="text-xs font-bold text-green-700 block mb-2">üì¶ PARA EL PROVEEDOR</label>
                        <div class="mb-2 text-[10px] text-slate-600 text-center">
                            Orden consolidada disgregada por familias
                        </div>
                        <button id="btn-pdf-semanal" onclick="exportarOrdenCompraSemanalPDF()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 rounded-xl font-bold btn-action opacity-50 pointer-events-none text-sm shadow-lg">
                            üìÑ EXPORTAR ORDEN DE COMPRA
                        </button>
                        <p class="text-[9px] text-slate-500 mt-2 text-center">
                            Sin AGUA FILTRADA, limpia planificaci√≥n
                        </p>
                    </div>
                </div>

                <div id="resultado-semanal" class="glass-card p-6 min-h-[300px]"></div>
                </div>

                <div class="lg:col-span-1 glass-card p-6 animate-in">
                    <div class="section-icon mb-3">üìú</div>
                    <h3 class="font-black text-sm mb-4 text-slate-700">HISTORIAL SEMANAL</h3>
                    <div id="historial-semanal-list" class="space-y-2 max-h-[600px] overflow-y-auto"></div>
                </div>
            </div>
        </section>

        <section id="section-mrp" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 glass-card p-6 animate-in">
                    <div class="section-icon mb-3">‚ö°</div>
                    <h2 class="text-xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600">
                        ORDEN DE PRODUCCI√ìN
                    </h2>
                    
                    <div class="bg-gradient-to-br from-purple-50 to-blue-50 p-4 rounded-xl mb-3 border-2 border-purple-200">
                        <select id="mrp-select" class="input-corp mb-2"></select>
                        <input id="mrp-qty" type="number" placeholder="Cantidad (PAX)" class="input-corp mb-3 text-center text-xl font-black" step="1" min="1">
                        <button onclick="addPlatoToOrder()" class="w-full bg-gradient-to-r from-slate-700 to-slate-900 text-white py-2.5 btn-action font-bold text-sm">
                            ‚ûï A√ëADIR A LISTA
                        </button>
                    </div>

                    <div id="mrp-order-list" class="space-y-2 mb-3 max-h-48 overflow-y-auto"></div>

                    <button onclick="calculateExplosion()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 btn-action font-bold mb-2 text-sm">
                        ‚ö° CALCULAR EXPLOSI√ìN
                    </button>
                    <button id="btn-pdf-mrp" onclick="exportToPDF()" class="w-full bg-gradient-to-r from-red-600 to-pink-600 text-white py-3 btn-action font-bold opacity-50 pointer-events-none text-sm">
                        üìÑ DESCARGAR PDF Y LIMPIAR
                    </button>

                    <div class="mt-4 pt-4 border-t-2 border-slate-200">
                        <h3 class="font-black text-xs mb-2 text-slate-700">üìú HISTORIAL DE PRODUCCI√ìN</h3>
                        <div id="historial-list" class="space-y-2 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>

                <div id="mrp-result" class="lg:col-span-2 glass-card p-6 min-h-[400px] animate-in flex items-start justify-center text-slate-400">
                    <div class="text-center">
                        <div class="text-6xl mb-4">üìã</div>
                        <p class="font-bold">Agrega platos y calcula la explosi√≥n de materiales</p>
                    </div>
                </div>
            </div>
        </section>
<section id="section-familias" class="hidden">
    <div class="glass-card p-8 animate-in">
        <div class="section-header">
            <div class="section-icon">üè∑Ô∏è</div>
            <div>
                <h2 class="text-2xl font-black">GESTI√ìN DE FAMILIAS, CATEGOR√çAS, √ÅREAS Y AL√âRGENOS</h2>
                <p class="text-sm text-slate-500 font-medium">Administra familias de materiales, categor√≠as de platos, √°reas operativas y al√©rgenos</p>
            </div>
        </div>

        <!-- GRID DE CUATRO COLUMNAS -->
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
            <!-- COLUMNA 1: FAMILIAS -->
            <div>
                <h3 class="text-xl font-black mb-4 text-indigo-700">üè∑Ô∏è FAMILIAS</h3>
                
                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-2xl mb-6 border-2 border-indigo-200">
                    <div class="flex flex-col gap-3">
                        <input id="familia-input" type="text" placeholder="Nueva familia" class="input-corp" style="text-transform: uppercase;">
                        <button onclick="agregarFamilia()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-xl font-bold btn-action">
                            ‚ûï AGREGAR
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3" id="lista-familias"></div>
            </div>

            <!-- COLUMNA 2: CATEGOR√çAS -->
            <div>
                <h3 class="text-xl font-black mb-4 text-blue-700">üìÇ CATEGOR√çAS</h3>
                
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-6 rounded-2xl mb-6 border-2 border-blue-200">
                    <p class="text-xs font-bold text-blue-700 mb-3">üí° Margen para precio ideal</p>
                    <div class="flex flex-col gap-3">
                        <input id="categoria-input" type="text" placeholder="Categor√≠a" class="input-corp" style="text-transform: uppercase;">
                        <input id="categoria-margen" type="number" placeholder="Margen %" class="input-corp" min="1" max="100" step="0.1">
                        <button onclick="agregarCategoria()" class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-6 py-3 rounded-xl font-bold btn-action">
                            ‚ûï AGREGAR
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3" id="lista-categorias"></div>
            </div>
            
            <!-- COLUMNA 3: √ÅREAS -->
            <div>
                <h3 class="text-xl font-black mb-4 text-green-700">üè¢ √ÅREAS</h3>
                
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-2xl mb-6 border-2 border-green-200">
                    <p class="text-xs font-bold text-green-700 mb-3">üí° √Åreas operativas del hotel</p>
                    <div class="flex flex-col gap-3">
                        <input id="area-input" type="text" placeholder="Nueva √°rea" class="input-corp">
                        <button onclick="agregarArea()" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-xl font-bold btn-action">
                            ‚ûï AGREGAR
                        </button>
                    </div>
                    <p class="text-xs text-green-600 mt-2">Ej: Lobby Bar, Le Cafe, Banquetes</p>
                </div>

                <div class="grid grid-cols-1 gap-3" id="lista-areas"></div>
            </div>

            <!-- COLUMNA 4: AL√âRGENOS -->
            <div>
                <h3 class="text-xl font-black mb-4 text-red-700">‚ö†Ô∏è AL√âRGENOS</h3>
                
                <div class="bg-gradient-to-br from-red-50 to-orange-50 p-6 rounded-2xl mb-6 border-2 border-red-200">
                    <div class="flex flex-col gap-3">
                        <input id="alergeno-input" type="text" placeholder="Al√©rgeno" class="input-corp" style="text-transform: uppercase;">
                        <button onclick="agregarAlergeno()" class="bg-gradient-to-r from-red-600 to-orange-600 text-white px-6 py-3 rounded-xl font-bold btn-action">
                            ‚ûï AGREGAR
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3" id="lista-alergenos"></div>
            </div>
        </div>
    </div>
</section>
<section id="section-usuarios" class="hidden">
    <div class="glass-card p-8 animate-in">
        <div class="section-header">
            <div class="section-icon">üë•</div>
            <div>
                <h2 class="text-2xl font-black">USUARIOS DEL SISTEMA</h2>
                <p class="text-sm text-slate-500 font-medium">Gesti√≥n de usuarios y permisos de acceso</p>
            </div>
        </div>

        <div class="bg-gradient-to-br from-purple-50 to-blue-50 p-6 rounded-2xl mb-6 border-2 border-purple-200">
            <input id="user-id-hidden" type="hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input id="user-usuario" type="text" placeholder="Usuario (sin espacios)" class="input-corp">
                <input id="user-password" type="text" placeholder="PIN (4 d√≠gitos)" class="input-corp" maxlength="4" pattern="\d{4}" inputmode="numeric">
                <input id="user-nombre" type="text" placeholder="Nombre completo" class="input-corp">
                <select id="user-rol" class="input-corp" onchange="mostrarPermisosSegunRol()">
                    <option value="mozo">üë®‚Äçüç≥ Mozo</option>
                    <option value="chef">üë®‚Äçüç≥ Chef</option>
                    <option value="almacen">üì¶ Almac√©n</option>
                    <option value="admin">üë®‚Äçüíº Administrador</option>
                </select>
            </div>
            
            <!-- SECCI√ìN DE PERMISOS (oculta para mozos) -->
            <div id="permisos-section" class="hidden mt-6 p-4 bg-white rounded-xl border-2 border-purple-300">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-black text-purple-700">üîê PERMISOS DE ACCESO A M√ìDULOS</h3>
                    <div class="flex gap-2">
                        <button type="button" onclick="seleccionarTodosPermisos()" class="text-xs px-3 py-1 bg-green-100 text-green-700 rounded-lg font-bold hover:bg-green-200">
                            ‚úÖ Seleccionar Todos
                        </button>
                        <button type="button" onclick="deseleccionarTodosPermisos()" class="text-xs px-3 py-1 bg-red-100 text-red-700 rounded-lg font-bold hover:bg-red-200">
                            ‚ùå Deseleccionar Todos
                        </button>
                    </div>
                </div>
                <p class="text-xs text-slate-600 mb-4">Selecciona los m√≥dulos a los que este usuario tendr√° acceso</p>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    <!-- ========== M√ìDULOS PRINCIPALES ========== -->
                    
                    <!-- DASHBOARD -->
                    <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
                        <input type="checkbox" class="permiso-check w-4 h-4" data-modulo="dashboard" checked>
                        <span class="text-xs font-bold">üìä DASHBOARD</span>
                    </label>
                    
                    <!-- MATERIALES -->
                    <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
                        <input type="checkbox" class="permiso-check w-4 h-4" data-modulo="bom" checked>
                        <span class="text-xs font-bold">üì¶ MATERIALES</span>
                    </label>
                    
                    <!-- RECETAS BASE -->
                    <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
                        <input type="checkbox" class="permiso-check w-4 h-4" data-modulo="bases" checked>
                        <span class="text-xs font-bold">üß™ RECETAS BASE</span>
                    </label>
                    
                    <!-- CARTA & BEBIDAS -->
                    <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
                        <input type="checkbox" class="permiso-check w-4 h-4" data-modulo="menu" checked>
                        <span class="text-xs font-bold">üçΩÔ∏è CARTA & BEBIDAS</span>
                    </label>
                    
                    <!-- INVENTARIO -->
                    <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
                        <input type="checkbox" class="permiso-check w-4 h-4" data-modulo="stock" checked>
                        <span class="text-xs font-bold">üìä INVENTARIO</span>
                    </label>
                    
                    <!-- PLANIFICACI√ìN -->
                    <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
                        <input type="checkbox" class="permiso-check w-4 h-4" data-modulo="planning" checked>
                        <span class="text-xs font-bold">üìÖ PLANIFICACI√ìN</span>
                    </label>
                    
                    <!-- √ìRDENES PLATOS -->
                    <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
                        <input type="checkbox" class="permiso-check w-4 h-4" data-modulo="mrp" checked>
                        <span class="text-xs font-bold">‚ö° √ìRDENES PLATOS</span>
                    </label>
                    
                    <!-- EVENTOS -->
                    <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
                        <input type="checkbox" class="permiso-check w-4 h-4" data-modulo="eventos" checked>
                        <span class="text-xs font-bold">üéâ EVENTOS</span>
                    </label>
                    
                    <!-- COMPRAS -->
                    <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
                        <input type="checkbox" class="permiso-check w-4 h-4" data-modulo="compras" checked>
                        <span class="text-xs font-bold">üìÇ COMPRAS</span>
                    </label>
                    
                    <!-- FAMILIAS -->
                    <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
                        <input type="checkbox" class="permiso-check w-4 h-4" data-modulo="familias" checked>
                        <span class="text-xs font-bold">üè∑Ô∏è FAMILIAS</span>
                    </label>
                    
                    <!-- USUARIOS -->
                    <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
                        <input type="checkbox" class="permiso-check w-4 h-4" data-modulo="usuarios" checked>
                        <span class="text-xs font-bold">üë• USUARIOS</span>
                    </label>
                </div>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-xs text-blue-700 font-medium">
                        üí° <strong>Nota:</strong> El administrador siempre tiene acceso total a todos los m√≥dulos. Los permisos personalizados aplican para Chef, Almac√©n y otros roles.
                    </p>
                </div>
            </div>
            
            <button onclick="guardarUsuario()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-4 btn-action font-bold text-sm mt-4">
                ‚úÖ GUARDAR USUARIO
            </button>
        </div>

        <div class="bg-white rounded-xl overflow-hidden border-2 border-slate-200">
            <table class="w-full text-sm">
                <thead style="background: linear-gradient(to right, #9333ea, #3b82f6); color: white !important;">
                    <tr>
                        <th class="p-4 text-left font-bold" style="color: white;">USUARIO</th>
                        <th class="p-4 text-left font-bold" style="color: white;">NOMBRE COMPLETO</th>
                        <th class="p-4 text-center font-bold" style="color: white;">ROL</th>
                        <th class="p-4 text-right font-bold" style="color: white;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="usuarios-list" class="divide-y"></tbody>
            </table>
        </div>
        
        <!-- ZONA DE PELIGRO: RESETEAR USUARIOS -->
        <div class="mt-6 bg-gradient-to-br from-red-50 to-orange-50 p-6 rounded-2xl border-2 border-red-300">
            <div class="flex items-center gap-3 mb-3">
                <div class="text-3xl">‚ö†Ô∏è</div>
                <div>
                    <h3 class="text-lg font-black text-red-700">ZONA DE PELIGRO</h3>
                    <p class="text-xs text-red-600 font-medium">Esta acci√≥n eliminar√° todos los usuarios del sistema</p>
                </div>
            </div>
            <button onclick="resetearTodosLosUsuarios()" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white py-4 rounded-xl font-bold text-sm hover:from-red-700 hover:to-red-800 transition-all shadow-lg">
                üóëÔ∏è BORRAR TODOS LOS USUARIOS Y RESETEAR SISTEMA
            </button>
            <p class="text-xs text-red-600 mt-2 text-center font-medium">Despu√©s del reseteo, solo existir√° el usuario: Admin / PIN: 1991</p>
        </div>
    </div>
</section>










    </main>


<!-- MODAL CALCULAR PRODUCCI√ìN -->
<div id="modal-calcular-produccion" class="modal">
    <div class="glass-card p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600">
                üè≠ PLANIFICACI√ìN DE PRODUCCI√ìN
            </h3>
            <button onclick="cerrarModalProduccion()" class="text-slate-400 hover:text-slate-600 text-2xl">‚úï</button>
        </div>
        
        <input type="hidden" id="prod-sku-receta">
        
        <!-- INFORMACI√ìN DE LA RECETA -->
        <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-xl p-5 mb-6">
            <p class="text-xs font-bold text-purple-800 mb-2">RECETA BASE:</p>
            <p id="prod-nombre-receta" class="text-xl font-black text-slate-800 mb-1"></p>
            <p id="prod-rendimiento-base" class="text-sm text-slate-600 font-semibold"></p>
        </div>

        <!-- CANTIDAD A PRODUCIR -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-300 rounded-xl p-6 mb-6">
            <label class="text-sm font-bold text-slate-700 mb-3 block">
                üìä ¬øCU√ÅNTO DESEAS PRODUCIR?
            </label>
            
            <div class="bg-white border-2 border-blue-400 rounded-xl p-4 mb-3">
                <div class="flex items-center justify-center gap-4">
                    <input type="number" id="prod-cantidad" 
                           class="text-center text-4xl font-black text-blue-600 border-0 outline-none w-32" 
                           placeholder="40" step="0.01" min="0.01" oninput="calcularInsumos()">
                    <span id="prod-unidad" class="text-3xl font-black text-slate-800"></span>
                </div>
            </div>
            
            <div class="bg-blue-100 border border-blue-300 rounded-lg p-3">
                <p class="text-xs font-semibold text-blue-800 text-center">
                    üí° <strong>Ingresa la cantidad en la misma unidad de la receta.</strong><br>
                    Ejemplo: Si la receta rinde <strong>1 kg</strong> y escribes <strong>40</strong>, producir√°s <strong>40 kg</strong>
                </p>
            </div>
        </div>

        <!-- TABLA DE INSUMOS NECESARIOS -->
        <div class="bg-white border-2 border-slate-200 rounded-xl p-5 mb-6">
            <p class="text-lg font-black text-slate-800 mb-4">üì¶ INSUMOS NECESARIOS</p>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-3 text-left">INGREDIENTE</th>
                            <th class="p-3 text-center">CANTIDAD NECESARIA</th>
                            <th class="p-3 text-center">UNIDAD</th>
                            <th class="p-3 text-right">PRECIO UNIT.</th>
                            <th class="p-3 text-right">SUBTOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-insumos-produccion" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>

            <!-- RESUMEN -->
            <div class="mt-4 pt-4 border-t-2 border-slate-200">
                <div class="flex justify-between items-center mb-2">
                    <p class="font-bold text-slate-700">COSTO TOTAL DE INSUMOS:</p>
                    <p id="prod-costo-total" class="text-3xl font-black text-emerald-600">S/. 0.00</p>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <p class="text-slate-600">Costo por unidad:</p>
                    <p id="prod-costo-unitario" class="font-bold text-slate-700">S/. 0.00</p>
                </div>
            </div>
        </div>

        <!-- BOTONES -->
        <div class="flex gap-3">
            <button onclick="exportarProduccionPDF()" class="flex-1 bg-gradient-to-r from-red-600 to-pink-600 text-white py-4 rounded-xl font-bold btn-action">
                üìÑ EXPORTAR A PDF
            </button>
            <button onclick="cerrarModalProduccion()" class="px-8 bg-slate-200 text-slate-700 py-4 rounded-xl font-bold btn-action">
                ‚ùå CERRAR
            </button>
        </div>
    </div>
</div>
    <div id="pasteModal" class="modal">
        <div class="glass-card p-8 w-full max-w-2xl">
            <h3 class="font-black text-2xl mb-6 text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600">
                üìã IMPORTAR DESDE EXCEL
            </h3>
            <p class="text-sm text-slate-600 mb-2 font-medium">Pega los datos copiados desde Excel con el siguiente formato:</p>
            <p class="text-xs text-slate-700 font-mono mb-4 bg-slate-100 p-3 rounded-lg">
                NOMBRE &nbsp;&nbsp; FAMILIA &nbsp;&nbsp; ALERGENOS &nbsp;&nbsp; U.COMPRA &nbsp;&nbsp; U.COSTO &nbsp;&nbsp; FACTOR &nbsp;&nbsp; PRECIO
            </p>
            <p class="text-xs text-amber-600 mb-4 font-bold">üí° Los al√©rgenos deben ir separados por comas (ej: GLUTEN,LACTEOS,HUEVO)</p>
            <textarea id="pasteArea" class="w-full h-64 border-2 border-slate-300 p-4 text-sm mb-4 rounded-xl font-mono" placeholder="HARINA DE TRIGO	ABARROTES	GLUTEN	KG	G	1000	5.50"></textarea>
            <div class="flex gap-3">
                <button onclick="processPaste()" class="flex-1 bg-gradient-to-r from-slate-700 to-slate-900 text-white py-3 rounded-xl font-bold btn-action">
                    ‚úÖ IMPORTAR DATOS
                </button>
                <button onclick="closePasteModal()" class="px-8 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold btn-action">
                    ‚ùå CERRAR
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE PRODUCCI√ìN MASIVA DE RECETAS BASE -->
    <div id="modal-produccion-masiva" class="modal">
        <div class="glass-card p-8 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-indigo-600">
                    üè≠ PRODUCCI√ìN MASIVA DE RECETAS BASE
                </h3>
                <button onclick="cerrarModalProduccionMasiva()" class="text-slate-400 hover:text-slate-600 text-2xl">‚úï</button>
            </div>
            
            <!-- BUSCADOR PREDICTIVO -->
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-xl p-6 mb-6">
                <p class="text-sm font-bold text-purple-800 mb-4">üîç BUSCAR Y AGREGAR RECETAS BASE</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative col-span-2">
                        <input 
                            type="text" 
                            id="buscar-rb-masiva" 
                            placeholder="Buscar receta base..."
                            class="input-corp"
                            oninput="buscarRecetaBaseMasiva()"
                            onkeydown="if(event.key==='Enter') event.preventDefault()"
                            autocomplete="off"
                        >
                        <input type="hidden" id="rb-masiva-sku-seleccionado">
                        <div id="resultados-rb-masiva" class="hidden absolute z-50 w-full mt-1 bg-white border-2 border-purple-300 rounded-xl shadow-2xl max-h-60 overflow-y-auto"></div>
                    </div>
                    
                    <div>
                        <input 
                            type="number" 
                            id="cantidad-rb-masiva" 
                            placeholder="Cantidad"
                            class="input-corp"
                            step="0.01"
                            min="0.01"
                            onkeydown="if(event.key==='Enter') agregarRBMasiva()"
                        >
                    </div>
                </div>
                
                <button onclick="agregarRBMasiva()" class="w-full mt-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-bold btn-action">
                    ‚ûï AGREGAR A LA LISTA
                </button>
            </div>
            
            <!-- LISTA DE RECETAS SELECCIONADAS -->
            <div class="bg-white border-2 border-slate-200 rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-lg font-black text-slate-800">üìã RECETAS PARA PRODUCIR</p>
                    <button onclick="limpiarListaProduccionMasiva()" class="text-xs bg-red-100 text-red-700 px-4 py-2 rounded-lg font-bold hover:bg-red-200">
                        üóëÔ∏è LIMPIAR TODO
                    </button>
                </div>
                
                <div id="lista-produccion-masiva" class="space-y-3">
                    <p class="text-sm text-slate-400 italic text-center py-8">No hay recetas agregadas a√∫n</p>
                </div>
            </div>
            
            <!-- CONSOLIDADO -->
            <div id="consolidado-masiva" class="hidden bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl p-6 mb-6">
                <p class="text-lg font-black text-green-800 mb-4">üì¶ CONSOLIDADO DE INSUMOS PARA ALMAC√âN</p>
                <div id="tabla-consolidado-masiva"></div>
            </div>
            
            <!-- BOTONES DE ACCI√ìN -->
            <div class="flex gap-3">
                <button onclick="calcularConsolidadoMasiva()" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-4 rounded-xl font-bold btn-action">
                    üßÆ CALCULAR CONSOLIDADO
                </button>
                <button onclick="exportarProduccionMasivaPDF()" class="flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 rounded-xl font-bold btn-action">
                    üìÑ EXPORTAR PDF
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE VALIDACI√ìN DE CLAVE ADMIN -->
    <div id="modalClaveAdmin" class="modal" style="display: none;">
        <div class="glass-card p-8 w-full max-w-md">
            <h3 class="font-black text-2xl mb-4 text-center text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-orange-600">
                üîê ACCESO RESTRINGIDO
            </h3>
            <p class="text-sm text-slate-600 mb-6 text-center font-medium" id="mensaje-clave-admin">
                Esta funci√≥n requiere clave de administrador
            </p>
            
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-700 block mb-2">CLAVE DE ADMINISTRADOR</label>
                <input 
                    type="password" 
                    id="input-clave-admin" 
                    class="w-full border-2 border-slate-300 p-4 rounded-xl text-center text-2xl font-bold tracking-widest focus:border-red-500 focus:outline-none" 
                    placeholder="****"
                    maxlength="4"
                    autocomplete="off"
                    onkeypress="if(event.key==='Enter') validarClaveAdmin()"
                >
                <p class="text-xs text-slate-500 mt-2 text-center">Ingresa el PIN del administrador (4 d√≠gitos)</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="validarClaveAdmin()" class="flex-1 bg-gradient-to-r from-red-600 to-orange-600 text-white py-4 rounded-xl font-bold btn-action text-lg">
                    üîì VALIDAR
                </button>
                <button onclick="cerrarModalClaveAdmin()" class="px-8 bg-slate-200 text-slate-700 py-4 rounded-xl font-bold btn-action">
                    ‚ùå CANCELAR
                </button>
            </div>
            
            <div id="error-clave-admin" class="hidden mt-4 p-4 bg-red-50 border-2 border-red-200 rounded-xl text-center">
                <p class="text-sm font-bold text-red-700">‚ùå CLAVE INCORRECTA</p>
                <p class="text-xs text-red-600 mt-1">Intenta nuevamente</p>
            </div>
        </div>
    </div>

    <!-- MODAL DE PEGAR COMPONENTES DE PLATO DESDE EXCEL -->
    <div id="pasteModalPlato" class="modal">
        <div class="glass-card p-8 w-full max-w-2xl">
            <h3 class="font-black text-2xl mb-6 text-transparent bg-clip-text bg-gradient-to-r from-orange-600 to-amber-600">
                üìã IMPORTAR COMPONENTES DESDE EXCEL
            </h3>
            <p class="text-sm text-slate-600 mb-2 font-medium">Pega los componentes del plato copiados desde Excel:</p>
            <p class="text-xs text-slate-700 font-mono mb-4 bg-slate-100 p-3 rounded-lg">
                NOMBRE_INGREDIENTE &nbsp;&nbsp; CANTIDAD
            </p>
            <p class="text-xs text-amber-600 mb-2 font-bold">üí° El ingrediente debe existir en Materiales o Recetas Base</p>
            <p class="text-xs text-slate-500 mb-4">Ejemplo: <span class="font-mono bg-slate-100 px-2 py-1 rounded">HARINA DE TRIGO	500</span></p>
            <textarea id="pasteAreaPlato" class="w-full h-64 border-2 border-slate-300 p-4 text-sm mb-4 rounded-xl font-mono" placeholder="HARINA DE TRIGO	500
LECHE EVAPORADA	200
RB SALSA BLANCA	300"></textarea>
            <div class="flex gap-3">
                <button onclick="processPastePlato()" class="flex-1 bg-gradient-to-r from-orange-600 to-amber-600 text-white py-3 rounded-xl font-bold btn-action">
                    ‚úÖ IMPORTAR COMPONENTES
                </button>
                <button onclick="closePasteModalPlato()" class="px-8 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold btn-action">
                    ‚ùå CERRAR
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE EDITAR CATEGOR√çA -->
    <div id="modalEditarCategoria" class="modal">
        <div class="glass-card p-8 w-full max-w-md">
            <h3 class="font-black text-2xl mb-6 text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-600">
                ‚úèÔ∏è EDITAR CATEGOR√çA
            </h3>
            
            <input type="hidden" id="edit-categoria-nombre-original">
            
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-700 block mb-2">NOMBRE DE LA CATEGOR√çA</label>
                <input 
                    type="text" 
                    id="edit-categoria-nombre" 
                    class="w-full border-2 border-blue-300 p-4 rounded-xl text-sm font-bold focus:border-blue-500 focus:outline-none" 
                    placeholder="ENSALADAS"
                    style="text-transform: uppercase;"
                >
            </div>
            
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-700 block mb-2">MARGEN FC% (1-100)</label>
                <input 
                    type="number" 
                    id="edit-categoria-margen" 
                    class="w-full border-2 border-emerald-300 p-4 rounded-xl text-sm font-bold focus:border-emerald-500 focus:outline-none" 
                    placeholder="29"
                    min="1"
                    max="100"
                    step="0.1"
                >
            </div>
            
            <div class="flex gap-3">
                <button onclick="guardarEdicionCategoria()" class="flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 rounded-xl font-bold btn-action">
                    üíæ GUARDAR CAMBIOS
                </button>
                <button onclick="cerrarModalEditarCategoria()" class="px-8 bg-slate-200 text-slate-700 py-4 rounded-xl font-bold btn-action">
                    ‚ùå CANCELAR
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE EDITAR FAMILIA -->
    <div id="modalEditarFamilia" class="modal">
        <div class="glass-card p-8 w-full max-w-md">
            <h3 class="font-black text-2xl mb-6 text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">
                ‚úèÔ∏è EDITAR FAMILIA
            </h3>
            
            <input type="hidden" id="edit-familia-nombre-original">
            
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-700 block mb-2">NOMBRE DE LA FAMILIA</label>
                <input 
                    type="text" 
                    id="edit-familia-nombre" 
                    class="w-full border-2 border-indigo-300 p-4 rounded-xl text-sm font-bold focus:border-indigo-500 focus:outline-none" 
                    placeholder="PROTE√çNAS"
                    style="text-transform: uppercase;"
                >
            </div>
            
            <div class="flex gap-3">
                <button onclick="guardarEdicionFamilia()" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-bold btn-action">
                    üíæ GUARDAR CAMBIOS
                </button>
                <button onclick="cerrarModalEditarFamilia()" class="px-8 bg-slate-200 text-slate-700 py-4 rounded-xl font-bold btn-action">
                    ‚ùå CANCELAR
                </button>
            </div>
        </div>
    </div>

    <script>
        let db = { 
    materiales: [], 
    recetasBase: [], 
    platos: [], 
    inventario: {},
    stockMinimo: {},
    historialProduccion: [], 
    historialSemanal: [], 
    planSemanal: {},
    fechasSemanas: { s1: null, s2: null }, // Fechas de inicio de cada semana
    proveedores: [],
    documentos: [],
    usuarios: [],
    ventas: [],
    eventos: [], // Array para eventos y banquetes
    compras: [], // Array para registros de compras desde Excel
    comprasStats: null, // Estad√≠sticas calculadas de compras
    comprasUltimaImportacion: null, // Fecha de √∫ltima importaci√≥n
    mesas: [],
    empleados: [],
    servicios: [],
    otrosEgresos: [],
    otrosIngresos: [],
    historialVentas: [],
    logs: [],
    familias: [
        "AVES", "ABARROTES", "VERDURAS", "FRUTAS", "HUEVOS",
        "CARNICOS", "BEBIDAS", "LICORES", "VINOS", "PANES", "REC COCINA"
    ],
    alergenos: [
        "GLUTEN", "L√ÅCTEOS", "HUEVO", "SOJA", "FRUTOS SECOS",
        "MAN√ç", "PESCADO", "MARISCOS", "SULFITOS", "S√âSAMO"
    ],
    areas: [
        "LOBBY BAR", "LE CAFE", "ROOM SERVICE", "LA LOCANDA", 
        "BANQUETES", "PISO EJECUTIVO", "LA FONDUE"
    ],
    descuentos: [],
    tributarios: [],
    cargasLaborales: [],
    produccionDiaria: {},
    historialProduccionDiaria: [],
    produccionesRB: [], // Historial de producciones de recetas base
    ordenesPendientes: [] // √ìrdenes de producci√≥n pendientes
};

        // ========== INDEXEDDB - SISTEMA DE ALMACENAMIENTO MEJORADO ==========
        // Capacidad: 50MB - 2GB (vs 5-10MB de localStorage)
        // Velocidad: As√≠ncrono, no bloquea la interfaz
        // Migraci√≥n autom√°tica desde localStorage
        
        const DB_NAME = 'GastroControlProDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'appData';

        // Abrir/crear base de datos IndexedDB
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('‚ùå Error abriendo IndexedDB:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                        console.log('üì¶ IndexedDB inicializada correctamente');
                    }
                };
            });
        }

        // Guardar datos en IndexedDB
        async function saveToIndexedDB(key, data) {
            try {
                const database = await openIndexedDB();
                const transaction = database.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                store.put(data, key);
                
                return new Promise((resolve, reject) => {
                    transaction.oncomplete = () => {
                        database.close();
                        resolve();
                    };
                    transaction.onerror = () => {
                        database.close();
                        console.error('‚ùå Error en transacci√≥n:', transaction.error);
                        reject(transaction.error);
                    };
                });
            } catch (error) {
                console.error('‚ùå Error guardando en IndexedDB:', error);
                throw error;
            }
        }

        // Cargar datos desde IndexedDB
        async function loadFromIndexedDB(key) {
            try {
                const database = await openIndexedDB();
                const transaction = database.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(key);
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        database.close();
                        resolve(request.result);
                    };
                    request.onerror = () => {
                        database.close();
                        console.error('‚ùå Error cargando desde IndexedDB:', request.error);
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('‚ùå Error al acceder a IndexedDB:', error);
                return null;
            }
        }

        // Migrar datos de localStorage a IndexedDB (autom√°tico, solo primera vez)
        async function migrateFromLocalStorage() {
            try {
                // Verificar si ya existe en IndexedDB
                const existsInIndexedDB = await loadFromIndexedDB('gastro_control_pro');
                if (existsInIndexedDB) {
                    console.log('‚úÖ Datos ya est√°n en IndexedDB');
                    return false;
                }
                
                // Buscar en localStorage
                const savedInLocalStorage = localStorage.getItem('gastro_control_pro');
                if (savedInLocalStorage) {
                    console.log('üì¶ Migrando datos de localStorage a IndexedDB...');
                    const data = JSON.parse(savedInLocalStorage);
                    await saveToIndexedDB('gastro_control_pro', data);
                    console.log('‚úÖ Migraci√≥n completada exitosamente');
                    console.log('üíæ Capacidad mejorada: 5MB ‚Üí 50MB-2GB');
                    
                    // NO borrar localStorage todav√≠a (por seguridad, solo informar)
                    console.log('‚ÑπÔ∏è localStorage mantiene copia de respaldo');
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('‚ùå Error en migraci√≥n:', error);
                return false;
            }
        }

        // Verificar tama√±o de datos guardados
        async function checkDataSize() {
            const data = await loadFromIndexedDB('gastro_control_pro');
            if (data) {
                const sizeInBytes = new Blob([JSON.stringify(data)]).size;
                const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);
                console.log(`üìä Tama√±o actual: ${sizeInMB} MB`);
                
                if (sizeInMB > 40) {
                    console.warn('‚ö†Ô∏è Uso de almacenamiento alto. Considera hacer limpieza.');
                }
            }
        }

        let tempBase = [], tempPlato = [], mrpOrder = [];
        let lastExplosion = null;
        let lastExplosionSemanal = null;

        // Emojis para categor√≠as de platos
        var emojisCategoria = {
            'TODAS': 'üìã',
            'FONDOS': 'üçñ',
            'PLATOS FUERTES': 'üçñ',
            'ENTRADAS': 'ü•ó',
            'ENSALADAS': 'ü•ó',
            'BEBIDAS FR√çAS': 'ü•§',
            'BEBIDAS CALIENTES': '‚òï',
            'BEBIDAS': 'ü•§',
            'POSTRES': 'üç∞',
            'PIQUEOS': 'üç¢',
            'CEVICHES': 'üêü',
            'SOPAS': 'üç≤',
            'GUARNICIONES': 'üçö',
            'ESPECIALES': '‚≠ê',
            'MEN√ö': 'üç±',
            'LICORES': 'üç∑',
            'VINOS': 'üç∑'
        };

        // Emojis para √°reas
        var emojisAreas = {
            'LOBBY BAR': 'üç∏',
            'LE CAFE': '‚òï',
            'ROOM SERVICE': 'üõéÔ∏è',
            'LA LOCANDA': 'üçù',
            'BANQUETES': 'üéâ',
            'PISO EJECUTIVO': 'üëî',
            'LA FONDUE': 'ü´ï'
        };

       
function updateFamiliasDropdown() {
    var select = document.getElementById('m-familia');
    if (!select) return;
    
    var valorActual = select.value;
    var html = '<option value="">-- Seleccionar Familia --</option>';
    
    if (db.familias && db.familias.length > 0) {
        var familias = db.familias.slice().sort();
        for (var i = 0; i < familias.length; i++) {
            html += '<option value="' + familias[i] + '">' + familias[i] + '</option>';
        }
    }
    
    select.innerHTML = html;
    
    if (valorActual) select.value = valorActual;
}

function updateCategoriasDropdown() {
    const select = document.getElementById('p-categoria');
    if(!select) return;
    
    if(!db.categorias) db.categorias = [];
    
    const categoriaActual = select.value;
    
    select.innerHTML = '<option value="">-- Selecciona categor√≠a --</option>' + 
        db.categorias.map(cat => {
            // Compatibilidad: Si es string, convertir a objeto
            const catObj = typeof cat === 'string' ? { nombre: cat, margen: 29 } : cat;
            const emoji = emojisCategoria[catObj.nombre] || 'üçΩÔ∏è';
            return `<option value="${catObj.nombre}">${emoji} ${catObj.nombre} (FC ${catObj.margen}%)</option>`;
        }).join('');
    
    // Restaurar selecci√≥n si exist√≠a
    const categoriasNombres = db.categorias.map(c => typeof c === 'string' ? c : c.nombre);
    if(categoriaActual && categoriasNombres.includes(categoriaActual)) {
        select.value = categoriaActual;
    }
}

function calcularEstadoStock(sku) {
    const stockActual = db.inventario[sku] || 0;
    const stockMinimo = db.stockMinimo[sku];
    
    // Sin configuraci√≥n
    if(stockMinimo === undefined || stockMinimo === null) {
        return 'sinconfig';
    }
    
    // Cr√≠tico (stock cero o negativo)
    if(stockActual <= 0) {
        return 'critico';
    }
    
    // Bajo (por debajo del m√≠nimo)
    if(stockActual < stockMinimo) {
        return 'bajo';
    }
    
    // Normal
    return 'normal';
}

function calcularContadoresAlertas() {
    let critico = 0, bajo = 0, normal = 0, sinconfig = 0;
    
    db.materiales.forEach(m => {
        const estado = calcularEstadoStock(m.sku);
        if(estado === 'critico') critico++;
        else if(estado === 'bajo') bajo++;
        else if(estado === 'normal') normal++;
        else if(estado === 'sinconfig') sinconfig++;
    });
    
    // Actualizar contadores solo si los elementos existen
    const elemCritico = document.getElementById('alert-critico-count');
    const elemBajo = document.getElementById('alert-bajo-count');
    const elemNormal = document.getElementById('alert-normal-count');
    const elemSinconfig = document.getElementById('alert-sinconfig-count');
    
    if (elemCritico) elemCritico.textContent = critico;
    if (elemBajo) elemBajo.textContent = bajo;
    if (elemNormal) elemNormal.textContent = normal;
    if (elemSinconfig) elemSinconfig.textContent = sinconfig;
    
    // Actualizar badge en el navegador
    actualizarBadgeAlertas(critico + bajo);
}

function actualizarBadgeAlertas(count) {
    const navBtn = document.getElementById('nav-alertas');
    if(!navBtn) return;
    
    // Remover badge anterior si existe
    const badgeExistente = navBtn.querySelector('.alert-badge');
    if(badgeExistente) badgeExistente.remove();
    
    // Agregar nuevo badge si hay alertas
    if(count > 0) {
        const badge = document.createElement('span');
        badge.className = 'alert-badge';
        badge.style.cssText = `
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #ef4444, #ec4899);
            color: white;
            font-size: 10px;
            font-weight: 900;
            padding: 2px 6px;
            border-radius: 9999px;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
            animation: pulse 2s infinite;
        `;
        badge.textContent = count;
        navBtn.style.position = 'relative';
        navBtn.appendChild(badge);
    }
}

function verificarAlertasCriticas() {
    const criticos = db.materiales.filter(m => calcularEstadoStock(m.sku) === 'critico').length;
    const bajos = db.materiales.filter(m => calcularEstadoStock(m.sku) === 'bajo').length;
    
    if(criticos > 0 || bajos > 0) {
        // Mostrar notificaci√≥n flotante
        const notif = document.createElement('div');
        notif.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444, #ec4899);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.4);
            z-index: 10000;
            font-weight: 700;
            animation: slideIn 0.5s ease-out;
            cursor: pointer;
        `;
        notif.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">üîî</span>
                <div>
                    <p style="font-size: 14px; margin: 0;">¬°ALERTA DE INVENTARIO!</p>
                    <p style="font-size: 12px; margin: 0; opacity: 0.9;">
                        ${criticos} cr√≠ticos ‚Ä¢ ${bajos} bajos
                    </p>
                </div>
            </div>
        `;
        
        notif.onclick = () => {
            showSection('alertas');
            notif.remove();
        };
        
        document.body.appendChild(notif);
        
        setTimeout(() => {
            notif.style.animation = 'slideOut 0.5s ease-out';
            setTimeout(() => notif.remove(), 500);
        }, 8000);
    }
}

// ========== FUNCI√ìN TICKER DE NOTICIAS 3D ==========
function inicializarTicker() {
    const tickerContent = document.getElementById('ticker-content');
    if (!tickerContent) {
        console.log('‚ö†Ô∏è Ticker content no encontrado');
        return;
    }
    
    // Obtener nombre del usuario actual
    let nombreUsuario = 'Invitado';
    if (typeof usuarioActual !== 'undefined' && usuarioActual && usuarioActual.nombre) {
        nombreUsuario = usuarioActual.nombre;
    } else {
        const sesionGuardada = localStorage.getItem('gastro_sesion_activa');
        if (sesionGuardada) {
            try {
                const sesion = JSON.parse(sesionGuardada);
                nombreUsuario = sesion.nombre || 'Usuario';
            } catch(e) {
                console.log('Error al parsear sesi√≥n:', e);
            }
        }
    }
    
    // Obtener fecha y hora
    const ahora = new Date();
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const fechaFormateada = ahora.toLocaleDateString('es-PE', opciones);
    const horaFormateada = ahora.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
    
    // Obtener estad√≠sticas del sistema
    let cantMateriales = 0;
    let cantPlatos = 0;
    let cantRecetas = 0;
    
    if (typeof db !== 'undefined') {
        cantMateriales = db.materiales ? db.materiales.length : 0;
        cantPlatos = db.platos ? db.platos.length : 0;
        cantRecetas = db.recetasBase ? db.recetasBase.length : 0;
    }
    
    // Clima simulado - selecci√≥n aleatoria
    const climas = [
        { ciudad: 'Lima', temperatura: 24, descripcion: 'Nublado', icon: '‚òÅÔ∏è' },
        { ciudad: 'Lima', temperatura: 26, descripcion: 'Soleado', icon: '‚òÄÔ∏è' },
        { ciudad: 'Lima', temperatura: 22, descripcion: 'Parcialmente nublado', icon: '‚õÖ' },
        { ciudad: 'Lima', temperatura: 20, descripcion: 'Fresco', icon: 'üå§Ô∏è' }
    ];
    const clima = climas[Math.floor(Math.random() * climas.length)];
    
    // Crear items del ticker
    const items = [
        {
            icon: 'üë§',
            text: `Bienvenido: ${nombreUsuario}`
        },
        {
            icon: 'üìÖ',
            text: `${fechaFormateada}`
        },
        {
            icon: 'üïí',
            text: `${horaFormateada}`
        },
        {
            icon: clima.icon,
            text: `${clima.ciudad}: ${clima.temperatura}¬∞C - ${clima.descripcion}`
        },
        {
            icon: 'üçΩÔ∏è',
            text: `GASTRO CONTROL PRO - Sistema de Gesti√≥n Gastron√≥mica`
        },
        {
            icon: 'üè®',
            text: `SWISSOTEL - Excelencia en cada plato`
        },
        {
            icon: 'üìä',
            text: `Materiales: ${cantMateriales} | Platos: ${cantPlatos} | Recetas: ${cantRecetas}`
        },
        {
            icon: '‚ö°',
            text: `Sistema en l√≠nea y funcionando correctamente`
        }
    ];
    
    // Generar HTML del ticker (duplicar para loop infinito)
    const tickerHTML = items.map(item => `
        <span class="ticker-item">
            <span class="ticker-icon">${item.icon}</span>
            <span>${item.text}</span>
        </span>
        <span class="ticker-item" style="opacity: 0.4; margin-right: 40px;">‚Ä¢</span>
    `).join('');
    
    // Duplicar contenido 5 veces para seamless loop continuo
    tickerContent.innerHTML = tickerHTML + tickerHTML + tickerHTML + tickerHTML + tickerHTML;
    
    console.log('‚úÖ Ticker inicializado:', items.length, 'items -', nombreUsuario);
}

// Funci√≥n para obtener clima (simulado)
async function obtenerClima() {
    // Simular datos de clima - puedes reemplazar con API real como OpenWeatherMap
    const climas = [
        { ciudad: 'Lima', temperatura: 24, descripcion: 'Nublado', icon: '‚òÅÔ∏è' },
        { ciudad: 'Lima', temperatura: 26, descripcion: 'Soleado', icon: '‚òÄÔ∏è' },
        { ciudad: 'Lima', temperatura: 22, descripcion: 'Parcialmente nublado', icon: '‚õÖ' },
        { ciudad: 'Lima', temperatura: 20, descripcion: 'Fresco', icon: 'üå§Ô∏è' }
    ];
    
    // Seleccionar clima aleatorio (en producci√≥n, usar API real)
    const climaAleatorio = climas[Math.floor(Math.random() * climas.length)];
    
    // Opcional: Integrar con API real
    /*
    try {
        const API_KEY = 'TU_API_KEY';
        const ciudad = 'Lima';
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${ciudad}&appid=${API_KEY}&units=metric&lang=es`);
        const data = await response.json();
        return {
            ciudad: data.name,
            temperatura: Math.round(data.main.temp),
            descripcion: data.weather[0].description,
            icon: getWeatherIcon(data.weather[0].main)
        };
    } catch (error) {
        console.log('Error al obtener clima:', error);
        return climaAleatorio;
    }
    */
    
    return climaAleatorio;
}

// Actualizar ticker cada minuto
setInterval(() => {
    inicializarTicker();
}, 60000);

window.onload = async () => {
    console.log('üöÄ Iniciando GASTRO CONTROL PRO...');
    
    // ========== MIGRACI√ìN Y CARGA DE DATOS ==========
    // 1. Intentar migrar datos de localStorage si existen
    const migracionExitosa = await migrateFromLocalStorage();
    if (migracionExitosa) {
        console.log('‚úÖ Sistema actualizado a IndexedDB (50MB-2GB)');
    }
    
    // 2. Cargar datos desde IndexedDB
    const saved = await loadFromIndexedDB('gastro_control_pro');
    if(saved) {
        db = saved;
        console.log('‚úÖ Datos cargados desde IndexedDB');
        
        // Verificar tama√±o de datos
        await checkDataSize();
    } else {
        // Si no hay datos en IndexedDB, intentar localStorage (primera vez)
        const savedLocal = localStorage.getItem('gastro_control_pro');
        if(savedLocal) {
            db = JSON.parse(savedLocal);
            console.log('‚ÑπÔ∏è Datos cargados desde localStorage (ser√° migrado)');
        } else {
            console.log('üÜï Sistema nuevo - Inicializando...');
        }
    }
    
    // üîí USUARIO MANAGER (CREADOR) - SIEMPRE PRESENTE, OCULTO PARA ADMIN
    if(!db.usuarios) db.usuarios = [];
    const managerExiste = db.usuarios.find(u => u.id === 'manager');
    if(!managerExiste) {
        db.usuarios.push({
            id: 'manager',
            usuario: 'manager',
            password: '128080', // PIN de 6 d√≠gitos
            nombre: 'Leider Tisnado Mego',
            rol: 'admin',
            oculto: true, // Marca especial para ocultar
            permisos: ['dashboard','bom','bases','menu','stock','planning','mrp','eventos','compras','familias','usuarios'] // Todos los permisos
        });
        console.log('üîí Usuario Manager (Creador) inicializado');
    }
    
    // üë§ USUARIO ADMIN POR DEFECTO
    const adminExiste = db.usuarios.find(u => u.id === 'admin');
    if(!adminExiste) {
        db.usuarios.push({
            id: 'admin',
            usuario: 'Admin',
            password: '1991',
            nombre: 'Administrador',
            rol: 'admin',
            permisos: ['dashboard','bom','bases','menu','stock','planning','mrp','eventos','compras','familias','usuarios']
        });
        console.log('üë§ Usuario Admin creado por defecto');
    }
    
    // Guardar usuarios inicializados
    if (!managerExiste || !adminExiste) {
        save();
        console.log('üíæ Usuarios guardados en localStorage');
    }
    
    // ‚úÖ Inicializar estructuras si no existen
    if(!db.familias) {
        db.familias = [
            "Comestibles",
            "Filtrantes",
            "Vinos",
            "Gaseosas",
            "Cervezas",
            "Licores",
            "Minibares",
            "IC Tub√©rculos",
            "IC Frutas y V.",
            "IC Carnes",
            "IC Aves",
            "IC Pescado y M",
            "IC L√°cteos y Q",
            "IC Embutidos"
        ];
    }
    
    // üîÑ MIGRACI√ìN FORZADA - Actualizar familias, categor√≠as y al√©rgenos
    // Esto se ejecuta UNA VEZ para actualizar los datos existentes
    if(!db.migracionV14_1) {
        console.log('üîÑ Ejecutando migraci√≥n V14.1 - Actualizando familias, categor√≠as y al√©rgenos...');
        
        // Actualizar familias (14 totales)
        db.familias = [
            "Comestibles",
            "Filtrantes",
            "Vinos",
            "Gaseosas",
            "Cervezas",
            "Licores",
            "Minibares",
            "IC Tub√©rculos",
            "IC Frutas y V.",
            "IC Carnes",
            "IC Aves",
            "IC Pescado y M",
            "IC L√°cteos y Q",
            "IC Embutidos"
        ];
        console.log('‚úÖ Familias actualizadas:', db.familias.length, 'familias');
        
        // Actualizar categor√≠as de platos (18 totales)
        db.categorias = [
            "ENTRADAS", "FONDOS", "PLATOS FUERTES", "MEN√ö",
            "BEBIDAS FR√çAS", "BEBIDAS CALIENTES", 
            "POSTRES", "ENSALADAS", "GUARNICIONES", 
            "PIQUEOS", "CEVICHES", "SOPAS", 
            "ESPECIALES", "LICORES", "VINOS",
            "DESAYUNOS", "AGUAS NACIONALES E INTERNACIONALES", "C√ìCTELES DE LA CASA"
        ];
        db.categorias.sort();
        console.log('‚úÖ Categor√≠as actualizadas:', db.categorias.length, 'categor√≠as');
        
        // Actualizar al√©rgenos (14 totales)
        db.alergenos = [
            "GLUTEN", "L√ÅCTEOS", "HUEVO", "SOJA", "FRUTOS SECOS",
            "MAN√ç", "PESCADO", "MARISCOS", "SULFITOS", "S√âSAMO",
            "APIO", "MOSTAZA", "ALTRAMUCES", "MOLUSCOS"
        ];
        db.alergenos.sort();
        console.log('‚úÖ Al√©rgenos actualizados:', db.alergenos.length, 'al√©rgenos');
        
        // Marcar migraci√≥n como completada
        db.migracionV14_1 = true;
        
        // Guardar cambios
        localStorage.setItem('gastro_control_pro', JSON.stringify(db));
        console.log('‚úÖ Migraci√≥n V14.1 completada y guardada');
        
        // Mostrar alerta al usuario
        setTimeout(() => {
            alert('‚úÖ Sistema actualizado\n\n' +
                  'üì¶ 14 Familias nuevas\n' +
                  'üçΩÔ∏è 18 Categor√≠as (3 nuevas)\n' +
                  '‚ö†Ô∏è 14 Al√©rgenos (4 nuevos)\n\n' +
                  'Los cambios ya est√°n disponibles.');
        }, 1000);
    }
    
    // üîÑ MIGRACI√ìN V14.2 - SISTEMA DE √ÅREAS DIN√ÅMICAS
    if(!db.migracionV14_2) {
        console.log('üîÑ Ejecutando migraci√≥n V14.2 - Implementando sistema de √°reas...');
        
        // Actualizar √°reas (7 √°reas operativas)
        db.areas = [
            "LOBBY BAR", 
            "LE CAFE", 
            "ROOM SERVICE", 
            "LA LOCANDA", 
            "BANQUETES", 
            "PISO EJECUTIVO", 
            "LA FONDUE"
        ];
        console.log('‚úÖ √Åreas actualizadas:', db.areas.length, '√°reas');
        
        // Marcar migraci√≥n como completada
        db.migracionV14_2 = true;
        
        // Guardar cambios
        localStorage.setItem('gastro_control_pro', JSON.stringify(db));
        console.log('‚úÖ Migraci√≥n V14.2 completada y guardada');
        
        // Actualizar dropdowns
        updateAreasDropdown();
        
        // Mostrar alerta al usuario
        setTimeout(() => {
            alert('‚úÖ Sistema de √Åreas Actualizado\n\n' +
                  'üè¢ 7 √Åreas Operativas:\n' +
                  '‚Ä¢ LOBBY BAR\n' +
                  '‚Ä¢ LE CAFE\n' +
                  '‚Ä¢ ROOM SERVICE (nuevo)\n' +
                  '‚Ä¢ LA LOCANDA\n' +
                  '‚Ä¢ BANQUETES\n' +
                  '‚Ä¢ PISO EJECUTIVO (nuevo)\n' +
                  '‚Ä¢ LA FONDUE\n\n' +
                  'üí° Ahora puedes crear, editar y eliminar √°reas en la secci√≥n de Configuraci√≥n.');
        }, 1500);
    }
    
    // ‚úÖ Inicializar categor√≠as de platos
    if(!db.categorias) {
        db.categorias = [
            "ENTRADAS", "FONDOS", "PLATOS FUERTES", "MEN√ö",
            "BEBIDAS FR√çAS", "BEBIDAS CALIENTES", 
            "POSTRES", "ENSALADAS", "GUARNICIONES", 
            "PIQUEOS", "CEVICHES", "SOPAS", 
            "ESPECIALES", "LICORES", "VINOS",
            "DESAYUNOS", "AGUAS NACIONALES E INTERNACIONALES", "C√ìCTELES DE LA CASA"
        ];
        db.categorias.sort(); // Ordenar alfab√©ticamente
    }
    
    // ‚úÖ Inicializar al√©rgenos (14 al√©rgenos obligatorios)
    if(!db.alergenos) {
        db.alergenos = [
            "GLUTEN", "L√ÅCTEOS", "HUEVO", "SOJA", "FRUTOS SECOS",
            "MAN√ç", "PESCADO", "MARISCOS", "SULFITOS", "S√âSAMO",
            "APIO", "MOSTAZA", "ALTRAMUCES", "MOLUSCOS"
        ];
        db.alergenos.sort(); // Ordenar alfab√©ticamente
    }
    
    if(!db.planSemanal) db.planSemanal = {};
    if(!db.fechasSemanas) db.fechasSemanas = { s1: null, s2: null }; // Inicializar fechas de semanas
    if(!db.historialProduccion) db.historialProduccion = [];
    if(!db.historialSemanal) db.historialSemanal = [];
    if(!db.inventario) db.inventario = {};
    if(!db.stockMinimo) db.stockMinimo = {};
    if(!db.costVariance) db.costVariance = [];
    
    // ‚úÖ Inicializar estructuras financieras
    if(!db.empleados) db.empleados = [];
    if(!db.servicios) db.servicios = [];
    if(!db.otrosEgresos) db.otrosEgresos = [];
    if(!db.otrosIngresos) db.otrosIngresos = [];
    if(!db.historialVentas) db.historialVentas = [];
    if(!db.documentos) db.documentos = [];
    if(!db.historialPrecios) db.historialPrecios = [];
    
    // ‚úÖ Inicializar sistema de producci√≥n diaria
    if(!db.produccionDiaria) db.produccionDiaria = {};
    if(!db.historialProduccionDiaria) db.historialProduccionDiaria = [];
    if(!db.produccionesRB) db.produccionesRB = [];
    if(!db.ordenesPendientes) db.ordenesPendientes = [];
    
    // ‚úÖ Compatibilidad: Agregar tipo a platos existentes si no lo tienen
    if(db.platos && db.platos.length > 0) {
        db.platos.forEach(function(plato) {
            if(!plato.tipo) {
                plato.tipo = 'PREPARADO'; // Por defecto, todos son preparados
            }
            if(!plato.skuInventario) {
                plato.skuInventario = null; // Para productos directos
            }
        });
    }
    
    renderAll();
    renderPlanSemanal();
    updateFamiliasDropdown();
    updateCategoriasDropdown(); // Actualizar dropdown de categor√≠as
    renderAlergenosCheckboxes(); // Renderizar checkboxes de al√©rgenos
    updateAlergenosFilter(); // Actualizar filtro de al√©rgenos
    
    calcularContadoresAlertas();
    verificarAlertasCriticas();
    if (typeof actualizarIndicadoresMesas === 'function') {
        actualizarIndicadoresMesas();
    }
    
    // Restaurar sesi√≥n si existe
    const sesionRestaurada = restaurarSesion();
    if (sesionRestaurada) {
        console.log('üîÑ Restaurando sesi√≥n autom√°ticamente...');
        usuarioActual = sesionRestaurada;
        document.getElementById('pantalla-login').classList.add('hidden');
        
        // Todos van al m√≥dulo administrativo (POS eliminado)
        const header = document.querySelector('header');
        const nav = document.querySelector('nav');
        const main = document.querySelector('main');
        if(header) header.classList.remove('hidden');
        if(nav) nav.classList.remove('hidden');
        if(main) main.classList.remove('hidden');
        
        const nombreUsuarioElement = document.getElementById('nombre-usuario-admin');
        if (nombreUsuarioElement) {
            nombreUsuarioElement.textContent = sesionRestaurada.nombre;
        } else {
            console.warn('‚ö†Ô∏è Elemento nombre-usuario-admin no encontrado');
        }
        
        // Aplicar permisos
        setTimeout(function() {
            aplicarPermisosPorRol(sesionRestaurada.rol);
            
            // Iniciar verificador permanente
            if (window.intervaloPermisos) {
                clearInterval(window.intervaloPermisos);
            }
            window.intervaloPermisos = setInterval(function() {
                aplicarPermisosPorRol(sesionRestaurada.rol, true); // modo silencioso
            }, 500);
            console.log('üîí Verificador permanente activado en restauraci√≥n');
            
            // Inicializar ticker para sesi√≥n restaurada
            setTimeout(() => {
                console.log('üé¨ Inicializando ticker (sesi√≥n restaurada)...');
                inicializarTicker();
                
                // üìª Activar radio si es manager
                if (sesionRestaurada.id === 'manager') {
                    mostrarRadioManager();
                }
            }, 300);
        }, 100);
        
        console.log('‚úÖ Sesi√≥n restaurada:', sesionRestaurada.nombre);
    }
    
    // ‚úÖ La barra de noticias ticker se inicializar√° autom√°ticamente despu√©s del login
    // No la iniciamos aqu√≠ para evitar que aparezca antes de tiempo
    
    // Inicializar √°reas
    if(!db.areas) {
        db.areas = ["LOBBY BAR", "LE CAFE", "ROOM SERVICE", "LA LOCANDA", 
                    "BANQUETES", "PISO EJECUTIVO", "LA FONDUE"];
    }
    updateAreasDropdown();
    
    // ========== AUTO-GUARDADO CADA 5 MINUTOS ==========
    setInterval(async () => {
        await save();
        console.log('üíæ Auto-guardado:', new Date().toLocaleTimeString());
    }, 5 * 60 * 1000); // 5 minutos
    
    // ========== MENSAJE DE BIENVENIDA (solo primera vez con IndexedDB) ==========
    if (!localStorage.getItem('indexeddb_welcome_shown')) {
        setTimeout(() => {
            console.log('‚ú® Sistema actualizado a IndexedDB');
            console.log('üìä Nueva capacidad: 50MB - 2GB');
            console.log('‚ö° Velocidad mejorada');
            localStorage.setItem('indexeddb_welcome_shown', 'true');
        }, 2000);
    }
    
    console.log('‚úÖ Sistema inicializado correctamente');
};

// ========== FUNCI√ìN DE FORMATEO DE DINERO ==========


        async function save() {
            try {
                // Crear copia de db SIN compras para evitar sobrecarga
                const dbParaGuardar = { ...db };
                
                // NO guardar compras (pueden ser miles de registros)
                // Solo mantenerlas en memoria durante la sesi√≥n
                delete dbParaGuardar.compras;
                
                // Guardar en IndexedDB (50MB-2GB de capacidad)
                await saveToIndexedDB('gastro_control_pro', dbParaGuardar);
                
                // Tambi√©n guardar en localStorage como respaldo (hasta que se llene)
                try {
                    localStorage.setItem('gastro_control_pro', JSON.stringify(dbParaGuardar));
                } catch (e) {
                    // Si localStorage est√° lleno, solo usamos IndexedDB
                    console.log('‚ÑπÔ∏è localStorage lleno, usando solo IndexedDB');
                }
                
                updateDropdowns();
            } catch (error) {
                console.error('‚ùå Error al guardar:', error);
                alert('‚ö†Ô∏è Error al guardar los datos. Intenta exportar un backup.');
            }
        }

        function updateTempQty(type, index, val) {
            const v = parseFloat(val) || 0;
            if(type === 'base') tempBase[index].cant = v;
            if(type === 'plato') tempPlato[index].cant = v;
        }

        function renderTBT() {
            document.getElementById('b-edit-table-body').innerHTML = tempBase.map((t,i)=>{
                const mat = db.materiales.find(m => m.sku === t.sku);
                let costo = 0;
                let alergenosHTML = '';
                
                if (mat) {
                    const precioUnitario = mat.precio / mat.factor;
                    costo = t.cant * precioUnitario;
                    
                    // Obtener al√©rgenos
                    if (mat.alergenos && mat.alergenos.length > 0) {
                        alergenosHTML = mat.alergenos.map(alergeno => 
                            `<span class="inline-block bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded-full font-bold mr-1">‚ö†Ô∏è ${alergeno}</span>`
                        ).join('');
                    }
                }
                
                return `
                <tr class="hover:bg-emerald-50">
                    <td class="p-3 font-semibold">${t.nombre}</td>
                    <td class="p-3">
                        <input type="number" value="${t.cant}" onchange="updateTempQty('base', ${i}, this.value);renderTBT()" 
                               class="w-full p-2 border-2 border-emerald-200 rounded-lg text-right font-bold" step="0.01">
                    </td>
                    <td class="p-3 text-slate-600 font-medium">${t.unidad}</td>
                    <td class="p-3 text-right font-bold text-emerald-600">S/. ${costo.toFixed(2)}</td>
                    <td class="p-3">${alergenosHTML || '<span class="text-slate-400 text-[10px]">Sin al√©rgenos</span>'}</td>
                    <td class="p-3 text-right">
                        <button onclick="tempBase.splice(${i},1);renderTBT()" 
                                class="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-bold hover:bg-red-200">
                            ‚ùå
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        function renderTPT() {
            let costoTotal = 0;
            let componentesConCosto = [];
            
            // Primera pasada: calcular costo total
            tempPlato.forEach((t) => {
                const mat = db.materiales.find(m => m.sku === t.sku);
                if (mat) {
                    const precioUnitario = mat.precio / mat.factor;
                    const costoComponente = t.cant * precioUnitario;
                    costoTotal += costoComponente;
                    componentesConCosto.push({
                        ...t,
                        precioUnitario,
                        costoComponente
                    });
                }
            });
            
            // Segunda pasada: renderizar con alertas basadas en porcentaje
            let componentesHTML = '';
            
            tempPlato.forEach((t, i) => {
                const mat = db.materiales.find(m => m.sku === t.sku);
                let precioUnitario = 0;
                let costoComponente = 0;
                let porcentajeCosto = 0;
                
                if (mat) {
                    precioUnitario = mat.precio / mat.factor;
                    costoComponente = t.cant * precioUnitario;
                    porcentajeCosto = costoTotal > 0 ? (costoComponente / costoTotal) * 100 : 0;
                }
                
                // Determinar color de alerta seg√∫n porcentaje del costo
                let alertClass = '';
                let alertIcon = '';
                let costoClass = 'text-blue-600';
                
                if (porcentajeCosto >= 50) {
                    alertClass = 'bg-red-50';
                    alertIcon = 'üî¥';
                    costoClass = 'text-red-600';
                } else if (porcentajeCosto >= 30) {
                    alertClass = 'bg-orange-50';
                    alertIcon = 'üü†';
                    costoClass = 'text-orange-600';
                } else if (porcentajeCosto >= 20) {
                    alertClass = 'bg-yellow-50';
                    alertIcon = 'üü°';
                    costoClass = 'text-yellow-700';
                }
                
                // Obtener al√©rgenos del material
                let alergenosHTML = '';
                if (mat && mat.alergenos && mat.alergenos.length > 0) {
                    alergenosHTML = mat.alergenos.map(alergeno => 
                        `<span class="inline-block bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded-full font-bold ml-1">‚ö†Ô∏è ${alergeno}</span>`
                    ).join('');
                } else if (mat && mat.nombre && mat.nombre.startsWith('RB ')) {
                    // Si es una receta base, obtener al√©rgenos de sus ingredientes
                    const recetaBase = db.recetasBase.find(rb => rb.nombre === mat.nombre);
                    const alergenosRB = new Set();
                    if (recetaBase && recetaBase.ingredientes) {
                        recetaBase.ingredientes.forEach(ing => {
                            const ingrediente = db.materiales.find(m => m.sku === ing.sku);
                            if (ingrediente && ingrediente.alergenos && ingrediente.alergenos.length > 0) {
                                ingrediente.alergenos.forEach(alergeno => alergenosRB.add(alergeno));
                            }
                        });
                    }
                    if (alergenosRB.size > 0) {
                        alergenosHTML = Array.from(alergenosRB).map(alergeno => 
                            `<span class="inline-block bg-red-100 text-red-700 text-[10px] px-2 py-0.5 rounded-full font-bold ml-1">‚ö†Ô∏è ${alergeno}</span>`
                        ).join('');
                    }
                }
                
                componentesHTML += `
                <tr class="hover:bg-orange-50 ${alertClass}">
                    <td class="p-3 font-semibold">
                        ${alertIcon ? `<span class="mr-1">${alertIcon}</span>` : ''}${t.nombre}
                        ${porcentajeCosto >= 20 ? `<span class="ml-2 text-[10px] bg-slate-700 text-white px-2 py-0.5 rounded font-bold">${porcentajeCosto.toFixed(1)}%</span>` : ''}
                        ${alergenosHTML}
                    </td>
                    <td class="p-3">
                        <input type="number" value="${t.cant}" onchange="updateTempQty('plato', ${i}, this.value);calculatePlatoMetrics()" 
                               class="w-full p-2 border-2 border-orange-200 rounded-lg text-right font-bold" step="0.01">
                    </td>
                    <td class="p-3 text-slate-600 font-medium text-center">${t.unidad}</td>
                    <td class="p-3 text-right font-semibold text-slate-700">S/. ${precioUnitario.toFixed(2)}</td>
                    <td class="p-3 text-right">
                        <span class="font-bold ${costoClass}">S/. ${costoComponente.toFixed(2)}</span>
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="tempPlato.splice(${i},1);renderTPT();calculatePlatoMetrics()" 
                                class="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-bold hover:bg-red-200">
                            ‚ùå
                        </button>
                    </td>
                </tr>
                `;
            });
            
            document.getElementById('p-edit-table-body').innerHTML = componentesHTML;
            
            // Renderizar fila de TOTAL
            if (tempPlato.length > 0) {
                // Identificar el componente m√°s costoso
                let maxCosto = 0;
                let componenteMasCostoso = '';
                
                tempPlato.forEach(t => {
                    const mat = db.materiales.find(m => m.sku === t.sku);
                    if (mat) {
                        const costo = t.cant * (mat.precio / mat.factor);
                        if (costo > maxCosto) {
                            maxCosto = costo;
                            componenteMasCostoso = t.nombre;
                        }
                    }
                });
                
                const porcentajeMasCostoso = costoTotal > 0 ? ((maxCosto / costoTotal) * 100) : 0;
                
                document.getElementById('p-edit-table-footer').innerHTML = `
                    <tr>
                        <td colspan="4" class="p-3 text-right">
                            <span class="font-black text-lg text-slate-700">COSTO TOTAL DE RECETA:</span>
                        </td>
                        <td class="p-3 text-right">
                            <span class="font-black text-xl text-green-600">S/. ${costoTotal.toFixed(2)}</span>
                        </td>
                        <td></td>
                    </tr>
                    ${maxCosto > 0 ? `
                    <tr>
                        <td colspan="6" class="p-3 bg-amber-50">
                            <div class="flex items-center justify-center gap-2 text-xs">
                                <span class="font-bold text-amber-700">üí° INGREDIENTE M√ÅS COSTOSO:</span>
                                <span class="font-black text-amber-800">${componenteMasCostoso}</span>
                                <span class="bg-amber-200 text-amber-900 px-2 py-1 rounded font-bold">S/. ${maxCosto.toFixed(2)} (${porcentajeMasCostoso.toFixed(1)}%)</span>
                            </div>
                        </td>
                    </tr>
                    ` : ''}
                    <tr>
                        <td colspan="6" class="p-2 bg-slate-50">
                            <div class="flex items-center justify-center gap-4 text-[10px] font-bold">
                                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-100 rounded-full inline-block"></span>üî¥ ‚â•50% Muy Alto</span>
                                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-100 rounded-full inline-block"></span>üü† ‚â•30% Alto</span>
                                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-yellow-100 rounded-full inline-block"></span>üü° ‚â•20% Moderado</span>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                document.getElementById('p-edit-table-footer').innerHTML = '';
            }
            
            calculatePlatoMetrics();
        }

        // Funci√≥n para obtener el margen de FC seg√∫n la categor√≠a del plato
        function obtenerMargenPorCategoria(categoria) {
            if (!categoria) return 0.29; // Default para platos sin categor√≠a
            
            if (!db.categorias) return 0.29;
            
            // Buscar la categor√≠a en la base de datos
            const categoriaObj = db.categorias.find(cat => {
                const catNombre = typeof cat === 'string' ? cat : cat.nombre;
                return catNombre === categoria;
            });
            
            if (categoriaObj) {
                // Si es objeto, obtener margen; si es string, usar default
                const margen = typeof categoriaObj === 'string' ? 29 : categoriaObj.margen;
                return margen / 100; // Convertir porcentaje a decimal
            }
            
            // Si no se encuentra la categor√≠a, usar default
            return 0.29;
        }

        // ===== FUNCIONES PARA TIPO DE COSTO =====
        function obtenerTipoCosto(categoria) {
            if (!categoria) return 'FOOD';
            
            const categoriaUpper = categoria.toUpperCase();
            
            // BEVERAGE COST - Bebidas no alcoh√≥licas
            if (categoriaUpper.includes('BEBIDA') || 
                categoriaUpper.includes('AGUA') ||
                categoriaUpper.includes('AGUAS')) {
                return 'BEVERAGE';
            }
            
            // LIQUOR COST - Bebidas alcoh√≥licas
            if (categoriaUpper.includes('LICOR') || 
                categoriaUpper.includes('VINO') ||
                categoriaUpper.includes('COCTEL') ||
                categoriaUpper.includes('CERVEZA')) {
                return 'LIQUOR';
            }
            
            // FOOD COST - Todo lo dem√°s (comida)
            return 'FOOD';
        }
        
        function obtenerEtiquetaCosto(categoria) {
            const tipo = obtenerTipoCosto(categoria);
            
            switch(tipo) {
                case 'BEVERAGE':
                    return 'BC%'; // Beverage Cost
                case 'LIQUOR':
                    return 'LC%'; // Liquor Cost
                case 'FOOD':
                default:
                    return 'FC%'; // Food Cost
            }
        }
        
        function obtenerNombreCompletoCosto(categoria) {
            const tipo = obtenerTipoCosto(categoria);
            
            switch(tipo) {
                case 'BEVERAGE':
                    return 'Beverage Cost';
                case 'LIQUOR':
                    return 'Liquor Cost';
                case 'FOOD':
                default:
                    return 'Food Cost';
            }
        }
        // ===== FIN FUNCIONES TIPO DE COSTO =====

        function calculatePlatoMetrics() {
            let costoReceta = 0;
            tempPlato.forEach(comp => {
                const mat = db.materiales.find(m => m.sku === comp.sku);
                if(mat) {
                    costoReceta += (comp.cant * (mat.precio / mat.factor));
                }
            });
            
            // Obtener categor√≠a seleccionada para calcular margen correcto
            const categoria = document.getElementById('p-categoria').value;
            const margenFC = obtenerMargenPorCategoria(categoria);
            
            // Actualizar etiquetas de costo seg√∫n categor√≠a
            const etiquetaCorta = obtenerEtiquetaCosto(categoria);
            const etiquetaCompleta = obtenerNombreCompletoCosto(categoria);
            document.getElementById('p-etiqueta-costo-corta').textContent = etiquetaCorta;
            document.getElementById('p-etiqueta-costo-completa').textContent = etiquetaCompleta;
            
            const precioMenu = parseFloat(document.getElementById('p-precio-menu').value) || 0;
            const precioSinIGV = precioMenu > 0 ? precioMenu / (1 + 0.18 + 0.10) : 0;
            const fcPorcentaje = (costoReceta > 0 && precioSinIGV > 0) ? (costoReceta / precioSinIGV) * 100 : 0;
            
            // Calcular precio ideal con margen seg√∫n categor√≠a
            const precioIdeal = costoReceta > 0 ? Math.round(((costoReceta + (costoReceta * 0.18) + (costoReceta * 0.10)) / margenFC) * 100) / 100 : 0;
            
            document.getElementById('p-costo-receta').textContent = `S/. ${costoReceta.toFixed(2)}`;
            document.getElementById('p-precio-sin-igv').textContent = `S/. ${precioSinIGV.toFixed(2)}`;
            document.getElementById('p-fc-porcentaje').textContent = `${fcPorcentaje.toFixed(2)}%`;
            
            // Mostrar precio ideal con indicador del margen usado
            const margenPorcentaje = (margenFC * 100).toFixed(1);
            document.getElementById('p-precio-ideal').textContent = `S/. ${precioIdeal.toFixed(2)}`;
            document.getElementById('p-precio-ideal').title = `Calculado con margen ${etiquetaCorta} ${margenPorcentaje}%`;
            
            // Actualizar indicador de margen
            const margenIndicador = document.getElementById('p-margen-usado');
            if (margenIndicador) {
                margenIndicador.textContent = `Margen ${etiquetaCorta}: ${margenPorcentaje}%`;
                margenIndicador.className = 'text-xs text-orange-100 mt-1 font-semibold';
            }
        }

        function exportToPDF() {
    if (!lastExplosion) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const ahora = new Date();

    // --- ENCABEZADO (Mantiene tu dise√±o) ---
    doc.setFillColor(30, 58, 138);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setFillColor(255, 255, 255);
    doc.circle(25, 15, 7, 'F');
    doc.setFillColor(30, 58, 138);
    doc.circle(25, 15, 5.5, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text("SWISSOTEL", 105, 10, { align: "center" });
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text("HOTELERA COSTA DEL PACIFICO S.A. - RUC: 20297885538", 105, 16, { align: "center" });
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text("ORDEN DE COMPRA DETALLADA POR FAMILIAS", 105, 24, { align: "center" });

    // --- INFO BOX ---
    const infoY = 48;
    doc.setFillColor(248, 250, 252);
    doc.roundedRect(10, infoY, 190, 20, 2, 2, 'F');
    doc.setTextColor(30, 41, 59);
    doc.setFontSize(8);
    doc.text("FECHA: " + ahora.toLocaleDateString('es-PE'), 15, infoY + 12);
    doc.text("PAX: " + lastExplosion.pax, 120, infoY + 12);

    // --- AGRUPACI√ìN Y C√ÅLCULO POR FAMILIA ---
   // --- LISTA DE ITEMS QUE NO SE COMPRAN (S√ìLO PARA COSTEO) ---
    // Aqu√≠ puedes ir agregando m√°s nombres entre comillas y separados por comas
    const excluidos = [
        "RB AGUA FILTRADA", 
        "GAS", 
        "LUZ", 
        "MANO DE OBRA", 
        "ALQUILER"
    ];

    // --- FILTRADO INTELIGENTE ---
    const itemsAComprar = lastExplosion.items.filter(i => {
        const nombreLimpio = i.nombre.trim().toUpperCase();
        // Solo incluimos si tiene faltante Y si NO est√° en la lista de excluidos
        return i.tieneFaltante && !excluidos.includes(nombreLimpio);
    });

    const grupos = {};
    
    itemsAComprar.forEach(item => {
        const m = db.materiales.find(mat => mat.sku === item.sku);
        const familia = (m && m.familia) ? m.familia : "VARIOS";
        if (!grupos[familia]) {
            grupos[familia] = { items: [], totalFamilia: 0 };
        }
        grupos[familia].items.push(item);
        grupos[familia].totalFamilia += parseFloat(item.sub);
    });

    let currentY = 75;

    // --- GENERAR TABLAS POR FAMILIA CON TOTALES ---
    for (const familia in grupos) {
        if (currentY > 230) { doc.addPage(); currentY = 20; }

        doc.setTextColor(30, 58, 138);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(`FAMILIA: ${familia}`, 10, currentY);

        doc.autoTable({
            startY: currentY + 2,
            head: [['DESCRIPCI√ìN', 'UM', 'CANT.', 'P.UNIT', 'SUBTOTAL']],
            body: grupos[familia].items.map(i => [
                i.nombre,
                i.unid,
                i.faltante,
                "S/. " + i.precio,
                "S/. " + i.sub
            ]),
            theme: 'grid',
            headStyles: { fillColor: [30, 58, 138], fontSize: 7, halign: 'center' },
            styles: { fontSize: 7, cellPadding: 2 },
            columnStyles: {
                0: { cellWidth: 90 },
                2: { halign: 'right' },
                3: { halign: 'right' },
                4: { halign: 'right' }
            },
            margin: { left: 10, right: 10 },
            didDrawPage: (data) => { currentY = data.cursor.y; }
        });

        // --- RECUADRO DE TOTAL POR FAMILIA ---
        currentY = doc.lastAutoTable.finalY + 6;
        doc.setFillColor(241, 245, 249); // Gris muy claro
        doc.rect(130, currentY - 5, 70, 7, 'F');
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        doc.text(`TOTAL ${familia}:`, 135, currentY);
        doc.text(`S/. ${grupos[familia].totalFamilia.toLocaleString('es-PE', {minimumFractionDigits: 2})}`, 195, currentY, { align: "right" });
        
        currentY += 12; // Espacio para la siguiente familia
    }

    // --- GRAN TOTAL FINAL (RESALTADO) ---
    if (currentY > 260) { doc.addPage(); currentY = 20; }
    currentY += 5;
    doc.setFillColor(16, 185, 129); // Verde √©xito
    doc.roundedRect(120, currentY, 80, 14, 2, 2, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.text("TOTAL COMPRA FINAL:", 125, currentY + 9);
    doc.text("S/. " + lastExplosion.totalSinStock, 195, currentY + 9, { align: "right" });

    // --- FOOTER ---
    doc.setTextColor(100, 116, 139);
    doc.setFontSize(7);
    doc.text("Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego", 105, 285, { align: "center" });

    doc.save(`ORDEN_COMPRA_FAMILIAS_${ahora.getTime()}.pdf`);

    // --- PROCESO DE DESCUENTO DE INVENTARIO ---
    lastExplosion.items.forEach(item => {
        const m = db.materiales.find(mat => mat.sku === item.sku);
        if(m) {
            const reqEnUnidadCosto = parseFloat(item.reqTotal) * m.factor;
            const stockActual = db.inventario[item.sku] || 0;
            db.inventario[item.sku] = Math.max(0, stockActual - reqEnUnidadCosto);
        }

    });
    // üîπ REGISTRO DE CONSUMO REAL (FC REAL)
if(!db.consumoReal) db.consumoReal = [];

lastExplosion.items.forEach(item => {
    db.consumoReal.push({
        fecha: new Date().toISOString(),
        sku: item.sku,
        nombre: item.nombre,
        cantidad: parseFloat(item.reqTotal),
        costo: parseFloat(item.sub)
    });
});

    save();
    lastExplosion = null;
    document.getElementById('mrp-result').innerHTML = `
        <div class="text-center p-10 bg-green-50 rounded-2xl border-2 border-green-200">
            <div class="text-6xl mb-4">üìÑ</div>
            <p class="font-bold text-xl text-green-700">Orden con Totales por Familia Generada</p>
            <p class="text-green-600 mt-2">Se ha actualizado el stock correctamente.</p>
        </div>`;
    document.getElementById('btn-pdf-mrp').classList.add('opacity-50', 'pointer-events-none');
}

        function showSection(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('section-' + id).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('nav-active');
                b.classList.add('bg-white');
            });
           const btn = document.getElementById('nav-' + id);
            btn.classList.add('nav-active');
            btn.classList.remove('bg-white');
            if(id === 'stock') renderStock();
            if(id === 'mrp') renderHistorial();
            if(id === 'planning') {
                renderPlanSemanal();
                renderHistorialSemanal();
            }
            if(id === 'familias') {
                renderFamilias();
                renderCategorias();
                renderAreas();
                renderAlergenos();
            }
            if(id === 'proveedores') renderProveedores();
            if(id === 'documentos') {
                actualizarSelectProveedores();
                inicDocumentos();
            }
            if(id === 'usuarios') renderUsuarios();
            if(id === 'finanzas') inicializarFinanzas();
            if(id === 'ventas') renderVentas();
            if(id === 'dashboard') actualizarDashboard();
            if(id === 'eventos') {
                mostrarTabEvento('crear');
                calcularResumenEvento();
            }
            if(id === 'compras') {
                // Si hay datos, mostrar an√°lisis autom√°ticamente
                if (db.compras && db.compras.length > 0) {
                    if (!db.comprasStats) {
                        calcularStatsCompras();
                    }
                    mostrarAnalisisCompras();
                }
            }
        }

              function addMaterial() {
    const skuId = document.getElementById('m-sku-hidden').value;
    const precioNuevo = parseFloat(document.getElementById('m-precio').value);
    
    // Obtener al√©rgenos seleccionados
    const alergenosSeleccionados = [];
    document.querySelectorAll('.alergeno-check:checked').forEach(checkbox => {
        alergenosSeleccionados.push(checkbox.value);
    });
    
    const data = {
        sku: skuId || "MAT-" + Math.random().toString(36).substr(2, 6).toUpperCase(),
        nombre: document.getElementById('m-nombre').value.toUpperCase(),
        familia: document.getElementById('m-familia').value.toUpperCase(),
        uCompra: document.getElementById('m-u-compra').value.toUpperCase(),
        uCosto: document.getElementById('m-u-costo').value.toUpperCase(),
        factor: parseFloat(document.getElementById('m-factor').value),
        precio: precioNuevo,
        alergenos: alergenosSeleccionados
    };
    
    if(!data.nombre || !data.familia || isNaN(data.factor) || isNaN(data.precio)) {
        alert("‚ö†Ô∏è Por favor completa todos los campos, incluyendo la Familia");
        return;
    }
    
    const idx = db.materiales.findIndex(m => m.sku === data.sku);
    
    if(idx > -1) {
        // Actualizar material existente
        db.materiales[idx] = data;
        console.log('Material actualizado:', data.sku);
    } else {
        // Crear nuevo material
        db.materiales.push(data);
        console.log('Material creado:', data.sku);
    }
    
    save();
    renderMaterials();

    // Limpieza de campos
    ['m-sku-hidden','m-nombre','m-familia','m-u-compra','m-u-costo','m-factor','m-precio'].forEach(i => {
        const el = document.getElementById(i);
        if(el) el.value = '';
    });
    
    // Desmarcar checkboxes de al√©rgenos
    document.querySelectorAll('.alergeno-check').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Mostrar mensaje de √©xito
    alert('‚úÖ Material guardado exitosamente');
    document.getElementById('m-nombre').focus();
}

// --- ESTA ES LA FUNCI√ìN QUE TE FALTABA PARA QUE EL BOT√ìN ELIMINAR FUNCIONE ---
function deleteMaterial(sku) {
    if(confirm("¬øEst√°s seguro de que deseas eliminar este material?")) {
        db.materiales = db.materiales.filter(m => m.sku !== sku);
        save();
        renderMaterials();
        if(typeof updateDropdowns === 'function') updateDropdowns();
    }
}

            function renderMaterials() {
    const q = document.getElementById('search-materials').value.toUpperCase();
    const filterAlergeno = document.getElementById('filter-alergenos')?.value || '';
    
    // B√∫squeda por palabras - encuentra materiales que contengan TODAS las palabras buscadas
    const palabrasBuscadas = q.split(' ').filter(p => p.length > 0);
    
    // Filtra por nombre, familia o al√©rgeno
    const filtered = db.materiales.filter(m => {
        let matchesSearch = true;
        if (palabrasBuscadas.length > 0) {
            // Verificar que el nombre o familia contengan TODAS las palabras buscadas
            matchesSearch = palabrasBuscadas.every(palabra => 
                m.nombre.includes(palabra) || (m.familia && m.familia.includes(palabra))
            );
        }
        const matchesAlergeno = !filterAlergeno || (m.alergenos && m.alergenos.includes(filterAlergeno));
        return matchesSearch && matchesAlergeno;
    });
    
    // Actualizar contador
    const contador = document.getElementById('contador-materiales');
    if (contador) {
        if (q || filterAlergeno) {
            contador.textContent = `üìä Mostrando ${filtered.length} de ${db.materiales.length} materiales`;
        } else {
            contador.textContent = `üìä Total: ${db.materiales.length} materiales registrados`;
        }
    }
    
    document.getElementById('table-materials').innerHTML = filtered.map(m => {
        // Obtener stock actual en unidad de costo (interno)
        const stockEnUnidadCosto = db.inventario[m.sku] || 0;
        // Convertir a unidad de compra (para mostrar)
        const stockEnUnidadCompra = stockEnUnidadCosto / m.factor;
        
        // Determinar color seg√∫n stock (usar unidad de compra)
        let colorStock = 'text-red-600';  // Rojo por defecto (sin stock)
        let iconoStock = 'üî¥';
        
        if (stockEnUnidadCompra >= 1) {
            colorStock = 'text-emerald-600';  // Verde (stock saludable)
            iconoStock = 'üü¢';
        } else if (stockEnUnidadCompra > 0) {
            colorStock = 'text-amber-600';  // Amarillo (stock bajo)
            iconoStock = 'üü°';
        }
        
        // Formatear al√©rgenos para mostrar
        let alergenosTexto = '';
        if (m.alergenos && m.alergenos.length > 0) {
            alergenosTexto = m.alergenos.join(', ');
        } else {
            alergenosTexto = '-';
        }
        
        return `
        <tr class="hover:bg-slate-50 transition-colors">
            <td class="p-4">
                <span class="font-mono text-xs bg-slate-100 px-2 py-1 rounded">${m.sku}</span>
            </td>
            <td class="p-4 font-semibold">${m.nombre}</td>
            <td class="p-4 text-slate-500 italic text-sm">${m.familia || '-'}</td>
            <td class="p-4 text-slate-600 text-xs">${alergenosTexto}</td>
            <td class="p-4 text-slate-600 font-medium">${m.uCompra}</td>
            <td class="p-4 text-slate-600 font-medium">${m.uCosto}</td>
            <td class="p-4 font-bold text-blue-600">${m.factor}</td>
            <td class="p-4">
                <span class="font-bold text-emerald-600">S/. ${m.precio.toFixed(2)}</span>
            </td>
            <td class="p-4">
                <span class="font-bold ${colorStock}">${stockEnUnidadCompra.toFixed(2)} ${m.uCompra} ${iconoStock}</span>
            </td>
            <td class="text-right p-4">
                <div class="flex gap-2 justify-end acciones-material">
                    <button onclick="editMaterial('${m.sku}')" 
                            class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-200 btn-action btn-editar-material">
                        ‚úèÔ∏è
                    </button>
                    <button onclick="deleteMaterial('${m.sku}')" 
                            class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-200 btn-action btn-eliminar-material">
                        üóëÔ∏è
                    </button>
                </div>
            </td>
        </tr>
    `;
    }).join('');
    
    // Aplicar restricciones de rol despu√©s de renderizar
    if (usuarioActual && usuarioActual.rol) {
        aplicarRestriccionesRol(usuarioActual.rol, true);
    }
}

        // ========== EXPORTAR MATERIALES A EXCEL ==========
        function exportarMaterialesExcel() {
            // üîê VALIDACI√ìN DE CLAVE ADMIN
            solicitarClaveAdmin(function() {
                exportarMaterialesExcelReal();
            }, 'üì§ EXPORTAR materiales a Excel requiere clave de administrador');
        }
        
        function exportarMaterialesExcelReal() {
            if (!db.materiales || db.materiales.length === 0) {
                alert('‚ö†Ô∏è No hay materiales para exportar');
                return;
            }
            
            // Colores por familia (RGB en formato hex)
            const coloresFamilia = {
                'AVES': 'FFE6CC',           // Naranja claro
                'ABARROTES': 'FFF2CC',      // Amarillo claro
                'VERDURAS': 'D9EAD3',       // Verde claro
                'FRUTAS': 'FCE5CD',         // Durazno
                'HUEVOS': 'FFF9C4',         // Amarillo muy claro
                'CARNICOS': 'F4CCCC',       // Rojo claro
                'BEBIDAS': 'CFE2F3',        // Azul claro
                'LICORES': 'D9D2E9',        // Morado claro
                'VINOS': 'E8DAEF',          // Lavanda
                'PANES': 'F9E79F',          // Amarillo trigo
                'REC COCINA': 'E8F5E9',     // Verde menta
                'LACTEOS': 'FFF8DC',        // Crema
                'PESCADOS': 'B3E5FC',       // Azul agua
                'MARISCOS': 'E1F5FE',       // Azul cielo
                'ESPECIAS': 'FFCCBC',       // Coral
                'ACEITES': 'FFF9C4'         // Amarillo oro
            };
            
            // Ordenar materiales por familia y luego por nombre
            const materialesOrdenados = [...db.materiales].sort((a, b) => {
                const familiaA = a.familia || 'ZZZ';
                const familiaB = b.familia || 'ZZZ';
                if (familiaA !== familiaB) {
                    return familiaA.localeCompare(familiaB);
                }
                return a.nombre.localeCompare(b.nombre);
            });
            
            // Crear datos para Excel
            const datos = [];
            
            // Encabezado
            datos.push(['C√ìDIGO', 'NOMBRE DEL MATERIAL', 'FAMILIA', 'PRECIO S/.', 'FACTOR', 'U. COSTO', 'U. COMPRA', 'STOCK']);
            
            // Agregar materiales
            materialesOrdenados.forEach(m => {
                const stockEnUnidadCosto = db.inventario[m.sku] || 0;
                const stockEnUnidadCompra = stockEnUnidadCosto / m.factor;
                
                datos.push([
                    m.sku,
                    m.nombre,
                    m.familia || 'SIN FAMILIA',
                    m.precio,
                    m.factor,
                    m.uCosto,
                    m.uCompra,
                    stockEnUnidadCompra
                ]);
            });
            
            // Crear workbook y worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(datos);
            
            // Configurar anchos de columna
            ws['!cols'] = [
                { wch: 12 },  // C√ìDIGO
                { wch: 35 },  // NOMBRE
                { wch: 18 },  // FAMILIA
                { wch: 12 },  // PRECIO
                { wch: 10 },  // FACTOR
                { wch: 12 },  // U. COSTO
                { wch: 12 },  // U. COMPRA
                { wch: 12 }   // STOCK
            ];
            
            // Aplicar estilos
            const range = XLSX.utils.decode_range(ws['!ref']);
            
            // Estilo del encabezado
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_col(C) + "1";
                if (!ws[address]) continue;
                
                ws[address].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
                    fill: { fgColor: { rgb: "1E3A8A" } }, // Azul oscuro
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "000000" } },
                        bottom: { style: "thin", color: { rgb: "000000" } },
                        left: { style: "thin", color: { rgb: "000000" } },
                        right: { style: "thin", color: { rgb: "000000" } }
                    }
                };
            }
            
            // Estilo de las filas de datos
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                const material = materialesOrdenados[R - 1];
                const familia = material.familia || 'SIN FAMILIA';
                const colorFamilia = coloresFamilia[familia] || 'FFFFFF';
                
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_col(C) + (R + 1);
                    if (!ws[address]) continue;
                    
                    ws[address].s = {
                        fill: { fgColor: { rgb: colorFamilia } },
                        alignment: { 
                            horizontal: C === 1 ? "left" : "center",  // Nombre a la izquierda
                            vertical: "center" 
                        },
                        border: {
                            top: { style: "thin", color: { rgb: "CCCCCC" } },
                            bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                            left: { style: "thin", color: { rgb: "CCCCCC" } },
                            right: { style: "thin", color: { rgb: "CCCCCC" } }
                        },
                        font: { 
                            sz: 11,
                            bold: C === 1  // Nombre en negrita
                        }
                    };
                    
                    // Formato especial para precio y stock
                    if (C === 3) {  // Precio
                        ws[address].z = '"S/. "#,##0.00';
                    } else if (C === 7) {  // Stock
                        ws[address].z = '#,##0.00';
                    }
                }
            }
            
            // Agregar worksheet al workbook
            XLSX.utils.book_append_sheet(wb, ws, "Cat√°logo Materiales");
            
            // Generar nombre de archivo con fecha
            const ahora = new Date();
            const fecha = `${ahora.getDate().toString().padStart(2, '0')}-${(ahora.getMonth() + 1).toString().padStart(2, '0')}-${ahora.getFullYear()}`;
            const nombreArchivo = `Catalogo_Materiales_${fecha}.xlsx`;
            
            // Descargar archivo
            XLSX.writeFile(wb, nombreArchivo);
            
            alert(`‚úÖ Cat√°logo exportado exitosamente\n\nüìä ${db.materiales.length} materiales\nüìÅ ${nombreArchivo}`);
        }

        function editMaterial(sku) {
            const m = db.materiales.find(x => x.sku === sku);
            document.getElementById('m-sku-hidden').value = m.sku;
            document.getElementById('m-nombre').value = m.nombre;
            document.getElementById('m-u-compra').value = m.uCompra;
            document.getElementById('m-u-costo').value = m.uCosto;
            document.getElementById('m-factor').value = m.factor;
            document.getElementById('m-precio').value = m.precio;
            document.getElementById('m-nombre').focus();
            document.getElementById('m-familia').value = m.familia || '';
            
            // Marcar los al√©rgenos que tiene el material
            document.querySelectorAll('.alergeno-check').forEach(checkbox => {
                checkbox.checked = m.alergenos && m.alergenos.includes(checkbox.value);
            });
            
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        // ========== GESTI√ìN DE MODOS RECETA BASE ==========
        function cambiarModoRecetaBase(modo) {
            const btnManual = document.getElementById('btn-modo-manual');
            const btnExcel = document.getElementById('btn-modo-excel');
            const modoManual = document.getElementById('modo-manual-rb');
            const modoExcel = document.getElementById('modo-excel-rb');
            
            if (modo === 'manual') {
                // Activar modo manual
                btnManual.className = 'flex-1 bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-3 rounded-xl font-bold btn-action';
                btnExcel.className = 'flex-1 bg-slate-200 text-slate-600 py-3 rounded-xl font-bold btn-action';
                modoManual.classList.remove('hidden');
                modoExcel.classList.add('hidden');
            } else {
                // Activar modo excel
                btnManual.className = 'flex-1 bg-slate-200 text-slate-600 py-3 rounded-xl font-bold btn-action';
                btnExcel.className = 'flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl font-bold btn-action';
                modoManual.classList.add('hidden');
                modoExcel.classList.remove('hidden');
            }
        }

        function procesarExcelPegado() {
            const textarea = document.getElementById('excel-paste-area');
            const texto = textarea.value.trim();
            
            if (!texto) {
                alert('‚ö†Ô∏è Pega datos desde Excel primero');
                return;
            }
            
            if (!document.getElementById('b-nombre').value) {
                alert("‚ö†Ô∏è Ingresa primero el nombre de la receta");
                return;
            }
            
            // Procesar l√≠neas
            const lineas = texto.split('\n').filter(l => l.trim());
            let procesados = 0;
            let errores = 0;
            
            lineas.forEach(linea => {
                // Dividir por tabulador o m√∫ltiples espacios
                const partes = linea.split(/\t+|\s{2,}/).map(p => p.trim()).filter(p => p);
                
                if (partes.length >= 2) {
                    const nombreIngrediente = partes[0];
                    const cantidad = parseFloat(partes[1]);
                    const unidad = partes[2] || '';
                    
                    if (isNaN(cantidad) || cantidad <= 0) {
                        console.log('‚ö†Ô∏è Cantidad inv√°lida en l√≠nea:', linea);
                        errores++;
                        return;
                    }
                    
                    // Buscar material que coincida con el nombre
                    const material = db.materiales.find(m => 
                        m.nombre.toUpperCase().includes(nombreIngrediente.toUpperCase()) ||
                        nombreIngrediente.toUpperCase().includes(m.nombre.toUpperCase())
                    );
                    
                    if (material) {
                        // Verificar si ya est√° agregado
                        if (!tempBase.some(x => x.sku === material.sku)) {
                            tempBase.push({
                                sku: material.sku,
                                nombre: material.nombre,
                                cant: cantidad,
                                unidad: material.uCosto
                            });
                            procesados++;
                        } else {
                            console.log('‚ö†Ô∏è Ingrediente duplicado:', nombreIngrediente);
                        }
                    } else {
                        console.log('‚ö†Ô∏è Material no encontrado:', nombreIngrediente);
                        errores++;
                    }
                }
            });
            
            if (procesados > 0) {
                renderTBT();
                alert(`‚úÖ Procesados: ${procesados} ingredientes\n${errores > 0 ? '‚ö†Ô∏è Errores: ' + errores + ' l√≠neas no procesadas' : ''}\n\nRevisa la tabla y guarda la receta.`);
                
                // Limpiar textarea
                textarea.value = '';
                
                // Volver a modo manual
                cambiarModoRecetaBase('manual');
            } else {
                alert('‚ùå No se pudo procesar ning√∫n ingrediente.\n\nVerifica que:\n1. Los nombres coincidan con materiales existentes\n2. Las cantidades sean v√°lidas\n3. El formato sea: Ingrediente [TAB] Cantidad [TAB] Unidad');
            }
        }

        function limpiarExcelPegado() {
            document.getElementById('excel-paste-area').value = '';
        }

        function addToBaseTemp() {
            if(!document.getElementById('b-nombre').value) {
                alert("‚ö†Ô∏è Ingresa primero el nombre de la receta");
                return;
            }
            
            const sku = document.getElementById('b-insumo').value;
            const cant = parseFloat(document.getElementById('b-cant').value);
            
            if(!sku || isNaN(cant) || cant <= 0) {
                alert("‚ö†Ô∏è Selecciona un ingrediente y cantidad v√°lida");
                return;
            }
            
            if(tempBase.some(x => x.sku === sku)) {
                alert("‚ö†Ô∏è Este ingrediente ya est√° agregado");
                return;
            }
            
            const m = db.materiales.find(x => x.sku === sku);
            tempBase.push({ sku, nombre: m.nombre, cant, unidad: m.uCosto });
            
            document.getElementById('b-insumo').value = '';
            document.getElementById('b-insumo-buscar').value = '';
            document.getElementById('b-cant').value = '';
            document.getElementById('b-insumo-buscar').focus();
            renderTBT();
        }

        function saveFinalBase() {
    // 1. Limpiamos el nombre de cualquier par√©ntesis que el usuario haya escrito
    let n = document.getElementById('b-nombre').value.toUpperCase();
    n = n.replace(/[()]/g, '').trim(); // Elimina ( ) y espacios extra

    const r = parseFloat(document.getElementById('b-rendimiento').value);
    const u = document.getElementById('b-unidad').value.toUpperCase();
    const instrucciones = document.getElementById('b-instrucciones').value.trim();
    
    // Obtener informaci√≥n de conservaci√≥n
    const vidaAmbiente = document.getElementById('b-vida-ambiente').value.trim();
    const vidaRefrigerado = document.getElementById('b-vida-refrigerado').value.trim();
    const vidaCongelado = document.getElementById('b-vida-congelado').value.trim();

    if(!n || isNaN(r) || !u || tempBase.length === 0) {
        alert("‚ö†Ô∏è Completa todos los campos y agrega ingredientes");
        return;
    }

    const sku = document.getElementById('b-sku-hidden').value || Math.random().toString(36).substr(2, 6).toUpperCase();
    const nombreCompleto = "RB " + n;
    
    // VALIDAR QUE NO EXISTA OTRA RECETA BASE CON EL MISMO NOMBRE (solo si es nueva)
    if (!document.getElementById('b-sku-hidden').value) {
        const existe = db.recetasBase.find(rb => rb.nombre === nombreCompleto);
        if (existe) {
            alert(`‚ö†Ô∏è YA EXISTE UNA RECETA BASE CON EL NOMBRE:\n\n"${nombreCompleto}"\n\nPor favor usa otro nombre o edita la receta existente.`);
            return;
        }
    }

    let costoTotalRB = 0;
    tempBase.forEach(ing => {
        const mat = db.materiales.find(m => m.sku === ing.sku);
        if(mat) {
            costoTotalRB += (ing.cant * (mat.precio / mat.factor));
        }
    });

    const rbData = {
        sku,
        nombre: nombreCompleto, // Se guarda como: RB ARROZ CON POLLO
        rendimiento: r,
        unidad: u,
        ingredientes: [...tempBase],
        instrucciones: instrucciones,
        conservacion: {
            ambiente: vidaAmbiente,
            refrigerado: vidaRefrigerado,
            congelado: vidaCongelado
        },
        fotos: [...fotosRecetaBaseTemp] // NUEVO: Guardar fotos
    };

    const idx = db.recetasBase.findIndex(b => b.sku === sku);
    if(idx > -1) {
        db.recetasBase[idx] = rbData;
    } else {
        db.recetasBase.push(rbData);
    }

    const matSku = "MAT-" + sku;
    const matIdx = db.materiales.findIndex(m => m.sku === matSku);
    
    // Calcular al√©rgenos de la receta base (de todos sus ingredientes)
    const alergenosRB = new Set();
    tempBase.forEach(ing => {
        const mat = db.materiales.find(m => m.sku === ing.sku);
        if (mat && mat.alergenos && mat.alergenos.length > 0) {
            mat.alergenos.forEach(alergeno => alergenosRB.add(alergeno));
        }
    });
    
    const matData = {
        sku: matSku,
        nombre: nombreCompleto,
        familia: 'REC COCINA',
        uCompra: u,
        uCosto: u,
        factor: r,
        precio: costoTotalRB,
        alergenos: Array.from(alergenosRB).sort() // Al√©rgenos detectados de los ingredientes
    };

    if(matIdx > -1) {
        db.materiales[matIdx] = matData;
    } else {
        db.materiales.push(matData);
    }

    clearRBForm();
    save();
    renderBases();
    renderMaterials();
    alert("‚úÖ Receta base guardada correctamente");
}

        function addToPlatoTemp() {
            if(!document.getElementById('p-nombre').value) {
                alert("‚ö†Ô∏è Ingresa primero el nombre del plato");
                return;
            }
            
            const sku = document.getElementById('p-item-selector').value;
            const cant = parseFloat(document.getElementById('p-cant').value);
            
            if(!sku || isNaN(cant) || cant <= 0) {
                alert("‚ö†Ô∏è Selecciona un componente y cantidad v√°lida");
                return;
            }
            
            if(tempPlato.some(x => x.sku === sku)) {
                alert("‚ö†Ô∏è Este componente ya est√° agregado");
                return;
            }
            
            const m = db.materiales.find(x => x.sku === sku);
            tempPlato.push({ sku, nombre: m.nombre, cant, unidad: m.uCosto });
            
            document.getElementById('p-item-selector').value = '';
            document.getElementById('p-item-buscar').value = '';
            document.getElementById('p-cant').value = '';
            document.getElementById('p-item-buscar').focus();
            renderTPT();
        }
           // ========== GESTI√ìN DE FOTOS DE PLATOS ==========
let currentPlatoImage = null;

function previewPlatoImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            currentPlatoImage = e.target.result; // Guardar en base64
            document.getElementById('p-preview-img').src = e.target.result;
            document.getElementById('p-preview').classList.remove('hidden');
        };
        
        reader.readAsDataURL(input.files[0]);
    }
}

function eliminarFotoPlato() {
    currentPlatoImage = null;
    document.getElementById('p-foto').value = '';
    document.getElementById('p-preview').classList.add('hidden');
    document.getElementById('p-preview-img').src = '';
}

// ========== FUNCIONES PARA TIPO DE PRODUCTO ==========
function toggleInventarioSelector() {
    var tipo = document.getElementById('p-tipo').value;
    var contenedor = document.getElementById('contenedor-sku-inventario');
    
    if (tipo === 'PRODUCTO_TERMINADO') {
        contenedor.classList.remove('hidden');
    } else {
        contenedor.classList.add('hidden');
        document.getElementById('p-sku-inventario').value = '';
        document.getElementById('p-sku-inventario-buscar').value = '';
    }
}

// ========== DETECTAR EN QU√â PLATOS SE USA UNA RECETA BASE ==========
function obtenerPlatosQueUsanRecetaBase(skuRecetaBase) {
    const platosEncontrados = [];
    const nombreRB = db.recetasBase.find(rb => rb.sku === skuRecetaBase)?.nombre;
    
    if (!nombreRB) return [];
    
    // El SKU del material asociado a la receta base es MAT-{sku}
    const skuMaterial = "MAT-" + skuRecetaBase;
    
    // Buscar en todos los platos
    db.platos.forEach(plato => {
        if (plato.componentes && plato.componentes.length > 0) {
            plato.componentes.forEach(comp => {
                // Comparar por SKU del material
                if (comp.sku === skuMaterial) {
                    platosEncontrados.push({
                        nombre: plato.nombre,
                        cantidad: comp.cant,
                        unidad: comp.unidad
                    });
                }
            });
        }
    });
    
    return platosEncontrados;
}

// ========== MOSTRAR INFO DE VIDA √öTIL Y PLATOS ENLAZADOS ==========
function mostrarInfoRecetaBase(sku) {
    const rb = db.recetasBase.find(r => r.sku === sku);
    if (!rb) return;
    
    const platosEnlazados = obtenerPlatosQueUsanRecetaBase(sku);
    
    let infoConservacion = '';
    if (rb.conservacion) {
        infoConservacion = `
            <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-4">
                <p class="font-bold text-blue-700 mb-2">‚ùÑÔ∏è INFORMACI√ìN DE CONSERVACI√ìN:</p>
                ${rb.conservacion.ambiente ? `<p class="text-sm mb-1"><strong>üå°Ô∏è Temp. Ambiente:</strong> ${rb.conservacion.ambiente}</p>` : ''}
                ${rb.conservacion.refrigerado ? `<p class="text-sm mb-1"><strong>üßä Refrigerado:</strong> ${rb.conservacion.refrigerado}</p>` : ''}
                ${rb.conservacion.congelado ? `<p class="text-sm"><strong>‚ùÑÔ∏è Congelado:</strong> ${rb.conservacion.congelado}</p>` : ''}
            </div>
        `;
    }
    
    let infoPlatosEnlazados = '';
    if (platosEnlazados.length > 0) {
        infoPlatosEnlazados = `
            <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 mb-4">
                <p class="font-bold text-green-700 mb-3">üçΩÔ∏è PLATOS QUE USAN ESTA RECETA BASE (${platosEnlazados.length}):</p>
                <div class="space-y-2">
                    ${platosEnlazados.map(plato => `
                        <div class="bg-white p-2 rounded-lg border border-green-200">
                            <p class="text-sm font-bold text-slate-700">${plato.nombre}</p>
                            <p class="text-xs text-slate-500">Cantidad: ${plato.cantidad} ${plato.unidad}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else {
        infoPlatosEnlazados = `
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-4">
                <p class="font-bold text-yellow-700">‚ö†Ô∏è Esta receta base NO est√° siendo usada en ning√∫n plato del men√∫</p>
            </div>
        `;
    }
    
    return infoConservacion + infoPlatosEnlazados;
}

        // ========== FUNCI√ìN PARA CONVERTIR A TITLE CASE ==========
        function toTitleCase(str) {
            if (!str) return '';
            
            // Palabras que deben permanecer en min√∫scula (excepto si son la primera palabra)
            const palabrasMinusculas = ['de', 'del', 'la', 'el', 'los', 'las', 'a', 'con', 'en', 'y', 'o', 'al'];
            
            return str.toLowerCase().split(' ').map((palabra, index) => {
                // Si la palabra est√° vac√≠a (espacios m√∫ltiples), retornar vac√≠o
                if (!palabra) return '';
                
                // La primera palabra siempre va en may√∫scula, las dem√°s verificar lista
                if (index === 0 || !palabrasMinusculas.includes(palabra)) {
                    return palabra.charAt(0).toUpperCase() + palabra.slice(1);
                }
                
                return palabra;
            }).join(' ');
        }
        
        function saveFinalPlato() {
            console.log('=== INICIANDO GUARDADO DE PLATO ===');
            
            const nombreOriginal = document.getElementById('p-nombre').value.trim();
            console.log('1. Nombre original del campo:', nombreOriginal);
            
            const n = toTitleCase(nombreOriginal); // ‚úÖ CAMBIO: Usar Title Case en lugar de UPPERCASE
            console.log('2. Nombre despu√©s de toTitleCase:', n);
            
            const categoria = document.getElementById('p-categoria').value;
            console.log('3. Categor√≠a:', categoria);
            
            const cocina = document.getElementById('p-cocina').value;
            console.log('3.5. Cocina:', cocina);
            
            const tipo = document.getElementById('p-tipo').value || 'PREPARADO';
            const tipoCarta = document.getElementById('p-tipo-carta').value || 'CARTA';
            const skuInventario = document.getElementById('p-sku-inventario').value || null;
            const precioMenu = parseFloat(document.getElementById('p-precio-menu').value) || 0;
            
            console.log('4. Tipo:', tipo, '| Tipo Carta:', tipoCarta, '| Precio:', precioMenu);
            console.log('5. Componentes (tempPlato):', tempPlato.length, 'items');
            
            if(!n || tempPlato.length === 0) {
                console.error('‚ùå ERROR: Nombre o componentes vac√≠os');
                alert("‚ö†Ô∏è Ingresa el nombre y agrega componentes");
                return;
            }
            
            if(!categoria) {
                console.error('‚ùå ERROR: Categor√≠a vac√≠a');
                alert("‚ö†Ô∏è Selecciona una categor√≠a para el plato");
                return;
            }
            
            // ‚úÖ VALIDACI√ìN DE PRECIO DE VENTA
            if(!precioMenu || precioMenu <= 0) {
                console.error('‚ùå ERROR: Precio inv√°lido:', precioMenu);
                alert("‚ö†Ô∏è Debes ingresar un precio de venta mayor a 0");
                document.getElementById('p-precio-menu').focus();
                return;
            }
            
            // Validar que productos directos tengan SKU de inventario
            if(tipo === 'PRODUCTO_TERMINADO' && !skuInventario) {
                console.error('‚ùå ERROR: Producto directo sin SKU de inventario');
                alert("‚ö†Ô∏è Los productos DIRECTOS deben estar vinculados a un material del inventario");
                return;
            }
            
            const sku = document.getElementById('p-sku-hidden').value || Math.random().toString(36).substr(2, 6).toUpperCase();
            console.log('6. SKU del plato:', sku, '(nuevo:', !document.getElementById('p-sku-hidden').value, ')');
            
            // ‚úÖ CAPTURAR CAMPOS DE DESCRIPCI√ìN PROFESIONAL
            const descripcion = document.getElementById('p-descripcion').value || '';
            const instrucciones = document.getElementById('p-instrucciones').value || '';
            const ventaSugestiva = document.getElementById('p-venta-sugestiva').value || '';
            const adjetivos = document.getElementById('p-adjetivos').value || '';
            const maridaje = document.getElementById('p-maridaje').value || '';
            
            // Calcular costo de la receta
            let costoReceta = 0;
            tempPlato.forEach(comp => {
                const mat = db.materiales.find(m => m.sku === comp.sku);
                if(mat) {
                    costoReceta += (comp.cant * (mat.precio / mat.factor));
                }
            });
            console.log('7. Costo de receta calculado:', costoReceta.toFixed(2));
            
            // Obtener margen seg√∫n categor√≠a
            const margenFC = obtenerMargenPorCategoria(categoria);
            console.log('8. Margen FC para categor√≠a:', (margenFC * 100).toFixed(1) + '%');
            
            // Calcular m√©tricas con margen din√°mico
            const precioSinIGV = precioMenu > 0 ? precioMenu / (1 + 0.18 + 0.10) : 0;
            const fcPorcentaje = (costoReceta > 0 && precioSinIGV > 0) ? (costoReceta / precioSinIGV) * 100 : 0;
            const precioIdeal = costoReceta > 0 ? Math.round(((costoReceta + (costoReceta * 0.18) + (costoReceta * 0.10)) / margenFC) * 100) / 100 : 0;
            
            console.log('9. M√©tricas: Sin IGV:', precioSinIGV.toFixed(2), '| FC%:', fcPorcentaje.toFixed(2), '| Ideal:', precioIdeal.toFixed(2));
            
            // ‚úÖ NOMBRE SIN PREFIJO (el sistema ya no usa PM)
            const nombreFinal = n;
            console.log('10. Nombre final:', nombreFinal);
            
            const pData = {
    sku,
    nombre: nombreFinal,
    categoria: categoria,
    cocina: cocina,
    tipo: tipo,
    tipoCarta: tipoCarta,
    skuInventario: skuInventario,
    componentes: [...tempPlato],
    precioMenu: precioMenu,
    costoReceta: costoReceta,
    precioSinIGV: precioSinIGV,
    fcPorcentaje: fcPorcentaje,
    precioIdeal: precioIdeal,
    foto: currentPlatoImage || null,
    // ‚úÖ NUEVOS CAMPOS DE DESCRIPCI√ìN PROFESIONAL
    descripcion: descripcion,
    instrucciones: instrucciones,
    ventaSugestiva: ventaSugestiva,
    adjetivos: adjetivos,
    maridaje: maridaje
};
            
            console.log('11. Objeto plato creado:', pData);
            
            const idx = db.platos.findIndex(p => p.sku === sku);
            console.log('12. √çndice en db.platos:', idx, '(es edici√≥n:', idx > -1, ')');
            
            if(idx > -1) {
                console.log('13. ACTUALIZANDO plato existente en √≠ndice:', idx);
                console.log('    - Plato anterior:', db.platos[idx].nombre);
                db.platos[idx] = pData;
                console.log('    - Plato nuevo:', db.platos[idx].nombre);
            } else {
                console.log('13. AGREGANDO plato nuevo');
                db.platos.push(pData);
                console.log('    - Total platos ahora:', db.platos.length);
            }
            
            console.log('14. Llamando a clearPlatoForm()...');
            clearPlatoForm();
            
            console.log('15. Llamando a save()...');
            save();
            
            console.log('16. Llamando a renderPlatos()...');
            renderPlatos();
            
            // Actualizar tabs de categor√≠as en POS si est√° abierto
            if (typeof generarTabsCategorias === 'function') {
                var tabsContainer = document.getElementById('tabs-categorias-pos');
                if (tabsContainer) {
                    console.log('17. Actualizando tabs de categor√≠as en POS...');
                    generarTabsCategorias();
                    renderMenuPOS();
                }
            }
            
            console.log('=== ‚úÖ PLATO GUARDADO EXITOSAMENTE ===');
            alert("‚úÖ Producto guardado correctamente");
        }

        function calculateExplosion() {
            if(mrpOrder.length === 0) {
                alert("‚ö†Ô∏è Agrega platos a la lista de producci√≥n");
                return;
            }
            
            try {
                let consolidated = {};
                let totalPax = 0;
                
                const orderCopy = JSON.parse(JSON.stringify(mrpOrder));
                
                orderCopy.forEach(o => {
                    const plato = db.platos.find(p => p.sku === o.sku);
                    if(!plato) {
                        console.error("Plato no encontrado:", o.sku);
                        return;
                    }
                    totalPax += o.qty;
                    plato.componentes.forEach(c => {
                        try {
                            explode(c.sku, c.cant * o.qty, consolidated);
                        } catch(e) {
                            console.error("Error en explosi√≥n de componente:", c.sku, e);
                        }
                    });
                });
                
                let total = 0;
                let totalSinStock = 0;
                let rows = [];
                
                Object.keys(consolidated).forEach((sku, index) => {
                    const m = db.materiales.find(mat => mat.sku === sku);
                    if(!m) {
                        console.error("Material no encontrado:", sku);
                        return;
                    }
                    
                    const reqTotalEnUnidadCosto = consolidated[sku];
                    const reqTotalEnUnidadCompra = reqTotalEnUnidadCosto / m.factor;
                    
                    const stockEnUnidadCosto = db.inventario[sku] || 0;
                    const stockEnUnidadCompra = stockEnUnidadCosto / m.factor;
                    
                    const faltanteEnUnidadCompra = Math.max(0, reqTotalEnUnidadCompra - stockEnUnidadCompra);
                    const sub = Math.round(faltanteEnUnidadCompra * m.precio * 100) / 100;
                    
                    const costoTotal = Math.round(reqTotalEnUnidadCompra * m.precio * 100) / 100;
                    
                    total += costoTotal;
                    totalSinStock += sub;
                    
                    rows.push({
                        idx: index + 1,
                        sku: sku,
                        nombre: m.nombre,
                        unid: m.uCompra,
                        reqTotal: reqTotalEnUnidadCompra.toFixed(2),
                        stock: stockEnUnidadCompra.toFixed(2),
                        faltante: faltanteEnUnidadCompra.toFixed(2),
                        precio: m.precio.toFixed(2),
                        sub: sub.toFixed(2),
                        tieneFaltante: faltanteEnUnidadCompra > 0
                    });
                });
                
                total = Math.round(total * 100) / 100;
                totalSinStock = Math.round(totalSinStock * 100) / 100;
                
                // CALCULAR COMPONENTES DIRECTOS PARA VISTA PRELIMINAR
                let componentesDirectos = [];
                orderCopy.forEach(o => {
                    const plato = db.platos.find(p => p.sku === o.sku);
                    if(!plato) return;
                    
                    plato.componentes.forEach(c => {
                        const esMaterial = db.materiales.find(m => m.sku === c.sku);
                        const esRecetaBase = db.recetasBase.find(rb => rb.sku === c.sku);
                        const cantidadTotal = c.cant * o.qty;
                        
                        if (esMaterial) {
                            const existente = componentesDirectos.find(comp => comp.sku === c.sku);
                            if (existente) {
                                existente.cantidad += cantidadTotal;
                            } else {
                                componentesDirectos.push({
                                    sku: c.sku,
                                    nombre: esMaterial.nombre,
                                    cantidad: cantidadTotal,
                                    unidad: c.unidad,
                                    tipo: 'MATERIAL',
                                    familia: esMaterial.familia || 'OTROS'
                                });
                            }
                        } else if (esRecetaBase) {
                            const existente = componentesDirectos.find(comp => comp.sku === c.sku);
                            if (existente) {
                                existente.cantidad += cantidadTotal;
                            } else {
                                componentesDirectos.push({
                                    sku: c.sku,
                                    nombre: esRecetaBase.nombre,
                                    cantidad: cantidadTotal,
                                    unidad: c.unidad,
                                    tipo: 'RECETA BASE',
                                    familia: 'RECETAS BASE'
                                });
                            }
                        }
                    });
                });
                
                componentesDirectos.sort((a, b) => {
                    if (a.tipo === 'RECETA BASE' && b.tipo !== 'RECETA BASE') return -1;
                    if (a.tipo !== 'RECETA BASE' && b.tipo === 'RECETA BASE') return 1;
                    return a.nombre.localeCompare(b.nombre);
                });
                
                // üîπREGISTRO DE CONSUMO TE√ìRICO

if(!db.consumoTeorico) db.consumoTeorico = [];

lastExplosion = {
    fecha: new Date().toISOString(),
    items: rows,
    total: total.toFixed(2),
    totalSinStock: totalSinStock.toFixed(2),
    pax: totalPax,
    componentesDirectos: componentesDirectos
};


// üîπ REGISTRO DE CONSUMO TE√ìRICO (por explosi√≥n)
if(!db.consumoTeorico) db.consumoTeorico = [];

lastExplosion.items.forEach(item => {
    db.consumoTeorico.push({
        fecha: lastExplosion.fecha,
        sku: item.sku,
        nombre: item.nombre,
        cantidad: parseFloat(item.reqTotal),
        costo: parseFloat(item.sub)
    });
});


                const ahora = new Date();
                const historialEntry = {
                    id: Date.now(),
                    fecha: ahora.toLocaleString('es-PE'),
                    platos: orderCopy.map(o => ({nombre: o.nombre, qty: o.qty})),
                    totalPax: totalPax,
                    costoTotal: totalSinStock,
                    materiales: rows.filter(r => r.tieneFaltante).map(r => ({
                        nombre: r.nombre,
                        unid: r.unid,
                        faltante: r.faltante,
                        precio: r.precio,
                        subtotal: r.sub
                    }))
                };
                
                db.historialProduccion.unshift(historialEntry);
                
                if(db.historialProduccion.length > 50) {
                    db.historialProduccion = db.historialProduccion.slice(0, 50);
                }
                
                save();
                renderHistorial();
                
                mrpOrder = [];
                document.getElementById('mrp-order-list').innerHTML = "";
                
                const itemsConFaltante = rows.filter(r => r.tieneFaltante);
                const itemsSinFaltante = rows.filter(r => !r.tieneFaltante);
                
                document.getElementById('mrp-result').innerHTML = `
                    <div class="w-full pt-0">
                        <div class="bg-gradient-to-r from-purple-100 to-blue-100 p-3 border-2 border-purple-300 rounded-2xl mb-2">
                            <h3 class="font-black text-lg text-center mb-1 text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600">
                                üìä VISTA PRELIMINAR DE PRODUCCI√ìN
                            </h3>
                            <p class="text-center text-xs font-bold text-slate-600 mb-2">Total: ${totalPax} PAX</p>
                            
                            <div class="bg-white rounded-xl overflow-hidden mb-2">
                                <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-2">
                                    <h4 class="font-black text-xs">üìã COMPONENTES NECESARIOS</h4>
                                    <p class="text-[9px] mt-1">Vista directa: Recetas Base + Materiales</p>
                                </div>
                                <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                                    <table class="w-full text-[11px]">
                                        <thead class="bg-slate-100 sticky top-0 z-10">
                                            <tr>
                                                <th class="p-2 text-left font-bold">#</th>
                                                <th class="p-2 text-left font-bold">COMPONENTE</th>
                                                <th class="p-2 text-center font-bold">CANTIDAD</th>
                                                <th class="p-2 text-center font-bold">UNIDAD</th>
                                                <th class="p-2 text-center font-bold">TIPO</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-200">
                                            ${componentesDirectos.map((comp, idx) => `
                                                <tr class="hover:bg-slate-50 ${comp.tipo === 'RECETA BASE' ? 'bg-blue-50' : 'bg-slate-50'}">
                                                    <td class="p-2 font-bold text-slate-700">${idx + 1}</td>
                                                    <td class="p-2 font-semibold ${comp.tipo === 'RECETA BASE' ? 'text-blue-700' : 'text-slate-800'}">
                                                        ${comp.tipo === 'RECETA BASE' ? 'üß™ ' : 'üì¶ '}${comp.nombre}
                                                    </td>
                                                    <td class="p-2 text-center font-bold ${comp.tipo === 'RECETA BASE' ? 'text-blue-600' : 'text-emerald-600'}">
                                                        ${comp.cantidad.toFixed(2)}
                                                    </td>
                                                    <td class="p-2 text-center text-slate-600">${comp.unidad}</td>
                                                    <td class="p-2 text-center">
                                                        ${comp.tipo === 'RECETA BASE' ? 
                                                            '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold">üß™ RB</span>' : 
                                                            '<span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-[10px] font-bold">üì¶ MAT</span>'
                                                        }
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="bg-amber-50 border-2 border-amber-300 rounded-xl p-3 mb-2">
                                <p class="text-xs font-bold text-amber-800 text-center">
                                    üí° <strong>VISTA PRELIMINAR:</strong> Muestra componentes directos (RB + Materiales).<br>
                                    Al exportar PDF puedes elegir entre vista preliminar o disgregado por familias.
                                </p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-3 rounded-2xl text-center">
                                <p class="text-[9px] font-semibold mb-1">RECETAS BASE</p>
                                <p class="text-lg font-black">${componentesDirectos.filter(c => c.tipo === 'RECETA BASE').length}</p>
                            </div>
                            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-3 rounded-2xl text-center">
                                <p class="text-[9px] font-semibold mb-1">MATERIALES</p>
                                <p class="text-lg font-black">${componentesDirectos.filter(c => c.tipo === 'MATERIAL').length}</p>
                            </div>
                            <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-3 rounded-2xl text-center">
                                <p class="text-[9px] font-semibold mb-1">TOTAL ITEMS</p>
                                <p class="text-lg font-black">${componentesDirectos.length}</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl p-3 border-2 border-slate-200">
                            <label class="text-xs font-bold text-slate-700 block mb-2">üìÑ EXPORTAR A PDF</label>
                            <select id="tipo-export-pdf" class="w-full p-2 border-2 border-slate-300 rounded-lg mb-2 font-semibold text-sm">
                                <option value="preliminar">üìã Vista Preliminar (Con Componentes Directos)</option>
                                <option value="orden">üõí Orden de Compra (Disgregado por Familias)</option>
                            </select>
                            <button onclick="exportarPDFSegunTipo()" class="w-full bg-gradient-to-r from-red-600 to-pink-600 text-white py-3 rounded-xl font-bold btn-action">
                                üìÑ EXPORTAR PDF
                            </button>
                            <p class="text-[10px] text-slate-500 mt-2 text-center">
                                üí° <strong>Vista Preliminar:</strong> Muestra RB y materiales tal cual<br>
                                üí° <strong>Orden de Compra:</strong> Todo disgregado, sin RB AGUA FILTRADA
                            </p>
                        </div>
                    </div>
                `;
                
                document.getElementById('btn-pdf-mrp').classList.remove('opacity-50', 'pointer-events-none');
                
                setTimeout(() => {
                    const historialElement = document.getElementById('historial-list');
                    if(historialElement && historialElement.firstChild) {
                        historialElement.firstChild.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        historialElement.firstChild.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.6)';
                        setTimeout(() => {
                            if(historialElement.firstChild) {
                                historialElement.firstChild.style.boxShadow = '';
                            }
                        }, 2000);
                    }
                }, 300);
                
            } catch(error) {
                console.error("Error en calculateExplosion:", error);
                alert("‚ùå Error al calcular explosi√≥n: " + error.message);
            }
        }

        function renderHistorialSemanal() {
            const historialContainer = document.getElementById('historial-semanal-list');
            
            if(!db.historialSemanal || db.historialSemanal.length === 0) {
                historialContainer.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <p class="text-sm font-semibold">No hay historial semanal a√∫n</p>
                    </div>
                `;
                return;
            }
            
            historialContainer.innerHTML = db.historialSemanal.map((h, idx) => `
                <div class="bg-white border-2 border-slate-200 rounded-xl p-3 hover:shadow-md transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="text-xs font-black text-slate-700">${h.fecha}</p>
                            <p class="text-xs font-bold text-green-600 mt-1">üìÖ 14 D√çAS</p>
                            <p class="text-xs font-bold text-purple-600">üë• ${h.totalPax} PAX</p>
                        </div>
                        <span class="badge bg-emerald-100 text-emerald-700 text-xs">S/. ${h.costoTotal}</span>
                    </div>
                    ${h.materiales && h.materiales.length > 0 ? `
                        <button onclick="toggleMaterialesSemanal(${idx})" class="w-full mt-2 bg-gradient-to-r from-green-600 to-teal-600 text-white py-1.5 rounded-lg text-[10px] font-bold hover:from-green-700 hover:to-teal-700 btn-action">
                            <span id="btn-text-semanal-${idx}">üëÅÔ∏è VER MATERIALES</span>
                        </button>
                        <div id="materiales-semanal-${idx}" class="hidden mt-2 bg-slate-50 rounded-lg p-2 border border-slate-200">
                            <p class="text-[10px] font-bold text-slate-700 mb-2">üì¶ MATERIALES COMPRADOS:</p>
                            <div class="space-y-1 max-h-40 overflow-y-auto">
                                ${h.materiales.map(m => `
                                    <div class="flex justify-between text-[10px] bg-white p-2 rounded border border-slate-200">
                                        <span class="font-semibold text-slate-700">${m.nombre}</span>
                                        <div class="flex gap-2 items-center">
                                            <span class="text-blue-600 font-bold">${m.faltante} ${m.unid}</span>
                                            <span class="text-emerald-600 font-bold">S/. ${m.subtotal}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function toggleMaterialesSemanal(idx) {
            const materialesDiv = document.getElementById(`materiales-semanal-${idx}`);
            const btnText = document.getElementById(`btn-text-semanal-${idx}`);
            
            if(materialesDiv.classList.contains('hidden')) {
                materialesDiv.classList.remove('hidden');
                btnText.textContent = 'üôà OCULTAR MATERIALES';
            } else {
                materialesDiv.classList.add('hidden');
                btnText.textContent = 'üëÅÔ∏è VER MATERIALES';
            }
        }

        function explode(sku, qty, result) {
            const rb = db.recetasBase.find(r => "MAT-" + r.sku === sku);
            if(rb) { 
                rb.ingredientes.forEach(ing => explode(ing.sku, (ing.cant / rb.rendimiento) * qty, result)); 
            } else { 
                result[sku] = (result[sku] || 0) + qty; 
            }
        }

        function renderStock() {
            const query = (document.getElementById('search-stock')?.value || '').toUpperCase();
            const filtered = db.materiales.filter(m => m.nombre.includes(query) || m.sku.includes(query));
            
            let totalValorizado = 0;
            
            const rows = filtered.map(m => {
                const stockEnUnidadCosto = db.inventario[m.sku] || 0;
                const stockEnUnidadCompra = stockEnUnidadCosto / m.factor;
                const valorTotal = stockEnUnidadCompra * m.precio;
                totalValorizado += valorTotal;
                
                // Determinar si el campo debe ser editable
                const disabled = !modoAjusteInventario ? 'disabled' : '';
                const bgColor = modoAjusteInventario ? 'bg-yellow-50 border-orange-400' : 'bg-slate-50 border-slate-300';
                
                return `
                    <tr class="hover:bg-blue-50 transition-colors">
                        <td class="p-4">
                            <span class="font-mono text-xs bg-slate-100 px-2 py-1 rounded">${m.sku}</span>
                        </td>
                        <td class="p-4 font-semibold">${m.nombre}</td>
                        <td class="p-4 text-center text-slate-600 font-medium">${m.uCompra}</td>
                        <td class="p-4 text-right font-bold text-blue-600">S/. ${m.precio.toFixed(2)}</td>
                        <td class="p-4 text-right">
                            <input type="number" 
                                   id="stock-${m.sku}"
                                   onchange="actualizarInventarioTemporal('${m.sku}', parseFloat(this.value) || 0, ${m.factor})" 
                                   value="${stockEnUnidadCompra > 0 ? stockEnUnidadCompra.toFixed(2) : ''}" 
                                   class="w-28 p-2 border-2 ${bgColor} rounded-lg text-right font-bold focus:border-blue-500 focus:outline-none"
                                   step="0.01"
                                   placeholder="0.00"
                                   ${disabled}>
                        </td>
                        <td class="p-4 text-right font-black text-emerald-600">S/. ${valorTotal.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('stock-list-container').innerHTML = rows;
            document.getElementById('total-valorizado').textContent = `S/. ${totalValorizado.toFixed(2)}`;
        }
        
        function actualizarInventario(sku, valorEnUnidadCompra, factor) {
            const valorEnUnidadCosto = valorEnUnidadCompra * factor;
            db.inventario[sku] = valorEnUnidadCosto;
            save();
            renderStock();
        }
        
        function actualizarInventarioTemporal(sku, valorEnUnidadCompra, factor) {
            // Solo actualizar en memoria, NO guardar
            const valorEnUnidadCosto = valorEnUnidadCompra * factor;
            db.inventario[sku] = valorEnUnidadCosto;
            // NO llamar save() aqu√≠ - se guardar√° con guardarAjusteInventario()
        }
        
        function aperturarAjusteInventario() {
            if (!confirm('‚ö†Ô∏è ¬øAperturar modo de ajuste de inventario?\n\nPodr√°s editar los stocks manualmente.')) {
                return;
            }
            
            console.log('üìù Aperturando ajuste de inventario...');
            
            // Guardar copia del inventario actual
            inventarioAntesCambios = JSON.parse(JSON.stringify(db.inventario));
            
            // Activar modo ajuste
            modoAjusteInventario = true;
            
            // Mostrar/ocultar botones
            document.getElementById('btn-aperturar-ajuste').classList.add('hidden');
            document.getElementById('btn-guardar-ajuste').classList.remove('hidden');
            document.getElementById('btn-cancelar-ajuste').classList.remove('hidden');
            document.getElementById('mensaje-ajuste').classList.remove('hidden');
            
            // Re-renderizar para habilitar campos
            renderStock();
            
            alert('‚úÖ Modo ajuste activado\n\nAhora puedes editar los stocks manualmente.');
        }
        
        function guardarAjusteInventario() {
            if (!confirm('üíæ ¬øGuardar los cambios del ajuste de inventario?\n\nEsto sobrescribir√° los stocks actuales.')) {
                return;
            }
            
            console.log('üíæ Guardando ajuste de inventario...');
            
            // Guardar en localStorage
            save();
            
            // Desactivar modo ajuste
            modoAjusteInventario = false;
            inventarioAntesCambios = {};
            
            // Mostrar/ocultar botones
            document.getElementById('btn-aperturar-ajuste').classList.remove('hidden');
            document.getElementById('btn-guardar-ajuste').classList.add('hidden');
            document.getElementById('btn-cancelar-ajuste').classList.add('hidden');
            document.getElementById('mensaje-ajuste').classList.add('hidden');
            
            // Re-renderizar para deshabilitar campos
            renderStock();
            
            alert('‚úÖ Ajuste guardado correctamente');
        }
        
        function cancelarAjusteInventario() {
            if (!confirm('‚ùå ¬øCancelar el ajuste de inventario?\n\nSe perder√°n todos los cambios no guardados.')) {
                return;
            }
            
            console.log('‚ùå Cancelando ajuste de inventario...');
            
            // Restaurar inventario original
            db.inventario = JSON.parse(JSON.stringify(inventarioAntesCambios));
            
            // Desactivar modo ajuste
            modoAjusteInventario = false;
            inventarioAntesCambios = {};
            
            // Mostrar/ocultar botones
            document.getElementById('btn-aperturar-ajuste').classList.remove('hidden');
            document.getElementById('btn-guardar-ajuste').classList.add('hidden');
            document.getElementById('btn-cancelar-ajuste').classList.add('hidden');
            document.getElementById('mensaje-ajuste').classList.add('hidden');
            
            // Re-renderizar para deshabilitar campos
            renderStock();
            
            alert('‚ùå Ajuste cancelado - Inventario restaurado');
        }

        // ========== FUNCIONES PARA FOTOS DE RECETAS BASE (NUEVO) ==========
        let fotosRecetaBaseTemp = []; // Array temporal para fotos

        function agregarFotosRB(event) {
            const files = event.target.files;
            const maxFotos = 5;
            
            if (fotosRecetaBaseTemp.length + files.length > maxFotos) {
                alert(`‚ö†Ô∏è M√°ximo ${maxFotos} fotos permitidas.\nActuales: ${fotosRecetaBaseTemp.length}`);
                event.target.value = '';
                return;
            }
            
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('‚ö†Ô∏è Solo se permiten im√°genes');
                    return;
                }
                
                // Limitar tama√±o a 2MB
                if (file.size > 2 * 1024 * 1024) {
                    alert('‚ö†Ô∏è La imagen ' + file.name + ' es muy grande (m√°x 2MB)');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    fotosRecetaBaseTemp.push({
                        nombre: file.name,
                        data: e.target.result,
                        fecha: new Date().toISOString()
                    });
                    renderGaleriaFotosRB();
                };
                reader.readAsDataURL(file);
            });
            
            // Limpiar input
            event.target.value = '';
        }
        
        function renderGaleriaFotosRB() {
            const galeria = document.getElementById('rb-galeria-fotos');
            
            if (fotosRecetaBaseTemp.length === 0) {
                galeria.innerHTML = '<p class="col-span-full text-center text-slate-400 italic text-sm py-4">No hay fotos agregadas</p>';
                return;
            }
            
            galeria.innerHTML = fotosRecetaBaseTemp.map((foto, idx) => `
                <div class="relative group">
                    <img src="${foto.data}" class="w-full h-32 object-cover rounded-xl border-2 border-purple-200 shadow-md hover:shadow-xl transition-all">
                    <button onclick="eliminarFotoRB(${idx})" class="absolute top-2 right-2 bg-red-500 text-white w-7 h-7 rounded-full font-bold opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600 flex items-center justify-center text-xs">
                        ‚úñ
                    </button>
                    <div class="absolute bottom-2 left-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded">
                        üì∑ ${idx + 1}
                    </div>
                </div>
            `).join('');
        }
        
        function eliminarFotoRB(index) {
            if (confirm('¬øEliminar esta foto?')) {
                fotosRecetaBaseTemp.splice(index, 1);
                renderGaleriaFotosRB();
            }
        }

        function clearRBForm() {
            ['b-sku-hidden','b-nombre','b-rendimiento','b-unidad','b-instrucciones','b-vida-ambiente','b-vida-refrigerado','b-vida-congelado'].forEach(i => {
                const el = document.getElementById(i);
                if(el) el.value = '';
            });
            // Limpiar buscador
            const buscar = document.getElementById('b-insumo-buscar');
            if(buscar) buscar.value = '';
            const insumo = document.getElementById('b-insumo');
            if(insumo) insumo.value = '';
            
            tempBase = [];
            fotosRecetaBaseTemp = []; // NUEVO: Limpiar fotos
            renderTBT();
            renderGaleriaFotosRB(); // NUEVO: Re-renderizar galer√≠a vac√≠a
        }

        function clearPlatoForm() {
            // Limpiar campos b√°sicos (verificando que existan)
            ['p-sku-hidden','p-nombre','p-categoria','p-cocina','p-precio-menu','p-sku-inventario'].forEach(i => {
                const elem = document.getElementById(i);
                if (elem) elem.value = '';
            });
            
            // Resetear tipo a PREPARADO
            const tipoSelect = document.getElementById('p-tipo');
            if (tipoSelect) tipoSelect.value = 'PREPARADO';
            
            const contenedorInv = document.getElementById('contenedor-sku-inventario');
            if (contenedorInv) contenedorInv.classList.add('hidden');
            
            // Limpiar buscadores
            const buscar = document.getElementById('p-item-buscar');
            if(buscar) buscar.value = '';
            const selector = document.getElementById('p-item-selector');
            if(selector) selector.value = '';
            const buscarInventario = document.getElementById('p-sku-inventario-buscar');
            if(buscarInventario) buscarInventario.value = '';
            
            // ‚úÖ LIMPIAR CAMPOS DE DESCRIPCI√ìN PROFESIONAL
            const descripcion = document.getElementById('p-descripcion');
            if (descripcion) descripcion.value = '';
            const instrucciones = document.getElementById('p-instrucciones');
            if (instrucciones) instrucciones.value = '';
            const ventaSugestiva = document.getElementById('p-venta-sugestiva');
            if (ventaSugestiva) ventaSugestiva.value = '';
            const adjetivos = document.getElementById('p-adjetivos');
            if (adjetivos) adjetivos.value = '';
            const maridaje = document.getElementById('p-maridaje');
            if (maridaje) maridaje.value = '';
            
            // ‚úÖ LIMPIAR CHECKBOXES DE ALERGIAS (solo si existen)
            ['p-alergia-gluten', 'p-alergia-lactosa', 'p-alergia-mariscos', 
             'p-alergia-frutos-secos', 'p-alergia-huevo', 'p-alergia-soja', 
             'p-vegano', 'p-vegetariano'].forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.checked = false;
                }
            });
            
            tempPlato = [];
            renderTPT();
            
            // üì∏ LIMPIAR FOTO
            if (typeof eliminarFotoPlato === 'function') {
                eliminarFotoPlato();
            }
            
            // Restaurar el bot√≥n al modo creaci√≥n
            const btnGuardar = document.getElementById('btn-guardar-plato');
            if (btnGuardar) {
                btnGuardar.innerHTML = 'üíæ GUARDAR PLATO';
                btnGuardar.className = 'flex-1 bg-gradient-to-r from-slate-700 to-slate-900 text-white py-4 btn-action font-bold';
            }
            
            console.log('‚úÖ Formulario de plato limpiado - Modo: CREAR NUEVO');
        }
        function deleteItem(list, key, value, callback) {
            if(confirm("‚ö†Ô∏è ¬øEst√°s seguro de eliminar este elemento?")) {
                db[list] = db[list].filter(i => i[key] !== value);
                save();
                callback();
                
                // Actualizar tabs de categor√≠as si se elimin√≥ un plato
                if (list === 'platos' && typeof generarTabsCategorias === 'function') {
                    var tabsContainer = document.getElementById('tabs-categorias-pos');
                    if (tabsContainer) {
                        console.log('üîÑ Actualizando tabs tras eliminar plato...');
                        generarTabsCategorias();
                        renderMenuPOS();
                    }
                }
            }
        }

        function renderAll() {
    renderMaterials();
    renderBases();
    renderPlatos();
    updateDropdowns();
    updateFamiliasDropdown(); // ‚¨ÖÔ∏è AGREGAR ESTA L√çNEA
    updateAreasDropdown(); // ‚¨ÖÔ∏è AGREGAR actualizaci√≥n de √°reas
}

function updateDropdowns() {
    // Ordenar materiales alfab√©ticamente
    const materialesOrdenados = [...db.materiales].sort((a, b) => 
        a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' })
    );
    
    const materialesOptions = `<option value="">-- Seleccionar Material --</option>` + 
        materialesOrdenados.map(x => `<option value="${x.sku}">${x.nombre} [${x.uCosto}]</option>`).join('');
    
    document.getElementById('b-insumo').innerHTML = materialesOptions;
    document.getElementById('p-item-selector').innerHTML = materialesOptions;
    
    // Ordenar platos alfab√©ticamente
    const platosOrdenados = [...db.platos].sort((a, b) => 
        a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' })
    );
    
    document.getElementById('mrp-select').innerHTML = `<option value="">-- Seleccionar Plato --</option>` + 
        platosOrdenados.map(x => `<option value="${x.sku}">${x.nombre}</option>`).join('');
}

        function openPasteModal() {
            // üîê VALIDACI√ìN DE CLAVE ADMIN
            solicitarClaveAdmin(function() {
                openPasteModalReal();
            }, 'üì• IMPORTAR materiales desde Excel requiere clave de administrador');
        }
        
        function openPasteModalReal() {
            document.getElementById('pasteModal').style.display = 'flex';
        }

        function closePasteModal() {
            document.getElementById('pasteModal').style.display = 'none';
            document.getElementById('pasteArea').value = '';
        }

        function processPaste() {
            const lines = document.getElementById('pasteArea').value.trim().split('\n');
            let count = 0;
            let errores = 0;
            
            lines.forEach((l, index) => {
                const c = l.split('\t');
                if(c.length >= 7) {
                    try {
                        // Procesar al√©rgenos (columna 2)
                        let alergenosArray = [];
                        if (c[2] && c[2].trim()) {
                            alergenosArray = c[2].trim()
                                .toUpperCase()
                                .split(',')
                                .map(a => a.trim())
                                .filter(a => a.length > 0);
                        }
                        
                        db.materiales.push({
                            sku: "MAT-" + Math.random().toString(36).substr(2, 6).toUpperCase(),
                            nombre: c[0].trim().toUpperCase(),
                            familia: c[1].trim().toUpperCase(),
                            alergenos: alergenosArray,
                            uCompra: c[3].trim().toUpperCase(),
                            uCosto: c[4].trim().toUpperCase(),
                            factor: parseFloat(c[5].replace(',', '.')),
                            precio: parseFloat(c[6].replace(',', '.'))
                        });
                        count++;
                    } catch (e) {
                        console.error(`Error en l√≠nea ${index + 1}:`, e);
                        errores++;
                    }
                } else {
                    console.warn(`L√≠nea ${index + 1} omitida: formato incorrecto (${c.length} columnas, se esperan 7)`);
                    errores++;
                }
            });
            
            save();
            renderMaterials();
            updateAlergenosFilter(); // Actualizar filtro de al√©rgenos
            closePasteModal();
            
            if (errores > 0) {
                alert(`‚úÖ Se importaron ${count} materiales correctamente\n‚ö†Ô∏è ${errores} l√≠neas omitidas por formato incorrecto\n\nFormato esperado: NOMBRE, FAMILIA, ALERGENOS, U.COMPRA, U.COSTO, FACTOR, PRECIO`);
            } else {
                alert(`‚úÖ Se importaron ${count} materiales correctamente`);
            }
        }

        // ========== FUNCIONES PARA PEGAR COMPONENTES DE PLATOS DESDE EXCEL ==========
        function openPasteModalPlato() {
            if(!document.getElementById('p-nombre').value) {
                alert("‚ö†Ô∏è Primero ingresa el nombre del plato antes de importar componentes");
                return;
            }
            document.getElementById('pasteModalPlato').style.display = 'flex';
        }

        function closePasteModalPlato() {
            document.getElementById('pasteModalPlato').style.display = 'none';
            document.getElementById('pasteAreaPlato').value = '';
        }

        function processPastePlato() {
            const lines = document.getElementById('pasteAreaPlato').value.trim().split('\n');
            let count = 0;
            let errores = 0;
            const erroresDetalle = [];
            
            lines.forEach((l, index) => {
                const c = l.split('\t');
                if(c.length >= 2) {
                    try {
                        const nombreIngrediente = c[0].trim().toUpperCase();
                        const cantidad = parseFloat(c[1].replace(',', '.'));
                        
                        if(isNaN(cantidad) || cantidad <= 0) {
                            erroresDetalle.push(`L√≠nea ${index + 1}: Cantidad inv√°lida (${c[1]})`);
                            errores++;
                            return;
                        }
                        
                        // Buscar el ingrediente en materiales
                        const material = db.materiales.find(m => m.nombre === nombreIngrediente);
                        
                        if(!material) {
                            erroresDetalle.push(`L√≠nea ${index + 1}: No se encontr√≥ "${nombreIngrediente}" en materiales`);
                            errores++;
                            return;
                        }
                        
                        // Verificar si ya est√° agregado
                        if(tempPlato.some(x => x.sku === material.sku)) {
                            erroresDetalle.push(`L√≠nea ${index + 1}: "${nombreIngrediente}" ya est√° agregado`);
                            errores++;
                            return;
                        }
                        
                        // Agregar a tempPlato
                        tempPlato.push({ 
                            sku: material.sku, 
                            nombre: material.nombre, 
                            cant: cantidad, 
                            unidad: material.uCosto 
                        });
                        count++;
                        
                    } catch (e) {
                        console.error(`Error en l√≠nea ${index + 1}:`, e);
                        erroresDetalle.push(`L√≠nea ${index + 1}: Error al procesar`);
                        errores++;
                    }
                } else {
                    erroresDetalle.push(`L√≠nea ${index + 1}: Formato incorrecto (${c.length} columnas, se esperan 2)`);
                    errores++;
                }
            });
            
            // Actualizar tabla y c√°lculos
            renderTPT();
            calculatePlatoMetrics();
            closePasteModalPlato();
            
            // Mostrar resultado
            if (count > 0 && errores === 0) {
                alert(`‚úÖ Se importaron ${count} componentes correctamente`);
            } else if (count > 0 && errores > 0) {
                alert(`‚úÖ Se importaron ${count} componentes correctamente\n‚ö†Ô∏è ${errores} l√≠neas con errores:\n\n${erroresDetalle.slice(0, 5).join('\n')}${errores > 5 ? `\n...y ${errores - 5} m√°s` : ''}`);
            } else {
                alert(`‚ùå No se pudo importar ning√∫n componente\n\n${erroresDetalle.slice(0, 5).join('\n')}${errores > 5 ? `\n...y ${errores - 5} m√°s` : ''}\n\nVerifica que:\n1. Los nombres coincidan exactamente con los de Materiales\n2. El formato sea: NOMBRE[TAB]CANTIDAD`);
            }
        }

        function editBase(sku) {
            const b = db.recetasBase.find(x => x.sku === sku);
            document.getElementById('b-sku-hidden').value = b.sku;
            document.getElementById('b-nombre').value = b.nombre.replace("RB ", "");
            document.getElementById('b-rendimiento').value = b.rendimiento;
            document.getElementById('b-unidad').value = b.unidad;
            document.getElementById('b-instrucciones').value = b.instrucciones || '';
            
            // Cargar informaci√≥n de conservaci√≥n
            if (b.conservacion) {
                document.getElementById('b-vida-ambiente').value = b.conservacion.ambiente || '';
                document.getElementById('b-vida-refrigerado').value = b.conservacion.refrigerado || '';
                document.getElementById('b-vida-congelado').value = b.conservacion.congelado || '';
            } else {
                document.getElementById('b-vida-ambiente').value = '';
                document.getElementById('b-vida-refrigerado').value = '';
                document.getElementById('b-vida-congelado').value = '';
            }
            
            // NUEVO: Cargar fotos
            fotosRecetaBaseTemp = b.fotos ? [...b.fotos] : [];
            renderGaleriaFotosRB();

            tempBase = [...b.ingredientes];
            renderTBT();
            window.scrollTo({top: 0, behavior: 'smooth'});
            showSection('bases');
        }
        
        // ========== FUNCI√ìN: VER FOTO EN GRANDE (NUEVO) ==========
        function verFotoGrande(dataUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-center; cursor: pointer;';
            modal.onclick = () => modal.remove();
            
            const img = document.createElement('img');
            img.src = dataUrl;
            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 12px; box-shadow: 0 0 30px rgba(255,255,255,0.3);';
            
            modal.appendChild(img);
            document.body.appendChild(modal);
        }

        function renderBases() {
            const query = (document.getElementById('search-bases')?.value || '').toUpperCase();
            const filtered = db.recetasBase.filter(b => b.nombre.includes(query));
            
            // Actualizar contador
            const contador = document.getElementById('contador-recetas-base');
            if (contador) {
                if (query) {
                    contador.textContent = `üìä Mostrando ${filtered.length} de ${db.recetasBase.length} recetas base`;
                } else {
                    contador.textContent = `üìä Total: ${db.recetasBase.length} recetas base registradas`;
                }
            }
            
            // Ordenar alfab√©ticamente
            filtered.sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            document.getElementById('list-bases').innerHTML = filtered.map(b => {
                const platosEnlazados = obtenerPlatosQueUsanRecetaBase(b.sku);
                
                return `
                <tr class="hover:bg-emerald-50 transition-colors border-b border-slate-100">
                    <td class="p-4">
                        <div>
                            <p class="font-black text-sm text-slate-700">${b.nombre}</p>
                            
                            ${b.instrucciones ? `
                                <details class="mt-2">
                                    <summary class="text-xs text-emerald-600 font-bold cursor-pointer hover:text-emerald-700">
                                        üìù Ver instrucciones
                                    </summary>
                                    <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-2 mt-1">
                                        <ol class="list-decimal list-inside space-y-1 text-xs text-slate-600">
                                            ${b.instrucciones
                                                .split('\n')
                                                .filter(l => l.trim() !== '')
                                                .map(line => `<li>${line.replace(/^[0-9]+\.?\s*/, '')}</li>`)
                                                .join('')}
                                        </ol>
                                    </div>
                                </details>
                            ` : ''}
                            
                            ${b.conservacion && (b.conservacion.ambiente || b.conservacion.refrigerado || b.conservacion.congelado) ? `
                                <details class="mt-2">
                                    <summary class="text-xs text-blue-600 font-bold cursor-pointer hover:text-blue-700">
                                        ‚ùÑÔ∏è Informaci√≥n de conservaci√≥n
                                    </summary>
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 mt-1 space-y-1">
                                        ${b.conservacion.ambiente ? `<p class="text-xs"><strong>üå°Ô∏è Ambiente:</strong> ${b.conservacion.ambiente}</p>` : ''}
                                        ${b.conservacion.refrigerado ? `<p class="text-xs"><strong>üßä Refrigerado:</strong> ${b.conservacion.refrigerado}</p>` : ''}
                                        ${b.conservacion.congelado ? `<p class="text-xs"><strong>‚ùÑÔ∏è Congelado:</strong> ${b.conservacion.congelado}</p>` : ''}
                                    </div>
                                </details>
                            ` : ''}
                            
                            ${b.fotos && b.fotos.length > 0 ? `
                                <details class="mt-2">
                                    <summary class="text-xs text-purple-600 font-bold cursor-pointer hover:text-purple-700 flex items-center gap-1">
                                        üì∏ Fotos (${b.fotos.length})
                                    </summary>
                                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-2 mt-1">
                                        <div class="grid grid-cols-3 gap-2">
                                            ${b.fotos.map(foto => `
                                                <img src="${foto.data}" class="w-full h-20 object-cover rounded border-2 border-purple-300 cursor-pointer hover:scale-105 transition-transform" onclick="verFotoGrande('${foto.data.replace(/'/g, "\\'")}')">
                                            `).join('')}
                                        </div>
                                    </div>
                                </details>
                            ` : ''}
                            
                            <details class="mt-2">
                                <summary class="text-xs ${platosEnlazados.length > 0 ? 'text-green-600' : 'text-yellow-600'} font-bold cursor-pointer hover:opacity-80">
                                    üçΩÔ∏è Usado en ${platosEnlazados.length} plato${platosEnlazados.length !== 1 ? 's' : ''}
                                </summary>
                                ${platosEnlazados.length > 0 ? `
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-2 mt-1 space-y-1">
                                        ${platosEnlazados.map(plato => `
                                            <div class="text-xs bg-white p-2 rounded border border-green-200">
                                                <p class="font-bold">${plato.nombre}</p>
                                                <p class="text-slate-500">Cantidad: ${plato.cantidad} ${plato.unidad}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2 mt-1">
                                        <p class="text-xs text-yellow-700">‚ö†Ô∏è No est√° siendo usada en ning√∫n plato</p>
                                    </div>
                                `}
                            </details>
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        <span class="inline-block bg-blue-100 text-blue-700 px-3 py-1 rounded-lg font-bold text-xs">
                            ${b.rendimiento} ${b.unidad}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        <span class="inline-block bg-purple-100 text-purple-700 px-3 py-1 rounded-lg font-bold text-xs">
                            ${b.ingredientes.length} ingredientes
                        </span>
                    </td>
                    <td class="p-4">
                        <div class="flex gap-2 justify-end">
                            <button onclick="editBase('${b.sku}')" 
                                    class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg font-bold text-xs hover:bg-blue-200 btn-action"
                                    title="Editar receta">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="exportRecetaBasePDF('${b.sku}')" 
                                    class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-3 py-2 rounded-lg text-xs font-bold btn-action"
                                    title="Exportar PDF">
                                üìÑ
                            </button>
                            <button onclick="abrirModalProduccion('${b.sku}')" 
                                    class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-3 py-2 rounded-lg text-xs font-bold btn-action"
                                    title="Calcular producci√≥n">
                                üè≠
                            </button>
                            <button onclick="deleteItem('recetasBase','sku','${b.sku}',renderBases)" 
                                    class="bg-red-100 text-red-600 px-3 py-2 rounded-lg font-bold text-xs hover:bg-red-200 btn-action"
                                    title="Eliminar receta">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
            
            // Mensaje si no hay resultados
            if (filtered.length === 0) {
                document.getElementById('list-bases').innerHTML = `
                    <tr>
                        <td colspan="4" class="p-12 text-center">
                            <div class="text-slate-400">
                                <p class="text-4xl mb-4">üîç</p>
                                <p class="font-bold text-lg">No se encontraron recetas base</p>
                                ${query ? `<p class="text-sm mt-2">Intenta con otro t√©rmino de b√∫squeda</p>` : `<p class="text-sm mt-2">Crea tu primera receta base</p>`}
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // ========== FUNCIONES DE B√öSQUEDA PREDICTIVA ==========
        
        function mostrarSugerenciasRecetasBase() {
            const input = document.getElementById('search-bases').value.toUpperCase();
            const contenedor = document.getElementById('sugerencias-recetas-base');
            
            if (input.length < 2) {
                contenedor.classList.add('hidden');
                return;
            }
            
            const coincidencias = db.recetasBase
                .filter(rb => rb.nombre.includes(input))
                .slice(0, 8)  // Mostrar m√°ximo 8 sugerencias
                .sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            if (coincidencias.length === 0) {
                contenedor.classList.add('hidden');
                return;
            }
            
            contenedor.innerHTML = coincidencias.map(rb => `
                <div class="p-3 hover:bg-emerald-50 cursor-pointer border-b border-slate-100 last:border-b-0"
                     onclick="seleccionarSugerenciaRecetaBase('${rb.nombre}')">
                    <p class="font-bold text-sm text-slate-700">${rb.nombre}</p>
                    <p class="text-xs text-slate-500">${rb.rendimiento} ${rb.unidad} ‚Ä¢ ${rb.ingredientes.length} ingredientes</p>
                </div>
            `).join('');
            
            contenedor.classList.remove('hidden');
        }
        
        function seleccionarSugerenciaRecetaBase(nombre) {
            document.getElementById('search-bases').value = nombre;
            document.getElementById('sugerencias-recetas-base').classList.add('hidden');
            renderBases();
        }
        
        function limpiarBusquedaBases() {
            document.getElementById('search-bases').value = '';
            document.getElementById('sugerencias-recetas-base').classList.add('hidden');
            renderBases();
        }
        
        // Cerrar sugerencias al hacer click fuera
        document.addEventListener('click', function(e) {
            const searchInput = document.getElementById('search-bases');
            const sugerencias = document.getElementById('sugerencias-recetas-base');
            
            if (searchInput && sugerencias && !searchInput.contains(e.target) && !sugerencias.contains(e.target)) {
                sugerencias.classList.add('hidden');
            }
            
            // Para platos
            const searchPlatos = document.getElementById('search-platos');
            const sugerenciasPlatos = document.getElementById('sugerencias-platos');
            
            if (searchPlatos && sugerenciasPlatos && !searchPlatos.contains(e.target) && !sugerenciasPlatos.contains(e.target)) {
                sugerenciasPlatos.classList.add('hidden');
            }
            
            // Para materiales
            const searchMateriales = document.getElementById('search-materials');
            const sugerenciasMateriales = document.getElementById('sugerencias-materiales');
            
            if (searchMateriales && sugerenciasMateriales && !searchMateriales.contains(e.target) && !sugerenciasMateriales.contains(e.target)) {
                sugerenciasMateriales.classList.add('hidden');
            }
        });

        // ========== B√öSQUEDA PREDICTIVA DE PLATOS ==========
        function mostrarSugerenciasPlatos() {
            const input = document.getElementById('search-platos').value.toUpperCase();
            const contenedor = document.getElementById('sugerencias-platos');
            
            if (input.length < 2) {
                contenedor.classList.add('hidden');
                renderPlatos();
                return;
            }
            
            // B√∫squeda por palabras - encuentra platos que contengan TODAS las palabras buscadas
            const palabrasBuscadas = input.split(' ').filter(p => p.length > 0);
            
            const coincidencias = db.platos
                .filter(p => {
                    // Verificar que el nombre contenga TODAS las palabras buscadas
                    return palabrasBuscadas.every(palabra => p.nombre.includes(palabra));
                })
                .slice(0, 8)
                .sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            if (coincidencias.length === 0) {
                contenedor.classList.add('hidden');
                renderPlatos();
                return;
            }
            
            contenedor.innerHTML = coincidencias.map(p => `
                <div class="p-3 hover:bg-orange-50 cursor-pointer border-b border-slate-100 last:border-b-0"
                     onclick="aplicarFiltroPlato('${p.nombre.replace(/'/g, "\\'")}')">
                    <p class="font-bold text-sm text-slate-700">${p.nombre}</p>
                    <p class="text-xs text-slate-500">${p.categoria || 'Sin categor√≠a'} ‚Ä¢ S/. ${p.precioMenu.toFixed(2)}</p>
                </div>
            `).join('');
            
            contenedor.classList.remove('hidden');
            renderPlatos();
        }
        
        function aplicarFiltroPlato(nombre) {
            document.getElementById('search-platos').value = nombre;
            document.getElementById('sugerencias-platos').classList.add('hidden');
            renderPlatos();
        }

        // ========== B√öSQUEDA PREDICTIVA DE MATERIALES ==========
        function mostrarSugerenciasMateriales() {
            const input = document.getElementById('search-materials').value.toUpperCase();
            const contenedor = document.getElementById('sugerencias-materiales');
            
            if (input.length < 2) {
                contenedor.classList.add('hidden');
                renderMaterials();
                return;
            }
            
            // B√∫squeda por palabras - encuentra materiales que contengan TODAS las palabras buscadas
            const palabrasBuscadas = input.split(' ').filter(p => p.length > 0);
            
            const coincidencias = db.materiales
                .filter(m => {
                    // Verificar que el nombre o familia contengan TODAS las palabras buscadas
                    return palabrasBuscadas.every(palabra => 
                        m.nombre.includes(palabra) || (m.familia && m.familia.includes(palabra))
                    );
                })
                .slice(0, 8)
                .sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            if (coincidencias.length === 0) {
                contenedor.classList.add('hidden');
                renderMaterials();
                return;
            }
            
            contenedor.innerHTML = coincidencias.map(m => {
                const stockEnUnidadCompra = (db.inventario[m.sku] || 0) / m.factor;
                let stockIcon = 'üî¥';
                if (stockEnUnidadCompra >= 1) stockIcon = 'üü¢';
                else if (stockEnUnidadCompra > 0) stockIcon = 'üü°';
                
                return `
                <div class="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-b-0"
                     onclick="aplicarFiltroMaterial('${m.nombre.replace(/'/g, "\\'")}')">
                    <p class="font-bold text-sm text-slate-700">${m.nombre}</p>
                    <p class="text-xs text-slate-500">${m.familia || 'Sin familia'} ‚Ä¢ ${stockIcon} ${stockEnUnidadCompra.toFixed(2)} ${m.uCompra} ‚Ä¢ S/. ${m.precio.toFixed(2)}</p>
                </div>
            `}).join('');
            
            contenedor.classList.remove('hidden');
            renderMaterials();
        }
        
        function aplicarFiltroMaterial(nombre) {
            document.getElementById('search-materials').value = nombre;
            document.getElementById('sugerencias-materiales').classList.add('hidden');
            renderMaterials();
        }
        
        function limpiarBusquedaMateriales() {
            document.getElementById('search-materials').value = '';
            document.getElementById('filter-alergenos').value = '';
            document.getElementById('sugerencias-materiales').classList.add('hidden');
            renderMaterials();
        }


function editPlato(sku) {
    console.log('=== INICIANDO EDICI√ìN DE PLATO ===');
    console.log('1. SKU a editar:', sku);
    
    const p = db.platos.find(x => x.sku === sku);
    
    if (!p) {
        console.error('‚ùå ERROR: Plato no encontrado con SKU:', sku);
        alert('‚ùå Error: Plato no encontrado');
        return;
    }
    
    console.log('2. Plato encontrado:', p);
    console.log('   - Nombre completo:', p.nombre);
    console.log('   - Categor√≠a:', p.categoria);
    console.log('   - Precio:', p.precioMenu);
    console.log('   - Componentes:', p.componentes.length);
    
    document.getElementById('p-sku-hidden').value = p.sku;
    const nombreSinPrefijo = p.nombre.replace("PM ", "");
    console.log('3. Nombre sin prefijo PM:', nombreSinPrefijo);
    
    document.getElementById('p-nombre').value = nombreSinPrefijo;
    document.getElementById('p-categoria').value = p.categoria || '';
    document.getElementById('p-cocina').value = p.cocina || '';
    document.getElementById('p-tipo').value = p.tipo || 'PREPARADO';
    document.getElementById('p-tipo-carta').value = p.tipoCarta || 'CARTA';
    document.getElementById('p-precio-menu').value = p.precioMenu || '';
    
    console.log('4. Campos del formulario cargados');
    console.log('   - p-sku-hidden:', document.getElementById('p-sku-hidden').value);
    console.log('   - p-nombre:', document.getElementById('p-nombre').value);
    console.log('   - p-categoria:', document.getElementById('p-categoria').value);
    console.log('   - p-cocina:', document.getElementById('p-cocina').value);
    console.log('   - p-precio-menu:', document.getElementById('p-precio-menu').value);
    
    // Cargar SKU inventario si es producto directo
    if (p.tipo === 'PRODUCTO_TERMINADO') {
        console.log('5. Es producto directo, cargando SKU inventario...');
        document.getElementById('p-sku-inventario').value = p.skuInventario || '';
        
        // Cargar nombre del material en el campo de b√∫squeda
        if (p.skuInventario) {
            const material = db.materiales.find(m => m.sku === p.skuInventario);
            if (material) {
                document.getElementById('p-sku-inventario-buscar').value = material.nombre;
                console.log('   - Material vinculado:', material.nombre);
            }
        }
        
        document.getElementById('contenedor-sku-inventario').classList.remove('hidden');
    } else {
        console.log('5. Es plato preparado, ocultando SKU inventario');
        document.getElementById('contenedor-sku-inventario').classList.add('hidden');
    }
    
    // ‚úÖ CARGAR CAMPOS DE DESCRIPCI√ìN PROFESIONAL
    document.getElementById('p-descripcion').value = p.descripcion || '';
    document.getElementById('p-instrucciones').value = p.instrucciones || '';
    document.getElementById('p-venta-sugestiva').value = p.ventaSugestiva || '';
    document.getElementById('p-adjetivos').value = p.adjetivos || '';
    document.getElementById('p-maridaje').value = p.maridaje || '';
    
    console.log('6. Campos de descripci√≥n cargados');
    
    tempPlato = [...p.componentes];
    console.log('7. tempPlato cargado con', tempPlato.length, 'componentes');
    
    renderTPT();
    console.log('8. Tabla de componentes renderizada');
    
    // üì∏ CARGAR FOTO SI EXISTE
    if(p.foto) {
        currentPlatoImage = p.foto;
        document.getElementById('p-preview-img').src = p.foto;
        document.getElementById('p-preview').classList.remove('hidden');
        console.log('9. Foto del plato cargada');
    } else {
        eliminarFotoPlato();
        console.log('9. Sin foto');
    }
    
    console.log('=== ‚úÖ PLATO CARGADO PARA EDICI√ìN ===');
    
    // Cambiar el texto del bot√≥n a modo edici√≥n
    const btnGuardar = document.getElementById('btn-guardar-plato');
    if (btnGuardar) {
        btnGuardar.innerHTML = '‚úèÔ∏è ACTUALIZAR PLATO';
        btnGuardar.className = 'flex-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white py-4 btn-action font-bold';
    }
    
    window.scrollTo({top: 0, behavior: 'smooth'});
    showSection('menu');
}

// üì∏ RENDErplatos LEIDER TISNADO MEGO

function renderPlatos() {
    const query = (document.getElementById('search-platos')?.value || '').toUpperCase();
    
    // B√∫squeda por palabras - encuentra platos que contengan TODAS las palabras buscadas
    const palabrasBuscadas = query.split(' ').filter(p => p.length > 0);
    
    const filtered = db.platos.filter(p => {
        if (palabrasBuscadas.length === 0) return true;
        // Verificar que el nombre contenga TODAS las palabras buscadas
        return palabrasBuscadas.every(palabra => p.nombre.includes(palabra));
    });
    
    // Actualizar contador
    const contador = document.getElementById('contador-platos');
    if (contador) {
        if (query) {
            contador.textContent = `üìä Mostrando ${filtered.length} de ${db.platos.length} platos`;
        } else {
            contador.textContent = `üìä Total: ${db.platos.length} platos registrados`;
        }
    }
    
    document.getElementById('list-platos').innerHTML = filtered.map(p => `
        <div class="glass-card overflow-hidden hover:shadow-xl transition-shadow">
            ${p.foto ? `
                <div class="relative h-48 overflow-hidden">
                    <img src="${p.foto}" alt="${p.nombre}" 
                         class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                    <div class="absolute bottom-3 left-3 right-3">
                        <p class="font-black text-white text-lg drop-shadow-lg">${p.nombre}</p>
                    </div>
                </div>
            ` : `
                <div class="bg-gradient-to-br from-orange-100 to-amber-100 h-48 flex items-center justify-center">
                    <div class="text-center">
                        <span class="text-6xl">üçΩÔ∏è</span>
                        <p class="font-black text-lg mt-2 text-slate-700">${p.nombre}</p>
                    </div>
                </div>
            `}
            
            <div class="p-5 border-t-4 border-orange-500">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-xs text-slate-500 font-semibold">
                        ${p.componentes.length} componentes
                    </p>
                    <span class="badge ${p.categoria ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}">
                        ${p.categoria || 'Sin categor√≠a'}
                    </span>
                </div>
                
                ${p.cocina ? `
                    <div class="mb-3">
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold ${
                            // Colores por √°rea
                            p.cocina === 'LOBBY BAR' ? 'bg-purple-100 text-purple-700' :
                            p.cocina === 'LE CAFE' ? 'bg-amber-100 text-amber-700' :
                            p.cocina === 'LA LOCANDA' ? 'bg-red-100 text-red-700' :
                            p.cocina === 'BANQUETES' ? 'bg-pink-100 text-pink-700' :
                            p.cocina === 'LA FONDUE' ? 'bg-orange-100 text-orange-700' :
                            p.cocina === 'ROOM SERVICE' ? 'bg-blue-100 text-blue-700' :
                            p.cocina === 'PISO EJECUTIVO' ? 'bg-indigo-100 text-indigo-700' :
                            // Colores legacy (compatibilidad)
                            p.cocina === 'Lobby Bar' ? 'bg-purple-100 text-purple-700' :
                            p.cocina === 'Le Cafe' ? 'bg-amber-100 text-amber-700' :
                            p.cocina === 'La Locanda' ? 'bg-red-100 text-red-700' :
                            p.cocina === 'Banquetes' ? 'bg-pink-100 text-pink-700' :
                            p.cocina === 'La Fondue' ? 'bg-orange-100 text-orange-700' :
                            p.cocina === 'Deli Gourmet' ? 'bg-green-100 text-green-700' :
                            'bg-slate-100 text-slate-700'
                        }">
                            ${emojisAreas[p.cocina] || 'üè¢'} ${p.cocina}
                        </span>
                    </div>
                ` : ''}
                
                ${p.precioMenu > 0 ? `
                    <div class="grid grid-cols-2 gap-2 text-xs mb-4">
                        <div class="bg-blue-50 p-2 rounded-lg">
                            <p class="text-blue-600 font-semibold">Costo</p>
                            <p class="font-black text-blue-700">S/. ${p.costoReceta.toFixed(2)}</p>
                        </div>
                        <div class="bg-purple-50 p-2 rounded-lg">
                            <p class="text-purple-600 font-semibold">Precio</p>
                            <p class="font-black text-purple-700">S/. ${p.precioMenu.toFixed(2)}</p>
                        </div>
                        <div class="bg-emerald-50 p-2 rounded-lg">
                            <p class="text-emerald-600 font-semibold">${obtenerEtiquetaCosto(p.categoria)}</p>
                            <p class="font-black text-emerald-700">${p.fcPorcentaje.toFixed(2)}%</p>
                        </div>
                        <div class="bg-orange-50 p-2 rounded-lg">
                            <p class="text-orange-600 font-semibold">Ideal</p>
                            <p class="font-black text-orange-700">S/. ${p.precioIdeal.toFixed(2)}</p>
                        </div>
                    </div>
                ` : ''}
                
                <div class="flex flex-col gap-2">
                    <button onclick="exportarHojaCataPDF('${p.sku}')" 
                            class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-2 rounded-lg font-bold text-xs hover:shadow-lg btn-action flex items-center justify-center gap-1">
                        üìù HOJA DE CATA
                    </button>
                    
                    <button onclick="exportarFichaTecnicaPlato('${p.sku}')" 
                            class="w-full bg-emerald-100 text-emerald-600 py-2 rounded-lg font-bold text-xs hover:bg-emerald-200 btn-action flex items-center justify-center gap-1">
                        üìÑ FICHA T√âCNICA
                    </button>
                    
                    <div class="flex gap-2">
                        <button onclick="editPlato('${p.sku}')" 
                                class="flex-1 bg-blue-100 text-blue-600 py-2 rounded-lg font-bold text-xs hover:bg-blue-200 btn-action">
                            ‚úèÔ∏è EDITAR
                        </button>
                        <button onclick="deleteItem('platos','sku','${p.sku}',renderPlatos)" 
                                class="flex-1 bg-red-100 text-red-600 py-2 rounded-lg font-bold text-xs hover:bg-red-200 btn-action">
                            üóëÔ∏è BORRAR
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}
        function addPlatoToOrder() {
            const sku = document.getElementById('mrp-select').value;
            const qty = parseFloat(document.getElementById('mrp-qty').value);
            
            if(!sku) {
                alert("‚ö†Ô∏è Selecciona un plato");
                return;
            }
            
            if(isNaN(qty) || qty <= 0) {
                alert("‚ö†Ô∏è Ingresa una cantidad v√°lida");
                return;
            }
            
            const p = db.platos.find(x => x.sku === sku);
            mrpOrder.push({sku: p.sku, nombre: p.nombre, qty: qty});
            
            document.getElementById('mrp-select').value = '';
            document.getElementById('mrp-qty').value = '';
            
            renderMRPOrder();
        }

        function renderMRPOrder() {
            document.getElementById('mrp-order-list').innerHTML = mrpOrder.map((o, i) => `
                <div class="flex justify-between items-center text-xs font-bold p-3 bg-white border-2 border-purple-200 rounded-xl hover:bg-purple-50">
                    <div>
                        <p class="font-black">${o.nombre}</p>
                        <p class="text-slate-500 font-semibold">Cantidad: ${o.qty}</p>
                    </div>
                    <button onclick="mrpOrder.splice(${i},1);renderMRPOrder()" 
                            class="bg-red-100 text-red-600 px-3 py-2 rounded-lg font-bold hover:bg-red-200">
                        ‚ùå
                    </button>
                </div>
            `).join('');
        }

        function exportData() {
            // üîê VALIDACI√ìN DE CLAVE ADMIN
            solicitarClaveAdmin(function() {
                exportDataReal();
            }, 'üíæ EXPORTAR base de datos JSON requiere clave de administrador');
        }
        
        function exportDataReal() {
            // Crear copia de db SIN compras para evitar archivos muy grandes
            const dbParaExportar = { ...db };
            
            // Eliminar compras del export
            const cantidadCompras = db.compras ? db.compras.length : 0;
            if (cantidadCompras > 0) {
                delete dbParaExportar.compras;
                console.log('‚ö†Ô∏è Compras NO incluidas en exportaci√≥n (', cantidadCompras, 'registros)');
            }
            
            const dataStr = JSON.stringify(dbParaExportar, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GASTRO_CONTROL_PRO_BACKUP_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            const mensaje = cantidadCompras > 0 
                ? `‚úÖ Respaldo exportado correctamente\n\n‚ö†Ô∏è NOTA: Las ${cantidadCompras} compras NO se incluyeron.\nPara exportar compras usa el bot√≥n "EXPORTAR BACKUP JSON" en la secci√≥n de Compras.`
                : "‚úÖ Respaldo exportado correctamente";
            
            alert(mensaje);
        }
        
        function solicitarImportarJSON() {
            // üîê VALIDACI√ìN DE CLAVE ADMIN
            solicitarClaveAdmin(function() {
                // Si la clave es correcta, abrir el file input
                document.getElementById('importFile').click();
            }, 'üì• IMPORTAR base de datos JSON requiere clave de administrador');
        }

        function importData(file) {
            console.log('üì• Iniciando importaci√≥n de archivo:', file.name);
            
            if (!file) {
                alert('‚ö†Ô∏è No se seleccion√≥ ning√∫n archivo');
                return;
            }
            
            if (!file.name.endsWith('.json')) {
                alert('‚ùå El archivo debe ser un JSON (.json)');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    console.log('üìñ Leyendo contenido del archivo...');
                    const contenido = e.target.result;
                    const datosImportados = JSON.parse(contenido);
                    
                    console.log('‚úÖ JSON parseado correctamente');
                    console.log('üìä Datos importados:', datosImportados);
                    
                    // Verificar que tenga la estructura b√°sica
                    if (typeof datosImportados !== 'object') {
                        throw new Error('El archivo no contiene un objeto JSON v√°lido');
                    }
                    
                    // Confirmar antes de sobrescribir
                    if (confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto sobrescribir√° TODOS los datos actuales.\n\n‚úÖ Se importar√°n:\n‚Ä¢ Materiales\n‚Ä¢ Recetas\n‚Ä¢ Platos\n‚Ä¢ Inventario\n‚Ä¢ Proveedores\n‚Ä¢ Usuarios\n‚Ä¢ Ventas\n‚Ä¢ Finanzas\n‚Ä¢ Y todo lo dem√°s\n\n‚ö†Ô∏è NOTA: Las compras NO se importar√°n (usar importaci√≥n Excel)')) {
                        
                        // Sobrescribir db completo
                        Object.keys(datosImportados).forEach(function(key) {
                            db[key] = datosImportados[key];
                        });
                        
                        // IMPORTANTE: Eliminar compras antes de guardar (evita QuotaExceededError)
                        if (db.compras && db.compras.length > 100) {
                            console.log('‚ö†Ô∏è Compras detectadas en importaci√≥n (', db.compras.length, 'registros). NO se guardar√°n en localStorage.');
                            delete db.compras;
                        }
                        
                        // Guardar en localStorage
                        try {
                            save();
                            console.log('üíæ Datos guardados en localStorage');
                        } catch (saveError) {
                            console.error('‚ùå Error al guardar en localStorage:', saveError);
                            alert('‚ö†Ô∏è ADVERTENCIA: Los datos se importaron en memoria pero NO se pudieron guardar en localStorage.\n\n' +
                                  'Esto puede ser porque:\n' +
                                  '‚Ä¢ El archivo es demasiado grande\n' +
                                  '‚Ä¢ Incluye muchas compras (usar m√≥dulo de Compras)\n\n' +
                                  'Los datos estar√°n disponibles durante esta sesi√≥n.\n' +
                                  'Considera exportar/importar m√≥dulos por separado.');
                        }
                        
                        alert('‚úÖ Importaci√≥n exitosa!\n\n' + 
                              'üì¶ Datos importados correctamente.\n' +
                              'La p√°gina se recargar√° para aplicar los cambios.');
                        
                        // Recargar la p√°gina para reflejar los cambios
                        setTimeout(function() {
                            location.reload();
                        }, 500);
                    } else {
                        console.log('‚ùå Importaci√≥n cancelada por el usuario');
                        alert('‚ùå Importaci√≥n cancelada');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error al importar:', error);
                    alert('‚ùå Error al importar el archivo:\n\n' + error.message + '\n\nVerifica que sea un archivo JSON v√°lido exportado desde GASTRO CONTROL PRO.');
                }
            };
            
            reader.onerror = function() {
                console.error('‚ùå Error al leer el archivo');
                alert('‚ùå Error al leer el archivo');
            };
            
            reader.readAsText(file);
        }

        // Event listener para el input de importar
        document.addEventListener('DOMContentLoaded', function() {
            const importFileInput = document.getElementById('importFile');
            if (importFileInput) {
                importFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        importData(file);
                        // Limpiar el input para poder seleccionar el mismo archivo nuevamente
                        e.target.value = '';
                    }
                });
                console.log('‚úÖ Event listener de importaci√≥n registrado');
            }
        });

        function renderHistorial() {
            const historialContainer = document.getElementById('historial-list');
            
            if(!db.historialProduccion || db.historialProduccion.length === 0) {
                historialContainer.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <p class="text-sm font-semibold">No hay historial a√∫n</p>
                    </div>
                `;
                return;
            }
            
            historialContainer.innerHTML = db.historialProduccion.map((h, idx) => `
                <div class="bg-white border-2 border-slate-200 rounded-xl p-3 hover:shadow-md transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="text-xs font-black text-slate-700">${h.fecha}</p>
                            <p class="text-xs font-bold text-purple-600 mt-1">üë• ${h.totalPax} PAX</p>
                        </div>
                        <span class="badge bg-emerald-100 text-emerald-700 text-xs">S/. ${h.costoTotal}</span>
                    </div>
                    <div class="border-t border-slate-200 pt-2 mt-2">
                        <p class="text-[10px] font-bold text-slate-600 mb-1">PLATOS:</p>
                        ${h.platos.map(p => `
                            <p class="text-xs text-slate-600">‚Ä¢ ${p.nombre} <span class="font-bold text-blue-600">x${p.qty}</span></p>
                        `).join('')}
                    </div>
                    ${h.materiales && h.materiales.length > 0 ? `
                        <button onclick="toggleMateriales(${idx})" class="w-full mt-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-1.5 rounded-lg text-[10px] font-bold hover:from-blue-700 hover:to-indigo-700 btn-action">
                            <span id="btn-text-${idx}">üëÅÔ∏è VER MATERIALES SOLICITADOS</span>
                        </button>
                        <div id="materiales-${idx}" class="hidden mt-2 bg-slate-50 rounded-lg p-2 border border-slate-200">
                            <p class="text-[10px] font-bold text-slate-700 mb-2">üì¶ MATERIALES COMPRADOS:</p>
                            <div class="space-y-1 max-h-40 overflow-y-auto">
                                ${h.materiales.map(m => `
                                    <div class="flex justify-between text-[10px] bg-white p-2 rounded border border-slate-200">
                                        <span class="font-semibold text-slate-700">${m.nombre}</span>
                                        <div class="flex gap-2 items-center">
                                            <span class="text-blue-600 font-bold">${m.faltante} ${m.unid}</span>
                                            <span class="text-emerald-600 font-bold">S/. ${m.subtotal}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function toggleMateriales(idx) {
            const materialesDiv = document.getElementById(`materiales-${idx}`);
            const btnText = document.getElementById(`btn-text-${idx}`);
            
            if(materialesDiv.classList.contains('hidden')) {
                materialesDiv.classList.remove('hidden');
                btnText.textContent = 'üôà OCULTAR MATERIALES';
            } else {
                materialesDiv.classList.add('hidden');
                btnText.textContent = 'üëÅÔ∏è VER MATERIALES SOLICITADOS';
            }
        }

        // ========== PLANIFICACI√ìN SEMANAL ==========
        const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

        function renderPlanSemanal() {
            // Renderizar Semana 1
            document.getElementById('semana1-dias').innerHTML = diasSemana.map((dia, idx) => {
                const key = `s1-d${idx}`;
                const platos = db.planSemanal[key] || [];
                return renderDiaCard(dia, key, platos, 'blue');
            }).join('');

            // Renderizar Semana 2
            document.getElementById('semana2-dias').innerHTML = diasSemana.map((dia, idx) => {
                const key = `s2-d${idx}`;
                const platos = db.planSemanal[key] || [];
                return renderDiaCard(dia, key, platos, 'purple');
            }).join('');
            
            // Cargar fechas guardadas
            cargarFechasSemanas();
        }
        
        // ========== SISTEMA DE FECHAS PARA MEN√ö DEL D√çA ==========
        
        function guardarFechasSemanas() {
            const fechaS1 = document.getElementById('fecha-inicio-s1').value;
            const fechaS2 = document.getElementById('fecha-inicio-s2').value;
            
            // Actualizar fecha m√≠nima permitida para Semana 2
            if (fechaS1) {
                const date1 = new Date(fechaS1 + 'T00:00:00');
                const minFechaS2 = new Date(date1);
                minFechaS2.setDate(minFechaS2.getDate() + 7); // M√≠nimo 7 d√≠as despu√©s
                
                const inputS2 = document.getElementById('fecha-inicio-s2');
                inputS2.min = minFechaS2.toISOString().split('T')[0];
            }
            
            // Validar solapamiento de fechas
            if (fechaS1 && fechaS2) {
                const date1 = new Date(fechaS1 + 'T00:00:00');
                const date2 = new Date(fechaS2 + 'T00:00:00');
                
                // Calcular fin de semana 1 (6 d√≠as despu√©s)
                const finSemana1 = new Date(date1);
                finSemana1.setDate(finSemana1.getDate() + 6);
                
                // Validar que Semana 2 no inicie antes o durante Semana 1
                if (date2 <= finSemana1) {
                    alert("‚ö†Ô∏è FECHAS INV√ÅLIDAS\n\nLa Semana 2 no puede iniciar antes de que termine la Semana 1.\n\n" +
                          "Semana 1: " + date1.toLocaleDateString('es-PE') + " al " + finSemana1.toLocaleDateString('es-PE') + "\n" +
                          "Semana 2 debe iniciar despu√©s del: " + finSemana1.toLocaleDateString('es-PE'));
                    
                    // Limpiar fecha inv√°lida de Semana 2
                    document.getElementById('fecha-inicio-s2').value = '';
                    return;
                }
                
                // Advertir si no son consecutivas (hay gap)
                const deberiaIniciar = new Date(date1);
                deberiaIniciar.setDate(deberiaIniciar.getDate() + 7);
                
                if (date2.getTime() !== deberiaIniciar.getTime()) {
                    const diasDiferencia = Math.floor((date2 - finSemana1) / (1000 * 60 * 60 * 24));
                    if (diasDiferencia > 1) {
                        const confirmar = confirm("‚ö†Ô∏è HAY UN ESPACIO ENTRE SEMANAS\n\n" +
                            "Semana 1 termina el: " + finSemana1.toLocaleDateString('es-PE') + "\n" +
                            "Semana 2 inicia el: " + date2.toLocaleDateString('es-PE') + "\n" +
                            "Hay " + diasDiferencia + " d√≠a(s) sin programaci√≥n.\n\n" +
                            "¬øDeseas continuar de todos modos?");
                        
                        if (!confirmar) {
                            // Sugerir fecha consecutiva
                            const fechaSugerida = deberiaIniciar.toISOString().split('T')[0];
                            document.getElementById('fecha-inicio-s2').value = fechaSugerida;
                            return;
                        }
                    }
                }
            }
            
            // Validar que sean lunes (opcional pero recomendado)
            if (fechaS1) {
                const date1 = new Date(fechaS1 + 'T00:00:00');
                if (date1.getDay() !== 1) { // 1 = Lunes
                    const confirmar = confirm("‚ö†Ô∏è ADVERTENCIA: La fecha seleccionada para Semana 1 no es Lunes.\n\n" +
                        "Fecha seleccionada: " + date1.toLocaleDateString('es-PE', {weekday: 'long'}) + "\n\n" +
                        "Se recomienda iniciar las semanas en Lunes.\n¬øContinuar de todos modos?");
                    
                    if (!confirmar) {
                        document.getElementById('fecha-inicio-s1').value = '';
                        return;
                    }
                }
            }
            
            if (fechaS2) {
                const date2 = new Date(fechaS2 + 'T00:00:00');
                if (date2.getDay() !== 1) { // 1 = Lunes
                    const confirmar = confirm("‚ö†Ô∏è ADVERTENCIA: La fecha seleccionada para Semana 2 no es Lunes.\n\n" +
                        "Fecha seleccionada: " + date2.toLocaleDateString('es-PE', {weekday: 'long'}) + "\n\n" +
                        "Se recomienda iniciar las semanas en Lunes.\n¬øContinuar de todos modos?");
                    
                    if (!confirmar) {
                        document.getElementById('fecha-inicio-s2').value = '';
                        return;
                    }
                }
            }
            
            if (!db.fechasSemanas) db.fechasSemanas = {};
            db.fechasSemanas.s1 = fechaS1 || null;
            db.fechasSemanas.s2 = fechaS2 || null;
            
            save();
            actualizarInfoSemanas();
            
            console.log('üìÖ Fechas de semanas actualizadas:', db.fechasSemanas);
        }
        
        function cargarFechasSemanas() {
            if (!db.fechasSemanas) db.fechasSemanas = { s1: null, s2: null };
            
            const inputS1 = document.getElementById('fecha-inicio-s1');
            const inputS2 = document.getElementById('fecha-inicio-s2');
            
            if (inputS1 && db.fechasSemanas.s1) {
                inputS1.value = db.fechasSemanas.s1;
                
                // Establecer fecha m√≠nima para Semana 2
                const date1 = new Date(db.fechasSemanas.s1 + 'T00:00:00');
                const minFechaS2 = new Date(date1);
                minFechaS2.setDate(minFechaS2.getDate() + 7);
                
                if (inputS2) {
                    inputS2.min = minFechaS2.toISOString().split('T')[0];
                }
            }
            
            if (inputS2 && db.fechasSemanas.s2) {
                inputS2.value = db.fechasSemanas.s2;
            }
            
            actualizarInfoSemanas();
        }
        
        function actualizarInfoSemanas() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            // Actualizar info Semana 1
            const infoS1 = document.getElementById('info-semana1');
            if (infoS1 && db.fechasSemanas.s1) {
                const fechaS1 = new Date(db.fechasSemanas.s1 + 'T00:00:00');
                const fechaFinS1 = new Date(fechaS1);
                fechaFinS1.setDate(fechaFinS1.getDate() + 6);
                
                const esSemanaActiva = hoy >= fechaS1 && hoy <= fechaFinS1;
                const esPasada = hoy > fechaFinS1;
                
                let badge = '';
                if (esSemanaActiva) {
                    badge = ' <span class="bg-green-500 text-white px-2 py-1 rounded text-xs ml-2">‚úÖ ACTIVA HOY</span>';
                } else if (esPasada) {
                    badge = ' <span class="bg-gray-400 text-white px-2 py-1 rounded text-xs ml-2">‚è≥ PASADA</span>';
                } else {
                    badge = ' <span class="bg-blue-400 text-white px-2 py-1 rounded text-xs ml-2">üìÖ FUTURA</span>';
                }
                
                infoS1.innerHTML = `${fechaS1.toLocaleDateString('es-PE')} al ${fechaFinS1.toLocaleDateString('es-PE')}${badge}`;
            } else if (infoS1) {
                infoS1.innerHTML = '‚ö†Ô∏è Sin fecha configurada';
            }
            
            // Actualizar info Semana 2
            const infoS2 = document.getElementById('info-semana2');
            if (infoS2 && db.fechasSemanas.s2) {
                const fechaS2 = new Date(db.fechasSemanas.s2 + 'T00:00:00');
                const fechaFinS2 = new Date(fechaS2);
                fechaFinS2.setDate(fechaFinS2.getDate() + 6);
                
                const esSemanaActiva = hoy >= fechaS2 && hoy <= fechaFinS2;
                const esPasada = hoy > fechaFinS2;
                
                let badge = '';
                if (esSemanaActiva) {
                    badge = ' <span class="bg-green-500 text-white px-2 py-1 rounded text-xs ml-2">‚úÖ ACTIVA HOY</span>';
                } else if (esPasada) {
                    badge = ' <span class="bg-gray-400 text-white px-2 py-1 rounded text-xs ml-2">‚è≥ PASADA</span>';
                } else {
                    badge = ' <span class="bg-blue-400 text-white px-2 py-1 rounded text-xs ml-2">üìÖ FUTURA</span>';
                }
                
                // Verificar solapamiento visual
                if (db.fechasSemanas.s1) {
                    const fechaS1 = new Date(db.fechasSemanas.s1 + 'T00:00:00');
                    const fechaFinS1 = new Date(fechaS1);
                    fechaFinS1.setDate(fechaFinS1.getDate() + 6);
                    
                    if (fechaS2 <= fechaFinS1) {
                        badge = ' <span class="bg-red-500 text-white px-2 py-1 rounded text-xs ml-2">‚ùå SOLAPAMIENTO</span>';
                    }
                }
                
                infoS2.innerHTML = `${fechaS2.toLocaleDateString('es-PE')} al ${fechaFinS2.toLocaleDateString('es-PE')}${badge}`;
            } else if (infoS2) {
                infoS2.innerHTML = '‚ö†Ô∏è Sin fecha configurada';
            }
        }
        
        // Funci√≥n para obtener los platos de MEN√ö programados para HOY
        function obtenerMenusDelDiaActual() {
            if (!db.fechasSemanas) return [];
            
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const diaSemanaHoy = hoy.getDay(); // 0=Domingo, 1=Lunes, etc
            
            // Mapear d√≠a de la semana a √≠ndice (Lunes=0, Martes=1, etc)
            const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            const indiceMap = {
                1: 0, // Lunes
                2: 1, // Martes
                3: 2, // Mi√©rcoles
                4: 3, // Jueves
                5: 4, // Viernes
                6: 5, // S√°bado
                0: 6  // Domingo
            };
            const diaIndex = indiceMap[diaSemanaHoy];
            
            // Verificar Semana 1
            if (db.fechasSemanas.s1) {
                const fechaS1 = new Date(db.fechasSemanas.s1 + 'T00:00:00');
                const fechaFinS1 = new Date(fechaS1);
                fechaFinS1.setDate(fechaFinS1.getDate() + 6);
                
                if (hoy >= fechaS1 && hoy <= fechaFinS1) {
                    const key = `s1-d${diaIndex}`;
                    const platosDelDia = db.planSemanal[key] || [];
                    return platosDelDia.filter(p => p.tipo === 'MENU');
                }
            }
            
            // Verificar Semana 2
            if (db.fechasSemanas.s2) {
                const fechaS2 = new Date(db.fechasSemanas.s2 + 'T00:00:00');
                const fechaFinS2 = new Date(fechaS2);
                fechaFinS2.setDate(fechaFinS2.getDate() + 6);
                
                if (hoy >= fechaS2 && hoy <= fechaFinS2) {
                    const key = `s2-d${diaIndex}`;
                    const platosDelDia = db.planSemanal[key] || [];
                    return platosDelDia.filter(p => p.tipo === 'MENU');
                }
            }
            
            // No hay semana activa para hoy
            return [];
        }

        function renderDiaCard(dia, key, platos, color) {
            const totalPax = platos.reduce((sum, p) => sum + p.qty, 0);
            const colorClass = color === 'blue' ? 'border-blue-300 bg-blue-50' : 'border-purple-300 bg-purple-50';
            const badgeColor = color === 'blue' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700';
            
            return `
                <div class="bg-white rounded-xl p-4 border-2 ${colorClass}">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-black text-sm">${dia}</h4>
                        <span class="badge ${badgeColor} text-xs">${totalPax} PAX</span>
                    </div>
                    
                    <div class="space-y-2 mb-3 max-h-32 overflow-y-auto">
                        ${platos.map((p, i) => {
                            const icon = p.tipo === 'MENU' ? 'üìã' : 'üçΩÔ∏è';
                            const bgColor = p.tipo === 'MENU' ? 'bg-pink-50' : 'bg-slate-50';
                            return `
                            <div class="flex justify-between items-center text-xs ${bgColor} p-2 rounded">
                                <span class="font-semibold">${icon} ${p.nombre}</span>
                                <div class="flex gap-2 items-center">
                                    <span class="font-bold text-blue-600">x${p.qty}</span>
                                    <button onclick="eliminarPlatoDia('${key}', ${i})" class="text-red-500 font-bold">√ó</button>
                                </div>
                            </div>
                        `;}).join('')}
                        ${platos.length === 0 ? '<p class="text-xs text-slate-400 italic">Sin platos programados</p>' : ''}
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="abrirModalAgregarPlato('${key}', '${dia}')" class="flex-1 bg-gradient-to-r from-${color}-500 to-${color}-600 text-white py-2 rounded-lg text-xs font-bold hover:from-${color}-600 hover:to-${color}-700 btn-action">
                            ‚ûï AGREGAR
                        </button>
                        ${platos.length > 0 ? `
                        <button onclick="abrirModalEditarDia('${key}', '${dia}')" class="flex-1 bg-gradient-to-r from-orange-500 to-amber-600 text-white py-2 rounded-lg text-xs font-bold hover:from-orange-600 hover:to-amber-700 btn-action">
                            ‚úèÔ∏è EDITAR
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function abrirModalAgregarPlato(key, dia) {
            // Categor√≠as excluidas de la programaci√≥n semanal
            const categoriasExcluidas = ['VINOS', 'LICORES', 'BEBIDAS', 'BEBIDAS FR√çAS', 'BEBIDAS CALIENTES', 'GUARNICIONES'];
            
            // Filtrar platos excluyendo bebidas, vinos, licores y guarniciones
            const platosCarta = db.platos.filter(p => {
                const esCarta = p.tipoCarta === 'CARTA' || !p.tipoCarta;
                const categoriaPermitida = !categoriasExcluidas.includes(p.categoria);
                return esCarta && categoriaPermitida;
            });
            
            const platosMenu = db.platos.filter(p => {
                const esMenu = p.tipoCarta === 'MENU';
                const categoriaPermitida = !categoriasExcluidas.includes(p.categoria);
                return esMenu && categoriaPermitida;
            });
            
            const html = `
                <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;" id="modal-plato" onclick="if(event.target.id==='modal-plato')cerrarModal()">
                    <div style="background: white; padding: 24px; border-radius: 16px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h3 style="font-weight: 800; font-size: 20px; margin-bottom: 8px; text-align: center;">Agregar Platos - ${dia}</h3>
                        <p style="text-align: center; color: #64748b; font-size: 13px; margin-bottom: 20px;">Selecciona platos de carta y/o men√∫ del d√≠a</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <!-- COLUMNA PLATOS DE CARTA -->
                            <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 16px; border-radius: 12px; border: 2px solid #60a5fa;">
                                <h4 style="font-weight: 700; font-size: 14px; margin-bottom: 12px; color: #1e40af; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 18px;">üçΩÔ∏è</span>
                                    PLATOS DE CARTA
                                </h4>
                                <div id="lista-platos-carta" style="max-height: 300px; overflow-y: auto; margin-bottom: 12px;">
                                    ${platosCarta.length === 0 ? '<p style="color: #64748b; font-size: 12px; text-align: center; padding: 20px;">No hay platos de carta</p>' : 
                                    platosCarta.map(p => `
                                        <div style="background: white; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0;">
                                            <div style="display: flex; justify-between; align-items: center; margin-bottom: 6px;">
                                                <label style="font-size: 12px; font-weight: 600; color: #1e293b; cursor: pointer; flex: 1; display: flex; align-items: center; gap: 6px;">
                                                    <input type="checkbox" value="${p.sku}" class="check-carta" style="width: 16px; height: 16px; cursor: pointer;" onchange="toggleCantidadInput(this, 'carta-${p.sku}')">
                                                    ${p.nombre.replace('PM ', '')}
                                                </label>
                                            </div>
                                            <input type="number" id="carta-${p.sku}" placeholder="Cantidad" min="1" disabled style="width: 100%; padding: 6px; border: 2px solid #e2e8f0; border-radius: 6px; font-weight: 600; font-size: 12px; background: #f8fafc;">
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- COLUMNA MEN√ö DEL D√çA -->
                            <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 16px; border-radius: 12px; border: 2px solid #ec4899;">
                                <h4 style="font-weight: 700; font-size: 14px; margin-bottom: 12px; color: #be185d; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 18px;">üìã</span>
                                    MEN√ö DEL D√çA
                                </h4>
                                <div id="lista-menu-dia" style="max-height: 300px; overflow-y: auto; margin-bottom: 12px;">
                                    ${platosMenu.length === 0 ? '<p style="color: #64748b; font-size: 12px; text-align: center; padding: 20px;">No hay platos de men√∫</p>' : 
                                    platosMenu.map(p => `
                                        <div style="background: white; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0;">
                                            <div style="display: flex; justify-between; align-items: center; margin-bottom: 6px;">
                                                <label style="font-size: 12px; font-weight: 600; color: #1e293b; cursor: pointer; flex: 1; display: flex; align-items: center; gap: 6px;">
                                                    <input type="checkbox" value="${p.sku}" class="check-menu" style="width: 16px; height: 16px; cursor: pointer;" onchange="toggleCantidadInput(this, 'menu-${p.sku}')">
                                                    ${p.nombre.replace('PM ', '')}
                                                </label>
                                            </div>
                                            <input type="number" id="menu-${p.sku}" placeholder="Cantidad" min="1" disabled style="width: 100%; padding: 6px; border: 2px solid #e2e8f0; border-radius: 6px; font-weight: 600; font-size: 12px; background: #f8fafc;">
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <button onclick="agregarPlatosAlDia('${key}')" style="flex: 1; background: linear-gradient(to right, #3b82f6, #6366f1); color: white; padding: 14px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; font-size: 14px;">
                                ‚úÖ AGREGAR SELECCIONADOS
                            </button>
                            <button onclick="cerrarModal()" style="padding: 14px 32px; background: #e2e8f0; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; font-size: 14px;">
                                ‚ùå CANCELAR
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function toggleCantidadInput(checkbox, inputId) {
            const input = document.getElementById(inputId);
            if (checkbox.checked) {
                input.disabled = false;
                input.focus();
                input.value = 1; // Valor por defecto
                input.style.background = 'white';
            } else {
                input.disabled = true;
                input.value = '';
                input.style.background = '#f8fafc';
            }
        }
        
        // Nueva funci√≥n para abrir modal de edici√≥n completo
        function abrirModalEditarDia(key, dia) {
            // Guardar en variables globales para eliminarPlatoEdicion
            window.diaEditandoKey = key;
            window.diaEditandoNombre = dia;
            
            const platosActuales = db.planSemanal[key] || [];
            
            // Categor√≠as excluidas de la programaci√≥n semanal
            const categoriasExcluidas = ['VINOS', 'LICORES', 'BEBIDAS', 'BEBIDAS FR√çAS', 'BEBIDAS CALIENTES', 'GUARNICIONES'];
            
            // Filtrar platos excluyendo bebidas, vinos, licores y guarniciones
            const platosCarta = db.platos.filter(p => {
                const esCarta = p.tipoCarta === 'CARTA' || !p.tipoCarta;
                const categoriaPermitida = !categoriasExcluidas.includes(p.categoria);
                return esCarta && categoriaPermitida;
            });
            
            const platosMenu = db.platos.filter(p => {
                const esMenu = p.tipoCarta === 'MENU';
                const categoriaPermitida = !categoriasExcluidas.includes(p.categoria);
                return esMenu && categoriaPermitida;
            });
            
            // Filtrar platos que no est√°n ya agregados
            const skusActuales = platosActuales.map(p => p.sku);
            const platosCartaDisponibles = platosCarta.filter(p => !skusActuales.includes(p.sku));
            const platosMenuDisponibles = platosMenu.filter(p => !skusActuales.includes(p.sku));
            
            const html = `
                <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;" id="modal-editar-dia" onclick="if(event.target.id==='modal-editar-dia')cerrarModalEdicion()">
                    <div style="background: white; padding: 24px; border-radius: 16px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="font-weight: 800; font-size: 22px; color: white; text-align: center; margin: 0;">‚úèÔ∏è EDITAR PROGRAMACI√ìN - ${dia}</h3>
                        </div>
                        
                        <!-- PLATOS YA PROGRAMADOS -->
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #fbbf24;">
                            <h4 style="font-weight: 700; font-size: 16px; margin-bottom: 12px; color: #92400e; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">üìù</span>
                                PLATOS PROGRAMADOS (Editar Cantidades)
                            </h4>
                            <div id="lista-platos-programados">
                                ${platosActuales.length === 0 ? '<p style="color: #64748b; font-size: 12px; text-align: center; padding: 20px;">No hay platos programados</p>' : 
                                platosActuales.map((p, idx) => {
                                    const icon = p.tipo === 'MENU' ? 'üìã' : 'üçΩÔ∏è';
                                    const bgColor = p.tipo === 'MENU' ? 'linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%)' : 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)';
                                    return `
                                    <div style="background: ${bgColor}; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 2px solid ${p.tipo === 'MENU' ? '#ec4899' : '#60a5fa'};">
                                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                                            <div style="flex: 1;">
                                                <p style="font-size: 14px; font-weight: 700; color: #1e293b; margin: 0;">${icon} ${p.nombre}</p>
                                                <p style="font-size: 11px; color: #64748b; margin: 2px 0 0 0;">${p.tipo === 'MENU' ? 'Men√∫ del D√≠a' : 'Plato de Carta'}</p>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="number" id="edit-qty-${idx}" value="${p.qty}" min="1" style="width: 80px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; font-weight: 700; font-size: 14px; text-align: center;">
                                                <button onclick="eliminarPlatoEdicion(${idx})" style="background: #ef4444; color: white; padding: 8px 12px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; font-size: 14px;">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                        
                        <!-- AGREGAR M√ÅS PLATOS -->
                        <div style="margin-bottom: 20px;">
                            <h4 style="font-weight: 700; font-size: 16px; margin-bottom: 12px; color: #1e40af; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">‚ûï</span>
                                AGREGAR M√ÅS PLATOS
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <!-- COLUMNA PLATOS DE CARTA -->
                                <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 16px; border-radius: 12px; border: 2px solid #60a5fa;">
                                    <h5 style="font-weight: 700; font-size: 13px; margin-bottom: 12px; color: #1e40af; display: flex; align-items: center; gap: 6px;">
                                        <span style="font-size: 16px;">üçΩÔ∏è</span>
                                        CARTA
                                    </h5>
                                    <div style="max-height: 250px; overflow-y: auto;">
                                        ${platosCartaDisponibles.length === 0 ? '<p style="color: #64748b; font-size: 11px; text-align: center; padding: 15px;">Todos los platos de carta ya est√°n agregados</p>' : 
                                        platosCartaDisponibles.map(p => `
                                            <div style="background: white; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0;">
                                                <div style="display: flex; justify-between; align-items: center; margin-bottom: 6px;">
                                                    <label style="font-size: 11px; font-weight: 600; color: #1e293b; cursor: pointer; flex: 1; display: flex; align-items: center; gap: 6px;">
                                                        <input type="checkbox" value="${p.sku}" class="check-carta-edit" style="width: 14px; height: 14px; cursor: pointer;" onchange="toggleCantidadInput(this, 'carta-edit-${p.sku}')">
                                                        ${p.nombre.replace('PM ', '')}
                                                    </label>
                                                </div>
                                                <input type="number" id="carta-edit-${p.sku}" placeholder="Cantidad" min="1" disabled style="width: 100%; padding: 6px; border: 2px solid #e2e8f0; border-radius: 6px; font-weight: 600; font-size: 11px; background: #f8fafc;">
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- COLUMNA MEN√ö DEL D√çA -->
                                <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 16px; border-radius: 12px; border: 2px solid #ec4899;">
                                    <h5 style="font-weight: 700; font-size: 13px; margin-bottom: 12px; color: #be185d; display: flex; align-items: center; gap: 6px;">
                                        <span style="font-size: 16px;">üìã</span>
                                        MEN√ö
                                    </h5>
                                    <div style="max-height: 250px; overflow-y: auto;">
                                        ${platosMenuDisponibles.length === 0 ? '<p style="color: #64748b; font-size: 11px; text-align: center; padding: 15px;">Todos los platos de men√∫ ya est√°n agregados</p>' : 
                                        platosMenuDisponibles.map(p => `
                                            <div style="background: white; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0;">
                                                <div style="display: flex; justify-between; align-items: center; margin-bottom: 6px;">
                                                    <label style="font-size: 11px; font-weight: 600; color: #1e293b; cursor: pointer; flex: 1; display: flex; align-items: center; gap: 6px;">
                                                        <input type="checkbox" value="${p.sku}" class="check-menu-edit" style="width: 14px; height: 14px; cursor: pointer;" onchange="toggleCantidadInput(this, 'menu-edit-${p.sku}')">
                                                        ${p.nombre.replace('PM ', '')}
                                                    </label>
                                                </div>
                                                <input type="number" id="menu-edit-${p.sku}" placeholder="Cantidad" min="1" disabled style="width: 100%; padding: 6px; border: 2px solid #e2e8f0; border-radius: 6px; font-weight: 600; font-size: 11px; background: #f8fafc;">
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <button onclick="guardarEdicionDia('${key}')" style="flex: 1; background: linear-gradient(to right, #059669, #10b981); color: white; padding: 14px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; font-size: 15px;">
                                ‚úÖ GUARDAR CAMBIOS
                            </button>
                            <button onclick="cerrarModalEdicion()" style="padding: 14px 32px; background: #e2e8f0; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; font-size: 15px;">
                                ‚ùå CANCELAR
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            
            // Guardar platos actuales en variable temporal para la edici√≥n
            window.platosEditandoTemp = JSON.parse(JSON.stringify(platosActuales));
        }
        
        function eliminarPlatoEdicion(idx) {
            if(confirm('¬øEliminar este plato de la programaci√≥n?')) {
                window.platosEditandoTemp.splice(idx, 1);
                
                // Guardar temporalmente los cambios
                const platosActualesBackup = db.planSemanal[window.diaEditandoKey];
                db.planSemanal[window.diaEditandoKey] = window.platosEditandoTemp;
                
                // Re-renderizar el modal
                cerrarModalEdicion();
                abrirModalEditarDia(window.diaEditandoKey, window.diaEditandoNombre);
                
                // Restaurar estado temporal
                window.platosEditandoTemp = db.planSemanal[window.diaEditandoKey];
                db.planSemanal[window.diaEditandoKey] = platosActualesBackup;
            }
        }
        
        function cerrarModalEdicion() {
            const modal = document.getElementById('modal-editar-dia');
            if(modal) modal.remove();
            window.platosEditandoTemp = null;
        }
        
        function guardarEdicionDia(key) {
            // Actualizar cantidades de platos existentes
            window.platosEditandoTemp.forEach((p, idx) => {
                const input = document.getElementById(`edit-qty-${idx}`);
                if(input) {
                    const nuevaCantidad = parseInt(input.value);
                    if(!isNaN(nuevaCantidad) && nuevaCantidad > 0) {
                        p.qty = nuevaCantidad;
                    }
                }
            });
            
            // Agregar nuevos platos seleccionados de carta
            const checksCarta = document.querySelectorAll('.check-carta-edit:checked');
            checksCarta.forEach(check => {
                const sku = check.value;
                const qty = parseInt(document.getElementById(`carta-edit-${sku}`).value);
                
                if(!isNaN(qty) && qty > 0) {
                    const platoObj = db.platos.find(p => p.sku === sku);
                    window.platosEditandoTemp.push({
                        sku: platoObj.sku,
                        nombre: platoObj.nombre,
                        qty: qty,
                        tipo: 'CARTA'
                    });
                }
            });
            
            // Agregar nuevos platos seleccionados de men√∫
            const checksMenu = document.querySelectorAll('.check-menu-edit:checked');
            checksMenu.forEach(check => {
                const sku = check.value;
                const qty = parseInt(document.getElementById(`menu-edit-${sku}`).value);
                
                if(!isNaN(qty) && qty > 0) {
                    const platoObj = db.platos.find(p => p.sku === sku);
                    window.platosEditandoTemp.push({
                        sku: platoObj.sku,
                        nombre: platoObj.nombre,
                        qty: qty,
                        tipo: 'MENU'
                    });
                }
            });
            
            // Guardar en la base de datos
            db.planSemanal[key] = window.platosEditandoTemp;
            save();
            renderPlanSemanal();
            cerrarModalEdicion();
            alert('‚úÖ Cambios guardados correctamente');
        }

        function cerrarModal() {
            const modal = document.getElementById('modal-plato');
            if(modal) modal.remove();
        }

        function agregarPlatosAlDia(key) {
            const checksCarta = document.querySelectorAll('.check-carta:checked');
            const checksMenu = document.querySelectorAll('.check-menu:checked');
            
            let platosAgregados = 0;
            
            // Procesar platos de carta
            checksCarta.forEach(check => {
                const sku = check.value;
                const qty = parseInt(document.getElementById(`carta-${sku}`).value);
                
                if(!isNaN(qty) && qty > 0) {
                    const platoObj = db.platos.find(p => p.sku === sku);
                    if(!db.planSemanal[key]) db.planSemanal[key] = [];
                    db.planSemanal[key].push({
                        sku: platoObj.sku,
                        nombre: platoObj.nombre,
                        qty: qty,
                        tipo: 'CARTA'
                    });
                    platosAgregados++;
                }
            });
            
            // Procesar platos de men√∫
            checksMenu.forEach(check => {
                const sku = check.value;
                const qty = parseInt(document.getElementById(`menu-${sku}`).value);
                
                if(!isNaN(qty) && qty > 0) {
                    const platoObj = db.platos.find(p => p.sku === sku);
                    if(!db.planSemanal[key]) db.planSemanal[key] = [];
                    db.planSemanal[key].push({
                        sku: platoObj.sku,
                        nombre: platoObj.nombre,
                        qty: qty,
                        tipo: 'MENU'
                    });
                    platosAgregados++;
                }
            });
            
            if(platosAgregados === 0) {
                alert('‚ö†Ô∏è Selecciona al menos un plato e ingresa su cantidad');
                return;
            }
            
            save();
            renderPlanSemanal();
            cerrarModal();
            alert(`‚úÖ ${platosAgregados} plato(s) agregado(s) correctamente`);
        }

        function eliminarPlatoDia(key, index) {
            if(confirm('¬øEliminar este plato?')) {
                db.planSemanal[key].splice(index, 1);
                save();
                renderPlanSemanal();
            }
        }

        function calcularExplosionSemanal() {
    // ‚úÖ VALIDACI√ìN: Verificar si hay platos programados
    let hayPlatos = false;
    let totalDiasConPlatos = 0;
    let totalPlatosAgregados = 0;
    
    Object.keys(db.planSemanal).forEach(key => {
        const platos = db.planSemanal[key];
        if(platos && platos.length > 0) {
            hayPlatos = true;
            totalDiasConPlatos++;
            totalPlatosAgregados += platos.length;
        }
    });
    
    // Si no hay platos, mostrar mensaje y detener
    if(!hayPlatos) {
        alert("‚ö†Ô∏è NO HAY PLATOS PROGRAMADOS\n\nDebes agregar al menos un plato a alg√∫n d√≠a de la semana antes de calcular la explosi√≥n.");
        
        // Mostrar mensaje visual en el √°rea de resultados
        document.getElementById('resultado-semanal').innerHTML = `
            <div class="text-center p-12 bg-amber-50 rounded-2xl border-2 border-amber-300">
                <div class="text-7xl mb-4">‚ö†Ô∏è</div>
                <p class="font-black text-2xl text-amber-700 mb-2">SIN PLANIFICACI√ìN</p>
                <p class="text-amber-600 font-semibold mb-4">No hay platos programados en las 2 semanas</p>
                <p class="text-sm text-slate-600">
                    üëà Usa los botones "‚ûï AGREGAR PLATO" en cada d√≠a para programar tu producci√≥n
                </p>
            </div>
        `;
        return;
    }
    
    // ‚úÖ CONTINUAR CON EL C√ÅLCULO SI HAY PLATOS
    let consolidated = {};
    let totalPaxGeneral = 0;
    
    // Consolidar todos los d√≠as
    Object.keys(db.planSemanal).forEach(key => {
        const platos = db.planSemanal[key];
        platos.forEach(p => {
            const plato = db.platos.find(pl => pl.sku === p.sku);
            if(!plato) return;
            totalPaxGeneral += p.qty;
            plato.componentes.forEach(c => explode(c.sku, c.cant * p.qty, consolidated));
        });
    });
    
    // CALCULAR COMPONENTES DIRECTOS PARA VISTA PRELIMINAR SEMANAL
    let componentesDirectos = [];
    Object.keys(db.planSemanal).forEach(key => {
        const platos = db.planSemanal[key];
        platos.forEach(p => {
            const plato = db.platos.find(pl => pl.sku === p.sku);
            if(!plato) return;
            
            plato.componentes.forEach(c => {
                const esMaterial = db.materiales.find(m => m.sku === c.sku);
                const esRecetaBase = db.recetasBase.find(rb => rb.sku === c.sku);
                const cantidadTotal = c.cant * p.qty;
                
                if (esMaterial) {
                    const existente = componentesDirectos.find(comp => comp.sku === c.sku);
                    if (existente) {
                        existente.cantidad += cantidadTotal;
                    } else {
                        componentesDirectos.push({
                            sku: c.sku,
                            nombre: esMaterial.nombre,
                            cantidad: cantidadTotal,
                            unidad: c.unidad,
                            tipo: 'MATERIAL',
                            familia: esMaterial.familia || 'OTROS'
                        });
                    }
                } else if (esRecetaBase) {
                    const existente = componentesDirectos.find(comp => comp.sku === c.sku);
                    if (existente) {
                        existente.cantidad += cantidadTotal;
                    } else {
                        componentesDirectos.push({
                            sku: c.sku,
                            nombre: esRecetaBase.nombre,
                            cantidad: cantidadTotal,
                            unidad: c.unidad,
                            tipo: 'RECETA BASE',
                            familia: 'RECETAS BASE'
                        });
                    }
                }
            });
        });
    });
    
    componentesDirectos.sort((a, b) => {
        if (a.tipo === 'RECETA BASE' && b.tipo !== 'RECETA BASE') return -1;
        if (a.tipo !== 'RECETA BASE' && b.tipo === 'RECETA BASE') return 1;
        return a.nombre.localeCompare(b.nombre);
    });
    
    
    let total = 0;
    let totalSinStock = 0;
    let rows = [];
    
    Object.keys(consolidated).forEach((sku, index) => {
        const m = db.materiales.find(mat => mat.sku === sku);
        if(!m) return;
        
        const reqTotalEnUnidadCosto = consolidated[sku];
        const reqTotalEnUnidadCompra = reqTotalEnUnidadCosto / m.factor;
        const stockEnUnidadCosto = db.inventario[sku] || 0;
        const stockEnUnidadCompra = stockEnUnidadCosto / m.factor;
        const faltanteEnUnidadCompra = Math.max(0, reqTotalEnUnidadCompra - stockEnUnidadCompra);
        const sub = Math.round(faltanteEnUnidadCompra * m.precio * 100) / 100;
        const costoTotal = Math.round(reqTotalEnUnidadCompra * m.precio * 100) / 100;
        
        total += costoTotal;
        totalSinStock += sub;
        
        rows.push({
            idx: index + 1,
            sku: sku,
            nombre: m.nombre,
            unid: m.uCompra,
            reqTotal: reqTotalEnUnidadCompra.toFixed(2),
            stock: stockEnUnidadCompra.toFixed(2),
            faltante: faltanteEnUnidadCompra.toFixed(2),
            precio: m.precio.toFixed(2),
            sub: sub.toFixed(2),
            tieneFaltante: faltanteEnUnidadCompra > 0
        });
    });
    
    total = Math.round(total * 100) / 100;
    totalSinStock = Math.round(totalSinStock * 100) / 100;
    
    lastExplosionSemanal = { items: rows, total: total.toFixed(2), totalSinStock: totalSinStock.toFixed(2), pax: totalPaxGeneral, componentesDirectos: componentesDirectos };
    
    const itemsConFaltante = rows.filter(r => r.tieneFaltante);
    
    // ‚úÖ MOSTRAR ESTAD√çSTICAS MEJORADAS
    document.getElementById('resultado-semanal').innerHTML = `
        <div class="w-full">
            <div class="bg-gradient-to-r from-green-100 to-teal-100 p-4 border-2 border-green-300 rounded-2xl mb-4">
                <h3 class="font-black text-xl text-center mb-3 text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-teal-600">
                    üìä EXPLOSI√ìN CONSOLIDADA 14 D√çAS
                </h3>
                
                <!-- Estad√≠sticas de planificaci√≥n -->
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="bg-white p-3 rounded-xl border-2 border-blue-200 text-center">
                        <p class="text-xs font-semibold text-slate-500 mb-1">D√çAS PLANIFICADOS</p>
                        <p class="text-2xl font-black text-blue-600">${totalDiasConPlatos}/14</p>
                    </div>
                    <div class="bg-white p-3 rounded-xl border-2 border-purple-200 text-center">
                        <p class="text-xs font-semibold text-slate-500 mb-1">PLATOS √öNICOS</p>
                        <p class="text-2xl font-black text-purple-600">${totalPlatosAgregados}</p>
                    </div>
                    <div class="bg-white p-3 rounded-xl border-2 border-emerald-200 text-center">
                        <p class="text-xs font-semibold text-slate-500 mb-1">TOTAL PAX</p>
                        <p class="text-2xl font-black text-emerald-600">${totalPaxGeneral}</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl overflow-hidden">
                    <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                        <table class="w-full text-xs">
                            <thead class="bg-green-600 text-white sticky top-0 z-10">
                                <tr>
                                    <th class="p-3 text-left font-bold">#</th>
                                    <th class="p-3 text-left font-bold">MATERIAL</th>
                                    <th class="p-3 text-center font-bold">U.M.</th>
                                    <th class="p-3 text-right font-bold">STOCK</th>
                                    <th class="p-3 text-right font-bold">REQUERIDO</th>
                                    <th class="p-3 text-right font-bold">FALTANTE</th>
                                    <th class="p-3 text-right font-bold">PRECIO</th>
                                    <th class="p-3 text-right font-bold">SUBTOTAL</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${itemsConFaltante.map(r => `
                                    <tr class="hover:bg-green-50">
                                        <td class="p-3 font-bold">${r.idx}</td>
                                        <td class="p-3 font-semibold">${r.nombre}</td>
                                        <td class="p-3 text-center">${r.unid}</td>
                                        <td class="p-3 text-right text-slate-500">${r.stock}</td>
                                        <td class="p-3 text-right text-blue-600 font-bold">${r.reqTotal}</td>
                                        <td class="p-3 text-right text-red-600 font-bold">${r.faltante}</td>
                                        <td class="p-3 text-right">S/. ${r.precio}</td>
                                        <td class="p-3 text-right text-emerald-600 font-bold">S/. ${r.sub}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-xl text-center">
                        <p class="text-xs font-semibold mb-1">COSTO TOTAL</p>
                        <p class="text-2xl font-black">S/. ${total.toFixed(2)}</p>
                    </div>
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-4 rounded-xl text-center">
                        <p class="text-xs font-semibold mb-1">A COMPRAR</p>
                        <p class="text-2xl font-black">S/. ${totalSinStock.toFixed(2)}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('btn-pdf-semanal').classList.remove('opacity-50', 'pointer-events-none');
    document.getElementById('btn-pdf-chef-semanal').classList.remove('opacity-50', 'pointer-events-none');
}



// Funci√≥n para decidir qu√© tipo de PDF semanal exportar
function exportarPDFSemanalSegunTipo() {
    const tipo = document.getElementById('tipo-export-pdf-semanal').value;
    if (tipo === 'preliminar') {
        exportarVistaPreliminarSemanalPDF();
    } else {
        exportarOrdenCompraSemanalPDF();
    }
}

// Exportar VISTA PRELIMINAR SEMANAL (componentes directos, CON AGUA FILTRADA)
function exportarVistaPreliminarSemanalPDF() {
    if (!lastExplosionSemanal) {
        alert('‚ö†Ô∏è Primero calcula la explosi√≥n semanal');
        return;
    }
    
    if (!lastExplosionSemanal.componentesDirectos || lastExplosionSemanal.componentesDirectos.length === 0) {
        alert('‚ö†Ô∏è No hay componentes directos calculados');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const componentes = lastExplosionSemanal.componentesDirectos;
    
    // Encabezado
    doc.setFillColor(22, 163, 74);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setFillColor(255, 255, 255);
    doc.circle(25, 15, 7, 'F');
    doc.setFillColor(22, 163, 74);
    doc.circle(25, 15, 5.5, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text(normalizarTexto("SWISSOTEL"), 105, 10, { align: "center" });
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(normalizarTexto("HOTELERA COSTA DEL PACIFICO S.A. - RUC: 20297885538"), 105, 16, { align: "center" });
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text(normalizarTexto("VISTA PRELIMINAR SEMANAL - 14 DIAS"), 105, 24, { align: "center" });
    
    const ahora = new Date();
    const infoY = 48;
    doc.setFillColor(240, 253, 244);
    doc.roundedRect(10, infoY, 190, 15, 2, 2, 'F');
    doc.setDrawColor(134, 239, 172);
    doc.roundedRect(10, infoY, 190, 15, 2, 2, 'S');
    doc.setTextColor(30, 41, 59);
    doc.setFontSize(8);
    doc.text("FECHA: " + ahora.toLocaleDateString('es-PE'), 15, infoY + 9);
    doc.text("TOTAL PAX: " + lastExplosionSemanal.pax + " (14 dias)", 110, infoY + 9);
    
    let y = 70;
    let pagina = 1;
    
    // T√≠tulo
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('COMPONENTES NECESARIOS', 14, y);
    y += 8;
    
    // Tabla de componentes
    componentes.forEach((comp, idx) => {
        if (y > 260) {
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('Pagina ' + pagina, 190, 285);
            doc.addPage();
            pagina++;
            y = 20;
        }
        
        if (idx % 2 === 0) {
            doc.setFillColor(249, 250, 251);
        } else {
            doc.setFillColor(255, 255, 255);
        }
        if (comp.tipo === 'RECETA BASE') {
            doc.setFillColor(239, 246, 255);
        }
        doc.rect(14, y - 3, 182, 10, 'F');
        
        doc.setTextColor(100, 116, 139);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text((idx + 1) + '', 18, y + 3);
        
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'bold');
        const icono = comp.tipo === 'RECETA BASE' ? 'RB' : 'MAT';
        doc.setFontSize(8);
        if (comp.tipo === 'RECETA BASE') {
            doc.setTextColor(37, 99, 235);
        } else {
            doc.setTextColor(16, 185, 129);
        }
        doc.text(icono, 28, y + 3);
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.text(normalizarTexto(comp.nombre), 40, y + 3);
        
        doc.setTextColor(37, 99, 235);
        doc.setFont(undefined, 'bold');
        doc.text(comp.cantidad.toFixed(2), 140, y + 3);
        
        doc.setTextColor(100, 116, 139);
        doc.setFont(undefined, 'normal');
        doc.text(normalizarTexto(comp.unidad), 160, y + 3);
        
        y += 10;
    });
    
    y += 10;
    
    // Resumen
    const rbCount = componentes.filter(c => c.tipo === 'RECETA BASE').length;
    const matCount = componentes.filter(c => c.tipo === 'MATERIAL').length;
    
    if (y > 240) { doc.addPage(); y = 20; pagina++; }
    
    doc.setFillColor(240, 253, 244);
    doc.roundedRect(14, y, 182, 25, 3, 3, 'F');
    doc.setDrawColor(134, 239, 172);
    doc.roundedRect(14, y, 182, 25, 3, 3, 'S');
    
    doc.setTextColor(22, 163, 74);
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('Recetas Base:', 20, y + 10);
    doc.text('' + rbCount, 60, y + 10);
    doc.text('Materiales:', 20, y + 18);
    doc.text('' + matCount, 60, y + 18);
    doc.text('Total PAX:', 110, y + 10);
    doc.text('' + lastExplosionSemanal.pax, 150, y + 10);
    doc.text('Total Items:', 110, y + 18);
    doc.text('' + componentes.length, 150, y + 18);
    
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.text('Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego', 14, 285);
    doc.text('Pagina ' + pagina, 190, 285);
    
    const nombre = 'VISTA_PRELIMINAR_SEMANAL_' + lastExplosionSemanal.pax + 'PAX_' + Date.now() + '.pdf';
    doc.save(nombre);
    
    alert('‚úÖ Vista Preliminar Semanal exportada correctamente');
}
        function exportarOrdenCompraSemanalPDF() {
    // 1. Confirmaci√≥n
    if(!confirm("¬øDeseas generar el PDF consolidado y limpiar la planificaci√≥n semanal?")) {
        return;
    }

    // 2. Validar datos
    if(!lastExplosionSemanal) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const ahora = new Date();
    
    // --- DISE√ëO DE ENCABEZADO (TU ESTILO VERDE) ---
    doc.setFillColor(22, 163, 74);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setFillColor(255, 255, 255);
    doc.circle(25, 15, 7, 'F');
    doc.setFillColor(22, 163, 74);
    doc.circle(25, 15, 5.5, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text("SWISSOTEL", 105, 10, { align: "center" });
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text("HOTELERA COSTA DEL PACIFICO S.A. - RUC: 20297885538", 105, 16, { align: "center" });
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text("PLANIFICACION SEMANAL - ORDEN DE COMPRA", 105, 24, { align: "center" });
    
    // --- CAJA DE INFORMACI√ìN ---
    const infoY = 48;
    doc.setFillColor(240, 253, 244);
    doc.roundedRect(10, infoY, 190, 20, 2, 2, 'F');
    doc.setDrawColor(134, 239, 172);
    doc.roundedRect(10, infoY, 190, 20, 2, 2, 'S');
    doc.setTextColor(30, 41, 59);
    doc.setFontSize(8);
    doc.text("FECHA: " + ahora.toLocaleDateString('es-PE'), 15, infoY + 12);
    doc.text("TOTAL PAX: " + lastExplosionSemanal.pax + " (14 d√≠as)", 110, infoY + 12);

    // --- FILTRO DE EXCLUSI√ìN (Para no comprar Agua Filtrada, Gas, etc.) ---
    const excluidos = ["RB AGUA FILTRADA", "GAS", "LUZ", "MANO DE OBRA", "ALQUILER"];
    
    // --- AGRUPACI√ìN POR FAMILIA ---
    const grupos = {};
    lastExplosionSemanal.items.forEach(item => {
        const nombreLimpio = item.nombre.trim().toUpperCase();
        
        // Solo procesamos si tiene faltante y NO est√° en la lista de excluidos
        if (item.tieneFaltante && !excluidos.includes(nombreLimpio)) {
            const m = db.materiales.find(mat => mat.sku === item.sku);
            const familia = (m && m.familia) ? m.familia : "VARIOS";
            
            if (!grupos[familia]) {
                grupos[familia] = { items: [], totalFamilia: 0 };
            }
            grupos[familia].items.push(item);
            grupos[familia].totalFamilia += parseFloat(item.sub);
        }
    });

    let currentY = 75;

    // --- DIBUJAR TABLAS POR CADA FAMILIA ---
    for (const familia in grupos) {
        if (currentY > 230) { doc.addPage(); currentY = 20; }

        doc.setTextColor(22, 163, 74);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(`CATEGOR√çA: ${familia}`, 10, currentY);

        doc.autoTable({
            startY: currentY + 2,
            head: [['DESCRIPCI√ìN', 'UM', 'CANT.', 'P.UNIT', 'SUBTOTAL']],
            body: grupos[familia].items.map(i => [
                i.nombre, i.unid, i.faltante, "S/. " + i.precio, "S/. " + i.sub
            ]),
            theme: 'grid',
            headStyles: { fillColor: [22, 163, 74], fontSize: 7 },
            styles: { fontSize: 7 },
            margin: { left: 10, right: 10 },
            didDrawPage: (data) => { currentY = data.cursor.y; }
        });

        // Subtotal de la familia
        currentY = doc.lastAutoTable.finalY + 6;
        doc.setFontSize(8);
        doc.setTextColor(30, 41, 59);
        doc.text(`SUBTOTAL ${familia}: S/. ${grupos[familia].totalFamilia.toLocaleString('es-PE', {minimumFractionDigits: 2})}`, 195, currentY, { align: "right" });
        currentY += 10;
    }

    // --- GRAN TOTAL ---
    if (currentY > 260) { doc.addPage(); currentY = 20; }
    doc.setFillColor(22, 163, 74);
    doc.roundedRect(120, currentY, 80, 14, 2, 2, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.text("TOTAL COMPRA 14 D√çAS:", 125, currentY + 9);
    doc.text("S/. " + lastExplosionSemanal.totalSinStock, 195, currentY + 9, { align: "right" });

    // Footer
    doc.setTextColor(100, 116, 139);
    doc.setFontSize(7);
    doc.text("Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego", 105, 285, { align: "center" });

    // Guardar PDF
    doc.save(`ORDEN_SEMANAL_${ahora.getTime()}.pdf`);
    
    // --- ACTUALIZAR INVENTARIO Y GUARDAR ---
    lastExplosionSemanal.items.forEach(item => {
        const m = db.materiales.find(mat => mat.sku === item.sku);
        if(m) {
            const reqEnUnidadCosto = parseFloat(item.reqTotal) * m.factor;
            const stockActual = db.inventario[item.sku] || 0;
            db.inventario[item.sku] = Math.max(0, stockActual - reqEnUnidadCosto);
        }
    });

    lastExplosionSemanal = null;
    db.planSemanal = {};
    save();
    
    renderPlanSemanal();
    alert("‚úÖ PDF semanal generado y planificaci√≥n reiniciada.");
}

// ========== EXPORTAR CALENDARIO SEMANAL PARA EL CHEF ==========
function exportarCalendarioSemanalPDF() {
    const { jsPDF } = window.jspdf;
    const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
    const ahora = new Date();
    
    // ===== VALIDACI√ìN: Verificar si hay platos de MEN√ö programados =====
    let hayMenusProgramados = false;
    let totalDiasConMenu = 0;
    
    Object.keys(db.planSemanal).forEach(key => {
        const platos = db.planSemanal[key] || [];
        const platosMenu = platos.filter(p => p.tipo === 'MENU');
        if (platosMenu.length > 0) {
            hayMenusProgramados = true;
            totalDiasConMenu++;
        }
    });
    
    // Si no hay men√∫s programados, no generar PDF
    if (!hayMenusProgramados) {
        alert("‚ö†Ô∏è NO HAY MEN√öS PROGRAMADOS\n\nNo hay platos de MEN√ö DEL D√çA programados en ning√∫n d√≠a de las 2 semanas.\n\nPrograma al menos un plato de men√∫ antes de generar el calendario.");
        return;
    }
    
    const doc = new jsPDF();
    
    // ===== PORTADA =====
    doc.setFillColor(236, 72, 153); // Rosa/Magenta para men√∫ del d√≠a
    doc.rect(0, 0, 210, 70, 'F');
    
    // Logo circular
    doc.setFillColor(255, 255, 255);
    doc.circle(105, 25, 15, 'F');
    doc.setFillColor(236, 72, 153);
    doc.circle(105, 25, 12, 'F');
    
    // Texto MEN√ö dentro del c√≠rculo
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text("MEN√ö", 105, 28, { align: "center" });
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(22);
    doc.setFont(undefined, 'bold');
    doc.text("CALENDARIO SEMANAL MEN√ö", 105, 50, { align: "center" });
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text("MEN√ö DEL D√çA - PROGRAMACI√ìN SEMANAL", 105, 58, { align: "center" });
    
    doc.setFontSize(10);
    doc.text("SWISSOTEL - RUC: 20297885538", 105, 64, { align: "center" });
    
    // Info del documento
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(9);
    doc.setFillColor(252, 231, 243);
    doc.roundedRect(10, 75, 190, 15, 2, 2, 'F');
    doc.setDrawColor(236, 72, 153);
    doc.roundedRect(10, 75, 190, 15, 2, 2, 'S');
    
    doc.setFont(undefined, 'bold');
    doc.text("FECHA GENERACI√ìN:", 15, 82);
    doc.setFont(undefined, 'normal');
    doc.text(ahora.toLocaleDateString('es-PE', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}), 55, 82);
    
    doc.setFont(undefined, 'bold');
    doc.text("PARA:", 15, 87);
    doc.setFont(undefined, 'normal');
    doc.text(`CHEF / CLIENTES - ${totalDiasConMenu} d√≠as con men√∫ programado`, 30, 87);
    
    let currentY = 95;
    
    // ===== SEMANA 1 =====
    doc.setFillColor(236, 72, 153); // Rosa
    doc.rect(0, currentY, 210, 12, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text("SEMANA 1 - MEN√ö DEL D√çA", 105, currentY + 8, { align: "center" });
    
    currentY += 15;
    
    // Dibujar cada d√≠a de la semana 1
    diasSemana.forEach((dia, idx) => {
        const key = `s1-d${idx}`;
        const todosPlatosDelDia = db.planSemanal[key] || [];
        
        // ‚úÖ FILTRAR SOLO PLATOS DE MEN√ö
        const platos = todosPlatosDelDia.filter(p => p.tipo === 'MENU');
        
        // ‚úÖ NUEVO: Solo renderizar d√≠a si tiene platos de men√∫
        if (platos.length === 0) {
            return; // Saltar este d√≠a
        }
        
        // Verificar si hay espacio, si no, nueva p√°gina
        if (currentY > 250) {
            doc.addPage();
            currentY = 20;
        }
        
        // Header del d√≠a
        doc.setFillColor(252, 231, 243); // Rosa claro
        doc.roundedRect(10, currentY, 190, 8, 1, 1, 'F');
        doc.setDrawColor(236, 72, 153);
        doc.roundedRect(10, currentY, 190, 8, 1, 1, 'S');
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text(dia.toUpperCase(), 12, currentY + 5.5);
        
        // Total PAX solo de men√∫
        const totalPax = platos.reduce((sum, p) => sum + p.qty, 0);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Total: ${totalPax} porciones`, 195, currentY + 5.5, { align: "right" });
        
        currentY += 10;
        
        // Platos del d√≠a
        platos.forEach((plato, i) => {
            // Fondo alternado
            if (i % 2 === 0) {
                doc.setFillColor(250, 250, 250);
                doc.rect(10, currentY, 190, 6, 'F');
            }
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            // Nombre del plato (sin emoji por compatibilidad PDF)
            doc.text(`‚Ä¢ ${plato.nombre}`, 12, currentY + 4);
            
            // Cantidad
            doc.setFont(undefined, 'bold');
            doc.setTextColor(236, 72, 153);
            doc.text(`x${plato.qty}`, 195, currentY + 4, { align: "right" });
            
            doc.setTextColor(0, 0, 0);
            currentY += 6;
        });
        
        currentY += 4; // Espacio entre d√≠as
    });
    
    // ===== SEMANA 2 =====
    // Verificar espacio para header de semana 2
    if (currentY > 250) {
        doc.addPage();
        currentY = 20;
    }
    
    doc.setFillColor(156, 39, 176); // P√∫rpura
    doc.rect(0, currentY, 210, 12, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text("SEMANA 2 - MEN√ö DEL D√çA", 105, currentY + 8, { align: "center" });
    
    currentY += 15;
    
    // Dibujar cada d√≠a de la semana 2
    diasSemana.forEach((dia, idx) => {
        const key = `s2-d${idx}`;
        const todosPlatosDelDia = db.planSemanal[key] || [];
        
        // ‚úÖ FILTRAR SOLO PLATOS DE MEN√ö
        const platos = todosPlatosDelDia.filter(p => p.tipo === 'MENU');
        
        // ‚úÖ NUEVO: Solo renderizar d√≠a si tiene platos de men√∫
        if (platos.length === 0) {
            return; // Saltar este d√≠a
        }
        
        // Verificar si hay espacio
        if (currentY > 250) {
            doc.addPage();
            currentY = 20;
        }
        
        // Header del d√≠a
        doc.setFillColor(243, 229, 245); // P√∫rpura claro
        doc.roundedRect(10, currentY, 190, 8, 1, 1, 'F');
        doc.setDrawColor(156, 39, 176);
        doc.roundedRect(10, currentY, 190, 8, 1, 1, 'S');
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text(dia.toUpperCase(), 12, currentY + 5.5);
        
        // Total PAX solo de men√∫
        const totalPax = platos.reduce((sum, p) => sum + p.qty, 0);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Total: ${totalPax} porciones`, 195, currentY + 5.5, { align: "right" });
        
        currentY += 10;
        
        // Platos del d√≠a
        platos.forEach((plato, i) => {
            // Fondo alternado
            if (i % 2 === 0) {
                doc.setFillColor(250, 250, 250);
                doc.rect(10, currentY, 190, 6, 'F');
            }
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            // Nombre del plato (sin emoji por compatibilidad PDF)
            doc.text(`‚Ä¢ ${plato.nombre}`, 12, currentY + 4);
            
            // Cantidad
            doc.setFont(undefined, 'bold');
            doc.setTextColor(156, 39, 176);
            doc.text(`x${plato.qty}`, 195, currentY + 4, { align: "right" });
            
            doc.setTextColor(0, 0, 0);
            currentY += 6;
        });
        
        currentY += 4; // Espacio entre d√≠as
    });
    
    // ===== PIE DE P√ÅGINA EN √öLTIMA P√ÅGINA =====
    const totalPages = doc.internal.pages.length - 1; // -1 porque la primera es null
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`P√°gina ${i} de ${totalPages}`, 105, 290, { align: "center" });
        doc.text("Documento generado por GASTRO CONTROL PRO", 105, 295, { align: "center" });
    }
    
    // Guardar PDF
    const nombreArchivo = `CALENDARIO_MENU_${ahora.getFullYear()}-${(ahora.getMonth()+1).toString().padStart(2,'0')}-${ahora.getDate().toString().padStart(2,'0')}.pdf`;
    doc.save(nombreArchivo);
    
    alert(`‚úÖ Calendario semanal del MEN√ö DEL D√çA generado exitosamente\n\n${totalDiasConMenu} d√≠as con men√∫ programado`);
}

        // --- FUNCIONES DE EXPORTACI√ìN PDF ---

// Funci√≥n helper para limpiar texto para PDF (eliminar emojis y caracteres especiales)
function cleanTextForPDF(text) {
    if (!text) return '';
    // Remover emojis y caracteres no-ASCII, mantener solo caracteres b√°sicos
    return text
        .replace(/[^\x00-\x7F]/g, '') // Remover no-ASCII
        .replace(/PM\s+/g, 'PM ') // Normalizar espacios despu√©s de PM
        .trim();
}

// 1. FUNCI√ìN MEJORADA: Exporta platos agrupados por categor√≠a y cocina
function exportPlatosMenuPDF() {
    if(db.platos.length === 0) {
        alert("‚ö†Ô∏è No hay platos en el men√∫ para exportar");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Obtener filtro de cocina
    const filtroCocinaElem = document.getElementById('filter-cocina-pdf');
    const filtroCocina = filtroCocinaElem ? filtroCocinaElem.value : '';
    
    // Filtrar platos por cocina si hay filtro
    let platosAExportar = db.platos;
    if (filtroCocina) {
        platosAExportar = db.platos.filter(p => p.cocina === filtroCocina);
        if (platosAExportar.length === 0) {
            alert(`‚ö†Ô∏è No hay platos registrados en la cocina "${filtroCocina}"`);
            return;
        }
    }
    
    // Agrupar platos por categor√≠a
    const platosPorCategoria = {};
    const categoriasOrdenadas = [...new Set(platosAExportar.map(p => p.categoria || 'SIN CATEGOR√çA'))].sort();
    
    categoriasOrdenadas.forEach(cat => {
        platosPorCategoria[cat] = platosAExportar.filter(p => (p.categoria || 'SIN CATEGOR√çA') === cat);
    });
    
    // ========== ENCABEZADO ==========
    doc.setFillColor(102, 126, 234);
    doc.rect(0, 0, 210, 50, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(24);
    doc.setFont(undefined, 'bold');
    doc.text("CARTA DE PLATOS", 105, 18, { align: "center" });
    
    doc.setFontSize(14);
    doc.text("SWISSOTEL", 105, 28, { align: "center" });
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text("HOTELERA COSTA DEL PACIFICO S.A. - RUC: 20297885538", 105, 36, { align: "center" });
    
    // Mostrar filtro aplicado
    if (filtroCocina) {
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text(`AREA: ${cleanTextForPDF(filtroCocina)}`, 105, 44, { align: "center" });
    } else {
        doc.setFontSize(11);
        doc.text("TODAS LAS AREAS", 105, 44, { align: "center" });
    }
    
    let yPos = 60;
    let totalPlatos = 0;
    let totalCosto = 0;
    let totalPrecio = 0;
    
    // ========== RECORRER CATEGOR√çAS ==========
    categoriasOrdenadas.forEach((categoria, catIndex) => {
        const platosCategoria = platosPorCategoria[categoria];
        
        // Verificar si necesita nueva p√°gina
        if (yPos > 240) {
            doc.addPage();
            yPos = 20;
        }
        
        // ===== ENCABEZADO DE CATEGOR√çA =====
        doc.setFillColor(99, 102, 241);
        doc.roundedRect(15, yPos, 180, 12, 3, 3, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text(cleanTextForPDF(categoria).toUpperCase(), 20, yPos + 8);
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`${platosCategoria.length} platos`, 190, yPos + 8, { align: "right" });
        
        yPos += 16;
        
        let subtotalCosto = 0;
        let subtotalPrecio = 0;
        
        // ===== PLATOS DE ESTA CATEGOR√çA =====
        platosCategoria.forEach((plato, index) => {
            // Verificar espacio
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            // Fondo del plato
            doc.setFillColor(248, 250, 252);
            doc.roundedRect(15, yPos, 180, 22, 2, 2, 'F');
            
            // N√∫mero
            const colors = [[255, 152, 0], [236, 72, 153], [34, 197, 94], [59, 130, 246], [139, 92, 246]];
            const color = colors[index % colors.length];
            doc.setFillColor(...color);
            doc.circle(22, yPos + 11, 5, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text((index + 1).toString(), 22, yPos + 13, { align: "center" });
            
            // Nombre del plato (limpio, sin emojis)
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            const nombreLimpio = cleanTextForPDF(plato.nombre.replace('PM ', ''));
            doc.text(nombreLimpio, 30, yPos + 8);
            
            // Cocina (si existe) - sin emojis
            let lineaCocina = yPos + 14;
            if (plato.cocina) {
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 116, 139);
                doc.text(cleanTextForPDF(plato.cocina), 30, lineaCocina);
            }
            
            // ===== AL√âRGENOS (solo si tiene) - Compacto y elegante =====
            const alergenosPlato = new Set();
            plato.componentes.forEach(comp => {
                const mat = db.materiales.find(m => m.sku === comp.sku);
                if (mat && mat.alergenos && mat.alergenos.length > 0) {
                    mat.alergenos.forEach(alergeno => alergenosPlato.add(alergeno));
                }
                // Si es receta base, obtener sus al√©rgenos
                if (mat && mat.nombre && mat.nombre.startsWith('RB ')) {
                    const recetaBase = db.recetasBase.find(rb => rb.nombre === mat.nombre);
                    if (recetaBase && recetaBase.ingredientes) {
                        recetaBase.ingredientes.forEach(ing => {
                            const ingrediente = db.materiales.find(m => m.sku === ing.sku);
                            if (ingrediente && ingrediente.alergenos && ingrediente.alergenos.length > 0) {
                                ingrediente.alergenos.forEach(alergeno => alergenosPlato.add(alergeno));
                            }
                        });
                    }
                }
            });
            
            // Mostrar al√©rgenos de forma compacta
            if (alergenosPlato.size > 0) {
                // Si tiene cocina, va debajo de la cocina; si no, va donde ir√≠a la cocina
                const lineaAlergenos = plato.cocina ? lineaCocina + 4 : lineaCocina;
                doc.setFontSize(7);
                doc.setTextColor(156, 39, 176); // Morado elegante
                doc.setFont(undefined, 'italic'); // Cursiva
                const alergenosText = Array.from(alergenosPlato).sort().map(a => cleanTextForPDF(a)).join(', ');
                doc.text(`Alergenos: ${alergenosText}`, 30, lineaAlergenos);
            }
            
            // M√©tricas financieras
            if (plato.precioMenu > 0) {
                // COSTO
                doc.setFillColor(219, 234, 254);
                doc.roundedRect(120, yPos + 3, 32, 9, 1, 1, 'F');
                doc.setFontSize(6);
                doc.setTextColor(30, 64, 175);
                doc.setFont(undefined, 'bold');
                doc.text("COSTO", 136, yPos + 6, { align: "center" });
                doc.setFontSize(8);
                doc.text(`S/. ${plato.costoReceta.toFixed(2)}`, 136, yPos + 10, { align: "center" });
                
                // PRECIO
                doc.setFillColor(233, 213, 255);
                doc.roundedRect(154, yPos + 3, 32, 9, 1, 1, 'F');
                doc.setTextColor(107, 33, 168);
                doc.setFontSize(6);
                doc.text("PRECIO", 170, yPos + 6, { align: "center" });
                doc.setFontSize(8);
                doc.text(`S/. ${plato.precioMenu.toFixed(2)}`, 170, yPos + 10, { align: "center" });
                
                // FC% / BC% / LC% (din√°mico seg√∫n categor√≠a)
                const etiquetaCosto = obtenerEtiquetaCosto(plato.categoria);
                doc.setFillColor(209, 250, 229);
                doc.roundedRect(120, yPos + 13, 32, 9, 1, 1, 'F');
                doc.setTextColor(21, 128, 61);
                doc.setFontSize(6);
                doc.text(etiquetaCosto, 136, yPos + 16, { align: "center" });
                doc.setFontSize(8);
                doc.text(`${plato.fcPorcentaje.toFixed(1)}%`, 136, yPos + 20, { align: "center" });
                
                // IDEAL
                doc.setFillColor(255, 237, 213);
                doc.roundedRect(154, yPos + 13, 32, 9, 1, 1, 'F');
                doc.setTextColor(194, 65, 12);
                doc.setFontSize(6);
                doc.text("IDEAL", 170, yPos + 16, { align: "center" });
                doc.setFontSize(8);
                doc.text(`S/. ${plato.precioIdeal.toFixed(2)}`, 170, yPos + 20, { align: "center" });
                
                subtotalCosto += plato.costoReceta;
                subtotalPrecio += plato.precioMenu;
            }
            
            yPos += 25;
        });
        
        // ===== SUBTOTALES DE CATEGOR√çA =====
        if (yPos > 260) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFillColor(243, 244, 246);
        doc.roundedRect(15, yPos, 180, 10, 2, 2, 'F');
        
        doc.setTextColor(75, 85, 99);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(`SUBTOTAL ${cleanTextForPDF(categoria).toUpperCase()}:`, 20, yPos + 6);
        
        doc.setTextColor(30, 64, 175);
        doc.text(`Costo: S/. ${subtotalCosto.toFixed(2)}`, 120, yPos + 6);
        
        doc.setTextColor(107, 33, 168);
        doc.text(`Precio: S/. ${subtotalPrecio.toFixed(2)}`, 160, yPos + 6);
        
        yPos += 15;
        
        totalPlatos += platosCategoria.length;
        totalCosto += subtotalCosto;
        totalPrecio += subtotalPrecio;
    });
    
    // ========== TOTALES GENERALES ==========
    if (yPos > 250) {
        doc.addPage();
        yPos = 20;
    }
    
    yPos += 5;
    
    doc.setFillColor(99, 102, 241);
    doc.roundedRect(15, yPos, 180, 18, 3, 3, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text("TOTALES GENERALES", 20, yPos + 8);
    
    doc.setFontSize(10);
    doc.text(`Platos: ${totalPlatos}`, 20, yPos + 14);
    doc.text(`Costo Total: S/. ${totalCosto.toFixed(2)}`, 80, yPos + 14);
    doc.text(`Precio Total: S/. ${totalPrecio.toFixed(2)}`, 145, yPos + 14);
    
    // ========== PIE DE P√ÅGINA ==========
    const totalPages = doc.internal.pages.length - 1;
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(100, 116, 139);
        doc.setFont(undefined, 'italic');
        doc.text(`Generado: ${new Date().toLocaleString('es-PE')} | GASTRO CONTROL PRO`, 105, 290, { align: "center" });
        doc.text(`P√°gina ${i} de ${totalPages}`, 105, 285, { align: "center" });
    }
    
    // ========== GUARDAR PDF ==========
    const nombreArchivo = filtroCocina 
        ? `CARTA_${filtroCocina.replace(/ /g, '_')}_${Date.now()}.pdf`
        : `CARTA_COMPLETA_${Date.now()}.pdf`;
    
    doc.save(nombreArchivo);
    
    const mensaje = filtroCocina
        ? `‚úÖ Carta de ${filtroCocina} exportada correctamente\n\nüìä ${totalPlatos} platos en ${categoriasOrdenadas.length} categor√≠as`
        : `‚úÖ Carta completa exportada correctamente\n\nüìä ${totalPlatos} platos en ${categoriasOrdenadas.length} categor√≠as`;
    
    alert(mensaje);
}

// NUEVA FUNCI√ìN: Exportar Hoja de Cata Profesional (estilo restaurante)
function exportarHojaCataPDF(sku) {
    const plato = db.platos.find(p => p.sku === sku);
    if (!plato) {
        alert("No se encontr√≥ el plato seleccionado.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // ========== ENCABEZADO PROFESIONAL ==========
    doc.setFillColor(219, 39, 119);
    doc.rect(0, 0, 210, 40, 'F');
    
    // Logo circular
    doc.setFillColor(255, 255, 255);
    doc.circle(25, 20, 10, 'F');
    doc.setFillColor(219, 39, 119);
    doc.circle(25, 20, 8, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text("SWISSOTEL", 105, 14, { align: "center" });
    
    doc.setFontSize(8);
    doc.setFont(undefined, 'normal');
    doc.text("HOTELERA COSTA DEL PACIFICO S.A. - RUC: 20297885538", 105, 20, { align: "center" });
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text("HOJA DE CATA", 105, 28, { align: "center" });
    
    doc.setFontSize(9);
    doc.text(`Fecha: ${new Date().toLocaleDateString('es-PE')}`, 105, 35, { align: "center" });
    
    // ========== NOMBRE DEL PLATO ==========
    let y = 48;
    doc.setFillColor(240, 240, 245);
    doc.roundedRect(10, y, 190, 12, 3, 3, 'F');
    
    doc.setTextColor(30, 30, 30);
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text(cleanTextForPDF(plato.nombre.replace('PM ', '')), 105, y + 8, { align: "center" });
    
    y += 18;
    
    // ========== INGREDIENTES (IZQUIERDA) + FOTO (DERECHA) ==========
    const yInicio = y;
    
    // INGREDIENTES
    doc.setFillColor(255, 152, 0);
    doc.rect(10, y, 85, 7, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text("INGREDIENTES", 12, y + 5);
    
    y += 10;
    
    doc.setTextColor(60, 60, 60);
    doc.setFontSize(8);
    doc.setFont(undefined, 'normal');
    
    plato.componentes.forEach((comp, idx) => {
        doc.text(cleanTextForPDF(comp.nombre), 12, y);
        doc.text(`${comp.cant.toFixed(2)} ${comp.unidad}`, 90, y, { align: 'right' });
        y += 4;
    });
    
    // FOTO del plato (derecha, al mismo nivel que ingredientes)
    const fotoHeight = 70;
    if(plato.foto) {
        try {
            doc.addImage(plato.foto, 'JPEG', 110, yInicio + 2, 85, fotoHeight);
        } catch(e) {
            console.error('Error al cargar imagen:', e);
        }
    }
    
    // Asegurar que y pase la zona de la foto
    y = Math.max(y, yInicio + fotoHeight + 5);
    
    // ========== INSTRUCCIONES PARA LA PREPARACI√ìN ==========
    if (plato.instrucciones && plato.instrucciones.trim()) {
        doc.setFillColor(59, 130, 246);
        doc.rect(10, y, 190, 7, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text("INSTRUCCIONES PARA LA PREPARACION", 12, y + 5);
        y += 10;
        
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        
        const instrucciones = doc.splitTextToSize(cleanTextForPDF(plato.instrucciones), 185);
        doc.text(instrucciones, 12, y);
        y += instrucciones.length * 4 + 3;
    }
    
    // ========== DESCRIPCION DEL PLATO (Izquierda) + ADJETIVOS (Derecha) ==========
    const yDescripcion = y;
    let yDescMax = y;
    
    // DESCRIPCION DEL PLATO (izquierda)
    if (plato.descripcion && plato.descripcion.trim()) {
        doc.setFillColor(168, 85, 247);
        doc.rect(10, y, 90, 7, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text("DESCRIPCION", 12, y + 5);
        y += 10;
        
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        const descripcion = doc.splitTextToSize(cleanTextForPDF(plato.descripcion), 88);
        doc.text(descripcion, 12, y);
        yDescMax = y + (descripcion.length * 4);
    }
    
    // ADJETIVOS INFORMATIVOS (derecha, al mismo nivel que descripci√≥n)
    let yAdjMax = yDescripcion;
    if (plato.adjetivos && plato.adjetivos.trim()) {
        const yAdj = yDescripcion;
        
        doc.setFillColor(236, 72, 153);
        doc.rect(105, yAdj, 90, 7, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text("ADJETIVOS INFORMATIVOS", 107, yAdj + 5);
        
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        const adjetivosLimpios = cleanTextForPDF(plato.adjetivos);
        const adjetivos = doc.splitTextToSize('- ' + adjetivosLimpios.split(',').map(a => a.trim()).join(' - '), 88);
        doc.text(adjetivos, 107, yAdj + 12);
        yAdjMax = yAdj + 12 + (adjetivos.length * 4);
    }
    
    // Calcular Y despu√©s de descripci√≥n/adjetivos
    y = Math.max(yDescMax, yAdjMax) + 2;
    
    // MARIDAJE (si existe)
    if (plato.maridaje && plato.maridaje.trim()) {
        doc.setFillColor(139, 92, 246);
        doc.rect(10, y, 190, 7, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text("MARIDAJE", 12, y + 5);
        y += 10;
        
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        const maridaje = doc.splitTextToSize(cleanTextForPDF(plato.maridaje), 185);
        doc.text(maridaje, 12, y);
        y += maridaje.length * 4 + 2;
    }
    
    // VENTA SUGESTIVA (ancho completo, m√°s compacta)
    if (plato.ventaSugestiva && plato.ventaSugestiva.trim()) {
        doc.setFillColor(34, 197, 94);
        doc.rect(10, y, 190, 7, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text("VENTA SUGESTIVA", 12, y + 5);
        y += 10;
        
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        const venta = doc.splitTextToSize(cleanTextForPDF(plato.ventaSugestiva), 185);
        doc.text(venta, 12, y);
        y += venta.length * 4 + 2;
    }
    
    // ========== ALERGENOS DETECTADOS AUTOMATICAMENTE ==========
    const alergenosPlato = new Set();
    plato.componentes.forEach(comp => {
        const mat = db.materiales.find(m => m.sku === comp.sku);
        if (mat && mat.alergenos && mat.alergenos.length > 0) {
            mat.alergenos.forEach(alergeno => alergenosPlato.add(alergeno));
        }
        // Si es receta base, obtener sus al√©rgenos
        if (mat && mat.nombre && mat.nombre.startsWith('RB ')) {
            const recetaBase = db.recetasBase.find(rb => rb.nombre === mat.nombre);
            if (recetaBase && recetaBase.ingredientes) {
                recetaBase.ingredientes.forEach(ing => {
                    const ingrediente = db.materiales.find(m => m.sku === ing.sku);
                    if (ingrediente && ingrediente.alergenos && ingrediente.alergenos.length > 0) {
                        ingrediente.alergenos.forEach(alergeno => alergenosPlato.add(alergeno));
                    }
                });
            }
        }
    });
    
    if (alergenosPlato.size > 0) {
        if (y > 260) {
            doc.addPage();
            y = 20;
        }
        
        doc.setFillColor(220, 38, 38);
        doc.rect(10, y, 190, 7, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text("ALERGENOS DETECTADOS (AUTOMATICO)", 12, y + 5);
        y += 10;
        
        doc.setTextColor(60, 60, 60);
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        
        const alergenosArray = Array.from(alergenosPlato).sort();
        const alergenosText = cleanTextForPDF(alergenosArray.join(', '));
        const alergenosLines = doc.splitTextToSize(alergenosText, 185);
        doc.text(alergenosLines, 12, y);
        y += alergenosLines.length * 4 + 5;
    }
    
    // ========== PIE DE P√ÅGINA ==========
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.setFont(undefined, 'italic');
    doc.text('Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego', 105, 285, { align: 'center' });
    
    // Guardar
    const nombreArchivo = plato.nombre.replace(/\s+/g, '_').replace('PM_', '');
    doc.save(`Hoja_Cata_${nombreArchivo}.pdf`);
    alert("‚úÖ Hoja de Cata exportada correctamente");
}

// 2. FUNCI√ìN: Exportar Ficha T√©cnica Individual
function exportarFichaTecnicaPlato(sku) {
    const plato = db.platos.find(p => p.sku === sku);
    if (!plato) {
        alert("No se encontr√≥ el plato seleccionado.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Encabezado Estilo Ficha (Fondo Oscuro)
    doc.setFillColor(59, 130, 246); // Slate 800
    doc.rect(0, 0, 210, 40, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text("FICHA T√âCNICA DE COSTOS", 14, 20);
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text(plato.nombre.toUpperCase(), 14, 30);

    // Foto del plato si existe
    if(plato.foto) {
        try {
            // Posici√≥n a la derecha del encabezado
            doc.addImage(plato.foto, 'JPEG', 150, 45, 45, 40);
        } catch(e) {
            console.error('Error al cargar imagen en PDF:', e);
        }
    }

    // Tabla 1: Datos Generales y Rentabilidad
    doc.autoTable({
        startY: 45,
        margin: { right: 70 }, // Espacio para que no choque con la foto
        head: [['Detalle del Plato', 'Informaci√≥n']],
        body: [
            ['SKU / C√≥digo', plato.sku],
            ['Costo Total Receta', `S/. ${plato.costoReceta.toFixed(2)}`],
            ['Precio Venta Men√∫', `S/. ${plato.precioMenu.toFixed(2)}`],
            [`Margen ${obtenerNombreCompletoCosto(plato.categoria)}`, `${plato.fcPorcentaje.toFixed(2)}%`],
            ['Precio Sugerido (Ideal)', `S/. ${plato.precioIdeal.toFixed(2)}`]
        ],
        theme: 'grid',
        headStyles: { fillStyle: [79, 70, 229] }, // √çndigo
        styles: { fontSize: 9 }
    });

    // Detalle de Componentes (Ingredientes y Recetas Base como Arroz o Salsa)
    const componentes = plato.componentes.map(comp => {
        // Buscamos la unidad de medida seg√∫n tus bases de datos
        const esMaterial = db.materiales.find(m => m.sku === comp.sku);
        const esBase = db.bases.find(b => b.sku === comp.sku);
        const unidad = esMaterial ? esMaterial.uCosto : (esBase ? esBase.unidad : 'und');
        
        return [
            comp.nombre, 
            comp.cantidad, 
            unidad, 
            `${(comp.costo || 0).toFixed(2)}`
        ];
    });

    // Tabla 2: Desglose de Insumos
    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 10,
        head: [['Ingrediente / Receta Base', 'Cant.', 'Und.', 'Costo Parcial']],
        body: componentes,
        theme: 'striped',
        headStyles: { fillStyle: [51, 65, 85] }, // Slate 700
        styles: { fontSize: 9 },
        columnStyles: {
            1: { halign: 'center' },
            2: { halign: 'center' },
            3: { halign: 'right' }
        }
    });

    // ===== SECCI√ìN: INSTRUCCIONES DE PREPARACI√ìN =====
    let currentY = doc.lastAutoTable.finalY + 15;
    
    // Verificar si hay que crear nueva p√°gina
    if (currentY > 240) {
        doc.addPage();
        currentY = 20;
    }
    
    if (plato.instrucciones && plato.instrucciones.trim()) {
        // T√≠tulo de secci√≥n
        doc.setFillColor(251, 191, 36); // Amber
        doc.rect(10, currentY - 5, 190, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text("INSTRUCCIONES DE PREPARACI√ìN", 14, currentY + 1);
        
        currentY += 10;
        
        // Contenido de instrucciones
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        
        // Dividir texto en l√≠neas que quepan en la p√°gina
        const instruccionesText = plato.instrucciones;
        const maxWidth = 180;
        const lineHeight = 5;
        const lines = doc.splitTextToSize(instruccionesText, maxWidth);
        
        lines.forEach(line => {
            // Si no hay espacio, nueva p√°gina
            if (currentY > 270) {
                doc.addPage();
                currentY = 20;
            }
            doc.text(line, 14, currentY);
            currentY += lineHeight;
        });
        
        currentY += 5; // Espacio despu√©s de instrucciones
    }
    
    // ===== SECCI√ìN: DESCRIPCION DEL PLATO (Opcional) =====
    if (plato.descripcion && plato.descripcion.trim()) {
        // Verificar espacio
        if (currentY > 240) {
            doc.addPage();
            currentY = 20;
        }
        
        // T√≠tulo
        doc.setFillColor(168, 85, 247); // Purple
        doc.rect(10, currentY - 5, 190, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text("DESCRIPCION DEL PLATO", 14, currentY + 1);
        
        currentY += 10;
        
        // Contenido
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        
        const descripcionLines = doc.splitTextToSize(plato.descripcion, 180);
        descripcionLines.forEach(line => {
            if (currentY > 270) {
                doc.addPage();
                currentY = 20;
            }
            doc.text(line, 14, currentY);
            currentY += 5;
        });
        
        currentY += 5;
    }
    
    // ===== SECCI√ìN: VENTA SUGESTIVA (Opcional) =====
    if (plato.ventaSugestiva && plato.ventaSugestiva.trim()) {
        if (currentY > 250) {
            doc.addPage();
            currentY = 20;
        }
        
        doc.setFillColor(34, 197, 94); // Green
        doc.roundedRect(10, currentY - 5, 190, 10, 2, 2, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text("VENTA SUGESTIVA", 14, currentY + 1);
        
        currentY += 10;
        
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(9);
        doc.setFont(undefined, 'italic');
        
        const ventaLines = doc.splitTextToSize(plato.ventaSugestiva, 180);
        ventaLines.forEach(line => {
            if (currentY > 270) {
                doc.addPage();
                currentY = 20;
            }
            doc.text(line, 14, currentY);
            currentY += 5;
        });
    }

    // Pie de p√°gina autom√°tico en todas las hojas
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(
            `Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego - P√°gina ${i} de ${pageCount}`,
            14, 
            doc.internal.pageSize.height - 10
        );
    }

    // Descarga del archivo con nombre limpio
    const nombreArchivo = plato.nombre.replace(/\s+/g, '_');
    doc.save(`Ficha_Costo_${nombreArchivo}.pdf`);
}

function exportRecetaBasePDF(sku) {
    const rb = db.recetasBase.find(r => r.sku === sku);
    if (!rb) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;

    doc.setFillColor(99, 102, 241);
    doc.rect(0, 0, 210, 35, 'F');

    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text("RECETA BASE", 105, 15, { align: "center" });

    doc.setFontSize(12);
    doc.text(rb.nombre, 105, 25, { align: "center" });

    y = 45;

    doc.setTextColor(30, 41, 59);
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text("DATOS GENERALES", 14, y);
    y += 6;

    doc.setFontSize(10);
doc.setFont(undefined, 'normal');

doc.text(`Codigo: ${rb.sku}`, 16, y);
y += 6;

doc.text(`Rendimiento: ${rb.rendimiento} ${rb.unidad}`, 16, y);
y += 10;


    doc.setFont(undefined, 'bold');
    doc.text("INGREDIENTES", 14, y);
    y += 4;

    doc.autoTable({
        startY: y,
        head: [['Ingrediente', 'Cantidad', 'Unidad']],
        body: rb.ingredientes.map(i => [
            i.nombre,
            i.cant.toFixed(2),
            i.unidad
        ]),
        theme: 'grid',
        headStyles: {
            fillColor: [16, 185, 129],
            textColor: [255, 255, 255],
            fontStyle: 'bold'
        },
        styles: {
            fontSize: 9,
            cellPadding: 3
        },
        margin: { left: 14, right: 14 }
    });

    let currentY = doc.lastAutoTable.finalY + 15;

    // ===== SECCI√ìN: INSTRUCCIONES DE PREPARACI√ìN =====
    if (rb.instrucciones && rb.instrucciones.trim()) {
        // Verificar espacio para la secci√≥n
        if (currentY > 230) {
            doc.addPage();
            currentY = 20;
        }
        
        // Caja con borde para instrucciones
        const boxHeight = Math.min(doc.splitTextToSize(rb.instrucciones, 170).length * 5 + 20, 100);
        doc.setFillColor(255, 251, 235); // Fondo crema suave
        doc.roundedRect(10, currentY - 5, 190, boxHeight, 3, 3, 'F');
        
        // Borde decorativo
        doc.setDrawColor(251, 191, 36); // Amber
        doc.setLineWidth(0.5);
        doc.roundedRect(10, currentY - 5, 190, boxHeight, 3, 3, 'S');
        
        // T√≠tulo de secci√≥n SIN EMOJI
        doc.setTextColor(180, 83, 9); // Amber oscuro
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text("INSTRUCCIONES DE PREPARACION", 15, currentY + 2);
        
        currentY += 10;
        
        // L√≠nea separadora
        doc.setDrawColor(251, 191, 36);
        doc.setLineWidth(0.3);
        doc.line(15, currentY, 195, currentY);
        
        currentY += 8;
        
        // Contenido de instrucciones (limpio)
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        
        // Limpiar texto de instrucciones
        const instruccionesText = cleanTextForPDF(rb.instrucciones);
        const maxWidth = 170;
        const lineHeight = 5;
        const lines = doc.splitTextToSize(instruccionesText, maxWidth);
        
        lines.forEach((line, index) => {
            // Si no hay espacio, nueva p√°gina
            if (currentY > 270) {
                doc.addPage();
                currentY = 20;
                
                // Repetir encabezado en nueva p√°gina
                doc.setFillColor(255, 251, 235);
                doc.roundedRect(10, currentY - 5, 190, 100, 3, 3, 'F');
                doc.setDrawColor(251, 191, 36);
                doc.setLineWidth(0.5);
                doc.roundedRect(10, currentY - 5, 190, 100, 3, 3, 'S');
                
                doc.setTextColor(180, 83, 9);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text("INSTRUCCIONES (continuacion)", 15, currentY + 2);
                currentY += 10;
            }
            
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(line, 15, currentY);
            currentY += lineHeight;
        });
        
        currentY += 10; // Espacio despu√©s de instrucciones
    }
    
    // ===== SECCI√ìN: NOTAS ADICIONALES (si existen) =====
    if (rb.notas && rb.notas.trim()) {
        if (currentY > 250) {
            doc.addPage();
            currentY = 20;
        }
        
        doc.setFillColor(59, 130, 246); // Blue
        doc.roundedRect(10, currentY - 5, 190, 10, 2, 2, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text("NOTAS ADICIONALES", 14, currentY + 1);
        
        currentY += 10;
        
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        
        const notasLines = doc.splitTextToSize(rb.notas, 180);
        notasLines.forEach(line => {
            if (currentY > 270) {
                doc.addPage();
                currentY = 20;
            }
            doc.text(line, 14, currentY);
            currentY += 5;
        });
    }

    // ===== SECCI√ìN: AL√âRGENOS DETECTADOS =====
    // Calcular al√©rgenos de los ingredientes
    const alergenosRB = new Set();
    rb.ingredientes.forEach(ing => {
        const mat = db.materiales.find(m => m.sku === ing.sku);
        if (mat && mat.alergenos && mat.alergenos.length > 0) {
            mat.alergenos.forEach(alergeno => alergenosRB.add(alergeno));
        }
    });
    
    if (alergenosRB.size > 0) {
        if (currentY > 240) {
            doc.addPage();
            currentY = 20;
        }
        
        doc.setFillColor(239, 68, 68); // Red
        doc.rect(10, currentY - 5, 190, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text("ALERGENOS DETECTADOS", 14, currentY + 1);
        
        currentY += 10;
        
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        
        const alergenosArray = Array.from(alergenosRB).sort();
        const alergenosText = alergenosArray.join(', ');
        const alergenosLines = doc.splitTextToSize(alergenosText, 180);
        
        alergenosLines.forEach(line => {
            if (currentY > 270) {
                doc.addPage();
                currentY = 20;
            }
            doc.text(line, 14, currentY);
            currentY += 6;
        });
        
        currentY += 5;
    }
    
    // ===== SECCI√ìN: VIDA √öTIL Y CONSERVACI√ìN =====
    if (rb.conservacion && (rb.conservacion.ambiente || rb.conservacion.refrigerado || rb.conservacion.congelado)) {
        if (currentY > 240) {
            doc.addPage();
            currentY = 20;
        }
        
        doc.setFillColor(59, 130, 246); // Blue
        doc.rect(10, currentY - 5, 190, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text("VIDA UTIL Y CONSERVACION", 14, currentY + 1);
        
        currentY += 10;
        
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        
        if (rb.conservacion.ambiente) {
            doc.setFont(undefined, 'bold');
            doc.text("Temperatura Ambiente:", 14, currentY);
            doc.setFont(undefined, 'normal');
            doc.text(rb.conservacion.ambiente, 70, currentY);
            currentY += 6;
        }
        
        if (rb.conservacion.refrigerado) {
            doc.setFont(undefined, 'bold');
            doc.text("Refrigerado (0-4C):", 14, currentY);
            doc.setFont(undefined, 'normal');
            doc.text(rb.conservacion.refrigerado, 70, currentY);
            currentY += 6;
        }
        
        if (rb.conservacion.congelado) {
            doc.setFont(undefined, 'bold');
            doc.text("Congelado (-18C):", 14, currentY);
            doc.setFont(undefined, 'normal');
            doc.text(rb.conservacion.congelado, 70, currentY);
            currentY += 6;
        }
        
        currentY += 5;
    }

    // ===== PIE DE P√ÅGINA EN TODAS LAS P√ÅGINAS =====
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(100, 116, 139);
        doc.text(
            `Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego - Receta Base: ${rb.nombre} - P√°gina ${i} de ${pageCount}`,
            14,
            doc.internal.pageSize.height - 10
        );
    }

    doc.save(`RB_${rb.nombre.replace(/\s+/g, '_')}.pdf`);
}
function calcularFCRealVsIdeal() {
    if(!db.consumoReal || db.consumoReal.length === 0) return;

    let costoRealTotal = 0;
    let ingresoTotal = 0;
    let fcIdealTotal = 0;

    db.platos.forEach(p => {
        const ventasSimuladas = 1; // üîß luego puedes reemplazar por ventas reales

        const precioSinIGV = p.precioMenu / 1.28;
        const costoIdeal = p.costoReceta;

        ingresoTotal += precioSinIGV * ventasSimuladas;
        fcIdealTotal += (costoIdeal / precioSinIGV) * 100;

        costoRealTotal += db.consumoReal.reduce((acc, c) => acc + c.costo, 0);
    });

    const fcReal = ingresoTotal > 0 ? (costoRealTotal / ingresoTotal) * 100 : 0;
    const fcIdeal = fcIdealTotal / db.platos.length || 0;
    const desviacion = fcReal - fcIdeal;

    document.getElementById("metric-fc-real").textContent = fcReal.toFixed(2) + "%";
    document.getElementById("metric-fc-ideal").textContent = fcIdeal.toFixed(2) + "%";
    document.getElementById("metric-fc-desviacion").textContent = desviacion.toFixed(2) + "%";
}

// ======================================================
//  FUNCION: EXPORTAR FICHA INDIVIDUAL DE PLATO (Pegar al final)
// ======================================================

function exportarFichaTecnicaPlato(sku) {
    // 1. Buscar el plato en la base de datos
    const plato = db.platos.find(p => p.sku === sku);
    if (!plato) {
        alert("Error: No se encontr√≥ el plato.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // --- ENCABEZADO AZUL (Actualizado) ---
    doc.setFillColor(59, 130, 246); // Azul vibrante (Tailwind blue-500)
    doc.rect(0, 0, 210, 40, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text("FICHA T√âCNICA DE COSTOS", 14, 20);
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text(plato.nombre.toUpperCase(), 14, 30);

    // --- FOTO ---
    if(plato.foto) {
        try {
            doc.addImage(plato.foto, 'JPEG', 150, 45, 45, 40);
        } catch(e) {
            console.log("No se pudo cargar la imagen");
        }
    }

    // --- TABLA 1: DATOS FINANCIEROS (Encabezado Azul) ---
    doc.autoTable({
        startY: 45,
        margin: { right: 70 },
        head: [['Concepto', 'Valor']],
        body: [
            ['C√≥digo SKU', plato.sku],
            ['Costo Receta', `S/. ${plato.costoReceta.toFixed(2)}`],
            ['Precio Venta', `S/. ${plato.precioMenu.toFixed(2)}`],
            [obtenerNombreCompletoCosto(plato.categoria) + ' %', `${plato.fcPorcentaje.toFixed(2)}%`],
            ['Precio Ideal', `S/. ${plato.precioIdeal.toFixed(2)}`]
        ],
        theme: 'grid',
        headStyles: { fillStyle: [59, 130, 246] }, // Azul
        styles: { fontSize: 10 }
    });

    // --- PREPARAR LISTA DE INGREDIENTES (Con correcci√≥n de cantidad) ---
    const listaIngredientes = plato.componentes.map(comp => {
        const esMaterial = db.materiales.find(m => m.sku === comp.sku);
        const esBase = db.recetasBase.find(b => b.sku === comp.sku);
        
        const unidad = esMaterial ? esMaterial.uCosto : (esBase ? esBase.unidad : 'und');
        
        // CORRECCI√ìN AQU√ç: Intentar leer 'cantidad' o 'cant'
        const qty = comp.cantidad || comp.cant || 0;
        
        let costoParcial = comp.costo || 0;
        if(costoParcial === 0 && esMaterial) {
            costoParcial = qty * (esMaterial.precio / esMaterial.factor);
        }

        return [
            comp.nombre,
            qty, // Usamos la variable qty que ya validamos
            unidad,
            `S/. ${costoParcial.toFixed(2)}`
        ];
    });

    // --- TABLA 2: DESGLOSE ---
    doc.autoTable({
        startY: doc.lastAutoTable.finalY + 10,
        head: [['Ingrediente / Receta Base', 'Cant.', 'Und.', 'Costo Parcial']],
        body: listaIngredientes,
        theme: 'striped',
        headStyles: { fillStyle: [30, 41, 59] }, // Slate oscuro para contraste
        styles: { fontSize: 9 },
        columnStyles: {
            1: { halign: 'center' },
            2: { halign: 'center' },
            3: { halign: 'right' }
        }
    });

    // --- PIE DE P√ÅGINA ---
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(`Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego - P√°gina ${i} de ${totalPages}`, 14, 285);
    }

    doc.save(`Ficha_${plato.nombre.replace(/\s+/g, '_')}.pdf`);
}

        // ======================================================
        // L√ìGICA DE SEGURIDAD TRIMESTRAL VINCULADA AL GENERADOR
        // ======================================================

        function generarHashSeguridad(text) {
            let hash = 0;
            for (let i = 0; i < text.length; i++) {
                const char = text.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16).toUpperCase().padStart(8, '0');
        }


// ========== INGRESO DE DOCUMENTOS ==========
// ========== INGRESO DE DOCUMENTOS ==========
if(!db.documentos) db.documentos = [];

let itemsDocumento = [];

function cargarDatosProveedor() {
    const provId = document.getElementById('doc-proveedor').value;
    if(!provId) {
        document.getElementById('doc-ruc').value = '';
        return;
    }
    
    const prov = db.proveedores.find(p => p.id === provId);
    if(prov) {
        document.getElementById('doc-ruc').value = prov.ruc || '';
    }
}

// B√∫squeda en tiempo real de materiales
function buscarMaterial() {
    const busqueda = document.getElementById('doc-item-buscar').value.trim().toLowerCase();
    const resultadosDiv = document.getElementById('doc-resultados-busqueda');
    
    if(busqueda.length < 2) {
        resultadosDiv.classList.add('hidden');
        return;
    }
    
    // Filtrar materiales
    const resultados = db.materiales.filter(m => {
        return m.nombre.toLowerCase().includes(busqueda) || 
               m.sku.toLowerCase().includes(busqueda) ||
               (m.familia && m.familia.toLowerCase().includes(busqueda));
    });
    
    if(resultados.length === 0) {
        resultadosDiv.innerHTML = '<div class="p-4 text-center text-slate-400">No se encontraron materiales</div>';
        resultadosDiv.classList.remove('hidden');
        return;
    }
    
    // Agrupar por familia
    const porFamilia = {};
    resultados.forEach(m => {
        const fam = m.familia || 'OTROS';
        if(!porFamilia[fam]) porFamilia[fam] = [];
        porFamilia[fam].push(m);
    });
    
    let html = '';
    Object.keys(porFamilia).sort().forEach(familia => {
        html += `<div class="border-b border-slate-200">`;
        html += `<div class="p-2 bg-slate-100 font-bold text-xs text-slate-600">üìÅ ${familia}</div>`;
        porFamilia[familia].forEach(m => {
            // Obtener √∫ltimo precio de compra si existe
            let ultimoPrecio = '-';
            if(db.documentos && db.documentos.length > 0) {
                const docsConMaterial = db.documentos
                    .filter(d => d.items && d.items.some(i => i.sku === m.sku))
                    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                if(docsConMaterial.length > 0) {
                    const ultimoItem = docsConMaterial[0].items.find(i => i.sku === m.sku);
                    if(ultimoItem) {
                        const precio = ultimoItem.precioUnitario || ultimoItem.precio || 0;
                        ultimoPrecio = 'S/. ' + precio.toFixed(2);
                    }
                }
            }
            
            html += `
                <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-100 transition-colors" onclick="seleccionarMaterial('${m.sku}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-bold text-sm text-slate-800">${m.nombre}</p>
                            <p class="text-xs text-slate-500">SKU: ${m.sku} | ${m.uCompra}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-400">√öltimo precio:</p>
                            <p class="text-sm font-bold text-blue-600">${ultimoPrecio}</p>
                        </div>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
    });
    
    resultadosDiv.innerHTML = html;
    resultadosDiv.classList.remove('hidden');
}

function mostrarResultadosBusqueda() {
    const busqueda = document.getElementById('doc-item-buscar').value.trim();
    if(busqueda.length >= 2) {
        buscarMaterial();
    }
}

function seleccionarMaterial(sku) {
    const material = db.materiales.find(m => m.sku === sku);
    if(!material) return;
    
    // Llenar campos
    document.getElementById('doc-item-buscar').value = material.nombre;
    document.getElementById('doc-item-material-sku').value = material.sku;
    document.getElementById('doc-item-unidad').value = material.uCompra;
    
    // Ocultar resultados
    document.getElementById('doc-resultados-busqueda').classList.add('hidden');
    
    // Mostrar info del material
    document.getElementById('info-sku').textContent = material.sku;
    document.getElementById('info-nombre').textContent = material.nombre;
    document.getElementById('info-familia').textContent = material.familia || 'N/A';
    document.getElementById('info-unidad').textContent = material.uCompra;
    document.getElementById('info-factor').textContent = material.factor + ' (para ' + material.uCosto + ')';
    
    // Buscar √∫ltimo precio
    let ultimoPrecio = '-';
    if(db.documentos && db.documentos.length > 0) {
        const docsConMaterial = db.documentos
            .filter(d => d.items && d.items.some(i => i.sku === material.sku))
            .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        if(docsConMaterial.length > 0) {
            const ultimoItem = docsConMaterial[0].items.find(i => i.sku === material.sku);
            if(ultimoItem) {
                const precio = ultimoItem.precioUnitario || ultimoItem.precio || 0;
                ultimoPrecio = 'S/. ' + precio.toFixed(2);
                // Auto-llenar precio
                document.getElementById('doc-item-precio').value = precio.toFixed(2);
            }
        }
    }
    document.getElementById('info-precio-ultimo').textContent = ultimoPrecio;
    
    document.getElementById('doc-item-info').classList.remove('hidden');
    
    // Auto-marcar exonerado si es fruta o verdura
    const familiasExoneradas = ['FRUTAS', 'VERDURAS'];
    if(familiasExoneradas.includes(material.familia)) {
        document.getElementById('doc-item-exonerado').checked = true;
    }
    
    // Focus en cantidad
    document.getElementById('doc-item-cantidad').focus();
}

// Cerrar resultados al hacer click fuera
document.addEventListener('click', function(e) {
    const buscar = document.getElementById('doc-item-buscar');
    const resultados = document.getElementById('doc-resultados-busqueda');
    if(buscar && resultados && !buscar.contains(e.target) && !resultados.contains(e.target)) {
        resultados.classList.add('hidden');
    }
});

function agregarItemDocumento() {
    const sku = document.getElementById('doc-item-material-sku').value;
    const cantidad = parseFloat(document.getElementById('doc-item-cantidad').value) || 0;
    const precioUnit = parseFloat(document.getElementById('doc-item-precio').value) || 0;
    const exonerado = document.getElementById('doc-item-exonerado').checked;
    
    if(!sku || cantidad <= 0 || precioUnit <= 0) {
        alert('‚ö†Ô∏è Busca un Material, ingresa Cantidad y Precio Unitario');
        return;
    }
    
    const material = db.materiales.find(m => m.sku === sku);
    if(!material) {
        alert('‚ö†Ô∏è Material no encontrado');
        return;
    }
    
    const valorVenta = cantidad * precioUnit;
    
    itemsDocumento.push({
        sku: material.sku,
        nombre: material.nombre,
        familia: material.familia,
        cantidad,
        unidad: material.uCompra,
        factor: material.factor,
        precioUnitario: precioUnit,
        valorVenta,
        exonerado
    });
    
    renderItemsDocumento();
    limpiarItemDocumento();
}

function limpiarItemDocumento() {
    document.getElementById('doc-item-buscar').value = '';
    document.getElementById('doc-item-material-sku').value = '';
    document.getElementById('doc-item-cantidad').value = '';
    document.getElementById('doc-item-precio').value = '';
    document.getElementById('doc-item-unidad').value = '';
    document.getElementById('doc-item-exonerado').checked = false;
    document.getElementById('doc-item-info').classList.add('hidden');
    document.getElementById('doc-resultados-busqueda').classList.add('hidden');
    document.getElementById('doc-item-buscar').focus();
}

function eliminarItemDocumento(idx) {
    itemsDocumento.splice(idx, 1);
    renderItemsDocumento();
}

function renderItemsDocumento() {
    const tbody = document.getElementById('doc-items-table');
    
    if(itemsDocumento.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="8" class="p-4 text-center text-slate-400">
                No hay items agregados
            </td></tr>
        `;
        actualizarTotalesDocumento();
        return;
    }
    
    tbody.innerHTML = itemsDocumento.map((item, idx) => {
        return `
            <tr class="hover:bg-blue-50">
                <td class="p-2 font-mono text-xs">${item.sku}</td>
                <td class="p-2 font-semibold">${item.nombre}</td>
                <td class="p-2 text-center font-bold">${item.cantidad}</td>
                <td class="p-2 text-center">${item.unidad}</td>
                <td class="p-2 text-right">S/. ${item.precioUnitario.toFixed(2)}</td>
                <td class="p-2 text-right font-bold">S/. ${item.valorVenta.toFixed(2)}</td>
                <td class="p-2 text-center">
                    <span class="px-2 py-1 rounded text-xs font-bold ${item.exonerado ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                        ${item.exonerado ? 'EXONERADO' : 'GRAVADO'}
                    </span>
                </td>
                <td class="p-2 text-center">
                    <button onclick="eliminarItemDocumento(${idx})" class="bg-red-100 text-red-600 px-2 py-1 rounded font-bold text-xs">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    actualizarTotalesDocumento();
}

function actualizarTotalesDocumento() {
    const opGravada = itemsDocumento.filter(i => !i.exonerado).reduce((sum, i) => sum + i.valorVenta, 0);
    const opExonerada = itemsDocumento.filter(i => i.exonerado).reduce((sum, i) => sum + i.valorVenta, 0);
    const igv = opGravada * 0.18;
    const total = opGravada + opExonerada + igv;
    
    document.getElementById('doc-subtotal').textContent = 'S/. ' + opGravada.toFixed(2);
    document.getElementById('doc-exonerado').textContent = 'S/. ' + opExonerada.toFixed(2);
    document.getElementById('doc-igv').textContent = 'S/. ' + igv.toFixed(2);
    document.getElementById('doc-total').textContent = 'S/. ' + total.toFixed(2);
}

function guardarDocumento() {
    const tipo = document.getElementById('doc-tipo').value;
    const numero = document.getElementById('doc-numero').value.trim();
    const fecha = document.getElementById('doc-fecha').value;
    const provId = document.getElementById('doc-proveedor').value;
    const ruc = document.getElementById('doc-ruc').value.trim();
    const condicion = document.getElementById('doc-condicion').value;
    const observaciones = document.getElementById('doc-observaciones').value.trim();
    
    if(!numero || !fecha || !provId) {
        alert('‚ö†Ô∏è Completa: N¬∞ Documento, Fecha y Proveedor');
        return;
    }
    
    if(itemsDocumento.length === 0) {
        alert('‚ö†Ô∏è Agrega al menos un item al documento');
        return;
    }
    
    const prov = db.proveedores.find(p => p.id === provId);
    const provNombre = prov ? prov.nombre : 'Proveedor desconocido';
    
    const opGravada = itemsDocumento.filter(i => !i.exonerado).reduce((sum, i) => sum + i.valorVenta, 0);
    const opExonerada = itemsDocumento.filter(i => i.exonerado).reduce((sum, i) => sum + i.valorVenta, 0);
    const igv = opGravada * 0.18;
    const total = opGravada + opExonerada + igv;
    
    const documento = {
        id: Date.now().toString(),
        tipo,
        numero,
        fecha,
        proveedor: provNombre,
        proveedorId: provId,
        ruc,
        condicion,
        observaciones,
        items: [...itemsDocumento],
        opGravada,
        opExonerada,
        igv,
        total,
        fechaRegistro: new Date().toISOString()
    };
    
    // Guardar documento
    if(!db.documentos) db.documentos = [];
    db.documentos.push(documento);
    
    // INTEGRACI√ìN CON FINANZAS: Crear egreso autom√°tico
    if(!db.otrosEgresos) db.otrosEgresos = [];
    db.otrosEgresos.push({
        id: Date.now().toString() + '-DOC',
        concepto: `${tipo} ${numero} - ${provNombre}`,
        categoria: 'COMPRAS',
        monto: total,
        fecha: fecha,
        observaciones: `Documento: ${tipo} ${numero}\n${itemsDocumento.length} items\nProveedor: ${provNombre}`,
        documentoId: documento.id
    });
    
    // ACTUALIZAR INVENTARIO - Ahora TODOS los items est√°n vinculados
    itemsDocumento.forEach(item => {
        if(!db.inventario[item.sku]) db.inventario[item.sku] = 0;
        // Convertir cantidad del documento (en unidad de compra) a unidad de costo
        const cantidadEnUnidadCosto = item.cantidad * item.factor;
        db.inventario[item.sku] += cantidadEnUnidadCosto;
        
        console.log(`üì¶ STOCK ACTUALIZADO:
        Material: ${item.nombre}
        SKU: ${item.sku}
        Cantidad comprada: ${item.cantidad} ${item.unidad}
        Factor: ${item.factor}
        Agregado al inventario: ${cantidadEnUnidadCosto} (en unidad de costo)
        Stock nuevo: ${db.inventario[item.sku]}`);
    });
    
    save();
    limpiarFormularioDocumento();
    renderHistorialDocumentos();
    
    if(typeof renderMaterials === 'function') renderMaterials();
    if(typeof renderStock === 'function') renderStock();
    if(typeof calcularFinanzas === 'function') calcularFinanzas();
    
    alert(`‚úÖ COMPRA REGISTRADA\n\n${tipo}: ${numero}\nProveedor: ${provNombre}\n\nSubtotal: S/. ${opGravada.toFixed(2)}\nExonerado: S/. ${opExonerada.toFixed(2)}\nIGV (18%): S/. ${igv.toFixed(2)}\nTOTAL: S/. ${total.toFixed(2)}\n\n‚úÖ Stock actualizado (${itemsDocumento.length} materiales)\n‚úÖ Egreso registrado en FINANZAS`);
}

function limpiarFormularioDocumento() {
    document.getElementById('doc-tipo').value = 'FACTURA';
    document.getElementById('doc-numero').value = '';
    document.getElementById('doc-fecha').value = new Date().toISOString().split('T')[0];
    document.getElementById('doc-proveedor').value = '';
    document.getElementById('doc-ruc').value = '';
    document.getElementById('doc-condicion').value = 'CONTADO';
    document.getElementById('doc-observaciones').value = '';
    itemsDocumento = [];
    renderItemsDocumento();
    limpiarItemDocumento();
}

function renderHistorialDocumentos() {
    const cont = document.getElementById('doc-historial');
    const count = document.getElementById('doc-count');
    
    if(!db.documentos || db.documentos.length === 0) {
        cont.innerHTML = '<p class="text-center text-slate-400 py-8">No hay documentos registrados</p>';
        count.textContent = '0';
        return;
    }
    
    count.textContent = db.documentos.length;
    
    const colores = {
        'FACTURA': 'from-blue-50 to-indigo-50 border-blue-300',
        'BOLETA': 'from-green-50 to-emerald-50 border-green-300',
        'GUIA': 'from-orange-50 to-amber-50 border-orange-300',
        'NOTA CREDITO': 'from-red-50 to-pink-50 border-red-300'
    };
    
    cont.innerHTML = db.documentos.slice().reverse().slice(0, 30).map(doc => {
        const fecha = new Date(doc.fecha).toLocaleDateString('es-PE');
        
        return `
            <div class="bg-gradient-to-r ${colores[doc.tipo] || 'from-slate-50 to-gray-50 border-slate-300'} border-2 rounded-xl p-4">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <p class="font-black text-base mb-1">${doc.tipo}: ${doc.numero}</p>
                        <p class="text-xs text-slate-600">üìÖ ${fecha} ‚Ä¢ üè¢ ${doc.proveedor}</p>
                        ${doc.ruc ? `<p class="text-xs text-slate-500">RUC: ${doc.ruc}</p>` : ''}
                        <p class="text-xs font-semibold text-slate-600 mt-1">üí≥ ${doc.condicion || 'CONTADO'}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-3xl font-black text-blue-600">S/. ${(doc.total || 0).toFixed(2)}</p>
                        <p class="text-xs text-slate-500 mt-1">${doc.items ? doc.items.length : 0} materiales</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-3 border mb-3">
                    <p class="text-xs font-bold mb-2">MATERIALES COMPRADOS:</p>
                    <div class="space-y-1 max-h-40 overflow-y-auto">
                        ${doc.items ? doc.items.map(it => {
                            const skuDisplay = it.sku ? `[${it.sku}] ` : '';
                            const nombreDisplay = it.nombre || it.descripcion || 'Item';
                            
                            // Compatibilidad con documentos antiguos y nuevos
                            const cantidad = it.cantidad || 0;
                            const unidad = it.unidad || 'UND';
                            const precioUnit = it.precioUnitario || it.precio || 0;
                            const valorTotal = it.valorVenta || it.subtotal || 0;
                            
                            return `
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-700">${skuDisplay}${nombreDisplay}</span>
                                <span><strong>${cantidad} ${unidad}</strong> √ó S/. ${precioUnit.toFixed(2)} = <strong class="text-blue-600">S/. ${valorTotal.toFixed(2)}</strong></span>
                            </div>
                        `;}).join('') : '<p class="text-xs text-slate-400">Sin items</p>'}
                    </div>
                </div>
                
                <div class="bg-slate-50 rounded-lg p-2 border text-xs">
                    <div class="flex justify-between">
                        <span>Op. Gravada:</span>
                        <span class="font-bold">S/. ${(doc.opGravada || 0).toFixed(2)}</span>
                    </div>
                    ${doc.opExonerada && doc.opExonerada > 0 ? `
                        <div class="flex justify-between text-green-700">
                            <span>Op. Exonerada:</span>
                            <span class="font-bold">S/. ${doc.opExonerada.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    <div class="flex justify-between text-orange-700">
                        <span>IGV (18%):</span>
                        <span class="font-bold">S/. ${(doc.igv || 0).toFixed(2)}</span>
                    </div>
                </div>
                
                ${doc.observaciones ? `
                    <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs">
                        <strong>Obs:</strong> ${doc.observaciones}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function inicDocumentos() {
    document.getElementById('doc-fecha').value = new Date().toISOString().split('T')[0];
    itemsDocumento = [];
    renderItemsDocumento();
    renderHistorialDocumentos();
    // Focus en el buscador
    setTimeout(() => {
        const buscar = document.getElementById('doc-item-buscar');
        if(buscar) buscar.focus();
    }, 100);
}


// ========== BUSCADORES PARA RECETAS BASE Y PLATOS MEN√ö ==========

let selectedIndexRB = -1;
let selectedIndexPlato = -1;

// BUSCADOR DE MATERIALES EN RECETAS BASE
function buscarMaterialRB() {
    const busqueda = document.getElementById('b-insumo-buscar').value.trim().toLowerCase();
    const resultadosDiv = document.getElementById('rb-resultados-busqueda');
    
    selectedIndexRB = -1; // Reset selecci√≥n
    
    if(busqueda.length < 2) {
        resultadosDiv.classList.add('hidden');
        return;
    }
    
    const resultados = db.materiales.filter(m => 
        m.nombre.toLowerCase().includes(busqueda) || 
        m.sku.toLowerCase().includes(busqueda) ||
        (m.familia && m.familia.toLowerCase().includes(busqueda))
    );
    
    if(resultados.length === 0) {
        resultadosDiv.innerHTML = '<div class="p-4 text-center text-slate-400">No se encontraron materiales</div>';
        resultadosDiv.classList.remove('hidden');
        return;
    }
    
    const porFamilia = {};
    resultados.forEach(m => {
        const fam = m.familia || 'OTROS';
        if(!porFamilia[fam]) porFamilia[fam] = [];
        porFamilia[fam].push(m);
    });
    
    let html = '';
    let itemIndex = 0;
    Object.keys(porFamilia).sort().forEach(familia => {
        html += `<div class="border-b border-slate-200">`;
        html += `<div class="p-2 bg-emerald-100 font-bold text-xs text-emerald-700">üìÅ ${familia}</div>`;
        porFamilia[familia].forEach(m => {
            html += `
                <div class="rb-resultado-item p-3 hover:bg-emerald-50 cursor-pointer border-b border-slate-100 transition-colors" onclick="seleccionarMaterialRB('${m.sku}')" data-index="${itemIndex}" data-sku="${m.sku}">
                    <p class="font-bold text-sm text-slate-800">${m.nombre}</p>
                    <p class="text-xs text-slate-500">SKU: ${m.sku} | ${m.uCosto}</p>
                </div>
            `;
            itemIndex++;
        });
        html += `</div>`;
    });
    
    resultadosDiv.innerHTML = html;
    resultadosDiv.classList.remove('hidden');
}

function navegarResultadosRB(event) {
    const resultadosDiv = document.getElementById('rb-resultados-busqueda');
    if(resultadosDiv.classList.contains('hidden')) return;
    
    const items = document.querySelectorAll('.rb-resultado-item');
    if(items.length === 0) return;
    
    if(event.key === 'ArrowDown') {
        event.preventDefault();
        selectedIndexRB = Math.min(selectedIndexRB + 1, items.length - 1);
        actualizarSeleccionRB(items);
    } else if(event.key === 'ArrowUp') {
        event.preventDefault();
        selectedIndexRB = Math.max(selectedIndexRB - 1, 0);
        actualizarSeleccionRB(items);
    } else if(event.key === 'Enter') {
        event.preventDefault();
        if(selectedIndexRB >= 0) {
            const sku = items[selectedIndexRB].getAttribute('data-sku');
            seleccionarMaterialRB(sku);
        }
    }
}

function actualizarSeleccionRB(items) {
    items.forEach((item, index) => {
        if(index === selectedIndexRB) {
            item.classList.add('bg-emerald-100');
            item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
            item.classList.remove('bg-emerald-100');
        }
    });
}

function mostrarResultadosRB() {
    const busqueda = document.getElementById('b-insumo-buscar').value.trim();
    if(busqueda.length >= 2) buscarMaterialRB();
}

function seleccionarMaterialRB(sku) {
    const material = db.materiales.find(m => m.sku === sku);
    if(!material) return;
    
    document.getElementById('b-insumo-buscar').value = material.nombre;
    document.getElementById('b-insumo').value = material.sku;
    document.getElementById('rb-resultados-busqueda').classList.add('hidden');
    document.getElementById('b-cant').focus();
    selectedIndexRB = -1;
}

// BUSCADOR DE RECETAS EN PLATOS MEN√ö
function buscarRecetaPlato() {
    const busqueda = document.getElementById('p-item-buscar').value.trim().toLowerCase();
    const resultadosDiv = document.getElementById('plato-resultados-busqueda');
    
    selectedIndexPlato = -1; // Reset selecci√≥n
    
    if(busqueda.length < 2) {
        resultadosDiv.classList.add('hidden');
        return;
    }
    
    // Buscar en TODOS los materiales (incluye materiales base y recetas base)
    const resultados = db.materiales.filter(m => 
        m.nombre.toLowerCase().includes(busqueda) || 
        m.sku.toLowerCase().includes(busqueda)
    ).slice(0, 15); // Limitar a 15 resultados
    
    if(resultados.length === 0) {
        resultadosDiv.innerHTML = '<div class="p-4 text-center text-slate-400">No se encontraron materiales</div>';
        resultadosDiv.classList.remove('hidden');
        return;
    }
    
    let html = '';
    resultados.forEach((m, index) => {
        const stock = db.inventario[m.sku] || 0;
        const esRecetaBase = m.sku.startsWith('MAT-RB-');
        const tipo = esRecetaBase ? 'üç≤ RB' : 'üì¶ MAT';
        
        html += `
            <div class="plato-resultado-item p-3 hover:bg-orange-50 cursor-pointer border-b border-slate-100 transition-colors" onclick="seleccionarRecetaPlato('${m.sku}')" data-index="${index}" data-sku="${m.sku}">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm text-slate-800">${tipo} ${m.nombre}</p>
                        <p class="text-xs text-slate-500">SKU: ${m.sku} | Stock: ${stock.toFixed(2)} ${m.uCosto}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-400">Precio:</p>
                        <p class="text-sm font-bold text-orange-600">S/. ${((m.precio / m.factor) || 0).toFixed(2)}</p>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultadosDiv.innerHTML = html;
    resultadosDiv.classList.remove('hidden');
}

function navegarResultadosPlato(event) {
    const resultadosDiv = document.getElementById('plato-resultados-busqueda');
    if(resultadosDiv.classList.contains('hidden')) return;
    
    const items = document.querySelectorAll('.plato-resultado-item');
    if(items.length === 0) return;
    
    if(event.key === 'ArrowDown') {
        event.preventDefault();
        selectedIndexPlato = Math.min(selectedIndexPlato + 1, items.length - 1);
        actualizarSeleccionPlato(items);
    } else if(event.key === 'ArrowUp') {
        event.preventDefault();
        selectedIndexPlato = Math.max(selectedIndexPlato - 1, 0);
        actualizarSeleccionPlato(items);
    } else if(event.key === 'Enter') {
        event.preventDefault();
        if(selectedIndexPlato >= 0) {
            const sku = items[selectedIndexPlato].getAttribute('data-sku');
            seleccionarRecetaPlato(sku);
        }
    }
}

function actualizarSeleccionPlato(items) {
    items.forEach((item, index) => {
        if(index === selectedIndexPlato) {
            item.classList.add('bg-orange-100');
            item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
            item.classList.remove('bg-orange-100');
        }
    });
}

function mostrarResultadosPlato() {
    const busqueda = document.getElementById('p-item-buscar').value.trim();
    if(busqueda.length >= 2) buscarRecetaPlato();
}

function seleccionarRecetaPlato(sku) {
    const material = db.materiales.find(m => m.sku === sku);
    if(!material) return;
    
    document.getElementById('p-item-buscar').value = material.nombre;
    document.getElementById('p-item-selector').value = material.sku; // Usar el SKU directo del material
    document.getElementById('plato-resultados-busqueda').classList.add('hidden');
    document.getElementById('p-cant').focus();
    selectedIndexPlato = -1;
}

// Cerrar resultados al hacer click fuera
document.addEventListener('click', function(e) {
    const buscarRB = document.getElementById('b-insumo-buscar');
    const resultadosRB = document.getElementById('rb-resultados-busqueda');
    if(buscarRB && resultadosRB && !buscarRB.contains(e.target) && !resultadosRB.contains(e.target)) {
        resultadosRB.classList.add('hidden');
    }
    
    const buscarPlato = document.getElementById('p-item-buscar');
    const resultadosPlato = document.getElementById('plato-resultados-busqueda');
    if(buscarPlato && resultadosPlato && !buscarPlato.contains(e.target) && !resultadosPlato.contains(e.target)) {
        resultadosPlato.classList.add('hidden');
    }
    
    const buscarInventarioPlato = document.getElementById('p-sku-inventario-buscar');
    const sugerenciasInventarioPlato = document.getElementById('p-sku-inventario-sugerencias');
    if(buscarInventarioPlato && sugerenciasInventarioPlato && !buscarInventarioPlato.contains(e.target) && !sugerenciasInventarioPlato.contains(e.target)) {
        sugerenciasInventarioPlato.classList.add('hidden');
    }
});

// B√∫squeda predictiva para selector de inventario en productos terminados
function buscarMaterialInventarioPlato() {
    const input = document.getElementById('p-sku-inventario-buscar').value.toUpperCase();
    const contenedor = document.getElementById('p-sku-inventario-sugerencias');
    
    if (input.length < 2) {
        contenedor.classList.add('hidden');
        return;
    }
    
    const coincidencias = db.materiales
        .filter(m => m.nombre.includes(input) || m.sku.includes(input))
        .slice(0, 15)
        .sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    if (coincidencias.length === 0) {
        contenedor.innerHTML = '<div class="p-3 text-center text-slate-400">No se encontraron materiales</div>';
        contenedor.classList.remove('hidden');
        return;
    }
    
    contenedor.innerHTML = coincidencias.map(m => {
        const stock = db.inventario[m.sku] || 0;
        const stockText = stock > 0 ? `Stock: ${stock.toFixed(2)} ${m.uCosto}` : 'Sin stock';
        const esRecetaBase = m.sku.startsWith('MAT-RB-');
        const tipo = esRecetaBase ? 'üç≤' : 'üì¶';
        
        return `
            <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-100 last:border-b-0"
                 onclick="seleccionarMaterialInventarioPlato('${m.sku}')">
                <p class="font-bold text-sm text-slate-700">${tipo} ${m.nombre}</p>
                <p class="text-xs text-slate-500">${stockText} ‚Ä¢ SKU: ${m.sku}</p>
            </div>
        `;
    }).join('');
    
    contenedor.classList.remove('hidden');
}

function seleccionarMaterialInventarioPlato(sku) {
    const material = db.materiales.find(m => m.sku === sku);
    if (!material) return;
    
    document.getElementById('p-sku-inventario').value = material.sku;
    document.getElementById('p-sku-inventario-buscar').value = material.nombre;
    document.getElementById('p-sku-inventario-sugerencias').classList.add('hidden');
}



// ========== C√ÅLCULO DE PRODUCCI√ìN PARA RECETAS BASE ==========

let datosProduccionActual = null;

function abrirModalProduccion(sku) {
    const receta = db.recetasBase.find(r => r.sku === sku);
    if (!receta) {
        alert('‚ö†Ô∏è Receta no encontrada');
        return;
    }
    
    // Guardar SKU de la receta
    document.getElementById('prod-sku-receta').value = sku;
    
    // Llenar informaci√≥n de la receta
    document.getElementById('prod-nombre-receta').textContent = receta.nombre;
    document.getElementById('prod-rendimiento-base').textContent = 
        `Rendimiento base: ${receta.rendimiento} ${receta.unidad}`;
    document.getElementById('prod-unidad').textContent = receta.unidad;
    
    // Limpiar cantidad
    document.getElementById('prod-cantidad').value = '';
    document.getElementById('tabla-insumos-produccion').innerHTML = '';
    document.getElementById('prod-costo-total').textContent = 'S/. 0.00';
    document.getElementById('prod-costo-unitario').textContent = 'S/. 0.00';
    
    // Mostrar modal
    document.getElementById('modal-calcular-produccion').style.display = 'flex';
}

function cerrarModalProduccion() {
    document.getElementById('modal-calcular-produccion').style.display = 'none';
    datosProduccionActual = null;
}

function calcularInsumos() {
    const sku = document.getElementById('prod-sku-receta').value;
    const cantidadDeseada = parseFloat(document.getElementById('prod-cantidad').value);
    
    if (!cantidadDeseada || cantidadDeseada <= 0) {
        document.getElementById('tabla-insumos-produccion').innerHTML = 
            '<tr><td colspan="5" class="text-center py-4 text-slate-400">Ingresa la cantidad a producir</td></tr>';
        document.getElementById('prod-costo-total').textContent = 'S/. 0.00';
        document.getElementById('prod-costo-unitario').textContent = 'S/. 0.00';
        datosProduccionActual = null;
        return;
    }
    
    const receta = db.recetasBase.find(r => r.sku === sku);
    if (!receta) return;
    
    // Calcular factor de escalado
    const factor = cantidadDeseada / receta.rendimiento;
    
    // Calcular insumos necesarios
    const insumosNecesarios = receta.ingredientes.map(ing => {
        const material = db.materiales.find(m => m.sku === ing.sku);
        
        // Validar que el material existe
        if (!material) {
            console.warn(`‚ö†Ô∏è Material no encontrado: ${ing.sku} - ${ing.nombre}`);
            return {
                nombre: ing.nombre + ' (NO ENCONTRADO)',
                cantidadNecesaria: ing.cant * factor,
                unidad: ing.unidad,
                cantidadEnUCompra: 0,
                uCompra: ing.unidad,
                precioUnitario: 0,
                subtotal: 0
            };
        }
        
        const cantidadNecesaria = ing.cant * factor;
        
        // Convertir a unidad de compra si es necesario
        const cantidadEnUCompra = cantidadNecesaria / (material.factor || 1);
        const precioUnitario = material.precio || 0;
        const subtotal = cantidadEnUCompra * precioUnitario;
        
        return {
            nombre: material.nombre,
            cantidadNecesaria: cantidadNecesaria,
            unidad: ing.unidad,
            cantidadEnUCompra: cantidadEnUCompra,
            uCompra: material.uCompra,
            precioUnitario: precioUnitario,
            subtotal: subtotal
        };
    });
    
    // Renderizar tabla
    const tbody = document.getElementById('tabla-insumos-produccion');
    tbody.innerHTML = insumosNecesarios.map(insumo => `
        <tr class="hover:bg-slate-50">
            <td class="p-3 font-semibold">${insumo.nombre}</td>
            <td class="p-3 text-center font-bold text-blue-600">
                ${insumo.cantidadNecesaria.toFixed(2)}
            </td>
            <td class="p-3 text-center text-slate-600">${insumo.unidad}</td>
            <td class="p-3 text-right text-slate-700">S/. ${insumo.precioUnitario.toFixed(2)}</td>
            <td class="p-3 text-right font-bold text-emerald-600">S/. ${insumo.subtotal.toFixed(2)}</td>
        </tr>
        <tr class="bg-slate-50">
            <td colspan="5" class="px-3 py-1 text-xs text-slate-500">
                ‚Üí En unidad de compra: ${insumo.cantidadEnUCompra.toFixed(2)} ${insumo.uCompra}
            </td>
        </tr>
    `).join('');
    
    // Calcular totales
    const costoTotal = insumosNecesarios.reduce((sum, i) => sum + i.subtotal, 0);
    const costoUnitario = costoTotal / cantidadDeseada;
    
    document.getElementById('prod-costo-total').textContent = `S/. ${costoTotal.toFixed(2)}`;
    document.getElementById('prod-costo-unitario').textContent = 
        `S/. ${costoUnitario.toFixed(2)} / ${receta.unidad}`;
    
    // Guardar datos para exportaci√≥n
    datosProduccionActual = {
        receta: receta,
        cantidadDeseada: cantidadDeseada,
        factor: factor,
        insumos: insumosNecesarios,
        costoTotal: costoTotal,
        costoUnitario: costoUnitario
    };
}

function exportarProduccionPDF() {
    if (!datosProduccionActual) {
        alert('‚ö†Ô∏è Primero ingresa la cantidad a producir');
        return;
    }
    
    const { receta, cantidadDeseada, insumos, costoTotal, costoUnitario } = datosProduccionActual;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Configuraci√≥n de colores
    const colorPrimario = [103, 58, 183]; // Purple
    const colorSecundario = [33, 150, 243]; // Blue
    
    // ENCABEZADO
    doc.setFillColor(...colorPrimario);
    doc.rect(0, 0, 210, 35, 'F');
    
    // T√≠tulo
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('PLANIFICACION DE PRODUCCION', 40, 17);
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('GASTRO CONTROL PRO - Swissotel', 40, 25);
    
    // Fecha y hora
    const ahora = new Date();
    doc.setFontSize(8);
    doc.text(`Generado: ${ahora.toLocaleDateString('es-PE')} ${ahora.toLocaleTimeString('es-PE')}`, 140, 30);
    
    // INFORMACI√ìN DE LA RECETA
    let y = 50;
    
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('RECETA BASE:', 14, y);
    
    doc.setFontSize(16);
    doc.setTextColor(...colorPrimario);
    doc.text(receta.nombre, 14, y + 8);
    
    // Cuadro de informaci√≥n
    doc.setFillColor(243, 244, 246);
    doc.roundedRect(14, y + 12, 182, 25, 3, 3, 'F');
    
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'bold');
    doc.text('Rendimiento base:', 18, y + 20);
    doc.setFont(undefined, 'normal');
    doc.text(`${receta.rendimiento} ${receta.unidad}`, 60, y + 20);
    
    doc.setFont(undefined, 'bold');
    doc.text('Cantidad a producir:', 18, y + 28);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(...colorSecundario);
    doc.setFontSize(12);
    doc.text(`${cantidadDeseada} ${receta.unidad}`, 65, y + 28);
    
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'bold');
    doc.text('Factor de escala:', 120, y + 20);
    doc.setFont(undefined, 'normal');
    doc.text(`${datosProduccionActual.factor.toFixed(2)}x`, 160, y + 20);
    
    // TABLA DE INSUMOS
    y += 45;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(...colorPrimario);
    doc.text('INSUMOS NECESARIOS', 14, y);
    
    y += 8;
    
    // Header de tabla
    doc.setFillColor(...colorPrimario);
    doc.rect(14, y, 182, 10, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('INGREDIENTE', 18, y + 7);
    doc.text('CANTIDAD', 100, y + 7);
    doc.text('UNIDAD', 130, y + 7);
    doc.text('P. UNIT.', 155, y + 7);
    doc.text('SUBTOTAL', 175, y + 7);
    
    y += 12;
    
    // Filas de insumos
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(9);
    
    insumos.forEach((insumo, index) => {
        // Alternar color de fondo
        if (index % 2 === 0) {
            doc.setFillColor(249, 250, 251);
            doc.rect(14, y - 4, 182, 12, 'F');
        }
        
        // Ingrediente
        doc.setFont(undefined, 'bold');
        doc.text(insumo.nombre, 18, y + 2);
        
        // Cantidad
        doc.setFont(undefined, 'normal');
        doc.setTextColor(...colorSecundario);
        doc.text(insumo.cantidadNecesaria.toFixed(2), 100, y + 2);
        
        // Unidad
        doc.setTextColor(100, 116, 139);
        doc.text(insumo.unidad, 130, y + 2);
        
        // Precio unitario
        doc.setTextColor(0, 0, 0);
        doc.text(`S/. ${insumo.precioUnitario.toFixed(2)}`, 155, y + 2);
        
        // Subtotal
        doc.setFont(undefined, 'bold');
        doc.setTextColor(16, 185, 129);
        doc.text(`S/. ${insumo.subtotal.toFixed(2)}`, 175, y + 2);
        
        // Nota de conversi√≥n
        doc.setFontSize(7);
        doc.setTextColor(100, 116, 139);
        doc.setFont(undefined, 'italic');
        doc.text(`En unidad de compra: ${insumo.cantidadEnUCompra.toFixed(2)} ${insumo.uCompra}`, 18, y + 7);
        
        doc.setFontSize(9);
        y += 12;
        
        // Nueva p√°gina si es necesario
        if (y > 250) {
            doc.addPage();
            y = 20;
        }
    });
    
    // TOTALES
    y += 5;
    
    doc.setFillColor(...colorPrimario);
    doc.rect(14, y, 182, 25, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('COSTO TOTAL DE INSUMOS:', 18, y + 10);
    
    doc.setFontSize(18);
    doc.text(`S/. ${costoTotal.toFixed(2)}`, 120, y + 11);
    
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text(`Costo por ${receta.unidad}: S/. ${costoUnitario.toFixed(2)}`, 18, y + 19);
    
    // FOOTER
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.text('Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego', 14, 285);
    doc.text(`P√°gina 1`, 190, 285);
    
    // Guardar PDF
    const nombreArchivo = `PRODUCCION_${receta.nombre.replace(/\s+/g, '_')}_${cantidadDeseada}${receta.unidad}_${Date.now()}.pdf`;
    doc.save(nombreArchivo);
    
    alert('‚úÖ PDF exportado correctamente');
}

// ========== PORCIONAMIENTO Y PRODUCCI√ìN DE RECETAS BASE ==========

let insumosNecesariosPorcionamiento = [];
let recetaSeleccionadaPorcionamiento = null;

// B√∫squeda predictiva de recetas
function buscarRecetaPorcionamiento() {
    const input = document.getElementById('porcion-receta-buscar').value.toUpperCase();
    const contenedor = document.getElementById('porcion-sugerencias');
    
    if (input.length < 2) {
        contenedor.classList.add('hidden');
        return;
    }
    
    const coincidencias = db.recetasBase
        .filter(rb => rb.nombre.includes(input))
        .slice(0, 10)
        .sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    if (coincidencias.length === 0) {
        contenedor.innerHTML = '<div class="p-3 text-center text-slate-400">No se encontraron recetas</div>';
        contenedor.classList.remove('hidden');
        return;
    }
    
    contenedor.innerHTML = coincidencias.map(rb => `
        <div class="p-3 hover:bg-indigo-50 cursor-pointer border-b border-slate-100 last:border-b-0"
             onclick="seleccionarRecetaPorcionamiento('${rb.sku}')">
            <p class="font-bold text-sm text-slate-700">${rb.nombre}</p>
            <p class="text-xs text-slate-500">${rb.rendimiento} ${rb.unidad} ‚Ä¢ ${rb.ingredientes.length} ingredientes</p>
        </div>
    `).join('');
    
    contenedor.classList.remove('hidden');
}

// Seleccionar receta de sugerencias
function seleccionarRecetaPorcionamiento(sku) {
    const receta = db.recetasBase.find(rb => rb.sku === sku);
    if (!receta) return;
    
    recetaSeleccionadaPorcionamiento = receta;
    
    document.getElementById('porcion-receta').value = receta.sku;
    document.getElementById('porcion-receta-buscar').value = receta.nombre;
    document.getElementById('porcion-sugerencias').classList.add('hidden');
    document.getElementById('porcion-cantidad').focus();
    
    // Mostrar info
    document.getElementById('porcion-rendimiento-base').textContent = `${receta.rendimiento} ${receta.unidad}`;
    document.getElementById('info-receta-porcionamiento').classList.remove('hidden');
    
    // Si ya hay cantidad, calcular
    const cantidad = parseFloat(document.getElementById('porcion-cantidad').value) || 0;
    if (cantidad > 0) {
        calcularInsumosNecesariosPorcionamiento();
    }
}

// Cerrar sugerencias al hacer click fuera
document.addEventListener('click', function(e) {
    const input = document.getElementById('porcion-receta-buscar');
    const sugerencias = document.getElementById('porcion-sugerencias');
    
    if (input && sugerencias && !input.contains(e.target) && !sugerencias.contains(e.target)) {
        sugerencias.classList.add('hidden');
    }
});

// Calcular insumos necesarios
function calcularInsumosNecesariosPorcionamiento() {
    const cantidad = parseFloat(document.getElementById('porcion-cantidad').value) || 0;
    
    if (!recetaSeleccionadaPorcionamiento || cantidad <= 0) {
        document.getElementById('tabla-insumos-porcionamiento').classList.add('hidden');
        return;
    }
    
    const factor = cantidad / recetaSeleccionadaPorcionamiento.rendimiento;
    document.getElementById('porcion-factor').textContent = factor.toFixed(2) + 'x';
    
    // Calcular explosi√≥n de materiales
    let consolidadoRB = {};
    
    recetaSeleccionadaPorcionamiento.ingredientes.forEach(ing => {
        const cantidadNecesaria = ing.cant * factor;
        explode(ing.sku, cantidadNecesaria, consolidadoRB);
    });
    
    // Convertir consolidado a array de insumos
    insumosNecesariosPorcionamiento = Object.keys(consolidadoRB).map(sku => {
        const mat = db.materiales.find(m => m.sku === sku);
        if (!mat) return null; // Saltar si no encuentra material
        
        const cantEnUnidadCosto = consolidadoRB[sku];
        const stockActual = db.inventario[sku] || 0;
        const suficiente = stockActual >= cantEnUnidadCosto;
        
        return {
            sku: sku,
            nombre: mat.nombre,
            cantidadNecesaria: cantEnUnidadCosto,
            unidad: mat.uCosto,
            stockActual: stockActual,
            suficiente: suficiente,
            precio: mat.precio / mat.factor
        };
    }).filter(ins => ins !== null); // Eliminar nulls
    
    // Calcular costo total
    const costoTotal = insumosNecesariosPorcionamiento.reduce((sum, ins) => {
        return sum + (ins.cantidadNecesaria * ins.precio);
    }, 0);
    
    document.getElementById('porcion-costo-estimado').textContent = `S/. ${costoTotal.toFixed(2)}`;
    
    // Renderizar tabla (mostrar advertencias pero no bloquear)
    const tbody = document.getElementById('tbody-insumos-porcionamiento');
    tbody.innerHTML = insumosNecesariosPorcionamiento.map(ins => `
        <tr class="hover:bg-slate-50 ${!ins.suficiente ? 'bg-yellow-50' : ''}">
            <td class="p-3 font-semibold">${ins.nombre}</td>
            <td class="p-3 text-center font-bold text-blue-600">
                ${ins.cantidadNecesaria.toFixed(2)} ${ins.unidad}
            </td>
            <td class="p-3 text-center ${ins.suficiente ? 'text-green-600' : 'text-orange-600'} font-bold">
                ${ins.stockActual.toFixed(2)} ${ins.unidad}
            </td>
            <td class="p-3 text-center">
                ${ins.suficiente ? 
                    '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-lg font-bold text-xs">‚úì DISPONIBLE</span>' :
                    '<span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-lg font-bold text-xs">‚ö† STOCK BAJO</span>'
                }
            </td>
        </tr>
    `).join('');
    
    document.getElementById('tabla-insumos-porcionamiento').classList.remove('hidden');
    
    // SIEMPRE HABILITAR BOT√ìN (permite stock negativo)
    document.getElementById('btn-ejecutar-produccion').disabled = false;
    document.getElementById('btn-ejecutar-produccion').innerHTML = '‚úÖ EJECUTAR PRODUCCI√ìN';
}

// Ejecutar producci√≥n
function ejecutarProduccionRB() {
    if (!recetaSeleccionadaPorcionamiento) {
        alert('‚ö†Ô∏è Selecciona una receta base');
        return;
    }
    
    const cantidad = parseFloat(document.getElementById('porcion-cantidad').value) || 0;
    const fecha = document.getElementById('porcion-fecha').value;
    
    if (cantidad <= 0) {
        alert('‚ö†Ô∏è Ingresa cantidad a producir');
        return;
    }
    
    if (!fecha) {
        alert('‚ö†Ô∏è Selecciona fecha de producci√≥n');
        return;
    }
    
    // Verificar si hay insumos con stock insuficiente
    const insumosInsuficientes = insumosNecesariosPorcionamiento.filter(ins => !ins.suficiente);
    
    let mensaje = `¬øConfirmas ejecutar producci√≥n de:\n\n${recetaSeleccionadaPorcionamiento.nombre}\nCantidad: ${cantidad} ${recetaSeleccionadaPorcionamiento.unidad}\n\nEsto descargar√° los insumos del inventario.`;
    
    if (insumosInsuficientes.length > 0) {
        mensaje += `\n\n‚ö†Ô∏è ADVERTENCIA: Los siguientes insumos tienen stock insuficiente y quedar√°n en NEGATIVO:\n\n`;
        insumosInsuficientes.forEach(ins => {
            const faltante = ins.cantidadNecesaria - ins.stockActual;
            mensaje += `‚Ä¢ ${ins.nombre}: Falta ${faltante.toFixed(2)} ${ins.unidad}\n`;
        });
        mensaje += `\n¬øDeseas continuar de todas formas?`;
    }
    
    if (!confirm(mensaje)) {
        return;
    }
    
    // 1. DESCARGAR INSUMOS DEL INVENTARIO (permite negativos)
    insumosNecesariosPorcionamiento.forEach(ins => {
        db.inventario[ins.sku] = (db.inventario[ins.sku] || 0) - ins.cantidadNecesaria;
    });
    
    // 2. GENERAR STOCK DE LA RECETA BASE
    const skuMaterial = 'MAT-' + recetaSeleccionadaPorcionamiento.sku;
    db.inventario[skuMaterial] = (db.inventario[skuMaterial] || 0) + cantidad;
    
    // 3. CALCULAR COSTO TOTAL
    const costoTotal = insumosNecesariosPorcionamiento.reduce((sum, ins) => {
        return sum + (ins.cantidadNecesaria * ins.precio);
    }, 0);
    
    // 4. REGISTRAR EN HISTORIAL
    const produccion = {
        id: Date.now().toString(),
        fecha: fecha,
        receta: recetaSeleccionadaPorcionamiento.nombre,
        skuReceta: recetaSeleccionadaPorcionamiento.sku,
        cantidad: cantidad,
        unidad: recetaSeleccionadaPorcionamiento.unidad,
        costoTotal: costoTotal,
        costoUnitario: costoTotal / cantidad,
        insumos: insumosNecesariosPorcionamiento.map(ins => ({
            sku: ins.sku,
            nombre: ins.nombre,
            cantidad: ins.cantidadNecesaria,
            unidad: ins.unidad
        })),
        timestamp: new Date().toISOString()
    };
    
    db.produccionesRB.push(produccion);
    
    // 5. GUARDAR
    save();
    
    // 6. ACTUALIZAR VISTAS
    renderStock();
    renderHistorialProducciones();
    limpiarFormPorcionamiento();
    
    alert(`‚úÖ PRODUCCI√ìN EJECUTADA\n\nSe produjo: ${cantidad} ${recetaSeleccionadaPorcionamiento.unidad} de ${recetaSeleccionadaPorcionamiento.nombre}\nCosto total: S/. ${costoTotal.toFixed(2)}\n\nStock actualizado en inventario.`);
}

// Limpiar formulario
function limpiarFormPorcionamiento() {
    document.getElementById('porcion-receta').value = '';
    document.getElementById('porcion-receta-buscar').value = '';
    document.getElementById('porcion-cantidad').value = '';
    document.getElementById('porcion-fecha').value = '';
    document.getElementById('info-receta-porcionamiento').classList.add('hidden');
    document.getElementById('tabla-insumos-porcionamiento').classList.add('hidden');
    document.getElementById('porcion-sugerencias').classList.add('hidden');
    recetaSeleccionadaPorcionamiento = null;
    insumosNecesariosPorcionamiento = [];
}

// Renderizar historial de producciones
function renderHistorialProducciones() {
    const filtroFecha = document.getElementById('filtro-fecha-porcionamiento').value;
    
    let producciones = [...db.produccionesRB];
    
    // Filtrar por fecha si hay filtro
    if (filtroFecha) {
        producciones = producciones.filter(p => p.fecha === filtroFecha);
    }
    
    // Ordenar por fecha desc
    producciones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    const tbody = document.getElementById('tbody-historial-producciones');
    
    if (producciones.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="p-8 text-center text-slate-400">
                    <div class="text-4xl mb-2">üì≠</div>
                    <p class="font-bold">No hay producciones registradas</p>
                    ${filtroFecha ? '<p class="text-sm mt-2">Intenta con otra fecha</p>' : ''}
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = producciones.map(prod => `
        <tr class="hover:bg-slate-50 border-b border-slate-100">
            <td class="p-3">
                <p class="font-bold text-sm">${prod.fecha}</p>
                <p class="text-xs text-slate-500">${new Date(prod.timestamp).toLocaleTimeString('es-PE')}</p>
            </td>
            <td class="p-3">
                <p class="font-bold text-sm text-indigo-700">${prod.receta}</p>
            </td>
            <td class="p-3 text-center">
                <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg font-bold text-xs">
                    ${prod.cantidad} ${prod.unidad}
                </span>
            </td>
            <td class="p-3 text-center">
                <p class="font-bold text-green-600">S/. ${prod.costoTotal.toFixed(2)}</p>
                <p class="text-xs text-slate-500">S/. ${prod.costoUnitario.toFixed(2)} / ${prod.unidad}</p>
            </td>
            <td class="p-3 text-right">
                <button onclick="verDetalleProduccion('${prod.id}')" class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg font-bold text-xs btn-action">
                    üëÅÔ∏è VER
                </button>
                <button onclick="exportarProduccionRBPDF('${prod.id}')" class="bg-indigo-600 text-white px-3 py-2 rounded-lg font-bold text-xs btn-action">
                    üìÑ PDF
                </button>
            </td>
        </tr>
    `).join('');
}

// Ver detalle de producci√≥n
function verDetalleProduccion(id) {
    const prod = db.produccionesRB.find(p => p.id === id);
    if (!prod) return;
    
    const insumos = prod.insumos.map(ins => `‚Ä¢ ${ins.nombre}: ${ins.cantidad.toFixed(2)} ${ins.unidad}`).join('\n');
    
    alert(`DETALLE DE PRODUCCI√ìN\n\nFecha: ${prod.fecha}\nReceta: ${prod.receta}\nCantidad: ${prod.cantidad} ${prod.unidad}\n\nINSUMOS UTILIZADOS:\n${insumos}\n\nCOSTO TOTAL: S/. ${prod.costoTotal.toFixed(2)}\nCOSTO UNITARIO: S/. ${prod.costoUnitario.toFixed(2)} / ${prod.unidad}`);
}

// Exportar producci√≥n a PDF
function exportarProduccionRBPDF(id) {
    const prod = db.produccionesRB.find(p => p.id === id);
    if (!prod) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Colores
    const colorPrimario = [103, 58, 183];
    
    // ENCABEZADO
    doc.setFillColor(...colorPrimario);
    doc.rect(0, 0, 210, 35, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('ORDEN DE PRODUCCION EJECUTADA', 105, 17, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('GASTRO CONTROL PRO - Swissotel', 105, 25, { align: 'center' });
    
    let y = 50;
    
    // INFORMACI√ìN
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('FECHA DE PRODUCCION:', 14, y);
    doc.setFont(undefined, 'normal');
    doc.text(prod.fecha, 70, y);
    
    y += 10;
    doc.setFont(undefined, 'bold');
    doc.text('RECETA BASE:', 14, y);
    doc.setFontSize(14);
    doc.setTextColor(...colorPrimario);
    doc.text(prod.receta, 14, y + 8);
    
    y += 20;
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'bold');
    doc.text('CANTIDAD PRODUCIDA:', 14, y);
    doc.setFont(undefined, 'normal');
    doc.text(`${prod.cantidad} ${prod.unidad}`, 70, y);
    
    y += 10;
    doc.setFont(undefined, 'bold');
    doc.text('COSTO TOTAL:', 14, y);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 150, 0);
    doc.text(`S/. ${prod.costoTotal.toFixed(2)}`, 70, y);
    
    y += 10;
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'bold');
    doc.text('COSTO UNITARIO:', 14, y);
    doc.setFont(undefined, 'normal');
    doc.text(`S/. ${prod.costoUnitario.toFixed(2)} / ${prod.unidad}`, 70, y);
    
    // TABLA DE INSUMOS
    y += 20;
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(...colorPrimario);
    doc.text('INSUMOS UTILIZADOS', 14, y);
    
    y += 8;
    
    // Header tabla
    doc.setFillColor(...colorPrimario);
    doc.rect(14, y, 182, 10, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(9);
    doc.text('MATERIAL', 18, y + 7);
    doc.text('CANTIDAD', 120, y + 7);
    doc.text('UNIDAD', 160, y + 7);
    
    y += 12;
    
    // Filas
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'normal');
    
    prod.insumos.forEach((ins, idx) => {
        if (idx % 2 === 0) {
            doc.setFillColor(249, 250, 251);
            doc.rect(14, y - 4, 182, 8, 'F');
        }
        
        doc.text(ins.nombre, 18, y + 2);
        doc.text(ins.cantidad.toFixed(2), 120, y + 2);
        doc.text(ins.unidad, 160, y + 2);
        
        y += 8;
    });
    
    // ===== AGREGAR INSTRUCCIONES DE PREPARACI√ìN =====
    const rbData = db.recetasBase.find(r => r.sku === prod.skuReceta);
    if (rbData && rbData.instrucciones && rbData.instrucciones.trim()) {
        y += 10;
        
        // Verificar si necesitamos nueva p√°gina
        if (y > 220) {
            doc.addPage();
            y = 20;
        }
        
        // Caja con borde para instrucciones
        const instruccionesLimpias = cleanTextForPDF(rbData.instrucciones);
        const boxHeight = Math.min(doc.splitTextToSize(instruccionesLimpias, 170).length * 5 + 20, 100);
        doc.setFillColor(255, 251, 235); // Fondo crema suave
        doc.roundedRect(14, y - 5, 182, boxHeight, 3, 3, 'F');
        
        // Borde decorativo
        doc.setDrawColor(251, 191, 36); // Amber
        doc.setLineWidth(0.5);
        doc.roundedRect(14, y - 5, 182, boxHeight, 3, 3, 'S');
        
        // T√≠tulo de instrucciones SIN EMOJI
        doc.setTextColor(180, 83, 9); // Amber oscuro
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('INSTRUCCIONES DE PREPARACION', 18, y + 2);
        
        y += 8;
        
        // L√≠nea separadora
        doc.setDrawColor(251, 191, 36);
        doc.setLineWidth(0.3);
        doc.line(18, y, 192, y);
        
        y += 8;
        
        // Contenido de instrucciones
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        
        const maxWidth = 170;
        const lineHeight = 5;
        const lines = doc.splitTextToSize(instruccionesLimpias, maxWidth);
        
        lines.forEach(line => {
            if (y > 270) {
                doc.addPage();
                y = 20;
                
                // Repetir encabezado en nueva p√°gina
                doc.setFillColor(255, 251, 235);
                doc.roundedRect(14, y - 5, 182, 80, 3, 3, 'F');
                doc.setDrawColor(251, 191, 36);
                doc.setLineWidth(0.5);
                doc.roundedRect(14, y - 5, 182, 80, 3, 3, 'S');
                
                doc.setTextColor(180, 83, 9);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('INSTRUCCIONES (continuacion)', 18, y + 2);
                y += 10;
            }
            
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(line, 18, y);
            y += lineHeight;
        });
        
        y += 5;
    }
    
    // Footer
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.text('Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego', 14, 285);
    
    doc.save(`PRODUCCION_${prod.receta.replace(/\s+/g, '_')}_${prod.fecha}.pdf`);
    alert('‚úÖ PDF exportado correctamente');
}

        function manualActivate() {
            const input = document.getElementById('licenseInput').value.trim().toUpperCase();
            const partes = input.split('-');
            
            if (partes.length !== 4 || partes[0] !== "LTM") {
                alert("‚ùå Formato de c√≥digo no reconocido.");
                return;
            }

            const year = parseInt(partes[1]);
            const quarterStr = partes[2]; 
            const userHash = partes[3];

            // VALIDACI√ìN MATEM√ÅTICA (Solo tu generador funcionar√° aqu√≠)
            const semilla = `LTM${year}${quarterStr}SWISSOTEL`;
            const hashCalculado = generarHashSeguridad(semilla).substring(0, 4);

            if (userHash !== hashCalculado) {
                alert("‚ùå C√≥digo inv√°lido. Este c√≥digo no pertenece a este sistema.");
                return;
            }

            // VALIDACI√ìN DE TIEMPO
            const qNumber = parseInt(quarterStr.replace('Q', ''));
            const mesVencimiento = qNumber * 3; 
            const fechaVencimiento = new Date(year, mesVencimiento, 0, 23, 59, 59);
            const hoy = new Date();

            if (hoy > fechaVencimiento) {
                alert("‚ùå Error: Est√°s intentando usar un c√≥digo del " + quarterStr + " " + year + ", pero ese periodo YA VENCI√ì.");
                return;
            }

            // GUARDADO AUTOM√ÅTICO
            localStorage.setItem('gastro_v14_active', "true");
            localStorage.setItem('gastro_v14_expira', fechaVencimiento.getTime());
            localStorage.setItem('gastro_v14_periodo', quarterStr + " - " + year);
            
            desbloquearSistema();
            alert("‚úÖ SISTEMA ACTIVADO\nPeriodo: " + quarterStr + " " + year + "\nVence el: " + fechaVencimiento.toLocaleDateString());
        }

        function verificarLicencia() {
            const estado = localStorage.getItem('gastro_v14_active');
            const expira = localStorage.getItem('gastro_v14_expira');
            const periodo = localStorage.getItem('gastro_v14_periodo') || "EXPIRADO";
            const hoy = new Date().getTime();

            if (estado !== "true" || !expira || hoy > parseInt(expira)) {
                localStorage.removeItem('gastro_v14_active');
                
                // CAMBIAR MENSAJE DEL MODAL PARA AVISAR QUE VENCI√ì
                const modalMsg = document.querySelector('#licenseModal p');
                if (modalMsg) {
                    modalMsg.innerHTML = `<b class="text-red-600 uppercase">¬°ATENCI√ìN: TRIMESTRE ${periodo} VENCIDO!</b><br>El sistema requiere el nuevo c√≥digo de activaci√≥n para continuar.`;
                }
                
                bloquearSistema();
            } else {
                desbloquearSistema();
            }
        }

        function bloquearSistema() {
            document.getElementById('licenseModal').style.display = 'flex';
            document.getElementById('mainContent').classList.add('blur-content');
        }

        function desbloquearSistema() {
            document.getElementById('licenseModal').style.display = 'none';
            document.getElementById('mainContent').classList.remove('blur-content');
        }

        window.addEventListener('load', verificarLicencia);

// ========== PRODUCCI√ìN MASIVA DE RECETAS BASE ==========

let listaProduccionMasiva = [];
let consolidadoMasiva = null;

function abrirModalProduccionMasiva() {
    document.getElementById('modal-produccion-masiva').style.display = 'flex';
    limpiarListaProduccionMasiva();
}

function cerrarModalProduccionMasiva() {
    document.getElementById('modal-produccion-masiva').style.display = 'none';
    listaProduccionMasiva = [];
    consolidadoMasiva = null;
}

function buscarRecetaBaseMasiva() {
    const input = document.getElementById('buscar-rb-masiva').value.toUpperCase().trim();
    const contenedor = document.getElementById('resultados-rb-masiva');
    
    if (input.length < 2) {
        contenedor.classList.add('hidden');
        return;
    }
    
    const palabras = input.split(' ').filter(p => p.length > 0);
    const coincidencias = db.recetasBase.filter(rb => {
        return palabras.every(palabra => rb.nombre.includes(palabra));
    }).slice(0, 8);
    
    if (coincidencias.length === 0) {
        contenedor.classList.add('hidden');
        return;
    }
    
    contenedor.innerHTML = coincidencias.map(rb => `
        <div onclick="seleccionarRBMasiva('${rb.sku}', '${rb.nombre.replace(/'/g, "\\'")}', '${rb.unidad}')" 
             class="p-3 hover:bg-purple-50 cursor-pointer border-b border-purple-100">
            <p class="font-bold text-purple-700">${rb.nombre}</p>
            <p class="text-xs text-slate-500">Rinde: ${rb.rendimiento} ${rb.unidad}</p>
        </div>
    `).join('');
    
    contenedor.classList.remove('hidden');
}

function seleccionarRBMasiva(sku, nombre, unidad) {
    document.getElementById('buscar-rb-masiva').value = nombre;
    document.getElementById('rb-masiva-sku-seleccionado').value = sku;
    document.getElementById('resultados-rb-masiva').classList.add('hidden');
    document.getElementById('cantidad-rb-masiva').focus();
}

function agregarRBMasiva() {
    const sku = document.getElementById('rb-masiva-sku-seleccionado').value;
    const cantidad = parseFloat(document.getElementById('cantidad-rb-masiva').value);
    
    if (!sku) {
        alert('‚ö†Ô∏è Selecciona una receta base del buscador');
        return;
    }
    
    if (!cantidad || cantidad <= 0) {
        alert('‚ö†Ô∏è Ingresa una cantidad v√°lida');
        return;
    }
    
    const receta = db.recetasBase.find(r => r.sku === sku);
    if (!receta) {
        alert('‚ùå Receta no encontrada');
        return;
    }
    
    // Verificar si ya est√° en la lista
    const existe = listaProduccionMasiva.findIndex(item => item.sku === sku);
    if (existe !== -1) {
        // Actualizar cantidad
        listaProduccionMasiva[existe].cantidad = cantidad;
    } else {
        // Agregar nueva
        listaProduccionMasiva.push({
            sku: receta.sku,
            nombre: receta.nombre,
            rendimiento: receta.rendimiento,
            unidad: receta.unidad,
            cantidad: cantidad,
            ingredientes: receta.ingredientes,
            instrucciones: receta.instrucciones || ''
        });
    }
    
    // Limpiar campos
    document.getElementById('buscar-rb-masiva').value = '';
    document.getElementById('rb-masiva-sku-seleccionado').value = '';
    document.getElementById('cantidad-rb-masiva').value = '';
    
    // Renderizar lista
    renderListaProduccionMasiva();
    
    // Ocultar consolidado
    document.getElementById('consolidado-masiva').classList.add('hidden');
    consolidadoMasiva = null;
}

function eliminarRBMasiva(sku) {
    listaProduccionMasiva = listaProduccionMasiva.filter(item => item.sku !== sku);
    renderListaProduccionMasiva();
    document.getElementById('consolidado-masiva').classList.add('hidden');
    consolidadoMasiva = null;
}

function renderListaProduccionMasiva() {
    const contenedor = document.getElementById('lista-produccion-masiva');
    
    if (listaProduccionMasiva.length === 0) {
        contenedor.innerHTML = '<p class="text-sm text-slate-400 italic text-center py-8">No hay recetas agregadas a√∫n</p>';
        return;
    }
    
    contenedor.innerHTML = listaProduccionMasiva.map((item, index) => `
        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl p-4">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded">${index + 1}</span>
                        <p class="font-bold text-purple-900">${item.nombre}</p>
                    </div>
                    <div class="flex gap-4 text-sm">
                        <span class="text-slate-600">
                            <strong>Rendimiento base:</strong> ${item.rendimiento} ${item.unidad}
                        </span>
                        <span class="text-purple-700 font-bold">
                            ‚Üí Producir: ${item.cantidad} ${item.unidad}
                        </span>
                        <span class="text-green-700 font-bold">
                            Factor: x${(item.cantidad / item.rendimiento).toFixed(2)}
                        </span>
                    </div>
                </div>
                <button onclick="eliminarRBMasiva('${item.sku}')" class="text-red-600 hover:bg-red-100 px-3 py-1 rounded-lg font-bold">
                    üóëÔ∏è
                </button>
            </div>
        </div>
    `).join('');
}

function limpiarListaProduccionMasiva() {
    listaProduccionMasiva = [];
    consolidadoMasiva = null;
    renderListaProduccionMasiva();
    document.getElementById('consolidado-masiva').classList.add('hidden');
}

function calcularConsolidadoMasiva() {
    if (listaProduccionMasiva.length === 0) {
        alert('‚ö†Ô∏è Agrega al menos una receta base a la lista');
        return;
    }
    
    // Consolidar todos los insumos (EXPLOSIONANDO RECETAS BASE ANIDADAS)
    const consolidado = {};
    
    // Funci√≥n recursiva para explotar recetas base
    function explodirIngredientes(ingredientes, factor) {
        ingredientes.forEach(ing => {
            const material = db.materiales.find(m => m.sku === ing.sku);
            if (!material) return;
            
            // Verificar si es una receta base anidada
            if (material.nombre.startsWith('RB ')) {
                const rbAnidada = db.recetasBase.find(rb => rb.nombre === material.nombre);
                if (rbAnidada) {
                    // Es una RB anidada, explotar sus ingredientes recursivamente
                    const factorAnidado = (ing.cant * factor) / rbAnidada.rendimiento;
                    explodirIngredientes(rbAnidada.ingredientes, factorAnidado);
                    return;
                }
            }
            
            // Es un material real, agregarlo al consolidado
            const cantidadNecesaria = ing.cant * factor;
            
            if (!consolidado[material.sku]) {
                consolidado[material.sku] = {
                    nombre: material.nombre,
                    cantidad: 0,
                    unidad: ing.unidad,
                    uCompra: material.uCompra,
                    factor: material.factor || 1,
                    precio: material.precio || 0
                };
            }
            
            consolidado[material.sku].cantidad += cantidadNecesaria;
        });
    }
    
    // Procesar todas las recetas
    listaProduccionMasiva.forEach(item => {
        const factor = item.cantidad / item.rendimiento;
        explodirIngredientes(item.ingredientes, factor);
    });
    
    // Convertir a array y ordenar
    consolidadoMasiva = Object.values(consolidado).sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    // Renderizar consolidado
    const tabla = `
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-green-600 text-white">
                    <tr>
                        <th class="p-3 text-left">MATERIAL</th>
                        <th class="p-3 text-center">CANTIDAD</th>
                        <th class="p-3 text-center">UNIDAD</th>
                        <th class="p-3 text-center">EN U. COMPRA</th>
                        <th class="p-3 text-right">COSTO</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    ${consolidadoMasiva.map((item, idx) => {
                        const cantidadCompra = item.cantidad / item.factor;
                        const costo = cantidadCompra * item.precio;
                        return `
                            <tr class="${idx % 2 === 0 ? 'bg-green-50' : ''}">
                                <td class="p-3 font-semibold">${item.nombre}</td>
                                <td class="p-3 text-center font-bold text-green-700">${item.cantidad.toFixed(2)}</td>
                                <td class="p-3 text-center">${item.unidad}</td>
                                <td class="p-3 text-center">${cantidadCompra.toFixed(2)} ${item.uCompra}</td>
                                <td class="p-3 text-right font-bold text-green-700">S/. ${costo.toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('')}
                    <tr class="bg-green-700 text-white font-bold">
                        <td colspan="4" class="p-3 text-right">COSTO TOTAL:</td>
                        <td class="p-3 text-right">
                            S/. ${consolidadoMasiva.reduce((sum, item) => sum + ((item.cantidad / item.factor) * item.precio), 0).toFixed(2)}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('tabla-consolidado-masiva').innerHTML = tabla;
    document.getElementById('consolidado-masiva').classList.remove('hidden');
    
    alert('‚úÖ Consolidado calculado correctamente\n\nüí° Las recetas base anidadas fueron explosionadas a materiales reales');
}

function exportarProduccionMasivaPDF() {
    if (listaProduccionMasiva.length === 0) {
        alert('‚ö†Ô∏è Agrega recetas base a la lista');
        return;
    }
    
    if (!consolidadoMasiva) {
        alert('‚ö†Ô∏è Primero calcula el consolidado');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const ahora = new Date();
    
    // ========== PORTADA ==========
    doc.setFillColor(103, 58, 183);
    doc.rect(0, 0, 210, 297, 'F');
    
    // Logo circular
    doc.setFillColor(255, 255, 255);
    doc.circle(105, 80, 30, 'F');
    doc.setFillColor(103, 58, 183);
    doc.circle(105, 80, 25, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(28);
    doc.setFont(undefined, 'bold');
    doc.text('PRODUCCION MASIVA', 105, 130, { align: 'center' });
    doc.setFontSize(20);
    doc.text('DE RECETAS BASE', 105, 142, { align: 'center' });
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'normal');
    doc.text('SWISSOTEL', 105, 165, { align: 'center' });
    doc.setFontSize(10);
    doc.text('HOTELERA COSTA DEL PACIFICO S.A.', 105, 173, { align: 'center' });
    doc.text('RUC: 20297885538', 105, 180, { align: 'center' });
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text(`${listaProduccionMasiva.length} RECETAS BASE`, 105, 200, { align: 'center' });
    
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text(`Fecha: ${ahora.toLocaleDateString('es-PE')} ${ahora.toLocaleTimeString('es-PE')}`, 105, 210, { align: 'center' });
    
    doc.setFontSize(8);
    doc.text('Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego', 105, 280, { align: 'center' });
    
    // ========== CADA RECETA EN SU PROPIA P√ÅGINA ==========
    listaProduccionMasiva.forEach((rb, index) => {
        doc.addPage();
        const factor = rb.cantidad / rb.rendimiento;
        let y = 20;
        
        // Encabezado de p√°gina
        doc.setFillColor(103, 58, 183);
        doc.rect(0, 0, 210, 35, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(`RECETA ${index + 1} de ${listaProduccionMasiva.length}`, 105, 15, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text(cleanTextForPDF(rb.nombre), 105, 25, { align: 'center' });
        
        y = 45;
        
        // Informaci√≥n de producci√≥n
        doc.setFillColor(237, 231, 246);
        doc.roundedRect(14, y, 182, 20, 3, 3, 'F');
        
        doc.setTextColor(103, 58, 183);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('DATOS DE PRODUCCION', 18, y + 7);
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(50, 50, 50);
        doc.text(`Rendimiento base: ${rb.rendimiento} ${rb.unidad}`, 18, y + 13);
        doc.text(`Cantidad a producir: ${rb.cantidad} ${rb.unidad}`, 18, y + 18);
        doc.text(`Factor de escalado: x${factor.toFixed(2)}`, 120, y + 13);
        
        y += 28;
        
        // Tabla de ingredientes
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(103, 58, 183);
        doc.text('INGREDIENTES NECESARIOS', 14, y);
        y += 8;
        
        doc.autoTable({
            startY: y,
            head: [['Material', 'Cantidad', 'Unidad']],
            body: rb.ingredientes.map(ing => {
                const material = db.materiales.find(m => m.sku === ing.sku);
                const nombreMat = material ? material.nombre : ing.nombre;
                const cantidadNecesaria = ing.cant * factor;
                return [
                    cleanTextForPDF(nombreMat),
                    cantidadNecesaria.toFixed(2),
                    ing.unidad
                ];
            }),
            theme: 'grid',
            headStyles: {
                fillColor: [103, 58, 183],
                textColor: [255, 255, 255],
                fontStyle: 'bold',
                fontSize: 9
            },
            styles: {
                fontSize: 9,
                cellPadding: 3
            },
            columnStyles: {
                0: { cellWidth: 120 },
                1: { halign: 'center', cellWidth: 30 },
                2: { halign: 'center', cellWidth: 32 }
            },
            margin: { left: 14, right: 14 }
        });
        
        y = doc.lastAutoTable.finalY + 10;
        
        // ===== INSTRUCCIONES =====
        if (rb.instrucciones && rb.instrucciones.trim()) {
            if (y > 220) {
                doc.addPage();
                y = 20;
                
                // Repetir encabezado
                doc.setFillColor(103, 58, 183);
                doc.rect(0, 0, 210, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(cleanTextForPDF(rb.nombre) + ' (continuacion)', 105, 15, { align: 'center' });
                y = 35;
            }
            
            // Caja de instrucciones
            const instruccionesLimpias = cleanTextForPDF(rb.instrucciones);
            const linesCount = doc.splitTextToSize(instruccionesLimpias, 168).length;
            const boxHeight = Math.min(linesCount * 5 + 20, 100);
            
            doc.setFillColor(255, 251, 235);
            doc.roundedRect(14, y, 182, boxHeight, 3, 3, 'F');
            doc.setDrawColor(251, 191, 36);
            doc.setLineWidth(0.5);
            doc.roundedRect(14, y, 182, boxHeight, 3, 3, 'S');
            
            doc.setTextColor(180, 83, 9);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('INSTRUCCIONES DE PREPARACION', 18, y + 7);
            
            doc.setDrawColor(251, 191, 36);
            doc.setLineWidth(0.3);
            doc.line(18, y + 10, 192, y + 10);
            
            y += 16;
            
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            
            const lines = doc.splitTextToSize(instruccionesLimpias, 168);
            lines.forEach(line => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(line, 18, y);
                y += 4;
            });
        }
        
        // Footer
        doc.setFontSize(7);
        doc.setTextColor(150, 150, 150);
        doc.text(`Receta ${index + 1} de ${listaProduccionMasiva.length}`, 105, 290, { align: 'center' });
    });
    
    // ========== RESUMEN PARA CHEF (RECETAS BASE ANIDADAS) ==========
    doc.addPage();
    
    doc.setFillColor(255, 152, 0); // Orange para Chef
    doc.rect(0, 0, 210, 35, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('RESUMEN PARA CHEF', 105, 15, { align: 'center' });
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('Recetas Base que debes preparar previamente', 105, 24, { align: 'center' });
    
    let y = 50;
    
    // Detectar recetas base anidadas
    const recetasBaseNecesarias = {};
    
    listaProduccionMasiva.forEach(item => {
        const factor = item.cantidad / item.rendimiento;
        
        item.ingredientes.forEach(ing => {
            const material = db.materiales.find(m => m.sku === ing.sku);
            if (material && material.nombre.startsWith('RB ')) {
                const rbAnidada = db.recetasBase.find(rb => rb.nombre === material.nombre);
                if (rbAnidada) {
                    const cantidadNecesaria = ing.cant * factor;
                    
                    if (!recetasBaseNecesarias[rbAnidada.sku]) {
                        recetasBaseNecesarias[rbAnidada.sku] = {
                            nombre: rbAnidada.nombre,
                            cantidad: 0,
                            unidad: rbAnidada.unidad,
                            usadaEn: []
                        };
                    }
                    
                    recetasBaseNecesarias[rbAnidada.sku].cantidad += cantidadNecesaria;
                    recetasBaseNecesarias[rbAnidada.sku].usadaEn.push(item.nombre);
                }
            }
        });
    });
    
    const rbArray = Object.values(recetasBaseNecesarias);
    
    if (rbArray.length > 0) {
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(255, 87, 34);
        doc.text(`NECESITAS PREPARAR ${rbArray.length} RECETA(S) BASE:`, 14, y);
        y += 10;
        
        rbArray.forEach((rb, index) => {
            if (y > 260) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFillColor(255, 243, 224);
            doc.roundedRect(14, y, 182, 18, 2, 2, 'F');
            doc.setDrawColor(255, 152, 0);
            doc.setLineWidth(0.5);
            doc.roundedRect(14, y, 182, 18, 2, 2, 'S');
            
            doc.setTextColor(230, 81, 0);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`${index + 1}. ${cleanTextForPDF(rb.nombre)}`, 18, y + 7);
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`Cantidad total: ${rb.cantidad.toFixed(2)} ${rb.unidad}`, 18, y + 13);
            
            y += 22;
        });
    } else {
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text('No hay recetas base anidadas en esta produccion', 14, y);
    }
    
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.text('Resumen para Chef', 105, 290, { align: 'center' });
    
    // ========== CONSOLIDADO PARA ALMAC√âN ==========
    doc.addPage();
    
    doc.setFillColor(16, 185, 129); // Green
    doc.rect(0, 0, 210, 35, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('CONSOLIDADO PARA ALMACEN', 105, 15, { align: 'center' });
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('Materiales reales a solicitar', 105, 24, { align: 'center' });
    
    y = 50;
    
    doc.autoTable({
        startY: y,
        head: [['Material', 'Cantidad', 'Unidad', 'U. Compra', 'Costo']],
        body: consolidadoMasiva.map(item => {
            const cantCompra = item.cantidad / item.factor;
            const costo = cantCompra * item.precio;
            return [
                cleanTextForPDF(item.nombre),
                item.cantidad.toFixed(2),
                item.unidad,
                `${cantCompra.toFixed(2)} ${item.uCompra}`,
                `S/. ${costo.toFixed(2)}`
            ];
        }),
        foot: [[
            'COSTO TOTAL',
            '',
            '',
            '',
            `S/. ${consolidadoMasiva.reduce((sum, item) => sum + ((item.cantidad / item.factor) * item.precio), 0).toFixed(2)}`
        ]],
        theme: 'grid',
        headStyles: {
            fillColor: [16, 185, 129],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: 9
        },
        footStyles: {
            fillColor: [16, 185, 129],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: 11
        },
        styles: {
            fontSize: 8,
            cellPadding: 3
        },
        columnStyles: {
            0: { cellWidth: 80 },
            1: { halign: 'center', cellWidth: 28 },
            2: { halign: 'center', cellWidth: 22 },
            3: { halign: 'center', cellWidth: 35 },
            4: { halign: 'right', cellWidth: 27 }
        },
        margin: { left: 14, right: 14 },
        didDrawPage: function(data) {
            // Footer en cada p√°gina del consolidado
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('Consolidado para Almacen', 105, 290, { align: 'center' });
        }
    });
    
    // Footer final en todas las p√°ginas
    const totalPages = doc.internal.pages.length - 1;
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(7);
        doc.setTextColor(100, 100, 100);
        doc.text(`Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego - P√°gina ${i} de ${totalPages}`, 105, 290, { align: 'center' });
    }
    
    doc.save(`PRODUCCION_MASIVA_${ahora.toISOString().slice(0, 10)}_${ahora.getHours()}${ahora.getMinutes()}.pdf`);
    alert('‚úÖ PDF exportado correctamente\n\nüìÑ Estructura:\n- Portada\n- 1 p√°gina por receta\n- Resumen para Chef\n- Consolidado para Almac√©n');
}

// ========== FIN PRODUCCI√ìN MASIVA ==========

// ========== GESTI√ìN DE FAMILIAS ==========

// Exportar explosi√≥n de materiales a PDF por familias

// Funci√≥n para normalizar texto (quitar tildes y √±)
function normalizarTexto(texto) {
    if (!texto) return '';
    return texto
        .replace(/√Å/g, 'A').replace(/√â/g, 'E').replace(/√ç/g, 'I').replace(/√ì/g, 'O').replace(/√ö/g, 'U')
        .replace(/√°/g, 'a').replace(/√©/g, 'e').replace(/√≠/g, 'i').replace(/√≥/g, 'o').replace(/√∫/g, 'u')
        .replace(/√ë/g, 'N').replace(/√±/g, 'n')
        .replace(/√ú/g, 'U').replace(/√º/g, 'u');
}

// Exportar explosi√≥n de materiales a PDF por familias

// Funci√≥n para decidir qu√© tipo de PDF exportar
function exportarPDFSegunTipo() {
    const tipo = document.getElementById('tipo-export-pdf').value;
    if (tipo === 'preliminar') {
        exportarVistaPreliminarPDF();
    } else {
        exportarOrdenCompraPDF();
    }
}

// Exportar VISTA PRELIMINAR (componentes directos, CON AGUA FILTRADA)
function exportarVistaPreliminarPDF() {
    if (!lastExplosion || !lastExplosion.componentesDirectos || lastExplosion.componentesDirectos.length === 0) {
        alert('‚ö†Ô∏è Primero calcula la explosi√≥n de materiales');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const componentes = lastExplosion.componentesDirectos;
    
    // Encabezado
    doc.setFillColor(103, 58, 183);
    doc.rect(0, 0, 210, 35, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text(normalizarTexto('VISTA PRELIMINAR DE PRODUCCION'), 14, 17);
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text(normalizarTexto('Componentes Directos - GASTRO CONTROL PRO'), 14, 24);
    const ahora = new Date();
    doc.setFontSize(8);
    doc.text('Fecha: ' + ahora.toLocaleDateString('es-PE') + ' ' + ahora.toLocaleTimeString('es-PE'), 14, 32);
    doc.text('PAX: ' + lastExplosion.pax, 120, 32);
    
    let y = 45;
    let pagina = 1;
    
    // T√≠tulo
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('COMPONENTES NECESARIOS', 14, y);
    y += 8;
    
    // Tabla de componentes
    componentes.forEach((comp, idx) => {
        if (y > 260) {
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('Pagina ' + pagina, 190, 285);
            doc.addPage();
            pagina++;
            y = 20;
        }
        
        // Fondo alternado
        if (idx % 2 === 0) {
            doc.setFillColor(249, 250, 251);
        } else {
            doc.setFillColor(255, 255, 255);
        }
        
        // Color seg√∫n tipo
        if (comp.tipo === 'RECETA BASE') {
            doc.setFillColor(239, 246, 255);
        }
        
        doc.rect(14, y - 3, 182, 10, 'F');
        
        // N√∫mero
        doc.setTextColor(100, 116, 139);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text((idx + 1) + '', 18, y + 3);
        
        // Icono y nombre
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'bold');
        const icono = comp.tipo === 'RECETA BASE' ? 'RB' : 'MAT';
        doc.setFontSize(8);
        if (comp.tipo === 'RECETA BASE') {
            doc.setTextColor(37, 99, 235);
        } else {
            doc.setTextColor(16, 185, 129);
        }
        doc.text(icono, 28, y + 3);
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.text(normalizarTexto(comp.nombre), 40, y + 3);
        
        // Cantidad
        doc.setTextColor(37, 99, 235);
        doc.setFont(undefined, 'bold');
        doc.text(comp.cantidad.toFixed(2), 140, y + 3);
        
        // Unidad
        doc.setTextColor(100, 116, 139);
        doc.setFont(undefined, 'normal');
        doc.text(normalizarTexto(comp.unidad), 160, y + 3);
        
        y += 10;
    });
    
    y += 10;
    
    // Resumen
    const rbCount = componentes.filter(c => c.tipo === 'RECETA BASE').length;
    const matCount = componentes.filter(c => c.tipo === 'MATERIAL').length;
    
    doc.setFillColor(243, 244, 246);
    doc.roundedRect(14, y, 182, 20, 3, 3, 'F');
    
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('Recetas Base:', 20, y + 8);
    doc.text('' + rbCount, 60, y + 8);
    
    doc.text('Materiales:', 20, y + 15);
    doc.text('' + matCount, 60, y + 15);
    
    doc.text('Total PAX:', 110, y + 8);
    doc.text('' + lastExplosion.pax, 150, y + 8);
    
    doc.text('Total Items:', 110, y + 15);
    doc.text('' + componentes.length, 150, y + 15);
    
    // Footer
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.text('Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego', 14, 285);
    doc.text('Pagina ' + pagina, 190, 285);
    
    const nombre = 'VISTA_PRELIMINAR_' + lastExplosion.pax + 'PAX_' + Date.now() + '.pdf';
    doc.save(nombre);
    alert('‚úÖ Vista Preliminar exportada correctamente');
}

// Exportar ORDEN DE COMPRA (disgregado por familias, SIN AGUA FILTRADA)
function exportarOrdenCompraPDF() {
    if (!lastExplosion || !lastExplosion.items || lastExplosion.items.length === 0) {
        alert('‚ö†Ô∏è Primero calcula la explosi√≥n de materiales');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Filtrar AGUA FILTRADA
    const itemsFiltrados = lastExplosion.items.filter(item => {
        return !item.nombre.toUpperCase().includes('AGUA FILTRADA');
    });
    
    // Agrupar por familias
    const porFamilias = {};
    itemsFiltrados.forEach(item => {
        const material = db.materiales.find(m => m.sku === item.sku);
        if (material) {
            const familia = material.familia || 'SIN FAMILIA';
            if (!porFamilias[familia]) {
                porFamilias[familia] = [];
            }
            porFamilias[familia].push({...item, familia: familia});
        }
    });
    
    const familiasOrdenadas = Object.keys(porFamilias).sort();
    
    // Encabezado
    doc.setFillColor(103, 58, 183);
    doc.rect(0, 0, 210, 35, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text(normalizarTexto('ORDEN DE COMPRA'), 40, 17);
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text(normalizarTexto('Explosion de Materiales - GASTRO CONTROL PRO'), 40, 24);
    const ahora = new Date();
    doc.setFontSize(8);
    doc.text('Fecha: ' + ahora.toLocaleDateString('es-PE') + ' ' + ahora.toLocaleTimeString('es-PE'), 14, 32);
    doc.text('PAX: ' + lastExplosion.pax, 90, 32);
    doc.text('Costo: S/. ' + lastExplosion.total, 130, 32);
    
    let y = 45;
    let pagina = 1;
    
    // Resumen
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('RESUMEN', 14, y);
    y += 6;
    doc.setFillColor(243, 244, 246);
    doc.roundedRect(14, y, 182, 20, 3, 3, 'F');
    doc.setFontSize(9);
    doc.text('Costo Total:', 18, y + 7);
    doc.setTextColor(16, 185, 129);
    doc.text('S/. ' + lastExplosion.total, 50, y + 7);
    doc.setTextColor(0, 0, 0);
    doc.text('A Comprar:', 18, y + 14);
    doc.setTextColor(239, 68, 68);
    doc.text('S/. ' + lastExplosion.totalSinStock, 50, y + 14);
    doc.setTextColor(0, 0, 0);
    doc.text('Items:', 110, y + 7);
    doc.text('' + itemsFiltrados.length, 140, y + 7);
    doc.text('PAX:', 110, y + 14);
    doc.text('' + lastExplosion.pax, 140, y + 14);
    y += 28;
    
    // Por familias
    familiasOrdenadas.forEach(familia => {
        const mats = porFamilias[familia];
        if (y > 250) {
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('Pagina ' + pagina, 190, 285);
            doc.addPage();
            pagina++;
            y = 20;
        }
        doc.setFillColor(103, 58, 183);
        doc.roundedRect(14, y, 182, 7, 2, 2, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(normalizarTexto(familia.toUpperCase()), 18, y + 5);
        doc.text('(' + mats.length + ' items)', 160, y + 5);
        y += 10;
        
        mats.forEach((item, idx) => {
            if (y > 270) {
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text('Pagina ' + pagina, 190, 285);
                doc.addPage();
                pagina++;
                y = 20;
            }
            if (idx % 2 === 0) {
                doc.setFillColor(249, 250, 251);
                doc.rect(14, y - 3, 182, 8, 'F');
            }
            if (item.tieneFaltante) {
                doc.setFillColor(254, 242, 242);
                doc.rect(14, y - 3, 182, 8, 'F');
            }
            doc.setTextColor(100, 116, 139);
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text((idx + 1) + '', 18, y + 2);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            doc.text(normalizarTexto(item.nombre), 28, y + 2);
            doc.setTextColor(37, 99, 235);
            doc.text(item.reqTotal, 120, y + 2);
            doc.setTextColor(100, 116, 139);
            doc.setFont(undefined, 'normal');
            doc.text(normalizarTexto(item.unid), 135, y + 2);
            const stockNum = parseFloat(item.stock);
            doc.setTextColor(stockNum > 0 ? 34 : 239, stockNum > 0 ? 197 : 68, stockNum > 0 ? 94 : 68);
            doc.setFont(undefined, 'bold');
            doc.text(item.stock, 150, y + 2);
            if (item.tieneFaltante) {
                doc.setFillColor(220, 38, 38);
                doc.roundedRect(165, y - 2, 28, 5, 1, 1, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(7);
                doc.text('COMPRAR', 167, y + 1.5);
            } else {
                doc.setFillColor(34, 197, 94);
                doc.roundedRect(165, y - 2, 28, 5, 1, 1, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(7);
                doc.text('OK STOCK', 167, y + 1.5);
            }
            y += 8;
        });
        y += 3;
    });
    
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.text('Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego', 14, 285);
    doc.text('Pagina ' + pagina, 190, 285);
    
    const nombre = 'ORDEN_COMPRA_' + lastExplosion.pax + 'PAX_' + Date.now() + '.pdf';
    doc.save(nombre);
    alert('‚úÖ Orden de Compra exportada correctamente');
}
function agregarFamilia() {
    const nombre = document.getElementById('familia-input').value.trim().toUpperCase();
    
    if(!nombre) {
        alert("‚ö†Ô∏è Ingresa el nombre de la familia");
        return;
    }
    
    if(db.familias.includes(nombre)) {
        alert("‚ö†Ô∏è Esta familia ya existe");
        return;
    }
    
    db.familias.push(nombre);
    db.familias.sort(); // Ordenar alfab√©ticamente
    save();
    renderFamilias();
    document.getElementById('familia-input').value = '';
    updateFamiliasDropdown();
    alert("‚úÖ Familia agregada correctamente");
}

function eliminarFamilia(nombre) {
    // Verificar si hay materiales usando esta familia
    const materialesConFamilia = db.materiales.filter(m => m.familia === nombre);
    
    if(materialesConFamilia.length > 0) {
        if(!confirm(`‚ö†Ô∏è Hay ${materialesConFamilia.length} materiales usando esta familia.\n¬øDeseas eliminarla de todos modos?`)) {
            return;
        }
    }
    
    db.familias = db.familias.filter(f => f !== nombre);
    save();
    renderFamilias();
    updateFamiliasDropdown();
    alert("‚úÖ Familia eliminada correctamente");
}

function editarFamilia(nombre) {
    // Llenar el formulario
    document.getElementById('edit-familia-nombre-original').value = nombre;
    document.getElementById('edit-familia-nombre').value = nombre;
    
    // Mostrar modal
    document.getElementById('modalEditarFamilia').style.display = 'flex';
}

function cerrarModalEditarFamilia() {
    document.getElementById('modalEditarFamilia').style.display = 'none';
    document.getElementById('edit-familia-nombre-original').value = '';
    document.getElementById('edit-familia-nombre').value = '';
}

function guardarEdicionFamilia() {
    const nombreOriginal = document.getElementById('edit-familia-nombre-original').value;
    const nombreNuevo = document.getElementById('edit-familia-nombre').value.trim().toUpperCase();
    
    if (!nombreNuevo) {
        alert("‚ö†Ô∏è Ingresa el nombre de la familia");
        return;
    }
    
    // Verificar si el nuevo nombre ya existe (y no es el mismo)
    if (nombreNuevo !== nombreOriginal && db.familias.includes(nombreNuevo)) {
        alert("‚ö†Ô∏è Ya existe una familia con ese nombre");
        return;
    }
    
    // Encontrar √≠ndice de la familia
    const index = db.familias.indexOf(nombreOriginal);
    
    if (index === -1) {
        alert("‚ö†Ô∏è Error: Familia no encontrada");
        return;
    }
    
    // Actualizar familia
    db.familias[index] = nombreNuevo;
    db.familias.sort(); // Reordenar alfab√©ticamente
    
    // Si el nombre cambi√≥, actualizar todos los materiales que usen esta familia
    if (nombreNuevo !== nombreOriginal) {
        db.materiales.forEach(material => {
            if (material.familia === nombreOriginal) {
                material.familia = nombreNuevo;
            }
        });
    }
    
    save();
    renderFamilias();
    updateFamiliasDropdown();
    cerrarModalEditarFamilia();
    
    alert("‚úÖ Familia actualizada correctamente");
}

function renderFamilias() {
    const container = document.getElementById('lista-familias');
    
    if(!db.familias || db.familias.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-8 text-slate-400">
                <p class="font-bold">No hay familias registradas</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = db.familias.map(familia => {
        const countMateriales = db.materiales.filter(m => m.familia === familia).length;
        
        return `
            <div class="bg-white border-2 border-indigo-200 rounded-xl p-4 hover:shadow-lg transition-all">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                        <p class="font-black text-sm text-indigo-700">${familia}</p>
                        <p class="text-xs text-slate-500 font-semibold mt-1">${countMateriales} materiales</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editarFamilia('${familia}')" 
                                class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-lg font-bold text-xs hover:bg-indigo-200 btn-action">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="eliminarFamilia('${familia}')" 
                                class="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-bold text-xs hover:bg-red-200 btn-action">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}


// ========== GESTI√ìN DE CATEGOR√çAS ==========
function agregarCategoria() {
    const nombre = document.getElementById('categoria-input').value.trim().toUpperCase();
    const margen = parseFloat(document.getElementById('categoria-margen').value);
    
    if(!nombre) {
        alert("‚ö†Ô∏è Ingresa el nombre de la categor√≠a");
        return;
    }
    
    if(!margen || margen <= 0 || margen > 100) {
        alert("‚ö†Ô∏è Ingresa un margen FC% v√°lido (entre 1 y 100)");
        return;
    }
    
    if(!db.categorias) db.categorias = [];
    
    // Verificar si ya existe (ahora comparamos por nombre del objeto)
    if(db.categorias.find(cat => cat.nombre === nombre)) {
        alert("‚ö†Ô∏è Esta categor√≠a ya existe");
        return;
    }
    
    db.categorias.push({ nombre, margen });
    db.categorias.sort((a, b) => a.nombre.localeCompare(b.nombre)); // Ordenar alfab√©ticamente
    save();
    renderCategorias();
    document.getElementById('categoria-input').value = '';
    document.getElementById('categoria-margen').value = '';
    updateCategoriasDropdown();
    
    // Actualizar tabs del POS si est√° abierto
    if (typeof generarTabsCategorias === 'function') {
        var tabsContainer = document.getElementById('tabs-categorias-pos');
        if (tabsContainer) {
            generarTabsCategorias();
            renderMenuPOS();
        }
    }
    
    alert("‚úÖ Categor√≠a agregada correctamente");
}

function eliminarCategoria(nombre) {
    // Verificar si hay platos usando esta categor√≠a
    const platosConCategoria = db.platos.filter(p => p.categoria === nombre);
    
    if(platosConCategoria.length > 0) {
        if(!confirm(`‚ö†Ô∏è Hay ${platosConCategoria.length} platos usando esta categor√≠a.\n¬øDeseas eliminarla de todos modos?`)) {
            return;
        }
    }
    
    if(!db.categorias) db.categorias = [];
    db.categorias = db.categorias.filter(c => c.nombre !== nombre);
    save();
    renderCategorias();
    updateCategoriasDropdown();
    
    // Actualizar tabs del POS si est√° abierto
    if (typeof generarTabsCategorias === 'function') {
        var tabsContainer = document.getElementById('tabs-categorias-pos');
        if (tabsContainer) {
            generarTabsCategorias();
            renderMenuPOS();
        }
    }
    
    alert("‚úÖ Categor√≠a eliminada correctamente");
}

function editarCategoria(nombre) {
    const categoriaObj = db.categorias.find(cat => {
        const catNombre = typeof cat === 'string' ? cat : cat.nombre;
        return catNombre === nombre;
    });
    
    if (!categoriaObj) {
        alert("‚ö†Ô∏è Categor√≠a no encontrada");
        return;
    }
    
    // Convertir a objeto si es string
    const catObj = typeof categoriaObj === 'string' ? { nombre: categoriaObj, margen: 29 } : categoriaObj;
    
    // Llenar el formulario
    document.getElementById('edit-categoria-nombre-original').value = catObj.nombre;
    document.getElementById('edit-categoria-nombre').value = catObj.nombre;
    document.getElementById('edit-categoria-margen').value = catObj.margen;
    
    // Mostrar modal
    document.getElementById('modalEditarCategoria').style.display = 'flex';
}

function cerrarModalEditarCategoria() {
    document.getElementById('modalEditarCategoria').style.display = 'none';
    document.getElementById('edit-categoria-nombre-original').value = '';
    document.getElementById('edit-categoria-nombre').value = '';
    document.getElementById('edit-categoria-margen').value = '';
}

function guardarEdicionCategoria() {
    const nombreOriginal = document.getElementById('edit-categoria-nombre-original').value;
    const nombreNuevo = document.getElementById('edit-categoria-nombre').value.trim().toUpperCase();
    const margenNuevo = parseFloat(document.getElementById('edit-categoria-margen').value);
    
    if (!nombreNuevo) {
        alert("‚ö†Ô∏è Ingresa el nombre de la categor√≠a");
        return;
    }
    
    if (!margenNuevo || margenNuevo <= 0 || margenNuevo > 100) {
        alert("‚ö†Ô∏è Ingresa un margen FC% v√°lido (entre 1 y 100)");
        return;
    }
    
    // Verificar si el nuevo nombre ya existe (y no es el mismo)
    if (nombreNuevo !== nombreOriginal) {
        const existeNuevo = db.categorias.find(cat => {
            const catNombre = typeof cat === 'string' ? cat : cat.nombre;
            return catNombre === nombreNuevo;
        });
        
        if (existeNuevo) {
            alert("‚ö†Ô∏è Ya existe una categor√≠a con ese nombre");
            return;
        }
    }
    
    // Encontrar √≠ndice de la categor√≠a
    const index = db.categorias.findIndex(cat => {
        const catNombre = typeof cat === 'string' ? cat : cat.nombre;
        return catNombre === nombreOriginal;
    });
    
    if (index === -1) {
        alert("‚ö†Ô∏è Error: Categor√≠a no encontrada");
        return;
    }
    
    // Actualizar categor√≠a
    db.categorias[index] = { nombre: nombreNuevo, margen: margenNuevo };
    
    // Si el nombre cambi√≥, actualizar todos los platos que usen esta categor√≠a
    if (nombreNuevo !== nombreOriginal) {
        db.platos.forEach(plato => {
            if (plato.categoria === nombreOriginal) {
                plato.categoria = nombreNuevo;
            }
        });
    }
    
    save();
    renderCategorias();
    updateCategoriasDropdown();
    cerrarModalEditarCategoria();
    
    // Actualizar tabs del POS si est√° abierto
    if (typeof generarTabsCategorias === 'function') {
        var tabsContainer = document.getElementById('tabs-categorias-pos');
        if (tabsContainer) {
            generarTabsCategorias();
            renderMenuPOS();
        }
    }
    
    alert("‚úÖ Categor√≠a actualizada correctamente");
}

function renderCategorias() {
    const container = document.getElementById('lista-categorias');
    
    if(!container) return; // Si no existe el container, salir
    
    if(!db.categorias) db.categorias = [];
    
    if(db.categorias.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-8 text-slate-400">
                <p class="font-bold">No hay categor√≠as registradas</p>
                <p class="text-xs mt-2">Agrega categor√≠as para organizar tu men√∫</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = db.categorias.map(categoria => {
        // Compatibilidad: Si es string (formato antiguo), convertir a objeto
        const catObj = typeof categoria === 'string' ? { nombre: categoria, margen: 29 } : categoria;
        
        const countPlatos = db.platos.filter(p => p.categoria === catObj.nombre).length;
        const emoji = emojisCategoria[catObj.nombre] || 'üçΩÔ∏è';
        
        return `
            <div class="bg-white border-2 border-blue-200 rounded-xl p-4 hover:shadow-lg transition-all">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                        <p class="font-black text-sm text-blue-700">${emoji} ${catObj.nombre}</p>
                        <p class="text-xs text-slate-500 font-semibold mt-1">${countPlatos} platos</p>
                        <p class="text-xs text-emerald-600 font-bold mt-1">üìä Margen FC: ${catObj.margen}%</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editarCategoria('${catObj.nombre}')" 
                                class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg font-bold text-xs hover:bg-blue-200 btn-action">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="eliminarCategoria('${catObj.nombre}')" 
                                class="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-bold text-xs hover:bg-red-200 btn-action">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// ========== GESTI√ìN DE √ÅREAS ==========
function agregarArea() {
    const nombre = document.getElementById('area-input').value.trim();
    
    if(!nombre) {
        alert("‚ö†Ô∏è Ingresa el nombre del √°rea");
        return;
    }
    
    if(!db.areas) db.areas = [];
    
    // Verificar si ya existe
    if(db.areas.includes(nombre)) {
        alert("‚ö†Ô∏è Esta √°rea ya existe");
        return;
    }
    
    db.areas.push(nombre);
    db.areas.sort(); // Ordenar alfab√©ticamente
    save();
    renderAreas();
    document.getElementById('area-input').value = '';
    updateAreasDropdown();
    
    alert("‚úÖ √Årea agregada correctamente");
}

function eliminarArea(nombre) {
    // Verificar si hay platos usando esta √°rea
    const platosConArea = db.platos.filter(p => p.cocina === nombre);
    
    if(platosConArea.length > 0) {
        if(!confirm(`‚ö†Ô∏è Hay ${platosConArea.length} platos asignados a esta √°rea.\n¬øDeseas eliminarla de todos modos?`)) {
            return;
        }
    }
    
    if(!db.areas) db.areas = [];
    db.areas = db.areas.filter(a => a !== nombre);
    save();
    renderAreas();
    updateAreasDropdown();
    
    alert("‚úÖ √Årea eliminada correctamente");
}

function editarArea(nombreAntiguo) {
    const nuevoNombre = prompt(`Editar √°rea:\n\nNombre actual: ${nombreAntiguo}\n\nIngresa el nuevo nombre:`, nombreAntiguo);
    
    if (!nuevoNombre || nuevoNombre.trim() === '') {
        return;
    }
    
    const nombre = nuevoNombre.trim();
    
    if (nombre === nombreAntiguo) {
        alert("‚ö†Ô∏è El nuevo nombre es igual al anterior");
        return;
    }
    
    if (db.areas.includes(nombre)) {
        alert("‚ö†Ô∏è Ya existe un √°rea con ese nombre");
        return;
    }
    
    // Actualizar √°rea
    const index = db.areas.indexOf(nombreAntiguo);
    if (index > -1) {
        db.areas[index] = nombre;
    }
    
    // Actualizar platos que usen esta √°rea
    db.platos.forEach(plato => {
        if (plato.cocina === nombreAntiguo) {
            plato.cocina = nombre;
        }
    });
    
    db.areas.sort();
    save();
    renderAreas();
    updateAreasDropdown();
    renderPlatos();
    
    alert("‚úÖ √Årea actualizada correctamente");
}

function renderAreas() {
    const container = document.getElementById('lista-areas');
    
    if(!container) return;
    
    if(!db.areas) db.areas = [];
    
    if(db.areas.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-slate-400">
                <p class="font-bold">No hay √°reas registradas</p>
                <p class="text-xs mt-2">Agrega √°reas operativas</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = db.areas.map(area => {
        const countPlatos = db.platos.filter(p => p.cocina === area).length;
        const emoji = emojisAreas[area] || 'üè¢';
        
        return `
            <div class="bg-white border-2 border-green-200 rounded-xl p-4 hover:shadow-lg transition-all">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                        <p class="font-black text-sm text-green-700">${emoji} ${area}</p>
                        <p class="text-xs text-slate-500 font-semibold mt-1">${countPlatos} platos</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editarArea('${area.replace(/'/g, "\\'")}')" 
                                class="bg-green-100 text-green-600 px-3 py-1 rounded-lg font-bold text-xs hover:bg-green-200 btn-action">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="eliminarArea('${area.replace(/'/g, "\\'")}')" 
                                class="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-bold text-xs hover:bg-red-200 btn-action">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function updateAreasDropdown() {
    if(!db.areas) db.areas = [];
    
    // Actualizar dropdown en formulario de platos
    const selectPlato = document.getElementById('p-cocina');
    if(selectPlato) {
        const areaActual = selectPlato.value;
        selectPlato.innerHTML = '<option value="">-- Selecciona √°rea --</option>' + 
            db.areas.map(area => {
                const emoji = emojisAreas[area] || 'üè¢';
                return `<option value="${area}">${emoji} ${area}</option>`;
            }).join('');
        
        if(areaActual && db.areas.includes(areaActual)) {
            selectPlato.value = areaActual;
        }
    }
    
    // Actualizar filtro de PDF
    const selectPDF = document.getElementById('filter-cocina-pdf');
    if(selectPDF) {
        const areaActual = selectPDF.value;
        selectPDF.innerHTML = '<option value="">üè® TODAS LAS √ÅREAS</option>' + 
            db.areas.map(area => {
                const emoji = emojisAreas[area] || 'üè¢';
                return `<option value="${area}">${emoji} ${area}</option>`;
            }).join('');
        
        if(areaActual && db.areas.includes(areaActual)) {
            selectPDF.value = areaActual;
        }
    }
}


// ========== GESTI√ìN DE AL√âRGENOS ==========
function agregarAlergeno() {
    const nombre = document.getElementById('alergeno-input').value.trim().toUpperCase();
    
    if(!nombre) {
        alert("‚ö†Ô∏è Ingresa el nombre del al√©rgeno");
        return;
    }
    
    if(!db.alergenos) db.alergenos = [];
    
    if(db.alergenos.includes(nombre)) {
        alert("‚ö†Ô∏è Este al√©rgeno ya existe");
        return;
    }
    
    db.alergenos.push(nombre);
    db.alergenos.sort(); // Ordenar alfab√©ticamente
    save();
    renderAlergenos();
    renderAlergenosCheckboxes();
    updateAlergenosFilter();
    document.getElementById('alergeno-input').value = '';
    alert("‚úÖ Al√©rgeno agregado correctamente");
}

function eliminarAlergeno(nombre) {
    // Verificar si hay materiales usando este al√©rgeno
    const materialesConAlergeno = db.materiales.filter(m => 
        m.alergenos && m.alergenos.includes(nombre)
    );
    
    if(materialesConAlergeno.length > 0) {
        if(!confirm(`‚ö†Ô∏è Hay ${materialesConAlergeno.length} materiales con este al√©rgeno.\n¬øDeseas eliminarlo de todos modos?`)) {
            return;
        }
        
        // Eliminar el al√©rgeno de todos los materiales
        db.materiales.forEach(m => {
            if(m.alergenos) {
                m.alergenos = m.alergenos.filter(a => a !== nombre);
            }
        });
    }
    
    if(!db.alergenos) db.alergenos = [];
    db.alergenos = db.alergenos.filter(a => a !== nombre);
    save();
    renderAlergenos();
    renderAlergenosCheckboxes();
    updateAlergenosFilter();
    renderMaterials();
    alert("‚úÖ Al√©rgeno eliminado correctamente");
}

function renderAlergenos() {
    const container = document.getElementById('lista-alergenos');
    
    if(!container) return;
    
    if(!db.alergenos) db.alergenos = [];
    
    if(db.alergenos.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-8 text-slate-400">
                <p class="font-bold">No hay al√©rgenos registrados</p>
                <p class="text-xs mt-2">Agrega al√©rgenos para identificar ingredientes</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = db.alergenos.map(alergeno => {
        const countMateriales = db.materiales.filter(m => 
            m.alergenos && m.alergenos.includes(alergeno)
        ).length;
        
        return `
            <div class="bg-white border-2 border-red-200 rounded-xl p-4 hover:shadow-lg transition-all">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                        <p class="font-black text-sm text-red-700">‚ö†Ô∏è ${alergeno}</p>
                        <p class="text-xs text-slate-500 font-semibold mt-1">${countMateriales} materiales</p>
                    </div>
                    <button onclick="eliminarAlergeno('${alergeno}')" 
                            class="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-bold text-xs hover:bg-red-200 btn-action">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function renderAlergenosCheckboxes() {
    const container = document.getElementById('m-alergenos-container');
    
    if(!container) return;
    
    if(!db.alergenos) db.alergenos = [];
    
    if(db.alergenos.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-4 text-slate-400">
                <p class="text-xs font-bold">No hay al√©rgenos registrados</p>
                <p class="text-xs mt-1">Ve a FAMILIAS para agregar al√©rgenos</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = db.alergenos.map(alergeno => `
        <label class="flex items-center gap-2 p-2 rounded-lg border-2 border-slate-200 hover:border-red-400 hover:bg-red-50 cursor-pointer transition-all">
            <input type="checkbox" class="alergeno-check w-4 h-4" value="${alergeno}">
            <span class="text-xs font-bold text-slate-700">‚ö†Ô∏è ${alergeno}</span>
        </label>
    `).join('');
}

function updateAlergenosFilter() {
    const filterSelect = document.getElementById('filter-alergenos');
    if (!filterSelect) return;
    
    if (!db.alergenos) db.alergenos = [];
    
    const currentValue = filterSelect.value;
    
    filterSelect.innerHTML = '<option value="">üîç Filtrar por al√©rgeno</option>' + 
        db.alergenos.sort().map(alergeno => 
            `<option value="${alergeno}">${alergeno}</option>`
        ).join('');
    
    // Restaurar valor seleccionado si existe
    if (currentValue && db.alergenos.includes(currentValue)) {
        filterSelect.value = currentValue;
    }
}



// ========== GESTI√ìN DE DESCUENTOS ==========
function guardarDescuento() {
    const nombre = document.getElementById('descuento-nombre').value.trim().toUpperCase();
    const tipo = document.getElementById('descuento-tipo').value;
    const valor = parseFloat(document.getElementById('descuento-valor').value);
    const id = document.getElementById('descuento-id-hidden').value;
    
    if(!nombre || isNaN(valor) || valor <= 0) {
        alert('‚ö†Ô∏è Completa todos los campos correctamente');
        return;
    }
    
    // Validar porcentaje
    if(tipo === 'porcentaje' && valor > 100) {
        alert('‚ö†Ô∏è El porcentaje no puede ser mayor a 100%');
        return;
    }
    
    if(!db.descuentos) db.descuentos = [];
    
    const descuentoData = {
        id: id || Date.now().toString(),
        nombre,
        tipo,
        valor,
        activo: true,
        fechaCreacion: new Date().toISOString()
    };
    
    if(id) {
        // Editar
        const idx = db.descuentos.findIndex(d => d.id === id);
        if(idx > -1) {
            db.descuentos[idx] = descuentoData;
        }
    } else {
        // Nuevo
        // Verificar duplicados
        if(db.descuentos.some(d => d.nombre === nombre)) {
            alert('‚ö†Ô∏è Ya existe un descuento con ese nombre');
            return;
        }
        db.descuentos.push(descuentoData);
    }
    
    save();
    renderDescuentos();
    limpiarFormDescuento();
    alert('‚úÖ Descuento guardado correctamente');
}

function renderDescuentos() {
    const container = document.getElementById('lista-descuentos');
    if(!container) return;
    
    if(!db.descuentos) db.descuentos = [];
    
    if(db.descuentos.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-12 text-slate-400">
                <div class="text-6xl mb-4">üéüÔ∏è</div>
                <p class="font-bold text-lg">No hay descuentos registrados</p>
                <p class="text-sm mt-2">Crea descuentos para aplicar en las ventas</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = db.descuentos.map(desc => {
        const iconoTipo = desc.tipo === 'porcentaje' ? 'üìä' : 'üíµ';
        const valorTexto = desc.tipo === 'porcentaje' ? `${desc.valor}%` : `S/. ${desc.valor.toFixed(2)}`;
        const estadoColor = desc.activo ? 'emerald' : 'slate';
        const estadoTexto = desc.activo ? 'ACTIVO' : 'INACTIVO';
        
        return `
            <div class="bg-white border-2 border-${estadoColor}-200 rounded-xl p-5 hover:shadow-lg transition-all">
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <p class="font-black text-base text-${estadoColor}-700">${iconoTipo} ${desc.nombre}</p>
                        <p class="text-2xl font-black text-${estadoColor}-600 mt-2">${valorTexto}</p>
                    </div>
                    <span class="px-2 py-1 bg-${estadoColor}-100 text-${estadoColor}-700 rounded-lg text-xs font-bold">
                        ${estadoTexto}
                    </span>
                </div>
                <p class="text-xs text-slate-500 mb-3">
                    Tipo: ${desc.tipo === 'porcentaje' ? 'Porcentaje' : 'Monto Fijo'}
                </p>
                <div class="flex gap-2">
                    <button onclick="editarDescuento('${desc.id}')" 
                            class="flex-1 bg-blue-100 text-blue-600 px-3 py-2 rounded-lg font-bold text-xs hover:bg-blue-200 btn-action">
                        ‚úèÔ∏è EDITAR
                    </button>
                    <button onclick="toggleDescuento('${desc.id}')" 
                            class="flex-1 bg-amber-100 text-amber-600 px-3 py-2 rounded-lg font-bold text-xs hover:bg-amber-200 btn-action">
                        ${desc.activo ? '‚è∏Ô∏è DESACTIVAR' : '‚ñ∂Ô∏è ACTIVAR'}
                    </button>
                    <button onclick="eliminarDescuento('${desc.id}')" 
                            class="bg-red-100 text-red-600 px-3 py-2 rounded-lg font-bold text-xs hover:bg-red-200 btn-action">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function editarDescuento(id) {
    const desc = db.descuentos.find(d => d.id === id);
    if(!desc) return;
    
    document.getElementById('descuento-id-hidden').value = desc.id;
    document.getElementById('descuento-nombre').value = desc.nombre;
    document.getElementById('descuento-tipo').value = desc.tipo;
    document.getElementById('descuento-valor').value = desc.valor;
    
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function eliminarDescuento(id) {
    if(!confirm('¬øEliminar este descuento?')) return;
    
    const idx = db.descuentos.findIndex(d => d.id === id);
    if(idx > -1) {
        db.descuentos.splice(idx, 1);
        save();
        renderDescuentos();
        alert('‚úÖ Descuento eliminado');
    }
}

function toggleDescuento(id) {
    const desc = db.descuentos.find(d => d.id === id);
    if(!desc) return;
    
    desc.activo = !desc.activo;
    save();
    renderDescuentos();
    alert(`‚úÖ Descuento ${desc.activo ? 'activado' : 'desactivado'}`);
}

function limpiarFormDescuento() {
    document.getElementById('descuento-id-hidden').value = '';
    document.getElementById('descuento-nombre').value = '';
    document.getElementById('descuento-tipo').value = 'porcentaje';
    document.getElementById('descuento-valor').value = '';
}


// ========== GESTI√ìN DE TRIBUTARIOS (IGV, RENTA) ==========
function registrarTributario() {
    const tipo = document.getElementById('tributario-tipo').value;
    const periodo = document.getElementById('tributario-periodo').value.trim();
    const monto = parseFloat(document.getElementById('tributario-monto').value);
    const fecha = document.getElementById('tributario-fecha').value;
    const comprobante = document.getElementById('tributario-comprobante').value.trim();
    const id = document.getElementById('tributario-id-hidden').value;
    
    if(!tipo || !periodo || isNaN(monto) || monto <= 0 || !fecha) {
        alert('‚ö†Ô∏è Completa todos los campos obligatorios');
        return;
    }
    
    if(!db.tributarios) db.tributarios = [];
    
    const tributario = {
        id: id || Date.now().toString(),
        tipo,
        periodo,
        monto,
        fecha,
        comprobante,
        fechaRegistro: new Date().toISOString()
    };
    
    if(id) {
        const idx = db.tributarios.findIndex(t => t.id === id);
        if(idx > -1) db.tributarios[idx] = tributario;
    } else {
        db.tributarios.push(tributario);
    }
    
    save();
    limpiarFormTributario();
    renderTributarios();
    calcularResumenTributario();
    calcularFinanzas();
    alert('‚úÖ Pago tributario registrado correctamente');
}

function renderTributarios() {
    const container = document.getElementById('lista-tributarios');
    if(!container) return;
    
    if(!db.tributarios) db.tributarios = [];
    
    if(db.tributarios.length === 0) {
        container.innerHTML = `
            <tr><td colspan="6" class="p-8 text-center text-slate-400">
                <div class="text-4xl mb-2">üìã</div>
                No hay pagos tributarios registrados
            </td></tr>
        `;
        return;
    }
    
    container.innerHTML = db.tributarios.slice().reverse().map(t => {
        const fecha = new Date(t.fecha);
        const iconoTipo = t.tipo === 'IGV' ? 'üìä' : t.tipo === 'RENTA' ? 'üíº' : 'üìã';
        
        return `
            <tr class="hover:bg-orange-50 transition-colors">
                <td class="p-4">
                    <span class="px-3 py-1 rounded-lg font-bold text-xs bg-orange-100 text-orange-700">
                        ${iconoTipo} ${t.tipo}
                    </span>
                </td>
                <td class="p-4 font-semibold">${t.periodo}</td>
                <td class="p-4 text-right font-bold text-orange-600">S/. ${t.monto.toFixed(2)}</td>
                <td class="p-4 text-center">${fecha.toLocaleDateString('es-PE')}</td>
                <td class="p-4">${t.comprobante || '-'}</td>
                <td class="p-4 text-right">
                    <button onclick="editarTributario('${t.id}')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg font-bold hover:bg-blue-200 text-xs mr-2">
                        ‚úèÔ∏è
                    </button>
                    <button onclick="eliminarTributario('${t.id}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-bold hover:bg-red-200 text-xs">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function calcularResumenTributario() {
    if(!db.tributarios) db.tributarios = [];
    
    const totalIGV = db.tributarios.filter(t => t.tipo === 'IGV').reduce((sum, t) => sum + t.monto, 0);
    const totalRenta = db.tributarios.filter(t => t.tipo === 'RENTA').reduce((sum, t) => sum + t.monto, 0);
    const totalTributario = db.tributarios.reduce((sum, t) => sum + t.monto, 0);
    
    const elemIGV = document.getElementById('total-igv-pagado');
    const elemRenta = document.getElementById('total-renta-pagada');
    const elemTotal = document.getElementById('total-tributario');
    
    if(elemIGV) elemIGV.textContent = 'S/. ' + totalIGV.toFixed(2);
    if(elemRenta) elemRenta.textContent = 'S/. ' + totalRenta.toFixed(2);
    if(elemTotal) elemTotal.textContent = 'S/. ' + totalTributario.toFixed(2);
}

function editarTributario(id) {
    const t = db.tributarios.find(x => x.id === id);
    if(!t) return;
    
    document.getElementById('tributario-id-hidden').value = t.id;
    document.getElementById('tributario-tipo').value = t.tipo;
    document.getElementById('tributario-periodo').value = t.periodo;
    document.getElementById('tributario-monto').value = t.monto;
    document.getElementById('tributario-fecha').value = t.fecha;
    document.getElementById('tributario-comprobante').value = t.comprobante || '';
    
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function eliminarTributario(id) {
    if(!confirm('¬øEliminar este pago tributario?')) return;
    
    const idx = db.tributarios.findIndex(t => t.id === id);
    if(idx > -1) {
        db.tributarios.splice(idx, 1);
        save();
        renderTributarios();
        calcularResumenTributario();
        calcularFinanzas();
        alert('‚úÖ Pago eliminado');
    }
}

function limpiarFormTributario() {
    document.getElementById('tributario-id-hidden').value = '';
    document.getElementById('tributario-tipo').value = '';
    document.getElementById('tributario-periodo').value = '';
    document.getElementById('tributario-monto').value = '';
    document.getElementById('tributario-fecha').value = '';
    document.getElementById('tributario-comprobante').value = '';
}


// ========== GESTI√ìN DE CARGAS LABORALES (ESSALUD, AFP, ONP) ==========
function registrarCarga() {
    const empleado = document.getElementById('carga-empleado').value;
    const tipo = document.getElementById('carga-tipo').value;
    const periodo = document.getElementById('carga-periodo').value.trim();
    const monto = parseFloat(document.getElementById('carga-monto').value);
    const fecha = document.getElementById('carga-fecha').value;
    const comprobante = document.getElementById('carga-comprobante').value.trim();
    const id = document.getElementById('carga-id-hidden').value;
    
    if(!empleado || !tipo || !periodo || isNaN(monto) || monto <= 0 || !fecha) {
        alert('‚ö†Ô∏è Completa todos los campos obligatorios');
        return;
    }
    
    if(!db.cargasLaborales) db.cargasLaborales = [];
    
    const carga = {
        id: id || Date.now().toString(),
        empleado,
        tipo,
        periodo,
        monto,
        fecha,
        comprobante,
        fechaRegistro: new Date().toISOString()
    };
    
    if(id) {
        const idx = db.cargasLaborales.findIndex(c => c.id === id);
        if(idx > -1) db.cargasLaborales[idx] = carga;
    } else {
        db.cargasLaborales.push(carga);
    }
    
    save();
    limpiarFormCarga();
    renderCargasLaborales();
    calcularResumenCargas();
    calcularFinanzas();
    alert('‚úÖ Carga laboral registrada correctamente');
}

function renderCargasLaborales() {
    const container = document.getElementById('lista-cargas');
    if(!container) return;
    
    if(!db.cargasLaborales) db.cargasLaborales = [];
    
    if(db.cargasLaborales.length === 0) {
        container.innerHTML = `
            <tr><td colspan="7" class="p-8 text-center text-slate-400">
                <div class="text-4xl mb-2">üë∑</div>
                No hay cargas laborales registradas
            </td></tr>
        `;
        return;
    }
    
    container.innerHTML = db.cargasLaborales.slice().reverse().map(c => {
        const fecha = new Date(c.fecha);
        const emp = db.empleados.find(e => e.id === c.empleado);
        const nombreEmp = emp ? emp.nombre : 'Empleado eliminado';
        const iconoTipo = c.tipo === 'ESSALUD' ? 'üè•' : c.tipo === 'AFP' ? 'üí∞' : c.tipo === 'ONP' ? 'üèõÔ∏è' : 'üõ°Ô∏è';
        
        return `
            <tr class="hover:bg-teal-50 transition-colors">
                <td class="p-4 font-semibold">${nombreEmp}</td>
                <td class="p-4">
                    <span class="px-3 py-1 rounded-lg font-bold text-xs bg-teal-100 text-teal-700">
                        ${iconoTipo} ${c.tipo}
                    </span>
                </td>
                <td class="p-4">${c.periodo}</td>
                <td class="p-4 text-right font-bold text-teal-600">S/. ${c.monto.toFixed(2)}</td>
                <td class="p-4 text-center">${fecha.toLocaleDateString('es-PE')}</td>
                <td class="p-4">${c.comprobante || '-'}</td>
                <td class="p-4 text-right">
                    <button onclick="editarCarga('${c.id}')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg font-bold hover:bg-blue-200 text-xs mr-2">
                        ‚úèÔ∏è
                    </button>
                    <button onclick="eliminarCarga('${c.id}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-bold hover:bg-red-200 text-xs">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function calcularResumenCargas() {
    if(!db.cargasLaborales) db.cargasLaborales = [];
    
    const totalEssalud = db.cargasLaborales.filter(c => c.tipo === 'ESSALUD').reduce((sum, c) => sum + c.monto, 0);
    const totalAFP = db.cargasLaborales.filter(c => c.tipo === 'AFP').reduce((sum, c) => sum + c.monto, 0);
    const totalONP = db.cargasLaborales.filter(c => c.tipo === 'ONP').reduce((sum, c) => sum + c.monto, 0);
    const totalCargas = db.cargasLaborales.reduce((sum, c) => sum + c.monto, 0);
    
    const elemEssalud = document.getElementById('total-essalud');
    const elemAFP = document.getElementById('total-afp');
    const elemONP = document.getElementById('total-onp');
    const elemTotal = document.getElementById('total-cargas');
    
    if(elemEssalud) elemEssalud.textContent = 'S/. ' + totalEssalud.toFixed(2);
    if(elemAFP) elemAFP.textContent = 'S/. ' + totalAFP.toFixed(2);
    if(elemONP) elemONP.textContent = 'S/. ' + totalONP.toFixed(2);
    if(elemTotal) elemTotal.textContent = 'S/. ' + totalCargas.toFixed(2);
}

function editarCarga(id) {
    const c = db.cargasLaborales.find(x => x.id === id);
    if(!c) return;
    
    document.getElementById('carga-id-hidden').value = c.id;
    document.getElementById('carga-empleado').value = c.empleado;
    document.getElementById('carga-tipo').value = c.tipo;
    document.getElementById('carga-periodo').value = c.periodo;
    document.getElementById('carga-monto').value = c.monto;
    document.getElementById('carga-fecha').value = c.fecha;
    document.getElementById('carga-comprobante').value = c.comprobante || '';
    
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function eliminarCarga(id) {
    if(!confirm('¬øEliminar esta carga laboral?')) return;
    
    const idx = db.cargasLaborales.findIndex(c => c.id === id);
    if(idx > -1) {
        db.cargasLaborales.splice(idx, 1);
        save();
        renderCargasLaborales();
        calcularResumenCargas();
        calcularFinanzas();
        alert('‚úÖ Carga eliminada');
    }
}

function limpiarFormCarga() {
    document.getElementById('carga-id-hidden').value = '';
    document.getElementById('carga-empleado').value = '';
    document.getElementById('carga-tipo').value = '';
    document.getElementById('carga-periodo').value = '';
    document.getElementById('carga-monto').value = '';
    document.getElementById('carga-fecha').value = '';
    document.getElementById('carga-comprobante').value = '';
}

// ========== AUTOMATIZACI√ìN DE CARGAS LABORALES ==========

let cargasCalculadasTemp = [];

function calcularCargasAutomaticas() {
    if(!db.empleados || db.empleados.length === 0) {
        alert('‚ö†Ô∏è No hay empleados en la planilla para calcular cargas');
        return;
    }
    
    const empleadosActivos = db.empleados.filter(e => e.activo);
    
    if(empleadosActivos.length === 0) {
        alert('‚ö†Ô∏è No hay empleados activos en la planilla');
        return;
    }
    
    // Verificar que todos tengan sistema pensionario
    const sinSistema = empleadosActivos.filter(e => !e.sistemaPensionario);
    if(sinSistema.length > 0) {
        alert('‚ö†Ô∏è Los siguientes empleados no tienen sistema pensionario asignado:\n\n' + 
              sinSistema.map(e => '‚Ä¢ ' + e.nombre).join('\n') + 
              '\n\nPor favor, edita estos empleados y asigna ONP o AFP antes de calcular.');
        return;
    }
    
    // Obtener mes y a√±o actual
    const hoy = new Date();
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const periodo = meses[hoy.getMonth()] + ' ' + hoy.getFullYear();
    
    // Limpiar cargas temporales
    cargasCalculadasTemp = [];
    
    // Calcular cargas para cada empleado
    empleadosActivos.forEach(emp => {
        const sueldo = emp.sueldo;
        
        // 1. ESSALUD (9% del sueldo bruto - lo paga el empleador)
        const essalud = sueldo * 0.09;
        cargasCalculadasTemp.push({
            empleadoId: emp.id,
            empleadoNombre: emp.nombre,
            tipo: 'ESSALUD',
            periodo: periodo,
            monto: essalud,
            concepto: 'ESSALUD 9% - ' + emp.nombre
        });
        
        // 2. ONP o AFP (lo descuenta al trabajador, pero se registra como carga)
        if(emp.sistemaPensionario === 'ONP') {
            const onp = sueldo * 0.13; // 13% para ONP
            cargasCalculadasTemp.push({
                empleadoId: emp.id,
                empleadoNombre: emp.nombre,
                tipo: 'ONP',
                periodo: periodo,
                monto: onp,
                concepto: 'ONP 13% - ' + emp.nombre
            });
        } else if(emp.sistemaPensionario === 'AFP') {
            // Usar el porcentaje espec√≠fico de la AFP o 12.5% por defecto
            const porcentajeAfp = (emp.afpPorcentaje || 12.5) / 100;
            const afp = sueldo * porcentajeAfp;
            
            // Nombre de AFP para el concepto
            const nombreAfp = emp.afpEspecifica || 'AFP';
            const porcentajeTexto = emp.afpPorcentaje ? emp.afpPorcentaje.toFixed(2) + '%' : '12.5%';
            
            cargasCalculadasTemp.push({
                empleadoId: emp.id,
                empleadoNombre: emp.nombre,
                tipo: 'AFP',
                periodo: periodo,
                monto: afp,
                concepto: nombreAfp + ' ' + porcentajeTexto + ' - ' + emp.nombre
            });
        }
    });
    
    // Mostrar detalle de liquidaci√≥n
    mostrarDetalleLiquidacion();
}

function mostrarDetalleLiquidacion() {
    const detalle = document.getElementById('detalle-liquidacion');
    const contenido = document.getElementById('contenido-liquidacion');
    
    if(!detalle || !contenido) return;
    
    let html = '';
    
    // Agrupar por empleado
    const empleadosUnicos = [...new Set(cargasCalculadasTemp.map(c => c.empleadoId))];
    
    let totalGeneral = 0;
    let totalESSALUD = 0;
    let totalONP = 0;
    let totalAFP = 0;
    
    empleadosUnicos.forEach(empId => {
        const emp = db.empleados.find(e => e.id === empId);
        if(!emp) return;
        
        const cargasEmp = cargasCalculadasTemp.filter(c => c.empleadoId === empId);
        
        const essalud = cargasEmp.find(c => c.tipo === 'ESSALUD');
        const pension = cargasEmp.find(c => c.tipo === 'ONP' || c.tipo === 'AFP');
        
        const descuentoPension = pension ? pension.monto : 0;
        const sueldoNeto = emp.sueldo - descuentoPension;
        
        totalESSALUD += essalud ? essalud.monto : 0;
        totalONP += pension && pension.tipo === 'ONP' ? pension.monto : 0;
        totalAFP += pension && pension.tipo === 'AFP' ? pension.monto : 0;
        totalGeneral += cargasEmp.reduce((sum, c) => sum + c.monto, 0);
        
        html += `
            <div class="bg-white border-2 border-blue-200 rounded-xl p-4">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <p class="font-black text-lg text-slate-800">${emp.nombre}</p>
                        <p class="text-sm text-slate-600">${emp.cargo}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-500">Sueldo Bruto</p>
                        <p class="text-xl font-bold text-blue-600">S/. ${emp.sueldo.toFixed(2)}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    ${essalud ? `
                        <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                            <p class="text-xs font-bold text-red-600 mb-1">üè• ESSALUD (9% - Empleador)</p>
                            <p class="text-lg font-black text-red-700">S/. ${essalud.monto.toFixed(2)}</p>
                        </div>
                    ` : ''}
                    
                    ${pension ? `
                        <div class="bg-${pension.tipo === 'ONP' ? 'purple' : 'blue'}-50 p-3 rounded-lg border border-${pension.tipo === 'ONP' ? 'purple' : 'blue'}-200">
                            <p class="text-xs font-bold text-${pension.tipo === 'ONP' ? 'purple' : 'blue'}-600 mb-1">
                                ${pension.tipo === 'ONP' ? 'üèõÔ∏è ONP (13%)' : 'üí∞ AFP (12.5%)'} - Trabajador
                            </p>
                            <p class="text-lg font-black text-${pension.tipo === 'ONP' ? 'purple' : 'blue'}-700">S/. ${pension.monto.toFixed(2)}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg border-2 border-green-300">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs font-bold text-green-600">üíµ SUELDO NETO A PAGAR</p>
                            <p class="text-sm text-green-600 mt-1">(Sueldo bruto - ${pension ? pension.tipo : 'N/A'})</p>
                        </div>
                        <p class="text-2xl font-black text-green-700">S/. ${sueldoNeto.toFixed(2)}</p>
                    </div>
                </div>
            </div>
        `;
    });
    
    // Resumen total
    html += `
        <div class="bg-gradient-to-br from-slate-700 to-slate-900 p-6 rounded-xl text-white">
            <p class="font-black text-xl mb-4">üìä RESUMEN TOTAL DEL MES</p>
            <div class="grid grid-cols-4 gap-4">
                <div>
                    <p class="text-xs opacity-75 mb-1">üè• ESSALUD Total</p>
                    <p class="text-xl font-black">S/. ${totalESSALUD.toFixed(2)}</p>
                </div>
                <div>
                    <p class="text-xs opacity-75 mb-1">üèõÔ∏è ONP Total</p>
                    <p class="text-xl font-black">S/. ${totalONP.toFixed(2)}</p>
                </div>
                <div>
                    <p class="text-xs opacity-75 mb-1">üí∞ AFP Total</p>
                    <p class="text-xl font-black">S/. ${totalAFP.toFixed(2)}</p>
                </div>
                <div class="border-l-2 border-white/30 pl-4">
                    <p class="text-xs opacity-75 mb-1">üë∑ TOTAL CARGAS</p>
                    <p class="text-2xl font-black text-yellow-300">S/. ${totalGeneral.toFixed(2)}</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-white/30">
                <p class="text-xs opacity-75 mb-1">üìå NOTA IMPORTANTE:</p>
                <p class="text-xs">
                    ‚Ä¢ ESSALUD: Lo paga el empleador (aparece en egresos)<br>
                    ‚Ä¢ ONP/AFP: Se descuenta del sueldo del trabajador (ya est√° descontado en sueldo neto)
                </p>
            </div>
        </div>
    `;
    
    contenido.innerHTML = html;
    detalle.classList.remove('hidden');
    
    // Scroll hacia el detalle
    detalle.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function guardarCargasCalculadas() {
    if(cargasCalculadasTemp.length === 0) {
        alert('‚ö†Ô∏è No hay cargas calculadas para guardar');
        return;
    }
    
    if(!confirm('¬øGuardar ' + cargasCalculadasTemp.length + ' cargas laborales?\n\nEsto registrar√° todas las cargas en el sistema.')) {
        return;
    }
    
    if(!db.cargasLaborales) db.cargasLaborales = [];
    
    const fechaHoy = new Date().toISOString().split('T')[0];
    const periodo = cargasCalculadasTemp[0].periodo;
    
    // Verificar si ya existen cargas para este per√≠odo
    const cargasExistentes = db.cargasLaborales.filter(c => c.periodo === periodo);
    if(cargasExistentes.length > 0) {
        if(!confirm('‚ö†Ô∏è YA EXISTEN ' + cargasExistentes.length + ' CARGAS PARA EL PER√çODO "' + periodo + '".\n\n¬øDeseas agregar estas cargas adicionales?')) {
            return;
        }
    }
    
    // Guardar todas las cargas
    cargasCalculadasTemp.forEach(carga => {
        db.cargasLaborales.push({
            id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9),
            empleado: carga.empleadoId,
            tipo: carga.tipo,
            periodo: carga.periodo,
            monto: carga.monto,
            fecha: fechaHoy,
            comprobante: 'AUTO-' + periodo,
            fechaRegistro: new Date().toISOString()
        });
    });
    
    save();
    calcularFinanzas();
    renderCargasLaborales();
    calcularResumenCargas();
    cerrarDetalleLiquidacion();
    
    alert('‚úÖ CARGAS LABORALES GUARDADAS\n\nSe registraron ' + cargasCalculadasTemp.length + ' cargas laborales para el per√≠odo ' + periodo);
    
    cargasCalculadasTemp = [];
}

function cerrarDetalleLiquidacion() {
    const detalle = document.getElementById('detalle-liquidacion');
    if(detalle) detalle.classList.add('hidden');
    cargasCalculadasTemp = [];
}

function updateCargasEmpleadosDropdown() {
    const select = document.getElementById('carga-empleado');
    if(!select) return;
    
    if(!db.empleados) db.empleados = [];
    
    const empleadosActivos = db.empleados.filter(e => e.activo);
    
    select.innerHTML = '<option value="">Seleccionar empleado...</option>' +
        empleadosActivos.map(e => `<option value="${e.id}">${e.nombre} - ${e.cargo}</option>`).join('');
}


// Modificar la funci√≥n showSection para incluir familias
   const showSectionOriginal = showSection;
showSection = function(id) {
    // üîê M√ìDULO USUARIOS REQUIERE CLAVE DE ADMIN
    if (id === 'usuarios') {
        solicitarClaveAdmin(function() {
            showSectionConValidacion('usuarios');
        }, 'üë• M√ìDULO DE USUARIOS requiere clave de administrador');
        return;
    }
    
    // üîê M√ìDULO ADMINISTRACI√ìN REQUIERE CLAVE DE ADMIN
    if (id === 'admin') {
        solicitarClaveAdmin(function() {
            showSectionConValidacion('admin');
        }, '‚öôÔ∏è M√ìDULO DE ADMINISTRACI√ìN requiere clave de administrador');
        return;
    }
    
    // Continuar con validaci√≥n normal
    showSectionConValidacion(id);
};

function showSectionConValidacion(id) {
    // VALIDACI√ìN DE PERMISOS: Verificar si el usuario tiene acceso
    if (usuarioActual && usuarioActual.rol !== 'admin' && usuarioActual.rol !== 'mozo') {
        // Si el usuario tiene permisos personalizados, verificar
        if (usuarioActual.permisos && usuarioActual.permisos.indexOf(id) === -1) {
            console.log('üö´ ACCESO DENEGADO a secci√≥n:', id);
            console.log('   Usuario:', usuarioActual.nombre);
            console.log('   Rol:', usuarioActual.rol);
            console.log('   Permisos:', usuarioActual.permisos);
            alert('‚õî ACCESO DENEGADO\n\nNo tienes permisos para acceder a este m√≥dulo.\n\nContacta al administrador si necesitas acceso.');
            return; // No ejecutar showSectionOriginal
        }
    }
    
    showSectionOriginal(id);
    
    if(id === 'familias') {
        renderFamilias();
        renderCategorias();
        renderAlergenos();
    }
    
    if(id === 'bom') {
        renderAlergenosCheckboxes();
        updateAlergenosFilter();
    }
    
    if(id === 'admin') {
        renderDescuentos();
    }
    
    if(id === 'analisis') {
        calcularAnalisisRentabilidad();
    }
    
    if(id === 'alertas') {
        calcularContadoresAlertas();
        renderAlertas();
    }
    
    if(id === 'variance') {
        actualizarDropdownVariance();
        inicializarFechaVariance();
        calcularMetricasVariance();
        renderVarianceHistorial();
    }
    
    if(id === 'logs') {
        poblarFiltroUsuarios();
        renderLogs();
    }
    
    if(id === 'documentos') {
        inicDocumentos();
    }
    
    if(id === 'produccion') {
        inicializarProduccionDiaria();
    }
    
    if(id === 'dashboard') {
        actualizarDashboard();
    }
}
// ========== AN√ÅLISIS DE RENTABILIDAD ==========
function calcularAnalisisRentabilidad() {
    if(db.platos.length === 0) {
        alert("‚ö†Ô∏è NO HAY PLATOS REGISTRADOS\n\nDebes crear al menos un plato en el men√∫ para realizar el an√°lisis.");
        return;
    }
    
    // Validar que los platos tengan precio
    const platosSinPrecio = db.platos.filter(p => !p.precioMenu || p.precioMenu <= 0);
    if(platosSinPrecio.length > 0) {
        alert(`‚ö†Ô∏è HAY ${platosSinPrecio.length} PLATOS SIN PRECIO\n\nAsigna precios de men√∫ a todos los platos para un an√°lisis preciso.`);
    }
    
    // Calcular m√©tricas generales
    calcularMetricasGenerales();
    
    // Calcular rankings
    calcularTopRentables();
    calcularTopProblematicos();
    
    // An√°lisis por familias
    calcularAnalisisFamilias();
    
    // Generar recomendaciones
    generarRecomendaciones();

   // Generar Versus Real
calcularFCRealVsIdeal();

// üîπ Calcular Mermas
// calcularMermas(); // TODO: Implementar funci√≥n de c√°lculo de mermas


    
    // Mensaje de √©xito
    setTimeout(() => {
        alert("‚úÖ AN√ÅLISIS COMPLETADO\n\nRevisa los resultados y recomendaciones para optimizar tu rentabilidad.");
    }, 500);
}

function calcularMetricasGenerales() {
    const platosConPrecio = db.platos.filter(p => p.precioMenu > 0);
    
    if(platosConPrecio.length === 0) {
        document.getElementById('metric-total-platos').textContent = db.platos.length;
        document.getElementById('metric-fc-promedio').textContent = "N/A";
        document.getElementById('metric-platos-altos').textContent = "N/A";
        document.getElementById('metric-costo-promedio').textContent = "N/A";
        return;
    }
    
    const fcPromedio = platosConPrecio.reduce((sum, p) => sum + p.fcPorcentaje, 0) / platosConPrecio.length;
    const platosAltos = platosConPrecio.filter(p => p.fcPorcentaje > 35).length;
    const costoPromedio = platosConPrecio.reduce((sum, p) => sum + p.costoReceta, 0) / platosConPrecio.length;
    
    document.getElementById('metric-total-platos').textContent = db.platos.length;
    document.getElementById('metric-fc-promedio').textContent = fcPromedio.toFixed(1) + "%";
    document.getElementById('metric-platos-altos').textContent = platosAltos;
    document.getElementById('metric-costo-promedio').textContent = costoPromedio.toFixed(2);
    
    // Cambiar color seg√∫n FC promedio
    const metricFC = document.getElementById('metric-fc-promedio').parentElement;
    if(fcPromedio <= 30) {
        metricFC.style.background = "linear-gradient(to bottom right, #059669, #0d9488)"; // Verde
    } else if(fcPromedio <= 35) {
        metricFC.style.background = "linear-gradient(to bottom right, #d97706, #ea580c)"; // Naranja
    } else {
        metricFC.style.background = "linear-gradient(to bottom right, #dc2626, #e11d48)"; // Rojo
    }
}

function calcularTopRentables() {
    const platosConPrecio = db.platos.filter(p => p.precioMenu > 0);
    const ordenados = [...platosConPrecio].sort((a, b) => a.fcPorcentaje - b.fcPorcentaje);
    const top10 = ordenados.slice(0, 10);
    
    const html = top10.map((plato, idx) => {
        const medalla = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}.`;
        const utilidad = plato.precioSinIGV - plato.costoReceta;
        const colorFC = plato.fcPorcentaje <= 30 ? 'text-emerald-600' : plato.fcPorcentaje <= 35 ? 'text-amber-600' : 'text-red-600';
        
        return `
            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-200 rounded-xl p-4 hover:shadow-lg transition-all">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-2xl">${medalla}</span>
                            <p class="font-black text-sm">${plato.nombre}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <p class="text-slate-500 font-semibold">Costo:</p>
                                <p class="font-bold text-blue-600">S/. ${plato.costoReceta.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-slate-500 font-semibold">Precio:</p>
                                <p class="font-bold text-purple-600">S/. ${plato.precioMenu.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-slate-500 font-semibold">FC%:</p>
                                <p class="font-bold ${colorFC}">${plato.fcPorcentaje.toFixed(2)}%</p>
                            </div>
                            <div>
                                <p class="text-slate-500 font-semibold">Utilidad:</p>
                                <p class="font-bold text-emerald-600">S/. ${utilidad.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="badge bg-emerald-100 text-emerald-700">
                        ${plato.fcPorcentaje <= 30 ? 'IDEAL' : 'BUENO'}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('top-rentables').innerHTML = html || '<p class="text-slate-400 text-center py-4">No hay datos disponibles</p>';
}

function calcularTopProblematicos() {
    const platosConPrecio = db.platos.filter(p => p.precioMenu > 0);
    const ordenados = [...platosConPrecio].sort((a, b) => b.fcPorcentaje - a.fcPorcentaje);
    const top10 = ordenados.slice(0, 10);
    
    const html = top10.map((plato, idx) => {
        const utilidad = plato.precioSinIGV - plato.costoReceta;
        const colorFC = plato.fcPorcentaje <= 30 ? 'text-emerald-600' : plato.fcPorcentaje <= 35 ? 'text-amber-600' : 'text-red-600';
        const precioSugerido = plato.precioIdeal;
        const diferenciaPrecio = precioSugerido - plato.precioMenu;
        
        return `
            <div class="bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 rounded-xl p-4 hover:shadow-lg transition-all">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-black text-slate-600">${idx + 1}.</span>
                            <p class="font-black text-sm">${plato.nombre}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                            <div>
                                <p class="text-slate-500 font-semibold">Costo:</p>
                                <p class="font-bold text-blue-600">S/. ${plato.costoReceta.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-slate-500 font-semibold">Precio Actual:</p>
                                <p class="font-bold text-purple-600">S/. ${plato.precioMenu.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-slate-500 font-semibold">FC%:</p>
                                <p class="font-bold ${colorFC}">${plato.fcPorcentaje.toFixed(2)}%</p>
                            </div>
                            <div>
                                <p class="text-slate-500 font-semibold">Utilidad:</p>
                                <p class="font-bold ${utilidad >= 0 ? 'text-emerald-600' : 'text-red-600'}">S/. ${utilidad.toFixed(2)}</p>
                            </div>
                        </div>
                        ${plato.fcPorcentaje > 35 ? `
                            <div class="bg-amber-100 border border-amber-300 rounded-lg p-2">
                                <p class="text-xs font-bold text-amber-800">üí° SUGERENCIA:</p>
                                <p class="text-xs text-amber-700">
                                    Subir precio a <span class="font-black">S/. ${precioSugerido.toFixed(2)}</span> 
                                    (${diferenciaPrecio > 0 ? '+' : ''}${diferenciaPrecio.toFixed(2)})
                                </p>
                            </div>
                        ` : ''}
                    </div>
                    <div class="badge ${plato.fcPorcentaje > 35 ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700'}">
                        ${plato.fcPorcentaje > 35 ? 'CR√çTICO' : 'REVISAR'}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('top-problematicos').innerHTML = html || '<p class="text-slate-400 text-center py-4">No hay datos disponibles</p>';
}

function calcularAnalisisFamilias() {
    if(!db.familias || db.familias.length === 0) {
        document.getElementById('analisis-familias').innerHTML = '<p class="text-slate-400 text-center py-4 col-span-full">No hay familias configuradas</p>';
        return;
    }
    
    const analisisFamilias = db.familias.map(familia => {
        const materialesFamilia = db.materiales.filter(m => m.familia === familia);
        
        if(materialesFamilia.length === 0) {
            return {
                familia,
                count: 0,
                precioPromedio: 0,
                precioTotal: 0
            };
        }
        
        const precioTotal = materialesFamilia.reduce((sum, m) => sum + m.precio, 0);
        const precioPromedio = precioTotal / materialesFamilia.length;
        
        return {
            familia,
            count: materialesFamilia.length,
            precioPromedio,
            precioTotal
        };
    }).filter(f => f.count > 0).sort((a, b) => b.precioPromedio - a.precioPromedio);
    
    const html = analisisFamilias.map((f, idx) => {
        const colores = [
            'from-red-500 to-pink-500',
            'from-orange-500 to-amber-500',
            'from-blue-500 to-indigo-500',
            'from-purple-500 to-pink-500',
            'from-emerald-500 to-teal-500'
        ];
        const color = colores[idx % colores.length];
        
        return `
            <div class="bg-gradient-to-br ${color} text-white rounded-xl p-4 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-white opacity-10 rounded-full transform translate-x-8 -translate-y-8"></div>
                <p class="text-xs font-semibold mb-1 opacity-90">${f.familia}</p>
                <p class="text-2xl font-black mb-1">S/. ${f.precioPromedio.toFixed(2)}</p>
                <p class="text-xs opacity-90">${f.count} materiales</p>
            </div>
        `;
    }).join('');
    
    document.getElementById('analisis-familias').innerHTML = html || '<p class="text-slate-400 text-center py-4 col-span-full">No hay datos disponibles</p>';
}

function generarRecomendaciones() {
    const recomendaciones = [];
    const platosConPrecio = db.platos.filter(p => p.precioMenu > 0);
    
    // Recomendaci√≥n 1: FC Promedio
    if(platosConPrecio.length > 0) {
        const fcPromedio = platosConPrecio.reduce((sum, p) => sum + p.fcPorcentaje, 0) / platosConPrecio.length;
        
        if(fcPromedio <= 25) {
            recomendaciones.push({
                tipo: 'success',
                icono: '‚úÖ',
                titulo: 'FC% EXCELENTE',
                mensaje: `Tu FC promedio es ${fcPromedio.toFixed(1)}% - ¬°Est√°s en un rango muy saludable! Mant√©n este nivel de eficiencia.`
            });
        } else if(fcPromedio <= 30) {
            recomendaciones.push({
                tipo: 'info',
                icono: 'üëç',
                titulo: 'FC% BUENO',
                mensaje: `Tu FC promedio es ${fcPromedio.toFixed(1)}% - Est√°s en un buen rango. Busca optimizar los platos problem√°ticos.`
            });
        } else if(fcPromedio <= 35) {
            recomendaciones.push({
                tipo: 'warning',
                icono: '‚ö†Ô∏è',
                titulo: 'FC% MEJORABLE',
                mensaje: `Tu FC promedio es ${fcPromedio.toFixed(1)}% - Considera ajustar precios o reducir costos en algunos platos.`
            });
        } else {
            recomendaciones.push({
                tipo: 'danger',
                icono: 'üö®',
                titulo: 'FC% CR√çTICO',
                mensaje: `Tu FC promedio es ${fcPromedio.toFixed(1)}% - ¬°URGENTE! Revisa precios inmediatamente, est√°s perdiendo rentabilidad.`
            });
        }
    }
    
    // Recomendaci√≥n 2: Platos cr√≠ticos
    const platosCriticos = platosConPrecio.filter(p => p.fcPorcentaje > 35);
    if(platosCriticos.length > 0) {
        recomendaciones.push({
            tipo: 'warning',
            icono: 'üìà',
            titulo: `${platosCriticos.length} PLATOS CR√çTICOS DETECTADOS`,
            mensaje: `Tienes ${platosCriticos.length} platos con FC% > 35%. Considera subir precios o reducir porciones/ingredientes costosos.`
        });
    }
    
    // Recomendaci√≥n 3: Platos sin precio
    const platosSinPrecio = db.platos.filter(p => !p.precioMenu || p.precioMenu <= 0);
    if(platosSinPrecio.length > 0) {
        recomendaciones.push({
            tipo: 'info',
            icono: 'üí∞',
            titulo: 'PLATOS SIN PRECIO',
            mensaje: `Tienes ${platosSinPrecio.length} platos sin precio asignado. Completa esta informaci√≥n para un an√°lisis m√°s preciso.`
        });
    }
    
    // Recomendaci√≥n 4: Oportunidades
    const platosIdeales = platosConPrecio.filter(p => p.fcPorcentaje <= 25);
    if(platosIdeales.length > 0) {
        recomendaciones.push({
            tipo: 'success',
            icono: 'üéØ',
            titulo: 'PLATOS ESTRELLA',
            mensaje: `Tienes ${platosIdeales.length} platos con FC% excelente (‚â§25%). ¬°Promociona estos platos para aumentar ventas!`
        });
    }
    
    // Recomendaci√≥n 5: An√°lisis de familias
    if(db.familias && db.familias.length > 0) {
        const familiaCostosa = db.familias.map(familia => {
            const mats = db.materiales.filter(m => m.familia === familia);
            if(mats.length === 0) return null;
            return {
                familia,
                promedio: mats.reduce((sum, m) => sum + m.precio, 0) / mats.length
            };
        }).filter(f => f !== null).sort((a, b) => b.promedio - a.promedio)[0];
        
        if(familiaCostosa) {
            recomendaciones.push({
                tipo: 'info',
                icono: 'üè∑Ô∏è',
                titulo: 'FAMILIA M√ÅS COSTOSA',
                mensaje: `"${familiaCostosa.familia}" es tu categor√≠a m√°s cara (S/. ${familiaCostosa.promedio.toFixed(2)} promedio). Busca proveedores alternativos.`
            });
        }
    }
    
// Recomendaci√É¬≥n 6: Oportunidades de Aumento de Precio
    const platosSubirPrecio = platosConPrecio.filter(p => p.fcPorcentaje <= 25 && p.precioMenu < p.precioIdeal * 0.9);
    if(platosSubirPrecio.length > 0) {
        const ejemplos = platosSubirPrecio.slice(0, 3).map(p => 
            `${p.nombre} (actual: S/. ${p.precioMenu.toFixed(2)} ‚Üí ideal: S/. ${p.precioIdeal.toFixed(2)})`
        ).join(', ');
        
        recomendaciones.push({
            tipo: 'success',
            icono: 'üí∞',
            titulo: 'OPORTUNIDAD: AUMENTAR PRECIOS',
            mensaje: `Tienes ${platosSubirPrecio.length} platos MUY rentables donde puedes subir el precio sin perder competitividad. Ejemplos: ${ejemplos}`
        });
    }
    
    // Recomendaci√É¬≥n 7: Ingredientes M√É¬°s Caros
    const componentesCostosos = [];
    db.platos.forEach(plato => {
        plato.componentes.forEach(comp => {
            const mat = db.materiales.find(m => m.sku === comp.sku);
            if(mat) {
                const costoTotal = (comp.cant * (mat.precio / mat.factor));
                componentesCostosos.push({
                    material: mat.nombre,
                    costo: costoTotal,
                    plato: plato.nombre
                });
            }
        });
    });
    
    if(componentesCostosos.length > 0) {
        const topCaro = componentesCostosos.sort((a, b) => b.costo - a.costo)[0];
        recomendaciones.push({
            tipo: 'info',
            icono: 'üìà',
            titulo: 'INGREDIENTE M√ÅS COSTOSO',
            mensaje: `"${topCaro.material}" es el componente m√°s caro en "${topCaro.plato}" (S/. ${topCaro.costo.toFixed(2)}). Considera reducir porci√≥n o buscar alternativas.`
        });
    }
    
    // Recomendaci√É¬≥n 8: Recetas Base sin Uso
    const recetasUsadas = new Set();
    db.platos.forEach(plato => {
        plato.componentes.forEach(comp => {
            if(comp.sku.startsWith('MAT-')) {
                const rbSku = comp.sku.replace('MAT-', '');
                if(db.recetasBase.find(rb => rb.sku === rbSku)) {
                    recetasUsadas.add(comp.sku);
                }
            }
        });
    });
    
    const recetasSinUso = db.recetasBase.filter(rb => !recetasUsadas.has('MAT-' + rb.sku));
    if(recetasSinUso.length > 0) {
        recomendaciones.push({
            tipo: 'warning',
            icono: 'üóëÔ∏è',
            titulo: 'RECETAS BASE SIN USO',
            mensaje: `Tienes ${recetasSinUso.length} recetas base que no est√°n en ning√∫n plato. Considera eliminarlas o crear nuevos platos con ellas.`
        });
    }
    
    // Recomendaci√É¬≥n 9: Materiales con Stock Cr√É¬≠tico en Platos Rentables
    const materialesCriticos = db.materiales.filter(m => {
        const estado = calcularEstadoStock(m.sku);
        return estado === 'critico' || estado === 'bajo';
    });
    
    if(materialesCriticos.length > 0) {
        const platosAfectados = platosConPrecio.filter(p => 
            p.fcPorcentaje <= 30 && 
            p.componentes.some(comp => materialesCriticos.find(mc => mc.sku === comp.sku))
        );
        
        if(platosAfectados.length > 0) {
            recomendaciones.push({
                tipo: 'danger',
                icono: '‚ö†Ô∏è',
                titulo: '¬°ALERTA! INGREDIENTES CR√çTICOS',
                mensaje: `${materialesCriticos.length} materiales con stock bajo afectan ${platosAfectados.length} platos RENTABLES. Reabastece urgentemente para no perder ventas.`
            });
        }
    }
    
    // Recomendaci√É¬≥n 10: Comparaci√É¬≥n Precio Real vs Ideal
    const diferenciaPrecios = platosConPrecio.map(p => ({
        nombre: p.nombre,
        diferencia: p.precioMenu - p.precioIdeal,
        porcentaje: ((p.precioMenu - p.precioIdeal) / p.precioIdeal) * 100
    })).filter(p => Math.abs(p.diferencia) > 5);
    
    if(diferenciaPrecios.length > 0) {
        const muyBaratos = diferenciaPrecios.filter(p => p.diferencia < -5).length;
        const muyCaros = diferenciaPrecios.filter(p => p.diferencia > 5).length;
        
        if(muyBaratos > 0) {
            recomendaciones.push({
                tipo: 'warning',
                icono: 'üí∏',
                titulo: 'PRECIOS MUY BAJOS',
                mensaje: `${muyBaratos} platos est√°n S/. 5+ por debajo de su precio ideal. Est√°s dejando de ganar dinero en cada venta.`
            });
        }
        
        if(muyCaros > 0) {
            recomendaciones.push({
                tipo: 'info',
                icono: 'üéØ',
                titulo: 'PRECIOS COMPETITIVOS',
                mensaje: `${muyCaros} platos tienen precios arriba del ideal. Si las ventas son bajas, considera ajustar precios o mejorar percepci√≥n de valor.`
            });
        }
    }
    
    // Recomendaci√É¬≥n 11: Diversidad de Men√É¬∫
    if(db.platos.length < 10) {
        recomendaciones.push({
            tipo: 'info',
            icono: 'üçΩÔ∏è',
            titulo: 'AMPLIAR MEN√ö',
            mensaje: `Solo tienes ${db.platos.length} platos. Considera agregar m√°s opciones para atraer diferentes tipos de clientes.`
        });
    }
    
    // Recomendaci√É¬≥n 12: Platos "Gancho"
    const platosGancho = platosConPrecio.filter(p => 
        p.fcPorcentaje <= 20 && p.precioMenu < platosConPrecio.reduce((sum, pl) => sum + pl.precioMenu, 0) / platosConPrecio.length
    );
    
    if(platosGancho.length > 0) {
        recomendaciones.push({
            tipo: 'success',
            icono: 'üé£',
            titulo: 'PLATOS "GANCHO" DETECTADOS',
            mensaje: `Tienes ${platosGancho.length} platos rentables Y econ√≥micos. √ösalos en promociones para atraer clientes y vender otros platos.`
        });
    }
    // Renderizar recomendaciones
    const coloresBg = {
        success: 'from-emerald-50 to-teal-50 border-emerald-200',
        info: 'from-blue-50 to-indigo-50 border-blue-200',
        warning: 'from-amber-50 to-orange-50 border-amber-200',
        danger: 'from-red-50 to-pink-50 border-red-200'
    };
    
    const coloresTexto = {
        success: 'text-emerald-700',
        info: 'text-blue-700',
        warning: 'text-amber-700',
        danger: 'text-red-700'
    };
    
    const html = recomendaciones.map(r => `
        <div class="bg-gradient-to-r ${coloresBg[r.tipo]} border-2 rounded-xl p-4">
            <div class="flex items-start gap-3">
                <span class="text-3xl">${r.icono}</span>
                <div class="flex-1">
                    <p class="font-black text-sm ${coloresTexto[r.tipo]} mb-1">${r.titulo}</p>
                    <p class="text-xs text-slate-700 font-medium">${r.mensaje}</p>
                </div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('recomendaciones').innerHTML = html || '<p class="text-slate-400 text-center py-4">No hay recomendaciones disponibles</p>';
}
// ========== SISTEMA DE ALERTAS DE STOCK ==========
let filtroActual = 'todos';




function renderAlertas() {
    const query = (document.getElementById('search-alertas')?.value || '').toUpperCase();
    
    let materialesFiltrados = db.materiales.filter(m => 
        m.nombre.includes(query) || m.sku.includes(query)
    );
    
    // Aplicar filtro de estado
    if(filtroActual !== 'todos') {
        materialesFiltrados = materialesFiltrados.filter(m => 
            calcularEstadoStock(m.sku) === filtroActual
        );
    }
    
    // Ordenar: cr√≠ticos primero, luego bajos, luego normales
    materialesFiltrados.sort((a, b) => {
        const estadoA = calcularEstadoStock(a.sku);
        const estadoB = calcularEstadoStock(b.sku);
        const orden = { critico: 0, bajo: 1, normal: 2, sinconfig: 3 };
        return orden[estadoA] - orden[estadoB];
    });
    
    const html = materialesFiltrados.map(m => {
        const stockActual = db.inventario[m.sku] || 0;
        const stockMinimo = db.stockMinimo[m.sku];
        const estado = calcularEstadoStock(m.sku);
        
        // Configuraci√≥n de colores por estado
        const configs = {
            critico: {
                bg: 'from-red-50 to-pink-50 border-red-300',
                badge: 'bg-red-600 text-white',
                icon: 'üî¥',
                label: 'CR√çTICO',
                textColor: 'text-red-700'
            },
            bajo: {
                bg: 'from-amber-50 to-orange-50 border-amber-300',
                badge: 'bg-amber-600 text-white',
                icon: 'üü°',
                label: 'BAJO',
                textColor: 'text-amber-700'
            },
            normal: {
                bg: 'from-emerald-50 to-teal-50 border-emerald-300',
                badge: 'bg-emerald-600 text-white',
                icon: 'üü¢',
                label: 'NORMAL',
                textColor: 'text-emerald-700'
            },
            sinconfig: {
                bg: 'from-slate-50 to-gray-50 border-slate-300',
                badge: 'bg-slate-600 text-white',
                icon: '‚ö´',
                label: 'SIN CONFIG',
                textColor: 'text-slate-700'
            }
        };
        
        const config = configs[estado];
        
        // Calcular sugerencia de compra
        let sugerenciaCompra = 0;
        if(stockMinimo !== undefined && stockMinimo !== null && stockActual < stockMinimo) {
            sugerenciaCompra = Math.ceil((stockMinimo - stockActual) * 1.5); // 1.5x para tener margen
        }
        
        return `
            <div class="bg-gradient-to-r ${config.bg} border-2 rounded-xl p-5 hover:shadow-lg transition-all">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-2xl">${config.icon}</span>
                            <div>
                                <p class="font-black text-sm">${m.nombre}</p>
                                <p class="text-xs text-slate-500 font-semibold">${m.sku} ‚Ä¢ ${m.uCosto}</p>
                            </div>
                        </div>
                    </div>
                    <div class="badge ${config.badge} text-xs">${config.label}</div>
                </div>
                
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <div class="bg-white rounded-lg p-3 text-center">
                        <p class="text-xs text-slate-500 font-semibold mb-1">ACTUAL</p>
                        <p class="text-xl font-black ${estado === 'critico' ? 'text-red-600' : 'text-blue-600'}">
                            ${stockActual.toFixed(2)}
                        </p>
                    </div>
                    <div class="bg-white rounded-lg p-3 text-center">
                        <p class="text-xs text-slate-500 font-semibold mb-1">M√çNIMO</p>
                        <p class="text-xl font-black text-purple-600">
                            ${stockMinimo !== undefined ? stockMinimo.toFixed(2) : '-'}
                        </p>
                    </div>
                    <div class="bg-white rounded-lg p-3 text-center">
                        <p class="text-xs text-slate-500 font-semibold mb-1">PRECIO</p>
                        <p class="text-xl font-black text-emerald-600">S/. ${m.precio.toFixed(2)}</p>
                    </div>
                </div>
                
                ${sugerenciaCompra > 0 ? `
                    <div class="bg-white border-2 border-amber-300 rounded-lg p-3 mb-3">
                        <p class="text-xs font-bold text-amber-800 mb-1">üí° SUGERENCIA DE COMPRA:</p>
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-black ${config.textColor}">
                                ${sugerenciaCompra.toFixed(2)} ${m.uCompra}
                            </p>
                            <p class="text-xs font-bold text-slate-600">
                                ‚âà ${(sugerenciaCompra * m.precio.toFixed(2))}
                            </p>
                        </div>
                    </div>
                ` : ''}
                
                <div class="flex gap-2">
                    <button onclick="abrirModalStockMinimo('${m.sku}')" 
                            class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-2 rounded-lg font-bold text-xs hover:from-blue-700 hover:to-indigo-700 btn-action">
                        ‚öôÔ∏è CONFIGURAR
                    </button>
                    ${stockMinimo !== undefined && stockMinimo !== null ? `
                        <button onclick="eliminarStockMinimo('${m.sku}')" 
                                class="px-4 bg-red-100 text-red-600 py-2 rounded-lg font-bold text-xs hover:bg-red-200 btn-action">
                            üóëÔ∏è
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('lista-alertas').innerHTML = html || `
        <div class="col-span-full text-center py-12 text-slate-400">
            <div class="text-6xl mb-4">üì¶</div>
            <p class="font-bold text-lg">No hay materiales que mostrar</p>
            <p class="text-sm">Intenta cambiar los filtros o la b√∫squeda</p>
        </div>
    `;
}

function filtrarAlertas(filtro) {
    filtroActual = filtro;
    
    // Actualizar estilos de botones
    ['todos', 'critico', 'bajo', 'normal', 'sinconfig'].forEach(f => {
        const btn = document.getElementById(`btn-filtro-${f}`);
        if(f === filtro) {
            btn.className = 'bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-xl font-bold btn-action';
        } else {
            btn.className = 'bg-white text-slate-700 px-6 py-3 rounded-xl font-bold btn-action border-2 border-slate-200';
        }
    });
    
    renderAlertas();
}

function abrirModalStockMinimo(sku) {
    const m = db.materiales.find(mat => mat.sku === sku);
    if(!m) return;
    
    const stockActual = db.inventario[sku] || 0;
    const stockMinimo = db.stockMinimo[sku] || '';
    
    document.getElementById('config-sku').value = sku;
    document.getElementById('config-nombre').textContent = m.nombre;
    document.getElementById('config-unidad').textContent = `Unidad: ${m.uCosto} ‚Ä¢ Precio: S/. ${m.precio.toFixed(2)}`;
    document.getElementById('config-stock-actual').textContent = stockActual.toFixed(2) + ' ' + m.uCosto;
    document.getElementById('config-stock-minimo').value = stockMinimo;
    
    document.getElementById('modal-stock-minimo').style.display = 'flex';
    document.getElementById('config-stock-minimo').focus();
}

function cerrarModalStockMinimo() {
    document.getElementById('modal-stock-minimo').style.display = 'none';
    document.getElementById('config-sku').value = '';
    document.getElementById('config-stock-minimo').value = '';
}

function guardarStockMinimo() {
    const sku = document.getElementById('config-sku').value;
    const valor = parseFloat(document.getElementById('config-stock-minimo').value);
    
    if(isNaN(valor) || valor < 0) {
        alert("‚ö†Ô∏è Ingresa un valor v√°lido (mayor o igual a 0)");
        return;
    }
    
    db.stockMinimo[sku] = valor;
    save();
    calcularContadoresAlertas();
    renderAlertas();
    cerrarModalStockMinimo();
    alert("‚úÖ Stock m√≠nimo configurado correctamente");
}

function eliminarStockMinimo(sku) {
    if(!confirm("¬øEliminar la configuraci√≥n de stock m√≠nimo para este material?")) {
        return;
    }
    
    delete db.stockMinimo[sku];
    save();
    calcularContadoresAlertas();
    renderAlertas();
}

function generarOrdenCompraAlertas() {
    // Filtrar materiales cr√≠ticos y bajos
    const materialesCompra = db.materiales.filter(m => {
        const estado = calcularEstadoStock(m.sku);
        return estado === 'critico' || estado === 'bajo';
    });
    
    if(materialesCompra.length === 0) {
        alert("‚úÖ NO HAY MATERIALES CR√çTICOS O BAJOS\n\nTodo el inventario est√° en niveles saludables.");
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const ahora = new Date();
    
    // Encabezado
    doc.setFillColor(239, 68, 68);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setFillColor(255, 255, 255);
    doc.circle(25, 15, 7, 'F');
    doc.setFillColor(239, 68, 68);
    doc.circle(25, 15, 5.5, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text("SWISSOTEL", 105, 10, { align: "center" });
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text("HOTELERA COSTA DEL PACIFICO S.A. - RUC: 20297885538", 105, 16, { align: "center" });
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text("ORDEN DE COMPRA URGENTE - ALERTAS DE STOCK", 105, 24, { align: "center" });
    
    // Info
    const infoY = 48;
    doc.setFillColor(254, 242, 242);
    doc.roundedRect(10, infoY, 190, 20, 2, 2, 'F');
    doc.setTextColor(30, 41, 59);
    doc.setFontSize(8);
    doc.text("FECHA: " + ahora.toLocaleDateString('es-PE'), 15, infoY + 8);
    doc.text("MATERIALES URGENTES: " + materialesCompra.length, 15, infoY + 14);
    
    // Agrupar por familia
    const grupos = {};
    let totalGeneral = 0;
    
    materialesCompra.forEach(m => {
        const stockActual = db.inventario[m.sku] || 0;
        const stockMinimo = db.stockMinimo[m.sku] || 0;
        const faltante = Math.max(0, stockMinimo - stockActual);
        const sugerencia = Math.ceil(faltante * 1.5);
        const subtotal = sugerencia * m.precio;
        
        const familia = m.familia || "VARIOS";
        if(!grupos[familia]) {
            grupos[familia] = { items: [], total: 0 };
        }
        
        grupos[familia].items.push({
            nombre: m.nombre,
            unidad: m.uCompra,
            stockActual: stockActual.toFixed(2),
            stockMin: stockMinimo.toFixed(2),
            sugerencia: sugerencia.toFixed(2),
            precio: m.precio.toFixed(2),
            subtotal: subtotal.toFixed(2),
            estado: calcularEstadoStock(m.sku)
        });
        
        grupos[familia].total += subtotal;
        totalGeneral += subtotal;
    });
    
    let currentY = 75;
    
    // Generar tablas por familia
    for(const familia in grupos) {
        if(currentY > 230) { doc.addPage(); currentY = 20; }
        
        doc.setTextColor(239, 68, 68);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(`CATEGOR√çA: ${familia}`, 10, currentY);
        
        doc.autoTable({
            startY: currentY + 2,
            head: [['MATERIAL', 'ACTUAL', 'M√çNIMO', 'COMPRAR', 'P.UNIT', 'SUBTOTAL']],
            body: grupos[familia].items.map(i => [
                i.nombre,
                i.stockActual + ' ' + i.unidad,
                i.stockMin,
                i.sugerencia + ' ' + i.unidad,
                "S/. " + i.precio,
                "S/. " + i.subtotal
            ]),
            theme: 'grid',
            headStyles: { fillColor: [239, 68, 68], fontSize: 7 },
            styles: { fontSize: 7 },
            columnStyles: {
                0: { cellWidth: 70 },
                1: { halign: 'center' },
                2: { halign: 'center' },
                3: { halign: 'right' },
                4: { halign: 'right' },
                5: { halign: 'right' }
            },
            margin: { left: 10, right: 10 },
            didDrawPage: (data) => { currentY = data.cursor.y; }
        });
        
        currentY = doc.lastAutoTable.finalY + 6;
        doc.setFillColor(241, 245, 249);
        doc.rect(130, currentY - 5, 70, 7, 'F');
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        doc.text(`SUBTOTAL ${familia}:`, 135, currentY);
        doc.text(`S/. ${grupos[familia].total.toFixed(2)}`, 195, currentY, { align: "right" });
        
        currentY += 12;
    }
    
    // Total
    if(currentY > 260) { doc.addPage(); currentY = 20; }
    currentY += 5;
    doc.setFillColor(239, 68, 68);
    doc.roundedRect(120, currentY, 80, 14, 2, 2, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.text("TOTAL URGENTE:", 125, currentY + 9);
    doc.text(totalGeneral.toFixed(2), 195, currentY + 9, { align: "right" });
    
    // Footer
    doc.setTextColor(100, 116, 139);
    doc.setFontSize(7);
    doc.text("Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego", 105, 285, { align: "center" });
    
    doc.save(`ORDEN_URGENTE_ALERTAS_${ahora.getTime()}.pdf`);
    alert(`‚úÖ ORDEN GENERADA\n\nSe ha creado el PDF con ${materialesCompra.length} materiales urgentes.\nTotal: S/. ${totalGeneral.toFixed(2)}`);
}


// ========== COST VARIANCE - CONTROL DE DESVIACIONES ==========
let filtroVariance = 'todos';

// Inicializar base de datos si no existe
if(!db.costVariance) db.costVariance = [];

function calcularCostoTeorico() {
    const skuPlato = document.getElementById('variance-plato').value;
    const cantidad = parseFloat(document.getElementById('variance-cantidad').value) || 0;
    
    if(!skuPlato || cantidad <= 0) {
        document.getElementById('variance-teorico').value = '';
        return;
    }
    
    const plato = db.platos.find(p => p.sku === skuPlato);
    if(!plato) return;
    
    const costoUnitario = plato.costoReceta;
    const costoTotal = costoUnitario * cantidad;
    
    document.getElementById('variance-teorico').value = `S/. ${costoTotal.toFixed(2)}`;
    calcularVarianceTemporal();
}

function calcularVarianceTemporal() {
    const teoricoStr = document.getElementById('variance-teorico').value;
    const realInput = parseFloat(document.getElementById('variance-real').value);
    
    if(!teoricoStr || !realInput) {
        document.getElementById('variance-preview').classList.add('hidden');
        return;
    }
    
    const teorico = parseFloat(teoricoStr.replace('S/. ', ''));
    const diferencia = realInput - teorico;
    const variancePercent = (diferencia / teorico) * 100;
    
    // Mostrar preview
    document.getElementById('variance-preview').classList.remove('hidden');
    
    // Diferencia
    const difElement = document.getElementById('variance-diferencia');
    difElement.textContent = `${Math.abs(diferencia.toFixed(2))}`;
    difElement.className = `text-2xl font-black ${diferencia > 0 ? 'text-red-600' : 'text-green-600'}`;
    
    // Porcentaje
    const percElement = document.getElementById('variance-porcentaje');
    percElement.textContent = `${variancePercent > 0 ? '+' : ''}${variancePercent.toFixed(2)}%`;
    percElement.className = `text-2xl font-black ${Math.abs(variancePercent) > 15 ? 'text-red-600' : Math.abs(variancePercent) > 10 ? 'text-orange-600' : Math.abs(variancePercent) > 5 ? 'text-amber-600' : 'text-green-600'}`;
    
    // Estado
    const estadoElement = document.getElementById('variance-estado');
    let estado, color;
    const absVariance = Math.abs(variancePercent);
    
    if(absVariance < 5) {
        estado = '‚úÖ EXCELENTE';
        color = 'text-green-600';
    } else if(absVariance < 10) {
        estado = 'üëç ACEPTABLE';
        color = 'text-amber-600';
    } else if(absVariance < 15) {
        estado = '‚ö†Ô∏è ALERTA';
        color = 'text-orange-600';
    } else {
        estado = 'üö® CR√çTICO';
        color = 'text-red-600';
    }
    
    estadoElement.textContent = estado;
    estadoElement.className = `text-2xl font-black ${color}`;
}

function guardarRegistroVariance() {
    const fecha = document.getElementById('variance-fecha').value;
    const skuPlato = document.getElementById('variance-plato').value;
    const cantidad = parseFloat(document.getElementById('variance-cantidad').value);
    const teoricoStr = document.getElementById('variance-teorico').value;
    const real = parseFloat(document.getElementById('variance-real').value);
    const observaciones = document.getElementById('variance-observaciones').value.trim();
    
    // Validaciones
    if(!fecha) {
        alert('‚ö†Ô∏è Selecciona una fecha');
        return;
    }
    
    if(!skuPlato) {
        alert('‚ö†Ô∏è Selecciona un plato');
        return;
    }
    
    if(!cantidad || cantidad <= 0) {
        alert('‚ö†Ô∏è Ingresa una cantidad v√°lida');
        return;
    }
    
    if(!real || real <= 0) {
        alert('‚ö†Ô∏è Ingresa el costo real gastado');
        return;
    }
    
    const plato = db.platos.find(p => p.sku === skuPlato);
    const teorico = parseFloat(teoricoStr.replace('S/. ', ''));
    const diferencia = real - teorico;
    const variancePercent = (diferencia / teorico) * 100;
    
    // Determinar categor√≠a
    const absVariance = Math.abs(variancePercent);
    let categoria;
    if(absVariance < 5) categoria = 'excelente';
    else if(absVariance < 10) categoria = 'aceptable';
    else if(absVariance < 15) categoria = 'alerta';
    else categoria = 'critico';
    
    // Crear registro
    const registro = {
        id: Date.now(),
        fecha: fecha,
        fechaRegistro: new Date().toLocaleString('es-PE'),
        plato: plato.nombre,
        skuPlato: skuPlato,
        cantidad: cantidad,
        costoTeorico: teorico,
        costoReal: real,
        diferencia: diferencia,
        variancePercent: variancePercent,
        categoria: categoria,
        observaciones: observaciones
    };
    
    db.costVariance.unshift(registro);
    
    // Limitar historial a 100 registros
    if(db.costVariance.length > 100) {
        db.costVariance = db.costVariance.slice(0, 100);
    }
    
    save();
    calcularMetricasVariance();
    renderVarianceHistorial();
    limpiarFormularioVariance();
    
    alert('‚úÖ Registro guardado correctamente');
}

function limpiarFormularioVariance() {
    document.getElementById('variance-fecha').value = '';
    document.getElementById('variance-plato').value = '';
    document.getElementById('variance-cantidad').value = '';
    document.getElementById('variance-teorico').value = '';
    document.getElementById('variance-real').value = '';
    document.getElementById('variance-observaciones').value = '';
    document.getElementById('variance-preview').classList.add('hidden');
}

function calcularMetricasVariance() {
    if(!db.costVariance || db.costVariance.length === 0) {
        document.getElementById('variance-total-registros').textContent = '0';
        document.getElementById('variance-costo-teorico').textContent = 'S/. 0';
        document.getElementById('variance-costo-real').textContent = 'S/. 0';
        document.getElementById('variance-promedio').textContent = '0%';
        return;
    }
    
    const totalRegistros = db.costVariance.length;
    const sumaTeorico = db.costVariance.reduce((sum, r) => sum + r.costoTeorico, 0);
    const sumaReal = db.costVariance.reduce((sum, r) => sum + r.costoReal, 0);
    const promedioVariance = db.costVariance.reduce((sum, r) => sum + Math.abs(r.variancePercent), 0) / totalRegistros;
    
    document.getElementById('variance-total-registros').textContent = totalRegistros;
    document.getElementById('variance-costo-teorico').textContent = `S/. ${sumaTeorico.toFixed(2)}`;
    document.getElementById('variance-costo-real').textContent = `S/. ${sumaReal.toFixed(2)}`;
    
    const percElement = document.getElementById('variance-promedio');
    percElement.textContent = `${promedioVariance.toFixed(2)}%`;
    
    // Cambiar color seg√∫n promedio
    const parent = percElement.parentElement;
    if(promedioVariance < 5) {
        parent.style.background = 'linear-gradient(to bottom right, #059669, #0d9488)';
    } else if(promedioVariance < 10) {
        parent.style.background = 'linear-gradient(to bottom right, #d97706, #ea580c)';
    } else {
        parent.style.background = 'linear-gradient(to bottom right, #dc2626, #e11d48)';
    }
}

function renderVarianceHistorial() {
    if(!db.costVariance || db.costVariance.length === 0) {
        document.getElementById('lista-variance').innerHTML = `
            <div class="col-span-full text-center py-12 text-slate-400">
                <div class="text-6xl mb-4">üìâ</div>
                <p class="font-bold text-lg">No hay registros de variance</p>
                <p class="text-sm">Comienza registrando costos reales de producci√≥n</p>
            </div>
        `;
        return;
    }
    
    let registrosFiltrados = db.costVariance;
    
    // Aplicar filtro
    if(filtroVariance !== 'todos') {
        registrosFiltrados = db.costVariance.filter(r => r.categoria === filtroVariance);
    }
    
    const html = registrosFiltrados.map(r => {
        // Configuraci√≥n por categor√≠a
        const configs = {
            excelente: {
                bg: 'from-emerald-50 to-teal-50 border-emerald-300',
                badge: 'bg-emerald-600 text-white',
                icon: '‚úÖ',
                label: 'EXCELENTE'
            },
            aceptable: {
                bg: 'from-amber-50 to-yellow-50 border-amber-300',
                badge: 'bg-amber-600 text-white',
                icon: 'üëç',
                label: 'ACEPTABLE'
            },
            alerta: {
                bg: 'from-orange-50 to-red-50 border-orange-300',
                badge: 'bg-orange-600 text-white',
                icon: '‚ö†Ô∏è',
                label: 'ALERTA'
            },
            critico: {
                bg: 'from-red-50 to-pink-50 border-red-300',
                badge: 'bg-red-600 text-white',
                icon: 'üö®',
                label: 'CR√çTICO'
            }
        };
        
        const config = configs[r.categoria];
        const esSobrecosto = r.diferencia > 0;
        
        return `
            <div class="bg-gradient-to-r ${config.bg} border-2 rounded-xl p-5 hover:shadow-lg transition-all">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-2xl">${config.icon}</span>
                            <div>
                                <p class="font-black text-sm">${r.plato}</p>
                                <p class="text-xs text-slate-500 font-semibold">
                                    ${new Date(r.fecha).toLocaleDateString('es-PE')} ‚Ä¢ ${r.cantidad} PAX
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="badge ${config.badge} text-xs">${config.label}</div>
                </div>
                
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <div class="bg-white rounded-lg p-3 text-center">
                        <p class="text-xs text-slate-500 font-semibold mb-1">TE√ìRICO</p>
                        <p class="text-lg font-black text-blue-600">S/. ${r.costoTeorico.toFixed(2)}</p>
                    </div>
                    <div class="bg-white rounded-lg p-3 text-center">
                        <p class="text-xs text-slate-500 font-semibold mb-1">REAL</p>
                        <p class="text-lg font-black text-purple-600">S/. ${r.costoReal.toFixed(2)}</p>
                    </div>
                    <div class="bg-white rounded-lg p-3 text-center">
                        <p class="text-xs text-slate-500 font-semibold mb-1">DIFERENCIA</p>
                        <p class="text-lg font-black ${esSobrecosto ? 'text-red-600' : 'text-green-600'}">
                            ${esSobrecosto ? '+' : ''}S/. ${r.diferencia.toFixed(2)}
                        </p>
                    </div>
                    <div class="bg-white rounded-lg p-3 text-center">
                        <p class="text-xs text-slate-500 font-semibold mb-1">VARIANCE</p>
                        <p class="text-lg font-black ${Math.abs(r.variancePercent) > 15 ? 'text-red-600' : Math.abs(r.variancePercent) > 10 ? 'text-orange-600' : 'text-amber-600'}">
                            ${r.variancePercent > 0 ? '+' : ''}${r.variancePercent.toFixed(2)}%
                        </p>
                    </div>
                </div>
                
                ${r.observaciones ? `
                    <div class="bg-white rounded-lg p-3 border-l-4 border-purple-500">
                        <p class="text-xs font-bold text-slate-700 mb-1">üí¨ Observaciones:</p>
                        <p class="text-xs text-slate-600">${r.observaciones}</p>
                    </div>
                ` : ''}
                
                <div class="flex gap-2 mt-3">
                    <button onclick="eliminarRegistroVariance(${r.id})" 
                            class="flex-1 bg-red-100 text-red-600 py-2 rounded-lg font-bold text-xs hover:bg-red-200 btn-action">
                        üóëÔ∏è ELIMINAR
                    </button>
                    <p class="text-xs text-slate-500 self-center">Registrado: ${r.fechaRegistro}</p>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('lista-variance').innerHTML = html;
}

function filtrarVariance(filtro) {
    filtroVariance = filtro;
    
    // Actualizar botones
    ['todos', 'excelente', 'aceptable', 'alerta', 'critico'].forEach(f => {
        const btn = document.getElementById(`btn-var-${f}`);
        if(f === filtro) {
            btn.className = 'bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-xl font-bold btn-action';
        } else {
            btn.className = 'bg-white text-slate-700 px-6 py-3 rounded-xl font-bold btn-action border-2 border-slate-200';
        }
    });
    
    renderVarianceHistorial();
}

function eliminarRegistroVariance(id) {
    if(!confirm('¬øEliminar este registro de variance?')) return;
    
    db.costVariance = db.costVariance.filter(r => r.id !== id);
    save();
    calcularMetricasVariance();
    renderVarianceHistorial();
}

// Actualizar dropdown al cargar secci√≥n
function actualizarDropdownVariance() {
    const select = document.getElementById('variance-plato');
    select.innerHTML = '<option value="">-- Seleccionar Plato --</option>' + 
        db.platos.sort((a, b) => a.nombre.localeCompare(b.nombre))
            .map(p => `<option value="${p.sku}">${p.nombre}</option>`).join('');
}

// Establecer fecha de hoy por defecto
function inicializarFechaVariance() {
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('variance-fecha').value = hoy;
}


// Variables para producci√≥n masiva de RB
let listaProduccionRB = [];
let resultadoProduccionRB = null;

function abrirProduccionMasivaRB() {
    document.getElementById('seccion-produccion-rb').classList.remove('hidden');
    document.getElementById('formulario-crear-rb').classList.add('hidden');
    listaProduccionRB = [];
    renderListaRBProduccion();
}

// B√∫squeda predictiva para producci√≥n masiva
function buscarRBProduccionMasiva() {
    const input = document.getElementById('rb-produccion-buscar').value.toUpperCase();
    const contenedor = document.getElementById('rb-produccion-sugerencias');
    
    if (input.length < 2) {
        contenedor.classList.add('hidden');
        return;
    }
    
    const coincidencias = db.recetasBase
        .filter(rb => rb.nombre.includes(input))
        .slice(0, 10)
        .sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    if (coincidencias.length === 0) {
        contenedor.innerHTML = '<div class="p-3 text-center text-slate-400">No se encontraron recetas</div>';
        contenedor.classList.remove('hidden');
        return;
    }
    
    contenedor.innerHTML = coincidencias.map(rb => `
        <div class="p-3 hover:bg-purple-50 cursor-pointer border-b border-slate-100 last:border-b-0"
             onclick="seleccionarRBProduccionMasiva('${rb.sku}')">
            <p class="font-bold text-sm text-slate-700">${rb.nombre}</p>
            <p class="text-xs text-slate-500">${rb.rendimiento} ${rb.unidad} ‚Ä¢ ${rb.ingredientes.length} ingredientes</p>
        </div>
    `).join('');
    
    contenedor.classList.remove('hidden');
}

function seleccionarRBProduccionMasiva(sku) {
    const rb = db.recetasBase.find(r => r.sku === sku);
    if (!rb) return;
    
    document.getElementById('rb-produccion-select').value = rb.sku;
    document.getElementById('rb-produccion-buscar').value = rb.nombre;
    document.getElementById('rb-produccion-sugerencias').classList.add('hidden');
    document.getElementById('rb-produccion-cantidad').focus();
}

// Cerrar sugerencias al hacer click fuera
document.addEventListener('click', function(e) {
    const input = document.getElementById('rb-produccion-buscar');
    const sugerencias = document.getElementById('rb-produccion-sugerencias');
    
    if (input && sugerencias && !input.contains(e.target) && !sugerencias.contains(e.target)) {
        sugerencias.classList.add('hidden');
    }
});

function cerrarProduccionMasivaRB() {
    document.getElementById('seccion-produccion-rb').classList.add('hidden');
    document.getElementById('formulario-crear-rb').classList.remove('hidden');
    listaProduccionRB = [];
    resultadoProduccionRB = null;
    document.getElementById('resultado-rb-produccion').innerHTML = '';
    document.getElementById('btn-exportar-rb-produccion').classList.add('opacity-50', 'pointer-events-none');
}

function agregarRBProduccion() {
    const sku = document.getElementById('rb-produccion-select').value;
    const cantidad = parseFloat(document.getElementById('rb-produccion-cantidad').value) || 0;
    
    if (!sku) {
        alert('‚ö†Ô∏è Selecciona una receta base');
        return;
    }
    
    if (cantidad <= 0) {
        alert('‚ö†Ô∏è Ingresa una cantidad v√°lida');
        return;
    }
    
    const rb = db.recetasBase.find(r => r.sku === sku);
    
    // Verificar si ya existe
    const existe = listaProduccionRB.find(r => r.sku === sku);
    if (existe) {
        existe.cantidad = cantidad;
    } else {
        listaProduccionRB.push({
            sku: rb.sku,
            nombre: rb.nombre,
            cantidad: cantidad,
            unidad: rb.unidad
        });
    }
    
    renderListaRBProduccion();
    document.getElementById('rb-produccion-select').value = '';
    document.getElementById('rb-produccion-buscar').value = '';
    document.getElementById('rb-produccion-cantidad').value = '';
    document.getElementById('rb-produccion-buscar').focus();
    
    // CALCULAR AUTOM√ÅTICAMENTE LA EXPLOSI√ìN
    calcularProduccionRB();
}

function eliminarRBProduccion(sku) {
    listaProduccionRB = listaProduccionRB.filter(r => r.sku !== sku);
    renderListaRBProduccion();
    
    // Recalcular si quedan recetas
    if (listaProduccionRB.length > 0) {
        calcularProduccionRB();
    } else {
        // Limpiar resultado si no quedan recetas
        document.getElementById('resultado-rb-produccion').innerHTML = '';
        document.getElementById('btn-exportar-rb-produccion').classList.add('opacity-50', 'pointer-events-none');
    }
}

function renderListaRBProduccion() {
    const container = document.getElementById('lista-rb-produccion');
    
    if (listaProduccionRB.length === 0) {
        container.innerHTML = `
            <div class="bg-amber-50 border-2 border-amber-300 rounded-xl p-4 text-center">
                <p class="text-amber-700 font-semibold">‚ö†Ô∏è No hay recetas base agregadas</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="bg-white rounded-xl p-4 border-2 border-purple-200">
            <p class="text-sm font-bold text-purple-700 mb-3">RECETAS BASE A PRODUCIR</p>
            <div class="space-y-2">
                ${listaProduccionRB.map(rb => `
                    <div class="flex justify-between items-center bg-purple-50 p-3 rounded-lg">
                        <div>
                            <p class="font-bold text-purple-700">${rb.nombre}</p>
                            <p class="text-sm text-slate-600">${rb.cantidad.toFixed(2)} ${rb.unidad}</p>
                        </div>
                        <button onclick="eliminarRBProduccion('${rb.sku}')" class="bg-red-500 text-white px-3 py-1 rounded-lg font-bold hover:bg-red-600">
                            üóëÔ∏è
                        </button>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function calcularProduccionRB() {
    if (listaProduccionRB.length === 0) {
        alert('‚ö†Ô∏è Agrega al menos una receta base');
        return;
    }
    
    // Calcular explosi√≥n de cada RB
    const desglosePorRB = [];
    let consolidadoTotal = {};
    
    listaProduccionRB.forEach(item => {
        const rb = db.recetasBase.find(r => r.sku === item.sku);
        const factor = item.cantidad / rb.rendimiento;
        
        let materialesRB = [];
        let consolidadoRB = {};
        
        rb.ingredientes.forEach(ing => {
            const cantidadNecesaria = ing.cant * factor;
            explode(ing.sku, cantidadNecesaria, consolidadoRB);
        });
        
        // Convertir a array para mostrar
        Object.keys(consolidadoRB).forEach(sku => {
            const mat = db.materiales.find(m => m.sku === sku);
            if (mat) {
                const cantEnUnidadCosto = consolidadoRB[sku];
                
                // ‚úÖ USAR UNIDAD DE COSTO (m√°s √∫til para el chef en cocina)
                materialesRB.push({
                    sku: sku,
                    nombre: mat.nombre,
                    cantidad: cantEnUnidadCosto,  // Cantidad en unidad de costo (ej: 189 ml en vez de 0.21 UND)
                    unidad: mat.uCosto            // Unidad de costo (ej: ML en vez de UND)
                });
                
                // Agregar al consolidado total
                if (!consolidadoTotal[sku]) {
                    consolidadoTotal[sku] = 0;
                }
                consolidadoTotal[sku] += cantEnUnidadCosto;
            }
        });
        
        desglosePorRB.push({
            sku: item.sku,
            nombre: item.nombre,
            cantidad: item.cantidad,
            unidad: item.unidad,
            materiales: materialesRB
        });
    });
    
    // Convertir consolidado total a array
    const consolidadoArray = Object.keys(consolidadoTotal).map(sku => {
        const mat = db.materiales.find(m => m.sku === sku);
        const cantEnUnidadCosto = consolidadoTotal[sku];
        
        // ‚úÖ USAR UNIDAD DE COSTO (m√°s clara para almac√©n)
        return {
            sku: sku,
            nombre: mat.nombre,
            cantidad: cantEnUnidadCosto,  // Cantidad en unidad de costo (ej: 450 g en vez de 0.45 kg)
            unidad: mat.uCosto,           // Unidad de costo (ej: G en vez de KG)
            familia: mat.familia || 'OTROS'
        };
    }).sort((a, b) => a.familia.localeCompare(b.familia));
    
    resultadoProduccionRB = {
        desglose: desglosePorRB,
        consolidado: consolidadoArray
    };
    
    mostrarResultadoProduccionRB();
    document.getElementById('btn-exportar-rb-produccion').classList.remove('opacity-50', 'pointer-events-none');
}

function mostrarResultadoProduccionRB() {
    const html = `
        <div class="bg-white rounded-xl p-6 border-2 border-green-300">
            <h4 class="text-lg font-black text-green-700 mb-4">‚úÖ EXPLOSI√ìN CALCULADA</h4>
            
            <div class="mb-4">
                <p class="text-sm font-bold text-purple-700 mb-2">üìã DESGLOSE POR RECETA BASE:</p>
                ${resultadoProduccionRB.desglose.map(rb => `
                    <div class="bg-purple-50 rounded-lg p-3 mb-2 border border-purple-200">
                        <p class="font-bold text-purple-700">${rb.nombre} - ${rb.cantidad.toFixed(2)} ${rb.unidad}</p>
                        <div class="text-sm text-slate-600 mt-2 space-y-1">
                            ${rb.materiales.map(mat => `
                                <div class="flex justify-between">
                                    <span>‚Ä¢ ${mat.nombre}</span>
                                    <span class="font-semibold">${mat.cantidad.toFixed(2)} ${mat.unidad}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div>
                <p class="text-sm font-bold text-green-700 mb-2">üì¶ CONSOLIDADO TOTAL:</p>
                <div class="bg-green-50 rounded-lg p-3 border border-green-200">
                    <div class="text-sm text-slate-700 space-y-1">
                        ${resultadoProduccionRB.consolidado.map(mat => `
                            <div class="flex justify-between">
                                <span class="font-semibold">${mat.nombre}</span>
                                <span class="font-bold text-green-700">${mat.cantidad.toFixed(2)} ${mat.unidad}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('resultado-rb-produccion').innerHTML = html;
}

function exportarProduccionRBMasivaPDF() {
    if (!resultadoProduccionRB) {
        alert('‚ö†Ô∏è Primero calcula la explosi√≥n');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const ahora = new Date();
    
    // Encabezado
    doc.setFillColor(147, 51, 234);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setFillColor(255, 255, 255);
    doc.circle(25, 15, 7, 'F');
    doc.setFillColor(147, 51, 234);
    doc.circle(25, 15, 5.5, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text(normalizarTexto('SWISSOTEL'), 105, 10, { align: 'center' });
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(normalizarTexto('HOTELERA COSTA DEL PACIFICO S.A. - RUC: 20297885538'), 105, 16, { align: 'center' });
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text(normalizarTexto('PRODUCCION MASIVA DE RECETAS BASE'), 105, 24, { align: 'center' });
    doc.setFontSize(8);
    doc.text('Fecha: ' + ahora.toLocaleDateString('es-PE') + ' ' + ahora.toLocaleTimeString('es-PE'), 105, 32, { align: 'center' });
    
    let y = 50;
    let pagina = 1;
    
    // DESGLOSE POR RECETA BASE
    doc.setTextColor(147, 51, 234);
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text(normalizarTexto('DESGLOSE POR RECETA BASE'), 14, y);
    y += 10;
    
    resultadoProduccionRB.desglose.forEach(rb => {
        if (y > 250) {
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('Pagina ' + pagina, 190, 285);
            doc.addPage();
            pagina++;
            y = 20;
        }
        
        // Header de RB
        doc.setFillColor(243, 232, 255);
        doc.roundedRect(14, y, 182, 10, 2, 2, 'F');
        doc.setTextColor(147, 51, 234);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text(normalizarTexto(rb.nombre + ' - ' + rb.cantidad.toFixed(2) + ' ' + rb.unidad), 18, y + 7);
        y += 15;
        
        // Materiales
        rb.materiales.forEach(mat => {
            if (y > 270) {
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text('Pagina ' + pagina, 190, 285);
                doc.addPage();
                pagina++;
                y = 20;
            }
            
            doc.setTextColor(100, 116, 139);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('‚Ä¢ ' + normalizarTexto(mat.nombre), 20, y);
            doc.setFont(undefined, 'bold');
            doc.text(mat.cantidad.toFixed(2) + ' ' + normalizarTexto(mat.unidad), 180, y, { align: 'right' });
            y += 6;
        });
        
        // ===== AGREGAR INSTRUCCIONES SI EXISTEN =====
        const rbData = db.recetasBase.find(r => r.sku === rb.sku);
        if (rbData && rbData.instrucciones && rbData.instrucciones.trim()) {
            y += 3;
            
            // Verificar espacio para instrucciones
            if (y > 230) {
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text('Pagina ' + pagina, 190, 285);
                doc.addPage();
                pagina++;
                y = 20;
            }
            
            // T√≠tulo de instrucciones
            doc.setFillColor(251, 191, 36); // Amber
            doc.roundedRect(18, y - 2, 174, 7, 1, 1, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('INSTRUCCIONES DE PREPARACION', 20, y + 3);
            y += 10;
            
            // Contenido de instrucciones
            doc.setTextColor(51, 65, 85);
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            
            const instruccionesText = normalizarTexto(rbData.instrucciones);
            const lines = doc.splitTextToSize(instruccionesText, 170);
            
            lines.forEach(line => {
                if (y > 270) {
                    doc.setFontSize(7);
                    doc.setTextColor(150, 150, 150);
                    doc.text('Pagina ' + pagina, 190, 285);
                    doc.addPage();
                    pagina++;
                    y = 20;
                    doc.setTextColor(51, 65, 85);
                    doc.setFontSize(8);
                }
                doc.text(line, 20, y);
                y += 4;
            });
        }
        
        y += 5;
    });
    
    // CONSOLIDADO TOTAL
    if (y > 200) {
        doc.addPage();
        pagina++;
        y = 20;
    }
    
    y += 10;
    doc.setFillColor(16, 185, 129);
    doc.roundedRect(14, y, 182, 10, 2, 2, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text(normalizarTexto('CONSOLIDADO TOTAL - ENTREGAR AL ALMACENERO'), 18, y + 7);
    y += 15;
    
    // Agrupar por familia
    const porFamilias = {};
    resultadoProduccionRB.consolidado.forEach(mat => {
        if (!porFamilias[mat.familia]) {
            porFamilias[mat.familia] = [];
        }
        porFamilias[mat.familia].push(mat);
    });
    
    Object.keys(porFamilias).sort().forEach(familia => {
        if (y > 260) {
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('Pagina ' + pagina, 190, 285);
            doc.addPage();
            pagina++;
            y = 20;
        }
        
        // Header familia
        doc.setFillColor(209, 250, 229);
        doc.roundedRect(14, y, 182, 8, 2, 2, 'F');
        doc.setTextColor(16, 185, 129);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(normalizarTexto(familia.toUpperCase()), 18, y + 5);
        y += 12;
        
        // Materiales
        porFamilias[familia].forEach(mat => {
            if (y > 270) {
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text('Pagina ' + pagina, 190, 285);
                doc.addPage();
                pagina++;
                y = 20;
            }
            
            doc.setTextColor(51, 65, 85);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text('‚Ä¢ ' + normalizarTexto(mat.nombre), 20, y);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(16, 185, 129);
            doc.text(mat.cantidad.toFixed(2) + ' ' + normalizarTexto(mat.unidad), 180, y, { align: 'right' });
            y += 6;
        });
        
        y += 3;
    });
    
    // Footer
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.text('Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego', 14, 285);
    doc.text('Pagina ' + pagina, 190, 285);
    
    const nombre = 'PRODUCCION_RB_' + Date.now() + '.pdf';
    doc.save(nombre);
    
    alert('‚úÖ PDF de producci√≥n generado correctamente');
}

// ========== GESTI√ìN DE √ìRDENES PENDIENTES ==========

function generarOrdenesPendientes() {
    if (listaProduccionRB.length === 0) {
        alert('‚ö†Ô∏è Agrega al menos una receta base');
        return;
    }
    
    const fecha = new Date().toISOString().split('T')[0];
    let ordenesCreadas = 0;
    
    listaProduccionRB.forEach(item => {
        const rb = db.recetasBase.find(r => r.sku === item.sku);
        const factor = item.cantidad / rb.rendimiento;
        
        // Calcular explosi√≥n de materiales (igual que en calcularProduccionRB)
        let consolidadoRB = {};
        
        rb.ingredientes.forEach(ing => {
            const cantidadNecesaria = ing.cant * factor;
            explode(ing.sku, cantidadNecesaria, consolidadoRB);
        });
        
        // Convertir consolidado a array de insumos
        const insumos = Object.keys(consolidadoRB).map(sku => {
            const mat = db.materiales.find(m => m.sku === sku);
            if (!mat) return null; // Saltar si no encuentra material
            
            const cantEnUnidadCosto = consolidadoRB[sku];
            const stockActual = db.inventario[sku] || 0;
            
            return {
                sku: sku,
                nombre: mat.nombre,
                cantidadNecesaria: cantEnUnidadCosto,
                unidad: mat.uCosto,
                stockActual: stockActual,
                precio: mat.precio / mat.factor
            };
        }).filter(ins => ins !== null); // Eliminar nulls
        
        const costoTotal = insumos.reduce((sum, ins) => sum + (ins.cantidadNecesaria * ins.precio), 0);
        
        // Crear orden pendiente
        const orden = {
            id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 5),
            fecha: fecha,
            receta: rb.nombre,
            skuReceta: rb.sku,
            cantidad: item.cantidad,
            unidad: item.unidad,
            costoTotal: costoTotal,
            costoUnitario: costoTotal / item.cantidad,
            insumos: insumos,
            estado: 'PENDIENTE',
            timestamp: new Date().toISOString()
        };
        
        db.ordenesPendientes.push(orden);
        ordenesCreadas++;
    });
    
    save();
    
    alert(`‚úÖ SE GENERARON ${ordenesCreadas} √ìRDENES DE PRODUCCI√ìN\n\nEstas √≥rdenes est√°n pendientes de procesamiento.`);
    
    // Limpiar lista
    listaProduccionRB = [];
    renderListaRBProduccion();
    cerrarProduccionMasivaRB();
}

function renderOrdenesPendientes() {
    const ordenes = db.ordenesPendientes.filter(o => o.estado === 'PENDIENTE');
    const container = document.getElementById('lista-ordenes-pendientes');
    const contador = document.getElementById('contador-ordenes-pendientes');
    
    contador.textContent = `${ordenes.length} √≥rdenes`;
    
    if (ordenes.length === 0) {
        container.innerHTML = `
            <div class="bg-white border-2 border-orange-200 rounded-xl p-6 text-center">
                <p class="text-orange-600 font-bold">‚úì No hay √≥rdenes pendientes</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = ordenes.map(orden => {
        const insuficientes = orden.insumos.filter(ins => ins.stockActual < ins.cantidadNecesaria);
        const todoDisponible = insuficientes.length === 0;
        
        return `
            <div class="bg-white border-2 ${todoDisponible ? 'border-green-300' : 'border-orange-300'} rounded-xl p-4">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <p class="font-black text-lg text-slate-800">${orden.receta}</p>
                        <p class="text-sm text-slate-600">Cantidad: ${orden.cantidad} ${orden.unidad} ‚Ä¢ Costo: S/. ${orden.costoTotal.toFixed(2)}</p>
                        <p class="text-xs text-slate-500">Orden creada: ${orden.fecha}</p>
                    </div>
                    <div class="text-right">
                        ${todoDisponible ? 
                            '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-lg font-bold text-xs">‚úì LISTO</span>' :
                            '<span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-lg font-bold text-xs">‚ö† FALTA STOCK</span>'
                        }
                    </div>
                </div>
                
                <details class="mb-3">
                    <summary class="text-sm font-bold text-slate-600 cursor-pointer hover:text-orange-600">
                        üì¶ Ver insumos necesarios (${orden.insumos.length})
                    </summary>
                    <div class="mt-2 space-y-1">
                        ${orden.insumos.map(ins => {
                            const suficiente = ins.stockActual >= ins.cantidadNecesaria;
                            return `
                                <div class="flex justify-between text-xs ${suficiente ? '' : 'text-orange-700 font-semibold'}">
                                    <span>${ins.nombre}</span>
                                    <span>Necesita: ${ins.cantidadNecesaria.toFixed(2)} ${ins.unidad} | Stock: ${ins.stockActual.toFixed(2)}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </details>
                
                <div class="flex gap-2">
                    <button onclick="procesarOrdenPendiente('${orden.id}')" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-2 rounded-lg font-bold btn-action text-sm">
                        ‚úÖ PROCESAR ORDEN
                    </button>
                    <button onclick="cancelarOrdenPendiente('${orden.id}')" class="px-4 bg-red-500 text-white py-2 rounded-lg font-bold btn-action text-sm">
                        ‚ùå CANCELAR
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function procesarOrdenPendiente(ordenId) {
    const orden = db.ordenesPendientes.find(o => o.id === ordenId);
    if (!orden) return;
    
    // Verificar stock insuficiente
    const insuficientes = orden.insumos.filter(ins => ins.stockActual < ins.cantidadNecesaria);
    
    let mensaje = `¬øConfirmas procesar la orden de producci√≥n?\n\n${orden.receta}\nCantidad: ${orden.cantidad} ${orden.unidad}\nCosto: S/. ${orden.costoTotal.toFixed(2)}`;
    
    if (insuficientes.length > 0) {
        mensaje += `\n\n‚ö†Ô∏è ADVERTENCIA: Los siguientes insumos quedar√°n en NEGATIVO:\n\n`;
        insuficientes.forEach(ins => {
            const faltante = ins.cantidadNecesaria - ins.stockActual;
            mensaje += `‚Ä¢ ${ins.nombre}: Falta ${faltante.toFixed(2)} ${ins.unidad}\n`;
        });
        mensaje += `\n¬øDeseas continuar de todas formas?`;
    }
    
    if (!confirm(mensaje)) return;
    
    // 1. DESCARGAR INSUMOS
    orden.insumos.forEach(ins => {
        db.inventario[ins.sku] = (db.inventario[ins.sku] || 0) - ins.cantidadNecesaria;
    });
    
    // 2. GENERAR STOCK RB
    const skuMaterial = 'MAT-' + orden.skuReceta;
    db.inventario[skuMaterial] = (db.inventario[skuMaterial] || 0) + orden.cantidad;
    
    // 3. CAMBIAR ESTADO DE ORDEN
    orden.estado = 'PROCESADA';
    orden.fechaProcesamiento = new Date().toISOString().split('T')[0];
    
    // 4. REGISTRAR EN HISTORIAL DE PRODUCCIONES
    db.produccionesRB.push({
        id: orden.id,
        fecha: orden.fechaProcesamiento,
        receta: orden.receta,
        skuReceta: orden.skuReceta,
        cantidad: orden.cantidad,
        unidad: orden.unidad,
        costoTotal: orden.costoTotal,
        costoUnitario: orden.costoUnitario,
        insumos: orden.insumos.map(ins => ({
            sku: ins.sku,
            nombre: ins.nombre,
            cantidad: ins.cantidadNecesaria,
            unidad: ins.unidad
        })),
        timestamp: new Date().toISOString()
    });
    
    save();
    renderStock();
    renderOrdenesPendientes();
    renderHistorialProducciones();
    
    alert(`‚úÖ ORDEN PROCESADA\n\nSe produjo: ${orden.cantidad} ${orden.unidad} de ${orden.receta}\nStock actualizado en inventario.`);
}

function cancelarOrdenPendiente(ordenId) {
    if (!confirm('¬øSeguro que deseas cancelar esta orden?')) return;
    
    db.ordenesPendientes = db.ordenesPendientes.filter(o => o.id !== ordenId);
    save();
    renderOrdenesPendientes();
    alert('‚úÖ Orden cancelada');
}

// ========== GESTI√ìN DE PROVEEDORES ==========
function renderProveedores() {
    if (!db.proveedores) db.proveedores = [];
    
    const query = (document.getElementById('search-proveedores')?.value || '').toUpperCase();
    const filtered = db.proveedores.filter(p => 
        p.nombre.toUpperCase().includes(query) || 
        p.ruc.includes(query)
    );
    
    const html = filtered.map(p => `
        <tr class="hover:bg-blue-50 transition-colors">
            <td class="p-4">
                <span class="font-mono text-xs bg-blue-100 px-2 py-1 rounded">${p.ruc}</span>
            </td>
            <td class="p-4 font-semibold">${p.nombre}</td>
            <td class="p-4 text-slate-600">${p.direccion || '-'}</td>
            <td class="p-4 text-right">
                <div class="flex gap-2 justify-end">
                    <button onclick="editarProveedor('${p.id}')" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-200 btn-action">
                        ‚úèÔ∏è
                    </button>
                    <button onclick="eliminarProveedor('${p.id}')" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-200 btn-action">
                        üóëÔ∏è
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    document.getElementById('proveedores-list').innerHTML = html || `
        <tr><td colspan="4" class="p-8 text-center text-slate-400">
            <div class="text-4xl mb-2">üì≠</div>
            No hay proveedores registrados
        </td></tr>
    `;
    
    actualizarSelectProveedores();
}

function guardarProveedor() {
    if (!db.proveedores) db.proveedores = [];
    
    const id = document.getElementById('prov-id-hidden').value;
    const ruc = document.getElementById('prov-ruc').value.trim();
    const nombre = document.getElementById('prov-nombre').value.trim();
    const direccion = document.getElementById('prov-direccion').value.trim();
    
    if (!ruc || !nombre) {
        alert('‚ö†Ô∏è RUC y Nombre son obligatorios');
        return;
    }
    
    if (ruc.length !== 11) {
        alert('‚ö†Ô∏è El RUC debe tener 11 d√≠gitos');
        return;
    }
    
    const proveedor = {
        id: id || Date.now().toString(),
        ruc: ruc,
        nombre: nombre,
        direccion: direccion
    };
    
    if (id) {
        const idx = db.proveedores.findIndex(p => p.id === id);
        db.proveedores[idx] = proveedor;
    } else {
        db.proveedores.push(proveedor);
    }
    
    limpiarFormProveedor();
    save();
    renderProveedores();
    alert('‚úÖ Proveedor guardado correctamente');
}

function editarProveedor(id) {
    const prov = db.proveedores.find(p => p.id === id);
    document.getElementById('prov-id-hidden').value = prov.id;
    document.getElementById('prov-ruc').value = prov.ruc;
    document.getElementById('prov-nombre').value = prov.nombre;
    document.getElementById('prov-direccion').value = prov.direccion || '';
}

function eliminarProveedor(id) {
    if (confirm('¬øEliminar este proveedor?')) {
        db.proveedores = db.proveedores.filter(p => p.id !== id);
        save();
        renderProveedores();
    }
}

function limpiarFormProveedor() {
    document.getElementById('prov-id-hidden').value = '';
    document.getElementById('prov-ruc').value = '';
    document.getElementById('prov-nombre').value = '';
    document.getElementById('prov-direccion').value = '';
}

function actualizarSelectProveedores() {
    const select = document.getElementById('doc-proveedor');
    if (select) {
        const valorActual = select.value;
        select.innerHTML = '<option value="">-- Seleccionar Proveedor --</option>' +
            db.proveedores.map(p => `<option value="${p.id}">${p.ruc ? p.ruc + ' - ' : ''}${p.nombre}</option>`).join('');
        select.value = valorActual;
    }
}

// ========== SISTEMA DE USUARIOS Y LOGIN ==========
let usuarioActual = null;
let autoLoginTimeout = null; // Para controlar el auto-login con delay
let pedidoActual = {
    tipo: null, // 'salon' o 'llevar'
    mesa: null,
    items: [],
    total: 0
};

// Variables para ajuste de inventario
let modoAjusteInventario = false;
let inventarioAntesCambios = {};

// Funciones para guardar/restaurar sesi√≥n
function guardarSesion(usuario) {
    sessionStorage.setItem('gastro_sesion_activa', JSON.stringify(usuario));
    console.log('üíæ Sesi√≥n guardada (solo para esta sesi√≥n del navegador):', usuario.nombre);
}

function restaurarSesion() {
    const sesionGuardada = sessionStorage.getItem('gastro_sesion_activa');
    if (sesionGuardada) {
        try {
            const usuario = JSON.parse(sesionGuardada);
            console.log('üîÑ Restaurando sesi√≥n de:', usuario.nombre);
            return usuario;
        } catch (error) {
            console.error('‚ùå Error al restaurar sesi√≥n:', error);
            return null;
        }
    }
    return null;
}

function limpiarSesion() {
    sessionStorage.removeItem('gastro_sesion_activa');
    console.log('üóëÔ∏è Sesi√≥n limpiada');
}

// ========== SISTEMA DE VALIDACI√ìN DE CLAVE ADMIN ==========
var accionPendienteClaveAdmin = null; // Guarda la funci√≥n a ejecutar despu√©s de validar

/**
 * Solicita clave de admin antes de ejecutar una funci√≥n
 * @param {Function} accion - Funci√≥n a ejecutar si la clave es correcta
 * @param {string} mensaje - Mensaje personalizado (opcional)
 */
function solicitarClaveAdmin(accion, mensaje) {
    // Si ya es admin, ejecutar directamente
    if (usuarioActual && usuarioActual.rol === 'admin') {
        console.log('‚úÖ Usuario es admin, ejecutando acci√≥n directamente');
        accion();
        return;
    }
    
    // Guardar acci√≥n pendiente
    accionPendienteClaveAdmin = accion;
    
    // Mostrar modal
    var modal = document.getElementById('modalClaveAdmin');
    var input = document.getElementById('input-clave-admin');
    var mensajeElement = document.getElementById('mensaje-clave-admin');
    var errorDiv = document.getElementById('error-clave-admin');
    
    if (mensaje) {
        mensajeElement.textContent = mensaje;
    } else {
        mensajeElement.textContent = 'Esta funci√≥n requiere clave de administrador';
    }
    
    // Limpiar y mostrar
    input.value = '';
    errorDiv.classList.add('hidden');
    modal.style.display = 'flex';
    
    // Auto-focus
    setTimeout(function() {
        input.focus();
    }, 100);
    
    console.log('üîê Solicitando clave de admin para funci√≥n protegida');
}

/**
 * Valida la clave ingresada
 */
/**
 * Abre el modal de clave de administrador
 * @param {string} tituloAccion - Descripci√≥n de la acci√≥n que se va a realizar
 */
function abrirModalClaveAdmin(tituloAccion) {
    var modal = document.getElementById('modalClaveAdmin');
    var input = document.getElementById('input-clave-admin');
    var errorDiv = document.getElementById('error-clave-admin');
    var mensajeDiv = document.getElementById('mensaje-clave-admin');
    
    // Actualizar mensaje
    if (tituloAccion) {
        mensajeDiv.textContent = 'Para ' + tituloAccion + ' necesitas autenticaci√≥n de administrador';
    } else {
        mensajeDiv.textContent = 'Esta funci√≥n requiere clave de administrador';
    }
    
    // Limpiar y mostrar modal
    input.value = '';
    errorDiv.classList.add('hidden');
    modal.style.display = 'flex';
    
    // Focus en el input
    setTimeout(function() {
        input.focus();
    }, 100);
    
    console.log('üîì Modal de clave admin abierto:', tituloAccion || 'Sin t√≠tulo');
}

/**
 * Valida la clave del administrador ingresada
 */
function validarClaveAdmin() {
    var input = document.getElementById('input-clave-admin');
    var claveIngresada = input.value.trim();
    var errorDiv = document.getElementById('error-clave-admin');
    
    if (!claveIngresada) {
        input.focus();
        return;
    }
    
    // Buscar admin en la base de datos
    var admin = db.usuarios ? db.usuarios.find(u => u.rol === 'admin') : null;
    
    if (!admin) {
        console.error('‚ùå No se encontr√≥ usuario admin en la base de datos');
        errorDiv.classList.remove('hidden');
        input.value = '';
        input.focus();
        return;
    }
    
    // Validar clave
    if (claveIngresada === admin.password) {
        console.log('‚úÖ Clave correcta, ejecutando acci√≥n');
        
        // Cerrar modal
        cerrarModalClaveAdmin();
        
        // Ejecutar acci√≥n pendiente
        if (accionPendienteClaveAdmin && typeof accionPendienteClaveAdmin === 'function') {
            accionPendienteClaveAdmin();
            accionPendienteClaveAdmin = null;
        }
    } else {
        console.log('‚ùå Clave incorrecta');
        errorDiv.classList.remove('hidden');
        input.value = '';
        input.focus();
        
        // Ocultar error despu√©s de 2 segundos
        setTimeout(function() {
            errorDiv.classList.add('hidden');
        }, 2000);
    }
}

/**
 * Cierra el modal de clave admin
 */
function cerrarModalClaveAdmin() {
    var modal = document.getElementById('modalClaveAdmin');
    var input = document.getElementById('input-clave-admin');
    var errorDiv = document.getElementById('error-clave-admin');
    
    modal.style.display = 'none';
    input.value = '';
    errorDiv.classList.add('hidden');
    accionPendienteClaveAdmin = null;
    
    console.log('üîí Modal de clave cerrado');
}

function aplicarPermisosPorRol(rol, silencioso) {
    if (!silencioso) {
        console.log('üîê INICIO - Aplicando permisos para rol:', rol);
        console.log('üîç Tipo de rol:', typeof rol);
    }
    
    // PERMISOS PERSONALIZADOS: Usar los permisos del usuario actual
    var permitidos = [];
    
    if (rol === 'admin') {
        // Admin siempre tiene acceso total
        permitidos = ['dashboard', 'bom', 'bases', 'menu', 'stock', 'planning', 'produccion', 'mrp', 'eventos', 'compras', 'familias', 'usuarios'];
    } else if (rol === 'mozo') {
        // Mozo solo ve POS
        permitidos = [];
    } else {
        // Chef, almac√©n, supervisor -> usar permisos personalizados
        if (usuarioActual && usuarioActual.permisos) {
            permitidos = usuarioActual.permisos;
        } else {
            // Permisos por defecto si no est√°n definidos (compatibilidad)
            const permisosDefecto = {
                chef: ['dashboard', 'bom', 'bases', 'menu', 'stock', 'planning', 'mrp', 'eventos', 'compras', 'familias'],
                almacen: ['bom', 'stock']
            };
            permitidos = permisosDefecto[rol] || [];
        }
    }
    
    if (!silencioso) {
        console.log('‚úÖ Secciones permitidas para ' + rol + ':', permitidos);
        console.log('üìè Cantidad de secciones permitidas:', permitidos.length);
        if (usuarioActual && usuarioActual.permisos) {
            console.log('üîê Usando permisos personalizados del usuario');
        }
    }
    
    // Lista de todos los botones del men√∫ (solo botones que existen f√≠sicamente)
    const todosLosBotones = ['dashboard', 'bom', 'bases', 'menu', 'stock', 'planning', 'mrp', 'eventos', 'compras', 'familias', 'usuarios'];
    
    // Ocultar/mostrar botones seg√∫n permisos
    let ocultados = 0;
    let mostrados = 0;
    let noEncontrados = 0;
    
    todosLosBotones.forEach(function(boton) {
        const elemento = document.getElementById('nav-' + boton);
        if (elemento) {
            if (permitidos.indexOf(boton) >= 0) {
                // Mostrar (remover todos los estilos de ocultaci√≥n)
                elemento.style.cssText = '';
                elemento.classList.remove('hidden');
                elemento.removeAttribute('hidden');
                mostrados++;
                if (!silencioso) console.log('  ‚úÖ MOSTRAR:', boton);
            } else {
                // Ocultar completamente con !important y m√∫ltiples m√©todos
                elemento.style.cssText = 'display: none !important; visibility: hidden !important;';
                elemento.classList.add('hidden');
                elemento.setAttribute('hidden', 'true');
                ocultados++;
                if (!silencioso) console.log('  ‚ùå OCULTAR:', boton);
            }
        } else {
            if (!silencioso) console.warn('  ‚ö†Ô∏è Bot√≥n NO encontrado:', 'nav-' + boton);
            noEncontrados++;
        }
    });
    
    if (!silencioso) {
        console.log('üìä RESULTADO FINAL:');
        console.log('  ‚Ä¢ Mostrados:', mostrados);
        console.log('  ‚Ä¢ Ocultados:', ocultados);
        console.log('  ‚Ä¢ No encontrados:', noEncontrados);
        console.log('üèÅ FIN aplicarPermisosPorRol');
    }
    
    // Aplicar restricciones espec√≠ficas por rol
    aplicarRestriccionesRol(rol, silencioso);
}

// ========== RESTRICCIONES ESPEC√çFICAS POR ROL ==========
function aplicarRestriccionesRol(rol, silencioso) {
    if (!silencioso) {
        console.log('üîí Aplicando restricciones espec√≠ficas para rol:', rol);
    }
    
    // CHEF: Solo lectura en MATERIALES
    if (rol === 'chef' || (usuarioActual && usuarioActual.rol === 'chef')) {
        if (!silencioso) console.log('üë®‚Äçüç≥ Aplicando modo SOLO LECTURA para Chef en Materiales');
        
        // Ocultar formulario de crear material
        const formCrear = document.getElementById('form-crear-material');
        if (formCrear) {
            formCrear.style.display = 'none';
            if (!silencioso) console.log('  ‚úÖ Formulario de creaci√≥n oculto');
        }
        
        // Ocultar botones de exportar/pegar
        const btnExportar = document.getElementById('btn-exportar-materiales');
        if (btnExportar) {
            btnExportar.style.display = 'none';
            if (!silencioso) console.log('  ‚úÖ Bot√≥n exportar oculto');
        }
        
        const btnPegar = document.getElementById('btn-pegar-materiales');
        if (btnPegar) {
            btnPegar.style.display = 'none';
            if (!silencioso) console.log('  ‚úÖ Bot√≥n pegar oculto');
        }
        
        // Ocultar botones de editar/eliminar en la tabla
        const botonesEditar = document.querySelectorAll('.btn-editar-material, .btn-eliminar-material');
        botonesEditar.forEach(btn => {
            btn.style.display = 'none';
        });
        
        // Ocultar columna de acciones
        const columnasAcciones = document.querySelectorAll('.acciones-material');
        columnasAcciones.forEach(col => {
            col.style.display = 'none';
        });
        
        // Ocultar encabezado de columna ACCIONES
        const headerAcciones = document.getElementById('th-acciones-materiales');
        if (headerAcciones) {
            headerAcciones.style.display = 'none';
            if (!silencioso) console.log('  ‚úÖ Header de acciones oculto');
        }
        
        if (!silencioso) console.log('  ‚úÖ Botones de acciones ocultos en tabla');
        
    } else {
        // OTROS ROLES: Mostrar todo
        if (!silencioso) console.log('‚úÖ Modo COMPLETO para', rol);
        
        const formCrear = document.getElementById('form-crear-material');
        if (formCrear) formCrear.style.display = '';
        
        const btnExportar = document.getElementById('btn-exportar-materiales');
        if (btnExportar) btnExportar.style.display = '';
        
        const btnPegar = document.getElementById('btn-pegar-materiales');
        if (btnPegar) btnPegar.style.display = '';
        
        const botonesEditar = document.querySelectorAll('.btn-editar-material, .btn-eliminar-material');
        botonesEditar.forEach(btn => {
            btn.style.display = '';
        });
        
        const columnasAcciones = document.querySelectorAll('.acciones-material');
        columnasAcciones.forEach(col => {
            col.style.display = '';
        });
        
        const headerAcciones = document.getElementById('th-acciones-materiales');
        if (headerAcciones) {
            headerAcciones.style.display = '';
        }
    }
}

// ========== TECLADO NUM√âRICO T√ÅCTIL ==========
function mostrarTecladoNumerico() {
    document.getElementById('teclado-numerico').classList.remove('hidden');
    document.getElementById('login-password').value = '';
}

function ocultarTecladoNumerico() {
    document.getElementById('teclado-numerico').classList.add('hidden');
    document.getElementById('login-password').blur();
    
    // Cancelar auto-login si estaba pendiente
    if (autoLoginTimeout) {
        clearTimeout(autoLoginTimeout);
        autoLoginTimeout = null;
    }
}

function agregarDigito(digito) {
    var input = document.getElementById('login-password');
    var valorActual = input.value;
    
    // Ocultar mensaje de error si est√° visible
    document.getElementById('login-error').classList.add('hidden');
    
    // Cancelar timeout anterior (si el usuario sigue escribiendo)
    if (autoLoginTimeout) {
        clearTimeout(autoLoginTimeout);
        autoLoginTimeout = null;
    }
    
    // Permitir hasta 6 d√≠gitos (para manager)
    if (valorActual.length < 6) {
        input.value = valorActual + digito;
        
        // Auto-login con delay solo cuando complete 4 o 6 d√≠gitos
        // Espera 800ms para ver si el usuario sigue escribiendo
        if (input.value.length === 4 || input.value.length === 6) {
            console.log('PIN de ' + input.value.length + ' d√≠gitos ingresado, esperando...');
            autoLoginTimeout = setTimeout(function() {
                console.log('Auto-login ejecutado (' + input.value.length + ' d√≠gitos)');
                iniciarSesionInteligente();
            }, 800); // Delay de 800ms
        }
    }
}

function borrarDigito() {
    var input = document.getElementById('login-password');
    input.value = input.value.slice(0, -1);
    
    // Cancelar auto-login si estaba pendiente
    if (autoLoginTimeout) {
        clearTimeout(autoLoginTimeout);
        autoLoginTimeout = null;
        console.log('Auto-login cancelado (usuario borr√≥ d√≠gito)');
    }
    
    // Ocultar error al borrar
    document.getElementById('login-error').classList.add('hidden');
}

function mostrarError(mensaje) {
    var errorDiv = document.getElementById('login-error');
    var errorText = document.getElementById('login-error-text');
    
    errorText.textContent = mensaje;
    errorDiv.classList.remove('hidden');
    
    // Limpiar PIN despu√©s de mostrar error
    setTimeout(function() {
        document.getElementById('login-password').value = '';
        // Mantener el teclado abierto
    }, 1500);
}

// ========== MINI REPRODUCTOR DE RADIO (MANAGER) ==========
function toggleRadio() {
    const miniRadio = document.getElementById('mini-radio');
    
    if (miniRadio.classList.contains('minimizado')) {
        miniRadio.classList.remove('minimizado');
        miniRadio.classList.add('expandido');
    } else {
        miniRadio.classList.remove('expandido');
        miniRadio.classList.add('minimizado');
    }
}

function mostrarRadioManager() {
    // Solo mostrar si el usuario es manager
    if (usuarioActual && usuarioActual.id === 'manager') {
        const miniRadio = document.getElementById('mini-radio');
        const radioIframe = document.getElementById('radio-iframe');
        
        // üîä Siempre recargar la radio (iniciar reproducci√≥n)
        if (radioIframe) {
            radioIframe.src = 'https://www.sondondo.com/radio-la-nube.html';
            console.log('üîä Radio encendida');
        }
        
        miniRadio.style.display = 'block';
        console.log('üìª Radio activada para Manager');
    }
}

function ocultarRadioManager() {
    const miniRadio = document.getElementById('mini-radio');
    const radioIframe = document.getElementById('radio-iframe');
    
    // üîá Apagar la radio (detener reproducci√≥n)
    if (radioIframe) {
        radioIframe.src = '';
        console.log('üîá Radio apagada');
    }
    
    // Minimizar si estaba expandida
    miniRadio.classList.remove('expandido');
    miniRadio.classList.add('minimizado');
    
    // Ocultar
    miniRadio.style.display = 'none';
    console.log('üìª Radio desactivada');
}

// ========== MOSTRAR SECCI√ìN POR ROL ==========
function mostrarSeccionPorRol(rol) {
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üìç mostrarSeccionPorRol() ejecutado');
    console.log('   - Rol recibido:', rol);
    console.log('   - usuarioActual:', usuarioActual);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    guardarSesion(usuarioActual); // Guardar sesi√≥n en localStorage
    
    // TODOS VAN AL M√ìDULO ADMINISTRATIVO (POS ELIMINADO)
    console.log('üìã ‚û°Ô∏è  REDIRIGIENDO A M√ìDULO ADMINISTRATIVO');
    
    const header = document.querySelector('header');
    const nav = document.querySelector('nav');
    const main = document.querySelector('main');
    if(header) header.classList.remove('hidden');
    if(nav) nav.classList.remove('hidden');
    if(main) main.classList.remove('hidden');
    
    const nombreUsuarioAdminElement = document.getElementById('nombre-usuario-admin');
    if (nombreUsuarioAdminElement) {
        nombreUsuarioAdminElement.textContent = usuarioActual.nombre;
    }
    
    // Aplicar permisos INMEDIATAMENTE
    console.log('‚è∞ Aplicando permisos inmediatamente...');
    aplicarPermisosPorRol(rol);
    
    // Y tambi√©n despu√©s del renderizado
    requestAnimationFrame(function() {
        console.log('‚è∞ Reaplicando permisos despu√©s del render...');
        aplicarPermisosPorRol(rol);
    });
    
    // Verificador permanente
    if (window.intervaloPermisos) {
        clearInterval(window.intervaloPermisos);
    }
    window.intervaloPermisos = setInterval(function() {
        aplicarPermisosPorRol(rol, true);
    }, 500);
    console.log('üîí Verificador permanente de permisos activado');
    
    console.log('‚úÖ REDIRIGIDO A ADMINISTRACI√ìN EXITOSAMENTE');
    
    // Registrar login en logs
    registrarActividad('login', 'Inicio de sesi√≥n', 'Usuario: ' + usuarioActual.nombre + ' (' + usuarioActual.rol + ')');
    
    // Inicializar ticker despu√©s del login
    setTimeout(() => {
        console.log('üé¨ Inicializando ticker...');
        inicializarTicker();
    }, 300);
    
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
}

function iniciarSesionInteligente() {
    const usuario = document.getElementById('login-usuario').value.trim();
    const pin = document.getElementById('login-password').value.trim();
    
    // üîí VALIDACI√ìN ESPECIAL: Manager puede tener PIN de 6 d√≠gitos
    const esManager = pin === '128080' && (!usuario || usuario.toLowerCase() === 'manager');
    
    if (!pin || (pin.length !== 4 && !esManager)) {
        mostrarError('‚ùå Ingresa un PIN de 4 d√≠gitos');
        return;
    }
    
    // Inicializar usuarios si no existen
    if (!db.usuarios) db.usuarios = [];
    
    // Usuario admin por defecto (respaldo, ya se crea en window.onload)
    const adminExiste = db.usuarios.find(u => u.id === 'admin');
    if (!adminExiste) {
        db.usuarios.push({
            id: 'admin',
            usuario: 'Admin',
            password: '1991',
            nombre: 'Administrador',
            rol: 'admin'
        });
        save();
        console.log('‚úÖ Usuario administrador creado por defecto (respaldo)');
    }
    
    // MODO 1: LOGIN R√ÅPIDO PARA MOZOS (solo PIN) o MANAGER con PIN de 6 d√≠gitos
    if (!usuario) {
        console.log('üîç MODO R√ÅPIDO: Buscando con PIN:', pin);
        console.log('üìä Usuarios en sistema:', db.usuarios.length);
        console.log('üìã Lista de usuarios:', db.usuarios.map(u => ({usuario: u.usuario, rol: u.rol, pin: u.password})));
        
        // üîí PRIORIDAD: Verificar si es manager con PIN de 6 d√≠gitos
        if (pin === '128080') {
            const manager = db.usuarios.find(u => u.id === 'manager');
            if (manager) {
                console.log('‚úÖ MANAGER ENCONTRADO - Acceso especial');
                usuarioActual = manager;
                document.getElementById('pantalla-login').style.display = 'none';
                setTimeout(() => { inicializarTicker(); }, 100);
                mostrarSeccionPorRol(manager.rol);
                
                // üìª Activar radio para manager
                setTimeout(() => { mostrarRadioManager(); }, 500);
                
                return;
            }
        }
        
        // Buscar mozo con ese PIN
        const mozo = db.usuarios.find(u => u.rol === 'mozo' && u.password === pin);
        
        if (mozo) {
            console.log('‚úÖ MOZO ENCONTRADO:', mozo);
            console.log('   - Nombre:', mozo.nombre);
            console.log('   - Rol:', mozo.rol);
            console.log('   - PIN:', mozo.password);
            console.log('üöÄ Ejecutando login de mozo...');
            
            usuarioActual = mozo;
            document.getElementById('pantalla-login').style.display = 'none';
            
            // Inicializar ticker inmediatamente
            setTimeout(() => {
                inicializarTicker();
            }, 100);
            
            console.log('üìç Llamando a mostrarSeccionPorRol con rol:', mozo.rol);
            mostrarSeccionPorRol(mozo.rol);
            return;
        } else {
            // No es mozo, puede ser admin/chef/almacen sin usuario
            console.log('‚ùå NO SE ENCONTR√ì MOZO con PIN:', pin);
            console.log('üîç Buscando en todos los usuarios...');
            
            // Buscar en todos los usuarios por si es admin/chef/almacen
            const otroUsuario = db.usuarios.find(u => u.password === pin);
            
            if (otroUsuario) {
                console.log('‚ÑπÔ∏è Usuario encontrado pero no es mozo:', otroUsuario);
                console.log('   - Rol:', otroUsuario.rol);
                mostrarError('üë®‚Äçüíº ' + otroUsuario.nombre + ': Ingresa tu usuario tambi√©n');
            } else {
                console.log('‚ùå PIN no existe en el sistema');
                mostrarError('‚ùå PIN incorrecto o no eres mozo');
            }
            return;
        }
    }
    
    // MODO 2: LOGIN NORMAL (usuario + PIN)
    console.log('üîç Login con usuario:', usuario);
    const user = db.usuarios.find(u => u.usuario.toLowerCase() === usuario.toLowerCase() && u.password === pin);
    
    if (!user) {
        console.log('‚ùå Usuario o PIN incorrectos');
        mostrarError('‚ùå Usuario o PIN incorrectos');
        return;
    }
    
    console.log('‚úÖ Login exitoso:', user.nombre);
    usuarioActual = user;
    document.getElementById('pantalla-login').style.display = 'none';
    
    // Inicializar ticker inmediatamente
    setTimeout(() => {
        inicializarTicker();
    }, 100);
    
    mostrarSeccionPorRol(user.rol);
    
    // üìª Activar radio si es manager
    if (user.id === 'manager') {
        setTimeout(() => { mostrarRadioManager(); }, 500);
    }
}

function iniciarSesion() {
    const usuario = document.getElementById('login-usuario').value.trim();
    const password = document.getElementById('login-password').value.trim();
    
    if (!usuario || !password) {
        alert('‚ö†Ô∏è Ingresa usuario y contrase√±a');
        return;
    }
    
    // Inicializar usuarios si no existen
    if (!db.usuarios) db.usuarios = [];
    
    // Usuario admin por defecto (respaldo, ya se crea en window.onload)
    const adminExiste = db.usuarios.find(u => u.id === 'admin');
    if (!adminExiste) {
        db.usuarios.push({
            id: 'admin',
            usuario: 'Admin',
            password: '1991',
            nombre: 'Administrador',
            rol: 'admin'
        });
        save();
        console.log('‚úÖ Usuario administrador creado por defecto (respaldo)');
    }
    
    // Buscar usuario (case-insensitive)
    const user = db.usuarios.find(u => u.usuario.toLowerCase() === usuario.toLowerCase() && u.password === password);
    
    if (!user) {
        alert('‚ùå Usuario o contrase√±a incorrectos');
        return;
    }
    
    usuarioActual = user;
    guardarSesion(user); // Guardar sesi√≥n en localStorage
    document.getElementById('pantalla-login').classList.add('hidden');
    
    // Todos van al m√≥dulo administrativo (POS eliminado)
    const header = document.querySelector('header');
    const nav = document.querySelector('nav');
    const main = document.querySelector('main');
    if(header) header.classList.remove('hidden');
    if(nav) nav.classList.remove('hidden');
    if(main) main.classList.remove('hidden');
    
    const nombreUsuarioAdminElement = document.getElementById('nombre-usuario-admin');
    if (nombreUsuarioAdminElement) {
        nombreUsuarioAdminElement.textContent = user.nombre;
    }
    
    // Aplicar permisos INMEDIATAMENTE
    console.log('‚è∞ Aplicando permisos inmediatamente...');
    aplicarPermisosPorRol(user.rol);
    
    // Y tambi√©n despu√©s del renderizado
    requestAnimationFrame(function() {
        console.log('‚è∞ Reaplicando permisos despu√©s del render...');
        aplicarPermisosPorRol(user.rol);
    });
    
    // Verificador permanente (se ejecuta cada 500ms SIEMPRE en modo silencioso)
    if (window.intervaloPermisos) {
        clearInterval(window.intervaloPermisos);
    }
    window.intervaloPermisos = setInterval(function() {
        aplicarPermisosPorRol(user.rol, true); // true = modo silencioso
    }, 500);
    console.log('üîí Verificador permanente de permisos activado (cada 500ms)');
    
    // Inicializar ticker inmediatamente despu√©s del login
    setTimeout(() => {
        console.log('üé¨ Inicializando ticker despu√©s del login...');
        inicializarTicker();
    }, 200);
}

function cerrarSesion() {
    if (confirm('¬øCerrar sesi√≥n?')) {
        // Registrar logout ANTES de limpiar usuarioActual
        if (usuarioActual) {
            registrarActividad('login', 'Cierre de sesi√≥n', 'Usuario: ' + usuarioActual.nombre + ' (' + usuarioActual.rol + ')');
        }
        
        usuarioActual = null;
        limpiarSesion(); // Limpiar sesi√≥n de localStorage
        
        // üìª Ocultar radio
        ocultarRadioManager();
        
        // Detener verificador de permisos
        if (window.intervaloPermisos) {
            clearInterval(window.intervaloPermisos);
            console.log('üîí Verificador de permisos detenido');
        }
        
        // Limpiar pedido actual
        pedidoActual = { tipo: null, mesa: null, items: [], total: 0 };
        
        // Limpiar campos de login
        document.getElementById('login-usuario').value = '';
        document.getElementById('login-password').value = '';
        
        // Ocultar error si est√° visible
        document.getElementById('login-error').classList.add('hidden');
        
        // Ocultar teclado si est√° visible
        document.getElementById('teclado-numerico').classList.add('hidden');
        
        // MOSTRAR pantalla de login
        document.getElementById('pantalla-login').style.display = 'flex';
        
        // OCULTAR m√≥dulo administrativo
        const header = document.querySelector('header');
        const nav = document.querySelector('nav');
        const main = document.querySelector('main');
        if(header) header.classList.add('hidden');
        if(nav) nav.classList.add('hidden');
        if(main) main.classList.add('hidden');
        
        console.log('‚úÖ Sesi√≥n cerrada correctamente');
    }
}

// ========== PANTALLA COMPLETA ==========
function toggleFullscreen() {
    const btn = document.getElementById('btn-fullscreen');
    
    if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
        // Entrar en pantalla completa
        const elem = document.documentElement;
        
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) { // Safari
            elem.webkitRequestFullscreen();
        } else if (elem.mozRequestFullScreen) { // Firefox
            elem.mozRequestFullScreen();
        } else if (elem.msRequestFullscreen) { // IE/Edge
            elem.msRequestFullscreen();
        }
        
        console.log('üñ•Ô∏è Pantalla completa activada');
    } else {
        // Salir de pantalla completa
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        
        console.log('üñ•Ô∏è Pantalla completa desactivada');
    }
}

// Detectar cambios en pantalla completa para actualizar el bot√≥n
document.addEventListener('fullscreenchange', actualizarBotonFullscreen);
document.addEventListener('webkitfullscreenchange', actualizarBotonFullscreen);
document.addEventListener('mozfullscreenchange', actualizarBotonFullscreen);
document.addEventListener('MSFullscreenChange', actualizarBotonFullscreen);

function actualizarBotonFullscreen() {
    const icono = document.getElementById('fullscreen-icon');
    
    if (icono) {
        if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
            icono.textContent = 'üî≤';
        } else {
            icono.textContent = 'üñ•Ô∏è';
        }
    }
}

// ========== GESTI√ìN DE USUARIOS ==========

// Cambiar entre m√≥dulos sin cerrar sesi√≥n
function cambiarModulo(destino) {
    if (!usuarioActual) {
        alert('‚ö†Ô∏è Error de sesi√≥n');
        return;
    }
    
    // Solo existe el m√≥dulo admin ahora (POS eliminado)
    if (destino === 'admin') {
        // Verificar que tenga permisos de admin
        if (usuarioActual.rol !== 'admin') {
            alert('‚ùå No tienes permisos de administrador');
            return;
        }
        
        // Mostrar m√≥dulo Admin
        const header = document.querySelector('header');
        const nav = document.querySelector('nav');
        const main = document.querySelector('main');
        if(header) header.classList.remove('hidden');
        if(nav) nav.classList.remove('hidden');
        if(main) main.classList.remove('hidden');
        
        const nombreUsuarioAdminElement3 = document.getElementById('nombre-usuario-admin');
        if (nombreUsuarioAdminElement3) {
            nombreUsuarioAdminElement3.textContent = usuarioActual.nombre;
        }
        
        // Aplicar permisos INMEDIATAMENTE
        aplicarPermisosPorRol(usuarioActual.rol);
        
        // Y tambi√©n despu√©s del renderizado
        requestAnimationFrame(function() {
            aplicarPermisosPorRol(usuarioActual.rol);
        });
    }
}

// ========== SISTEMA DE MESAS ==========
function seleccionarTipoPedido(tipo) {
    pedidoActual.tipo = tipo;
    
    if (tipo === 'salon') {
        document.getElementById('selector-tipo-pedido').classList.add('hidden');
        document.getElementById('seccion-calculadora-mesa').classList.remove('hidden');
        document.getElementById('seccion-pedido').classList.add('hidden');
        limpiarMesa();
    } else {
        pedidoActual.mesa = 'LLEVAR';
        document.getElementById('selector-tipo-pedido').classList.add('hidden');
        document.getElementById('seccion-calculadora-mesa').classList.add('hidden');
        document.getElementById('seccion-pedido').classList.remove('hidden');
        document.getElementById('mesa-actual').textContent = 'PARA LLEVAR';
        generarTabsCategorias(); // Generar tabs din√°micamente
        renderMenuPOS();
    }
}

var numeroMesaActual = '';

function agregarNumeroMesa(num) {
    console.log('Agregar numero:', num, 'Actual:', numeroMesaActual);
    if (numeroMesaActual.length < 2) {
        numeroMesaActual += num;
        var display = document.getElementById('display-mesa');
        if (display) {
            display.textContent = numeroMesaActual || '-';
        }
        console.log('Nuevo valor:', numeroMesaActual);
    }
}

function borrarNumeroMesa() {
    console.log('Borrar ultimo numero');
    numeroMesaActual = numeroMesaActual.slice(0, -1);
    var display = document.getElementById('display-mesa');
    if (display) {
        display.textContent = numeroMesaActual || '-';
    }
    console.log('Nuevo valor:', numeroMesaActual);
}

function limpiarMesa() {
    console.log('Limpiar mesa');
    numeroMesaActual = '';
    var display = document.getElementById('display-mesa');
    if (display) {
        display.textContent = '-';
    }
}

function confirmarMesa() {
    console.log('CONFIRMAR MESA - Inicio');
    console.log('numeroMesaActual:', numeroMesaActual);
    
    if (numeroMesaActual === '') {
        alert('Por favor ingresa un numero de mesa');
        return;
    }
    
    var numMesa = parseInt(numeroMesaActual);
    console.log('Numero parseado:', numMesa);
    
    if (numMesa < 1 || numMesa > 20) {
        alert('Numero de mesa invalido. Debe ser entre 1 y 20');
        limpiarMesa();
        return;
    }
    
    if (!db.mesas) db.mesas = [];
    
    // CREAR MESAS FALTANTES (asegurar que existan mesas 1-20)
    console.log('Verificando mesas existentes...');
    for (var i = 1; i <= 20; i++) {
        var mesaExiste = db.mesas.find(function(m) { return m.numero === i; });
        if (!mesaExiste) {
            console.log('Creando mesa', i);
            db.mesas.push({ numero: i, estado: 'libre', pedidoId: null });
        }
    }
    
    // Ordenar mesas por n√∫mero
    db.mesas.sort(function(a, b) { return a.numero - b.numero; });
    save();
    
    var mesa = db.mesas.find(function(m) { return m.numero === numMesa; });
    console.log('Mesa encontrada:', mesa);
    
    if (!mesa) {
        alert('Mesa no encontrada');
        return;
    }
    
    console.log('Estado de la mesa:', mesa.estado);
    console.log('pedidoId de la mesa:', mesa.pedidoId);
    
    if (mesa.estado === 'ocupada' && mesa.pedidoId && db.pedidosActivos && db.pedidosActivos[numMesa]) {
        console.log('Mesa ocupada, cargando pedido existente...');
        cargarPedidoExistente(mesa.pedidoId);
    } else {
        console.log('Mesa libre o sin pedido activo, iniciando nuevo pedido...');
        
        // Limpiar completamente pedidoActual
        pedidoActual = {
            tipo: 'salon',
            mesa: numMesa,
            items: [],
            total: 0,
            pedidoId: Date.now().toString()
        };
        
        // Actualizar estado de la mesa
        mesa.estado = 'ocupada';
        mesa.pedidoId = pedidoActual.pedidoId;
        
        // Crear pedido activo
        if (!db.pedidosActivos) db.pedidosActivos = {};
        db.pedidosActivos[numMesa] = {
            id: pedidoActual.pedidoId,
            items: [],
            total: 0,
            fecha: new Date().toISOString(),
            mozo: usuarioActual.nombre
        };
        
        save();
        console.log('Nuevo pedido creado para mesa', numMesa);
    }
    
    console.log('Cambiando a seccion pedido...');
    document.getElementById('seccion-calculadora-mesa').classList.add('hidden');
    document.getElementById('seccion-pedido').classList.remove('hidden');
    document.getElementById('mesa-actual').textContent = 'MESA ' + numMesa;
    
    // Limpiar visualizaci√≥n del pedido
    document.getElementById('items-pedido-actual').innerHTML = '';
    document.getElementById('total-pedido').textContent = '0.00';
    
    generarTabsCategorias(); // Generar tabs din√°micamente
    renderMenuPOS();
    limpiarMesa();
    console.log('CONFIRMAR MESA - Completado');
}



// ========== MEN√ö Y PEDIDOS ==========
// Generar tabs de categor√≠as din√°micamente
function generarTabsCategorias() {
    // ‚úÖ NUEVO: Filtrar platos por tipo de carta primero
    var platosAMostrar = db.platos;
    if (filtroTipoCarta !== 'TODO') {
        platosAMostrar = db.platos.filter(function(p) {
            return (p.tipoCarta || 'CARTA') === filtroTipoCarta;
        });
    }
    
    // Obtener todas las categor√≠as √∫nicas de los platos filtrados
    var categorias = [];
    platosAMostrar.forEach(function(plato) {
        var cat = plato.categoria || 'SIN CATEGOR√çA';
        if (categorias.indexOf(cat) === -1) {
            categorias.push(cat);
        }
    });
    
    // Ordenar alfab√©ticamente
    categorias.sort();
    
    var html = '';
    
    // Tab "TODAS" siempre primero
    var emoji = emojisCategoria['TODAS'] || 'üìã';
    html += '<button onclick="filtrarCategoriaPOS(\'TODAS\')" data-categoria="TODAS" class="tab-categoria-pos tab-activa px-3 py-2 rounded-lg font-bold text-xs transition-all">';
    html += emoji + ' TODAS';
    html += '</button>';
    
    // Resto de categor√≠as
    categorias.forEach(function(cat) {
        var emoji = emojisCategoria[cat] || 'üçΩÔ∏è';
        // Acortar nombre si es muy largo
        var nombre = cat.length > 12 ? cat.substring(0, 10) + '...' : cat;
        
        html += '<button onclick="filtrarCategoriaPOS(\'' + cat + '\')" data-categoria="' + cat + '" class="tab-categoria-pos px-3 py-2 rounded-lg font-bold text-xs transition-all">';
        html += emoji + ' ' + nombre;
        html += '</button>';
    });
    
    document.getElementById('tabs-categorias-pos').innerHTML = html;
}

// Refrescar tabs con feedback visual
function refrescarTabsCategorias() {
    console.log('üîÑ Refrescando tabs de categor√≠as...');
    
    // Guardar categor√≠a actual para mantenerla seleccionada
    var categoriaAnterior = categoriaPOSActual;
    
    // Regenerar tabs
    generarTabsCategorias();
    
    // Restaurar categor√≠a seleccionada si a√∫n existe
    filtrarCategoriaPOS(categoriaAnterior);
    
    // Feedback visual (opcional)
    var btn = event?.target;
    if (btn) {
        var textoOriginal = btn.innerHTML;
        btn.innerHTML = '‚úÖ Actualizado';
        btn.classList.add('bg-green-600', 'text-white');
        btn.classList.remove('bg-green-100', 'text-green-700');
        
        setTimeout(function() {
            btn.innerHTML = textoOriginal;
            btn.classList.remove('bg-green-600', 'text-white');
            btn.classList.add('bg-green-100', 'text-green-700');
        }, 1500);
    }
    
    console.log('‚úÖ Tabs refrescados');
}

// ========== SISTEMA DE PRODUCCI√ìN DIARIA ==========

function inicializarProduccionDiaria() {
    var fechaHoy = obtenerFechaHoy();
    document.getElementById('fecha-produccion-actual').textContent = fechaHoy;
    renderTablaProduccionPorCategoria();
    actualizarResumenProduccion();
}

function obtenerFechaHoy() {
    var hoy = new Date();
    var dia = String(hoy.getDate()).padStart(2, '0');
    var mes = String(hoy.getMonth() + 1).padStart(2, '0');
    var ano = hoy.getFullYear();
    return ano + '-' + mes + '-' + dia;
}

function renderTablaProduccionPorCategoria() {
    var fechaHoy = obtenerFechaHoy();
    var busqueda = (document.getElementById('buscar-plato-produccion')?.value || '').toUpperCase();
    
    // Categor√≠as de bebidas que NO deben aparecer en producci√≥n
    var categoriasBebidas = [
        'BEBIDAS FR√çAS',
        'BEBIDAS CALIENTES',
        'BEBIDAS',
        'LICORES',
        'VINOS',
        'CERVEZAS',
        'TRAGOS',
        'C√ìCTELES',
        'JUGOS'
    ];
    
    // Obtener solo platos de comida (excluir bebidas y productos terminados)
    var platosPreparados = db.platos.filter(function(p) {
        // Debe ser PREPARADO (no producto terminado)
        var esPreparado = (p.tipo === 'PREPARADO' || !p.tipo);
        
        // No debe ser bebida
        var categoria = (p.categoria || '').toUpperCase();
        var noBebida = categoriasBebidas.indexOf(categoria) === -1;
        
        // Debe coincidir con b√∫squeda
        var coincideBusqueda = p.nombre.toUpperCase().includes(busqueda);
        
        return esPreparado && noBebida && coincideBusqueda;
    });
    
    // Agrupar por categor√≠a
    var platosPorCategoria = {};
    platosPreparados.forEach(function(plato) {
        var cat = plato.categoria || 'SIN CATEGOR√çA';
        if (!platosPorCategoria[cat]) {
            platosPorCategoria[cat] = [];
        }
        platosPorCategoria[cat].push(plato);
    });
    
    var html = '';
    var categorias = Object.keys(platosPorCategoria).sort();
    
    if (categorias.length === 0) {
        html = '<div class="text-center py-12 text-slate-400">';
        html += '<p class="text-4xl mb-4">üçΩÔ∏è</p>';
        html += '<p class="font-bold">No hay platos de comida registrados</p>';
        html += '<p class="text-sm mt-2">Solo se muestran PLATOS DE COMIDA (fondos, entradas, sopas, etc.)</p>';
        html += '<p class="text-sm">Las BEBIDAS se controlan desde el INVENTARIO</p>';
        html += '<p class="text-sm mt-4 text-blue-600">Ve a PLATOS MEN√ö y crea algunos platos de comida</p>';
        html += '</div>';
    } else {
        categorias.forEach(function(categoria) {
            var platos = platosPorCategoria[categoria];
            
            html += '<div class="mb-6">';
            html += '<div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-3 rounded-t-xl font-black flex items-center justify-between">';
            html += '<span>üìÇ ' + categoria + '</span>';
            html += '<span class="text-sm font-normal">' + platos.length + ' platos</span>';
            html += '</div>';
            
            html += '<div class="bg-white rounded-b-xl overflow-hidden border-2 border-slate-200">';
            html += '<table class="w-full text-sm">';
            html += '<thead class="bg-slate-100 border-b-2 border-slate-200">';
            html += '<tr>';
            html += '<th class="text-left p-3 font-bold">PLATO</th>';
            html += '<th class="text-center p-3 font-bold w-32">PRECIO</th>';
            html += '<th class="text-center p-3 font-bold w-40">CANTIDAD HOY</th>';
            html += '<th class="text-center p-3 font-bold w-32">VENDIDOS</th>';
            html += '<th class="text-center p-3 font-bold w-32">DISPONIBLES</th>';
            html += '<th class="text-center p-3 font-bold w-20">ESTADO</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody>';
            
            platos.forEach(function(plato) {
                var produccion = db.produccionDiaria[plato.sku];
                var cantidadActual = (produccion && produccion.fecha === fechaHoy) ? produccion.cantidad : 0;
                var vendidos = (produccion && produccion.fecha === fechaHoy) ? produccion.vendidos : 0;
                var disponibles = cantidadActual - vendidos;
                var estado = disponibles === 0 ? 'üî¥' : disponibles <= 5 ? 'üü°' : 'üü¢';
                
                html += '<tr class="border-b border-slate-100 hover:bg-blue-50 transition-colors">';
                html += '<td class="p-3 font-semibold">' + plato.nombre + '</td>';
                html += '<td class="text-center p-3 text-green-600 font-bold">S/. ' + plato.precioMenu.toFixed(2) + '</td>';
                html += '<td class="p-3">';
                html += '<input type="number" ';
                html += 'id="prod-' + plato.sku + '" ';
                html += 'value="' + (cantidadActual > 0 ? cantidadActual : '') + '" ';
                html += 'min="0" ';
                html += 'class="w-full p-2 border-2 border-slate-300 rounded-lg text-center font-bold text-lg focus:border-blue-500 focus:outline-none" ';
                html += 'placeholder="">';
                html += '</td>';
                html += '<td class="text-center p-3 font-bold text-orange-600">' + (vendidos > 0 ? vendidos : '-') + '</td>';
                html += '<td class="text-center p-3 font-bold text-purple-600">' + (disponibles > 0 ? disponibles : '-') + '</td>';
                html += '<td class="text-center p-3 text-2xl">' + estado + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            html += '</div>';
        });
    }
    
    document.getElementById('tabla-produccion-categorias').innerHTML = html;
}

function guardarTodasProduccionesDiarias() {
    var fechaHoy = obtenerFechaHoy();
    var platosActualizados = 0;
    var cantidadTotal = 0;
    
    // Categor√≠as de bebidas a excluir
    var categoriasBebidas = [
        'BEBIDAS FR√çAS',
        'BEBIDAS CALIENTES',
        'BEBIDAS',
        'LICORES',
        'VINOS',
        'CERVEZAS',
        'TRAGOS',
        'C√ìCTELES',
        'JUGOS'
    ];
    
    // Obtener solo platos de comida (no bebidas ni productos terminados)
    var platosPreparados = db.platos.filter(function(p) {
        var esPreparado = (p.tipo === 'PREPARADO' || !p.tipo);
        var categoria = (p.categoria || '').toUpperCase();
        var noBebida = categoriasBebidas.indexOf(categoria) === -1;
        return esPreparado && noBebida;
    });
    
    platosPreparados.forEach(function(plato) {
        var input = document.getElementById('prod-' + plato.sku);
        if (input) {
            var cantidad = parseInt(input.value) || 0;
            
            if (cantidad > 0) {
                // Mantener vendidos si ya exist√≠a producci√≥n del mismo d√≠a
                var vendidosActuales = 0;
                if (db.produccionDiaria[plato.sku] && db.produccionDiaria[plato.sku].fecha === fechaHoy) {
                    vendidosActuales = db.produccionDiaria[plato.sku].vendidos || 0;
                }
                
                db.produccionDiaria[plato.sku] = {
                    sku: plato.sku,
                    fecha: fechaHoy,
                    cantidad: cantidad,
                    vendidos: vendidosActuales,
                    nombre: plato.nombre
                };
                
                platosActualizados++;
                cantidadTotal += cantidad;
            } else {
                // Si cantidad es 0, eliminar registro
                if (db.produccionDiaria[plato.sku]) {
                    delete db.produccionDiaria[plato.sku];
                }
            }
        }
    });
    
    save();
    renderTablaProduccionPorCategoria();
    actualizarResumenProduccion();
    
    registrarActividad('produccion', 'Guard√≥ producci√≥n diaria', platosActualizados + ' platos, ' + cantidadTotal + ' unidades totales');
    
    alert('‚úÖ PRODUCCI√ìN GUARDADA\n\n' + 
          'Platos registrados: ' + platosActualizados + '\n' +
          'Cantidad total: ' + cantidadTotal + '\n\n' +
          'Los mozos ahora ver√°n la disponibilidad en el POS.');
}

function copiarProduccionDiaAnterior() {
    if (!confirm('üìã COPIAR PRODUCCI√ìN DEL D√çA ANTERIOR\n\n¬øDeseas copiar las cantidades del d√≠a anterior?\n\nEsto sobrescribir√° las cantidades actuales.')) {
        return;
    }
    
    var fechaHoy = obtenerFechaHoy();
    var fechaAyer = obtenerFechaAyer();
    
    console.log('üìã Copiando producci√≥n de', fechaAyer, 'a', fechaHoy);
    
    // Buscar producciones del d√≠a anterior en el historial
    var produccionesAyer = {};
    
    // Primero buscar en produccionDiaria actual
    Object.keys(db.produccionDiaria).forEach(function(sku) {
        var prod = db.produccionDiaria[sku];
        if (prod.fecha === fechaAyer) {
            produccionesAyer[sku] = prod.cantidad;
        }
    });
    
    // Si no hay en produccionDiaria, buscar en historial
    if (Object.keys(produccionesAyer).length === 0 && db.historialProduccionDiaria) {
        db.historialProduccionDiaria.forEach(function(registro) {
            if (registro.fecha === fechaAyer && registro.tipo !== 'cierre_dia') {
                produccionesAyer[registro.sku] = registro.cantidad;
            }
        });
    }
    
    if (Object.keys(produccionesAyer).length === 0) {
        alert('‚ö†Ô∏è NO HAY PRODUCCI√ìN DEL D√çA ANTERIOR\n\nNo se encontr√≥ producci√≥n registrada para ayer.\n\nRegistra manualmente las cantidades.');
        return;
    }
    
    // Copiar cantidades a los inputs
    var copiados = 0;
    Object.keys(produccionesAyer).forEach(function(sku) {
        var input = document.getElementById('prod-' + sku);
        if (input) {
            input.value = produccionesAyer[sku];
            copiados++;
        }
    });
    
    alert('‚úÖ PRODUCCI√ìN COPIADA\n\n' + 
          copiados + ' platos copiados del d√≠a anterior.\n\n' +
          'Revisa las cantidades y haz click en "GUARDAR TODA LA PRODUCCI√ìN".');
    
    console.log('‚úÖ Copiados', copiados, 'platos');
}

function obtenerFechaAyer() {
    var ayer = new Date();
    ayer.setDate(ayer.getDate() - 1);
    var dia = String(ayer.getDate()).padStart(2, '0');
    var mes = String(ayer.getMonth() + 1).padStart(2, '0');
    var ano = ayer.getFullYear();
    return ano + '-' + mes + '-' + dia;
}

function limpiarTodasCantidades() {
    if (!confirm('üßπ LIMPIAR TODAS LAS CANTIDADES\n\n¬øEst√°s seguro?\n\nEsto pondr√° todas las cantidades en 0 (no se guardar√° hasta que hagas click en GUARDAR).')) {
        return;
    }
    
    var platosPreparados = db.platos.filter(function(p) {
        return p.tipo === 'PREPARADO' || !p.tipo;
    });
    
    platosPreparados.forEach(function(plato) {
        var input = document.getElementById('prod-' + plato.sku);
        if (input) {
            input.value = 0;
        }
    });
    
    alert('‚úÖ CANTIDADES LIMPIADAS\n\nTodas las cantidades est√°n en 0.\n\nRecuerda hacer click en "GUARDAR" si deseas aplicar los cambios.');
}

function actualizarResumenProduccion() {
    var fechaHoy = obtenerFechaHoy();
    var totalPlatos = 0;
    var cantidadTotal = 0;
    var vendidosTotal = 0;
    var disponiblesTotal = 0;
    
    Object.keys(db.produccionDiaria).forEach(function(sku) {
        var prod = db.produccionDiaria[sku];
        if (prod.fecha === fechaHoy) {
            totalPlatos++;
            cantidadTotal += prod.cantidad;
            vendidosTotal += prod.vendidos || 0;
            disponiblesTotal += (prod.cantidad - (prod.vendidos || 0));
        }
    });
    
    document.getElementById('total-platos-produccion').textContent = totalPlatos;
    document.getElementById('cantidad-total-produccion').textContent = cantidadTotal;
    document.getElementById('vendidos-total-produccion').textContent = vendidosTotal;
    document.getElementById('disponibles-total-produccion').textContent = disponiblesTotal;
}

function resetearProduccionDiaria() {
    if (!confirm('‚ö†Ô∏è RESETEAR PRODUCCI√ìN DEL D√çA\n\n¬øEst√°s seguro? Esto archivar√° la producci√≥n actual e iniciar√° un nuevo d√≠a.\n\nEsta acci√≥n NO se puede deshacer.')) {
        return;
    }
    
    var fechaHoy = obtenerFechaHoy();
    
    // Archivar producci√≥n actual en historial
    Object.values(db.produccionDiaria).forEach(function(prod) {
        if (prod.fecha === fechaHoy) {
            db.historialProduccionDiaria.push({
                sku: prod.sku,
                fecha: prod.fecha,
                cantidad: prod.cantidad,
                vendidos: prod.vendidos,
                disponibles: prod.cantidad - prod.vendidos,
                nombre: prod.nombre,
                timestamp: new Date().toISOString(),
                tipo: 'cierre_dia'
            });
        }
    });
    
    // Limpiar producci√≥n diaria
    db.produccionDiaria = {};
    save();
    renderTablaProduccionPorCategoria();
    actualizarResumenProduccion();
    
    registrarActividad('produccion', 'Reseteo producci√≥n diaria', 'Nuevo d√≠a iniciado');
    
    alert('‚úÖ PRODUCCI√ìN RESETEADA\n\nPuedes registrar la producci√≥n para el nuevo d√≠a.');
}

// ========== DASHBOARD - REPORTES Y M√âTRICAS ==========

function actualizarDashboard() {
    var periodo = document.getElementById('dashboard-periodo').value;
    
    // Obtener fechas seg√∫n el per√≠odo
    var fechas = obtenerRangoDeFechas(periodo);
    
    // Calcular m√©tricas principales
    calcularMetricasPrincipales(fechas);
    
    // Renderizar gr√°ficos
    renderGraficoVentasPorDia(fechas);
    renderGraficoVentasPorHora(fechas);
    
    // Renderizar top platos
    renderTopPlatosVendidos(fechas);
    
    // Renderizar ventas por categor√≠a
    renderVentasPorCategoria(fechas);
    
    // An√°lisis de rentabilidad
    renderAnalisisRentabilidad(fechas);
    
    // Alertas y recomendaciones
    renderAlertasDashboard(fechas);
    
    // Actualizar timestamp
    var ahora = new Date();
    var horaStr = ahora.getHours().toString().padStart(2, '0') + ':' + 
                  ahora.getMinutes().toString().padStart(2, '0');
    document.getElementById('dashboard-ultima-actualizacion').textContent = horaStr;
    
    console.log('‚úÖ Dashboard actualizado:', periodo);
}

function obtenerRangoDeFechas(periodo) {
    var hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    
    var fechaInicio, fechaFin;
    
    switch(periodo) {
        case 'hoy':
            fechaInicio = new Date(hoy);
            fechaFin = new Date(hoy);
            fechaFin.setHours(23, 59, 59, 999);
            break;
            
        case 'ayer':
            fechaInicio = new Date(hoy);
            fechaInicio.setDate(fechaInicio.getDate() - 1);
            fechaFin = new Date(fechaInicio);
            fechaFin.setHours(23, 59, 59, 999);
            break;
            
        case 'semana':
            fechaInicio = new Date(hoy);
            fechaInicio.setDate(fechaInicio.getDate() - hoy.getDay()); // Domingo
            fechaFin = new Date(fechaInicio);
            fechaFin.setDate(fechaFin.getDate() + 6); // S√°bado
            fechaFin.setHours(23, 59, 59, 999);
            break;
            
        case 'mes':
            fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            fechaFin = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            fechaFin.setHours(23, 59, 59, 999);
            break;
            
        case 'mes-anterior':
            fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
            fechaFin = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
            fechaFin.setHours(23, 59, 59, 999);
            break;
            
        default:
            fechaInicio = new Date(hoy);
            fechaFin = new Date(hoy);
            fechaFin.setHours(23, 59, 59, 999);
    }
    
    return {
        inicio: fechaInicio,
        fin: fechaFin,
        periodo: periodo
    };
}

function calcularMetricasPrincipales(fechas) {
    var ventas = db.ventas || db.historialVentas || [];
    
    // Filtrar ventas del per√≠odo
    var ventasPeriodo = ventas.filter(function(v) {
        if (!v.fecha) return false;
        var fechaVenta = new Date(v.fecha);
        return fechaVenta >= fechas.inicio && fechaVenta <= fechas.fin;
    });
    
    // Calcular totales
    var totalVentas = ventasPeriodo.reduce(function(sum, v) { return sum + (v.total || 0); }, 0);
    var totalPedidos = ventasPeriodo.length;
    var ticketPromedio = totalPedidos > 0 ? totalVentas / totalPedidos : 0;
    
    // Calcular utilidad (asumiendo margen promedio del 50%)
    var totalCostos = ventasPeriodo.reduce(function(sum, v) {
        var costoVenta = 0;
        if (v.items) {
            v.items.forEach(function(item) {
                var plato = db.platos.find(function(p) { return p.sku === item.sku; });
                if (plato) {
                    costoVenta += (plato.costoReceta || 0) * item.cantidad;
                }
            });
        }
        return sum + costoVenta;
    }, 0);
    
    var utilidadBruta = totalVentas - totalCostos;
    var margenUtilidad = totalVentas > 0 ? (utilidadBruta / totalVentas) * 100 : 0;
    
    // Comparar con per√≠odo anterior
    var ventasAnteriores = calcularVentasPeriodoAnterior(fechas);
    var variacionVentas = ventasAnteriores.total > 0 
        ? ((totalVentas - ventasAnteriores.total) / ventasAnteriores.total) * 100 
        : 0;
    var variacionPedidos = ventasAnteriores.pedidos > 0 
        ? ((totalPedidos - ventasAnteriores.pedidos) / ventasAnteriores.pedidos) * 100 
        : 0;
    var variacionTicket = ventasAnteriores.ticket > 0 
        ? ((ticketPromedio - ventasAnteriores.ticket) / ventasAnteriores.ticket) * 100 
        : 0;
    
    // Actualizar DOM
    document.getElementById('ventas-total').textContent = 'S/. ' + totalVentas.toFixed(2);
    document.getElementById('ventas-variacion').textContent = 
        (variacionVentas >= 0 ? '‚ñ≤ ' : '‚ñº ') + Math.abs(variacionVentas).toFixed(1) + '%';
    document.getElementById('ventas-variacion').className = 
        'text-xs font-bold bg-white/20 px-2 py-1 rounded ' + 
        (variacionVentas >= 0 ? 'text-green-100' : 'text-red-100');
    
    document.getElementById('pedidos-total').textContent = totalPedidos;
    document.getElementById('pedidos-variacion').textContent = 
        (variacionPedidos >= 0 ? '‚ñ≤ ' : '‚ñº ') + Math.abs(variacionPedidos).toFixed(1) + '%';
    document.getElementById('pedidos-variacion').className = 
        'text-xs font-bold bg-white/20 px-2 py-1 rounded ' + 
        (variacionPedidos >= 0 ? 'text-green-100' : 'text-red-100');
    
    document.getElementById('ticket-promedio').textContent = 'S/. ' + ticketPromedio.toFixed(2);
    document.getElementById('ticket-variacion').textContent = 
        (variacionTicket >= 0 ? '‚ñ≤ ' : '‚ñº ') + Math.abs(variacionTicket).toFixed(1) + '%';
    document.getElementById('ticket-variacion').className = 
        'text-xs font-bold bg-white/20 px-2 py-1 rounded ' + 
        (variacionTicket >= 0 ? 'text-green-100' : 'text-red-100');
    
    document.getElementById('utilidad-total').textContent = 'S/. ' + utilidadBruta.toFixed(2);
    document.getElementById('utilidad-porcentaje').textContent = margenUtilidad.toFixed(1) + '% margen';
}

function calcularVentasPeriodoAnterior(fechas) {
    var ventas = db.ventas || db.historialVentas || [];
    
    // Calcular duraci√≥n del per√≠odo actual
    var duracion = fechas.fin - fechas.inicio;
    
    // Calcular fechas del per√≠odo anterior
    var finAnterior = new Date(fechas.inicio);
    finAnterior.setMilliseconds(-1);
    var inicioAnterior = new Date(finAnterior.getTime() - duracion);
    
    // Filtrar ventas del per√≠odo anterior
    var ventasAnteriores = ventas.filter(function(v) {
        if (!v.fecha) return false;
        var fechaVenta = new Date(v.fecha);
        return fechaVenta >= inicioAnterior && fechaVenta <= finAnterior;
    });
    
    var total = ventasAnteriores.reduce(function(sum, v) { return sum + (v.total || 0); }, 0);
    var pedidos = ventasAnteriores.length;
    var ticket = pedidos > 0 ? total / pedidos : 0;
    
    return {total: total, pedidos: pedidos, ticket: ticket};
}

function renderGraficoVentasPorDia(fechas) {
    var ventas = db.ventas || db.historialVentas || [];
    
    // Agrupar ventas por d√≠a
    var ventasPorDia = {};
    ventas.filter(function(v) {
        if (!v.fecha) return false;
        var fechaVenta = new Date(v.fecha);
        return fechaVenta >= fechas.inicio && fechaVenta <= fechas.fin;
    }).forEach(function(v) {
        var fecha = new Date(v.fecha);
        var dia = fecha.toLocaleDateString('es-ES', {weekday: 'short', day: '2-digit', month: '2-digit'});
        ventasPorDia[dia] = (ventasPorDia[dia] || 0) + (v.total || 0);
    });
    
    // Crear gr√°fico simple ASCII
    var dias = Object.keys(ventasPorDia).sort();
    var maxVenta = Math.max(...Object.values(ventasPorDia), 1);
    
    var html = '<div class="space-y-2">';
    dias.forEach(function(dia) {
        var venta = ventasPorDia[dia];
        var porcentaje = (venta / maxVenta) * 100;
        html += '<div>';
        html += '<div class="flex justify-between text-xs mb-1">';
        html += '<span class="font-bold">' + dia + '</span>';
        html += '<span class="text-green-600 font-bold">S/. ' + venta.toFixed(2) + '</span>';
        html += '</div>';
        html += '<div class="w-full bg-slate-200 rounded-full h-6 overflow-hidden">';
        html += '<div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-end px-2 text-white text-xs font-bold" style="width: ' + porcentaje + '%">';
        if (porcentaje > 15) html += porcentaje.toFixed(0) + '%';
        html += '</div>';
        html += '</div>';
        html += '</div>';
    });
    html += '</div>';
    
    if (dias.length === 0) {
        html = '<p class="text-center text-slate-400 py-8">Sin ventas en este per√≠odo</p>';
    }
    
    document.getElementById('grafico-ventas-dias').innerHTML = html;
}

function renderGraficoVentasPorHora(fechas) {
    var ventas = db.ventas || db.historialVentas || [];
    
    // Agrupar ventas por hora
    var ventasPorHora = {};
    for (var h = 0; h < 24; h++) {
        ventasPorHora[h] = 0;
    }
    
    ventas.filter(function(v) {
        if (!v.fecha) return false;
        var fechaVenta = new Date(v.fecha);
        return fechaVenta >= fechas.inicio && fechaVenta <= fechas.fin;
    }).forEach(function(v) {
        var fecha = new Date(v.fecha);
        var hora = fecha.getHours();
        ventasPorHora[hora] += (v.total || 0);
    });
    
    // Filtrar solo horas con ventas
    var horasConVentas = Object.keys(ventasPorHora).filter(function(h) {
        return ventasPorHora[h] > 0;
    });
    
    var maxVenta = Math.max(...Object.values(ventasPorHora), 1);
    
    var html = '<div class="space-y-2">';
    horasConVentas.forEach(function(hora) {
        var venta = ventasPorHora[hora];
        var porcentaje = (venta / maxVenta) * 100;
        var horaStr = hora.toString().padStart(2, '0') + ':00';
        html += '<div>';
        html += '<div class="flex justify-between text-xs mb-1">';
        html += '<span class="font-bold">' + horaStr + '</span>';
        html += '<span class="text-green-600 font-bold">S/. ' + venta.toFixed(2) + '</span>';
        html += '</div>';
        html += '<div class="w-full bg-slate-200 rounded-full h-6 overflow-hidden">';
        html += '<div class="h-full bg-gradient-to-r from-orange-500 to-amber-500 flex items-center justify-end px-2 text-white text-xs font-bold" style="width: ' + porcentaje + '%">';
        if (porcentaje > 15) html += porcentaje.toFixed(0) + '%';
        html += '</div>';
        html += '</div>';
        html += '</div>';
    });
    html += '</div>';
    
    if (horasConVentas.length === 0) {
        html = '<p class="text-center text-slate-400 py-8">Sin ventas en este per√≠odo</p>';
    }
    
    document.getElementById('grafico-ventas-horas').innerHTML = html;
}

function renderTopPlatosVendidos(fechas) {
    var ventas = db.ventas || db.historialVentas || [];
    
    // Agrupar items vendidos
    var platosVendidos = {};
    ventas.filter(function(v) {
        if (!v.fecha) return false;
        var fechaVenta = new Date(v.fecha);
        return fechaVenta >= fechas.inicio && fechaVenta <= fechas.fin;
    }).forEach(function(v) {
        if (v.items) {
            v.items.forEach(function(item) {
                var sku = item.sku;
                if (!platosVendidos[sku]) {
                    platosVendidos[sku] = {
                        nombre: item.nombre,
                        cantidad: 0,
                        ventas: 0
                    };
                }
                platosVendidos[sku].cantidad += item.cantidad;
                platosVendidos[sku].ventas += item.subtotal || (item.precio * item.cantidad);
            });
        }
    });
    
    // Convertir a array y ordenar
    var platosArray = Object.keys(platosVendidos).map(function(sku) {
        return {
            sku: sku,
            nombre: platosVendidos[sku].nombre,
            cantidad: platosVendidos[sku].cantidad,
            ventas: platosVendidos[sku].ventas
        };
    }).sort(function(a, b) {
        return b.cantidad - a.cantidad;
    }).slice(0, 10);
    
    var html = '<div class="space-y-2">';
    platosArray.forEach(function(plato, index) {
        var emoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : (index + 1) + 'Ô∏è‚É£';
        html += '<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">';
        html += '<div class="flex items-center gap-3 flex-1">';
        html += '<span class="text-2xl">' + emoji + '</span>';
        html += '<div>';
        html += '<p class="font-bold text-sm">' + plato.nombre + '</p>';
        html += '<p class="text-xs text-slate-600">' + plato.cantidad + ' vendidos</p>';
        html += '</div>';
        html += '</div>';
        html += '<div class="text-right">';
        html += '<p class="font-bold text-green-600">S/. ' + plato.ventas.toFixed(2) + '</p>';
        html += '</div>';
        html += '</div>';
    });
    html += '</div>';
    
    if (platosArray.length === 0) {
        html = '<p class="text-center text-slate-400 py-8">Sin ventas en este per√≠odo</p>';
    }
    
    document.getElementById('top-platos-vendidos').innerHTML = html;
}

function renderVentasPorCategoria(fechas) {
    var ventas = db.ventas || db.historialVentas || [];
    
    // Agrupar ventas por categor√≠a
    var ventasPorCategoria = {};
    ventas.filter(function(v) {
        if (!v.fecha) return false;
        var fechaVenta = new Date(v.fecha);
        return fechaVenta >= fechas.inicio && fechaVenta <= fechas.fin;
    }).forEach(function(v) {
        if (v.items) {
            v.items.forEach(function(item) {
                var plato = db.platos.find(function(p) { return p.sku === item.sku; });
                var categoria = plato ? (plato.categoria || 'SIN CATEGOR√çA') : 'SIN CATEGOR√çA';
                
                if (!ventasPorCategoria[categoria]) {
                    ventasPorCategoria[categoria] = 0;
                }
                ventasPorCategoria[categoria] += item.subtotal || (item.precio * item.cantidad);
            });
        }
    });
    
    // Convertir a array y ordenar
    var categoriasArray = Object.keys(ventasPorCategoria).map(function(cat) {
        return {categoria: cat, ventas: ventasPorCategoria[cat]};
    }).sort(function(a, b) {
        return b.ventas - a.ventas;
    });
    
    var totalVentas = categoriasArray.reduce(function(sum, c) { return sum + c.ventas; }, 0);
    
    var html = '<div class="space-y-2">';
    categoriasArray.forEach(function(cat) {
        var porcentaje = totalVentas > 0 ? (cat.ventas / totalVentas) * 100 : 0;
        html += '<div>';
        html += '<div class="flex justify-between text-xs mb-1">';
        html += '<span class="font-bold">' + cat.categoria + '</span>';
        html += '<span class="text-green-600 font-bold">S/. ' + cat.ventas.toFixed(2) + ' (' + porcentaje.toFixed(1) + '%)</span>';
        html += '</div>';
        html += '<div class="w-full bg-slate-200 rounded-full h-6 overflow-hidden">';
        html += '<div class="h-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-end px-2 text-white text-xs font-bold" style="width: ' + porcentaje + '%">';
        if (porcentaje > 15) html += porcentaje.toFixed(0) + '%';
        html += '</div>';
        html += '</div>';
        html += '</div>';
    });
    html += '</div>';
    
    if (categoriasArray.length === 0) {
        html = '<p class="text-center text-slate-400 py-8">Sin ventas en este per√≠odo</p>';
    }
    
    document.getElementById('ventas-por-categoria').innerHTML = html;
}

function renderAnalisisRentabilidad(fechas) {
    var ventas = db.ventas || db.historialVentas || [];
    
    // Agrupar items vendidos con margen
    var platosConMargen = {};
    ventas.filter(function(v) {
        if (!v.fecha) return false;
        var fechaVenta = new Date(v.fecha);
        return fechaVenta >= fechas.inicio && fechaVenta <= fechas.fin;
    }).forEach(function(v) {
        if (v.items) {
            v.items.forEach(function(item) {
                var plato = db.platos.find(function(p) { return p.sku === item.sku; });
                if (plato) {
                    var precio = item.precio || plato.precioMenu;
                    var costo = plato.costoReceta || 0;
                    var margen = precio > 0 ? ((precio - costo) / precio) * 100 : 0;
                    
                    if (!platosConMargen[item.sku]) {
                        platosConMargen[item.sku] = {
                            nombre: item.nombre,
                            margen: margen,
                            cantidad: 0
                        };
                    }
                    platosConMargen[item.sku].cantidad += item.cantidad;
                }
            });
        }
    });
    
    // Clasificar por rentabilidad
    var masRentables = [];
    var rentabilidadMedia = [];
    var bajaRentabilidad = [];
    
    Object.keys(platosConMargen).forEach(function(sku) {
        var plato = platosConMargen[sku];
        if (plato.margen > 50) {
            masRentables.push(plato);
        } else if (plato.margen >= 30) {
            rentabilidadMedia.push(plato);
        } else {
            bajaRentabilidad.push(plato);
        }
    });
    
    // Ordenar por cantidad vendida
    masRentables.sort(function(a, b) { return b.cantidad - a.cantidad; });
    rentabilidadMedia.sort(function(a, b) { return b.cantidad - a.cantidad; });
    bajaRentabilidad.sort(function(a, b) { return b.cantidad - a.cantidad; });
    
    // Renderizar cada categor√≠a
    var htmlMasRentables = '';
    masRentables.slice(0, 5).forEach(function(p) {
        htmlMasRentables += '<div class="p-2 bg-green-50 rounded text-xs">';
        htmlMasRentables += '<p class="font-bold">' + p.nombre + '</p>';
        htmlMasRentables += '<p class="text-green-700">' + p.margen.toFixed(1) + '% margen ‚Ä¢ ' + p.cantidad + ' vendidos</p>';
        htmlMasRentables += '</div>';
    });
    if (masRentables.length === 0) {
        htmlMasRentables = '<p class="text-xs text-slate-400 text-center py-4">Sin datos</p>';
    }
    
    var htmlRentabilidadMedia = '';
    rentabilidadMedia.slice(0, 5).forEach(function(p) {
        htmlRentabilidadMedia += '<div class="p-2 bg-orange-50 rounded text-xs">';
        htmlRentabilidadMedia += '<p class="font-bold">' + p.nombre + '</p>';
        htmlRentabilidadMedia += '<p class="text-orange-700">' + p.margen.toFixed(1) + '% margen ‚Ä¢ ' + p.cantidad + ' vendidos</p>';
        htmlRentabilidadMedia += '</div>';
    });
    if (rentabilidadMedia.length === 0) {
        htmlRentabilidadMedia = '<p class="text-xs text-slate-400 text-center py-4">Sin datos</p>';
    }
    
    var htmlBajaRentabilidad = '';
    bajaRentabilidad.slice(0, 5).forEach(function(p) {
        htmlBajaRentabilidad += '<div class="p-2 bg-red-50 rounded text-xs">';
        htmlBajaRentabilidad += '<p class="font-bold">' + p.nombre + '</p>';
        htmlBajaRentabilidad += '<p class="text-red-700">' + p.margen.toFixed(1) + '% margen ‚Ä¢ ' + p.cantidad + ' vendidos</p>';
        htmlBajaRentabilidad += '</div>';
    });
    if (bajaRentabilidad.length === 0) {
        htmlBajaRentabilidad = '<p class="text-xs text-slate-400 text-center py-4">Sin datos</p>';
    }
    
    document.getElementById('platos-mas-rentables').innerHTML = htmlMasRentables;
    document.getElementById('platos-rentabilidad-media').innerHTML = htmlRentabilidadMedia;
    document.getElementById('platos-baja-rentabilidad').innerHTML = htmlBajaRentabilidad;
}

function renderAlertasDashboard(fechas) {
    var alertas = [];
    
    // Alerta: Stock bajo
    var materialesBajoStock = 0;
    Object.keys(db.inventario).forEach(function(sku) {
        var material = db.materiales.find(function(m) { return m.sku === sku; });
        var stock = db.inventario[sku];
        var minimo = material ? material.stockMinimo : 0;
        if (stock <= minimo) {
            materialesBajoStock++;
        }
    });
    if (materialesBajoStock > 0) {
        alertas.push({
            tipo: 'warning',
            mensaje: materialesBajoStock + ' materiales con stock bajo o cr√≠tico',
            accion: 'Ver Inventario'
        });
    }
    
    // Alerta: Platos sin vender
    var platosSinVentas = db.platos.filter(function(p) {
        var ventas = (db.ventas || db.historialVentas || []).filter(function(v) {
            if (!v.fecha) return false;
            var fechaVenta = new Date(v.fecha);
            return fechaVenta >= fechas.inicio && fechaVenta <= fechas.fin;
        });
        
        var vendido = ventas.some(function(v) {
            return v.items && v.items.some(function(i) { return i.sku === p.sku; });
        });
        
        return !vendido;
    }).length;
    
    if (platosSinVentas > 3) {
        alertas.push({
            tipo: 'info',
            mensaje: platosSinVentas + ' platos sin ventas en este per√≠odo',
            accion: 'Revisar men√∫'
        });
    }
    
    // Alerta: Baja rentabilidad general
    var ventas = db.ventas || db.historialVentas || [];
    var ventasPeriodo = ventas.filter(function(v) {
        if (!v.fecha) return false;
        var fechaVenta = new Date(v.fecha);
        return fechaVenta >= fechas.inicio && fechaVenta <= fechas.fin;
    });
    
    var totalVentas = ventasPeriodo.reduce(function(sum, v) { return sum + (v.total || 0); }, 0);
    var totalCostos = ventasPeriodo.reduce(function(sum, v) {
        var costoVenta = 0;
        if (v.items) {
            v.items.forEach(function(item) {
                var plato = db.platos.find(function(p) { return p.sku === item.sku; });
                if (plato) {
                    costoVenta += (plato.costoReceta || 0) * item.cantidad;
                }
            });
        }
        return sum + costoVenta;
    }, 0);
    
    var margenGeneral = totalVentas > 0 ? ((totalVentas - totalCostos) / totalVentas) * 100 : 0;
    if (margenGeneral < 40 && totalVentas > 0) {
        alertas.push({
            tipo: 'danger',
            mensaje: 'Margen de utilidad bajo: ' + margenGeneral.toFixed(1) + '% (objetivo: >45%)',
            accion: 'Revisar costos y precios'
        });
    }
    
    // Renderizar alertas
    var html = '';
    alertas.forEach(function(alerta) {
        var colorClass = alerta.tipo === 'danger' ? 'bg-red-50 border-red-200' : 
                        alerta.tipo === 'warning' ? 'bg-orange-50 border-orange-200' : 
                        'bg-blue-50 border-blue-200';
        var iconoColor = alerta.tipo === 'danger' ? 'text-red-600' : 
                        alerta.tipo === 'warning' ? 'text-orange-600' : 
                        'text-blue-600';
        
        html += '<div class="p-4 rounded-lg border-2 ' + colorClass + '">';
        html += '<div class="flex items-start gap-3">';
        html += '<span class="text-2xl ' + iconoColor + '">‚ö†Ô∏è</span>';
        html += '<div class="flex-1">';
        html += '<p class="font-bold text-sm">' + alerta.mensaje + '</p>';
        html += '<p class="text-xs text-slate-600 mt-1">üí° ' + alerta.accion + '</p>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
    });
    
    if (alertas.length === 0) {
        html = '<div class="text-center py-8 text-slate-400">';
        html += '<p class="text-4xl mb-2">‚úÖ</p>';
        html += '<p class="font-bold">Todo est√° bien</p>';
        html += '<p class="text-sm">No hay alertas en este momento</p>';
        html += '</div>';
    }
    
    document.getElementById('dashboard-alertas').innerHTML = html;
}

// Variable global para vista y categor√≠a actual
var vistaPOSActual = 'normal';
var categoriaPOSActual = 'TODAS';
var filtroTipoCarta = 'TODO'; // NUEVO: Filtro de tipo de carta (MENU, CARTA, TODO)

function filtrarPorTipoCarta(tipo) {
    filtroTipoCarta = tipo;
    
    // Actualizar estilos de botones
    var btnMenu = document.getElementById('btn-filtro-menu');
    var btnCarta = document.getElementById('btn-filtro-carta');
    var btnTodo = document.getElementById('btn-filtro-todo');
    
    var estiloActivo = 'flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-3 rounded-xl font-bold text-sm hover:shadow-lg transition-all shadow-lg scale-105';
    var estiloInactivo = 'flex-1 bg-slate-200 text-slate-600 px-4 py-3 rounded-xl font-bold text-sm hover:bg-slate-300 transition-all';
    
    if (tipo === 'MENU') {
        btnMenu.className = estiloActivo.replace('from-blue-600 to-purple-600', 'from-blue-600 to-purple-600');
        btnCarta.className = estiloInactivo;
        btnTodo.className = estiloInactivo;
    } else if (tipo === 'CARTA') {
        btnMenu.className = estiloInactivo;
        btnCarta.className = estiloActivo.replace('from-blue-600 to-purple-600', 'from-green-600 to-emerald-600');
        btnTodo.className = estiloInactivo;
    } else {
        btnMenu.className = estiloInactivo;
        btnCarta.className = estiloInactivo;
        btnTodo.className = estiloActivo.replace('from-blue-600 to-purple-600', 'from-slate-600 to-slate-800');
    }
    
    // Regenerar tabs de categor√≠as y renderizar platos
    generarTabsCategorias();
    renderMenuPOS();
    
    console.log('‚úÖ Filtro cambiado a:', tipo);
}

function cambiarVistaPOS(vista) {
    vistaPOSActual = vista;
    
    // Actualizar botones
    document.getElementById('btn-vista-normal').className = vista === 'normal' 
        ? 'px-3 py-1.5 bg-blue-600 text-white rounded-lg font-bold text-xs hover:bg-blue-700 transition-all'
        : 'px-3 py-1.5 bg-slate-200 text-slate-600 rounded-lg font-bold text-xs hover:bg-slate-300 transition-all';
    
    document.getElementById('btn-vista-compacta').className = vista === 'compacta' 
        ? 'px-3 py-1.5 bg-blue-600 text-white rounded-lg font-bold text-xs hover:bg-blue-700 transition-all'
        : 'px-3 py-1.5 bg-slate-200 text-slate-600 rounded-lg font-bold text-xs hover:bg-slate-300 transition-all';
    
    document.getElementById('btn-vista-lista').className = vista === 'lista' 
        ? 'px-3 py-1.5 bg-blue-600 text-white rounded-lg font-bold text-xs hover:bg-blue-700 transition-all'
        : 'px-3 py-1.5 bg-slate-200 text-slate-600 rounded-lg font-bold text-xs hover:bg-slate-300 transition-all';
    
    renderMenuPOS();
}

function filtrarCategoriaPOS(categoria) {
    categoriaPOSActual = categoria;
    
    // Actualizar tabs
    var tabs = document.querySelectorAll('.tab-categoria-pos');
    tabs.forEach(function(tab) {
        if (tab.getAttribute('data-categoria') === categoria) {
            tab.classList.add('tab-activa');
        } else {
            tab.classList.remove('tab-activa');
        }
    });
    
    renderMenuPOS();
}

function renderMenuPOS() {
    var busqueda = (document.getElementById('buscar-plato-pos')?.value || '').toUpperCase();
    var fechaHoy = obtenerFechaHoy();
    
    // Filtrar platos por b√∫squeda
    var platosFiltrados = db.platos.filter(p => p.nombre.toUpperCase().includes(busqueda));
    
    // Filtrar por categor√≠a
    if (categoriaPOSActual !== 'TODAS') {
        platosFiltrados = platosFiltrados.filter(function(p) {
            return (p.categoria || 'SIN CATEGOR√çA') === categoriaPOSActual;
        });
    }
    
    // ‚úÖ NUEVO: Filtrar por tipo de carta (MENU, CARTA, TODO)
    if (filtroTipoCarta === 'MENU') {
        // Para MEN√ö DEL D√çA: Solo mostrar platos programados para HOY
        const menusDeHoy = obtenerMenusDelDiaActual();
        
        if (menusDeHoy.length > 0) {
            const skusMenuHoy = menusDeHoy.map(m => m.sku);
            platosFiltrados = platosFiltrados.filter(function(p) {
                return skusMenuHoy.includes(p.sku) && (p.tipoCarta || 'CARTA') === 'MENU';
            });
        } else {
            // No hay men√∫s programados para hoy
            platosFiltrados = [];
        }
    } else if (filtroTipoCarta === 'CARTA') {
        // Para CARTA: Mostrar todos los platos de carta normalmente
        platosFiltrados = platosFiltrados.filter(function(p) {
            return (p.tipoCarta || 'CARTA') === 'CARTA';
        });
    }
    // Si es TODO, no filtrar por tipoCarta
    
    // ‚úÖ NUEVO: Filtrar por platos programados del d√≠a (si est√° activado)
    if (window.filtroProgramadosActivo) {
        const platosProgramados = obtenerPlatosProgramadosHoy();
        if (platosProgramados.length > 0) {
            const skusProgramados = platosProgramados.map(p => p.sku);
            platosFiltrados = platosFiltrados.filter(p => skusProgramados.includes(p.sku));
        } else {
            // Si no hay platos programados pero el filtro est√° activo, no mostrar nada
            platosFiltrados = [];
        }
    }
    
    // Actualizar contador
    document.getElementById('contador-platos').textContent = platosFiltrados.length;
    
    var html = '';
    
    // VISTA NORMAL (2 columnas, fotos medianas)
    if (vistaPOSActual === 'normal') {
        html += '<div class="grid grid-cols-2 gap-3">';
        platosFiltrados.forEach(function(plato) {
            // Calcular disponibilidad
            var disponibilidadInfo = obtenerDisponibilidad(plato, fechaHoy);
            var disponible = disponibilidadInfo.disponible;
            var cantidad = disponibilidadInfo.cantidad;
            var textoDisp = disponibilidadInfo.texto;
            var colorDisp = disponibilidadInfo.color;
            var emoji = disponibilidadInfo.emoji;
            
            var cardClass = disponible ? 'producto-card glass-card p-3 hover:shadow-xl transition-all cursor-pointer' : 'producto-card glass-card p-3 opacity-50 cursor-not-allowed';
            var onclick = disponible ? "agregarItemPedido('" + plato.sku + "')" : '';
            
            html += '<div class="' + cardClass + '" ' + (onclick ? 'onclick="' + onclick + '"' : '') + '>';
            if (plato.foto) {
                html += '<img src="' + plato.foto + '" class="w-full h-24 object-cover rounded-lg mb-2">';
            } else {
                html += '<div class="w-full h-24 bg-gradient-to-br from-slate-100 to-slate-200 rounded-lg mb-2 flex items-center justify-center text-3xl">üçΩÔ∏è</div>';
            }
            html += '<p class="font-black text-xs mb-1 line-clamp-2">' + plato.nombre + '</p>';
            html += '<p class="text-lg font-black text-green-600">S/. ' + plato.precioMenu.toFixed(2) + '</p>';
            
            // Indicador de disponibilidad
            html += '<div class="mt-2 px-2 py-1 rounded-lg text-[10px] font-bold text-center" style="background-color: ' + colorDisp + '20; color: ' + colorDisp + ';">';
            html += emoji + ' ' + textoDisp;
            html += '</div>';
            
            html += '</div>';
        });
        html += '</div>';
    }
    
    // VISTA COMPACTA (4 columnas, fotos peque√±as)
    else if (vistaPOSActual === 'compacta') {
        html += '<div class="grid grid-cols-4 gap-2">';
        platosFiltrados.forEach(function(plato) {
            var disponibilidadInfo = obtenerDisponibilidad(plato, fechaHoy);
            var disponible = disponibilidadInfo.disponible;
            var emoji = disponibilidadInfo.emoji;
            
            var cardClass = disponible ? 'producto-card glass-card p-2 hover:shadow-xl transition-all cursor-pointer' : 'producto-card glass-card p-2 opacity-50 cursor-not-allowed';
            var onclick = disponible ? "agregarItemPedido('" + plato.sku + "')" : '';
            
            html += '<div class="' + cardClass + '" ' + (onclick ? 'onclick="' + onclick + '"' : '') + '>';
            if (plato.foto) {
                html += '<img src="' + plato.foto + '" class="w-full h-16 object-cover rounded-lg mb-1">';
            } else {
                html += '<div class="w-full h-16 bg-gradient-to-br from-slate-100 to-slate-200 rounded-lg mb-1 flex items-center justify-center text-2xl">üçΩÔ∏è</div>';
            }
            html += '<p class="font-bold text-[10px] mb-1 line-clamp-2 leading-tight">' + emoji + ' ' + plato.nombre + '</p>';
            html += '<p class="text-sm font-black text-green-600">S/. ' + plato.precioMenu.toFixed(2) + '</p>';
            html += '</div>';
        });
        html += '</div>';
    }
    
    // VISTA LISTA (sin fotos, m√°xima densidad)
    else if (vistaPOSActual === 'lista') {
        html += '<div class="space-y-1">';
        platosFiltrados.forEach(function(plato) {
            var disponibilidadInfo = obtenerDisponibilidad(plato, fechaHoy);
            var disponible = disponibilidadInfo.disponible;
            var textoDisp = disponibilidadInfo.texto;
            var emoji = disponibilidadInfo.emoji;
            
            var cardClass = disponible ? 'producto-card glass-card p-3 hover:shadow-lg transition-all cursor-pointer flex items-center justify-between' : 'producto-card glass-card p-3 opacity-50 cursor-not-allowed flex items-center justify-between';
            var onclick = disponible ? "agregarItemPedido('" + plato.sku + "')" : '';
            
            html += '<div class="' + cardClass + '" ' + (onclick ? 'onclick="' + onclick + '"' : '') + '>';
            html += '<div class="flex-1">';
            html += '<p class="font-bold text-sm">' + emoji + ' ' + plato.nombre + '</p>';
            if (plato.categoria) {
                html += '<p class="text-xs text-slate-500">' + plato.categoria + ' ‚Ä¢ ' + textoDisp + '</p>';
            }
            html += '</div>';
            html += '<p class="text-lg font-black text-green-600 ml-4">S/. ' + plato.precioMenu.toFixed(2) + '</p>';
            html += '</div>';
        });
        html += '</div>';
    }
    
    // Mensaje especial si no hay platos y se est√° filtrando por MEN√ö
    if (!html && filtroTipoCarta === 'MENU') {
        html = `
            <div class="text-center py-12 px-6">
                <div class="text-6xl mb-4">üìã</div>
                <p class="font-black text-xl text-slate-700 mb-2">Sin Men√∫ del D√≠a Programado</p>
                <p class="text-slate-500 mb-4">No hay platos de men√∫ programados para hoy</p>
                <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 max-w-md mx-auto">
                    <p class="text-sm text-amber-700 font-semibold">üí° Para programar el men√∫:</p>
                    <p class="text-xs text-amber-600 mt-2">Ir a PLANIFICACI√ìN SEMANAL ‚Üí Configurar fechas ‚Üí Agregar platos de men√∫</p>
                </div>
            </div>
        `;
    }
    
    document.getElementById('menu-platos-pos').innerHTML = html || '<p class="text-center text-slate-400 py-12">No hay platos disponibles</p>';
}

// Nueva funci√≥n para obtener platos programados para hoy
function obtenerPlatosProgramadosHoy() {
    const diasSemanaMap = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
    const hoy = new Date();
    const diaNumero = hoy.getDay(); // 0=Domingo, 1=Lunes, etc.
    const diaNombre = diasSemanaMap[diaNumero];
    
    // Mapear d√≠a a √≠ndice de diasSemana (Lunes=0, Martes=1, etc.)
    const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
    const diaIndex = diasSemana.indexOf(diaNombre);
    
    if (diaIndex === -1) return [];
    
    // Determinar semana actual (simplificado: semana par = semana 1, impar = semana 2)
    const numeroSemana = getWeekNumber(hoy);
    const semana = (numeroSemana % 2 === 0) ? 's1' : 's2';
    const key = `${semana}-d${diaIndex}`;
    
    return db.planSemanal[key] || [];
}

// Funci√≥n auxiliar para obtener n√∫mero de semana del a√±o
function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return weekNo;
}

// Variable global para el filtro de programados
window.filtroProgramadosActivo = false;

function toggleFiltroProgramados() {
    window.filtroProgramadosActivo = !window.filtroProgramadosActivo;
    const btn = document.getElementById('btn-filtro-programados');
    if (window.filtroProgramadosActivo) {
        btn.classList.add('bg-green-600', 'text-white');
        btn.classList.remove('bg-slate-200', 'text-slate-700');
        btn.innerHTML = '‚úÖ MOSTRAR SOLO PROGRAMADOS HOY';
    } else {
        btn.classList.remove('bg-green-600', 'text-white');
        btn.classList.add('bg-slate-200', 'text-slate-700');
        btn.innerHTML = 'üìÖ FILTRAR POR PROGRAMACI√ìN';
    }
    renderMenuPOS();
}

// Funci√≥n para obtener disponibilidad de un plato
function obtenerDisponibilidad(plato, fechaHoy) {
    var tipo = plato.tipo || 'PREPARADO';
    
    if (tipo === 'PREPARADO') {
        // Plato preparado - verificar producci√≥n diaria
        var produccion = db.produccionDiaria[plato.sku];
        
        if (!produccion || produccion.fecha !== fechaHoy) {
            return {
                disponible: false,
                cantidad: 0,
                texto: 'Sin producci√≥n hoy',
                color: '#dc2626',
                emoji: '‚ùå'
            };
        }
        
        var disponibles = produccion.cantidad - produccion.vendidos;
        
        if (disponibles <= 0) {
            return {
                disponible: false,
                cantidad: 0,
                texto: 'AGOTADO',
                color: '#dc2626',
                emoji: 'üî¥'
            };
        } else if (disponibles <= 5) {
            return {
                disponible: true,
                cantidad: disponibles,
                texto: 'Quedan ' + disponibles,
                color: '#f59e0b',
                emoji: 'üü°'
            };
        } else {
            return {
                disponible: true,
                cantidad: disponibles,
                texto: 'Disponible: ' + disponibles,
                color: '#10b981',
                emoji: 'üü¢'
            };
        }
    } else {
        // Producto terminado - verificar inventario
        var stock = db.inventario[plato.skuInventario] || 0;
        
        if (stock <= 0) {
            return {
                disponible: false,
                cantidad: 0,
                texto: 'SIN STOCK',
                color: '#dc2626',
                emoji: 'üì¶‚ùå'
            };
        } else if (stock <= 10) {
            return {
                disponible: true,
                cantidad: stock,
                texto: 'Stock: ' + stock.toFixed(0),
                color: '#f59e0b',
                emoji: 'üì¶üü°'
            };
        } else {
            return {
                disponible: true,
                cantidad: stock,
                texto: 'Stock: ' + stock.toFixed(0),
                color: '#10b981',
                emoji: 'üì¶‚úÖ'
            };
        }
    }
}

function agregarItemPedido(sku) {
    var plato = db.platos.find(p => p.sku === sku);
    var fechaHoy = obtenerFechaHoy();
    
    // ‚úÖ VALIDAR DISPONIBILIDAD
    var disponibilidadInfo = obtenerDisponibilidad(plato, fechaHoy);
    
    if (!disponibilidadInfo.disponible) {
        alert('‚ùå NO DISPONIBLE\n\n' + plato.nombre + '\n' + disponibilidadInfo.texto + '\n\nContacta a cocina o selecciona otro plato.');
        return;
    }
    
    // Verificar cantidad en carrito + nueva cantidad
    var cantidadEnCarrito = pedidoActual.items
        .filter(i => i.sku === sku)
        .reduce((sum, i) => sum + i.cantidad, 0);
    
    if (cantidadEnCarrito >= disponibilidadInfo.cantidad) {
        alert('‚ö†Ô∏è STOCK INSUFICIENTE\n\n' + plato.nombre + '\n\nDisponibles: ' + disponibilidadInfo.cantidad + '\nYa en carrito: ' + cantidadEnCarrito + '\n\nNo puedes agregar m√°s.');
        return;
    }
    
    // Alerta si quedan pocos
    if (disponibilidadInfo.cantidad - cantidadEnCarrito <= 3) {
        var mensaje = 'üü° ATENCI√ìN\n\n' + plato.nombre + '\n\nSolo quedan ' + (disponibilidadInfo.cantidad - cantidadEnCarrito) + ' disponibles.\n\n¬øDeseas agregarlo al pedido?';
        if (!confirm(mensaje)) {
            return;
        }
    }
    
    var existente = pedidoActual.items.find(i => i.sku === sku && !i.observacion);
    
    if (existente) {
        existente.cantidad++;
        existente.subtotal = existente.cantidad * existente.precio;
    } else {
        pedidoActual.items.push({
            sku: plato.sku,
            nombre: plato.nombre,
            cantidad: 1,
            precio: plato.precioMenu,
            subtotal: plato.precioMenu,
            observacion: '',
            enviado: false,
            tipo: plato.tipo || 'PREPARADO', // ‚úÖ Guardar tipo
            skuInventario: plato.skuInventario || null // ‚úÖ Guardar SKU inventario
        });
    }
    
    calcularTotalPedido();
    renderPedidoActual();
}

function renderPedidoActual() {
    var html = pedidoActual.items.map((item, idx) => `
        <div class="bg-white rounded-lg p-3 border-2 ${item.enviado ? 'border-orange-300 bg-orange-50' : 'border-slate-200'}">
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                    <p class="font-bold text-sm">${item.nombre}</p>
                    ${item.observacion ? `<p class="text-xs text-blue-600 italic">üìù ${item.observacion}</p>` : ''}
                    ${item.enviado ? '<span class="text-xs bg-orange-500 text-white px-2 py-1 rounded">ENVIADO</span>' : ''}
                </div>
                ${!item.enviado ? `<button onclick="eliminarItemPedido(${idx})" class="text-red-500 font-bold">‚ùå</button>` : ''}
            </div>
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    ${!item.enviado ? `<button onclick="cambiarCantidad(${idx}, -1)" class="bg-slate-200 px-2 py-1 rounded font-bold">-</button>` : ''}
                    <span class="font-bold">x${item.cantidad}</span>
                    ${!item.enviado ? `<button onclick="cambiarCantidad(${idx}, 1)" class="bg-slate-200 px-2 py-1 rounded font-bold">+</button>` : ''}
                </div>
                <span class="font-bold text-green-600">S/. ${item.subtotal.toFixed(2)}</span>
            </div>
            ${!item.enviado ? `<button onclick="agregarObservacion(${idx})" class="text-xs text-blue-600 mt-2">+ Observaci√≥n</button>` : ''}
        </div>
    `).join('');
    
    document.getElementById('items-pedido-actual').innerHTML = html || '<p class="text-center text-slate-400 text-sm">Sin items</p>';
}

function cambiarCantidad(idx, delta) {
    pedidoActual.items[idx].cantidad += delta;
    
    if (pedidoActual.items[idx].cantidad <= 0) {
        pedidoActual.items.splice(idx, 1);
    } else {
        pedidoActual.items[idx].subtotal = pedidoActual.items[idx].cantidad * pedidoActual.items[idx].precio;
    }
    
    calcularTotalPedido();
    renderPedidoActual();
}

function eliminarItemPedido(idx) {
    pedidoActual.items.splice(idx, 1);
    calcularTotalPedido();
    renderPedidoActual();
}

function agregarObservacion(idx) {
    var obs = prompt('Observaci√≥n para el plato:', pedidoActual.items[idx].observacion);
    if (obs !== null) {
        pedidoActual.items[idx].observacion = obs;
        renderPedidoActual();
    }
}

function calcularTotalPedido() {
    pedidoActual.total = pedidoActual.items.reduce((sum, item) => sum + item.subtotal, 0);
    document.getElementById('total-pedido').textContent = pedidoActual.total.toFixed(2);
}

function cancelarPedido() {
    if (confirm('¬øCancelar pedido actual?')) {
        pedidoActual = { tipo: null, mesa: null, items: [], total: 0 };
        document.getElementById('seccion-pedido').classList.add('hidden');
        document.getElementById('btn-salon').classList.remove('opacity-50');
        document.getElementById('btn-llevar').classList.remove('opacity-50');
    }
}

// ========== ENVIAR A COCINA ==========
function enviarACocina() {
    if (pedidoActual.items.length === 0) {
        alert('‚ö†Ô∏è Agrega items al pedido');
        return;
    }
    
    // Obtener solo items no enviados
    var itemsNuevos = pedidoActual.items.filter(i => !i.enviado);
    
    if (itemsNuevos.length === 0) {
        alert('‚ö†Ô∏è Todos los items ya fueron enviados a cocina');
        return;
    }
    
    // Descontar stock (PERMITE STOCK NEGATIVO)
    itemsNuevos.forEach(item => {
        var plato = db.platos.find(p => p.sku === item.sku);
        if (plato) {
            plato.componentes.forEach(comp => {
                var cantidadTotal = comp.cant * item.cantidad;
                var mat = db.materiales.find(m => m.sku === comp.sku);
                
                if (mat) {
                    var cantEnUnidadCosto = cantidadTotal;
                    var stockActual = db.inventario[comp.sku] || 0;
                    var nuevoStock = stockActual - cantEnUnidadCosto;
                    
                    // PERMITIR STOCK NEGATIVO (√∫til cuando no se ha ingresado documento)
                    db.inventario[comp.sku] = nuevoStock;
                    
                    // Avisar en consola si qued√≥ en negativo
                    if (nuevoStock < 0) {
                        console.warn('‚ö†Ô∏è Stock negativo:', mat.nombre, '‚Üí', nuevoStock.toFixed(2), mat.uCosto);
                    }
                }
            });
        }
    });
    
    // Marcar items como enviados
    pedidoActual.items.forEach(item => {
        item.enviado = true;
    });
    
    // Recalcular total antes de guardar
    calcularTotalPedido();
    
    // Actualizar estado de mesa y guardar pedido si es sal√≥n
    if (pedidoActual.tipo === 'salon') {
        var mesa = db.mesas.find(m => m.numero === pedidoActual.mesa);
        mesa.estado = 'ocupada';
        mesa.pedidoId = pedidoActual.pedidoId;
        
        // CR√çTICO: Guardar pedido en pedidosActivos
        if (!db.pedidosActivos) db.pedidosActivos = {};
        db.pedidosActivos[pedidoActual.mesa] = {
            id: pedidoActual.pedidoId,
            items: pedidoActual.items.slice(), // Copia completa de items
            total: pedidoActual.total,
            fecha: db.pedidosActivos[pedidoActual.mesa] ? db.pedidosActivos[pedidoActual.mesa].fecha : new Date().toISOString(),
            mozo: usuarioActual.nombre
        };
        
        console.log('Pedido guardado en db.pedidosActivos[' + pedidoActual.mesa + ']:', db.pedidosActivos[pedidoActual.mesa]);
    } else if (pedidoActual.tipo === 'llevar') {
        // GUARDAR pedido PARA LLEVAR en pedidosActivos
        if (!db.pedidosActivos) db.pedidosActivos = {};
        db.pedidosActivos['LLEVAR'] = {
            items: pedidoActual.items.slice(), // Copia completa de items
            total: pedidoActual.total,
            fecha: db.pedidosActivos['LLEVAR'] ? db.pedidosActivos['LLEVAR'].fecha : new Date().toISOString(),
            mozo: usuarioActual.nombre
        };
        
        console.log('ü•° Pedido PARA LLEVAR guardado en db.pedidosActivos[LLEVAR]:', db.pedidosActivos['LLEVAR']);
    }
    
    save();
    renderPedidoActual();
    actualizarIndicadoresMesas();
    
    // Generar ticket de cocina PRIMERO
    imprimirTicketCocina(itemsNuevos);
    
    // Mostrar mensaje de confirmaci√≥n
    alert('‚úÖ Pedido enviado a cocina');
}

function imprimirTicketCocina(items) {
    console.log('=== IMPRIMIR TICKET ===');
    
    var fecha = new Date();
    var html = '';
    
    html += '<div id="modal-ticket-cocina" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99999;">';
    html += '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 0; border-radius: 15px; width: 400px; max-height: 90vh; overflow-y: auto;">';
    
    // Contenido imprimible
    html += '<div id="ticket-content" style="padding: 30px;">';
    
    // Logo y t√≠tulo
    html += '<div style="text-align: center; margin-bottom: 20px; border-bottom: 3px solid #ff6b35; padding-bottom: 15px;">';
    html += '<div style="font-size: 50px; margin-bottom: 10px;">üè®</div>';
    html += '<h1 style="margin: 0; font-size: 22px; font-weight: 900; color: #ff6b35;">SWISSOTEL</h1>';
    html += '<p style="margin: 3px 0 0 0; font-size: 11px; color: #666;">HOTELERA COSTA DEL PACIFICO S.A.</p>';
    html += '<p style="margin: 3px 0 0 0; font-size: 11px; color: #666;">RUC: 20297885538</p>';
    html += '<p style="margin: 3px 0 0 0; font-size: 10px; color: #666;">Cal. Cantuarias Nro. 289, Urb. Progreso - Miraflores, Lima</p>';
    html += '</div>';
    
    // Header orden - Muestra MESA X o PARA LLEVAR
    var headerTexto = pedidoActual.tipo === 'salon' ? 'MESA ' + pedidoActual.mesa : 'PARA LLEVAR';
    html += '<div style="text-align: center; background: #ff6b35; color: white; padding: 15px; margin: 0 -30px 20px -30px;">';
    html += '<h2 style="margin: 0; font-size: 24px; font-weight: 900;">' + headerTexto + '</h2>';
    html += '</div>';
    
    // Informaci√≥n
    html += '<div style="background: #fff5f2; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ff6b35;">';
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
    html += '<p style="margin: 0; font-size: 13px;"><strong>Fecha:</strong> ' + fecha.toLocaleDateString('es-PE') + '</p>';
    html += '<p style="margin: 0; font-size: 13px;"><strong>Hora:</strong> ' + fecha.toLocaleTimeString('es-PE') + '</p>';
    
    // Solo mostrar mesa si es tipo llevar (porque en sal√≥n ya est√° en el header)
    if (pedidoActual.tipo === 'llevar') {
        html += '<p style="margin: 0; font-size: 13px;"><strong>Tipo:</strong> Para Llevar</p>';
    }
    
    html += '<p style="margin: 0; font-size: 13px;"><strong>Mozo:</strong> ' + usuarioActual.nombre + '</p>';
    html += '</div>';
    html += '</div>';
    
    // Items
    html += '<div style="margin-bottom: 20px;">';
    html += '<h3 style="margin: 0 0 15px 0; font-size: 16px; color: #ff6b35; border-bottom: 2px solid #ff6b35; padding-bottom: 8px;">PEDIDO:</h3>';
    
    for (var i = 0; i < items.length; i++) {
        html += '<div style="background: white; border-left: 4px solid #ff6b35; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
        html += '<p style="margin: 0; font-weight: 900; font-size: 18px; color: #333;">' + items[i].cantidad + 'x ' + items[i].nombre + '</p>';
        if (items[i].observacion) {
            html += '<p style="margin: 8px 0 0 0; font-style: italic; color: #ff6b35; background: #fff5f2; padding: 8px; border-radius: 5px; font-size: 14px;">Obs: ' + items[i].observacion + '</p>';
        }
        html += '</div>';
    }
    
    html += '</div>';
    html += '</div>'; // Fin ticket-content
    
    // Botones
    html += '<div id="ticket-buttons" style="padding: 0 30px 30px 30px; background: white; border-top: 2px solid #eee;">';
    html += '<div style="display: flex; gap: 10px; padding-top: 20px;">';
    html += '<button onclick="imprimirTicket()" style="flex: 1; background: #ff6b35; color: white; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px;">IMPRIMIR</button>';
    html += '<button onclick="cerrarModalTicket()" style="background: #ddd; color: #333; padding: 15px 25px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px;">CERRAR</button>';
    html += '</div>';
    html += '</div>';
    
    html += '</div></div>';
    
    document.body.insertAdjacentHTML('beforeend', html);
    console.log('Ticket insertado');
}

function imprimirTicket() {
    var buttons = document.getElementById('ticket-buttons');
    var modal = document.getElementById('modal-ticket-cocina');
    
    if (buttons) buttons.style.display = 'none';
    if (modal) modal.style.background = 'white';
    
    window.print();
    
    setTimeout(function() {
        // Cerrar el modal despu√©s de imprimir
        cerrarModalTicket();
    }, 500);
}

function cerrarModalTicket() {
    var modal = document.getElementById('modal-ticket-cocina');
    if (modal) modal.remove();
    
    // Volver autom√°ticamente al inicio despu√©s de cerrar el ticket
    volverInicio();
}



// ========== COBRAR PEDIDO ==========
function cobrarPedido() {
    if (pedidoActual.items.length === 0) {
        alert('‚ö†Ô∏è No hay items en el pedido');
        return;
    }
    
    var itemsNoEnviados = pedidoActual.items.filter(i => !i.enviado);
    if (itemsNoEnviados.length > 0) {
        alert('‚ö†Ô∏è Hay items sin enviar a cocina');
        return;
    }
    
    // Recalcular total antes de mostrar modal
    calcularTotalPedido();
    
    // Mostrar modal de cobro
    mostrarModalCobro();
}

function mostrarModalCobro() {
    console.log('=== MOSTRAR MODAL COBRO ===');
    
    var html = '';
    html += '<div id="modal-cobro" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99999;">';
    html += '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 450px; max-height: 90vh; overflow-y: auto;">';
    html += '<h2 style="margin: 0 0 20px 0; font-size: 24px; font-weight: bold;">COBRAR PEDIDO</h2>';
    
    // SELECTOR DE DESCUENTO
    var descuentosActivos = db.descuentos ? db.descuentos.filter(d => d.activo) : [];
    if(descuentosActivos.length > 0) {
        html += '<div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 8px; padding: 15px; margin-bottom: 15px;">';
        html += '<label style="display: block; margin-bottom: 8px; font-weight: bold; color: #059669;">üéüÔ∏è Aplicar Descuento:</label>';
        html += '<select id="descuento-select" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #86efac; border-radius: 5px; font-size: 14px;" onchange="aplicarDescuentoModal()">';
        html += '<option value="">Sin descuento</option>';
        descuentosActivos.forEach(desc => {
            var valorTexto = desc.tipo === 'porcentaje' ? desc.valor + '%' : 'S/. ' + desc.valor.toFixed(2);
            html += '<option value="' + desc.id + '">' + desc.nombre + ' (' + valorTexto + ')</option>';
        });
        html += '</select>';
        html += '<div id="descuento-aplicado" style="display: none; padding: 8px; background: #dcfce7; border-radius: 5px; font-size: 13px;"></div>';
        html += '</div>';
    }
    
    // TOTALES
    html += '<div style="background: #f9fafb; border-radius: 8px; padding: 15px; margin-bottom: 15px;">';
    html += '<p style="font-size: 14px; margin: 5px 0;">Subtotal: <span id="subtotal-display">S/. ' + pedidoActual.total.toFixed(2) + '</span></p>';
    html += '<p id="descuento-monto-display" style="font-size: 14px; margin: 5px 0; color: #059669; display: none;">Descuento: <span></span></p>';
    html += '<p style="font-size: 24px; font-weight: bold; color: green; margin: 10px 0;">TOTAL: <span id="total-display">S/. ' + pedidoActual.total.toFixed(2) + '</span></p>';
    html += '</div>';
    
    html += '<label style="display: block; margin: 10px 0;">M√©todo de pago:</label>';
    html += '<select id="metodo-pago" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">';
    html += '<option value="efectivo">Efectivo</option>';
    html += '<option value="tarjeta">Tarjeta</option>';
    html += '<option value="yape">Yape/Plin</option>';
    html += '</select>';
    html += '<div id="div-efectivo">';
    html += '<label style="display: block; margin: 10px 0;">Monto recibido:</label>';
    html += '<input type="number" id="monto-recibido" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;" step="0.01" onchange="calcularVuelto()">';
    html += '<p>Vuelto: <span id="vuelto">S/. 0.00</span></p>';
    html += '</div>';
    html += '<button onclick="confirmarCobro()" style="background: green; color: white; padding: 15px 30px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer; font-size: 16px;">CONFIRMAR</button>';
    html += '<button onclick="cerrarModalCobro()" style="background: gray; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">CANCELAR</button>';
    html += '</div></div>';
    
    document.body.insertAdjacentHTML('beforeend', html);
    console.log('Modal cobro insertado');
    
    // Event listener para cambio de m√©todo de pago
    var selectMetodo = document.getElementById('metodo-pago');
    if (selectMetodo) {
        selectMetodo.addEventListener('change', function() {
            var divEfectivo = document.getElementById('div-efectivo');
            if (divEfectivo) {
                if (this.value === 'efectivo') {
                    divEfectivo.style.display = 'block';
                } else {
                    divEfectivo.style.display = 'none';
                }
            }
        });
    }
}

// NUEVA FUNCI√ìN: Aplicar descuento en el modal
function aplicarDescuentoModal() {
    var descuentoId = document.getElementById('descuento-select').value;
    var subtotal = pedidoActual.total;
    var montoDescuento = 0;
    var totalFinal = subtotal;
    
    if(descuentoId) {
        var descuento = db.descuentos.find(d => d.id === descuentoId);
        if(descuento) {
            if(descuento.tipo === 'porcentaje') {
                montoDescuento = subtotal * (descuento.valor / 100);
            } else {
                montoDescuento = descuento.valor;
            }
            totalFinal = subtotal - montoDescuento;
            
            // Mostrar descuento aplicado
            document.getElementById('descuento-aplicado').style.display = 'block';
            document.getElementById('descuento-aplicado').innerHTML = '‚úÖ Descuento aplicado: <strong>-S/. ' + montoDescuento.toFixed(2) + '</strong>';
            
            document.getElementById('descuento-monto-display').style.display = 'block';
            document.getElementById('descuento-monto-display').querySelector('span').textContent = '-S/. ' + montoDescuento.toFixed(2);
        }
    } else {
        // Sin descuento
        document.getElementById('descuento-aplicado').style.display = 'none';
        document.getElementById('descuento-monto-display').style.display = 'none';
    }
    
    // Actualizar displays
    document.getElementById('subtotal-display').textContent = 'S/. ' + subtotal.toFixed(2);
    document.getElementById('total-display').textContent = 'S/. ' + totalFinal.toFixed(2);
    
    // Guardar info del descuento temporalmente
    window.descuentoTemporal = {
        id: descuentoId,
        monto: montoDescuento,
        totalFinal: totalFinal
    };
    
    // Recalcular vuelto si hay monto recibido
    if(document.getElementById('monto-recibido')) {
        calcularVuelto();
    }
}

function calcularVuelto() {
    var recibido = parseFloat(document.getElementById('monto-recibido').value) || 0;
    var totalFinal = window.descuentoTemporal ? window.descuentoTemporal.totalFinal : pedidoActual.total;
    var vuelto = recibido - totalFinal;
    document.getElementById('vuelto').textContent = 'S/. ' + vuelto.toFixed(2);
}

function confirmarCobro() {
    console.log('CONFIRMAR COBRO INICIADO');
    
    var metodo = document.getElementById('metodo-pago').value;
    var totalFinal = window.descuentoTemporal ? window.descuentoTemporal.totalFinal : pedidoActual.total;
    var descuentoAplicado = null;
    
    // Capturar info del descuento si existe
    if(window.descuentoTemporal && window.descuentoTemporal.id) {
        var desc = db.descuentos.find(d => d.id === window.descuentoTemporal.id);
        if(desc) {
            descuentoAplicado = {
                id: desc.id,
                nombre: desc.nombre,
                tipo: desc.tipo,
                valor: desc.valor,
                montoDescontado: window.descuentoTemporal.monto
            };
        }
    }
    
    if (metodo === 'efectivo') {
        var recibido = parseFloat(document.getElementById('monto-recibido').value) || 0;
        if (recibido < totalFinal) {
            alert('Monto insuficiente. Recibido: S/. ' + recibido.toFixed(2) + ' - Total: S/. ' + totalFinal.toFixed(2));
            return;
        }
    }
    
    if (!db.ventas) db.ventas = [];
    if (!db.historialVentas) db.historialVentas = [];
    
    var venta = {
        id: Date.now().toString(),
        fecha: new Date().toISOString(),
        tipo: pedidoActual.tipo,
        mesa: pedidoActual.mesa,
        items: pedidoActual.items.slice(),
        subtotal: pedidoActual.total,
        descuento: descuentoAplicado,
        total: totalFinal,
        metodoPago: metodo,
        usuario: usuarioActual.nombre
    };
    
    db.ventas.push(venta);
    db.historialVentas.push(venta); // Para c√°lculos financieros
    
    // ========== ‚úÖ DESCUENTO AUTOM√ÅTICO DE STOCK/PRODUCCI√ìN ==========
    var fechaHoy = obtenerFechaHoy();
    pedidoActual.items.forEach(function(item) {
        var plato = db.platos.find(p => p.sku === item.sku);
        if (!plato) return;
        
        var tipo = item.tipo || plato.tipo || 'PREPARADO';
        
        if (tipo === 'PREPARADO') {
            // Descontar de producci√≥n diaria
            if (db.produccionDiaria[item.sku] && db.produccionDiaria[item.sku].fecha === fechaHoy) {
                db.produccionDiaria[item.sku].vendidos += item.cantidad;
                console.log('‚úÖ Descontado de producci√≥n:', item.nombre, '- Cantidad:', item.cantidad);
            } else {
                console.warn('‚ö†Ô∏è No hay producci√≥n registrada para:', item.nombre);
            }
        } else if (tipo === 'PRODUCTO_TERMINADO') {
            // Descontar de inventario
            var skuInv = item.skuInventario || plato.skuInventario;
            if (skuInv && db.inventario[skuInv]) {
                db.inventario[skuInv] -= item.cantidad;
                if (db.inventario[skuInv] < 0) db.inventario[skuInv] = 0;
                console.log('‚úÖ Descontado de inventario:', item.nombre, '- Cantidad:', item.cantidad, '- Stock restante:', db.inventario[skuInv]);
            } else {
                console.warn('‚ö†Ô∏è No se pudo descontar inventario para:', item.nombre);
            }
        }
    });
    // =================================================================
    
    // Liberar mesa si es sal√≥n
    if (pedidoActual.tipo === 'salon') {
        console.log('Liberando mesa:', pedidoActual.mesa);
        for (var i = 0; i < db.mesas.length; i++) {
            if (db.mesas[i].numero === pedidoActual.mesa) {
                db.mesas[i].estado = 'libre';
                db.mesas[i].pedidoId = null;
                console.log('Mesa', pedidoActual.mesa, 'liberada. Estado:', db.mesas[i].estado);
                break;
            }
        }
        
        // Eliminar pedido activo
        if (db.pedidosActivos && db.pedidosActivos[pedidoActual.mesa]) {
            delete db.pedidosActivos[pedidoActual.mesa];
            console.log('Pedido activo eliminado de mesa', pedidoActual.mesa);
        }
    } else if (pedidoActual.tipo === 'llevar') {
        // Eliminar pedido PARA LLEVAR activo
        if (db.pedidosActivos && db.pedidosActivos['LLEVAR']) {
            delete db.pedidosActivos['LLEVAR'];
            console.log('ü•° Pedido PARA LLEVAR eliminado de pedidosActivos');
        }
    }
    
    // Limpiar descuento temporal
    window.descuentoTemporal = null;
    
    save();
    console.log('Cambios guardados en localStorage');
    console.log('üí∞ Venta guardada: S/.', venta.total.toFixed(2));
    
    var ventaParaImprimir = venta;
    
    // Limpiar pedidoActual completamente
    pedidoActual = { tipo: null, mesa: null, items: [], total: 0, pedidoId: null };
    
    cerrarModalCobro();
    imprimirBoleta(ventaParaImprimir);
    
    document.getElementById('seccion-pedido').classList.add('hidden');
    document.getElementById('selector-tipo-pedido').classList.remove('hidden');
    
    actualizarIndicadoresMesas();
    console.log('COBRO COMPLETADO');
}
    

function cerrarModalCobro() {
    var modal = document.getElementById('modal-cobro');
    if (modal) modal.remove();
}

function imprimirBoleta(venta) {
    console.log('=== IMPRIMIR BOLETA ===');
    
    var fecha = new Date(venta.fecha);
    var html = '';
    
    html += '<div id="modal-boleta" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99999;">';
    html += '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 0; border-radius: 15px; width: 420px; max-height: 90vh; overflow-y: auto;">';
    
    // Contenido imprimible
    html += '<div id="boleta-content" style="padding: 30px;">';
    
    // Logo y header
    html += '<div style="text-align: center; margin-bottom: 20px;">';
    html += '<div style="font-size: 60px; margin-bottom: 10px;">üè®</div>';
    html += '<h1 style="margin: 0; font-size: 26px; font-weight: 900; color: #16a34a;">SWISSOTEL</h1>';
    html += '<p style="margin: 3px 0; font-size: 12px; color: #666;">HOTELERA COSTA DEL PACIFICO S.A.</p>';
    html += '<p style="margin: 3px 0; font-size: 11px; color: #666;">RUC: 20297885538</p>';
    html += '<p style="margin: 3px 0; font-size: 11px; color: #666;">Cal. Cantuarias Nro. 289, Urb. Progreso</p>';
    html += '<p style="margin: 3px 0; font-size: 11px; color: #666;">Miraflores - Lima, Per√∫</p>';
    html += '</div>';
    
    // T√≠tulo boleta
    html += '<div style="text-align: center; background: #16a34a; color: white; padding: 12px; margin: 0 -30px 20px -30px;">';
    html += '<h2 style="margin: 0; font-size: 20px; font-weight: 900;">BOLETA DE VENTA</h2>';
    html += '</div>';
    
    // Informaci√≥n de venta
    html += '<div style="background: #f0fdf4; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #16a34a;">';
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">';
    html += '<p style="margin: 0;"><strong>Fecha:</strong> ' + fecha.toLocaleDateString('es-PE') + '</p>';
    html += '<p style="margin: 0;"><strong>Hora:</strong> ' + fecha.toLocaleTimeString('es-PE') + '</p>';
    html += '<p style="margin: 0;"><strong>Mesa:</strong> ' + venta.mesa + '</p>';
    html += '<p style="margin: 0;"><strong>Atendio:</strong> ' + venta.usuario + '</p>';
    html += '</div>';
    html += '</div>';
    
    // Tabla de items
    html += '<table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">';
    html += '<thead>';
    html += '<tr style="background: #f0fdf4; border-bottom: 2px solid #16a34a;">';
    html += '<th style="padding: 10px 5px; text-align: left; font-size: 12px;">CANT</th>';
    html += '<th style="padding: 10px 5px; text-align: left; font-size: 12px;">DESCRIPCION</th>';
    html += '<th style="padding: 10px 5px; text-align: right; font-size: 12px;">IMPORTE</th>';
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';
    
    for (var i = 0; i < venta.items.length; i++) {
        html += '<tr style="border-bottom: 1px solid #e5e7eb;">';
        html += '<td style="padding: 10px 5px; font-weight: bold;">' + venta.items[i].cantidad + '</td>';
        html += '<td style="padding: 10px 5px;">' + venta.items[i].nombre + '</td>';
        html += '<td style="padding: 10px 5px; text-align: right; font-weight: bold;">' + venta.items[i].subtotal.toFixed(2) + '</td>';
        html += '</tr>';
    }
    
    html += '</tbody>';
    html += '</table>';
    
    // Total
    html += '<div style="background: #16a34a; color: white; padding: 20px; border-radius: 10px; margin-bottom: 15px;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
    html += '<span style="font-size: 18px; font-weight: bold;">TOTAL A PAGAR:</span>';
    html += '<span style="font-size: 32px; font-weight: 900;">' + venta.total.toFixed(2) + '</span>';
    html += '</div>';
    html += '<p style="margin: 10px 0 0 0; font-size: 13px; text-align: center;">Metodo de pago: ' + venta.metodoPago.toUpperCase() + '</p>';
    html += '</div>';
    
    // Footer
    html += '<div style="text-align: center; padding-top: 15px; border-top: 2px dashed #16a34a;">';
    html += '<p style="margin: 5px 0; font-weight: bold; font-size: 15px;">GRACIAS POR SU VISITA</p>';
    html += '<p style="margin: 5px 0; font-size: 12px; color: #666;">Esperamos volver a atenderle pronto</p>';
    html += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #999;">El sabor que conquista</p>';
    html += '</div>';
    
    html += '</div>'; // Fin boleta-content
    
    // Botones
    html += '<div id="boleta-buttons" style="padding: 0 30px 30px 30px; background: white; border-top: 2px solid #eee;">';
    html += '<div style="display: flex; gap: 10px; padding-top: 20px;">';
    html += '<button onclick="imprimirBoletaFinal()" style="flex: 1; background: #16a34a; color: white; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px;">IMPRIMIR</button>';
    html += '<button onclick="cerrarModalBoleta()" style="background: #ddd; color: #333; padding: 15px 25px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px;">CERRAR</button>';
    html += '</div>';
    html += '</div>';
    
    html += '</div></div>';
    
    document.body.insertAdjacentHTML('beforeend', html);
    console.log('Boleta insertada');
}

function imprimirBoletaFinal() {
    var buttons = document.getElementById('boleta-buttons');
    var modal = document.getElementById('modal-boleta');
    
    if (buttons) buttons.style.display = 'none';
    if (modal) modal.style.background = 'white';
    
    window.print();
    
    setTimeout(function() {
        if (buttons) buttons.style.display = 'block';
        if (modal) modal.style.background = 'rgba(0,0,0,0.8)';
    }, 500);
}

function cerrarModalBoleta() {
    var modal = document.getElementById('modal-boleta');
    if (modal) modal.remove();
}



function cargarPedidoExistente(pedidoId) {
    console.log('Cargar pedido existente:', pedidoId);
    
    // Buscar en qu√© mesa est√° este pedido
    var mesaDelPedido = null;
    var pedidoData = null;
    
    for (var i = 0; i < db.mesas.length; i++) {
        if (db.mesas[i].pedidoId === pedidoId) {
            mesaDelPedido = db.mesas[i].numero;
            break;
        }
    }
    
    console.log('Mesa del pedido:', mesaDelPedido);
    
    if (mesaDelPedido && db.pedidosActivos && db.pedidosActivos[mesaDelPedido]) {
        pedidoData = db.pedidosActivos[mesaDelPedido];
        console.log('Pedido encontrado:', pedidoData);
    } else {
        console.error('No se encontro pedido activo');
        alert('No se pudo cargar el pedido');
        return;
    }
    
    // Cargar datos al pedidoActual
    pedidoActual = {
        tipo: 'salon',
        mesa: mesaDelPedido,
        items: pedidoData.items ? pedidoData.items.slice() : [],
        total: 0,  // Se recalcular√° autom√°ticamente
        pedidoId: pedidoId
    };
    
    console.log('pedidoActual cargado:', pedidoActual);
    
    // Recalcular total basado en items
    calcularTotalPedido();
    
    // Actualizar interfaz
    renderPedidoActual();
}

// ========== GESTI√ìN DE USUARIOS ==========
function renderUsuarios() {
    if (!db.usuarios) db.usuarios = [];
    
    // üîí Filtrar usuario manager (oculto)
    const usuariosVisibles = db.usuarios.filter(u => !u.oculto && u.id !== 'manager');
    
    const html = usuariosVisibles.map(u => {
        // Definir badge seg√∫n rol
        let rolBadge = '';
        if (u.rol === 'admin') {
            rolBadge = '<span class="px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">üë®‚Äçüíº ADMIN</span>';
        } else if (u.rol === 'chef') {
            rolBadge = '<span class="px-3 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">üë®‚Äçüç≥ CHEF</span>';
        } else if (u.rol === 'almacen') {
            rolBadge = '<span class="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">üì¶ ALMAC√âN</span>';
        } else {
            rolBadge = '<span class="px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700">üë®‚Äçüç≥ MOZO</span>';
        }
        
        return `
        <tr class="hover:bg-purple-50 transition-colors">
            <td class="p-4">
                <span class="font-mono text-xs bg-purple-100 px-2 py-1 rounded">${u.usuario}</span>
            </td>
            <td class="p-4 font-semibold">${u.nombre}</td>
            <td class="p-4">
                ${rolBadge}
            </td>
            <td class="p-4 text-right">
                <div class="flex gap-2 justify-end">
                    <button onclick="editarUsuario('${u.id}')" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-200 btn-action">
                        ‚úèÔ∏è
                    </button>
                    ${u.id !== 'admin' ? `<button onclick="eliminarUsuario('${u.id}')" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-200 btn-action">üóëÔ∏è</button>` : ''}
                </div>
            </td>
        </tr>
        `;
    }).join('');
    
    document.getElementById('usuarios-list').innerHTML = html || `
        <tr><td colspan="4" class="p-8 text-center text-slate-400">
            <div class="text-4xl mb-2">üë•</div>
            No hay usuarios registrados
        </td></tr>
    `;
}

function guardarUsuario() {
    if (!db.usuarios) db.usuarios = [];
    
    const id = document.getElementById('user-id-hidden').value;
    const usuario = document.getElementById('user-usuario').value.trim();
    const password = document.getElementById('user-password').value.trim();
    const nombre = document.getElementById('user-nombre').value.trim();
    const rol = document.getElementById('user-rol').value;
    
    console.log('üîç Guardando usuario:', {usuario, password, nombre, rol});
    
    // üîí PROTECCI√ìN: No permitir usuario "manager" reservado
    if (usuario.toLowerCase() === 'manager' && id !== 'manager') {
        alert('‚ùå El nombre de usuario "manager" est√° reservado.\n\nPor favor usa otro nombre.');
        return;
    }
    
    if (!usuario || !password || !nombre) {
        alert('‚ö†Ô∏è Completa todos los campos');
        return;
    }
    
    // VALIDACI√ìN: PIN debe ser de exactamente 4 d√≠gitos
    if (!/^\d{4}$/.test(password)) {
        alert('‚ùå El PIN debe ser de exactamente 4 d√≠gitos num√©ricos\n\nEjemplo: 1234, 5678, 9999');
        return;
    }
    
    // üîí VALIDACI√ìN: PIN no puede ser 128080 (reservado para manager)
    if (password === '128080' || password.startsWith('1280')) {
        alert('‚ùå Este PIN est√° reservado por el sistema.\n\nPor favor elige otro PIN.');
        return;
    }
    
    // VALIDACI√ìN: PIN no puede repetirse en otros usuarios (excluir usuarios ocultos)
    const pinDuplicado = db.usuarios.find(u => u.password === password && u.id !== id && !u.oculto);
    if (pinDuplicado) {
        alert('‚ùå Este PIN ya est√° en uso por otro usuario\n\nUsuario: ' + pinDuplicado.nombre + '\n\nPor favor elige un PIN diferente.');
        return;
    }
    
    // OBTENER PERMISOS SELECCIONADOS (solo si no es mozo ni admin)
    var permisos = [];
    if (rol !== 'mozo') {
        var checks = document.querySelectorAll('.permiso-check:checked');
        checks.forEach(function(check) {
            permisos.push(check.getAttribute('data-modulo'));
        });
    }
    
    const user = {
        id: id || Date.now().toString(),
        usuario: usuario,
        password: password,
        nombre: nombre,
        rol: rol,
        permisos: permisos // Agregar permisos personalizados
    };
    
    console.log('‚úÖ Usuario creado/actualizado:', user);
    console.log('üîê Permisos asignados:', permisos);
    
    if (id) {
        const idx = db.usuarios.findIndex(u => u.id === id);
        db.usuarios[idx] = user;
    } else {
        // Verificar que usuario no exista
        if (db.usuarios.find(u => u.usuario === usuario)) {
            alert('‚ùå El usuario ya existe');
            return;
        }
        db.usuarios.push(user);
    }
    
    limpiarFormUsuario();
    save();
    renderUsuarios();
    
    // Registrar actividad
    var accion = id ? 'Edici√≥n de usuario' : 'Creaci√≥n de usuario';
    var detalles = 'Usuario: ' + nombre + ', Rol: ' + rol;
    if (permisos.length > 0) {
        detalles += ', Permisos: ' + permisos.length + ' m√≥dulos';
    }
    registrarActividad('usuarios', accion, detalles);
    
    console.log('üìä Total usuarios en sistema:', db.usuarios.length);
    console.log('üìã Usuarios:', db.usuarios.map(u => ({usuario: u.usuario, rol: u.rol})));
    
    var mensajePermisos = permisos.length > 0 ? '\nüîê Permisos: ' + permisos.length + ' m√≥dulos' : '';
    alert('‚úÖ Usuario guardado correctamente\n\nüë§ Usuario: ' + usuario + '\nüîí PIN: ' + password + '\nüëî Rol: ' + rol + mensajePermisos);
}

function editarUsuario(id) {
    // üîí PROTECCI√ìN: No permitir editar usuario manager
    if (id === 'manager') {
        alert('üîí Este usuario est√° protegido y no puede ser editado.');
        return;
    }
    
    const user = db.usuarios.find(u => u.id === id);
    document.getElementById('user-id-hidden').value = user.id;
    document.getElementById('user-usuario').value = user.usuario;
    document.getElementById('user-password').value = user.password;
    document.getElementById('user-nombre').value = user.nombre;
    document.getElementById('user-rol').value = user.rol;
    
    // Mostrar permisos si no es mozo
    mostrarPermisosSegunRol();
    
    // Cargar permisos del usuario
    if (user.permisos && user.permisos.length > 0) {
        // Primero deseleccionar todos
        document.querySelectorAll('.permiso-check').forEach(function(check) {
            check.checked = false;
        });
        
        // Luego marcar solo los permisos del usuario
        user.permisos.forEach(function(modulo) {
            var check = document.querySelector('.permiso-check[data-modulo="' + modulo + '"]');
            if (check) check.checked = true;
        });
    }
}

function eliminarUsuario(id) {
    // üîí PROTECCI√ìN: No permitir eliminar usuario manager
    if (id === 'manager') {
        alert('üîí Este usuario est√° protegido y no puede ser eliminado.');
        return;
    }
    
    var usuario = db.usuarios.find(u => u.id === id);
    if (!usuario) return;
    
    if (confirm('¬øEliminar este usuario?')) {
        registrarActividad('usuarios', 'Eliminaci√≥n de usuario', 'Usuario: ' + usuario.nombre + ', Rol: ' + usuario.rol);
        
        db.usuarios = db.usuarios.filter(u => u.id !== id);
        save();
        renderUsuarios();
    }
}

function limpiarFormUsuario() {
    document.getElementById('user-id-hidden').value = '';
    document.getElementById('user-usuario').value = '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-nombre').value = '';
    document.getElementById('user-rol').value = 'mozo';
    
    // Ocultar secci√≥n de permisos
    document.getElementById('permisos-section').classList.add('hidden');
    
    // Marcar todos los permisos por defecto
    document.querySelectorAll('.permiso-check').forEach(function(check) {
        // Por defecto, marcar todos excepto usuarios y logs
        if (check.getAttribute('data-modulo') === 'usuarios' || check.getAttribute('data-modulo') === 'logs') {
            check.checked = false;
        } else {
            check.checked = true;
        }
    });
}

// Mostrar/ocultar permisos seg√∫n el rol seleccionado
function mostrarPermisosSegunRol() {
    var rol = document.getElementById('user-rol').value;
    var permisosSection = document.getElementById('permisos-section');
    
    if (rol === 'mozo') {
        // Mozos no tienen permisos personalizados (solo POS)
        permisosSection.classList.add('hidden');
    } else {
        // Chef, almac√©n, admin -> mostrar permisos
        permisosSection.classList.remove('hidden');
        
        // Si es admin, marcar todos por defecto
        if (rol === 'admin') {
            seleccionarTodosPermisos();
        }
    }
}

// Seleccionar todos los permisos
function seleccionarTodosPermisos() {
    document.querySelectorAll('.permiso-check').forEach(function(check) {
        check.checked = true;
    });
}

// Deseleccionar todos los permisos
function deseleccionarTodosPermisos() {
    document.querySelectorAll('.permiso-check').forEach(function(check) {
        check.checked = false;
    });
}

// ========== FUNCI√ìN AUXILIAR PARA AGREGAR NUEVOS PERMISOS DIN√ÅMICAMENTE ==========
/**
 * Agrega un nuevo permiso al sistema de forma din√°mica
 * @param {string} moduloId - ID √∫nico del m√≥dulo (ej: "inventario-avanzado")
 * @param {string} nombreVisible - Nombre que se muestra al usuario (ej: "üì¶ INVENTARIO AVANZADO")
 * @param {boolean} checkedPorDefecto - Si debe estar marcado por defecto (true/false)
 * 
 * Ejemplo de uso:
 * agregarNuevoPermiso('reportes-avanzados', 'üìä REPORTES AVANZADOS', true);
 */
function agregarNuevoPermiso(moduloId, nombreVisible, checkedPorDefecto = true) {
    const grid = document.querySelector('#permisos-section .grid');
    if (!grid) {
        console.error('‚ùå No se encontr√≥ la grilla de permisos');
        return false;
    }
    
    // Verificar si el permiso ya existe
    const existente = document.querySelector(`.permiso-check[data-modulo="${moduloId}"]`);
    if (existente) {
        console.warn('‚ö†Ô∏è El permiso "' + moduloId + '" ya existe');
        return false;
    }
    
    // Crear nuevo permiso
    const label = document.createElement('label');
    label.className = 'flex items-center gap-2 p-3 rounded-lg border-2 border-slate-200 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'permiso-check w-4 h-4';
    checkbox.setAttribute('data-modulo', moduloId);
    if (checkedPorDefecto) checkbox.checked = true;
    
    const span = document.createElement('span');
    span.className = 'text-xs font-bold';
    span.textContent = nombreVisible;
    
    label.appendChild(checkbox);
    label.appendChild(span);
    grid.appendChild(label);
    
    console.log('‚úÖ Nuevo permiso agregado: ' + moduloId);
    return true;
}

/**
 * Agrega m√∫ltiples permisos de una vez
 * @param {Array} permisos - Array de objetos {id, nombre, checked}
 * 
 * Ejemplo:
 * agregarNuevosPermisos([
 *     {id: 'modulo1', nombre: 'üî∞ M√ìDULO 1', checked: true},
 *     {id: 'modulo2', nombre: 'üéØ M√ìDULO 2', checked: false}
 * ]);
 */
function agregarNuevosPermisos(permisos) {
    if (!Array.isArray(permisos)) {
        console.error('‚ùå Se esperaba un array de permisos');
        return;
    }
    
    let agregados = 0;
    permisos.forEach(p => {
        if (agregarNuevoPermiso(p.id, p.nombre, p.checked !== false)) {
            agregados++;
        }
    });
    
    console.log('‚úÖ ' + agregados + ' permisos agregados de ' + permisos.length + ' solicitados');
}

function resetearTodosLosUsuarios() {
    // CONFIRMACI√ìN 1
    var confirmar1 = confirm('‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\n¬øEst√°s seguro de que deseas BORRAR TODOS LOS USUARIOS?\n\nEsta acci√≥n:\n‚Ä¢ Eliminar√° todos los usuarios del sistema\n‚Ä¢ No se puede deshacer\n‚Ä¢ Deber√°s crear nuevos usuarios despu√©s\n\n¬øContinuar?');
    
    if (!confirmar1) {
        console.log('‚ùå Reseteo cancelado por el usuario');
        return;
    }
    
    // CONFIRMACI√ìN 2
    var confirmar2 = confirm('üö® √öLTIMA CONFIRMACI√ìN üö®\n\n¬øREALMENTE deseas eliminar TODOS los usuarios?\n\nDespu√©s del reseteo:\n‚Ä¢ Solo existir√° el usuario Admin / PIN: 1991\n‚Ä¢ Todos los dem√°s usuarios ser√°n eliminados\n‚Ä¢ Tendr√°s que volver a crear a tus mozos, chef, etc.\n\n¬øProceder con el BORRADO TOTAL?');
    
    if (!confirmar2) {
        console.log('‚ùå Reseteo cancelado en segunda confirmaci√≥n');
        return;
    }
    
    // RESETEAR USUARIOS
    console.log('üóëÔ∏è Iniciando reseteo total de usuarios...');
    
    // Crear solo el usuario Admin por defecto
    db.usuarios = [{
        id: 'admin',
        usuario: 'Admin',
        password: '1991',
        nombre: 'Administrador',
        rol: 'admin'
    }];
    
    // Guardar en localStorage
    save();
    
    // Limpiar formulario
    limpiarFormUsuario();
    
    // Actualizar vista
    renderUsuarios();
    
    // Mensaje de √©xito
    alert('‚úÖ RESETEO COMPLETADO\n\nTodos los usuarios han sido eliminados.\n\nUsuario disponible:\nüë§ Usuario: Admin\nüîí PIN: 1991\n\nAhora puedes crear nuevos usuarios desde cero.');
    
    console.log('‚úÖ Reseteo completado. Solo existe el usuario Admin.');
}

// ========== SISTEMA DE LOGS DE ACTIVIDAD ==========

// Variables globales para logs
var paginaLogsActual = 1;
var logsPorPagina = 50;
var logsFiltrados = [];

// Funci√≥n para registrar actividad
function registrarActividad(tipo, accion, detalles) {
    if (!db.logs) db.logs = [];
    
    var log = {
        id: Date.now().toString(),
        fecha: new Date().toISOString(),
        usuario: usuarioActual ? usuarioActual.nombre : 'Sistema',
        usuarioId: usuarioActual ? usuarioActual.id : 'sistema',
        rol: usuarioActual ? usuarioActual.rol : 'sistema',
        tipo: tipo, // login, platos, usuarios, materiales, ventas, configuracion, sistema
        accion: accion,
        detalles: detalles,
        ip: 'Local', // En aplicaci√≥n web real, se obtendr√≠a del servidor
        dispositivo: navigator.userAgent.substring(0, 50)
    };
    
    db.logs.push(log);
    
    // Limitar a √∫ltimos 10000 registros para no sobrecargar localStorage
    if (db.logs.length > 10000) {
        db.logs = db.logs.slice(-10000);
    }
    
    save();
    console.log('üìã Log registrado:', tipo, '-', accion);
}

// Renderizar logs
function renderLogs() {
    if (!db.logs) db.logs = [];
    
    var tbody = document.getElementById('logs-list');
    var empty = document.getElementById('logs-empty');
    
    // Aplicar filtros si existen
    var logs = logsFiltrados.length > 0 ? logsFiltrados : db.logs.slice().reverse();
    
    // Calcular estad√≠sticas
    actualizarEstadisticasLogs();
    
    if (logs.length === 0) {
        tbody.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }
    
    empty.classList.add('hidden');
    
    // Paginaci√≥n
    var inicio = (paginaLogsActual - 1) * logsPorPagina;
    var fin = inicio + logsPorPagina;
    var logsPagina = logs.slice(inicio, fin);
    
    var html = '';
    logsPagina.forEach(function(log) {
        var fecha = new Date(log.fecha);
        var fechaStr = fecha.toLocaleDateString('es-PE') + ' ' + fecha.toLocaleTimeString('es-PE');
        
        var colorTipo = {
            'login': 'bg-green-100 text-green-700',
            'platos': 'bg-blue-100 text-blue-700',
            'usuarios': 'bg-purple-100 text-purple-700',
            'materiales': 'bg-orange-100 text-orange-700',
            'ventas': 'bg-emerald-100 text-emerald-700',
            'configuracion': 'bg-slate-100 text-slate-700',
            'sistema': 'bg-red-100 text-red-700'
        };
        
        var badgeClass = colorTipo[log.tipo] || 'bg-gray-100 text-gray-700';
        
        html += '<tr class="hover:bg-slate-50">';
        html += '<td class="p-3 text-left font-mono text-xs">' + fechaStr + '</td>';
        html += '<td class="p-3 text-left"><span class="font-bold text-purple-600">' + log.usuario + '</span><br><span class="text-xs text-slate-400">' + log.rol + '</span></td>';
        html += '<td class="p-3 text-center"><span class="px-2 py-1 rounded-full text-xs font-bold ' + badgeClass + '">' + log.tipo.toUpperCase() + '</span></td>';
        html += '<td class="p-3 text-left font-bold">' + log.accion + '</td>';
        html += '<td class="p-3 text-left text-xs text-slate-600">' + (log.detalles || '-') + '</td>';
        html += '<td class="p-3 text-center text-xs text-slate-400">' + log.ip + '</td>';
        html += '</tr>';
    });
    
    tbody.innerHTML = html;
    
    // Actualizar info de paginaci√≥n
    document.getElementById('logs-showing').textContent = Math.min(fin, logs.length);
    document.getElementById('logs-total').textContent = logs.length;
    document.getElementById('logs-pagina').textContent = paginaLogsActual;
}

// Actualizar estad√≠sticas de logs
function actualizarEstadisticasLogs() {
    if (!db.logs) db.logs = [];
    
    var ahora = new Date();
    var hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
    var hace24h = new Date(ahora.getTime() - 24 * 60 * 60 * 1000);
    
    var logsHoy = db.logs.filter(function(l) {
        var fechaLog = new Date(l.fecha);
        return fechaLog >= hoy;
    });
    
    var logs24h = db.logs.filter(function(l) {
        var fechaLog = new Date(l.fecha);
        return fechaLog >= hace24h;
    });
    
    var usuariosUnicos = new Set(db.logs.map(function(l) { return l.usuarioId; }));
    
    document.getElementById('stats-total-logs').textContent = db.logs.length;
    document.getElementById('stats-logs-hoy').textContent = logsHoy.length;
    document.getElementById('stats-usuarios-activos').textContent = usuariosUnicos.size;
    document.getElementById('stats-logs-24h').textContent = logs24h.length;
}

// Poblar filtro de usuarios
function poblarFiltroUsuarios() {
    var select = document.getElementById('filter-usuario-log');
    var usuarios = db.usuarios || [];
    
    var html = '<option value="">üë§ Todos los usuarios</option>';
    usuarios.forEach(function(u) {
        html += '<option value="' + u.id + '">' + u.nombre + ' (' + u.rol + ')</option>';
    });
    
    select.innerHTML = html;
}

// Filtrar logs
function filtrarLogs() {
    if (!db.logs) db.logs = [];
    
    var usuarioId = document.getElementById('filter-usuario-log').value;
    var tipo = document.getElementById('filter-tipo-log').value;
    var fechaInicio = document.getElementById('filter-fecha-inicio-log').value;
    var fechaFin = document.getElementById('filter-fecha-fin-log').value;
    
    logsFiltrados = db.logs.filter(function(log) {
        // Filtro por usuario
        if (usuarioId && log.usuarioId !== usuarioId) return false;
        
        // Filtro por tipo
        if (tipo && log.tipo !== tipo) return false;
        
        // Filtro por fecha
        var fechaLog = new Date(log.fecha);
        if (fechaInicio) {
            var inicio = new Date(fechaInicio);
            if (fechaLog < inicio) return false;
        }
        if (fechaFin) {
            var fin = new Date(fechaFin);
            fin.setHours(23, 59, 59, 999);
            if (fechaLog > fin) return false;
        }
        
        return true;
    });
    
    paginaLogsActual = 1;
    renderLogs();
    
    console.log('üîç Filtros aplicados:', logsFiltrados.length, 'registros encontrados');
}

// Limpiar filtros
function limpiarFiltrosLogs() {
    document.getElementById('filter-usuario-log').value = '';
    document.getElementById('filter-tipo-log').value = '';
    document.getElementById('filter-fecha-inicio-log').value = '';
    document.getElementById('filter-fecha-fin-log').value = '';
    
    logsFiltrados = [];
    paginaLogsActual = 1;
    renderLogs();
}

// Cambiar p√°gina de logs
function cambiarPaginaLogs(direccion) {
    var logs = logsFiltrados.length > 0 ? logsFiltrados : db.logs;
    var totalPaginas = Math.ceil(logs.length / logsPorPagina);
    
    paginaLogsActual += direccion;
    
    if (paginaLogsActual < 1) paginaLogsActual = 1;
    if (paginaLogsActual > totalPaginas) paginaLogsActual = totalPaginas;
    
    renderLogs();
}

// Exportar logs a CSV
function exportarLogs() {
    if (!db.logs || db.logs.length === 0) {
        alert('‚ö†Ô∏è NO HAY LOGS PARA EXPORTAR');
        return;
    }
    
    var logs = logsFiltrados.length > 0 ? logsFiltrados : db.logs;
    
    var csv = 'Fecha/Hora,Usuario,Rol,Tipo,Accion,Detalles,IP,Dispositivo\n';
    
    logs.forEach(function(log) {
        var fecha = new Date(log.fecha);
        var fechaStr = fecha.toLocaleDateString('es-PE') + ' ' + fecha.toLocaleTimeString('es-PE');
        
        csv += '"' + fechaStr + '",';
        csv += '"' + log.usuario + '",';
        csv += '"' + log.rol + '",';
        csv += '"' + log.tipo + '",';
        csv += '"' + log.accion + '",';
        csv += '"' + (log.detalles || '') + '",';
        csv += '"' + log.ip + '",';
        csv += '"' + (log.dispositivo || '') + '"\n';
    });
    
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    var url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', 'logs_actividad_' + new Date().toISOString().split('T')[0] + '.csv');
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    registrarActividad('sistema', 'Exportaci√≥n de logs', 'Exportados ' + logs.length + ' registros');
    
    alert('‚úÖ LOGS EXPORTADOS\n\n' + logs.length + ' registros exportados a CSV');
}

// Confirmar limpieza de logs antiguos
function confirmarLimpiezaLogs() {
    var dias = prompt('¬øCu√°ntos d√≠as de historial deseas mantener?\n\nSe eliminar√°n todos los logs anteriores a esta fecha.\n\nRecomendado: 90 d√≠as', '90');
    
    if (!dias) return;
    
    var diasNum = parseInt(dias);
    if (isNaN(diasNum) || diasNum < 1) {
        alert('‚ùå N√∫mero de d√≠as inv√°lido');
        return;
    }
    
    var confirmar = confirm('‚ö†Ô∏è ADVERTENCIA\n\n¬øEst√°s seguro de eliminar todos los logs anteriores a ' + diasNum + ' d√≠as?\n\nEsta acci√≥n NO se puede deshacer.');
    
    if (!confirmar) return;
    
    limpiarLogsAntiguos(diasNum);
}

// Limpiar logs antiguos
function limpiarLogsAntiguos(dias) {
    if (!db.logs) db.logs = [];
    
    console.log('üóëÔ∏è Iniciando limpieza de logs...');
    console.log('üìä Total de logs antes:', db.logs.length);
    console.log('üìÖ D√≠as a mantener:', dias);
    
    var fechaLimite = new Date();
    fechaLimite.setDate(fechaLimite.getDate() - dias);
    
    console.log('üìÖ Fecha l√≠mite:', fechaLimite.toISOString());
    
    var cantidadAntes = db.logs.length;
    var logsEliminados = 0;
    var logsConservados = 0;
    var logsSinFecha = 0;
    
    // Filtrar logs manteniendo solo los recientes
    db.logs = db.logs.filter(function(log) {
        // Verificar si el log tiene fecha
        if (!log.fecha) {
            console.warn('‚ö†Ô∏è Log sin fecha encontrado:', log);
            logsSinFecha++;
            return false; // Eliminar logs sin fecha
        }
        
        // Convertir fecha del log
        var fechaLog = new Date(log.fecha);
        
        // Verificar si la fecha es v√°lida
        if (isNaN(fechaLog.getTime())) {
            console.warn('‚ö†Ô∏è Log con fecha inv√°lida:', log.fecha);
            logsSinFecha++;
            return false; // Eliminar logs con fecha inv√°lida
        }
        
        // Comparar fechas
        var mantener = fechaLog >= fechaLimite;
        
        if (mantener) {
            logsConservados++;
        } else {
            logsEliminados++;
            console.log('üóëÔ∏è Eliminando log:', log.fecha, '-', log.accion);
        }
        
        return mantener;
    });
    
    var totalEliminados = cantidadAntes - db.logs.length;
    
    console.log('üìä Resultados de limpieza:');
    console.log('  ‚úÖ Logs conservados:', logsConservados);
    console.log('  üóëÔ∏è Logs eliminados por antig√ºedad:', logsEliminados);
    console.log('  ‚ö†Ô∏è Logs eliminados sin fecha:', logsSinFecha);
    console.log('  üìä Total eliminados:', totalEliminados);
    console.log('  üìä Total final:', db.logs.length);
    
    // Guardar cambios
    save();
    
    // Actualizar vista
    renderLogs();
    
    // Registrar actividad
    registrarActividad('sistema', 'Limpieza de logs', 
        'Eliminados ' + totalEliminados + ' registros (>' + dias + ' d√≠as). ' +
        'Conservados: ' + logsConservados + ', Sin fecha: ' + logsSinFecha
    );
    
    // Mostrar resultado
    alert('‚úÖ LIMPIEZA COMPLETADA\n\n' + 
          'üóëÔ∏è Eliminados: ' + totalEliminados + ' registros\n' +
          '‚úÖ Conservados: ' + db.logs.length + ' registros\n\n' +
          (logsSinFecha > 0 ? '‚ö†Ô∏è Se eliminaron ' + logsSinFecha + ' logs sin fecha v√°lida\n' : '') +
          'üìÖ Se mantienen logs de los √∫ltimos ' + dias + ' d√≠as');
}

// ========== GESTI√ìN FINANCIERA ==========

// Variables globales para finanzas
var tabFinanzasActual = 'planilla';

// ========== TABS DE FINANZAS ==========
function mostrarTabFinanzas(tab) {
    // Ocultar todos los tabs
    var tabs = ['planilla', 'servicios', 'otros-egresos', 'otros-ingresos', 'tributario', 'cargas', 'reporte'];
    tabs.forEach(function(t) {
        var contentTab = document.getElementById('tab-content-' + t);
        if(contentTab) contentTab.classList.add('hidden');
        var btnTab = document.getElementById('tab-' + t);
        if(btnTab) {
            btnTab.classList.remove('border-purple-600', 'text-purple-600', 'border-cyan-600', 'text-cyan-600', 'border-red-600', 'text-red-600', 'border-green-600', 'text-green-600', 'border-blue-600', 'text-blue-600', 'border-orange-600', 'text-orange-600', 'border-teal-600', 'text-teal-600');
            btnTab.classList.add('border-transparent', 'text-slate-400');
        }
    });
    
    // Mostrar el tab seleccionado
    var contentTabActivo = document.getElementById('tab-content-' + tab);
    if(contentTabActivo) contentTabActivo.classList.remove('hidden');
    var btnTabActivo = document.getElementById('tab-' + tab);
    if(btnTabActivo) {
        btnTabActivo.classList.remove('border-transparent', 'text-slate-400');
        
        // Aplicar color seg√∫n tab
        if (tab === 'planilla') {
            btnTabActivo.classList.add('border-purple-600', 'text-purple-600');
        } else if (tab === 'servicios') {
            btnTabActivo.classList.add('border-cyan-600', 'text-cyan-600');
        } else if (tab === 'otros-egresos') {
            btnTabActivo.classList.add('border-red-600', 'text-red-600');
        } else if (tab === 'otros-ingresos') {
            btnTabActivo.classList.add('border-green-600', 'text-green-600');
        } else if (tab === 'tributario') {
            btnTabActivo.classList.add('border-orange-600', 'text-orange-600');
        } else if (tab === 'cargas') {
            btnTabActivo.classList.add('border-teal-600', 'text-teal-600');
        } else if (tab === 'reporte') {
            btnTabActivo.classList.add('border-blue-600', 'text-blue-600');
        }
    }
    
    // Renderizar contenido seg√∫n tab
    if(tab === 'tributario') {
        renderTributarios();
        calcularResumenTributario();
    } else if(tab === 'cargas') {
        updateCargasEmpleadosDropdown();
        renderCargasLaborales();
        calcularResumenCargas();
    }
    
    tabFinanzasActual = tab;
}

// ========== GESTI√ìN DE EMPLEADOS ==========

// Mostrar/ocultar selector de AFP espec√≠fica
function toggleAfpSelector() {
    var sistemaPensionario = document.getElementById('emp-sistema-pensionario').value;
    var contenedor = document.getElementById('contenedor-afp-especifica');
    
    if (sistemaPensionario === 'AFP') {
        contenedor.classList.remove('hidden');
    } else {
        contenedor.classList.add('hidden');
        // Limpiar campos de AFP
        document.getElementById('emp-afp-especifica').value = '';
        document.getElementById('emp-afp-porcentaje').value = '';
    }
}

// Funci√≥n para editar empleado (cargar datos en formulario)
function editarEmpleado(id) {
    var emp = db.empleados.find(function(e) { return e.id === id; });
    
    if (!emp) {
        alert('‚ö†Ô∏è Empleado no encontrado');
        return;
    }
    
    // Cargar datos en formulario
    document.getElementById('emp-id-edit').value = emp.id;
    document.getElementById('emp-nombre').value = emp.nombre;
    document.getElementById('emp-cargo').value = emp.cargo;
    document.getElementById('emp-sueldo').value = emp.sueldo;
    document.getElementById('emp-sistema-pensionario').value = emp.sistemaPensionario || '';
    document.getElementById('emp-fecha-ingreso').value = emp.fechaIngreso;
    
    // Si tiene AFP espec√≠fica, mostrar y cargar datos
    if (emp.sistemaPensionario === 'AFP') {
        document.getElementById('contenedor-afp-especifica').classList.remove('hidden');
        document.getElementById('emp-afp-especifica').value = emp.afpEspecifica || '';
        document.getElementById('emp-afp-porcentaje').value = emp.afpPorcentaje || '';
    }
    
    // Cambiar t√≠tulo y bot√≥n
    document.getElementById('titulo-form-empleado').innerHTML = '‚úèÔ∏è EDITAR EMPLEADO';
    document.getElementById('btn-guardar-empleado').innerHTML = '‚úÖ ACTUALIZAR';
    document.getElementById('btn-guardar-empleado').className = 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-6 py-3 rounded-xl font-bold btn-action';
    
    // Scroll al formulario
    document.getElementById('titulo-form-empleado').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Funci√≥n unificada para guardar (agregar o actualizar)
function guardarEmpleado() {
    var idEdit = document.getElementById('emp-id-edit').value;
    
    if (idEdit) {
        // Modo edici√≥n
        actualizarEmpleado(idEdit);
    } else {
        // Modo agregar nuevo
        agregarEmpleado();
    }
}

function agregarEmpleado() {
    var nombre = document.getElementById('emp-nombre').value.trim();
    var cargo = document.getElementById('emp-cargo').value.trim();
    var sueldo = parseFloat(document.getElementById('emp-sueldo').value) || 0;
    var sistemaPensionario = document.getElementById('emp-sistema-pensionario').value;
    var fechaIngreso = document.getElementById('emp-fecha-ingreso').value;
    
    if (!nombre || !cargo || sueldo <= 0 || !sistemaPensionario || !fechaIngreso) {
        alert('‚ö†Ô∏è Completa todos los campos correctamente');
        return;
    }
    
    // Validar AFP espec√≠fica si es AFP
    var afpEspecifica = null;
    var afpPorcentaje = null;
    
    if (sistemaPensionario === 'AFP') {
        afpEspecifica = document.getElementById('emp-afp-especifica').value;
        afpPorcentaje = parseFloat(document.getElementById('emp-afp-porcentaje').value) || 0;
        
        if (!afpEspecifica || afpPorcentaje <= 0) {
            alert('‚ö†Ô∏è Debes seleccionar la AFP espec√≠fica y su porcentaje de aporte');
            return;
        }
    }
    
    var empleado = {
        id: Date.now().toString(),
        nombre: nombre,
        cargo: cargo,
        sueldo: sueldo,
        sistemaPensionario: sistemaPensionario,
        afpEspecifica: afpEspecifica,
        afpPorcentaje: afpPorcentaje,
        fechaIngreso: fechaIngreso,
        activo: true
    };
    
    db.empleados.push(empleado);
    save();
    limpiarFormEmpleado();
    renderEmpleados();
    calcularFinanzas();
    alert('‚úÖ Empleado agregado correctamente');
}

function actualizarEmpleado(id) {
    var nombre = document.getElementById('emp-nombre').value.trim();
    var cargo = document.getElementById('emp-cargo').value.trim();
    var sueldo = parseFloat(document.getElementById('emp-sueldo').value) || 0;
    var sistemaPensionario = document.getElementById('emp-sistema-pensionario').value;
    var fechaIngreso = document.getElementById('emp-fecha-ingreso').value;
    
    if (!nombre || !cargo || sueldo <= 0 || !sistemaPensionario || !fechaIngreso) {
        alert('‚ö†Ô∏è Completa todos los campos correctamente');
        return;
    }
    
    // Validar AFP espec√≠fica si es AFP
    var afpEspecifica = null;
    var afpPorcentaje = null;
    
    if (sistemaPensionario === 'AFP') {
        afpEspecifica = document.getElementById('emp-afp-especifica').value;
        afpPorcentaje = parseFloat(document.getElementById('emp-afp-porcentaje').value) || 0;
        
        if (!afpEspecifica || afpPorcentaje <= 0) {
            alert('‚ö†Ô∏è Debes seleccionar la AFP espec√≠fica y su porcentaje de aporte');
            return;
        }
    }
    
    // Buscar y actualizar empleado
    var emp = db.empleados.find(function(e) { return e.id === id; });
    
    if (!emp) {
        alert('‚ö†Ô∏è Empleado no encontrado');
        return;
    }
    
    emp.nombre = nombre;
    emp.cargo = cargo;
    emp.sueldo = sueldo;
    emp.sistemaPensionario = sistemaPensionario;
    emp.afpEspecifica = afpEspecifica;
    emp.afpPorcentaje = afpPorcentaje;
    emp.fechaIngreso = fechaIngreso;
    
    save();
    limpiarFormEmpleado();
    renderEmpleados();
    calcularFinanzas();
    alert('‚úÖ Empleado actualizado correctamente');
}

function limpiarFormEmpleado() {
    document.getElementById('emp-id-edit').value = '';
    document.getElementById('emp-nombre').value = '';
    document.getElementById('emp-cargo').value = '';
    document.getElementById('emp-sueldo').value = '';
    document.getElementById('emp-sistema-pensionario').value = '';
    document.getElementById('emp-fecha-ingreso').value = '';
    document.getElementById('emp-afp-especifica').value = '';
    document.getElementById('emp-afp-porcentaje').value = '';
    document.getElementById('contenedor-afp-especifica').classList.add('hidden');
    
    // Restaurar t√≠tulo y bot√≥n
    document.getElementById('titulo-form-empleado').innerHTML = '‚ûï AGREGAR EMPLEADO A PLANILLA';
    document.getElementById('btn-guardar-empleado').innerHTML = 'üíæ GUARDAR';
    document.getElementById('btn-guardar-empleado').className = 'bg-gradient-to-r from-purple-600 to-violet-600 text-white px-6 py-3 rounded-xl font-bold btn-action';
}

function toggleEmpleado(id) {
    var emp = db.empleados.find(function(e) { return e.id === id; });
    if (emp) {
        emp.activo = !emp.activo;
        save();
        renderEmpleados();
        calcularFinanzas();
    }
}

function eliminarEmpleado(id) {
    if (confirm('¬øEliminar empleado de la planilla?')) {
        db.empleados = db.empleados.filter(function(e) { return e.id !== id; });
        save();
        renderEmpleados();
        calcularFinanzas();
    }
}

function renderEmpleados() {
    var html = '';
    var totalBruto = 0;
    var totalNeto = 0;
    var totalDescuentos = 0;
    var empleadosActivos = 0;
    
    db.empleados.forEach(function(emp) {
        var estadoBadge = emp.activo 
            ? '<span class="badge bg-green-100 text-green-700">ACTIVO</span>'
            : '<span class="badge bg-red-100 text-red-700">INACTIVO</span>';
        
        var sistemaBadge = '';
        var descuentoPorcentaje = 0;
        
        if (emp.sistemaPensionario === 'ONP') {
            sistemaBadge = '<span class="badge bg-purple-100 text-purple-700">üèõÔ∏è ONP 13%</span>';
            descuentoPorcentaje = 0.13;
        } else if (emp.sistemaPensionario === 'AFP') {
            // Usar el porcentaje espec√≠fico de la AFP o 12.5% por defecto
            descuentoPorcentaje = (emp.afpPorcentaje || 12.5) / 100;
            
            // Mostrar AFP espec√≠fica si existe
            if (emp.afpEspecifica) {
                var nombreAfp = emp.afpEspecifica;
                var porcentajeAfp = emp.afpPorcentaje || 12.5;
                sistemaBadge = '<span class="badge bg-blue-100 text-blue-700">üí∞ ' + nombreAfp + ' ' + porcentajeAfp.toFixed(2) + '%</span>';
            } else {
                sistemaBadge = '<span class="badge bg-blue-100 text-blue-700">üí∞ AFP 12.5%</span>';
            }
        } else {
            sistemaBadge = '<span class="badge bg-slate-100 text-slate-500">-</span>';
        }
        
        // Calcular sueldo neto
        var descuento = emp.sueldo * descuentoPorcentaje;
        var sueldoNeto = emp.sueldo - descuento;
        
        // Acumular totales solo de empleados activos
        if (emp.activo) {
            empleadosActivos++;
            totalBruto += emp.sueldo;
            totalNeto += sueldoNeto;
            totalDescuentos += descuento;
        }
        
        html += '<tr class="hover:bg-purple-50">';
        html += '<td class="p-4 font-bold text-slate-700">' + emp.nombre + '</td>';
        html += '<td class="p-4 text-slate-600">' + emp.cargo + '</td>';
        html += '<td class="p-4 text-right font-bold text-slate-600">S/. ' + emp.sueldo.toFixed(2) + '</td>';
        html += '<td class="p-4 text-center">' + sistemaBadge + '</td>';
        
        // Columna de sueldo neto con tooltip
        if (emp.sistemaPensionario) {
            html += '<td class="p-4 text-right">';
            html += '<div class="inline-block">';
            html += '<p class="text-lg font-black text-green-600">S/. ' + sueldoNeto.toFixed(2) + '</p>';
            html += '<p class="text-xs text-slate-500">(-S/. ' + descuento.toFixed(2) + ')</p>';
            html += '</div>';
            html += '</td>';
        } else {
            html += '<td class="p-4 text-right">';
            html += '<p class="text-lg font-black text-slate-400">-</p>';
            html += '<p class="text-xs text-slate-400">Sin sistema</p>';
            html += '</td>';
        }
        
        html += '<td class="p-4 text-center text-sm text-slate-600">' + emp.fechaIngreso + '</td>';
        html += '<td class="p-4 text-center">' + estadoBadge + '</td>';
        html += '<td class="p-4 text-right">';
        html += '<button onclick="editarEmpleado(\'' + emp.id + '\')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-xs font-bold mr-2">';
        html += '‚úèÔ∏è EDITAR';
        html += '</button>';
        html += '<button onclick="toggleEmpleado(\'' + emp.id + '\')" class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-lg text-xs font-bold mr-2">';
        html += emp.activo ? '‚è∏Ô∏è PAUSAR' : '‚ñ∂Ô∏è ACTIVAR';
        html += '</button>';
        html += '<button onclick="eliminarEmpleado(\'' + emp.id + '\')" class="bg-red-100 text-red-700 px-3 py-1 rounded-lg text-xs font-bold">';
        html += 'üóëÔ∏è ELIMINAR';
        html += '</button>';
        html += '</td>';
        html += '</tr>';
    });
    
    document.getElementById('lista-empleados').innerHTML = html || '<tr><td colspan="8" class="p-8 text-center text-slate-400">No hay empleados registrados</td></tr>';
    
    // Actualizar resumen de planilla
    var resumenDiv = document.getElementById('resumen-planilla');
    if (resumenDiv) {
        if (db.empleados.length > 0) {
            resumenDiv.classList.remove('hidden');
            
            var elemActivos = document.getElementById('total-empleados-activos');
            var elemBruto = document.getElementById('total-sueldo-bruto');
            var elemNeto = document.getElementById('total-sueldo-neto');
            var elemDescuentos = document.getElementById('total-descuentos');
            
            if (elemActivos) elemActivos.textContent = empleadosActivos;
            if (elemBruto) elemBruto.textContent = 'S/. ' + totalBruto.toFixed(2);
            if (elemNeto) elemNeto.textContent = 'S/. ' + totalNeto.toFixed(2);
            if (elemDescuentos) elemDescuentos.textContent = 'S/. ' + totalDescuentos.toFixed(2);
        } else {
            resumenDiv.classList.add('hidden');
        }
    }
}

// ========== GESTI√ìN DE SERVICIOS ==========
function agregarServicio() {
    var tipo = document.getElementById('servicio-tipo').value;
    var descripcion = document.getElementById('servicio-descripcion').value.trim();
    var monto = parseFloat(document.getElementById('servicio-monto').value) || 0;
    var fecha = document.getElementById('servicio-fecha').value;
    
    if (!tipo || !descripcion || monto <= 0 || !fecha) {
        alert('‚ö†Ô∏è Completa todos los campos correctamente');
        return;
    }
    
    var servicio = {
        id: Date.now().toString(),
        tipo: tipo,
        descripcion: descripcion,
        monto: monto,
        fecha: fecha
    };
    
    db.servicios.push(servicio);
    save();
    limpiarFormServicio();
    renderServicios();
    calcularFinanzas();
    alert('‚úÖ Servicio registrado correctamente');
}

function limpiarFormServicio() {
    document.getElementById('servicio-tipo').value = '';
    document.getElementById('servicio-descripcion').value = '';
    document.getElementById('servicio-monto').value = '';
    document.getElementById('servicio-fecha').value = '';
}

function eliminarServicio(id) {
    if (confirm('¬øEliminar este registro de servicio?')) {
        db.servicios = db.servicios.filter(function(s) { return s.id !== id; });
        save();
        renderServicios();
        calcularFinanzas();
    }
}

function renderServicios() {
    var html = '';
    db.servicios.forEach(function(serv) {
        var iconos = {
            'LUZ': '‚ö°',
            'AGUA': 'üíß',
            'INTERNET': 'üåê',
            'ALQUILER': 'üè†',
            'GAS': 'üî•',
            'TELEFONO': 'üìû',
            'LIMPIEZA': 'üßπ',
            'SEGURIDAD': 'üîí',
            'OTROS': 'üìå'
        };
        
        html += '<tr class="hover:bg-cyan-50">';
        html += '<td class="p-4 font-bold text-slate-700">' + iconos[serv.tipo] + ' ' + serv.tipo + '</td>';
        html += '<td class="p-4 text-slate-600">' + serv.descripcion + '</td>';
        html += '<td class="p-4 text-right font-bold text-cyan-700">' + serv.monto.toFixed(2) + '</td>';
        html += '<td class="p-4 text-center text-sm text-slate-600">' + serv.fecha + '</td>';
        html += '<td class="p-4 text-right">';
        html += '<button onclick="eliminarServicio(\'' + serv.id + '\')" class="bg-red-100 text-red-700 px-3 py-1 rounded-lg text-xs font-bold">';
        html += 'üóëÔ∏è ELIMINAR';
        html += '</button>';
        html += '</td>';
        html += '</tr>';
    });
    
    document.getElementById('lista-servicios').innerHTML = html || '<tr><td colspan="5" class="p-8 text-center text-slate-400">No hay servicios registrados</td></tr>';
}

// ========== GESTI√ìN DE OTROS EGRESOS ==========
function agregarOtroEgreso() {
    var concepto = document.getElementById('egreso-concepto').value.trim();
    var monto = parseFloat(document.getElementById('egreso-monto').value) || 0;
    var fecha = document.getElementById('egreso-fecha').value;
    
    if (!concepto || monto <= 0 || !fecha) {
        alert('‚ö†Ô∏è Completa todos los campos correctamente');
        return;
    }
    
    var egreso = {
        id: Date.now().toString(),
        concepto: concepto,
        monto: monto,
        fecha: fecha
    };
    
    db.otrosEgresos.push(egreso);
    save();
    limpiarFormEgreso();
    renderOtrosEgresos();
    calcularFinanzas();
    alert('‚úÖ Egreso registrado correctamente');
}

function limpiarFormEgreso() {
    document.getElementById('egreso-concepto').value = '';
    document.getElementById('egreso-monto').value = '';
    document.getElementById('egreso-fecha').value = '';
}

function eliminarOtroEgreso(id) {
    if (confirm('¬øEliminar este egreso?')) {
        db.otrosEgresos = db.otrosEgresos.filter(function(e) { return e.id !== id; });
        save();
        renderOtrosEgresos();
        calcularFinanzas();
    }
}

function renderOtrosEgresos() {
    var html = '';
    db.otrosEgresos.forEach(function(egreso) {
        html += '<tr class="hover:bg-red-50">';
        html += '<td class="p-4 font-bold text-slate-700">' + egreso.concepto + '</td>';
        html += '<td class="p-4 text-right font-bold text-red-700">' + egreso.monto.toFixed(2) + '</td>';
        html += '<td class="p-4 text-center text-sm text-slate-600">' + egreso.fecha + '</td>';
        html += '<td class="p-4 text-right">';
        html += '<button onclick="eliminarOtroEgreso(\'' + egreso.id + '\')" class="bg-red-100 text-red-700 px-3 py-1 rounded-lg text-xs font-bold">';
        html += 'üóëÔ∏è ELIMINAR';
        html += '</button>';
        html += '</td>';
        html += '</tr>';
    });
    
    document.getElementById('lista-otros-egresos').innerHTML = html || '<tr><td colspan="4" class="p-8 text-center text-slate-400">No hay egresos registrados</td></tr>';
}

// ========== GESTI√ìN DE OTROS INGRESOS ==========
function agregarOtroIngreso() {
    var concepto = document.getElementById('ingreso-concepto').value.trim();
    var monto = parseFloat(document.getElementById('ingreso-monto').value) || 0;
    var fecha = document.getElementById('ingreso-fecha').value;
    
    if (!concepto || monto <= 0 || !fecha) {
        alert('‚ö†Ô∏è Completa todos los campos correctamente');
        return;
    }
    
    var ingreso = {
        id: Date.now().toString(),
        concepto: concepto,
        monto: monto,
        fecha: fecha
    };
    
    db.otrosIngresos.push(ingreso);
    save();
    limpiarFormIngreso();
    renderOtrosIngresos();
    calcularFinanzas();
    alert('‚úÖ Ingreso registrado correctamente');
}

function limpiarFormIngreso() {
    document.getElementById('ingreso-concepto').value = '';
    document.getElementById('ingreso-monto').value = '';
    document.getElementById('ingreso-fecha').value = '';
}

function eliminarOtroIngreso(id) {
    if (confirm('¬øEliminar este ingreso?')) {
        db.otrosIngresos = db.otrosIngresos.filter(function(i) { return i.id !== id; });
        save();
        renderOtrosIngresos();
        calcularFinanzas();
    }
}

function renderOtrosIngresos() {
    var html = '';
    db.otrosIngresos.forEach(function(ingreso) {
        html += '<tr class="hover:bg-green-50">';
        html += '<td class="p-4 font-bold text-slate-700">' + ingreso.concepto + '</td>';
        html += '<td class="p-4 text-right font-bold text-green-700">' + ingreso.monto.toFixed(2) + '</td>';
        html += '<td class="p-4 text-center text-sm text-slate-600">' + ingreso.fecha + '</td>';
        html += '<td class="p-4 text-right">';
        html += '<button onclick="eliminarOtroIngreso(\'' + ingreso.id + '\')" class="bg-red-100 text-red-700 px-3 py-1 rounded-lg text-xs font-bold">';
        html += 'üóëÔ∏è ELIMINAR';
        html += '</button>';
        html += '</td>';
        html += '</tr>';
    });
    
    document.getElementById('lista-otros-ingresos').innerHTML = html || '<tr><td colspan="4" class="p-8 text-center text-slate-400">No hay ingresos registrados</td></tr>';
}

// ========== C√ÅLCULO DE FINANZAS ==========
function setFinanzasMesActual() {
    var hoy = new Date();
    var primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    var ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
    
    document.getElementById('finanzas-fecha-inicio').value = primerDia.toISOString().split('T')[0];
    document.getElementById('finanzas-fecha-fin').value = ultimoDia.toISOString().split('T')[0];
    
    calcularFinanzas();
}

function calcularFinanzas() {
    var fechaInicio = document.getElementById('finanzas-fecha-inicio').value;
    var fechaFin = document.getElementById('finanzas-fecha-fin').value;
    
    if (!fechaInicio || !fechaFin) {
        // Si no hay fechas, usar mes actual por defecto
        setFinanzasMesActual();
        return;
    }
    
    var inicio = new Date(fechaInicio);
    var fin = new Date(fechaFin);
    
    // CALCULAR INGRESOS
    var ingresosVentas = 0;
    var costoVentas = 0;
    
    // ‚úÖ MIGRAR ventas antiguas a historialVentas si es necesario
    if (!db.historialVentas) db.historialVentas = [];
    if (db.historialVentas.length === 0 && db.ventas && db.ventas.length > 0) {
        // Copiar ventas existentes al historial
        db.historialVentas = db.ventas.slice();
        save();
    }
    
    // Obtener ventas del per√≠odo desde TODAS las fuentes
    var todasLasVentas = [];
    
    // Agregar de historialVentas
    if (db.historialVentas) {
        todasLasVentas = todasLasVentas.concat(db.historialVentas);
    }
    
    // Agregar de ventas (por compatibilidad con datos antiguos)
    if (db.ventas) {
        db.ventas.forEach(function(v) {
            // Solo agregar si no est√° ya en historialVentas
            var existe = todasLasVentas.find(function(tv) { return tv.id === v.id; });
            if (!existe) {
                todasLasVentas.push(v);
            }
        });
    }
    
    // Calcular ingresos y costos de TODAS las ventas
    console.log('üìä AN√ÅLISIS DETALLADO DE VENTAS:');
    console.log('Total ventas a procesar:', todasLasVentas.length);
    console.log('Ventas de historialVentas:', db.historialVentas ? db.historialVentas.length : 0);
    console.log('Ventas de db.ventas:', db.ventas ? db.ventas.length : 0);
    
    var ventasEnPeriodo = [];
    todasLasVentas.forEach(function(venta) {
        var fechaVenta = new Date(venta.fecha);
        if (fechaVenta >= inicio && fechaVenta <= fin) {
            ingresosVentas += venta.total;
            ventasEnPeriodo.push({
                id: venta.id,
                fecha: venta.fecha,
                total: venta.total
            });
            // Calcular costo de venta (suma de costos de receta de cada plato)
            if (venta.items && venta.items.length > 0) {
                venta.items.forEach(function(item) {
                    var plato = db.platos.find(function(p) { return p.sku === item.sku; });
                    if (plato && plato.costoReceta) {
                        costoVentas += plato.costoReceta * item.cantidad;
                    }
                });
            }
        }
    });
    
    console.log('Ventas en per√≠odo encontradas:', ventasEnPeriodo.length);
    console.log('Total ventas POS calculado:', ingresosVentas.toFixed(2));
    if (ventasEnPeriodo.length > 0) {
        console.log('Primeras 5 ventas:');
        ventasEnPeriodo.slice(0, 5).forEach(function(v) {
            console.log('  - ID:', v.id, '| Fecha:', v.fecha, '| Total:', v.total);
        });
    }
    
    // Otros ingresos
    var otrosIngresos = 0;
    db.otrosIngresos.forEach(function(ing) {
        var fecha = new Date(ing.fecha);
        if (fecha >= inicio && fecha <= fin) {
            otrosIngresos += parseFloat(ing.monto) || 0;
        }
    });
    
    var totalIngresos = Number(ingresosVentas) + Number(otrosIngresos);
    
    // CALCULAR EGRESOS
    
    // Planilla (solo empleados activos)
    var egresoPlanilla = 0;
    var diasPeriodo = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
    var factorPlanilla = diasPeriodo / 30; // Proporci√≥n del mes
    
    db.empleados.forEach(function(emp) {
        if (emp.activo) {
            var fechaIngreso = new Date(emp.fechaIngreso);
            if (fechaIngreso <= fin) {
                egresoPlanilla += (parseFloat(emp.sueldo) || 0) * factorPlanilla;
            }
        }
    });
    
    // Servicios
    var egresoServicios = 0;
    var serviciosDelPeriodo = []; // ‚úÖ NUEVO: Guardar servicios individuales
    
    console.log('üîå DEBUG SERVICIOS - Total servicios en DB:', db.servicios.length);
    
    db.servicios.forEach(function(serv) {
        var fecha = new Date(serv.fecha);
        if (fecha >= inicio && fecha <= fin) {
            console.log('üîå Servicio en per√≠odo:', serv);
            
            var monto = parseFloat(serv.monto) || 0;
            egresoServicios += monto;
            
            // ‚úÖ Construir nombre del servicio
            var nombreServicio = '';
            if (serv.tipo) {
                // Formatear tipo (LUZ ‚Üí Luz)
                nombreServicio = serv.tipo.charAt(0).toUpperCase() + serv.tipo.slice(1).toLowerCase();
            }
            
            // Si hay descripci√≥n, agregarla
            if (serv.descripcion && serv.descripcion.trim()) {
                if (nombreServicio) {
                    nombreServicio += ' - ' + serv.descripcion;
                } else {
                    nombreServicio = serv.descripcion;
                }
            }
            
            // Si a√∫n no hay nombre, usar 'Servicio'
            if (!nombreServicio) {
                nombreServicio = 'Servicio';
            }
            
            console.log('üîå Nombre construido:', nombreServicio, 'Monto:', monto);
            
            serviciosDelPeriodo.push({
                nombre: nombreServicio,
                monto: monto
            });
        }
    });
    
    console.log('üîå Total servicios del per√≠odo:', serviciosDelPeriodo.length);
    console.log('üîå Servicios array:', serviciosDelPeriodo);
    
    // Otros egresos
    var egresoOtros = 0;
    db.otrosEgresos.forEach(function(eg) {
        var fecha = new Date(eg.fecha);
        if (fecha >= inicio && fecha <= fin) {
            egresoOtros += parseFloat(eg.monto) || 0;
        }
    });
    
    // Tributarios (IGV, Renta)
    var egresoTributario = 0;
    if(db.tributarios) {
        db.tributarios.forEach(function(trib) {
            var fecha = new Date(trib.fecha);
            if (fecha >= inicio && fecha <= fin) {
                egresoTributario += parseFloat(trib.monto) || 0;
            }
        });
    }
    
    // Cargas Laborales (Essalud, AFP, ONP)
    var egresoCargas = 0;
    if(db.cargasLaborales) {
        db.cargasLaborales.forEach(function(carga) {
            var fecha = new Date(carga.fecha);
            if (fecha >= inicio && fecha <= fin) {
                egresoCargas += parseFloat(carga.monto) || 0;
            }
        });
    }
    
    var totalEgresos = Number(costoVentas) + Number(egresoPlanilla) + Number(egresoServicios) + Number(egresoOtros) + Number(egresoTributario) + Number(egresoCargas);
    
    // CALCULAR RENTABILIDAD
    var utilidadBruta = Number(ingresosVentas) - Number(costoVentas);
    var utilidadNeta = Number(totalIngresos) - Number(totalEgresos);
    
    // ‚úÖ DEBUG: Mostrar informaci√≥n de c√°lculo
    console.log('=== C√ÅLCULO FINANCIERO ===');
    console.log('Per√≠odo:', fechaInicio, 'a', fechaFin);
    console.log('Total ventas procesadas:', todasLasVentas.length);
    console.log('Ventas en per√≠odo:', todasLasVentas.filter(function(v) {
        var fv = new Date(v.fecha);
        return fv >= inicio && fv <= fin;
    }).length);
    console.log('Ingresos por ventas:', ingresosVentas.toFixed(2));
    console.log('Costo de ventas:', costoVentas.toFixed(2));
    console.log('Otros ingresos:', otrosIngresos.toFixed(2));
    console.log('Total ingresos:', totalIngresos.toFixed(2));
    console.log('Total egresos:', totalEgresos.toFixed(2));
    console.log('Utilidad neta:', utilidadNeta.toFixed(2));
    console.log('========================');
    
    // ACTUALIZAR DASHBOARD
    document.getElementById('total-ingresos').textContent = 'S/. ' + totalIngresos.toFixed(2);
    document.getElementById('total-egresos').textContent = 'S/. ' + totalEgresos.toFixed(2);
    document.getElementById('utilidad-bruta').textContent = 'S/. ' + utilidadBruta.toFixed(2);
    document.getElementById('utilidad-neta').textContent = 'S/. ' + utilidadNeta.toFixed(2);
    
    // ACTUALIZAR DESGLOSE DE INGRESOS
    document.getElementById('desglose-ventas-pos').textContent = 'S/. ' + ingresosVentas.toFixed(2);
    document.getElementById('desglose-otros-ingresos').textContent = 'S/. ' + otrosIngresos.toFixed(2);
    
    // Cambiar color seg√∫n utilidad
    var elementoNeta = document.getElementById('utilidad-neta');
    if (utilidadNeta > 0) {
        elementoNeta.classList.remove('text-red-700');
        elementoNeta.classList.add('text-purple-700');
    } else {
        elementoNeta.classList.remove('text-purple-700');
        elementoNeta.classList.add('text-red-700');
    }
    
    // ACTUALIZAR REPORTES
    actualizarDesglose(ingresosVentas, otrosIngresos, costoVentas, egresoPlanilla, serviciosDelPeriodo, egresoOtros, egresoTributario, egresoCargas);
    actualizarEstadoResultados(ingresosVentas, otrosIngresos, costoVentas, egresoPlanilla, serviciosDelPeriodo, egresoOtros, egresoTributario, egresoCargas);
}

function actualizarDesglose(ingresosVentas, otrosIngresos, costoVentas, planilla, serviciosArray, otros, tributario, cargas) {
    // Desglose de ingresos
    var htmlIngresos = '';
    htmlIngresos += '<div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">';
    htmlIngresos += '<span class="font-bold text-sm text-slate-700">üõí Ventas del POS</span>';
    htmlIngresos += '<span class="font-black text-green-700">S/. ' + ingresosVentas.toFixed(2) + '</span>';
    htmlIngresos += '</div>';
    
    htmlIngresos += '<div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">';
    htmlIngresos += '<span class="font-bold text-sm text-slate-700">üíµ Otros Ingresos</span>';
    htmlIngresos += '<span class="font-black text-green-700">S/. ' + otrosIngresos.toFixed(2) + '</span>';
    htmlIngresos += '</div>';
    
    htmlIngresos += '<div class="flex justify-between items-center p-3 bg-green-100 rounded-lg border-2 border-green-300">';
    htmlIngresos += '<span class="font-black text-sm text-slate-700">TOTAL INGRESOS</span>';
    htmlIngresos += '<span class="font-black text-green-700 text-lg">S/. ' + (Number(ingresosVentas) + Number(otrosIngresos)).toFixed(2) + '</span>';
    htmlIngresos += '</div>';
    
    document.getElementById('desglose-ingresos').innerHTML = htmlIngresos;
    
    // ‚úÖ CALCULAR TOTAL DE SERVICIOS
    var totalServicios = 0;
    if(Array.isArray(serviciosArray)) {
        serviciosArray.forEach(function(s) {
            totalServicios += Number(s.monto) || 0;
        });
    }
    
    // Desglose de egresos
    var htmlEgresos = '';
    htmlEgresos += '<div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">';
    htmlEgresos += '<span class="font-bold text-sm text-slate-700">üçΩÔ∏è Costo de Ventas</span>';
    htmlEgresos += '<span class="font-black text-red-700">S/. ' + costoVentas.toFixed(2) + '</span>';
    htmlEgresos += '</div>';
    
    htmlEgresos += '<div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">';
    htmlEgresos += '<span class="font-bold text-sm text-slate-700">üë• Planilla</span>';
    htmlEgresos += '<span class="font-black text-red-700">S/. ' + planilla.toFixed(2) + '</span>';
    htmlEgresos += '</div>';
    
    // ‚úÖ MOSTRAR SERVICIOS DESGLOSADOS
    if(Array.isArray(serviciosArray) && serviciosArray.length > 0) {
        serviciosArray.forEach(function(servicio) {
            var nombreDisplay = servicio.nombre || 'Servicio';
            var montoDisplay = (servicio.monto || 0).toFixed(2);
            
            htmlEgresos += '<div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">';
            htmlEgresos += '<span class="font-bold text-sm text-slate-700">üîå ' + nombreDisplay + '</span>';
            htmlEgresos += '<span class="font-black text-blue-700">S/. ' + montoDisplay + '</span>';
            htmlEgresos += '</div>';
        });
    } else {
        htmlEgresos += '<div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">';
        htmlEgresos += '<span class="font-bold text-sm text-slate-700">üîå Servicios</span>';
        htmlEgresos += '<span class="font-black text-red-700">S/. 0.00</span>';
        htmlEgresos += '</div>';
    }
    
    htmlEgresos += '<div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">';
    htmlEgresos += '<span class="font-bold text-sm text-slate-700">üí∏ Otros Egresos</span>';
    htmlEgresos += '<span class="font-black text-red-700">S/. ' + otros.toFixed(2) + '</span>';
    htmlEgresos += '</div>';
    
    if(tributario > 0) {
        htmlEgresos += '<div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">';
        htmlEgresos += '<span class="font-bold text-sm text-slate-700">üìã Tributario</span>';
        htmlEgresos += '<span class="font-black text-orange-700">S/. ' + tributario.toFixed(2) + '</span>';
        htmlEgresos += '</div>';
    }
    
    if(cargas > 0) {
        htmlEgresos += '<div class="flex justify-between items-center p-3 bg-teal-50 rounded-lg">';
        htmlEgresos += '<span class="font-bold text-sm text-slate-700">üë∑ Cargas Laborales</span>';
        htmlEgresos += '<span class="font-black text-teal-700">S/. ' + cargas.toFixed(2) + '</span>';
        htmlEgresos += '</div>';
    }
    
    htmlEgresos += '<div class="flex justify-between items-center p-3 bg-red-100 rounded-lg border-2 border-red-300">';
    htmlEgresos += '<span class="font-black text-sm text-slate-700">TOTAL EGRESOS</span>';
    htmlEgresos += '<span class="font-black text-red-700 text-lg">S/. ' + (Number(costoVentas) + Number(planilla) + Number(totalServicios) + Number(otros) + Number(tributario || 0) + Number(cargas || 0)).toFixed(2) + '</span>';
    htmlEgresos += '</div>';
    
    document.getElementById('desglose-egresos').innerHTML = htmlEgresos;
}

function actualizarEstadoResultados(ingresosVentas, otrosIngresos, costoVentas, planilla, serviciosArray, otros, tributario, cargas) {
    // ‚úÖ CALCULAR TOTAL DE SERVICIOS
    var totalServicios = 0;
    if(Array.isArray(serviciosArray)) {
        serviciosArray.forEach(function(s) {
            totalServicios += Number(s.monto) || 0;
        });
    }
    
    var totalIngresos = Number(ingresosVentas) + Number(otrosIngresos);
    var utilidadBruta = Number(ingresosVentas) - Number(costoVentas);
    var totalEgresos = Number(costoVentas) + Number(planilla) + Number(totalServicios) + Number(otros) + Number(tributario || 0) + Number(cargas || 0);
    var utilidadNeta = Number(totalIngresos) - Number(totalEgresos);
    var margenBruto = ingresosVentas > 0 ? (utilidadBruta / ingresosVentas * 100) : 0;
    var margenNeto = totalIngresos > 0 ? (utilidadNeta / totalIngresos * 100) : 0;
    
    var html = '';
    
    // Ingresos
    html += '<div class="bg-green-50 p-4 rounded-lg">';
    html += '<p class="font-black text-sm text-slate-700 mb-2">INGRESOS</p>';
    html += '<div class="pl-4 space-y-1">';
    html += '<div class="flex justify-between text-sm"><span>Ventas del POS</span><span class="font-bold">S/. ' + ingresosVentas.toFixed(2) + '</span></div>';
    html += '<div class="flex justify-between text-sm"><span>Otros Ingresos</span><span class="font-bold">S/. ' + otrosIngresos.toFixed(2) + '</span></div>';
    html += '<div class="flex justify-between font-black text-green-700 border-t-2 border-green-300 pt-2 mt-2">';
    html += '<span>TOTAL INGRESOS</span><span>S/. ' + totalIngresos.toFixed(2) + '</span>';
    html += '</div>';
    html += '</div></div>';
    
    // Costo de Ventas
    html += '<div class="bg-orange-50 p-4 rounded-lg">';
    html += '<div class="flex justify-between font-black text-sm text-slate-700">';
    html += '<span>(-) COSTO DE VENTAS</span><span class="text-orange-700">S/. ' + costoVentas.toFixed(2) + '</span>';
    html += '</div></div>';
    
    // Utilidad Bruta
    html += '<div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-300">';
    html += '<div class="flex justify-between items-center">';
    html += '<div><p class="font-black text-blue-700">UTILIDAD BRUTA</p><p class="text-xs text-blue-600">Margen: ' + margenBruto.toFixed(2) + '%</p></div>';
    html += '<span class="font-black text-blue-700 text-xl">S/. ' + utilidadBruta.toFixed(2) + '</span>';
    html += '</div></div>';
    
    // Gastos Operativos
    html += '<div class="bg-red-50 p-4 rounded-lg">';
    html += '<p class="font-black text-sm text-slate-700 mb-2">(-) GASTOS OPERATIVOS</p>';
    html += '<div class="pl-4 space-y-1">';
    html += '<div class="flex justify-between text-sm"><span>Planilla</span><span class="font-bold">S/. ' + planilla.toFixed(2) + '</span></div>';
    
    // ‚úÖ MOSTRAR SERVICIOS DESGLOSADOS
    if(Array.isArray(serviciosArray) && serviciosArray.length > 0) {
        serviciosArray.forEach(function(servicio) {
            var nombreDisplay = servicio.nombre || 'Servicio';
            var montoDisplay = (servicio.monto || 0).toFixed(2);
            
            html += '<div class="flex justify-between text-sm pl-4 border-l-2 border-blue-300">';
            html += '<span class="text-blue-700">‚Ä¢ ' + nombreDisplay + '</span>';
            html += '<span class="font-bold text-blue-700">S/. ' + montoDisplay + '</span>';
            html += '</div>';
        });
    } else {
        html += '<div class="flex justify-between text-sm"><span>Servicios</span><span class="font-bold">S/. 0.00</span></div>';
    }
    
    html += '<div class="flex justify-between text-sm"><span>Otros Gastos</span><span class="font-bold">S/. ' + otros.toFixed(2) + '</span></div>';
    if(tributario > 0) {
        html += '<div class="flex justify-between text-sm"><span>Tributario</span><span class="font-bold text-orange-700">S/. ' + tributario.toFixed(2) + '</span></div>';
    }
    if(cargas > 0) {
        html += '<div class="flex justify-between text-sm"><span>Cargas Laborales</span><span class="font-bold text-teal-700">S/. ' + cargas.toFixed(2) + '</span></div>';
    }
    html += '<div class="flex justify-between font-black text-red-700 border-t-2 border-red-300 pt-2 mt-2">';
    html += '<span>TOTAL GASTOS</span><span>S/. ' + (Number(planilla) + Number(totalServicios) + Number(otros) + Number(tributario || 0) + Number(cargas || 0)).toFixed(2) + '</span>';
    html += '</div>';
    html += '</div></div>';
    
    // Utilidad Neta
    var colorNeta = utilidadNeta >= 0 ? 'purple' : 'red';
    html += '<div class="bg-' + colorNeta + '-50 p-4 rounded-lg border-4 border-' + colorNeta + '-300">';
    html += '<div class="flex justify-between items-center">';
    html += '<div><p class="font-black text-' + colorNeta + '-700 text-lg">UTILIDAD NETA</p>';
    html += '<p class="text-xs text-' + colorNeta + '-600">Margen: ' + margenNeto.toFixed(2) + '%</p></div>';
    html += '<span class="font-black text-' + colorNeta + '-700 text-2xl">S/. ' + utilidadNeta.toFixed(2) + '</span>';
    html += '</div></div>';
    
    document.getElementById('estado-resultados').innerHTML = html;
}

// ========== EXPORTAR ESTADO DE RESULTADOS ==========
function exportarEstadoResultados() {
    console.log('üìÑ Generando PDF del Estado de Resultados...');
    
    // Verificar si jsPDF est√° disponible
    if (typeof window.jspdf === 'undefined') {
        alert('‚ùå No se puede generar el PDF\n\n' +
              'La librer√≠a jsPDF no est√° disponible.\n' +
              'Esto puede ocurrir si:\n' +
              '‚Ä¢ No tienes conexi√≥n a internet\n' +
              '‚Ä¢ El CDN de jsPDF est√° bloqueado\n\n' +
              'Por favor verifica tu conexi√≥n e intenta de nuevo.');
        console.error('jsPDF no est√° cargado');
        return;
    }
    
    // ‚úÖ FUNCI√ìN PARA FORMATEAR N√öMEROS CON COMAS
    function formatMoney(num) {
        const absNum = Math.abs(num);
        const formatted = absNum.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return (num < 0 ? '-' : '') + 'S/. ' + formatted;
    }
    
    try {
        // Obtener fechas del per√≠odo actual
        var fechaInicio = document.getElementById('finanzas-fecha-inicio').value;
        var fechaFin = document.getElementById('finanzas-fecha-fin').value;
        
        if (!fechaInicio || !fechaFin) {
            alert('‚ö†Ô∏è Por favor selecciona un per√≠odo v√°lido primero\n\n' +
                  'Ve a la secci√≥n FINANZAS y aseg√∫rate de tener fechas seleccionadas.');
            return;
        }
        
        console.log('üìÖ Per√≠odo: ' + fechaInicio + ' al ' + fechaFin);
        
        // Recalcular datos financieros para el PDF
        var inicio = new Date(fechaInicio);
        var fin = new Date(fechaFin);
        
        // CALCULAR INGRESOS
        var ingresosVentas = 0;
        var costoVentas = 0;
        
        if (!db.historialVentas) db.historialVentas = [];
        var todasLasVentas = db.historialVentas.slice();
        if (db.ventas) {
            db.ventas.forEach(function(v) {
                var existe = todasLasVentas.find(function(tv) { return tv.id === v.id; });
                if (!existe) todasLasVentas.push(v);
            });
        }
        
        todasLasVentas.forEach(function(venta) {
            var fechaVenta = new Date(venta.fecha);
            if (fechaVenta >= inicio && fechaVenta <= fin) {
                ingresosVentas += venta.total;
                if (venta.items && venta.items.length > 0) {
                    venta.items.forEach(function(item) {
                        var plato = db.platos.find(function(p) { return p.sku === item.sku; });
                        if (plato && plato.costoReceta) {
                            costoVentas += plato.costoReceta * item.cantidad;
                        }
                    });
                }
            }
        });
        
        var otrosIngresos = 0;
        db.otrosIngresos.forEach(function(ing) {
            var fecha = new Date(ing.fecha);
            if (fecha >= inicio && fecha <= fin) {
                otrosIngresos += parseFloat(ing.monto) || 0;
            }
        });
        
        var totalIngresos = Number(ingresosVentas) + Number(otrosIngresos);
        
        // CALCULAR EGRESOS
        var egresoPlanilla = 0;
        var diasPeriodo = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
        var factorPlanilla = diasPeriodo / 30;
        
        db.empleados.forEach(function(emp) {
            if (emp.activo) {
                var fechaIngreso = new Date(emp.fechaIngreso);
                if (fechaIngreso <= fin) {
                    egresoPlanilla += (parseFloat(emp.sueldo) || 0) * factorPlanilla;
                }
            }
        });
        
        // ‚úÖ SERVICIOS DESGLOSADOS
        var serviciosDelPeriodo = [];
        var egresoServicios = 0;
        db.servicios.forEach(function(serv) {
            var fecha = new Date(serv.fecha);
            if (fecha >= inicio && fecha <= fin) {
                var monto = parseFloat(serv.monto) || 0;
                egresoServicios += monto;
                
                var nombreServicio = '';
                if (serv.tipo) {
                    nombreServicio = serv.tipo.charAt(0).toUpperCase() + serv.tipo.slice(1).toLowerCase();
                }
                if (serv.descripcion && serv.descripcion.trim()) {
                    if (nombreServicio) {
                        nombreServicio += ' - ' + serv.descripcion;
                    } else {
                        nombreServicio = serv.descripcion;
                    }
                }
                if (!nombreServicio) nombreServicio = 'Servicio';
                
                serviciosDelPeriodo.push({
                    nombre: nombreServicio,
                    monto: monto
                });
            }
        });
        
        var egresoOtros = 0;
        db.otrosEgresos.forEach(function(eg) {
            var fecha = new Date(eg.fecha);
            if (fecha >= inicio && fecha <= fin) {
                egresoOtros += parseFloat(eg.monto) || 0;
            }
        });
        
        var totalEgresos = Number(costoVentas) + Number(egresoPlanilla) + Number(egresoServicios) + Number(egresoOtros);
        
        // CALCULAR RENTABILIDAD
        var utilidadBruta = Number(ingresosVentas) - Number(costoVentas);
        var utilidadNeta = Number(totalIngresos) - Number(totalEgresos);
        var margenBruto = ingresosVentas > 0 ? (utilidadBruta / ingresosVentas * 100) : 0;
        var margenNeto = totalIngresos > 0 ? (utilidadNeta / totalIngresos * 100) : 0;
        
        console.log('üí∞ Ingresos:', totalIngresos.toFixed(2));
        console.log('üí∏ Egresos:', totalEgresos.toFixed(2));
        console.log('üíé Utilidad Neta:', utilidadNeta.toFixed(2));
        
        // ============================================
        // CREAR PDF CON DISE√ëO FULL COLOR
        // ============================================
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let y = 10;
        
        // ===== HEADER CON GRADIENTE P√öRPURA =====
        doc.setFillColor(147, 51, 234); // P√∫rpura
        doc.rect(0, 0, pageWidth, 45, 'F');
        
        // Logo circular blanco
        doc.setFillColor(255, 255, 255);
        doc.circle(20, 20, 8, 'F');
        doc.setFillColor(147, 51, 234);
        doc.circle(20, 20, 6, 'F');
        
        // T√≠tulo
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('SWISSOTEL', pageWidth / 2, 18, { align: 'center' });
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('HOTELERA COSTA DEL PACIFICO S.A. - RUC: 20297885538', pageWidth / 2, 24, { align: 'center' });
        
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('ESTADO DE RESULTADOS', pageWidth / 2, 33, { align: 'center' });
        
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        doc.text('Periodo: ' + new Date(fechaInicio).toLocaleDateString('es-PE') + ' al ' + new Date(fechaFin).toLocaleDateString('es-PE'), pageWidth / 2, 40, { align: 'center' });
        
        y = 55;
        
        // ===== SECCI√ìN INGRESOS (VERDE) =====
        doc.setFillColor(220, 252, 231); // Verde claro
        doc.roundedRect(margin, y, pageWidth - 2*margin, 28, 3, 3, 'F');
        
        // T√≠tulo INGRESOS
        doc.setTextColor(22, 163, 74); // Verde oscuro
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('INGRESOS', margin + 5, y + 7);
        
        // L√≠neas de ingresos
        doc.setTextColor(71, 85, 105);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('Ventas del POS', margin + 8, y + 13);
        doc.setFont(undefined, 'bold');
        doc.text(formatMoney(ingresosVentas), pageWidth - margin - 5, y + 13, { align: 'right' });
        
        doc.setFont(undefined, 'normal');
        doc.text('Otros Ingresos', margin + 8, y + 18);
        doc.setFont(undefined, 'bold');
        doc.text(formatMoney(otrosIngresos), pageWidth - margin - 5, y + 18, { align: 'right' });
        
        // Total Ingresos
        doc.setFillColor(34, 197, 94); // Verde fuerte
        doc.roundedRect(margin + 3, y + 21, pageWidth - 2*margin - 6, 6, 1, 1, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont(undefined, 'bold');
        doc.text('TOTAL INGRESOS', margin + 6, y + 25);
        doc.text(formatMoney(totalIngresos), pageWidth - margin - 8, y + 25, { align: 'right' });
        
        y += 35;
        
        // ===== COSTO DE VENTAS (NARANJA) =====
        doc.setFillColor(254, 243, 199); // Naranja claro
        doc.roundedRect(margin, y, pageWidth - 2*margin, 8, 2, 2, 'F');
        
        doc.setTextColor(234, 88, 12); // Naranja oscuro
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('(-) COSTO DE VENTAS', margin + 5, y + 5.5);
        doc.text(formatMoney(costoVentas), pageWidth - margin - 5, y + 5.5, { align: 'right' });
        
        y += 13;
        
        // ===== UTILIDAD BRUTA (AZUL) =====
        doc.setFillColor(219, 234, 254); // Azul claro
        doc.roundedRect(margin, y, pageWidth - 2*margin, 10, 2, 2, 'F');
        
        doc.setTextColor(29, 78, 216); // Azul oscuro
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('UTILIDAD BRUTA', margin + 5, y + 5);
        doc.text(formatMoney(utilidadBruta), pageWidth - margin - 5, y + 5, { align: 'right' });
        
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        doc.text('Margen: ' + margenBruto.toFixed(2) + '%', margin + 5, y + 8.5);
        
        y += 15;
        
        // ===== GASTOS OPERATIVOS (ROJO) =====
        var alturaServicios = 5 * serviciosDelPeriodo.length; // 5mm por servicio
        var alturaGastos = 28 + alturaServicios;
        
        doc.setFillColor(254, 226, 226); // Rojo claro
        doc.roundedRect(margin, y, pageWidth - 2*margin, alturaGastos, 3, 3, 'F');
        
        // T√≠tulo GASTOS OPERATIVOS
        doc.setTextColor(220, 38, 38); // Rojo oscuro
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('(-) GASTOS OPERATIVOS', margin + 5, y + 7);
        
        var yGastos = y + 13;
        
        // Planilla
        doc.setTextColor(71, 85, 105);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('Planilla', margin + 8, yGastos);
        doc.setFont(undefined, 'bold');
        doc.text(formatMoney(egresoPlanilla), pageWidth - margin - 5, yGastos, { align: 'right' });
        
        yGastos += 5;
        
        // ‚úÖ SERVICIOS DESGLOSADOS
        if (serviciosDelPeriodo.length > 0) {
            serviciosDelPeriodo.forEach(function(servicio) {
                doc.setTextColor(59, 130, 246); // Azul para servicios
                doc.setFont(undefined, 'normal');
                doc.text('  ‚Ä¢ ' + servicio.nombre, margin + 10, yGastos);
                doc.setFont(undefined, 'bold');
                doc.text(formatMoney(servicio.monto), pageWidth - margin - 5, yGastos, { align: 'right' });
                yGastos += 5;
            });
        } else {
            doc.setTextColor(71, 85, 105);
            doc.setFont(undefined, 'normal');
            doc.text('Servicios', margin + 8, yGastos);
            doc.setFont(undefined, 'bold');
            doc.text(formatMoney(0), pageWidth - margin - 5, yGastos, { align: 'right' });
            yGastos += 5;
        }
        
        // Otros Egresos
        doc.setTextColor(71, 85, 105);
        doc.setFont(undefined, 'normal');
        doc.text('Otros Gastos', margin + 8, yGastos);
        doc.setFont(undefined, 'bold');
        doc.text(formatMoney(egresoOtros), pageWidth - margin - 5, yGastos, { align: 'right' });
        
        yGastos += 3;
        
        // Total Gastos
        doc.setFillColor(239, 68, 68); // Rojo fuerte
        doc.roundedRect(margin + 3, yGastos, pageWidth - 2*margin - 6, 6, 1, 1, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont(undefined, 'bold');
        doc.text('TOTAL GASTOS OPERATIVOS', margin + 6, yGastos + 4);
        var totalGastosOp = Number(egresoPlanilla) + Number(egresoServicios) + Number(egresoOtros);
        doc.text(formatMoney(totalGastosOp), pageWidth - margin - 8, yGastos + 4, { align: 'right' });
        
        y = y + alturaGastos + 8;
        
        // ===== UTILIDAD NETA (P√öRPURA O ROJO SEG√öN RESULTADO) =====
        var colorNeta = utilidadNeta >= 0 ? [147, 51, 234] : [220, 38, 38]; // P√∫rpura o Rojo
        var colorNetaClaro = utilidadNeta >= 0 ? [243, 232, 255] : [254, 226, 226];
        
        doc.setFillColor(colorNetaClaro[0], colorNetaClaro[1], colorNetaClaro[2]);
        doc.roundedRect(margin, y, pageWidth - 2*margin, 14, 3, 3, 'F');
        
        // Borde grueso
        doc.setDrawColor(colorNeta[0], colorNeta[1], colorNeta[2]);
        doc.setLineWidth(1);
        doc.roundedRect(margin, y, pageWidth - 2*margin, 14, 3, 3, 'S');
        
        doc.setTextColor(colorNeta[0], colorNeta[1], colorNeta[2]);
        doc.setFontSize(13);
        doc.setFont(undefined, 'bold');
        doc.text('UTILIDAD NETA', margin + 5, y + 7);
        doc.setFontSize(14);
        doc.text(formatMoney(utilidadNeta), pageWidth - margin - 5, y + 7, { align: 'right' });
        
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        doc.text('Margen Neto: ' + margenNeto.toFixed(2) + '%', margin + 5, y + 11);
        
        // ===== FOOTER =====
        y = pageHeight - 15;
        doc.setTextColor(100, 116, 139);
        doc.setFontSize(7);
        doc.setFont(undefined, 'italic');
        doc.text('GASTRO CONTROL PRO - Estado de Resultados', margin, y);
        doc.text('Generado: ' + new Date().toLocaleDateString('es-PE') + ' ' + new Date().toLocaleTimeString('es-PE'), pageWidth - margin, y, { align: 'right' });
        
        // GUARDAR PDF
        var nombreArchivo = 'Estado_Resultados_' + fechaInicio + '_' + fechaFin + '.pdf';
        doc.save(nombreArchivo);
        
        console.log('‚úÖ PDF generado exitosamente:', nombreArchivo);
        alert('‚úÖ PDF GENERADO EXITOSAMENTE\n\n' +
              'üìÑ ' + nombreArchivo + '\n\n' +
              'üé® Dise√±o profesional a todo color\n' +
              'üí∞ Formato con separadores de miles\n' +
              'üîå Servicios desglosados\n\n' +
              'El PDF se descarg√≥ autom√°ticamente.');
        
    } catch (error) {
        console.error('‚ùå Error al generar PDF:', error);
        alert('‚ùå Error al generar PDF\n\n' +
              'Detalles del error:\n' + error.message + '\n\n' +
              'Por favor revisa la consola (F12) para m√°s informaci√≥n.');
    }
}

// ========== INICIALIZAR FINANZAS ==========
function inicializarFinanzas() {
    // ‚úÖ Migrar ventas antiguas a historialVentas si es necesario
    if (!db.historialVentas) db.historialVentas = [];
    if (db.historialVentas.length === 0 && db.ventas && db.ventas.length > 0) {
        console.log('Migrando ' + db.ventas.length + ' ventas al historial financiero...');
        db.historialVentas = db.ventas.slice();
        save();
    }
    
    renderEmpleados();
    renderServicios();
    renderOtrosEgresos();
    renderOtrosIngresos();
    setFinanzasMesActual();
}

// ========== REPORTES DE VENTAS ==========
function renderVentas() {
    if (!db.ventas) db.ventas = [];
    
    // Actualizar tarjetas con todas las ventas
    actualizarTarjetasVentas(db.ventas);
    
    // Mostrar tabla con todas las ventas
    renderTablaVentas(db.ventas);
}

function actualizarTarjetasVentas(ventas) {
    // Calcular estad√≠sticas basadas en el array de ventas proporcionado
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    
    const ventasHoy = ventas.filter(v => {
        const fechaVenta = new Date(v.fecha);
        fechaVenta.setHours(0, 0, 0, 0);
        return fechaVenta.getTime() === hoy.getTime();
    });
    
    const ventasMes = ventas.filter(v => {
        const fechaVenta = new Date(v.fecha);
        return fechaVenta.getMonth() === hoy.getMonth() && 
               fechaVenta.getFullYear() === hoy.getFullYear();
    });
    
    const totalHoy = ventasHoy.reduce((sum, v) => sum + v.total, 0);
    const totalMes = ventasMes.reduce((sum, v) => sum + v.total, 0);
    const totalGeneral = ventas.reduce((sum, v) => sum + v.total, 0);
    
    document.getElementById('ventas-hoy').textContent = totalHoy.toFixed(2);
    document.getElementById('ventas-mes').textContent = totalMes.toFixed(2);
    document.getElementById('total-ventas-count').textContent = ventas.length;
    
    // Calcular promedio (solo del mes actual o del per√≠odo filtrado si aplica)
    const promedio = ventasMes.length > 0 ? (totalMes / ventasMes.length) : 0;
    const promedioElement = document.getElementById('promedio-venta');
    if (promedioElement) {
        promedioElement.textContent = promedio.toFixed(2);
    }
}

function renderTablaVentas(ventas) {
    const html = ventas.slice().reverse().map(v => {
        const fecha = new Date(v.fecha);
        const itemsResumen = v.items.map(i => `${i.cantidad}x ${i.nombre}`).join(', ');
        
        // Determinar el tipo de pedido para mostrar
        const tipoDisplay = v.tipo === 'llevar' ? 
            '<span class="px-2 py-1 rounded text-xs font-bold bg-orange-100 text-orange-700">ü•° LLEVAR</span>' : 
            `<span class="px-2 py-1 rounded text-xs font-bold bg-purple-100 text-purple-700">ü™ë Mesa ${v.mesa}</span>`;
        
        // Mostrar total con descuento si existe
        let totalDisplay = '';
        if(v.descuento) {
            totalDisplay = `
                <div>
                    <div class="text-sm line-through text-slate-400">S/. ${v.subtotal.toFixed(2)}</div>
                    <div class="text-xs text-emerald-600 font-bold">-${v.descuento.nombre}</div>
                    <div class="font-bold text-emerald-600">S/. ${v.total.toFixed(2)}</div>
                </div>
            `;
        } else {
            totalDisplay = `<div class="font-bold text-green-600">S/. ${v.total.toFixed(2)}</div>`;
        }
        
        return `
            <tr class="hover:bg-green-50 transition-colors">
                <td class="p-4">${fecha.toLocaleDateString('es-PE')}</td>
                <td class="p-4">${fecha.toLocaleTimeString('es-PE')}</td>
                <td class="p-4">${tipoDisplay}</td>
                <td class="p-4 font-semibold">${v.usuario || '-'}</td>
                <td class="p-4 text-sm text-slate-600">${itemsResumen.substring(0, 50)}${itemsResumen.length > 50 ? '...' : ''}</td>
                <td class="p-4 text-center">
                    <span class="px-2 py-1 rounded text-xs font-bold bg-blue-100 text-blue-700">
                        ${v.metodoPago.toUpperCase()}
                    </span>
                </td>
                <td class="p-4 text-right">${totalDisplay}</td>
                <td class="p-4 text-center">
                    <div class="flex gap-2 justify-center">
                        <button onclick="verDetalleVenta('${v.id}')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg font-bold hover:bg-blue-200 text-xs">
                            üëÅÔ∏è VER
                        </button>
                        <button onclick="eliminarVentaIndividual('${v.id}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg font-bold hover:bg-red-200 text-xs">
                            üóëÔ∏è
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    document.getElementById('ventas-list').innerHTML = html || `
        <tr><td colspan="8" class="p-8 text-center text-slate-400">
            <div class="text-4xl mb-2">üí∞</div>
            No hay ventas registradas
        </td></tr>
    `;
}

function filtrarVentas() {
    const inicio = document.getElementById('fecha-inicio-ventas').value;
    const fin = document.getElementById('fecha-fin-ventas').value;
    
    if (!inicio || !fin) {
        alert('‚ö†Ô∏è Por favor selecciona ambas fechas');
        renderTablaVentas(db.ventas);
        return;
    }
    
    // CR√çTICO: Crear fechas en zona horaria local (no UTC)
    // Dividir el string "YYYY-MM-DD" y crear fecha local
    const [yInicio, mInicio, dInicio] = inicio.split('-').map(Number);
    const fechaInicio = new Date(yInicio, mInicio - 1, dInicio, 0, 0, 0, 0);
    
    const [yFin, mFin, dFin] = fin.split('-').map(Number);
    const fechaFin = new Date(yFin, mFin - 1, dFin, 23, 59, 59, 999);
    
    console.log('=== FILTRAR VENTAS ===');
    console.log('String inicio:', inicio, '‚Üí Fecha:', fechaInicio);
    console.log('String fin:', fin, '‚Üí Fecha:', fechaFin);
    console.log('Total ventas:', db.ventas.length);
    
    const ventasFiltradas = db.ventas.filter(v => {
        const fechaVenta = new Date(v.fecha);
        const cumple = fechaVenta >= fechaInicio && fechaVenta <= fechaFin;
        if (cumple) {
            console.log('‚úÖ Incluida:', fechaVenta.toLocaleString('es-PE'), '- Total:', v.total);
        }
        return cumple;
    });
    
    console.log('Ventas filtradas:', ventasFiltradas.length);
    console.log('===================');
    
    if (ventasFiltradas.length === 0) {
        alert('‚ÑπÔ∏è No se encontraron ventas en el per√≠odo seleccionado.\n\nFechas buscadas:\n' + 
              'Desde: ' + fechaInicio.toLocaleDateString('es-PE') + '\n' +
              'Hasta: ' + fechaFin.toLocaleDateString('es-PE'));
    }
    
    // ACTUALIZAR TARJETAS con estad√≠sticas del per√≠odo filtrado
    actualizarTarjetasPeriodoFiltrado(ventasFiltradas, fechaInicio, fechaFin);
    
    // Mostrar tabla filtrada
    renderTablaVentas(ventasFiltradas);
}

function actualizarTarjetasPeriodoFiltrado(ventas, fechaInicio, fechaFin) {
    // Calcular totales del per√≠odo filtrado
    const totalPeriodo = ventas.reduce((sum, v) => sum + v.total, 0);
    const promedio = ventas.length > 0 ? (totalPeriodo / ventas.length) : 0;
    
    // Calcular ventas por d√≠a (primera y √∫ltima fecha del filtro)
    const primeraVenta = ventas.length > 0 ? new Date(ventas[0].fecha) : fechaInicio;
    const ultimaVenta = ventas.length > 0 ? new Date(ventas[ventas.length - 1].fecha) : fechaFin;
    
    // Cambiar etiquetas a modo "PER√çODO FILTRADO"
    document.getElementById('label-ventas-hoy').textContent = 'üìÖ PER√çODO FILTRADO';
    document.getElementById('label-ventas-mes').textContent = 'üí∞ TOTAL PER√çODO';
    document.getElementById('label-total-ventas').textContent = 'üìä VENTAS EN PER√çODO';
    document.getElementById('label-promedio-venta').textContent = 'üßæ PROMEDIO PER√çODO';
    
    // Actualizar valores
    document.getElementById('ventas-hoy').textContent = totalPeriodo.toFixed(2);
    document.getElementById('ventas-mes').textContent = totalPeriodo.toFixed(2);
    document.getElementById('total-ventas-count').textContent = ventas.length;
    document.getElementById('promedio-venta').textContent = promedio.toFixed(2);
}

function verDetalleVenta(id) {
    const venta = db.ventas.find(v => v.id === id);
    const fecha = new Date(venta.fecha);
    
    // Determinar el tipo de pedido para mostrar
    const tipoDisplay = venta.tipo === 'llevar' ? 
        'ü•° PARA LLEVAR' : 
        `ü™ë Mesa ${venta.mesa}`;
    
    const html = `
        <div id="modal-venta" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-black">üìÑ DETALLE DE VENTA</h3>
                    <button onclick="cerrarModalVenta()" class="text-4xl">√ó</button>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <p class="text-sm text-slate-600">Fecha</p>
                        <p class="font-bold">${fecha.toLocaleDateString('es-PE')} ${fecha.toLocaleTimeString('es-PE')}</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-600">Tipo de Pedido</p>
                        <p class="font-bold">${tipoDisplay}</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-600">M√©todo de pago</p>
                        <p class="font-bold">${venta.metodoPago.toUpperCase()}</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-600">Atendido por</p>
                        <p class="font-bold">${venta.usuario || '-'}</p>
                    </div>
                </div>
                
                <div class="border-t-2 pt-4 mb-4">
                    <p class="font-bold mb-3">Items del pedido:</p>
                    <div class="space-y-2">
                        ${venta.items.map(item => `
                            <div class="flex justify-between bg-slate-50 p-3 rounded-lg">
                                <div>
                                    <p class="font-semibold">${item.cantidad}x ${item.nombre}</p>
                                    ${item.observacion ? `<p class="text-xs text-blue-600">üìù ${item.observacion}</p>` : ''}
                                </div>
                                <p class="font-bold">S/. ${item.subtotal.toFixed(2)}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="border-t-2 pt-4">
                    <div class="flex justify-between text-2xl font-black">
                        <span>TOTAL:</span>
                        <span class="text-green-600">S/. ${venta.total.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', html);
}

function cerrarModalVenta() {
    var modal = document.getElementById('modal-venta');
    if (modal) modal.remove();
}

// ========== INDICADORES DE MESAS ==========
function actualizarIndicadoresMesas() {
    if (!db.mesas) db.mesas = [];
    
    var mesasOcupadas = db.mesas.filter(function(m) { return m.estado === 'ocupada'; });
    
    // Indicador de mesas ocupadas (SAL√ìN)
    var htmlOcupadas = '';
    if (mesasOcupadas.length > 0) {
        htmlOcupadas += '<div class="bg-blue-50 rounded-lg p-3">';
        htmlOcupadas += '<p class="text-xs font-bold text-blue-700 mb-2">ü™ë Mesas Ocupadas (' + mesasOcupadas.length + '):</p>';
        htmlOcupadas += '<div class="flex flex-wrap gap-1">';
        
        for (var i = 0; i < mesasOcupadas.length; i++) {
            var mesa = mesasOcupadas[i];
            var pedido = db.pedidosActivos ? db.pedidosActivos[mesa.numero] : null;
            var total = pedido ? (pedido.total || 0) : 0;
            var colorBg = total === 0 ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700';
            
            htmlOcupadas += '<button onclick="abrirMesaDesdeIndicador(' + mesa.numero + ')" class="' + colorBg + ' px-2 py-1 rounded text-xs font-bold hover:opacity-80 transition-opacity" title="Click para abrir">';
            htmlOcupadas += 'M' + mesa.numero + ' S/.' + total.toFixed(0);
            htmlOcupadas += '</button>';
        }
        
        htmlOcupadas += '</div>';
        htmlOcupadas += '</div>';
    } else {
        htmlOcupadas = '<p class="text-xs text-slate-400 text-center">Sin mesas ocupadas</p>';
    }
    
    var elemOcupadas = document.getElementById('indicador-mesas-ocupadas');
    if (elemOcupadas) elemOcupadas.innerHTML = htmlOcupadas;
    
    // Indicador de pedidos para llevar PENDIENTES
    var htmlLlevar = '';
    var pedidoParaLlevar = db.pedidosActivos && db.pedidosActivos['LLEVAR'] ? db.pedidosActivos['LLEVAR'] : null;
    
    if (pedidoParaLlevar && pedidoParaLlevar.items && pedidoParaLlevar.items.length > 0) {
        var totalLlevar = pedidoParaLlevar.total || 0;
        var cantidadItems = pedidoParaLlevar.items.length;
        
        htmlLlevar += '<div class="bg-green-50 rounded-lg p-3 border-2 border-green-300">';
        htmlLlevar += '<p class="text-xs font-bold text-green-700 mb-2">üì¶ Pedido Pendiente:</p>';
        htmlLlevar += '<button onclick="cargarPedidoParaLlevar()" class="bg-green-500 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-600 w-full">';
        htmlLlevar += 'ü•° ' + cantidadItems + ' item(s) ‚Ä¢ S/. ' + totalLlevar.toFixed(2);
        htmlLlevar += '<br><span class="text-xs opacity-90">Click para cobrar</span>';
        htmlLlevar += '</button>';
        htmlLlevar += '</div>';
    } else {
        htmlLlevar = '<p class="text-xs text-slate-400 text-center">Click para crear pedido</p>';
    }
    
    var elemLlevar = document.getElementById('indicador-para-llevar');
    if (elemLlevar) elemLlevar.innerHTML = htmlLlevar;
    
    // Resumen de mesas activas
    var htmlResumen = '';
    if (mesasOcupadas.length > 0) {
        var totalGeneral = 0;
        for (var i = 0; i < mesasOcupadas.length; i++) {
            var pedido = db.pedidosActivos ? db.pedidosActivos[mesasOcupadas[i].numero] : null;
            totalGeneral += pedido ? (pedido.total || 0) : 0;
        }
        
        htmlResumen += '<div class="bg-orange-50 rounded-lg p-3">';
        htmlResumen += '<p class="text-xs font-bold text-orange-700 text-center">';
        htmlResumen += mesasOcupadas.length + ' mesa(s) ‚Ä¢ S/. ' + totalGeneral.toFixed(2);
        htmlResumen += '</p>';
        htmlResumen += '</div>';
    } else {
        htmlResumen = '<p class="text-xs text-slate-400 text-center">Sin mesas activas</p>';
    }
    
    var elemResumen = document.getElementById('indicador-resumen-activas');
    if (elemResumen) elemResumen.innerHTML = htmlResumen;
}

function abrirMesaDesdeIndicador(numMesa) {
    console.log('Abrir mesa desde indicador:', numMesa);
    
    var mesa = db.mesas.find(function(m) { return m.numero === numMesa; });
    if (!mesa || mesa.estado !== 'ocupada') {
        alert('Esta mesa ya no est√° activa');
        actualizarIndicadoresMesas();
        return;
    }
    
    // Cargar pedido y cambiar a vista de pedido
    cargarPedidoExistente(mesa.pedidoId);
    
    document.getElementById('selector-tipo-pedido').classList.add('hidden');
    document.getElementById('seccion-pedido').classList.remove('hidden');
    document.getElementById('mesa-actual').textContent = 'MESA ' + numMesa;
    renderMenuPOS();
}

function cargarPedidoParaLlevar() {
    console.log('ü•° Cargar pedido para llevar pendiente');
    
    // Verificar que existe el pedido
    if (!db.pedidosActivos || !db.pedidosActivos['LLEVAR']) {
        alert('‚ö†Ô∏è No hay pedidos para llevar pendientes');
        return;
    }
    
    var pedidoPendiente = db.pedidosActivos['LLEVAR'];
    
    if (!pedidoPendiente.items || pedidoPendiente.items.length === 0) {
        alert('‚ö†Ô∏è El pedido para llevar est√° vac√≠o');
        delete db.pedidosActivos['LLEVAR'];
        save();
        actualizarIndicadoresMesas();
        return;
    }
    
    // Cargar el pedido en pedidoActual
    pedidoActual = {
        tipo: 'llevar',
        mesa: 'LLEVAR',
        items: pedidoPendiente.items.slice(), // Copiar array
        total: pedidoPendiente.total || 0
    };
    
    console.log('‚úÖ Pedido para llevar cargado:', pedidoActual);
    console.log('üì¶ Items:', pedidoActual.items.length);
    console.log('üí∞ Total: S/.', pedidoActual.total.toFixed(2));
    
    // Cambiar a vista de pedido
    document.getElementById('selector-tipo-pedido').classList.add('hidden');
    document.getElementById('seccion-pedido').classList.remove('hidden');
    document.getElementById('mesa-actual').textContent = 'PARA LLEVAR';
    
    // Renderizar el pedido
    renderPedidoActual();
}

// ========== MESAS ACTIVAS ==========
function verMesasActivas() {
    console.log('Ver mesas activas');
    document.getElementById('selector-tipo-pedido').classList.add('hidden');
    document.getElementById('seccion-mesas-activas').classList.remove('hidden');
    renderMesasActivas();
}

function renderMesasActivas() {
    if (!db.mesas) db.mesas = [];
    
    var mesasOcupadas = db.mesas.filter(function(m) { return m.estado === 'ocupada'; });
    
    console.log('Mesas ocupadas:', mesasOcupadas.length);
    
    if (mesasOcupadas.length === 0) {
        document.getElementById('lista-mesas-activas').innerHTML = '<div class="col-span-2 text-center py-12"><div class="text-6xl mb-4">üò¥</div><p class="text-xl text-slate-500">No hay mesas activas en este momento</p></div>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < mesasOcupadas.length; i++) {
        var mesa = mesasOcupadas[i];
        var pedidoActivo = db.pedidosActivos ? db.pedidosActivos[mesa.numero] : null;
        
        var itemsCount = 0;
        var total = 0;
        var mozo = '';
        var tiempo = '';
        
        if (pedidoActivo) {
            itemsCount = pedidoActivo.items ? pedidoActivo.items.length : 0;
            total = pedidoActivo.total || 0;
            mozo = pedidoActivo.mozo || '';
            
            if (pedidoActivo.fecha) {
                var fechaPedido = new Date(pedidoActivo.fecha);
                var ahora = new Date();
                var minutos = Math.floor((ahora - fechaPedido) / 60000);
                tiempo = minutos + ' min';
            }
        }
        
        // Determinar si la mesa est√° vac√≠a
        var esVacia = total === 0;
        var colorBorde = esVacia ? 'border-red-400' : 'border-orange-300';
        var colorBordeHover = esVacia ? 'hover:border-red-600' : 'hover:border-orange-500';
        var badgeVacio = esVacia ? '<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold">üóëÔ∏è VAC√çA</span>' : '';
        
        html += '<div class="glass-card p-6 hover:shadow-2xl transition-all border-4 ' + colorBorde + ' ' + colorBordeHover + '">';
        html += '<div class="flex justify-between items-start mb-4">';
        html += '<div>';
        html += '<div class="flex items-center gap-2">';
        html += '<p class="text-4xl font-black text-orange-600">MESA ' + mesa.numero + '</p>';
        html += badgeVacio;
        html += '</div>';
        html += '<p class="text-sm text-slate-600">üë§ ' + mozo + '</p>';
        html += '</div>';
        html += '<div class="text-right">';
        html += '<p class="text-sm text-slate-500">‚è±Ô∏è ' + tiempo + '</p>';
        html += '</div>';
        html += '</div>';
        html += '<div class="bg-orange-50 rounded-lg p-4">';
        html += '<p class="text-sm text-slate-600 mb-2">üìù Items: <span class="font-bold">' + itemsCount + '</span></p>';
        html += '<p class="text-2xl font-black text-green-600">' + total.toFixed(2) + '</p>';
        html += '</div>';
        html += '<div class="mt-4 flex gap-2">';
        html += '<button onclick="abrirMesaActiva(' + mesa.numero + ')" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-blue-700">VER PEDIDO</button>';
        html += '<button onclick="cobrarMesaDirecta(' + mesa.numero + ')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-green-700">COBRAR</button>';
        html += '</div>';
        html += '</div>';
    }
    
    document.getElementById('lista-mesas-activas').innerHTML = html;
}

function abrirMesaActiva(numMesa) {
    console.log('=== ABRIR MESA ACTIVA ===');
    console.log('Numero de mesa:', numMesa);
    
    var mesa = db.mesas.find(function(m) { return m.numero === numMesa; });
    console.log('Mesa encontrada:', mesa);
    
    if (!mesa || mesa.estado !== 'ocupada') {
        alert('Esta mesa ya no esta activa');
        renderMesasActivas();
        return;
    }
    
    console.log('Cargando pedido con ID:', mesa.pedidoId);
    cargarPedidoExistente(mesa.pedidoId);
    
    console.log('Cambiando vistas...');
    document.getElementById('seccion-mesas-activas').classList.add('hidden');
    document.getElementById('seccion-pedido').classList.remove('hidden');
    document.getElementById('mesa-actual').textContent = 'MESA ' + numMesa;
    
    console.log('Renderizando menu...');
    renderMenuPOS();
    
    console.log('=== MESA ACTIVA ABIERTA ===');
}

function cobrarMesaDirecta(numMesa) {
    console.log('Cobrar mesa directa:', numMesa);
    abrirMesaActiva(numMesa);
    setTimeout(function() {
        cobrarPedido();
    }, 300);
}

function limpiarMesasVacias() {
    console.log('=== LIMPIAR MESAS VAC√çAS ===');
    
    // Pedir clave de administrador
    var clave = prompt('üîí Ingrese clave de ADMINISTRADOR para limpiar mesas vac√≠as:');
    
    if (!clave) {
        console.log('Operaci√≥n cancelada');
        return;
    }
    
    // Verificar clave de admin
    var admin = db.usuarios.find(function(u) { return u.rol === 'admin' && u.password === clave; });
    
    if (!admin) {
        alert('‚ùå Clave de administrador incorrecta');
        console.log('Clave incorrecta');
        return;
    }
    
    console.log('Clave correcta, buscando mesas vac√≠as...');
    
    // Buscar mesas ocupadas con total 0
    var mesasVacias = [];
    
    for (var i = 0; i < db.mesas.length; i++) {
        var mesa = db.mesas[i];
        if (mesa.estado === 'ocupada') {
            var pedido = db.pedidosActivos ? db.pedidosActivos[mesa.numero] : null;
            var total = pedido ? (pedido.total || 0) : 0;
            
            if (total === 0) {
                mesasVacias.push(mesa.numero);
            }
        }
    }
    
    console.log('Mesas vac√≠as encontradas:', mesasVacias);
    
    if (mesasVacias.length === 0) {
        alert('‚úÖ No hay mesas vac√≠as (S/. 0.00) para limpiar');
        return;
    }
    
    // Confirmar acci√≥n
    var confirmar = confirm('¬øSeguro que deseas ANULAR ' + mesasVacias.length + ' mesa(s) vac√≠a(s)?\n\nMesas: ' + mesasVacias.join(', '));
    
    if (!confirmar) {
        console.log('Operaci√≥n cancelada por usuario');
        return;
    }
    
    // Liberar mesas
    var liberadas = 0;
    for (var i = 0; i < mesasVacias.length; i++) {
        var numMesa = mesasVacias[i];
        
        // Buscar mesa y liberarla
        for (var j = 0; j < db.mesas.length; j++) {
            if (db.mesas[j].numero === numMesa) {
                db.mesas[j].estado = 'libre';
                db.mesas[j].pedidoId = null;
                liberadas++;
                break;
            }
        }
        
        // Eliminar de pedidos activos
        if (db.pedidosActivos && db.pedidosActivos[numMesa]) {
            delete db.pedidosActivos[numMesa];
        }
    }
    
    save();
    
    console.log('Mesas liberadas:', liberadas);
    alert('‚úÖ Se liberaron ' + liberadas + ' mesa(s) vac√≠a(s)\n\nMesas: ' + mesasVacias.join(', '));
    
    // Actualizar vista
    renderMesasActivas();
    actualizarIndicadoresMesas();
}

// ========== NAVEGACI√ìN POS ==========
function volverInicio() {
    pedidoActual = { tipo: null, mesa: null, items: [], total: 0, pedidoId: null };
    document.getElementById('seccion-calculadora-mesa').classList.add('hidden');
    document.getElementById('seccion-mesas-activas').classList.add('hidden');
    document.getElementById('seccion-pedido').classList.add('hidden');
    document.getElementById('selector-tipo-pedido').classList.remove('hidden');
    document.getElementById('items-pedido-actual').innerHTML = '';
    document.getElementById('total-pedido').textContent = '0.00';
    limpiarMesa();
    actualizarIndicadoresMesas();
}

function limpiarFiltroVentas() {
    // Limpiar campos de fecha
    document.getElementById('fecha-inicio-ventas').value = '';
    document.getElementById('fecha-fin-ventas').value = '';
    
    // Restaurar etiquetas originales
    document.getElementById('label-ventas-hoy').textContent = 'üíµ VENTAS HOY';
    document.getElementById('label-ventas-mes').textContent = 'üìÖ VENTAS MES';
    document.getElementById('label-total-ventas').textContent = 'üìä TOTAL VENTAS';
    document.getElementById('label-promedio-venta').textContent = 'üßæ PROMEDIO VENTA';
    
    // Renderizar con todas las ventas
    renderVentas();
}

// ========== RESETEAR HISTORIAL DE VENTAS ==========
function resetearHistorialVentas() {
    console.log('üóëÔ∏è Intentando resetear historial de ventas...');
    
    // PASO 1: Primera confirmaci√≥n
    var confirmacion1 = confirm(
        '‚ö†Ô∏è ADVERTENCIA: ACCI√ìN IRREVERSIBLE\n\n' +
        '¬øEst√°s seguro de que quieres ELIMINAR TODAS LAS VENTAS?\n\n' +
        'Esto borrar√°:\n' +
        '‚Ä¢ Todas las ventas del POS\n' +
        '‚Ä¢ Todo el historial de ventas\n' +
        '‚Ä¢ Datos de VENTAS y FINANZAS\n\n' +
        'Esta acci√≥n NO SE PUEDE DESHACER.\n\n' +
        '¬øDeseas continuar?'
    );
    
    if (!confirmacion1) {
        console.log('Reseteo cancelado por el usuario');
        return;
    }
    
    // PASO 2: Pedir clave del administrador usando MODAL BONITO
    accionPendienteClaveAdmin = function() {
        console.log('üîë Clave validada correctamente - Ejecutando acci√≥n de reseteo');
        
        // DIAGN√ìSTICO ANTES
        console.log('üîç ========== ANTES DEL RESETEO ==========');
        diagnosticarVentas();
        
        // Esta funci√≥n se ejecutar√° despu√©s de validar la clave correctamente
        
        // PASO 3: Confirmaci√≥n final
        var confirmacion2 = confirm(
            'üîê AUTENTICACI√ìN EXITOSA\n\n' +
            '‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\n' +
            'Ventas en db.ventas: ' + (db.ventas ? db.ventas.length : 0) + '\n' +
            'Ventas en historial: ' + (db.historialVentas ? db.historialVentas.length : 0) + '\n\n' +
            'Se eliminar√°n TODAS las ventas de ambas ubicaciones.\n\n' +
            '¬øProceder con el reseteo COMPLETO?'
        );
        
        console.log('üìã Confirmaci√≥n final:', confirmacion2 ? 'ACEPTADA' : 'CANCELADA');
        
        if (!confirmacion2) {
            console.log('Reseteo cancelado en confirmaci√≥n final');
            alert('‚ÑπÔ∏è Operaci√≥n cancelada\n\nNo se elimin√≥ ning√∫n dato.');
            return;
        }
        
        // PASO 4: Guardar estad√≠sticas antes de borrar (para el log)
        var ventasBorradas = db.ventas ? db.ventas.length : 0;
        var historialBorrado = db.historialVentas ? db.historialVentas.length : 0;
        var totalBorrado = ventasBorradas + historialBorrado;
        
        console.log('üìä ANTES DEL RESETEO:');
        console.log('  - db.ventas:', ventasBorradas, 'registros');
        console.log('  - db.historialVentas:', historialBorrado, 'registros');
        console.log('  - db.ventas array:', db.ventas);
        
        // PASO 5: RESETEAR TODO - MUY AGRESIVO
        console.log('üóëÔ∏è Vaciando arrays de forma agresiva...');
        
        // M√©todo 1: Asignar arrays vac√≠os
        db.ventas = [];
        db.historialVentas = [];
        
        // M√©todo 2: Eliminar propiedades y recrear
        delete db.ventas;
        delete db.historialVentas;
        db.ventas = [];
        db.historialVentas = [];
        
        console.log('üíæ Guardando en localStorage...');
        
        // PASO 6: Guardar en localStorage de forma agresiva
        save();
        
        // Forzar un segundo guardado
        localStorage.setItem('gastro_control_pro', JSON.stringify(db));
        
        console.log('‚úÖ RESETEO COMPLETADO');
        console.log('üìä DESPU√âS DEL RESETEO:');
        console.log('  - db.ventas:', db.ventas.length, 'registros');
        console.log('  - db.historialVentas:', db.historialVentas.length, 'registros');
        console.log('  - db.ventas array:', db.ventas);
        console.log('  - localStorage gastro_v14_pro:', localStorage.getItem('gastro_control_pro'));
        
        // DIAGN√ìSTICO DESPU√âS
        console.log('üîç ========== DESPU√âS DEL RESETEO ==========');
        diagnosticarVentas();
        
        // PASO 7: Actualizar vistas
        console.log('üîÑ Actualizando vistas...');
        renderVentas();
        if (document.getElementById('section-finanzas').classList.contains('hidden') === false) {
            calcularFinanzas();
        }
        
        console.log('‚úÖ Vistas actualizadas');
        
        // PASO 8: Mensaje de √©xito y recarga
        alert(
            '‚úÖ RESETEO COMPLETADO\n\n' +
            'Se eliminaron:\n' +
            '‚Ä¢ ' + ventasBorradas + ' ventas del POS\n' +
            '‚Ä¢ ' + historialBorrado + ' registros del historial\n' +
            '‚Ä¢ Total: ' + totalBorrado + ' registros eliminados\n\n' +
            'La p√°gina se recargar√° para asegurar que todo est√© limpio.'
        );
        
        // PASO 9: Recargar p√°gina para asegurar limpieza total
        setTimeout(function() {
            location.reload();
        }, 1000);
    };
    
    // Abrir modal de clave admin
    abrirModalClaveAdmin('Resetear Historial de Ventas');
}

// ========== ELIMINAR VENTA INDIVIDUAL ==========
function eliminarVentaIndividual(idVenta) {
    console.log('üóëÔ∏è Intentando eliminar venta individual:', idVenta);
    
    // Buscar la venta
    const ventaEnVentas = db.ventas ? db.ventas.find(v => v.id === idVenta) : null;
    const ventaEnHistorial = db.historialVentas ? db.historialVentas.find(v => v.id === idVenta) : null;
    
    if (!ventaEnVentas && !ventaEnHistorial) {
        alert('‚ùå No se encontr√≥ la venta');
        return;
    }
    
    const venta = ventaEnVentas || ventaEnHistorial;
    
    // Confirmaci√≥n
    const confirmar = confirm(
        '‚ö†Ô∏è ¬øELIMINAR ESTA VENTA?\n\n' +
        'Fecha: ' + new Date(venta.fecha).toLocaleString('es-PE') + '\n' +
        'Total: S/. ' + venta.total.toFixed(2) + '\n' +
        'Items: ' + venta.items.map(i => i.cantidad + 'x ' + i.nombre).join(', ') + '\n\n' +
        'Esta acci√≥n NO se puede deshacer.'
    );
    
    if (!confirmar) {
        console.log('Eliminaci√≥n cancelada');
        return;
    }
    
    // Eliminar de db.ventas
    if (db.ventas) {
        const indexVentas = db.ventas.findIndex(v => v.id === idVenta);
        if (indexVentas !== -1) {
            db.ventas.splice(indexVentas, 1);
            console.log('‚úÖ Venta eliminada de db.ventas');
        }
    }
    
    // Eliminar de db.historialVentas
    if (db.historialVentas) {
        const indexHistorial = db.historialVentas.findIndex(v => v.id === idVenta);
        if (indexHistorial !== -1) {
            db.historialVentas.splice(indexHistorial, 1);
            console.log('‚úÖ Venta eliminada de db.historialVentas');
        }
    }
    
    // Guardar cambios
    save();
    
    console.log('üíæ Cambios guardados');
    console.log('üìä Ventas restantes en db.ventas:', db.ventas.length);
    console.log('üìä Ventas restantes en historial:', db.historialVentas.length);
    
    // Actualizar vistas
    renderVentas();
    if (document.getElementById('section-finanzas').classList.contains('hidden') === false) {
        calcularFinanzas();
    }
    
    alert('‚úÖ Venta eliminada correctamente');
}

// ========== DIAGN√ìSTICO DE VENTAS ==========
function diagnosticarVentas() {
    console.log('üîç ========== DIAGN√ìSTICO DE VENTAS ==========');
    console.log('db.ventas existe:', !!db.ventas);
    console.log('db.ventas length:', db.ventas ? db.ventas.length : 0);
    console.log('db.historialVentas existe:', !!db.historialVentas);
    console.log('db.historialVentas length:', db.historialVentas ? db.historialVentas.length : 0);
    
    if (db.ventas && db.ventas.length > 0) {
        console.log('üìä VENTAS EN db.ventas:');
        db.ventas.forEach((v, i) => {
            console.log(`  ${i + 1}. ID: ${v.id} | Fecha: ${v.fecha} | Total: S/. ${v.total}`);
        });
    }
    
    if (db.historialVentas && db.historialVentas.length > 0) {
        console.log('üìä VENTAS EN db.historialVentas:');
        db.historialVentas.forEach((v, i) => {
            console.log(`  ${i + 1}. ID: ${v.id} | Fecha: ${v.fecha} | Total: S/. ${v.total}`);
        });
    }
    
    const stored = localStorage.getItem('gastro_control_pro');
    if (stored) {
        const parsed = JSON.parse(stored);
        console.log('üíæ EN LOCALSTORAGE:');
        console.log('  ventas:', parsed.ventas ? parsed.ventas.length : 0);
        console.log('  historialVentas:', parsed.historialVentas ? parsed.historialVentas.length : 0);
    }
    
    console.log('üîç ==========================================');
}

// ========== REPORTE DE VENTAS POR CATEGOR√çA ==========
function generarReporteCategorias() {
    console.log('üìä Generando reporte de categor√≠as...');
    
    var fechaInicio = document.getElementById('fecha-inicio-categorias').value;
    var fechaFin = document.getElementById('fecha-fin-categorias').value;
    
    if (!fechaInicio || !fechaFin) {
        alert('‚ö†Ô∏è Por favor selecciona ambas fechas para generar el reporte');
        return;
    }
    
    // Crear fechas en zona horaria local
    const [yInicio, mInicio, dInicio] = fechaInicio.split('-').map(Number);
    const inicio = new Date(yInicio, mInicio - 1, dInicio, 0, 0, 0, 0);
    
    const [yFin, mFin, dFin] = fechaFin.split('-').map(Number);
    const fin = new Date(yFin, mFin - 1, dFin, 23, 59, 59, 999);
    
    console.log('Per√≠odo:', inicio, 'a', fin);
    
    // Obtener todas las ventas del per√≠odo
    var todasLasVentas = [];
    if (db.historialVentas) {
        todasLasVentas = todasLasVentas.concat(db.historialVentas);
    }
    if (db.ventas) {
        db.ventas.forEach(function(v) {
            var existe = todasLasVentas.find(function(tv) { return tv.id === v.id; });
            if (!existe) {
                todasLasVentas.push(v);
            }
        });
    }
    
    // Filtrar ventas por per√≠odo
    var ventasPeriodo = todasLasVentas.filter(function(v) {
        var fechaVenta = new Date(v.fecha);
        return fechaVenta >= inicio && fechaVenta <= fin;
    });
    
    console.log('Ventas en per√≠odo:', ventasPeriodo.length);
    
    if (ventasPeriodo.length === 0) {
        document.getElementById('reporte-categorias-container').innerHTML = 
            '<p class="text-center text-slate-400 py-8">‚ùå No hay ventas en el per√≠odo seleccionado</p>';
        return;
    }
    
    // Agrupar ventas por categor√≠a y plato
    var ventasPorCategoria = {};
    
    ventasPeriodo.forEach(function(venta) {
        if (!venta.items) return;
        
        venta.items.forEach(function(item) {
            var plato = db.platos.find(function(p) { return p.sku === item.sku; });
            if (!plato) return;
            
            var categoria = plato.categoria || 'Sin Categor√≠a';
            
            if (!ventasPorCategoria[categoria]) {
                ventasPorCategoria[categoria] = {};
            }
            
            if (!ventasPorCategoria[categoria][item.nombre]) {
                ventasPorCategoria[categoria][item.nombre] = {
                    cantidad: 0,
                    precio: item.precio || 0,
                    total: 0
                };
            }
            
            ventasPorCategoria[categoria][item.nombre].cantidad += item.cantidad;
            ventasPorCategoria[categoria][item.nombre].total += item.cantidad * (item.precio || 0);
        });
    });
    
    // Generar HTML del reporte
    var html = '<div class="space-y-6">';
    
    // Resumen general
    html += '<div class="bg-gradient-to-r from-purple-100 to-pink-100 p-4 rounded-xl border-2 border-purple-300">';
    html += '<h4 class="font-black text-purple-700 mb-2">üìÖ PER√çODO ANALIZADO</h4>';
    html += '<p class="text-sm text-purple-600">Desde: ' + inicio.toLocaleDateString('es-PE') + ' | Hasta: ' + fin.toLocaleDateString('es-PE') + '</p>';
    html += '<p class="text-sm text-purple-600 mt-1">Total de ventas: ' + ventasPeriodo.length + '</p>';
    html += '</div>';
    
    // Ordenar categor√≠as alfab√©ticamente
    var categorias = Object.keys(ventasPorCategoria).sort();
    
    if (categorias.length === 0) {
        html += '<p class="text-center text-slate-400 py-4">No hay datos para mostrar</p>';
    }
    
    // Por cada categor√≠a
    categorias.forEach(function(categoria) {
        var platos = ventasPorCategoria[categoria];
        var platosArray = Object.keys(platos).map(function(nombre) {
            return {
                nombre: nombre,
                cantidad: platos[nombre].cantidad,
                precio: platos[nombre].precio,
                total: platos[nombre].total
            };
        });
        
        // Ordenar platos por cantidad vendida (descendente)
        platosArray.sort(function(a, b) { return b.cantidad - a.cantidad; });
        
        // Calcular totales de la categor√≠a
        var totalCantidad = platosArray.reduce(function(sum, p) { return sum + p.cantidad; }, 0);
        var totalVentas = platosArray.reduce(function(sum, p) { return sum + p.total; }, 0);
        
        // Card de la categor√≠a
        html += '<div class="bg-white border-2 border-purple-200 rounded-xl overflow-hidden">';
        
        // Header de la categor√≠a
        html += '<div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4">';
        html += '<div class="flex justify-between items-center">';
        html += '<h4 class="font-black text-lg">üçΩÔ∏è ' + categoria.toUpperCase() + '</h4>';
        html += '<div class="text-right">';
        html += '<p class="text-xs opacity-90">Total vendido</p>';
        html += '<p class="font-black text-xl">' + totalCantidad + ' unidades</p>';
        html += '<p class="text-sm">S/. ' + totalVentas.toFixed(2) + '</p>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        
        // Tabla de platos
        html += '<div class="overflow-x-auto">';
        html += '<table class="w-full text-sm">';
        html += '<thead class="bg-purple-50">';
        html += '<tr>';
        html += '<th class="p-3 text-left font-bold text-purple-700">PLATO</th>';
        html += '<th class="p-3 text-center font-bold text-purple-700">CANTIDAD</th>';
        html += '<th class="p-3 text-right font-bold text-purple-700">PRECIO</th>';
        html += '<th class="p-3 text-right font-bold text-purple-700">TOTAL</th>';
        html += '<th class="p-3 text-center font-bold text-purple-700">%</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';
        
        platosArray.forEach(function(plato, index) {
            var porcentaje = (plato.cantidad / totalCantidad * 100).toFixed(1);
            var bgClass = index % 2 === 0 ? 'bg-white' : 'bg-purple-50';
            
            html += '<tr class="' + bgClass + ' hover:bg-purple-100 transition-colors">';
            html += '<td class="p-3 font-semibold">' + plato.nombre + '</td>';
            html += '<td class="p-3 text-center font-bold text-purple-600">' + plato.cantidad + '</td>';
            html += '<td class="p-3 text-right">S/. ' + plato.precio.toFixed(2) + '</td>';
            html += '<td class="p-3 text-right font-bold">S/. ' + plato.total.toFixed(2) + '</td>';
            html += '<td class="p-3 text-center">';
            html += '<span class="px-2 py-1 bg-purple-200 text-purple-700 rounded-full text-xs font-bold">' + porcentaje + '%</span>';
            html += '</td>';
            html += '</tr>';
        });
        
        html += '</tbody>';
        html += '</table>';
        html += '</div>';
        html += '</div>';
    });
    
    html += '</div>';
    
    document.getElementById('reporte-categorias-container').innerHTML = html;
    console.log('‚úÖ Reporte generado exitosamente');
}

function limpiarReporteCategorias() {
    document.getElementById('fecha-inicio-categorias').value = '';
    document.getElementById('fecha-fin-categorias').value = '';
    document.getElementById('reporte-categorias-container').innerHTML = 
        '<p class="text-center text-slate-400 py-8">üìä Selecciona un per√≠odo y haz click en "GENERAR REPORTE"</p>';
}

function exportarReporteCategorias() {
    console.log('üìÑ Exportando reporte de categor√≠as a PDF...');
    
    // Funci√≥n auxiliar para limpiar texto de caracteres especiales
    function limpiarTextoParaPDF(texto) {
        if (!texto) return '';
        return texto
            .replace(/√°/g, 'a')
            .replace(/√©/g, 'e')
            .replace(/√≠/g, 'i')
            .replace(/√≥/g, 'o')
            .replace(/√∫/g, 'u')
            .replace(/√Å/g, 'A')
            .replace(/√â/g, 'E')
            .replace(/√ç/g, 'I')
            .replace(/√ì/g, 'O')
            .replace(/√ö/g, 'U')
            .replace(/√±/g, 'n')
            .replace(/√ë/g, 'N')
            .replace(/[^\x00-\x7F]/g, ''); // Remover cualquier otro caracter no ASCII (incluye emojis)
    }
    
    // Verificar si jsPDF est√° disponible
    if (typeof window.jspdf === 'undefined') {
        alert('‚ùå No se puede generar el PDF\n\nLa librer√≠a jsPDF no est√° disponible.');
        return;
    }
    
    var fechaInicio = document.getElementById('fecha-inicio-categorias').value;
    var fechaFin = document.getElementById('fecha-fin-categorias').value;
    
    if (!fechaInicio || !fechaFin) {
        alert('‚ö†Ô∏è Por favor genera el reporte primero\n\nSelecciona fechas y haz click en "GENERAR REPORTE"');
        return;
    }
    
    try {
        // Crear fechas en zona horaria local
        const [yInicio, mInicio, dInicio] = fechaInicio.split('-').map(Number);
        const inicio = new Date(yInicio, mInicio - 1, dInicio, 0, 0, 0, 0);
        
        const [yFin, mFin, dFin] = fechaFin.split('-').map(Number);
        const fin = new Date(yFin, mFin - 1, dFin, 23, 59, 59, 999);
        
        // Obtener todas las ventas del per√≠odo
        var todasLasVentas = [];
        if (db.historialVentas) {
            todasLasVentas = todasLasVentas.concat(db.historialVentas);
        }
        if (db.ventas) {
            db.ventas.forEach(function(v) {
                var existe = todasLasVentas.find(function(tv) { return tv.id === v.id; });
                if (!existe) {
                    todasLasVentas.push(v);
                }
            });
        }
        
        // Filtrar ventas por per√≠odo
        var ventasPeriodo = todasLasVentas.filter(function(v) {
            var fechaVenta = new Date(v.fecha);
            return fechaVenta >= inicio && fechaVenta <= fin;
        });
        
        if (ventasPeriodo.length === 0) {
            alert('‚ùå No hay datos para exportar\n\nNo se encontraron ventas en el per√≠odo seleccionado.');
            return;
        }
        
        // Agrupar ventas por categor√≠a y plato
        var ventasPorCategoria = {};
        
        ventasPeriodo.forEach(function(venta) {
            if (!venta.items) return;
            
            venta.items.forEach(function(item) {
                var plato = db.platos.find(function(p) { return p.sku === item.sku; });
                if (!plato) return;
                
                var categoria = plato.categoria || 'Sin Categor√≠a';
                
                if (!ventasPorCategoria[categoria]) {
                    ventasPorCategoria[categoria] = {};
                }
                
                if (!ventasPorCategoria[categoria][item.nombre]) {
                    ventasPorCategoria[categoria][item.nombre] = {
                        cantidad: 0,
                        precio: item.precio || 0,
                        total: 0
                    };
                }
                
                ventasPorCategoria[categoria][item.nombre].cantidad += item.cantidad;
                ventasPorCategoria[categoria][item.nombre].total += item.cantidad * (item.precio || 0);
            });
        });
        
        // CREAR PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let y = 20;
        
        // HEADER
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text('SWISSOTEL', pageWidth / 2, y, { align: 'center' });
        
        y += 8;
        doc.setFontSize(14);
        doc.text('REPORTE DE VENTAS POR CATEGORIA', pageWidth / 2, y, { align: 'center' });
        
        y += 8;
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('Periodo: ' + inicio.toLocaleDateString('es-PE') + ' al ' + fin.toLocaleDateString('es-PE'), pageWidth / 2, y, { align: 'center' });
        
        y += 4;
        doc.text('Generado: ' + new Date().toLocaleDateString('es-PE') + ' ' + new Date().toLocaleTimeString('es-PE'), pageWidth / 2, y, { align: 'center' });
        
        y += 4;
        doc.text('Total de ventas: ' + ventasPeriodo.length, pageWidth / 2, y, { align: 'center' });
        
        y += 6;
        doc.setLineWidth(0.5);
        doc.line(margin, y, pageWidth - margin, y);
        y += 8;
        
        // Por cada categor√≠a
        var categorias = Object.keys(ventasPorCategoria).sort();
        
        categorias.forEach(function(categoria, catIndex) {
            var platos = ventasPorCategoria[categoria];
            var platosArray = Object.keys(platos).map(function(nombre) {
                return {
                    nombre: nombre,
                    cantidad: platos[nombre].cantidad,
                    precio: platos[nombre].precio,
                    total: platos[nombre].total
                };
            });
            
            // Ordenar por cantidad vendida
            platosArray.sort(function(a, b) { return b.cantidad - a.cantidad; });
            
            // Calcular totales
            var totalCantidad = platosArray.reduce(function(sum, p) { return sum + p.cantidad; }, 0);
            var totalVentas = platosArray.reduce(function(sum, p) { return sum + p.total; }, 0);
            
            // Verificar espacio disponible
            if (y > pageHeight - 60) {
                doc.addPage();
                y = 20;
            }
            
            // Header de categor√≠a
            doc.setFillColor(147, 51, 234); // purple-600
            doc.rect(margin, y - 5, pageWidth - 2 * margin, 10, 'F');
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(255, 255, 255);
            doc.text(limpiarTextoParaPDF(categoria).toUpperCase(), margin + 3, y);
            doc.text(totalCantidad + ' unidades - S/. ' + totalVentas.toFixed(2), pageWidth - margin - 3, y, { align: 'right' });
            doc.setTextColor(0, 0, 0);
            
            y += 10;
            
            // Tabla de platos
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text('PLATO', margin + 2, y);
            doc.text('CANT.', pageWidth - margin - 65, y, { align: 'right' });
            doc.text('PRECIO', pageWidth - margin - 45, y, { align: 'right' });
            doc.text('TOTAL', pageWidth - margin - 20, y, { align: 'right' });
            doc.text('%', pageWidth - margin - 5, y, { align: 'right' });
            
            y += 2;
            doc.setLineWidth(0.3);
            doc.line(margin, y, pageWidth - margin, y);
            y += 4;
            
            doc.setFont(undefined, 'normal');
            platosArray.forEach(function(plato) {
                // Verificar espacio
                if (y > pageHeight - 20) {
                    doc.addPage();
                    y = 20;
                }
                
                var porcentaje = (plato.cantidad / totalCantidad * 100).toFixed(1);
                
                // Truncar nombre si es muy largo
                var nombreLimpio = limpiarTextoParaPDF(plato.nombre);
                var nombreCorto = nombreLimpio.length > 35 ? nombreLimpio.substring(0, 35) + '...' : nombreLimpio;
                
                doc.text(nombreCorto, margin + 2, y);
                doc.text(plato.cantidad.toString(), pageWidth - margin - 65, y, { align: 'right' });
                doc.text('S/. ' + plato.precio.toFixed(2), pageWidth - margin - 45, y, { align: 'right' });
                doc.text('S/. ' + plato.total.toFixed(2), pageWidth - margin - 20, y, { align: 'right' });
                doc.text(porcentaje + '%', pageWidth - margin - 5, y, { align: 'right' });
                
                y += 5;
            });
            
            y += 5;
        });
        
        // FOOTER
        var numPages = doc.internal.getNumberOfPages();
        for (var i = 1; i <= numPages; i++) {
            doc.setPage(i);
            doc.setFontSize(7);
            doc.setFont(undefined, 'italic');
            doc.text('Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego - P√°gina ' + i + ' de ' + numPages, pageWidth / 2, pageHeight - 10, { align: 'center' });
        }
        
        // GUARDAR
        var nombreArchivo = 'Reporte_Categorias_' + fechaInicio + '_' + fechaFin + '.pdf';
        doc.save(nombreArchivo);
        
        console.log('‚úÖ PDF exportado:', nombreArchivo);
        alert('‚úÖ PDF exportado exitosamente\n\nArchivo: ' + nombreArchivo);
        
    } catch (error) {
        console.error('‚ùå Error al exportar PDF:', error);
        alert('‚ùå Error al exportar PDF\n\n' + error.message);
    }
}

// ========================================
// FUNCIONES DEL DASHBOARD GASTRON√ìMICO
// ========================================

// Variables globales para gr√°ficos
var chartCategoriaFC = null;
var chartAreaFC = null;

// Funci√≥n principal para actualizar todo el dashboard
function actualizarDashboard() {
    console.log('üîÑ Actualizando Dashboard...');
    
    calcularKPIs();
    calcularTopProductos();
    calcularAnalisisPorCategoria();
    calcularAnalisisPorArea();
    calcularAlertas();
    calcularInsights();
    
    console.log('‚úÖ Dashboard actualizado');
}

// ========== 1. CALCULAR KPIs PRINCIPALES ==========
function calcularKPIs() {
    const platos = db.platos || [];
    
    if (platos.length === 0) {
        document.getElementById('kpi-food-cost').textContent = '0%';
        document.getElementById('kpi-beverage-cost').textContent = '0%';
        document.getElementById('kpi-liquor-cost').textContent = '0%';
        document.getElementById('kpi-total-productos').textContent = '0';
        document.getElementById('kpi-valor-inventario').textContent = 'S/. 0';
        document.getElementById('kpi-margen-promedio').textContent = '0%';
        return;
    }
    
    // Separar por tipo de costo
    let foodPlatos = [];
    let beveragePlatos = [];
    let liquorPlatos = [];
    
    platos.forEach(p => {
        const categoria = (p.categoria || '').toUpperCase();
        const tipoCosto = obtenerTipoCosto(categoria);
        
        if (tipoCosto === 'FOOD') {
            foodPlatos.push(p);
        } else if (tipoCosto === 'BEVERAGE') {
            beveragePlatos.push(p);
        } else if (tipoCosto === 'LIQUOR') {
            liquorPlatos.push(p);
        }
    });
    
    // Calcular promedios
    const avgFoodCost = foodPlatos.length > 0 
        ? foodPlatos.reduce((sum, p) => sum + (p.fcPorcentaje || 0), 0) / foodPlatos.length 
        : 0;
    
    const avgBeverageCost = beveragePlatos.length > 0 
        ? beveragePlatos.reduce((sum, p) => sum + (p.fcPorcentaje || 0), 0) / beveragePlatos.length 
        : 0;
    
    const avgLiquorCost = liquorPlatos.length > 0 
        ? liquorPlatos.reduce((sum, p) => sum + (p.fcPorcentaje || 0), 0) / liquorPlatos.length 
        : 0;
    
    // Valor del inventario
    let valorInventario = 0;
    (db.materiales || []).forEach(m => {
        const stockUnidadCosto = db.inventario[m.sku] || 0;
        const precioUnitario = m.precio / m.factor;
        valorInventario += stockUnidadCosto * precioUnitario;
    });
    
    // Margen promedio (100% - FC%)
    const avgFC = platos.reduce((sum, p) => sum + (p.fcPorcentaje || 0), 0) / platos.length;
    const margenPromedio = 100 - avgFC;
    
    // Actualizar UI
    document.getElementById('kpi-food-cost').textContent = avgFoodCost.toFixed(1) + '%';
    document.getElementById('kpi-beverage-cost').textContent = avgBeverageCost.toFixed(1) + '%';
    document.getElementById('kpi-liquor-cost').textContent = avgLiquorCost.toFixed(1) + '%';
    document.getElementById('kpi-total-productos').textContent = platos.length;
    document.getElementById('kpi-valor-inventario').textContent = 'S/. ' + valorInventario.toFixed(2);
    document.getElementById('kpi-margen-promedio').textContent = margenPromedio.toFixed(1) + '%';
}

// ========== 2. CALCULAR TOP PRODUCTOS ==========
function calcularTopProductos() {
    const platos = db.platos || [];
    
    if (platos.length === 0) {
        document.getElementById('top-rentables').innerHTML = '<p class="text-slate-400 italic">No hay productos</p>';
        document.getElementById('top-menos-rentables').innerHTML = '<p class="text-slate-400 italic">No hay productos</p>';
        return;
    }
    
    // Ordenar por FC% (menor = m√°s rentable)
    const platosOrdenados = [...platos].sort((a, b) => (a.fcPorcentaje || 100) - (b.fcPorcentaje || 100));
    
    // Top 10 m√°s rentables (menor FC%)
    const topRentables = platosOrdenados.slice(0, 10);
    let htmlRentables = '<div class="space-y-2">';
    topRentables.forEach((p, i) => {
        const fcColor = p.fcPorcentaje < 25 ? 'text-emerald-600' : p.fcPorcentaje < 30 ? 'text-green-600' : 'text-yellow-600';
        htmlRentables += `
            <div class="flex items-center justify-between p-2 rounded-lg bg-emerald-50 border border-emerald-200">
                <div class="flex items-center gap-2">
                    <span class="font-black text-emerald-700 text-xs">#${i + 1}</span>
                    <span class="text-xs font-semibold text-slate-700">${p.nombre}</span>
                </div>
                <span class="font-black ${fcColor} text-sm">${(p.fcPorcentaje || 0).toFixed(1)}%</span>
            </div>
        `;
    });
    htmlRentables += '</div>';
    document.getElementById('top-rentables').innerHTML = htmlRentables;
    
    // Top 10 menos rentables (mayor FC%)
    const topMenosRentables = platosOrdenados.reverse().slice(0, 10);
    let htmlMenosRentables = '<div class="space-y-2">';
    topMenosRentables.forEach((p, i) => {
        const fcColor = p.fcPorcentaje > 35 ? 'text-red-600' : p.fcPorcentaje > 30 ? 'text-orange-600' : 'text-yellow-600';
        htmlMenosRentables += `
            <div class="flex items-center justify-between p-2 rounded-lg bg-red-50 border border-red-200">
                <div class="flex items-center gap-2">
                    <span class="font-black text-red-700 text-xs">#${i + 1}</span>
                    <span class="text-xs font-semibold text-slate-700">${p.nombre}</span>
                </div>
                <span class="font-black ${fcColor} text-sm">${(p.fcPorcentaje || 0).toFixed(1)}%</span>
            </div>
        `;
    });
    htmlMenosRentables += '</div>';
    document.getElementById('top-menos-rentables').innerHTML = htmlMenosRentables;
}

// ========== 3. AN√ÅLISIS POR CATEGOR√çA ==========
function calcularAnalisisPorCategoria() {
    const platos = db.platos || [];
    
    if (platos.length === 0) {
        document.getElementById('tabla-categorias').innerHTML = '<p class="text-slate-400 italic">No hay productos</p>';
        if (chartCategoriaFC) chartCategoriaFC.destroy();
        return;
    }
    
    // Agrupar por categor√≠a
    const categorias = {};
    platos.forEach(p => {
        const cat = p.categoria || 'SIN CATEGOR√çA';
        if (!categorias[cat]) {
            categorias[cat] = {
                nombre: cat,
                productos: [],
                totalFC: 0,
                count: 0
            };
        }
        categorias[cat].productos.push(p);
        categorias[cat].totalFC += (p.fcPorcentaje || 0);
        categorias[cat].count++;
    });
    
    // Calcular promedios
    const categoriasArray = Object.values(categorias).map(c => ({
        nombre: c.nombre,
        count: c.count,
        avgFC: c.totalFC / c.count
    })).sort((a, b) => a.avgFC - b.avgFC);
    
    // Generar tabla
    let htmlTabla = '<table class="w-full text-xs">';
    htmlTabla += '<thead class="bg-purple-100"><tr><th class="p-2 text-left">CATEGOR√çA</th><th class="p-2 text-center">PRODUCTOS</th><th class="p-2 text-right">FC% PROM.</th></tr></thead>';
    htmlTabla += '<tbody>';
    categoriasArray.forEach(c => {
        const fcColor = c.avgFC < 25 ? 'text-emerald-600' : c.avgFC < 30 ? 'text-green-600' : c.avgFC < 35 ? 'text-yellow-600' : 'text-red-600';
        htmlTabla += `
            <tr class="border-b border-purple-100">
                <td class="p-2 font-semibold">${c.nombre}</td>
                <td class="p-2 text-center">${c.count}</td>
                <td class="p-2 text-right font-black ${fcColor}">${c.avgFC.toFixed(1)}%</td>
            </tr>
        `;
    });
    htmlTabla += '</tbody></table>';
    document.getElementById('tabla-categorias').innerHTML = htmlTabla;
    
    // Generar gr√°fico HORIZONTAL con altura din√°mica
    const ctx = document.getElementById('chart-categoria-fc');
    if (chartCategoriaFC) chartCategoriaFC.destroy();
    
    // Ajustar altura del canvas seg√∫n cantidad de categor√≠as (40px por categor√≠a)
    const alturaCanvas = Math.max(300, categoriasArray.length * 40);
    ctx.parentElement.style.minHeight = alturaCanvas + 'px';
    
    chartCategoriaFC = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: categoriasArray.map(c => c.nombre),
            datasets: [{
                label: 'Food Cost %',
                data: categoriasArray.map(c => c.avgFC),
                backgroundColor: categoriasArray.map(c => 
                    c.avgFC < 25 ? 'rgba(16, 185, 129, 0.8)' : 
                    c.avgFC < 30 ? 'rgba(34, 197, 94, 0.8)' : 
                    c.avgFC < 35 ? 'rgba(251, 191, 36, 0.8)' : 
                    'rgba(239, 68, 68, 0.8)'
                ),
                borderColor: categoriasArray.map(c => 
                    c.avgFC < 25 ? 'rgba(16, 185, 129, 1)' : 
                    c.avgFC < 30 ? 'rgba(34, 197, 94, 1)' : 
                    c.avgFC < 35 ? 'rgba(251, 191, 36, 1)' : 
                    'rgba(239, 68, 68, 1)'
                ),
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y', // GR√ÅFICO HORIZONTAL
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 50,
                    ticks: {
                        callback: function(value) { return value + '%'; }
                    }
                }
            }
        }
    });
}

// ========== 4. AN√ÅLISIS POR √ÅREA ==========
function calcularAnalisisPorArea() {
    const platos = db.platos || [];
    
    if (platos.length === 0) {
        document.getElementById('tabla-areas').innerHTML = '<p class="text-slate-400 italic">No hay productos</p>';
        if (chartAreaFC) chartAreaFC.destroy();
        return;
    }
    
    // Agrupar por √°rea
    const areas = {};
    platos.forEach(p => {
        const area = p.cocina || 'SIN √ÅREA';
        if (!areas[area]) {
            areas[area] = {
                nombre: area,
                productos: [],
                totalFC: 0,
                count: 0
            };
        }
        areas[area].productos.push(p);
        areas[area].totalFC += (p.fcPorcentaje || 0);
        areas[area].count++;
    });
    
    // Calcular promedios
    const areasArray = Object.values(areas).map(a => ({
        nombre: a.nombre,
        count: a.count,
        avgFC: a.totalFC / a.count
    })).sort((a, b) => a.avgFC - b.avgFC);
    
    // Generar tabla
    let htmlTabla = '<table class="w-full text-xs">';
    htmlTabla += '<thead class="bg-teal-100"><tr><th class="p-2 text-left">√ÅREA</th><th class="p-2 text-center">PRODUCTOS</th><th class="p-2 text-right">FC% PROM.</th></tr></thead>';
    htmlTabla += '<tbody>';
    areasArray.forEach(a => {
        const fcColor = a.avgFC < 25 ? 'text-emerald-600' : a.avgFC < 30 ? 'text-green-600' : a.avgFC < 35 ? 'text-yellow-600' : 'text-red-600';
        const emoji = emojisAreas[a.nombre] || 'üè¢';
        htmlTabla += `
            <tr class="border-b border-teal-100">
                <td class="p-2 font-semibold">${emoji} ${a.nombre}</td>
                <td class="p-2 text-center">${a.count}</td>
                <td class="p-2 text-right font-black ${fcColor}">${a.avgFC.toFixed(1)}%</td>
            </tr>
        `;
    });
    htmlTabla += '</tbody></table>';
    document.getElementById('tabla-areas').innerHTML = htmlTabla;
    
    // Generar gr√°fico HORIZONTAL con altura din√°mica
    const ctx = document.getElementById('chart-area-fc');
    if (chartAreaFC) chartAreaFC.destroy();
    
    // Ajustar altura del canvas seg√∫n cantidad de √°reas (40px por √°rea)
    const alturaCanvas = Math.max(300, areasArray.length * 40);
    ctx.parentElement.style.minHeight = alturaCanvas + 'px';
    
    chartAreaFC = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: areasArray.map(a => a.nombre),
            datasets: [{
                label: 'Food Cost %',
                data: areasArray.map(a => a.avgFC),
                backgroundColor: areasArray.map(a => 
                    a.avgFC < 25 ? 'rgba(16, 185, 129, 0.8)' : 
                    a.avgFC < 30 ? 'rgba(34, 197, 94, 0.8)' : 
                    a.avgFC < 35 ? 'rgba(251, 191, 36, 0.8)' : 
                    'rgba(239, 68, 68, 0.8)'
                ),
                borderColor: areasArray.map(a => 
                    a.avgFC < 25 ? 'rgba(16, 185, 129, 1)' : 
                    a.avgFC < 30 ? 'rgba(34, 197, 94, 1)' : 
                    a.avgFC < 35 ? 'rgba(251, 191, 36, 1)' : 
                    'rgba(239, 68, 68, 1)'
                ),
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y', // GR√ÅFICO HORIZONTAL
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 50,
                    ticks: {
                        callback: function(value) { return value + '%'; }
                    }
                }
            }
        }
    });
}

// ========== 5. CALCULAR ALERTAS ==========
function calcularAlertas() {
    const platos = db.platos || [];
    const materiales = db.materiales || [];
    const recetasBase = db.recetasBase || [];
    
    // Platos con FC alto (> 35%)
    const fcAlto = platos.filter(p => (p.fcPorcentaje || 0) > 35).length;
    document.getElementById('alerta-fc-alto').textContent = fcAlto;
    
    // Platos con FC medio (30-35%)
    const fcMedio = platos.filter(p => {
        const fc = p.fcPorcentaje || 0;
        return fc >= 30 && fc <= 35;
    }).length;
    document.getElementById('alerta-fc-medio').textContent = fcMedio;
    
    // Platos sin precio
    const sinPrecio = platos.filter(p => !p.precioMenu || p.precioMenu <= 0).length;
    document.getElementById('alerta-sin-precio').textContent = sinPrecio;
    
    // Materiales sin stock
    const sinStock = materiales.filter(m => {
        const stock = db.inventario[m.sku] || 0;
        return stock <= 0;
    }).length;
    document.getElementById('alerta-sin-stock').textContent = sinStock;
    
    // Materiales con stock bajo (< 1 unidad de compra)
    const stockBajo = materiales.filter(m => {
        const stockUnidadCosto = db.inventario[m.sku] || 0;
        const stockUnidadCompra = stockUnidadCosto / m.factor;
        return stockUnidadCompra > 0 && stockUnidadCompra < 1;
    }).length;
    document.getElementById('alerta-stock-bajo').textContent = stockBajo;
    
    // Recetas base sin usar
    const rbSinUsar = recetasBase.filter(rb => {
        const usada = platos.some(p => 
            p.componentes && p.componentes.some(c => c.nombre === rb.nombre)
        );
        return !usada;
    }).length;
    document.getElementById('alerta-rb-sin-usar').textContent = rbSinUsar;
}

// ========== 6. CALCULAR INSIGHTS ==========
function calcularInsights() {
    const platos = db.platos || [];
    
    if (platos.length === 0) {
        document.getElementById('insight-estrella').textContent = '-';
        document.getElementById('insight-revisar').textContent = '-';
        document.getElementById('insight-categoria-top').textContent = '-';
        document.getElementById('insight-area-top').textContent = '-';
        return;
    }
    
    // Producto estrella (menor FC%)
    const estrella = [...platos].sort((a, b) => (a.fcPorcentaje || 100) - (b.fcPorcentaje || 100))[0];
    document.getElementById('insight-estrella').textContent = 
        `${estrella.nombre} (${(estrella.fcPorcentaje || 0).toFixed(1)}% FC)`;
    
    // Producto a revisar (mayor FC%)
    const revisar = [...platos].sort((a, b) => (b.fcPorcentaje || 0) - (a.fcPorcentaje || 0))[0];
    document.getElementById('insight-revisar').textContent = 
        `${revisar.nombre} (${(revisar.fcPorcentaje || 0).toFixed(1)}% FC)`;
    
    // Categor√≠a m√°s rentable
    const categorias = {};
    platos.forEach(p => {
        const cat = p.categoria || 'SIN CATEGOR√çA';
        if (!categorias[cat]) {
            categorias[cat] = { totalFC: 0, count: 0 };
        }
        categorias[cat].totalFC += (p.fcPorcentaje || 0);
        categorias[cat].count++;
    });
    
    const categoriasArray = Object.keys(categorias).map(cat => ({
        nombre: cat,
        avgFC: categorias[cat].totalFC / categorias[cat].count
    })).sort((a, b) => a.avgFC - b.avgFC);
    
    if (categoriasArray.length > 0) {
        const catTop = categoriasArray[0];
        document.getElementById('insight-categoria-top').textContent = 
            `${catTop.nombre} (${catTop.avgFC.toFixed(1)}% FC)`;
    }
    
    // √Årea m√°s rentable
    const areas = {};
    platos.forEach(p => {
        const area = p.cocina || 'SIN √ÅREA';
        if (!areas[area]) {
            areas[area] = { totalFC: 0, count: 0 };
        }
        areas[area].totalFC += (p.fcPorcentaje || 0);
        areas[area].count++;
    });
    
    const areasArray = Object.keys(areas).map(area => ({
        nombre: area,
        avgFC: areas[area].totalFC / areas[area].count
    })).sort((a, b) => a.avgFC - b.avgFC);
    
    if (areasArray.length > 0) {
        const areaTop = areasArray[0];
        const emoji = emojisAreas[areaTop.nombre] || 'üè¢';
        document.getElementById('insight-area-top').textContent = 
            `${emoji} ${areaTop.nombre} (${areaTop.avgFC.toFixed(1)}% FC)`;
    }
}

// ========================================
// FUNCIONES DE EVENTOS Y BANQUETES
// ========================================

// Variable global para el evento actual
let eventoActual = {
    nombre: '',
    fecha: '',
    paxTotal: 100,
    platos: [] // { sku, nombre, pax, costoUnitario, costoTotal, fcPorcentaje }
};

// ========== FUNCI√ìN: CAMBIAR TABS ==========
function mostrarTabEvento(tab) {
    // Actualizar botones
    document.getElementById('tab-crear-evento').classList.remove('tab-evento-active');
    document.getElementById('tab-guardados-evento').classList.remove('tab-evento-active');
    
    if (tab === 'crear') {
        document.getElementById('tab-crear-evento').classList.add('tab-evento-active');
        document.getElementById('contenido-crear-evento').classList.remove('hidden');
        document.getElementById('contenido-guardados-evento').classList.add('hidden');
    } else {
        document.getElementById('tab-guardados-evento').classList.add('tab-evento-active');
        document.getElementById('contenido-crear-evento').classList.add('hidden');
        document.getElementById('contenido-guardados-evento').classList.remove('hidden');
        renderEventosGuardados();
    }
}

// ========== FUNCI√ìN: BUSCAR PLATOS PARA EVENTO ==========
function buscarPlatoEvento() {
    const busqueda = document.getElementById('evento-buscar-plato').value.toLowerCase();
    const sugerencias = document.getElementById('evento-sugerencias-platos');
    
    if (busqueda.length < 2) {
        sugerencias.classList.add('hidden');
        return;
    }
    
    const platos = db.platos || [];
    const platosEncontrados = platos.filter(p => 
        p.nombre.toLowerCase().includes(busqueda)
    ).slice(0, 10);
    
    if (platosEncontrados.length === 0) {
        sugerencias.classList.add('hidden');
        return;
    }
    
    let html = '<div class="p-2">';
    platosEncontrados.forEach(p => {
        const costo = p.costoReceta || 0;
        const fc = p.fcPorcentaje || 0;
        const fcColor = fc < 25 ? 'text-emerald-600' : fc < 30 ? 'text-green-600' : fc < 35 ? 'text-yellow-600' : 'text-red-600';
        
        html += `
            <div onclick="seleccionarPlatoEvento('${p.sku}')" class="p-3 hover:bg-blue-50 cursor-pointer rounded-lg border-b border-blue-100 transition-all">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm text-slate-800">${p.nombre}</p>
                        <p class="text-xs text-slate-500">${p.categoria || 'Sin categor√≠a'}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-sm text-slate-700">S/. ${costo.toFixed(2)}</p>
                        <p class="text-xs font-bold ${fcColor}">FC: ${fc.toFixed(1)}%</p>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    sugerencias.innerHTML = html;
    sugerencias.classList.remove('hidden');
}

// ========== FUNCI√ìN: SELECCIONAR PLATO PARA EVENTO ==========
function seleccionarPlatoEvento(sku) {
    const plato = db.platos.find(p => p.sku === sku);
    if (!plato) {
        alert('‚ö†Ô∏è Plato no encontrado');
        return;
    }
    
    const pax = parseInt(document.getElementById('evento-pax-plato').value) || 1;
    
    // Verificar si ya est√° agregado
    const yaAgregado = eventoActual.platos.find(p => p.sku === sku);
    if (yaAgregado) {
        alert('‚ö†Ô∏è Este plato ya est√° agregado al evento. Puedes editar la cantidad desde la tabla.');
        return;
    }
    
    // Agregar plato al evento
    const costoUnitario = plato.costoReceta || 0;
    const costoTotal = costoUnitario * pax;
    
    eventoActual.platos.push({
        sku: sku,
        nombre: plato.nombre,
        pax: pax,
        costoUnitario: costoUnitario,
        costoTotal: costoTotal,
        fcPorcentaje: plato.fcPorcentaje || 0
    });
    
    // Limpiar b√∫squeda
    document.getElementById('evento-buscar-plato').value = '';
    document.getElementById('evento-sugerencias-platos').classList.add('hidden');
    
    // Actualizar tabla y resumen
    renderTablaPlatosEvento();
    calcularResumenEvento();
    
    console.log('‚úÖ Plato agregado al evento:', plato.nombre, 'x', pax, 'PAX');
}

// ========== FUNCI√ìN: RENDERIZAR TABLA DE PLATOS DEL EVENTO ==========
function renderTablaPlatosEvento() {
    const tbody = document.getElementById('evento-platos-tabla');
    
    if (eventoActual.platos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="p-8 text-center text-slate-400 italic">
                    <span class="text-4xl mb-2 block opacity-50">üçΩÔ∏è</span>
                    No hay platos agregados. Busca y selecciona platos arriba.
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    eventoActual.platos.forEach((p, index) => {
        const fcColor = p.fcPorcentaje < 25 ? 'text-emerald-600' : p.fcPorcentaje < 30 ? 'text-green-600' : p.fcPorcentaje < 35 ? 'text-yellow-600' : 'text-red-600';
        
        html += `
            <tr class="hover:bg-emerald-50 transition-all">
                <td class="p-3 font-semibold text-slate-800">${p.nombre}</td>
                <td class="p-3 text-center">
                    <input type="number" value="${p.pax}" min="1" class="w-20 p-2 border-2 border-emerald-300 rounded-lg text-center font-bold focus:border-emerald-500 focus:outline-none" onchange="actualizarPaxPlato(${index}, this.value)">
                </td>
                <td class="p-3 text-right font-semibold text-slate-700">S/. ${p.costoUnitario.toFixed(2)}</td>
                <td class="p-3 text-right font-black text-slate-800">S/. ${p.costoTotal.toFixed(2)}</td>
                <td class="p-3 text-right font-bold ${fcColor}">${p.fcPorcentaje.toFixed(1)}%</td>
                <td class="p-3 text-center">
                    <button onclick="eliminarPlatoEvento(${index})" class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-600 transition-all">
                        üóëÔ∏è QUITAR
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// ========== FUNCI√ìN: ACTUALIZAR PAX DE UN PLATO ==========
function actualizarPaxPlato(index, nuevoPax) {
    nuevoPax = parseInt(nuevoPax) || 1;
    
    eventoActual.platos[index].pax = nuevoPax;
    eventoActual.platos[index].costoTotal = eventoActual.platos[index].costoUnitario * nuevoPax;
    
    renderTablaPlatosEvento();
    calcularResumenEvento();
}

// ========== FUNCI√ìN: ELIMINAR PLATO DEL EVENTO ==========
function eliminarPlatoEvento(index) {
    const plato = eventoActual.platos[index];
    if (confirm(`¬øEliminar "${plato.nombre}" del evento?`)) {
        eventoActual.platos.splice(index, 1);
        renderTablaPlatosEvento();
        calcularResumenEvento();
        console.log('‚úÖ Plato eliminado del evento');
    }
}

// ========== FUNCI√ìN: CALCULAR RESUMEN FINANCIERO ==========
function calcularResumenEvento() {
    const paxTotal = parseInt(document.getElementById('evento-pax-total').value) || 100;
    const profitDeseado = parseFloat(document.getElementById('evento-profit').value) || 35;
    
    if (eventoActual.platos.length === 0) {
        document.getElementById('evento-costo-total').textContent = 'S/. 0';
        document.getElementById('evento-fc-promedio').textContent = '0%';
        document.getElementById('evento-precio-sugerido').textContent = 'S/. 0';
        document.getElementById('evento-precio-pax').textContent = 'S/. 0';
        return;
    }
    
    // Costo total
    const costoTotal = eventoActual.platos.reduce((sum, p) => sum + p.costoTotal, 0);
    
    // FC% promedio ponderado (solo para referencia)
    let totalFC = 0;
    let totalCosto = 0;
    eventoActual.platos.forEach(p => {
        totalFC += p.fcPorcentaje * p.costoTotal;
        totalCosto += p.costoTotal;
    });
    const fcPromedio = totalCosto > 0 ? totalFC / totalCosto : 0;
    
    // NUEVO C√ÅLCULO: Precio sugerido basado en PROFIT DESEADO
    // Precio = Costo + (Costo * Profit%)
    const precioSugerido = costoTotal + (costoTotal * profitDeseado / 100);
    
    // Precio por persona
    const precioPax = precioSugerido / paxTotal;
    
    // Actualizar UI
    document.getElementById('evento-costo-total').textContent = 'S/. ' + costoTotal.toFixed(2);
    document.getElementById('evento-fc-promedio').textContent = fcPromedio.toFixed(1) + '%';
    document.getElementById('evento-precio-sugerido').textContent = 'S/. ' + precioSugerido.toFixed(2);
    document.getElementById('evento-precio-pax').textContent = 'S/. ' + precioPax.toFixed(2);
}

// ========== FUNCI√ìN: GUARDAR EVENTO ==========
function guardarEvento() {
    const nombre = document.getElementById('evento-nombre').value.trim();
    const fecha = document.getElementById('evento-fecha').value;
    const paxTotal = parseInt(document.getElementById('evento-pax-total').value) || 0;
    const profitDeseado = parseFloat(document.getElementById('evento-profit').value) || 35;
    
    if (!nombre) {
        alert('‚ö†Ô∏è Por favor ingresa el nombre del evento');
        return;
    }
    
    if (!fecha) {
        alert('‚ö†Ô∏è Por favor ingresa la fecha del evento');
        return;
    }
    
    if (eventoActual.platos.length === 0) {
        alert('‚ö†Ô∏è Por favor agrega al menos un plato al men√∫');
        return;
    }
    
    // Calcular totales
    const costoTotal = eventoActual.platos.reduce((sum, p) => sum + p.costoTotal, 0);
    let totalFC = 0;
    let totalCosto = 0;
    eventoActual.platos.forEach(p => {
        totalFC += p.fcPorcentaje * p.costoTotal;
        totalCosto += p.costoTotal;
    });
    const fcPromedio = totalCosto > 0 ? totalFC / totalCosto : 0;
    
    // NUEVO C√ÅLCULO: Precio con profit deseado
    const precioSugerido = costoTotal + (costoTotal * profitDeseado / 100);
    
    // Crear evento
    const evento = {
        id: 'EVT-' + Date.now(),
        nombre: nombre,
        fecha: fecha,
        paxTotal: paxTotal,
        profitDeseado: profitDeseado, // NUEVO: Guardar profit deseado
        platos: JSON.parse(JSON.stringify(eventoActual.platos)), // Copia profunda
        costoTotal: costoTotal,
        fcPromedio: fcPromedio,
        precioSugerido: precioSugerido,
        precioPorPax: precioSugerido / paxTotal,
        fechaCreacion: new Date().toISOString()
    };
    
    // Guardar en db
    db.eventos.push(evento);
    save();
    
    alert('‚úÖ Evento guardado exitosamente\n\n' +
          'Evento: ' + nombre + '\n' +
          'Fecha: ' + fecha + '\n' +
          'PAX: ' + paxTotal + '\n' +
          'Profit Deseado: ' + profitDeseado + '%\n' +
          'Costo Total: S/. ' + costoTotal.toFixed(2) + '\n' +
          'Precio Sugerido: S/. ' + precioSugerido.toFixed(2) + '\n' +
          'Por Persona: S/. ' + (precioSugerido / paxTotal).toFixed(2));
    
    console.log('‚úÖ Evento guardado:', evento);
}

// ========== FUNCI√ìN: LIMPIAR EVENTO ==========
function limpiarEvento() {
    if (eventoActual.platos.length > 0) {
        if (!confirm('¬øLimpiar todos los datos del evento actual?')) {
            return;
        }
    }
    
    eventoActual = {
        nombre: '',
        fecha: '',
        paxTotal: 100,
        platos: []
    };
    
    document.getElementById('evento-nombre').value = '';
    document.getElementById('evento-fecha').value = '';
    document.getElementById('evento-pax-total').value = '';
    document.getElementById('evento-profit').value = '';
    document.getElementById('evento-buscar-plato').value = '';
    document.getElementById('evento-pax-plato').value = '';
    
    renderTablaPlatosEvento();
    calcularResumenEvento();
    
    console.log('‚úÖ Evento limpiado');
}

// ========== FUNCI√ìN: RENDERIZAR EVENTOS GUARDADOS ==========
function renderEventosGuardados() {
    const contenedor = document.getElementById('eventos-guardados-lista');
    
    if (!db.eventos || db.eventos.length === 0) {
        contenedor.innerHTML = `
            <div class="text-center p-12 text-slate-400">
                <span class="text-6xl mb-4 block opacity-50">üìã</span>
                <p class="text-lg font-semibold">No hay eventos guardados</p>
                <p class="text-sm">Crea tu primer evento en la pesta√±a "CREAR EVENTO"</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    db.eventos.slice().reverse().forEach((evento, index) => {
        const realIndex = db.eventos.length - 1 - index;
        
        html += `
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-2xl border-2 border-purple-200 hover:shadow-lg transition-all">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="font-black text-purple-700 text-lg flex items-center gap-2">
                            <span class="sparkle-icon">üéâ</span>
                            ${evento.nombre}
                        </h4>
                        <p class="text-sm text-purple-600 font-semibold flex items-center gap-1 mt-1">
                            <span class="pulse-icon">üìÖ</span>
                            ${new Date(evento.fecha).toLocaleDateString('es-PE')} ‚Ä¢ ${evento.paxTotal} PAX
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="cargarEvento(${realIndex})" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-600 transition-all flex items-center gap-1">
                            <span>üìù</span> EDITAR
                        </button>
                        <button onclick="exportarEventoPDF(${realIndex})" class="bg-purple-500 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-purple-600 transition-all flex items-center gap-1">
                            <span>üìÑ</span> PDF
                        </button>
                        <button onclick="eliminarEvento(${realIndex})" class="bg-red-500 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-600 transition-all">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-4">
                    <div class="bg-white p-3 rounded-lg border border-purple-200">
                        <p class="text-xs text-purple-600 font-semibold mb-1">üí∞ Costo Total</p>
                        <p class="font-black text-purple-700">S/. ${evento.costoTotal.toFixed(2)}</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg border border-purple-200">
                        <p class="text-xs text-purple-600 font-semibold mb-1">üìä FC% Prom.</p>
                        <p class="font-black text-purple-700">${evento.fcPromedio.toFixed(1)}%</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg border border-purple-200">
                        <p class="text-xs text-purple-600 font-semibold mb-1">üíé Profit</p>
                        <p class="font-black text-purple-700">${(evento.profitDeseado || 35).toFixed(1)}%</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg border border-purple-200">
                        <p class="text-xs text-purple-600 font-semibold mb-1">üíµ Precio Total</p>
                        <p class="font-black text-purple-700">S/. ${evento.precioSugerido.toFixed(2)}</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg border border-purple-200">
                        <p class="text-xs text-purple-600 font-semibold mb-1">üë§ Por PAX</p>
                        <p class="font-black text-purple-700">S/. ${evento.precioPorPax.toFixed(2)}</p>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg border border-purple-200">
                    <p class="text-xs font-bold text-purple-700 mb-2">üìã MEN√ö (${evento.platos.length} platos):</p>
                    <div class="space-y-1">
                        ${evento.platos.map(p => `
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-700">‚Ä¢ ${p.nombre} <span class="text-purple-600 font-bold">(${p.pax} PAX)</span></span>
                                <span class="font-bold text-slate-800">S/. ${p.costoTotal.toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    });
    
    contenedor.innerHTML = html;
}

// ========== FUNCI√ìN: CARGAR EVENTO PARA EDITAR ==========
function cargarEvento(index) {
    const evento = db.eventos[index];
    if (!evento) return;
    
    // Cambiar a tab de crear
    mostrarTabEvento('crear');
    
    // Cargar datos
    document.getElementById('evento-nombre').value = evento.nombre;
    document.getElementById('evento-fecha').value = evento.fecha;
    document.getElementById('evento-pax-total').value = evento.paxTotal;
    document.getElementById('evento-profit').value = evento.profitDeseado || 35;
    
    // Cargar platos
    eventoActual.platos = JSON.parse(JSON.stringify(evento.platos));
    
    renderTablaPlatosEvento();
    calcularResumenEvento();
    
    // Eliminar el evento guardado ya que ahora est√° en edici√≥n
    db.eventos.splice(index, 1);
    save();
    
    console.log('‚úÖ Evento cargado para edici√≥n');
}

// ========== FUNCI√ìN: ELIMINAR EVENTO ==========
function eliminarEvento(index) {
    const evento = db.eventos[index];
    if (!evento) return;
    
    if (confirm(`¬øEliminar el evento "${evento.nombre}"?`)) {
        db.eventos.splice(index, 1);
        save();
        renderEventosGuardados();
        console.log('‚úÖ Evento eliminado');
    }
}

// ========== FUNCI√ìN: EXPORTAR COTIZACI√ìN A PDF ==========
function exportarCotizacionPDF() {
    const nombre = document.getElementById('evento-nombre').value.trim() || 'Evento Sin Nombre';
    const fecha = document.getElementById('evento-fecha').value || 'Sin fecha';
    const paxTotal = parseInt(document.getElementById('evento-pax-total').value) || 0;
    const profitDeseado = parseFloat(document.getElementById('evento-profit').value) || 35;
    
    if (eventoActual.platos.length === 0) {
        alert('‚ö†Ô∏è No hay platos en el men√∫ para generar el PDF');
        return;
    }
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // HEADER
        doc.setFillColor(124, 58, 237); // Purple
        doc.rect(0, 0, 210, 40, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont(undefined, 'bold');
        doc.text('COTIZACI√ìN DE EVENTO', 105, 15, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text('SWISSOTEL LIMA', 105, 25, { align: 'center' });
        doc.text('Sistema GASTRO CONTROL PRO | Desarrollado por Leider Tisnado Mego', 105, 32, { align: 'center' });
        
        // INFO DEL EVENTO
        let y = 50;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('Informaci√≥n del Evento', 14, y);
        
        y += 10;
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.text(`Evento: ${nombre}`, 14, y);
        y += 7;
        doc.text(`Fecha: ${new Date(fecha).toLocaleDateString('es-PE')}`, 14, y);
        y += 7;
        doc.text(`N√∫mero de Personas: ${paxTotal} PAX`, 14, y);
        y += 7;
        doc.text(`Profit Deseado: ${profitDeseado}%`, 14, y);
        y += 7;
        doc.text(`Fecha de Cotizaci√≥n: ${new Date().toLocaleDateString('es-PE')}`, 14, y);
        
        // TABLA DE PLATOS
        y += 15;
        const tableData = eventoActual.platos.map(p => [
            p.nombre,
            p.pax.toString(),
            'S/. ' + p.costoUnitario.toFixed(2),
            'S/. ' + p.costoTotal.toFixed(2),
            p.fcPorcentaje.toFixed(1) + '%'
        ]);
        
        doc.autoTable({
            startY: y,
            head: [['PLATO', 'PAX', 'COSTO/UNI', 'TOTAL', 'FC%']],
            body: tableData,
            theme: 'grid',
            headStyles: { fillColor: [124, 58, 237], textColor: 255, fontStyle: 'bold', fontSize: 10 },
            styles: { fontSize: 9, cellPadding: 3 },
            columnStyles: {
                0: { cellWidth: 70 },
                1: { halign: 'center', cellWidth: 20 },
                2: { halign: 'right', cellWidth: 30 },
                3: { halign: 'right', cellWidth: 35 },
                4: { halign: 'right', cellWidth: 25 }
            }
        });
        
        // RESUMEN FINANCIERO
        y = doc.lastAutoTable.finalY + 15;
        
        const costoTotal = eventoActual.platos.reduce((sum, p) => sum + p.costoTotal, 0);
        let totalFC = 0;
        let totalCosto = 0;
        eventoActual.platos.forEach(p => {
            totalFC += p.fcPorcentaje * p.costoTotal;
            totalCosto += p.costoTotal;
        });
        const fcPromedio = totalCosto > 0 ? totalFC / totalCosto : 0;
        
        // NUEVO C√ÅLCULO: Con profit deseado
        const precioSugerido = costoTotal + (costoTotal * profitDeseado / 100);
        const precioPax = precioSugerido / paxTotal;
        
        doc.setFillColor(240, 240, 240);
        doc.rect(14, y, 182, 45, 'F');
        
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('RESUMEN FINANCIERO', 105, y + 10, { align: 'center' });
        
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        y += 18;
        doc.text(`Costo Total del Evento: S/. ${costoTotal.toFixed(2)}`, 20, y);
        y += 7;
        doc.text(`Food Cost Promedio: ${fcPromedio.toFixed(1)}%`, 20, y);
        y += 7;
        doc.text(`Profit Aplicado: ${profitDeseado}%`, 20, y);
        
        doc.setFont(undefined, 'bold');
        y += 10;
        doc.setFontSize(12);
        doc.text(`PRECIO SUGERIDO TOTAL: S/. ${precioSugerido.toFixed(2)}`, 20, y);
        y += 7;
        doc.text(`PRECIO POR PERSONA: S/. ${precioPax.toFixed(2)}`, 20, y);
        
        // FOOTER
        doc.setFontSize(8);
        doc.setFont(undefined, 'italic');
        doc.setTextColor(100, 100, 100);
        doc.text('HOTELERA COSTA DEL PACIFICO S.A. ¬∑ RUC 20297885538', 105, 280, { align: 'center' });
        doc.text('Cotizaci√≥n generada por GastroCore Pro', 105, 285, { align: 'center' });
        
        // GUARDAR
        const nombreArchivo = `Cotizacion_${nombre.replace(/\s+/g, '_')}_${fecha}.pdf`;
        doc.save(nombreArchivo);
        
        console.log('‚úÖ PDF generado:', nombreArchivo);
        alert('‚úÖ Cotizaci√≥n exportada exitosamente\n\nArchivo: ' + nombreArchivo);
        
    } catch (error) {
        console.error('‚ùå Error al generar PDF:', error);
        alert('‚ùå Error al generar PDF\n\n' + error.message);
    }
}

// ========== FUNCI√ìN: EXPORTAR EVENTO GUARDADO A PDF ==========
function exportarEventoPDF(index) {
    const evento = db.eventos[index];
    if (!evento) return;
    
    // Cargar evento temporalmente
    eventoActual = JSON.parse(JSON.stringify(evento));
    document.getElementById('evento-nombre').value = evento.nombre;
    document.getElementById('evento-fecha').value = evento.fecha;
    document.getElementById('evento-pax-total').value = evento.paxTotal;
    document.getElementById('evento-profit').value = evento.profitDeseado || 35;
    
    // Exportar
    exportarCotizacionPDF();
    
    // Limpiar
    limpiarEvento();
}

// ========================================
// FUNCIONES DEL M√ìDULO DE COMPRAS
// ========================================

// Variables globales para gr√°ficos de compras
var chartComprasFamilias = null;
var chartComprasTemporal = null;
var comprasPeriodoActual = 'mes';

// ========== FUNCI√ìN: IMPORTAR EXCEL DE COMPRAS ==========
function importarExcelCompras(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('üìÇ Iniciando importaci√≥n de Excel:', file.name);
    
    document.getElementById('compras-estado').innerHTML = `
        <p class="font-bold text-blue-700 flex items-center gap-2">
            <span class="rotate-icon">üîÑ</span>
            Procesando archivo: ${file.name}...
        </p>
    `;
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Leer la primera hoja
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 'A', defval: '' });
            
            console.log('üìä Datos extra√≠dos:', jsonData.length, 'filas');
            
            // Procesar datos (omitir header, empezar desde fila 2)
            const compras = [];
            let errores = 0;
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                
                // Validar que tenga datos m√≠nimos
                if (!row.A && !row.F && !row.L) continue;
                
                try {
                    const compra = {
                        fecha: row.A ? excelDateToJSDate(row.A) : null,
                        descripcion: (row.F || '').toString().trim().toUpperCase(),
                        proveedor: (row.G || '').toString().trim().toUpperCase(),
                        cantidad: parseFloat(row.J) || 0,
                        importe: parseFloat(row.L) || 0,
                        familia: (row.M || 'SIN FAMILIA').toString().trim().toUpperCase(),
                        kardex: (row.N || '').toString().trim()
                    };
                    
                    // Solo agregar si tiene datos v√°lidos
                    if (compra.descripcion || compra.importe > 0) {
                        compras.push(compra);
                    }
                } catch (err) {
                    errores++;
                    console.warn('‚ö†Ô∏è Error en fila', i + 1, ':', err);
                }
            }
            
            if (compras.length === 0) {
                alert('‚ö†Ô∏è No se encontraron datos v√°lidos en el archivo Excel.\n\nVerifica que las columnas est√©n correctas:\n- A: Fecha\n- F: Descripci√≥n\n- G: Proveedor\n- J: Cantidad\n- L: Importe\n- M: Familia\n- N: Kardex');
                document.getElementById('compras-estado').innerHTML = '<p class="italic text-red-600">‚ùå Error: No se encontraron datos v√°lidos</p>';
                return;
            }
            
            // Guardar en base de datos (EN MEMORIA - no localStorage por tama√±o)
            db.compras = compras;
            db.comprasUltimaImportacion = new Date().toISOString();
            save(); // Guarda stats pero NO las compras (para evitar QuotaExceededError)
            
            console.log('‚úÖ Compras importadas en MEMORIA:', compras.length);
            if (errores > 0) {
                console.warn('‚ö†Ô∏è Filas con errores:', errores);
            }
            
            // Actualizar UI
            document.getElementById('compras-estado').innerHTML = `
                <p class="font-bold text-green-700 flex items-center gap-2 mb-2">
                    <span class="sparkle-icon">‚úÖ</span>
                    Importaci√≥n exitosa!
                </p>
                <p class="text-xs text-green-600">üìä Registros: ${compras.length}</p>
                <p class="text-xs text-green-600">üìÖ √öltima actualizaci√≥n: ${new Date().toLocaleString('es-PE')}</p>
                ${errores > 0 ? `<p class="text-xs text-orange-600 mt-1">‚ö†Ô∏è ${errores} filas omitidas por errores</p>` : ''}
                <p class="text-xs text-blue-600 mt-2 font-semibold">üí° Datos temporales (re-importar al reabrir el sistema)</p>
            `;
            
            // Mostrar secci√≥n de backup
            document.getElementById('compras-backup-section').classList.remove('hidden');
            
            // Calcular estad√≠sticas y mostrar an√°lisis
            calcularStatsCompras();
            mostrarAnalisisCompras();
            
            alert('‚úÖ Importaci√≥n completada\n\n' + 
                  'Registros importados: ' + compras.length + '\n' +
                  (errores > 0 ? 'Filas omitidas: ' + errores + '\n' : '') +
                  '\nüí° NOTA: Los datos se mantienen durante esta sesi√≥n.\n' +
                  'Al recargar la p√°gina deber√°s re-importar el Excel.\n' +
                  '(Esto evita saturar el almacenamiento del navegador)\n\n' +
                  'Ahora puedes ver el an√°lisis completo abajo.');
            
        } catch (error) {
            console.error('‚ùå Error al procesar Excel:', error);
            alert('‚ùå Error al procesar el archivo Excel\n\n' + error.message);
            document.getElementById('compras-estado').innerHTML = '<p class="italic text-red-600">‚ùå Error al procesar archivo</p>';
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// ========== FUNCI√ìN: CONVERTIR FECHA DE EXCEL A JS ==========
function excelDateToJSDate(excelDate) {
    // Si es n√∫mero de serie de Excel
    if (typeof excelDate === 'number') {
        const epoch = new Date(1899, 11, 30);
        const date = new Date(epoch.getTime() + excelDate * 86400000);
        return date.toISOString().split('T')[0];
    }
    // Si ya es string de fecha
    if (typeof excelDate === 'string') {
        return excelDate.split('T')[0];
    }
    return null;
}

// ========== FUNCI√ìN: CALCULAR ESTAD√çSTICAS ==========
function calcularStatsCompras() {
    const compras = db.compras || [];
    
    if (compras.length === 0) {
        db.comprasStats = null;
        return;
    }
    
    // Total comprado
    const totalComprado = compras.reduce((sum, c) => sum + c.importe, 0);
    
    // Art√≠culos √∫nicos (por descripci√≥n)
    const articulosUnicos = [...new Set(compras.map(c => c.descripcion))].length;
    
    // Proveedores √∫nicos
    const proveedoresUnicos = [...new Set(compras.map(c => c.proveedor).filter(p => p))].length;
    
    // Promedio por orden
    const promedioOrden = totalComprado / compras.length;
    
    // Top familia
    const familias = {};
    compras.forEach(c => {
        const fam = c.familia || 'SIN FAMILIA';
        familias[fam] = (familias[fam] || 0) + c.importe;
    });
    const topFamilia = Object.keys(familias).sort((a, b) => familias[b] - familias[a])[0];
    
    // Frecuencia diaria
    const fechas = compras.map(c => c.fecha).filter(f => f);
    const fechasUnicas = [...new Set(fechas)];
    const diasUnicos = fechasUnicas.length;
    const frecuenciaDiaria = compras.length / (diasUnicos || 1);
    
    db.comprasStats = {
        totalComprado,
        totalArticulos: articulosUnicos,
        totalProveedores: proveedoresUnicos,
        promedioOrden,
        topFamilia,
        frecuenciaDiaria
    };
    
    save();
    console.log('üìä Estad√≠sticas calculadas:', db.comprasStats);
}

// ========== FUNCI√ìN: MOSTRAR AN√ÅLISIS COMPLETO ==========
function mostrarAnalisisCompras() {
    const stats = db.comprasStats;
    
    if (!stats) {
        document.getElementById('compras-kpis-section').classList.add('hidden');
        document.getElementById('compras-analisis-section').classList.add('hidden');
        return;
    }
    
    // Mostrar secciones
    document.getElementById('compras-kpis-section').classList.remove('hidden');
    document.getElementById('compras-analisis-section').classList.remove('hidden');
    
    // Actualizar KPIs
    document.getElementById('kpi-compras-total').textContent = 'S/. ' + stats.totalComprado.toLocaleString('es-PE', { minimumFractionDigits: 2 });
    document.getElementById('kpi-compras-articulos').textContent = stats.totalArticulos.toLocaleString('es-PE');
    document.getElementById('kpi-compras-proveedores').textContent = stats.totalProveedores.toLocaleString('es-PE');
    document.getElementById('kpi-compras-promedio').textContent = 'S/. ' + stats.promedioOrden.toLocaleString('es-PE', { minimumFractionDigits: 2 });
    document.getElementById('kpi-compras-top-familia').textContent = stats.topFamilia;
    document.getElementById('kpi-compras-frecuencia').textContent = stats.frecuenciaDiaria.toFixed(1);
    
    // Renderizar an√°lisis
    renderTopProveedores();
    renderTopProductos();
    renderAnalisisFamilias();
    renderGraficoTemporal();
}

// ========== FUNCI√ìN: RENDERIZAR TOP PROVEEDORES ==========
function renderTopProveedores() {
    const compras = db.compras || [];
    
    // Agrupar por proveedor
    const proveedores = {};
    compras.forEach(c => {
        const prov = c.proveedor || 'SIN PROVEEDOR';
        if (!proveedores[prov]) {
            proveedores[prov] = {
                nombre: prov,
                totalImporte: 0,
                cantidadOrdenes: 0,
                productos: new Set()
            };
        }
        proveedores[prov].totalImporte += c.importe;
        proveedores[prov].cantidadOrdenes++;
        if (c.descripcion) proveedores[prov].productos.add(c.descripcion);
    });
    
    // Ordenar por importe
    const proveedoresArray = Object.values(proveedores)
        .map(p => ({
            ...p,
            productos: p.productos.size
        }))
        .sort((a, b) => b.totalImporte - a.totalImporte)
        .slice(0, 10);
    
    // Renderizar
    const totalComprado = db.comprasStats.totalComprado;
    let html = '';
    
    proveedoresArray.forEach((p, index) => {
        const porcentaje = (p.totalImporte / totalComprado * 100).toFixed(1);
        const medalla = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;
        
        html += `
            <div class="bg-gradient-to-r from-emerald-50 to-green-50 p-4 rounded-xl border-2 border-emerald-200 hover:shadow-lg transition-all">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-xl font-black text-emerald-700">${medalla}</span>
                        <span class="text-sm font-bold text-slate-800">${p.nombre}</span>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 text-xs">
                    <div class="text-center">
                        <p class="text-emerald-600 font-semibold">üí∞ Importe</p>
                        <p class="font-black text-slate-800">S/. ${p.totalImporte.toLocaleString('es-PE', { minimumFractionDigits: 0 })}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-emerald-600 font-semibold">üì¶ √ìrdenes</p>
                        <p class="font-black text-slate-800">${p.cantidadOrdenes}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-emerald-600 font-semibold">üìä %</p>
                        <p class="font-black text-slate-800">${porcentaje}%</p>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('compras-top-proveedores').innerHTML = html;
}

// ========== FUNCI√ìN: RENDERIZAR TOP PRODUCTOS ==========
function renderTopProductos() {
    const compras = db.compras || [];
    
    // Agrupar por descripci√≥n
    const productos = {};
    compras.forEach(c => {
        const desc = c.descripcion || 'SIN DESCRIPCI√ìN';
        if (!productos[desc]) {
            productos[desc] = {
                descripcion: desc,
                totalCantidad: 0,
                totalImporte: 0,
                cantidadCompras: 0,
                proveedores: new Set()
            };
        }
        productos[desc].totalCantidad += c.cantidad;
        productos[desc].totalImporte += c.importe;
        productos[desc].cantidadCompras++;
        if (c.proveedor) productos[desc].proveedores.add(c.proveedor);
    });
    
    // Ordenar por importe
    const productosArray = Object.values(productos)
        .map(p => ({
            ...p,
            proveedores: p.proveedores.size
        }))
        .sort((a, b) => b.totalImporte - a.totalImporte)
        .slice(0, 10);
    
    // Renderizar
    let html = '';
    
    productosArray.forEach((p, index) => {
        const medalla = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;
        
        html += `
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-4 rounded-xl border-2 border-blue-200 hover:shadow-lg transition-all cursor-pointer" onclick="mostrarDetalleProducto('${p.descripcion.replace(/'/g, "\\'")}')">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-xl font-black text-blue-700">${medalla}</span>
                        <span class="text-sm font-bold text-slate-800">${p.descripcion}</span>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 text-xs">
                    <div class="text-center">
                        <p class="text-blue-600 font-semibold">üí∞ Importe</p>
                        <p class="font-black text-slate-800">S/. ${p.totalImporte.toLocaleString('es-PE', { minimumFractionDigits: 0 })}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-blue-600 font-semibold">üì¶ Cantidad</p>
                        <p class="font-black text-slate-800">${p.totalCantidad.toLocaleString('es-PE', { minimumFractionDigits: 0 })}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-blue-600 font-semibold">üìä Compras</p>
                        <p class="font-black text-slate-800">${p.cantidadCompras}</p>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('compras-top-productos').innerHTML = html;
}

// ========== FUNCI√ìN: B√öSQUEDA PREDICTIVA DE PRODUCTOS ==========
function buscarProductoCompras() {
    const input = document.getElementById('compras-buscar-producto');
    const busqueda = input.value.toLowerCase().trim();
    const sugerencias = document.getElementById('compras-sugerencias');
    const btnLimpiar = document.getElementById('compras-btn-limpiar-busqueda');
    
    // Mostrar/ocultar bot√≥n X seg√∫n si hay texto
    if (input.value.length > 0) {
        btnLimpiar.classList.remove('hidden');
    } else {
        btnLimpiar.classList.add('hidden');
    }
    
    if (busqueda.length < 2) {
        sugerencias.classList.add('hidden');
        return;
    }
    
    const compras = db.compras || [];
    
    // Agrupar productos
    const productos = {};
    compras.forEach(c => {
        const desc = c.descripcion || '';
        if (!productos[desc]) {
            productos[desc] = {
                descripcion: desc,
                cantidadCompras: 0,
                totalImporte: 0
            };
        }
        productos[desc].cantidadCompras++;
        productos[desc].totalImporte += c.importe;
    });
    
    // Filtrar y ordenar
    const productosEncontrados = Object.values(productos)
        .filter(p => p.descripcion.toLowerCase().includes(busqueda))
        .sort((a, b) => b.cantidadCompras - a.cantidadCompras)
        .slice(0, 15);
    
    if (productosEncontrados.length === 0) {
        sugerencias.innerHTML = '<div class="p-4 text-center text-slate-400 italic">No se encontraron productos</div>';
        sugerencias.classList.remove('hidden');
        return;
    }
    
    let html = '<div class="p-2">';
    productosEncontrados.forEach(p => {
        html += `
            <div onclick="mostrarDetalleProducto('${p.descripcion.replace(/'/g, "\\'")}'); document.getElementById('compras-sugerencias').classList.add('hidden');" class="p-3 hover:bg-purple-50 cursor-pointer rounded-lg border-b border-purple-100 transition-all">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm text-slate-800">${p.descripcion}</p>
                        <p class="text-xs text-slate-500">${p.cantidadCompras} compras</p>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-sm text-purple-700">S/. ${p.totalImporte.toLocaleString('es-PE', { minimumFractionDigits: 0 })}</p>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    sugerencias.innerHTML = html;
    sugerencias.classList.remove('hidden');
}

// ========== FUNCI√ìN: LIMPIAR B√öSQUEDA ==========
function limpiarBusquedaCompras() {
    document.getElementById('compras-buscar-producto').value = '';
    document.getElementById('compras-sugerencias').classList.add('hidden');
    document.getElementById('compras-btn-limpiar-busqueda').classList.add('hidden');
    document.getElementById('compras-buscar-producto').focus();
}

// ========== FUNCI√ìN: MOSTRAR DETALLE DE PRODUCTO ==========
function mostrarDetalleProducto(descripcion) {
    const compras = db.compras || [];
    const comprasProducto = compras.filter(c => c.descripcion === descripcion);
    
    if (comprasProducto.length === 0) {
        alert('‚ö†Ô∏è No se encontraron compras de este producto');
        return;
    }
    
    // Calcular estad√≠sticas del producto
    const totalImporte = comprasProducto.reduce((sum, c) => sum + c.importe, 0);
    const totalCantidad = comprasProducto.reduce((sum, c) => sum + c.cantidad, 0);
    const precioPromedio = totalCantidad > 0 ? totalImporte / totalCantidad : 0;
    
    // Proveedores
    const proveedores = {};
    comprasProducto.forEach(c => {
        const prov = c.proveedor || 'SIN PROVEEDOR';
        if (!proveedores[prov]) {
            proveedores[prov] = {
                nombre: prov,
                totalImporte: 0,
                totalCantidad: 0
            };
        }
        proveedores[prov].totalImporte += c.importe;
        proveedores[prov].totalCantidad += c.cantidad;
    });
    
    const proveedoresArray = Object.values(proveedores)
        .map(p => ({
            ...p,
            porcentaje: (p.totalImporte / totalImporte * 100).toFixed(1),
            precioPromedio: p.totalCantidad > 0 ? p.totalImporte / p.totalCantidad : 0
        }))
        .sort((a, b) => b.totalImporte - a.totalImporte);
    
    // Fechas
    const fechas = comprasProducto.map(c => c.fecha).filter(f => f).sort();
    const primeraCompra = fechas[0] || 'N/A';
    const ultimaCompra = fechas[fechas.length - 1] || 'N/A';
    
    // Familia
    const familia = comprasProducto[0].familia || 'SIN FAMILIA';
    
    // ========== AN√ÅLISIS MENSUAL CON PROVEEDORES ==========
    const porMes = {};
    comprasProducto.forEach(c => {
        if (!c.fecha) return;
        const fecha = new Date(c.fecha);
        const mesA√±o = fecha.toLocaleDateString('es-PE', { year: 'numeric', month: '2-digit' }); // "01/2025"
        const mesNombre = fecha.toLocaleDateString('es-PE', { year: 'numeric', month: 'long' }); // "enero de 2025"
        
        if (!porMes[mesA√±o]) {
            porMes[mesA√±o] = {
                mes: mesA√±o,
                mesNombre: mesNombre.charAt(0).toUpperCase() + mesNombre.slice(1), // Capitalizar
                totalImporte: 0,
                totalCantidad: 0,
                cantidadCompras: 0,
                proveedores: {} // Nuevo: proveedores por mes
            };
        }
        porMes[mesA√±o].totalImporte += c.importe;
        porMes[mesA√±o].totalCantidad += c.cantidad;
        porMes[mesA√±o].cantidadCompras++;
        
        // Agrupar por proveedor dentro del mes
        const prov = c.proveedor || 'SIN PROVEEDOR';
        if (!porMes[mesA√±o].proveedores[prov]) {
            porMes[mesA√±o].proveedores[prov] = {
                nombre: prov,
                importe: 0,
                cantidad: 0
            };
        }
        porMes[mesA√±o].proveedores[prov].importe += c.importe;
        porMes[mesA√±o].proveedores[prov].cantidad += c.cantidad;
    });
    
    // Convertir a array y ordenar cronol√≥gicamente
    const mesesArray = Object.values(porMes).sort((a, b) => {
        const [mesA, a√±oA] = a.mes.split('/');
        const [mesB, a√±oB] = b.mes.split('/');
        return a√±oA === a√±oB ? mesA - mesB : a√±oA - a√±oB;
    });
    
    // Renderizar detalle
    let html = `
        <h3 class="font-black text-blue-700 mb-4 flex items-center gap-2">
            <span class="text-xl sparkle-icon">üìä</span>
            AN√ÅLISIS DETALLADO: ${descripcion}
        </h3>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-emerald-50 to-green-50 p-4 rounded-xl border-2 border-emerald-200">
                <p class="text-xs text-emerald-600 font-semibold mb-1">üí∞ Total Gastado</p>
                <p class="font-black text-lg text-emerald-700">S/. ${totalImporte.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</p>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-xl border-2 border-blue-200">
                <p class="text-xs text-blue-600 font-semibold mb-1">üì¶ Total Comprado</p>
                <p class="font-black text-lg text-blue-700">${totalCantidad.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</p>
            </div>
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 rounded-xl border-2 border-purple-200">
                <p class="text-xs text-purple-600 font-semibold mb-1">üìà Precio Promedio</p>
                <p class="font-black text-lg text-purple-700">S/. ${precioPromedio.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</p>
            </div>
            <div class="bg-gradient-to-br from-orange-50 to-amber-50 p-4 rounded-xl border-2 border-orange-200">
                <p class="text-xs text-orange-600 font-semibold mb-1">üè∑Ô∏è Familia</p>
                <p class="font-black text-sm text-orange-700">${familia}</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <p class="text-xs text-slate-600 font-semibold">üìÖ Primera Compra</p>
                <p class="font-bold text-slate-800">${primeraCompra !== 'N/A' ? new Date(primeraCompra).toLocaleDateString('es-PE') : 'N/A'}</p>
            </div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <p class="text-xs text-slate-600 font-semibold">üìÖ √öltima Compra</p>
                <p class="font-bold text-slate-800">${ultimaCompra !== 'N/A' ? new Date(ultimaCompra).toLocaleDateString('es-PE') : 'N/A'}</p>
            </div>
        </div>
        
        <div class="bg-purple-50 p-4 rounded-xl border-2 border-purple-200 mb-6">
            <h4 class="font-black text-purple-700 mb-3 flex items-center gap-2">
                <span class="pulse-icon">üè¢</span>
                PROVEEDORES (${proveedoresArray.length})
            </h4>
            <div class="space-y-2">
                ${proveedoresArray.map(p => `
                    <div class="bg-white p-3 rounded-lg border border-purple-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-sm text-slate-800">${p.nombre}</span>
                            <span class="text-xs font-bold text-purple-600">${p.porcentaje}%</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div>
                                <p class="text-slate-500">üí∞ Importe</p>
                                <p class="font-bold text-slate-700">S/. ${p.totalImporte.toLocaleString('es-PE', { minimumFractionDigits: 0 })}</p>
                            </div>
                            <div>
                                <p class="text-slate-500">üì¶ Cantidad</p>
                                <p class="font-bold text-slate-700">${p.totalCantidad.toLocaleString('es-PE', { minimumFractionDigits: 1 })}</p>
                            </div>
                            <div>
                                <p class="text-slate-500">üí≤ Precio/u</p>
                                <p class="font-bold text-slate-700">S/. ${p.precioPromedio.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</p>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <!-- ========== AN√ÅLISIS MENSUAL ========== -->
        <div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-6 rounded-xl border-2 border-indigo-200 mb-6">
            <h4 class="font-black text-indigo-700 mb-4 flex items-center gap-2">
                <span class="text-xl rotate-icon">üìÖ</span>
                AN√ÅLISIS POR MES
                <span class="text-sm sparkle-icon">üìä</span>
            </h4>
            
            ${mesesArray.length > 0 ? `
                <!-- Gr√°fico de Barras por Mes -->
                <div class="bg-white p-4 rounded-xl border-2 border-indigo-200 mb-4">
                    <p class="text-sm font-bold text-indigo-700 mb-3">üìä COMPRAS POR MES (S/.)</p>
                    <div style="height: 300px;">
                        <canvas id="chart-producto-mensual"></canvas>
                    </div>
                </div>
                
                <!-- Tabla Detallada por Mes -->
                <div class="bg-white rounded-xl border-2 border-indigo-200 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-gradient-to-r from-indigo-600 to-blue-600 text-white">
                            <tr>
                                <th class="p-3 text-left font-bold">üìÖ MES</th>
                                <th class="p-3 text-left font-bold">üè¢ PROVEEDORES</th>
                                <th class="p-3 text-right font-bold">üí∞ IMPORTE</th>
                                <th class="p-3 text-right font-bold">üì¶ CANTIDAD</th>
                                <th class="p-3 text-right font-bold">üî¢ COMPRAS</th>
                                <th class="p-3 text-right font-bold">üí≤ PRECIO PROM.</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-indigo-100">
                            ${mesesArray.map(m => {
                                const precioPromMes = m.totalCantidad > 0 ? m.totalImporte / m.totalCantidad : 0;
                                
                                // Ordenar proveedores por importe
                                const provsArray = Object.values(m.proveedores).sort((a, b) => b.importe - a.importe);
                                const proveedoresHTML = provsArray.map((p, idx) => {
                                    const porcent = ((p.importe / m.totalImporte) * 100).toFixed(0);
                                    return `<div class="text-xs ${idx > 0 ? 'mt-1' : ''}">
                                        <span class="font-semibold text-purple-700">${p.nombre}</span>
                                        <span class="text-slate-500">(${porcent}%)</span>
                                    </div>`;
                                }).join('');
                                
                                return `
                                    <tr class="hover:bg-indigo-50 transition-all">
                                        <td class="p-3 font-bold text-indigo-700">${m.mesNombre}</td>
                                        <td class="p-3">${proveedoresHTML}</td>
                                        <td class="p-3 text-right font-black text-emerald-700">S/. ${m.totalImporte.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</td>
                                        <td class="p-3 text-right font-bold text-blue-700">${m.totalCantidad.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</td>
                                        <td class="p-3 text-right font-semibold text-slate-700">${m.cantidadCompras}</td>
                                        <td class="p-3 text-right font-bold text-purple-700">S/. ${precioPromMes.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                        <tfoot class="bg-gradient-to-r from-indigo-100 to-blue-100">
                            <tr>
                                <td colspan="2" class="p-3 font-black text-indigo-800">TOTAL</td>
                                <td class="p-3 text-right font-black text-emerald-800">S/. ${totalImporte.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</td>
                                <td class="p-3 text-right font-black text-blue-800">${totalCantidad.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</td>
                                <td class="p-3 text-right font-black text-slate-800">${comprasProducto.length}</td>
                                <td class="p-3 text-right font-black text-purple-800">S/. ${precioPromedio.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            ` : '<p class="text-center text-slate-500 italic py-4">No hay datos de fechas disponibles</p>'}
        </div>
        
        <div class="mt-4 flex justify-end">
            <button onclick="cerrarDetalleProducto()" class="bg-slate-500 text-white px-6 py-3 rounded-xl font-bold text-sm hover:bg-slate-600 transition-all flex items-center gap-2">
                <span>‚úñÔ∏è</span> CERRAR
            </button>
        </div>
    `;
    
    document.getElementById('compras-detalle-producto').innerHTML = html;
    document.getElementById('compras-detalle-producto').classList.remove('hidden');
    
    // Renderizar gr√°fico mensual si hay datos
    if (mesesArray.length > 0) {
        setTimeout(() => {
            renderGraficoProductoMensual(mesesArray);
        }, 100);
    }
    
    // Scroll al detalle
    document.getElementById('compras-detalle-producto').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ========== FUNCI√ìN: RENDERIZAR GR√ÅFICO MENSUAL DEL PRODUCTO ==========
let chartProductoMensual = null;

function renderGraficoProductoMensual(mesesArray) {
    // Destruir gr√°fico anterior si existe
    if (chartProductoMensual) {
        chartProductoMensual.destroy();
    }
    
    const ctx = document.getElementById('chart-producto-mensual');
    if (!ctx) return;
    
    chartProductoMensual = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: mesesArray.map(m => m.mesNombre),
            datasets: [{
                label: 'Importe (S/.)',
                data: mesesArray.map(m => m.totalImporte),
                backgroundColor: 'rgba(99, 102, 241, 0.8)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 12, weight: 'bold' }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const mes = mesesArray[context.dataIndex];
                            return [
                                'Importe: S/. ' + mes.totalImporte.toLocaleString('es-PE', { minimumFractionDigits: 2 }),
                                'Cantidad: ' + mes.totalCantidad.toLocaleString('es-PE', { minimumFractionDigits: 2 }),
                                'Compras: ' + mes.cantidadCompras
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'S/. ' + value.toLocaleString('es-PE', { minimumFractionDigits: 0 });
                        }
                    }
                }
            }
        }
    });
}

// ========== FUNCI√ìN: CERRAR DETALLE DE PRODUCTO ==========
function cerrarDetalleProducto() {
    // Destruir gr√°fico
    if (chartProductoMensual) {
        chartProductoMensual.destroy();
        chartProductoMensual = null;
    }
    
    document.getElementById('compras-detalle-producto').classList.add('hidden');
}

// ========== FUNCI√ìN: AN√ÅLISIS POR FAMILIAS ==========
function renderAnalisisFamilias() {
    const compras = db.compras || [];
    
    // Agrupar por familia
    const familias = {};
    compras.forEach(c => {
        const fam = c.familia || 'SIN FAMILIA';
        if (!familias[fam]) {
            familias[fam] = {
                nombre: fam,
                totalImporte: 0,
                cantidadItems: 0
            };
        }
        familias[fam].totalImporte += c.importe;
        familias[fam].cantidadItems++;
    });
    
    // Convertir a array y ordenar
    const familiasArray = Object.values(familias)
        .sort((a, b) => b.totalImporte - a.totalImporte);
    
    const totalComprado = db.comprasStats.totalComprado;
    
    // GR√ÅFICO DE DONA
    if (chartComprasFamilias) {
        chartComprasFamilias.destroy();
    }
    
    const ctx = document.getElementById('chart-compras-familias');
    if (ctx && familiasArray.length > 0) {
        const colores = [
            'rgba(16, 185, 129, 0.8)',   // Emerald
            'rgba(59, 130, 246, 0.8)',   // Blue
            'rgba(168, 85, 247, 0.8)',   // Purple
            'rgba(249, 115, 22, 0.8)',   // Orange
            'rgba(236, 72, 153, 0.8)',   // Pink
            'rgba(14, 165, 233, 0.8)',   // Cyan
            'rgba(234, 179, 8, 0.8)',    // Yellow
            'rgba(239, 68, 68, 0.8)',    // Red
            'rgba(34, 197, 94, 0.8)',    // Green
            'rgba(139, 92, 246, 0.8)'    // Violet
        ];
        
        chartComprasFamilias = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: familiasArray.map(f => f.nombre),
                datasets: [{
                    data: familiasArray.map(f => f.totalImporte),
                    backgroundColor: colores,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 11, weight: 'bold' }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const valor = context.parsed;
                                const porcentaje = ((valor / totalComprado) * 100).toFixed(1);
                                return context.label + ': S/. ' + valor.toLocaleString('es-PE', { minimumFractionDigits: 0 }) + ' (' + porcentaje + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // TABLA DE FAMILIAS
    let htmlTabla = `
        <table class="w-full text-sm">
            <thead class="bg-gradient-to-r from-rose-600 to-red-600 text-white">
                <tr>
                    <th class="p-3 text-left font-bold">#</th>
                    <th class="p-3 text-left font-bold">FAMILIA</th>
                    <th class="p-3 text-right font-bold">IMPORTE</th>
                    <th class="p-3 text-right font-bold">%</th>
                    <th class="p-3 text-right font-bold">ITEMS</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-rose-100">
    `;
    
    familiasArray.forEach((f, index) => {
        const porcentaje = ((f.totalImporte / totalComprado) * 100).toFixed(1);
        const medalla = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : (index + 1);
        
        htmlTabla += `
            <tr class="hover:bg-rose-50 transition-all">
                <td class="p-3 font-bold text-rose-700">${medalla}</td>
                <td class="p-3 font-semibold text-slate-800">${f.nombre}</td>
                <td class="p-3 text-right font-bold text-slate-700">S/. ${f.totalImporte.toLocaleString('es-PE', { minimumFractionDigits: 0 })}</td>
                <td class="p-3 text-right font-bold text-rose-600">${porcentaje}%</td>
                <td class="p-3 text-right font-semibold text-slate-600">${f.cantidadItems}</td>
            </tr>
        `;
    });
    
    htmlTabla += `
            </tbody>
        </table>
    `;
    
    document.getElementById('compras-tabla-familias').innerHTML = htmlTabla;
}

// ========== FUNCI√ìN: GR√ÅFICO TEMPORAL ==========
function renderGraficoTemporal() {
    const compras = db.compras || [];
    const comprasFiltradas = filtrarComprasPorPeriodoInterno(comprasPeriodoActual, compras);
    
    // Agrupar por fecha
    const porFecha = {};
    comprasFiltradas.forEach(c => {
        const fecha = c.fecha || 'SIN FECHA';
        porFecha[fecha] = (porFecha[fecha] || 0) + c.importe;
    });
    
    // Ordenar fechas
    const fechas = Object.keys(porFecha).filter(f => f !== 'SIN FECHA').sort();
    const valores = fechas.map(f => porFecha[f]);
    
    // Destruir gr√°fico anterior
    if (chartComprasTemporal) {
        chartComprasTemporal.destroy();
    }
    
    const ctx = document.getElementById('chart-compras-temporal');
    if (ctx && fechas.length > 0) {
        chartComprasTemporal = new Chart(ctx, {
            type: 'line',
            data: {
                labels: fechas.map(f => new Date(f).toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit' })),
                datasets: [{
                    label: 'Compras (S/.)',
                    data: valores,
                    borderColor: 'rgba(99, 102, 241, 1)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { size: 12, weight: 'bold' }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'S/. ' + context.parsed.y.toLocaleString('es-PE', { minimumFractionDigits: 2 });
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'S/. ' + value.toLocaleString('es-PE', { minimumFractionDigits: 0 });
                            }
                        }
                    }
                }
            }
        });
    }
}

// ========== FUNCI√ìN: FILTRAR COMPRAS POR PERIODO ==========
function filtrarComprasPorPeriodo(periodo) {
    comprasPeriodoActual = periodo;
    
    // Actualizar botones
    const botones = document.querySelectorAll('[onclick^="filtrarComprasPorPeriodo"]');
    botones.forEach(btn => {
        btn.classList.remove('bg-indigo-500', 'text-white');
        btn.classList.add('bg-indigo-100', 'text-indigo-700');
    });
    event.target.classList.remove('bg-indigo-100', 'text-indigo-700');
    event.target.classList.add('bg-indigo-500', 'text-white');
    
    // Re-renderizar gr√°fico
    renderGraficoTemporal();
}

function filtrarComprasPorPeriodoInterno(periodo, compras) {
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    
    return compras.filter(c => {
        if (!c.fecha) return false;
        const fecha = new Date(c.fecha);
        
        switch(periodo) {
            case 'hoy':
                return fecha.toDateString() === hoy.toDateString();
            case 'semana':
                const inicioSemana = new Date(hoy);
                inicioSemana.setDate(hoy.getDate() - 7);
                return fecha >= inicioSemana;
            case 'mes':
                const inicioMes = new Date(hoy);
                inicioMes.setDate(hoy.getDate() - 30);
                return fecha >= inicioMes;
            case 'trimestre':
                const inicioTrimestre = new Date(hoy);
                inicioTrimestre.setMonth(hoy.getMonth() - 3);
                return fecha >= inicioTrimestre;
            case 'a√±o':
                const inicioA√±o = new Date(hoy);
                inicioA√±o.setFullYear(hoy.getFullYear() - 1);
                return fecha >= inicioA√±o;
            default: // 'todo'
                return true;
        }
    });
}

// ========== FUNCI√ìN: EXPORTAR COMPRAS COMO JSON ==========
function exportarComprasJSON() {
    if (!db.compras || db.compras.length === 0) {
        alert('‚ö†Ô∏è No hay compras para exportar.\nPrimero importa un archivo Excel.');
        return;
    }
    
    const dataStr = JSON.stringify(db.compras, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `compras_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    console.log('‚úÖ Backup JSON exportado:', db.compras.length, 'registros');
    alert('‚úÖ Backup exportado exitosamente\n\nArchivo: ' + link.download + '\nRegistros: ' + db.compras.length);
}

// ========== FUNCI√ìN: IMPORTAR COMPRAS DESDE JSON ==========
function importarComprasJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('üìÇ Importando backup JSON:', file.name);
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const compras = JSON.parse(e.target.result);
            
            if (!Array.isArray(compras)) {
                throw new Error('El archivo JSON no contiene un array v√°lido');
            }
            
            if (compras.length === 0) {
                throw new Error('El archivo JSON est√° vac√≠o');
            }
            
            // Cargar en memoria
            db.compras = compras;
            db.comprasUltimaImportacion = new Date().toISOString();
            
            // Actualizar UI
            document.getElementById('compras-estado').innerHTML = `
                <p class="font-bold text-green-700 flex items-center gap-2 mb-2">
                    <span class="sparkle-icon">‚úÖ</span>
                    Backup JSON cargado!
                </p>
                <p class="text-xs text-green-600">üìä Registros: ${compras.length}</p>
                <p class="text-xs text-green-600">üìÖ √öltima actualizaci√≥n: ${new Date().toLocaleString('es-PE')}</p>
                <p class="text-xs text-blue-600 mt-2 font-semibold">üí° Datos temporales (re-cargar al reabrir el sistema)</p>
            `;
            
            // Mostrar secci√≥n de backup
            document.getElementById('compras-backup-section').classList.remove('hidden');
            
            // Calcular estad√≠sticas y mostrar an√°lisis
            calcularStatsCompras();
            mostrarAnalisisCompras();
            
            alert('‚úÖ Backup JSON importado\n\nRegistros: ' + compras.length + '\n\nAhora puedes ver el an√°lisis completo abajo.');
            
            console.log('‚úÖ Compras cargadas desde JSON:', compras.length);
            
        } catch (error) {
            console.error('‚ùå Error al cargar JSON:', error);
            alert('‚ùå Error al cargar el archivo JSON\n\n' + error.message);
        }
    };
    
    reader.readAsText(file);
}



    </script>

    <footer class="fixed bottom-0 left-0 w-full text-center text-[10px] text-slate-600 py-2 bg-white/90 backdrop-blur border-t border-slate-200">
        <div class="flex items-center justify-center gap-3 flex-wrap">
            <span class="font-bold text-blue-700">GASTRO CONTROL PRO</span>
            <span class="opacity-40">|</span>
            <span>Sistema Profesional de Gesti√≥n Gastron√≥mica</span>
            <span class="opacity-40">|</span>
            <span class="flex items-center gap-1">
                <span class="opacity-70">Desarrollado por</span>
                <span class="font-bold text-indigo-700">Leider Tisnado Mego</span>
            </span>
            <span class="opacity-40">|</span>
            <span>¬© 2025 Todos los derechos reservados</span>
        </div>
    </footer>

    <!-- ========== BOT√ìN FLOTANTE PANTALLA COMPLETA (TODOS LOS USUARIOS) ========== -->
    <div id="btn-fullscreen-float" onclick="toggleFullscreen()">
        <span id="fullscreen-icon">üñ•Ô∏è</span>
    </div>

    <!-- ========== MINI REPRODUCTOR RADIO (SOLO MANAGER) ========== -->
    <div id="mini-radio" class="minimizado">
        <div class="radio-toggle-btn" onclick="toggleRadio()">
            <span>üìª</span>
        </div>
        <div class="radio-content">
            <div class="radio-header-mini">
                <div class="radio-title-mini">Radio La Nube</div>
                <div class="radio-subtitle-mini">91.9 FM - Lima, Per√∫</div>
            </div>
            
            <div class="radio-iframe-container">
                <iframe 
                    id="radio-iframe"
                    src=""
                    allow="autoplay"
                    loading="lazy"
                    style="width:100%; height:120px; border:none; background:#000;">
                </iframe>
            </div>
            
            <div class="radio-status-mini">
                <span class="status-dot-mini"></span>
                <span>En vivo</span>
            </div>
        </div>
    </div>
<script>
// ========== CONFIGURACI√ìN API BACKEND ==========
const API_URL = '/api';

// ========== FUNCI√ìN LOGIN MODIFICADA ==========
async function iniciarSesion(event) {
    event.preventDefault();
    
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    
    try {
        const response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        if (!response.ok) throw new Error('Login fallido');
        
        const data = await response.json();
        usuarioActual = data.user;
        
        // Cargar datos desde backend
        const [eventos, compras, inventario, usuarios] = await Promise.all([
            fetch(`${API_URL}/eventos`).then(r => r.json()),
            fetch(`${API_URL}/compras`).then(r => r.json()),
            fetch(`${API_URL}/inventario`).then(r => r.json()),
            fetch(`${API_URL}/usuarios`).then(r => r.json())
        ]);
        
        db.eventos = eventos;
        db.compras = compras;
        db.inventario = inventario;
        db.usuarios = usuarios;
        
        mostrarDashboard();
        
    } catch (error) {
        alert('‚ùå Error: ' + error.message);
    }
}

// ========== FUNCIONES GUARDAR/ACTUALIZAR ==========
async function guardarEvento() {
    const nombre = document.getElementById('evento-nombre').value;
    const fecha = document.getElementById('evento-fecha').value;
    
    if (!nombre || !fecha) {
        alert('‚ö†Ô∏è Completa nombre y fecha');
        return;
    }
    
    const evento = {
        nombre,
        fecha,
        tipo: document.getElementById('evento-tipo')?.value || '',
        cliente: document.getElementById('evento-cliente')?.value || '',
        presupuesto: parseFloat(document.getElementById('evento-presupuesto')?.value) || 0,
        estado: 'Pendiente',
        items: []
    };
    
    try {
        const url = eventoActual?.id ? `${API_URL}/eventos/${eventoActual.id}` : `${API_URL}/eventos`;
        const method = eventoActual?.id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(evento)
        });
        
        const resultado = await response.json();
        
        if (eventoActual?.id) {
            const index = db.eventos.findIndex(e => e.id === eventoActual.id);
            db.eventos[index] = resultado;
        } else {
            db.eventos.unshift(resultado);
        }
        
        renderEventos();
        cerrarModal();
        alert('‚úÖ Evento guardado');
        
    } catch (error) {
        alert('‚ùå Error: ' + error.message);
    }
}

console.log('‚úÖ Backend conectado:', API_URL);
// ========== USUARIOS API ==========

// Override funci√≥n cargarUsuarios
if (typeof cargarUsuarios !== 'undefined') {
    const cargarUsuariosOriginal = window.cargarUsuarios;
    window.cargarUsuarios = async function() {
        try {
            const response = await fetch(`${API_URL}/usuarios`);
            const usuarios = await response.json();
            window.db.usuarios = usuarios;
            
            if (typeof renderUsuarios === 'function') {
                renderUsuarios();
            }
            
            console.log('‚úÖ Usuarios cargados desde PostgreSQL:', usuarios.length);
        } catch (error) {
            console.error('‚ùå Error cargando usuarios:', error);
        }
    };
}

// Override funci√≥n crearUsuario
if (typeof crearUsuario !== 'undefined') {
    const crearUsuarioOriginal = window.crearUsuario;
    window.crearUsuario = async function() {
        const username = document.getElementById('nuevo-usuario-username')?.value;
        const password = document.getElementById('nuevo-usuario-password')?.value;
        const rol = document.getElementById('nuevo-usuario-rol')?.value;
        const nombreCompleto = document.getElementById('nuevo-usuario-nombre')?.value;
        
        if (!username || !password || !rol) {
            alert('‚ö†Ô∏è Completa todos los campos obligatorios');
            return;
        }
        
        const usuario = {
            username,
            password,
            rol,
            nombre_completo: nombreCompleto || username
        };
        
        try {
            const response = await fetch(`${API_URL}/usuarios`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(usuario)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Error creando usuario');
            }
            
            const nuevoUsuario = await response.json();
            
            if (!window.db.usuarios) window.db.usuarios = [];
            window.db.usuarios.push(nuevoUsuario);
            
            if (typeof renderUsuarios === 'function') {
                renderUsuarios();
            }
            
            // Limpiar formulario
            if (document.getElementById('nuevo-usuario-username')) {
                document.getElementById('nuevo-usuario-username').value = '';
                document.getElementById('nuevo-usuario-password').value = '';
                document.getElementById('nuevo-usuario-rol').value = 'Chef';
                if (document.getElementById('nuevo-usuario-nombre')) {
                    document.getElementById('nuevo-usuario-nombre').value = '';
                }
            }
            
            alert('‚úÖ Usuario creado: ' + nuevoUsuario.username);
            console.log('‚úÖ Usuario creado en PostgreSQL:', nuevoUsuario);
            
        } catch (error) {
            console.error('‚ùå Error:', error);
            alert('‚ùå Error: ' + error.message);
        }
    };
}

// Override funci√≥n eliminarUsuario
if (typeof eliminarUsuario !== 'undefined') {
    const eliminarUsuarioOriginal = window.eliminarUsuario;
    window.eliminarUsuario = async function(id) {
        if (!confirm('¬øEliminar este usuario?')) return;
        
        try {
            const response = await fetch(`${API_URL}/usuarios/${id}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) throw new Error('Error eliminando usuario');
            
            window.db.usuarios = window.db.usuarios.filter(u => u.id !== id);
            
            if (typeof renderUsuarios === 'function') {
                renderUsuarios();
            }
            
            alert('‚úÖ Usuario eliminado');
            console.log('‚úÖ Usuario eliminado de PostgreSQL');
            
        } catch (error) {
            console.error('‚ùå Error:', error);
            alert('‚ùå Error: ' + error.message);
        }
    };
}

console.log('‚úÖ M√≥dulo de usuarios conectado al backend');
</script>
</body>
</html>
